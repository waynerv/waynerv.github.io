<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><title type="text">Shall We Code?</title><subtitle type="html">åˆ†äº«åç«¯å·¥ä½œä¸­çš„æ‰€æ€æ‰€å¾—ï¼Œæ¶‰åŠçš„é¢†åŸŸåŒ…æ‹¬ä½†ä¸é™äºï¼šPython, Go, Linux, Kubernetes, Container, Git, Github ç­‰</subtitle><updated>2022-07-28T05:24:50+00:00</updated><id>https://waynerv.com/</id><link rel="alternate" type="text/html" href="https://waynerv.com/"/><link rel="self" type="application/atom+xml" href="https://waynerv.com/atom.xml"/><author><name>Waynerv</name><uri>https://waynerv.com/</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><generator uri="https://gohugo.io/" version="0.100.1">Hugo</generator><entry><title type="text">è¯»ã€ŠBuilding a Second Brainã€‹</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/reading-notes-of-building-a-second-brain/"/><id>https://waynerv.com/posts/reading-notes-of-building-a-second-brain/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-07-28T13:06:12+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">è¿™æœ¬ä¹¦å‡ºç‰ˆäºå…­æœˆä»½ï¼ŒèŠ±äº†äº›æ—¶é—´çœ‹äº†å¤§åŠã€‚ç¬”è®°ä¸­æºæ‚äº†ä¸€äº›ä¸ªäººçš„æ€»ç»“å’Œçœ‹æ³•ï¼Œä¸€èˆ¬ä¼šæ”¾åœ¨åŸæ–‡å†…å®¹å½’çº³çš„åé¢ã€‚</summary><content type="html">&lt;p>&lt;img src="book-cover.png" alt="book cover">&lt;/p>
&lt;p>&lt;em>è¿™æœ¬ä¹¦å‡ºç‰ˆäºå…­æœˆä»½ï¼ŒèŠ±äº†äº›æ—¶é—´çœ‹äº†å¤§åŠã€‚ç¬”è®°ä¸­æºæ‚äº†ä¸€äº›ä¸ªäººçš„æ€»ç»“å’Œçœ‹æ³•ï¼Œä¸€èˆ¬ä¼šæ”¾åœ¨åŸæ–‡å†…å®¹å½’çº³çš„åé¢ã€‚&lt;/em>&lt;/p>
&lt;h2 id="ä¸ºä½•è¦æ„å»ºå¤–è„‘">ä¸ºä½•è¦æ„å»ºå¤–è„‘&lt;/h2>
&lt;blockquote>
&lt;p>We spend hours every day interacting with social media updates that will be forgotten in minutes. We bookmark articles to read later, but rarely find the time to revisit them again&lt;/p>
&lt;/blockquote>
&lt;p>ä¿¡æ¯æŠ€æœ¯çš„è¿›æ­¥æå¤§åœ°ä¸°å¯Œäº†äººä»¬è·å–ä¿¡æ¯çš„æ‰‹æ®µï¼Œä½†å¹¶æœªå¸¦æ¥æ˜¾è‘—çš„å­¦ä¹ æ•ˆç‡æå‡ï¼Œå› ä¸ºäººç±»çš„å¤§è„‘ğŸ§ ç»“æ„å’Œå‡ ä¸‡å¹´ä¹‹å‰æ²¡æœ‰åŒºåˆ«ï¼Œåªèƒ½å¤„ç†æœ‰é™çš„ä¿¡æ¯ï¼Œè€Œä¸”å¾ˆå¿«å°±ä¼šé—å¿˜ã€‚äººç±»çš„ç²¾åŠ›å’Œä¸“æ³¨åŠ›ä¹Ÿæ˜¯æœ‰é™çš„ï¼Œæ¯å¤©è·å–ä¿¡æ¯çš„å®¹é‡å·²ç»ä¸¥é‡è¿‡è½½ï¼Œå¤§é‡çš„æ— æ•ˆä¿¡æ¯åè€Œä¼šæ¶ˆè€—äººçš„ä¸“æ³¨åŠ›å’Œç²¾åŠ›å¯¼è‡´æ•ˆç‡é™ä½ã€‚&lt;/p>
&lt;p>å¦‚æœä½ æ¯å¤©ä¸æ–­è¢«å„ç§äº‹æƒ…æ‰“æ–­ï¼Œä¸æ–­åœ¨å¤šä¸ªä»»åŠ¡ä¹‹é—´åˆ‡æ¢ï¼ŒèŠ±è´¹è¿‡å¤šæ—¶é—´å»æ•´ç†æ£€ç´¢ä¿¡æ¯ï¼Œå¯èƒ½ä¼šæœ‰ä¸‹é¢çš„ä½“éªŒï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸ºäº†å®ç°è‡ªæˆ‘æˆé•¿æˆ–è¾¾æˆæŸä¸ªç›®æ ‡ï¼Œä½ ä¼šä¸ºè‡ªå·±è®¾å®šä¸€äº›è€—æ—¶é•¿ä¸”æœ‰éš¾åº¦çš„ä»»åŠ¡äº‹é¡¹ï¼Œè¿™äº›ä»»åŠ¡å¾€å¾€ä¸ä¸å½“ä¸‹çš„å·¥ä½œæˆ–èŒè´£ç›´æ¥å…³è”ï¼Œä½†å¯¹ä½ ä¸ªäººæ¥è¯´æ¯”é‡å¤çš„æ—¥å¸¸å·¥ä½œæ›´æœ‰æ„ä¹‰ã€‚&lt;/li>
&lt;li>è¿‡å¤šçš„ä¸´æ—¶ä»»åŠ¡å’Œçç¢äº‹åŠ¡ä½¿ä½ ä¸å¾—ä¸è°ƒæ•´ä¼˜å…ˆçº§ï¼Œå°†å¯¹ä½ æ¥è¯´çœŸæ­£é‡è¦çš„ä»»åŠ¡ä¸æ–­å»¶åã€‚&lt;/li>
&lt;li>ç­‰åˆ°ä½ ç»ˆäºæœ‰æ—¶é—´å¤„ç†è‡ªå·±çš„ä»»åŠ¡ï¼Œä¼šå‘ç°æ­¤æ—¶å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„ä¸“æ³¨åŠ›å’Œç²¾åŠ›ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä½œè€…æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯å»ºç«‹å¤–è„‘ï¼Œåœ¨äººè„‘å¤–éƒ¨å»ºç«‹æ•°å­—ç©ºé—´é›†ä¸­å­˜æ”¾ã€å¤„ç†è¾“å…¥çš„ä¿¡æ¯ã€‚&lt;strong>å…¶æœ¬è´¨æ˜¯å»ºç«‹ä¸€ç§æœ‰æ•ˆåº”å¯¹è¿‡è½½ä¿¡æ¯çš„æ‰‹æ®µ&lt;/strong>ï¼Œä½¿å¾—æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œæ¥å¤„ç†çœŸæ­£é‡è¦çš„ä¿¡æ¯å¹¶è¿›è¡Œæœ‰æ•ˆäº§å‡ºã€‚å¤–è„‘çš„ä½œç”¨ä¸ä»…ä»…åªæ˜¯çŸ¥è¯†ç®¡ç†ï¼Œè¿˜å…¼æœ‰æ—¶é—´ç®¡ç†ã€ç²¾åŠ›ç®¡ç†ç­‰è‡ªæˆ‘ç®¡ç†åŠŸèƒ½ã€‚&lt;/p>
&lt;h3 id="å¤–è„‘å¸¦æ¥çš„å¥½å¤„">å¤–è„‘å¸¦æ¥çš„å¥½å¤„&lt;/h3>
&lt;ol>
&lt;li>ä½¿å¾—æƒ³æ³•å’Œç†å¿µå…·è±¡åŒ–ï¼Œå¤§è„‘æ›´æ“…é•¿å¤„ç†å…·è±¡è€Œä¸æ˜¯æŠ½è±¡ï¼Œè·å¾—è¯ºè´å°”å¥–çš„ç§‘å­¦å®¶ä¹Ÿæ›¾ç»éœ€è¦å€ŸåŠ©ç‰©ç†æ¨¡å‹æ¥æ„å»ºæŠ½è±¡ç†è®ºï¼Œå…·è±¡åŒ–èƒ½å¤Ÿå¢å¼ºå¤§è„‘å¤„ç†ä¿¡æ¯çš„èƒ½åŠ›ã€‚&lt;/li>
&lt;li>å‘ç°å·²æœ‰äº‹ç‰©é—´çš„æ–°å…³è”ã€‚å°†ä¸åŒç§ç±»çš„ææ–™ç»„ç»‡åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬ä¼šè‡ªç„¶åœ°å»å‘ç°å®ƒä»¬ä¹‹é—´çš„ç›¸åŒç‚¹å’Œå…³è”ï¼Œå¹¶å‘æ•£å¼åœ°å»å»ºç«‹æ–°çš„å…³è”ã€‚&lt;/li>
&lt;li>åœ¨æ›´é•¿çš„æ—¶é—´è·¨åº¦å†…ç§¯ç´¯å­µåŒ–æˆ‘ä»¬çš„æƒ³æ³•ã€‚å¤§è„‘åœ¨çŸ­æ—¶é—´å†…åªèƒ½åŸºäºå·²æœ‰ææ–™ç”Ÿäº§æœ‰é™çš„ä¿¡æ¯ï¼Œå€ŸåŠ©å¤–è„‘å¯ä»¥åœ¨ä¸€ä¸ªæƒ³æ³•æˆ–ä¸»é¢˜ä¹‹ä¸Šä¸æ–­ç§¯ç´¯å’Œå‘å±•ï¼Œéšç€æ—¶é—´çš„æ¨ç§»å°±æœ‰å¯èƒ½äº§ç”Ÿæ›´é«˜ä»·å€¼çš„ç»“æœã€‚&lt;/li>
&lt;li>å¼ºåŒ–æˆ‘ä»¬çš„ç‹¬ç‰¹è§†è§’ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä¸ªäººçŸ¥è¯†ç®¡ç†çš„ä¸‰ä¸ªé˜¶æ®µ">ä¸ªäººçŸ¥è¯†ç®¡ç†çš„ä¸‰ä¸ªé˜¶æ®µ&lt;/h3>
&lt;ol>
&lt;li>è®°å½•&lt;/li>
&lt;li>è¿æ¥&lt;/li>
&lt;li>åˆ›é€ &lt;/li>
&lt;/ol>
&lt;h2 id="code-å››æ­¥éª¤æ–¹æ³•">CODE å››æ­¥éª¤æ–¹æ³•&lt;/h2>
&lt;p>&lt;img src="CODE.png" alt="CODE">&lt;/p>
&lt;p>æ„å»ºå¤–è„‘çš„ä¸»è¦æ–¹æ³•å°±æ˜¯å¤šè®°ç¬”è®°ï¼Œä½œè€…åœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±•äº†ä¸€å¥— CODE å››æ­¥éª¤ä½œä¸ºæ–¹æ³•è®ºã€‚&lt;/p>
&lt;h3 id="capture">Capture&lt;/h3>
&lt;h4 id="ä»€ä¹ˆæ˜¯å¯ä»¥è®°å½•çš„ä¿¡æ¯">ä»€ä¹ˆæ˜¯å¯ä»¥è®°å½•çš„ä¿¡æ¯ï¼Ÿ&lt;/h4>
&lt;p>æ¥è‡ªå¤–éƒ¨ï¼šHighlightsï¼ŒQuotesï¼ŒBookmarks and favoritesï¼ŒVoice memosï¼ŒMeeting notesï¼ŒImagesï¼ŒTakeaways&lt;/p>
&lt;p>æ¥è‡ªå†…éƒ¨ï¼šStoriesï¼ŒInsightsï¼ŒMemoriesï¼ŒReflectionsï¼ŒMusings&lt;/p>
&lt;h4 id="ä»€ä¹ˆä¿¡æ¯ä¸é€‚åˆè®°å½•">ä»€ä¹ˆä¿¡æ¯ä¸é€‚åˆè®°å½•ï¼Ÿ&lt;/h4>
&lt;ul>
&lt;li>ç§äººçš„&lt;/li>
&lt;li>ç‰¹å®šæ ¼å¼çš„&lt;/li>
&lt;li>å¤§æ–‡ä»¶&lt;/li>
&lt;li>åä½œç¼–è¾‘çš„&lt;/li>
&lt;/ul>
&lt;h4 id="è®°å½•å“ªäº›ä¿¡æ¯">è®°å½•å“ªäº›ä¿¡æ¯ï¼Ÿ&lt;/h4>
&lt;p>å¦‚ä½•ç¡®å®šå“ªäº›ä¿¡æ¯éœ€è¦è®°å½•ä¸‹æ¥ï¼Œæ ¸å¿ƒåœ¨äºä¸è¦è¢«åŠ¨å’Œéšæ„åœ°å»æ¥æ”¶ä¿¡æ¯ï¼Œè€Œæ˜¯å»ºç«‹è‡ªå·±çš„å…³æ³¨é¢†åŸŸï¼Œåœ¨å…³æ³¨é¢†åŸŸå†…æå‡ºæœ€å¤š 12 ä¸ªå¾…è§£å†³çš„é—®é¢˜æˆ–ç–‘æƒ‘ï¼Œç„¶åä¸»åŠ¨å¯»æ‰¾æˆ–æ£€æŸ¥è¢«åŠ¨æ¥æ”¶çš„ä¿¡æ¯ï¼Œæ˜¯å¦æœ‰åŠ©äºè§£å†³è‡ªå·±æå‡ºçš„é—®é¢˜ã€‚&lt;/p>
&lt;p>å¯¹äºå¼€å‘è€…æ¥è®²ï¼Œåˆ™æ˜¯å»ºç«‹ä¸€ä¸ªæœ‰é™çš„æŠ€æœ¯é—®é¢˜åˆ—è¡¨ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´æ®µå°½é‡åªå…³æ³¨å’Œè®°å½•å’Œè§£å†³è¿™äº›é—®é¢˜æœ‰å…³çš„ä¿¡æ¯ã€‚æ¯”æ–¹è¯´æˆ‘ä¸ªäººè¿‘æœŸï¼ˆè‡³å°‘ä¸€å¹´å†…ï¼‰å…³æ³¨ä»¥ä¸‹é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>golang çš„è°ƒåº¦å™¨å¦‚ä½•å·¥ä½œï¼Œå†…å­˜æ¨¡å‹ä»¥åŠåƒåœ¾å›æ”¶æœºåˆ¶æ˜¯æ€æ ·çš„&lt;/li>
&lt;li>å¦‚ä½•ç†Ÿç»ƒæŒæ¡ client-goï¼Œcontroller-runtime ç­‰ k8s åº“çš„ä½¿ç”¨æ–¹æ³•&lt;/li>
&lt;li>å®¹å™¨ç½‘ç»œçš„å·¥ä½œæœºåˆ¶&lt;/li>
&lt;li>linux ç½‘ç»œçš„å†…æ ¸å®ç°ï¼Œå¦‚ä½•å¿«é€Ÿå®šä½ç½‘ç»œé—®é¢˜å’Œæ’é™¤æ•…éšœ&lt;/li>
&lt;li>æ•°æ®åŒ…åœ¨ cilium å’Œ ebpf æ„å»ºçš„å®¹å™¨ç½‘ç»œä¸­æ˜¯å¦‚ä½•æµåŠ¨çš„&lt;/li>
&lt;li>k8s çš„è°ƒåº¦å™¨å¦‚ä½•å·¥ä½œçš„ï¼Œå¦‚ä½•è‡ªå®šä¹‰è°ƒåº¦ç­–ç•¥&lt;/li>
&lt;li>postgresql çš„å¤‡ä»½æ¢å¤æœºåˆ¶ï¼Œä¸»ä»åŒæ­¥æœºåˆ¶&lt;/li>
&lt;li>linux æ–‡ä»¶ç³»ç»Ÿçš„å†…æ ¸å®ç°ï¼Œå¦‚ä½•ç›‘æ§ç£ç›˜io&lt;/li>
&lt;li>åˆ†å¸ƒå¼é¢†åŸŸéœ€è¦å…³æ³¨çš„æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆï¼Œraft å…±è¯†ç®—æ³•çš„åŸç†å’Œå®ç°&lt;/li>
&lt;li>å¦‚ä½•æé«˜æ—¥å¸¸å·¥ä½œçš„æ•ˆç‡ï¼Œç»ˆç«¯å’Œ vim ç›¸å…³çš„æŠ€å·§&lt;/li>
&lt;li>å¦‚ä½•æå‡è‡ªå·±çš„æŠ€æœ¯å†™ä½œæ°´å¹³å’Œæ•ˆç‡ï¼Œæ‰©å¤§è‡ªå·±çš„æŠ€æœ¯å½±å“åŠ›&lt;/li>
&lt;li>å¦‚ä½•æé«˜è‡ªå·±çš„ leetcode æ°´å¹³&lt;/li>
&lt;/ul>
&lt;h4 id="å¦‚ä½•é¿å…è®°å½•å¤ªå¤šæˆ–å¤ªå°‘ä¿¡æ¯">å¦‚ä½•é¿å…è®°å½•å¤ªå¤šæˆ–å¤ªå°‘ä¿¡æ¯ï¼Ÿ&lt;/h4>
&lt;p>&lt;strong>ä¿¡æ¯å†…å®¹ä¸­çš„ä»·å€¼å¹¶ä¸æ˜¯å‡åŒ€åˆ†å¸ƒçš„&lt;/strong>ï¼Œå°éƒ¨åˆ†å†…å®¹è•´å«äº†æœ€å…·å¸®åŠ©å’Œæœ‰è¶£çš„ä»·å€¼ï¼ˆè¿™é‡Œä¹Ÿè®¸å¯ä»¥å¥—äºŒå…«æ³•åˆ™ï¼Ÿï¼‰ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦ä»è¾“å…¥çš„ä¿¡æ¯ä¸­é€‰å–ä¸€å°éƒ¨åˆ†è®°å½•ä¸‹æ¥ï¼ˆæœ€å¤šä¸è¦è¶…è¿‡10%ï¼Œä¿ç•™å›åˆ°åŸæ–‡çš„é“¾æ¥ï¼‰ã€‚&lt;/p>
&lt;p>é€‰å–çš„æ¡ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨æƒ…æ„Ÿä¸Šæœ‰é¼“èˆã€é©±åŠ¨ä½œç”¨&lt;/li>
&lt;li>æœ‰å®é™…ä½œç”¨çš„&lt;/li>
&lt;li>ä¸ªäººåŒ–çš„&lt;/li>
&lt;li>èƒ½æ”¹å˜ç°æœ‰è®¤çŸ¥ï¼Œä»¤äººæƒŠè®¶çš„&lt;/li>
&lt;/ul>
&lt;p>æœ€é‡è¦ä¹Ÿæ˜¯å”¯ä¸€çš„åˆ¤æ–­æ¡ä»¶ï¼š&lt;strong>Capture What Resonates&lt;/strong>ã€‚è®°å½•åœ¨ç›´è§‰ä¸Šèƒ½å¤Ÿå¼•èµ·ä½ å…±é¸£çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆé ç›´è§‰ï¼Ÿæˆ‘ä»¬ä¸åº”è¯¥ä¾èµ–æ­»æ¿çš„æ ‡å‡†åˆ¤æ–­ä¿¡æ¯æ˜¯å¦å€¼å¾—è®°å½•ï¼Œè€Œåº”è¯¥ç»ƒä¹ ä½¿ç”¨ç›´è§‰å»è¾¨åˆ«ï¼Œè¿™æ ·ä¸€æ˜¯é™ä½äº†è¾¨åˆ«ä¿¡æ¯çš„éš¾åº¦å’Œå·¥ä½œé‡ï¼ŒäºŒæ˜¯å‘å±•äº†è‡ªå·±å¿«é€Ÿè¯†åˆ«æœ‰ä»·å€¼ä¿¡æ¯çš„èƒ½åŠ›ã€‚&lt;/p>
&lt;blockquote>
&lt;p>â€œitâ€™s often helpful to capture chapter titles, headings, and bullet-point lists, since they add structure to your notes and represent distillation already performed by the author on your behalf.â€&lt;/p>
&lt;/blockquote>
&lt;p>è®°å½•æ—¶å°½é‡ä¿ç•™åŸæ–‡çš„å¤šçº§æ ‡é¢˜å’Œåˆ—è¡¨ç­‰å·²æœ‰çš„ç»„ç»‡ç»“æ„ã€‚&lt;/p>
&lt;h4 id="é€‰æ‹©åˆé€‚çš„è®°å½•å·¥å…·">é€‰æ‹©åˆé€‚çš„è®°å½•å·¥å…·&lt;/h4>
&lt;blockquote>
&lt;p>â€œdonâ€™t leave all the knowledge they contain scattered across dozens of places youâ€™ll never think to look. Make sure your best findings get routed back to your notes app where you can put them all together and act on them.â€&lt;/p>
&lt;/blockquote>
&lt;p>ä»»ä½•è¶æ‰‹çš„è®°å½•å·¥å…·éƒ½å¯ä»¥ï¼Œåªè¦èƒ½å°†å…¶æ”¶é›†çš„ä¿¡æ¯æ±‡æ€»åˆ°ä¸€å¤„ã€‚&lt;/p>
&lt;h4 id="å¤–éƒ¨åŒ–æ€ç»´è¿‡ç¨‹">å¤–éƒ¨åŒ–æ€ç»´è¿‡ç¨‹&lt;/h4>
&lt;p>ç ”ç©¶è€…å‘ç°ï¼Œä¸é˜…è¯»ä¸€æ®µè¯ç›¸æ¯”ï¼Œå£è¿°æˆ–å†™å‡ºåŒä¸€æ®µè¯æ—¶å¤§è„‘çš„æ´»è·ƒåŒºåŸŸæ›´å¹¿ã€‚&lt;/p>
&lt;p>å¤–éƒ¨åŒ–æ€ç»´è¿‡ç¨‹èƒ½å¤Ÿæ˜¾è‘—å¢å¼ºæˆ‘ä»¬çš„è®°å¿†å’Œå…³è”å‘æ•£èƒ½åŠ›ï¼Œç”šè‡³æœ‰ç›Šèº«å¿ƒå¥åº·ã€‚&lt;/p>
&lt;blockquote>
&lt;p>â€œDonâ€™t worry about whether youâ€™re capturing â€œcorrectly.â€ Thereâ€™s no right way to do this, and therefore, no wrong way.â€&lt;/p>
&lt;/blockquote>
&lt;h3 id="organize">Organize&lt;/h3>
&lt;h4 id="æ•´ç†ä¿¡æ¯çš„é‡è¦æ€§">æ•´ç†ä¿¡æ¯çš„é‡è¦æ€§&lt;/h4>
&lt;p>â€œå¤§æ•™å ‚æ•ˆåº”â€ï¼ˆCathedral Effectï¼‰æè¿°äº†å»ºç­‘å±‹é¡¶çš„é«˜åº¦å¯¹äººç±»æ€è€ƒè¡Œä¸ºçš„å¿ƒç†å­¦å½±å“ã€‚&lt;strong>é«˜å±‹é¡¶ä¿ƒè¿›æŠ½è±¡æ€ç»´ï¼ˆæ¿€å‘åˆ›é€ åŠ›ï¼‰ï¼Œä½å±‹é¡¶ä¿ƒè¿›å…·è±¡æ€ç»´ï¼ˆèšç„¦ç»†èŠ‚ï¼‰ã€‚&lt;/strong>&lt;/p>
&lt;p>å¤–è„‘ä½œä¸ºæˆ‘ä»¬å·¥ä½œå’Œåˆ›ä½œçš„æ•°å­—ç¯å¢ƒï¼Œä¹Ÿéœ€è¦å¾—åˆ°è‰¯å¥½çš„æ•´ç†å’Œç»„ç»‡ã€‚&lt;/p>
&lt;p>ç»„ç»‡ä¿¡æ¯çš„æœ€å¤§è¯±æƒ‘æ˜¯å®Œç¾ä¸»ä¹‰ï¼Œå°†ç»„ç»‡è¿‡ç¨‹æœ¬èº«è§†ä¸ºç›®çš„ã€‚è®¸å¤šäººå¸Œæœ›èƒ½æ‰¾åˆ°ä¸€å¥—åƒå›¾ä¹¦é¦†åˆ†ç±»ä¹¦ç±ä¸€æ ·å®Œç¾çš„åˆ†ç±»æ–¹æ³•å¯¹ä¿¡æ¯è¿›è¡Œæ•´ç†ï¼Œç„¶è€Œè¿™ç§å®Œç¾çš„æ–¹æ³•æ˜¯ä¸å­˜åœ¨çš„ã€‚&lt;/p>
&lt;h4 id="para-ç³»ç»Ÿ">PARA ç³»ç»Ÿ&lt;/h4>
&lt;p>PARA ç³»ç»Ÿå’Œä¼ ç»Ÿåˆ†ç±»æ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œå…¶ç›®çš„ä¸æ˜¯ä¸ºäº†è®¾è®¡ä¸€å¥—å¤§è€Œå…¨çš„åˆ†ç±»ç³»ç»Ÿå°†ä¿¡æ¯æ”¾åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œè€Œæ˜¯å°½é‡å‡å°‘ç»„ç»‡ä¿¡æ¯çš„è´Ÿæ‹…åŒæ—¶ä¸å½±å“ä¿¡æ¯çš„åŠŸç”¨ã€‚&lt;/p>
&lt;p>PARA ç³»ç»Ÿå°†æ‰€æœ‰çš„ä¿¡æ¯åˆ†ä¸ºå››ç±»ï¼š&lt;/p>
&lt;ol>
&lt;li>Projectsï¼šå›´ç»•å½“å‰æ­£åœ¨è¿›è¡Œçš„ï¼ŒçŸ­æœŸçš„å·¥ä½œæˆ–ç”Ÿæ´»é¡¹ç›®ï¼Œæœ‰æ˜ç¡®çš„èµ·æ­¢æ—¶é—´æˆ–äº§å‡ºç»“æœã€‚è®¾å®š Projects ä¹Ÿæ˜¯ä¸€é¡¹è®¾å®šç›®æ ‡ã€åˆ†é…æ—¶é—´å’Œä¼˜å…ˆçº§çš„è®¡åˆ’è¿‡ç¨‹ã€‚&lt;/li>
&lt;li>Areasï¼šé•¿æœŸå…³æ³¨æˆ–ä»äº‹çš„é¢†åŸŸã€‚ä¸éœ€è¦å¾ˆå…·ä½“çš„ç›®æ ‡ï¼Œä½†åº”è¯¥è®¾å®šé¢„æœŸåˆ°è¾¾çš„æŒæ¡ç¨‹åº¦æˆ–æŠ€èƒ½æ°´å¹³ã€‚&lt;/li>
&lt;li>Resourcesï¼šåœ¨æœªæ¥å¯èƒ½ç”¨å¾—ä¸Šçš„ä¸»é¢˜ã€‚ä¸ä¸ªäººçš„å…´è¶£ã€ç ”ç©¶æœ‰å…³ï¼Œå¹¶ä¸”åœ¨æœªæ¥èƒ½å¤Ÿè¢«å¼•ç”¨æˆ–å‚è€ƒã€‚&lt;/li>
&lt;li>Archivesï¼šä»¥ä¸Šä¸‰ä¸ªåˆ†ç±»ä¸­ä¸åœ¨æ´»è·ƒçš„é¡¹ç›®ã€‚å·²å®Œæˆçš„ projects æˆ–è€…ä¸å†å…³æ³¨çš„ areas ç­‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>PARA çš„æ ¸å¿ƒæ€æƒ³æ˜¯&lt;strong>æŒ‰ç¬”è®°è¢«ä½¿ç”¨çš„ç´§æ€¥ç¨‹åº¦å’Œé¢‘ç‡è¿›è¡Œç»„ç»‡&lt;/strong>ï¼Œå®ƒçš„ä¾æ®ä¸æ˜¯ä¿¡æ¯ä»å“ªé‡Œæ¥ï¼Œè€Œæ˜¯ä¿¡æ¯å°†åˆ°å“ªé‡Œå»ã€‚&lt;/p>
&lt;p>çŸ¥è¯†æ˜¯å¦æœ‰ä»·å€¼çš„åˆ¤æ–­æ¡ä»¶ä¸æ˜¯å®ƒæ˜¯å¦äº•äº•æœ‰æ¡æ•´æ´æœ‰åºï¼Œè€Œæ˜¯å®ƒèƒ½å¦å¯¹ä¸ªäººæˆ–ä¸ªäººå…³æ³¨çš„ç›®æ ‡äº§ç”Ÿå½±å“ã€‚ä½¿ç”¨ PARA ç³»ç»Ÿçš„è¿‡ç¨‹ä¸ä»…ä»…åªæ˜¯å¯¹è®°å½•çš„ä¿¡æ¯è¿›è¡Œæ•´ç†åˆ†ç±»ï¼Œæ›´æ˜¯å¯¹ä¸ªäººçš„å·¥ä½œå’Œç”Ÿæ´»è¿›è¡Œç»„ç»‡å’Œç®¡ç†ã€‚&lt;/p>
&lt;p>çœ‹å®Œè¿™ç« ï¼Œå‘ç°è‡ªå·±åŸºæœ¬ä¸Šå·²ç»åœ¨ Notion ä¸­ä½¿ç”¨è¿™å¥—æ‰€è°“çš„ã€Œç³»ç»Ÿã€äº†ï¼Œäºæ˜¯åœ¨ Dashboard é¡µé¢ä¸­é‡æ–°æ•´ç†å½’ç±»äº†åŸæœ‰çš„é¡µé¢ï¼ˆå¥—äº†ä¸ª PARA çš„æ ‡é¢˜ï¼‰ï¼š&lt;/p>
&lt;p>&lt;img src="Dashboard.png" alt="Dashboard">&lt;/p>
&lt;ol>
&lt;li>Projectsï¼šæ¯å‘¨çš„ä»»åŠ¡å®‰æ’ï¼ŒTodo Inboxï¼Œä¸ªäººOKRï¼Œåšå®¢å†™ä½œçœ‹æ¿å’Œé˜…è¯»æ¸…å•ï¼Œä»¥åŠå·¥ä½œä¸­ç”¨åˆ°çš„æ—¥å¿—ç­‰æ—¶æ•ˆæ€§å†…å®¹ã€‚&lt;/li>
&lt;li>Areasï¼šåŸºæœ¬ä¸Šå°±æ˜¯æŠ€æœ¯ wiki äº†ã€‚&lt;/li>
&lt;li>Resourcesï¼šçº¯ç²¹ç”¨æ¥æ•´ç†é€šè¿‡ Save to Notion æ”¶è—çš„é¡µé¢ã€‚&lt;/li>
&lt;li>Archivesï¼šå¯¹ Projects é‡Œé¢å¾€å‘¨å¾€å¹´çš„é¡¹ç›®è¿›è¡Œå½’æ¡£ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="æ•´ç†çš„æ—¶æœº">æ•´ç†çš„æ—¶æœº&lt;/h4>
&lt;p>è®°å½•ä¿¡æ¯çš„æ—¶åˆ»å¹¶ä¸æ˜¯å¯¹å…¶æ•´ç†çš„æœ€ä½³æ—¶åˆ»ï¼Œå¯ä»¥å°è¯•åœ¨ç¬”è®°ä¸­å»ºç«‹ä¸€ä¸ª Inbox åˆ†ç±»å­˜æ”¾æ‰€æœ‰çš„æœªå¤„ç†ä¿¡æ¯ï¼Œå¹¶å®šæœŸæ¯”å¦‚æ¯å‘¨å¯¹å…¶è¿›è¡Œæ•´ç†ã€‚&lt;/p>
&lt;h3 id="distill">Distill&lt;/h3>
&lt;p>&lt;del>çœ‹åˆ°è¿™é‡Œï¼Œæ„Ÿè§‰ä½œè€…æœ‰ç‚¹ä¸ºäº†å†™ä¹¦è€Œå†™ä¹¦äº†ã€‚&lt;/del>&lt;/p>
&lt;p>è¿™ä¸€ç« è®²çš„æ˜¯ï¼Œå¦‚ä½•æå–ä¿¡æ¯ä¸­çš„å…³é”®ç‚¹ï¼Œä½¿å¾—è®°å½•å’Œç»„ç»‡ä¿¡æ¯ä¸€æ®µæ—¶é—´ä¹‹åèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°å¹¶æŠ•å…¥ä½¿ç”¨ï¼Œå³å¢å¼ºä¿¡æ¯çš„å¯å‘ç°æ€§ï¼ˆDiscoverabilityï¼‰ã€‚&lt;/p>
&lt;p>æ²¡æœ‰äººèƒ½å¤Ÿè¿‡ç›®ä¸å¿˜ï¼Œåœ¨ç¬¬ä¸€æ¬¡é˜…è¯»ä¸€ç¯‡æ–‡ç« æ—¶ï¼Œæˆ‘ä»¬ä¼šæ·±å…¥å…¶ä¸­çš„ç»†èŠ‚ï¼›ä½†è¿‡æ®µæ—¶é—´æƒ³ç”¨åˆ°è¿™ç¯‡æ–‡ç« æ—¶ï¼Œä½ å¯èƒ½éœ€è¦å†ä»å¤´åˆ°å°¾é˜…è¯»ä¸€éï¼Œæ‰èƒ½ä»ä¸­æ‰¾åˆ°å¯¹è‡ªå·±æœ‰ä»·å€¼çš„é‚£éƒ¨åˆ†ä¿¡æ¯ã€‚&lt;/p>
&lt;p>è§£å†³æ–¹æ³•æ˜¯åœ¨è®°å½•å’Œç»„ç»‡ä¹‹åå¢åŠ ä¸€ä¸ªæå–ç¯èŠ‚ï¼Œåœ¨æå–ç¯èŠ‚ä¸­ï¼Œæå‰è®¾æƒ³å“ªäº›éƒ¨åˆ†çš„ä¿¡æ¯ä¼šåœ¨æœªæ¥å¯¹è‡ªå·±æœ‰å¸®åŠ©ï¼Œå¹¶æ ‡è®°å‡ºæ¥ã€‚&lt;/p>
&lt;h4 id="æ¸è¿›å¼æ¦‚è¦">æ¸è¿›å¼æ¦‚è¦&lt;/h4>
&lt;p>ä½œè€…åœ¨ä¹¦ä¸­èŠ±äº†åå‡ é¡µä»‹ç»äº†ä¸€å¥—åä¸ºã€Œæ¸è¿›å¼æ¦‚è¦ã€çš„åˆ†å±‚æå–æ–¹æ³•ï¼Œå…¶å®å‡ å¥è¯å°±èƒ½è®²æ¸…æ¥šï¼š&lt;/p>
&lt;ol>
&lt;li>ç¬¬ä¸€ä¸ªå±‚çº§ï¼Œæ˜¯ç›´æ¥æ‘˜å–åŸæ–‡ä¸­çš„å…³é”®æ®µè½ï¼Œå¹¶ä¿ç•™åŸæ–‡é“¾æ¥ã€‚&lt;/li>
&lt;li>åœ¨ä¸Šä¸€å±‚åŸºç¡€ä¸Šï¼Œå¯¹å…³é”®ä¿¡æ¯åŠ ç²—ã€‚&lt;/li>
&lt;li>é«˜äº®æ›´å…³é”®çš„ä¿¡æ¯ã€‚&lt;/li>
&lt;li>ç”¨è‡ªå·±çš„è¯æ€»ç»“å…³é”®ç‚¹ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="éœ€è¦é¿å…çš„ä¸‰ä¸ªè¯¯åŒº">éœ€è¦é¿å…çš„ä¸‰ä¸ªè¯¯åŒº&lt;/h4>
&lt;ol>
&lt;li>æ¯ä¸€èŠ‚éƒ½æ˜¯é‡ç‚¹ï¼Œå°±ç­‰äºæ²¡æœ‰é‡ç‚¹ã€‚é‡ç‚¹åªæ˜¯èµ·åˆ°åŸæ–‡ç´¢å¼•çš„ä½œç”¨ï¼Œä¸è¦è¶…è¿‡ä¸Šä¸€å±‚å†…å®¹çš„ 10-20%ã€‚&lt;/li>
&lt;li>åœ¨å‡†å¤‡ç”¨åˆ°ä¿¡æ¯çš„æ—¶å€™å†å»åšæå–ã€‚å³æ ¹æ®å“ªäº›ä¿¡æ¯åœ¨æœªæ¥æœ€æœ‰å¯èƒ½ç”¨åˆ°ï¼Œæ¥è¾¨åˆ«ä¿¡æ¯ä¸­çš„å…³é”®ç‚¹ã€‚&lt;/li>
&lt;li>ä¸è¦èŠ±å¤ªå¤šæ—¶é—´å’Œç²¾åŠ›æ¥æå–ä¿¡æ¯ï¼Œè¿ç”¨ä½ çš„ç›´è§‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>è¿™ç« è®²çš„å…¶å®å°±æ˜¯åœ¨ä¿å­˜ä¿¡æ¯åï¼Œå¦‚ä½•å¯¹ä¿¡æ¯è¿›è¡Œç®€å•å¤„ç†ï¼Œä½¿å¾—åœ¨éœ€è¦æ—¶èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ä¿¡æ¯ã€‚&lt;/p>
&lt;p>è§£å†³è¿™ç§é—®é¢˜è¿˜æœ‰æ¯”æ•°æ®åº“æ›´åœ¨è¡Œçš„å—ï¼Ÿä½œè€…ä»‹ç»çš„æ–¹æ³•å…¶å®å°±æ˜¯ä¸ºä¿¡æ¯å»ºç«‹ç´¢å¼•ï¼Œä¸ºäº†æé«˜æ•ˆç‡æˆ‘ä»¬ä¼šä¸ºæœ€å¸¸ç”¨åˆ°çš„æ•°æ®åˆ—å»ºç«‹ç´¢å¼•ã€‚ä¸€å±‚ç´¢å¼•ä¸å¤Ÿå°±å†åŠ ä¸€å±‚ redis ä½œä¸ºç¼“å­˜ï¼Œç¼“å­˜è¿˜ä¸å¤Ÿå°±æŠŠæœ€å¸¸ç”¨çš„æ•°æ® hardcode åœ¨ä»£ç ä¸­ä½œä¸ºå¸¸é‡â€¦â€¦&lt;/p>
&lt;h3 id="express">Express&lt;/h3>
&lt;p>&lt;del>è¿™ç« çš„å¤§éƒ¨åˆ†å†…å®¹å·²ç»æ˜¯åœ¨å……å­—æ•°äº†ã€‚&lt;/del>&lt;/p>
&lt;p>CODE çš„æœ€åé˜¶æ®µæ˜¯ Express å³è¡¨è¾¾ï¼Œæ˜¯æŒ‡ä¸åº”è¯¥å½»åº•æŒæ¡äº†ä¸€é¡¹çŸ¥è¯†å†å¯¹å¤–åˆ†äº«ï¼Œè€Œæ˜¯åº”è¯¥æ›´æ—©ã€æ›´é¢‘ç¹ã€æ›´å°è§„æ¨¡åœ°è¡¨è¾¾ä½ çš„æƒ³æ³•ï¼Œä»¥éªŒè¯æ˜¯å¦æœ‰æ•ˆï¼Œå¹¶ä»ä»–äººé‚£é‡Œæ”¶é›†åé¦ˆã€‚è¿™äº›åé¦ˆæœ‰åŠ©äºå¼€å§‹ä¸‹ä¸€è½®çš„è¡¨è¾¾ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´åº”è¯¥å°†ä¸€ä¸ªæœ‰æŒ‘æˆ˜æ€§çš„å¤§çš„è®¡åˆ’ï¼Œåˆ†è§£æˆéš¾åº¦æ›´å°éœ€è¦èµ„æºæ›´å°‘çš„å­ç›®æ ‡ã€‚ä½œè€…åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µ Intermediate Packet ï¼ˆIPï¼Ÿï¼‰ï¼Œå³å®Œæˆç›®æ ‡è¿‡ç¨‹ä¸­æ‰€è®°å½•çš„ä¿¡æ¯æˆ–è€…ä¸­é—´äº§ç‰©ï¼Œè¿™äº›å¯¹å®ç°æ–°çš„ç›®æ ‡ä¼šå¾ˆæœ‰ç”¨ã€‚&lt;/p>
&lt;p>å¯èƒ½æ˜¯æˆ‘è‹±è¯­æ°´å¹³ä¸åˆ°ä½ï¼Œè¿™ç« çš„å¤§éƒ¨åˆ†æ®µè½è¯»èµ·æ¥äº‘é‡Œé›¾é‡Œï¼Œå¹²è„†å°è¯•æ ¹æ®æ ‡é¢˜å½’çº³ä¸‹æ¯èŠ‚å†…å®¹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>How to Protect Your Most Precious Resourceã€‚&lt;/p>
&lt;p>æ³¨æ„åŠ›æ˜¯çŸ¥è¯†å·¥ä½œè€…æœ€ç¨€ç¼ºçš„èµ„æºï¼Œå› ä¸ºæ³¨æ„åŠ›å¾ˆå®è´µï¼Œæ‰€ä»¥åº”è¯¥å°½é‡å¤ç”¨çŸ¥è¯†å·¥ä½œçš„ä¸­é—´äº§ç‰©ã€‚ï¼ˆä¸»é¢˜ã€å†…å®¹ä»¥åŠæœ€åå¾—å‡ºç»“è®ºä¹‹é—´çš„é€»è¾‘è”ç³»å¾ˆç‰µå¼ºï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Intermediate Packets: The Power of Thinking Smallã€‚&lt;/p>
&lt;p>å¼•å…¥äº† Intermediate Packet è¿™ä¸ªæ¦‚å¿µï¼Œæ„æ€å°±æ˜¯å®Œæˆå¤§çš„é¡¹ç›®æˆ–ç›®æ ‡è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ç¬”è®°ã€æ–‡æ¡£ã€PPT ç­‰ä¸­é—´äº§ç‰©ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Assembling Building Blocks: The Secret to Frictionless Outputã€‚&lt;/p>
&lt;p>è¿™æ®µçš„å¤§æ¦‚æ˜¯è®²å¤ç”¨ä¸Šé¢çš„ä¸­é—´äº§ç‰©ç»„åˆèµ·æ¥å°±èƒ½å®ç°å¿«é€Ÿäº§å‡ºæ–°çš„æˆæœã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>How to Resurface and Reuse Your Past Workã€‚&lt;/p>
&lt;p>å¤§æ„æ˜¯è®²é€šè¿‡æœç´¢ã€æµè§ˆã€æ‰“æ ‡ç­¾å’Œç¢°è¿æ°”ç­‰æ–¹å¼æ›´å¥½åœ°ä»å·²å®Œæˆçš„å·¥ä½œä¸­ï¼Œå‘æ˜å¯¹å½“å‰ç›®æ ‡æœ‰ç”¨çš„ä¿¡æ¯ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Three Stages of Expressing: What Does It Look Like to Show Our Work?&lt;/p>
&lt;p>é‡æ–°å›é¡¾çŸ¥è¯†ç®¡ç†çš„ä¸‰ä¸ªé˜¶æ®µï¼šè®°å¿†ã€è¿æ¥å’Œåˆ›ä½œã€‚æœ‰äº†å¤–è„‘å®ç°è¿™ä¸‰è€…æ›´è½»æ¾å’Œé«˜æ•ˆäº†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Creativity Is Inherently Collaborativeã€‚&lt;/p>
&lt;p>åˆ›é€ åŠ›æœ¬è´¨ä¸Šæ˜¯åä½œçš„ï¼Œæ‰€ä»¥è¦ç»å¸¸å‘ä»–äººå±•ç¤ºé˜¶æ®µæ€§çš„æˆæœå¯»æ±‚åé¦ˆã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Everything Is a Remixã€‚&lt;/p>
&lt;p>ä»»ä½•æ–°äº‹ç‰©éƒ½å»ºç«‹åœ¨å·²æœ‰äº‹ç‰©çš„åŸºç¡€ä¸Šã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>è¿™ç« æ„Ÿè§‰ä½œè€…åœ¨å†™é•¿ç¯‡å¤§è®ºä¸”æ­£ç¡®çš„åºŸè¯äº†ï¼Œæ¯ä¸€å¥è¯éƒ½å†™çš„å¾ˆå¯¹ï¼Œä½†çœ‹å®Œåªèƒ½ä½“ä¼šåˆ°æ—¶é—´ç™½ç™½æµé€ã€‚æ´‹æ´‹æ´’æ´’å‡ åé¡µå¹¶æ²¡æœ‰æå‡ºä»€ä¹ˆå®é™…çš„è§‚ç‚¹å’Œæ–¹æ³•ï¼Œä¸€ç›´åœ¨å¼ºè°ƒé€šè¿‡å¤–è„‘ä¿ç•™çŸ¥è¯†åˆ›ä½œçš„ä¸­é—´äº§ç‰©ï¼Œèƒ½å¤ŸåŠ é€Ÿæ–°é¡¹ç›®çš„æˆåŠŸã€‚ä½†å…¶å®æ ¹æœ¬ä¸éœ€è¦æ‰€è°“çš„å¤–è„‘å°±å¤©ç„¶å¦‚æ­¤ã€‚&lt;/p>
&lt;p>æ ¹æ®è¾“å…¥-å†…åŒ–-è¾“å‡ºè¿™æ ·ä¸€ä¸ªç¬¼ç»Ÿçš„å­¦ä¹ æµç¨‹ï¼Œä¸ªäººç†è§£æœ€åä¸€ä¸ªé˜¶æ®µæ˜¯è¦å°†çŸ¥è¯†å°½é‡åœ°å­¦ä»¥è‡´ç”¨ï¼Œã€Œç”¨ã€çš„æ–¹å¼å¯ä»¥æ˜¯åœ¨å·¥ä½œæˆ–ä¸ªäººé¡¹ç›®ä¸­å®è·µï¼Œé€šè¿‡å†™ä½œæˆ–å…¶ä»–åª’ä»‹æ•™æˆç»™ä»–äººï¼Œä»¥åŠç›´æ¥å‚ä¸æœ‰å…³è¯¥çŸ¥è¯†çš„è®¨è®ºï¼Œæ€»ä¹‹è¦å°†å¸æ”¶å½’çº³çš„çŸ¥è¯†è¡¨è¾¾åˆ°å¤–éƒ¨ç¯å¢ƒè·å¾—åé¦ˆã€‚&lt;/p>
&lt;h2 id="åç»­ç« èŠ‚">åç»­ç« èŠ‚&lt;/h2>
&lt;p>åé¢çš„ç« èŠ‚ä»æ ‡é¢˜æ¥çœ‹ååˆ†æŠ½è±¡ï¼Œæ²¡æœ‰ç»§ç»­çœ‹ä¸‹å»çš„æ¬²æœ›äº†ã€‚&lt;/p>
&lt;ul>
&lt;li>Chapter 8ï¼šThe Art of Creative Execution&lt;/li>
&lt;li>Chapter 9ï¼šThe Essential Habits of Digital Organizers&lt;/li>
&lt;li>Chapter 10ï¼šThe Path of Self-Expression&lt;/li>
&lt;/ul>
&lt;h2 id="ä¹¦è¯„">ä¹¦è¯„&lt;/h2>
&lt;h3 id="ä¸è¶³ä¹‹å¤„">ä¸è¶³ä¹‹å¤„&lt;/h3>
&lt;ul>
&lt;li>ä¹¦ä¸­æ¯ä¸€ç« éƒ½ä¼šä»¥åäººè½¶äº‹ä½œä¸ºå¼€å¤´ï¼Œæ¥ä½è¯æœ¬èŠ‚æ‰€æŠ›å‡ºçš„æ–¹æ¡ˆæˆ–è®ºç‚¹çš„å¿…è¦æ€§å’Œæœ‰æ•ˆæ€§ï¼Œä½†é€»è¾‘ååˆ†ç‰µå¼ºï¼Œä¸ªäººå»ºè®®ç›´æ¥è·³è¿‡è¿™éƒ¨åˆ†ã€‚&lt;/li>
&lt;li>ååŠéƒ¨åˆ†çš„ç« èŠ‚æœ‰å……å­—æ•°çš„å«Œç–‘ï¼Œå……æ–¥ç€å¯¹å¤–è„‘æ¦‚å¿µçš„åˆ»æ„å¼ºåŒ–å’Œè½¬åŒ–ä¸ºæ•ˆç›Šçš„æ‰¿è¯ºï¼Œå®é™…ä¸Šè¨€ä¹‹æ— ç‰©ã€‚å°èŠ‚ä¹‹é—´ç¼ºä¹é€»è¾‘è¿è´¯æ€§ï¼Œä»åç§°æ¥çœ‹å¾ˆå¤šç« èŠ‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ›´åƒæ˜¯åšå®¢æ–‡ç« çš„å †ç Œç»„åˆã€‚&lt;/li>
&lt;li>è¿™ç±»è‡ªæˆ‘æˆé•¿ä¹¦ç±çš„å…±æ€§ï¼šä¸ºè§£å†³æŸä¸€é—®é¢˜ï¼Œä½œè€…ä¼šå°è¯•åˆ›é€ ä¸€å¥—é€‚åˆæ‰€æœ‰è¯»è€…çš„ä½“ç³»æˆ–æ–¹æ³•ï¼Œä½†å½“ä½ å‘ç°è¿™äº›æ–¹æ³•ä¸é€‚åˆè‡ªå·±ï¼Œæˆ–è€…å·²ç»åœ¨å®è·µç±»ä¼¼çš„æˆ–æ›´æœ‰æ•ˆçš„æ–¹æ³•æ—¶ï¼Œå°±ä¼šå¤±å»ç»§ç»­è¯»ä¸‹å»çš„åŠ¨åŠ›ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="è¿™æœ¬ä¹¦å€¼å¾—ä¸€è¯»å—">è¿™æœ¬ä¹¦å€¼å¾—ä¸€è¯»å—&lt;/h3>
&lt;p>è¯´è¯´æˆ‘çš„ä¸ªäººä½“éªŒï¼Œå¼€å§‹è¯»è¿™æœ¬ä¹¦çš„æ—¶å€™æœŸå¾…å¾ˆé«˜ï¼Œå› ä¸ºæ£€è§†ç›®å½•æ—¶å‘ç°ä½œè€…æå‡ºäº†è®¸å¤šæ–°çš„æ¦‚å¿µå’Œæ–¹æ³•è®ºï¼Œä¹‹å‰ä¹Ÿè¢«æ¨èè¿‡ä½œè€…çš„ Youtube é¢‘é“å’Œä¸ªäººç½‘ç«™ã€‚ä½†è¯»åˆ°ä¸€åŠå‘ç°å¦‚é£Ÿé¸¡è‚‹ï¼šæƒ³å°±æ­¤æ”¾å¼ƒï¼Œä½†å·²ç»èŠ±äº†æ—¶é—´è¯»äº†ä¸€åŠå¤šäº†ï¼›ç»§ç»­è¯»ä¸‹å»ï¼Œåé¢çš„ç« èŠ‚æ³¨æ°´ä¸¥é‡ï¼Œä¹Ÿåš¼ä¸å‡ºä»€ä¹ˆå‘³æ¥ã€‚æœ€åå®åœ¨ä¸æƒ³æµªè´¹æ—¶é—´åŠé€”è€ŒåºŸäº†ã€‚&lt;/p>
&lt;p>ä¹¦ä¸­æœ‰ç”¨çš„å†…å®¹è¿˜æ˜¯æœ‰çš„ï¼Œä½œè€…æå€¡çš„&lt;strong>å¤šè®°ç¬”è®°&lt;/strong>ä»¥åŠæç‚¼çš„ &lt;strong>CODE&lt;/strong> å››æ­¥éª¤å’Œ &lt;strong>PARA&lt;/strong> ç³»ç»Ÿéƒ½æœ‰å¯å–ä¹‹å¤„ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæœ€å¤§çš„æ”¶è·æ˜¯å¼ºåŒ–äº†çŸ¥è¯†ç®¡ç†ç³»ç»Ÿçš„é‡è¦æ€§ï¼Œæ¨åŠ¨äº†è‡ªå·±å¯¹ç°æœ‰çŸ¥è¯†ç®¡ç†ç³»ç»Ÿçš„æ€è€ƒå’Œä¼˜åŒ–ã€‚&lt;/p>
&lt;p>å¦‚æœä½ å¹³æ—¶å·²ç»åœ¨å®è·µç»ˆèº«å­¦ä¹ ç†å¿µï¼Œå¯¹ Notionï¼ŒObsidianï¼ŒLogseqï¼ŒRoam Research ç­‰ç¬”è®°åº”ç”¨å¦‚æ•°å®¶çï¼Œæœ‰ä½¿ç”¨ Pocketã€InstaPaper ä»¥åŠ RSS é˜…è¯»å™¨çš„ä¹ æƒ¯ï¼Œå¯¹åŒå‘é“¾æ¥ã€æ»‘ç®±å¡ç‰‡ç¬”è®°ã€å¢æ›¼ç­‰åè¯éƒ½ä¸é™Œç”Ÿï¼ˆå°¤å…¶æ˜¯å°‘æ•°æ´¾ç½‘ç«™è¯»è€…ï¼‰ï¼Œè¿™æœ¬ä¹¦é‡Œå¯¹ä½ æœ‰ç”¨çš„ä¿¡æ¯ææ‰æ°´åˆ†é¡¶å¤šåªæœ‰ä¸€ç¯‡åšå®¢ï¼Œæˆ‘ä¸å»ºè®®ä½ æµªè´¹æ—¶é—´å»è¯»è‹±æ–‡åŸæ–‡ã€‚&lt;/p>
&lt;p>å¦‚æœä½ ä¸æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œä½†æƒ³æå‡è‡ªå·±åŸºäºæ•°å­—åª’ä½“çš„å­¦ä¹ èƒ½åŠ›ï¼Œæˆ‘æ¨èä½ çœ‹çœ‹æœ¬ä¹¦çš„å‰ä¸¤éƒ¨åˆ†ã€‚&lt;/p></content><category scheme="https://waynerv.com/categories/%E7%AC%94%E8%AE%B0%E6%80%BB%E7%BB%93/" term="ç¬”è®°æ€»ç»“" label="ç¬”è®°æ€»ç»“"/><category scheme="https://waynerv.com/tags/%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/" term="çŸ¥è¯†ç®¡ç†" label="çŸ¥è¯†ç®¡ç†"/></entry><entry><title type="text">å¦‚ä½•ä¼˜åŒ– docker é•œåƒä½“ç§¯</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/how-to-reduce-docker-image-size/"/><id>https://waynerv.com/posts/how-to-reduce-docker-image-size/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-07-17T09:29:18+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">ä»‹ç»ä¸€ç‚¹ docker é•œåƒä½“ç§¯ä¼˜åŒ–çš„å…ˆè¿›ç»éªŒã€‚</summary><content type="html">&lt;p>æœ€è¿‘åœ¨æ¥æ‰‹ä¸€ä¸ªæ–°é¡¹ç›®åï¼Œå°†åŸæœ¬ 1.6GB çš„é•œåƒç²¾ç®€åˆ°äº† 600 å¤šMBï¼Œç›´æ¥è¿›å…¥äº†è´¤è€…æ—¶é—´ï¼Œç‰¹åœ°è®°å½•ä¸‹ä¼˜åŒ–è¿‡ç¨‹ä¸­æ€»ç»“çš„ä¸€äº›ç»éªŒã€‚&lt;/p>
&lt;h2 id="ç†è®ºä¾æ®">ç†è®ºä¾æ®&lt;/h2>
&lt;p>é•œåƒçš„æœ¬è´¨æ˜¯é•œåƒå±‚å’Œè¿è¡Œé…ç½®æ–‡ä»¶ç»„æˆçš„å‹ç¼©åŒ…ï¼Œæ„å»ºé•œåƒæ˜¯é€šè¿‡è¿è¡Œ Dockerfile ä¸­çš„ &lt;code>RUN&lt;/code> ã€&lt;code>COPY&lt;/code> å’Œ &lt;code>ADD&lt;/code> ç­‰æŒ‡ä»¤ç”Ÿæˆé•œåƒå±‚å’Œé…ç½®æ–‡ä»¶çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>åœ¨æˆ‘å»å¹´å†™çš„åšå®¢ &lt;a href="https://waynerv.com/posts/container-fundamentals-learn-container-with-oci-spec/#%E9%95%9C%E5%83%8F%E8%A7%84%E8%8C%83">å®¹å™¨æŠ€æœ¯åŸç†(ä¸€)ï¼šä»æ ¹æœ¬ä¸Šè®¤è¯†å®¹å™¨é•œåƒ | Shall We Code?&lt;/a> ä¸­ï¼Œè¯¦ç»†è§£é‡Šäº†é•œåƒç»„æˆã€è”åˆæ–‡ä»¶ç³»ç»ŸåŠå…¶å·¥ä½œæ–¹å¼ç­‰ç†è®ºï¼Œæœ¬æ–‡ä¸å†èµ˜è¿°ï¼Œåªä»ä¸­æå–å’Œé•œåƒä½“ç§¯æœ‰å…³çš„å…³é”®ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>RUN&lt;/code>ã€&lt;code>COPY&lt;/code> å’Œ &lt;code>ADD&lt;/code> æŒ‡ä»¤ä¼šåœ¨å·²æœ‰é•œåƒå±‚çš„åŸºç¡€ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„é•œåƒå±‚ï¼Œæ‰§è¡ŒæŒ‡ä»¤äº§ç”Ÿçš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿå˜æ›´ä¼šåœ¨æŒ‡ä»¤ç»“æŸåä½œä¸ºä¸€ä¸ªé•œåƒå±‚æ•´ä½“æäº¤ã€‚&lt;/li>
&lt;li>é•œåƒå±‚å…·æœ‰ &lt;code>copy-on-write&lt;/code> çš„ç‰¹æ€§ï¼Œå¦‚æœå»æ›´æ–°å…¶ä»–é•œåƒå±‚ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œä¼šå…ˆå°†å…¶å¤åˆ¶åˆ°æ–°çš„é•œåƒå±‚ä¸­å†ä¿®æ”¹ï¼Œé€ æˆåŒå€çš„æ–‡ä»¶ç©ºé—´å ç”¨ã€‚&lt;/li>
&lt;li>å¦‚æœå»åˆ é™¤å…¶ä»–é•œåƒå±‚çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œåªä¼šåœ¨å½“å‰é•œåƒå±‚ç”Ÿæˆä¸€ä¸ªè¯¥æ–‡ä»¶çš„åˆ é™¤æ ‡è®°ï¼Œå¹¶ä¸ä¼šå‡å°‘æ•´ä¸ªé•œåƒçš„å®é™…ä½“ç§¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸Šè¿°ç†è®ºå¯ä»¥é€šè¿‡å¦‚ä¸‹ Dockerfile æ¥éªŒè¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine:latest&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> resource.tar /&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> touch /resource.tar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> rm -f /resource.tar&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/ash&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬åœ¨ Dockerfile ä¸­ç®€å•åœ°æ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤æŸä¸ªèµ„æºæ–‡ä»¶ï¼Œç„¶åæ„å»ºé•œåƒæŸ¥çœ‹å…¶é•œåƒå±‚ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ docker build -t test-image -f Dockerfile .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker &lt;span class="nb">history&lt;/span> test-image:latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">IMAGE CREATED CREATED BY SIZE COMMENT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">95f1695b2904 About a minute ago /bin/sh -c &lt;span class="c1">#(nop) ENTRYPOINT [&amp;#34;/bin/ash&amp;#34;] 0B&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1780448c656f About a minute ago /bin/sh -c rm -f /resource.tar 0B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">a85d29bf7738 About a minute ago /bin/sh -c touch /resource.tar 135MB
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6dac335fa653 &lt;span class="m">4&lt;/span> minutes ago /bin/sh -c &lt;span class="c1">#(nop) COPY file:66065d6e23e0bc52â€¦ 135MB&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e66264b98777 &lt;span class="m">7&lt;/span> weeks ago /bin/sh -c &lt;span class="c1">#(nop) CMD [&amp;#34;/bin/sh&amp;#34;] 0B&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt;missing&amp;gt; &lt;span class="m">7&lt;/span> weeks ago /bin/sh -c &lt;span class="c1">#(nop) ADD file:8e81116368669ed3dâ€¦ 5.53MB&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ &lt;code>docker history&lt;/code> çš„è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>RUN touch /resource.tar&lt;/code> æŒ‡ä»¤åªæ˜¯ä¿®æ”¹äº†æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œä½†ä¾ç„¶å°†æ•´ä¸ªæ–‡ä»¶æ‹·è´åˆ°äº†æ–°çš„é•œåƒå±‚ä¸­ã€‚&lt;/li>
&lt;li>&lt;code>RUN rm -f /resource.tar&lt;/code> æŒ‡ä»¤è™½ç„¶åˆ é™¤äº†æ–‡ä»¶ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶åœ¨è¿è¡Œå®¹å™¨æ—¶ä¸å¯è§ï¼Œä½†ä¾ç„¶åœ¨å‰ä¸¤ä¸ªé•œåƒå±‚ä¸­ä»¥åŠæœ€ç»ˆçš„é•œåƒä¸­å­˜åœ¨ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="åˆ†æå·¥å…·">åˆ†æå·¥å…·&lt;/h2>
&lt;p>ç»™ä»£ç åšæ€§èƒ½è°ƒä¼˜æ—¶ï¼Œé¦–å…ˆè¦å€ŸåŠ© Profiling å·¥å…·æ‰¾åˆ°ä»£ç çš„æ€§èƒ½ç“¶é¢ˆï¼Œå¯¹äºä¼˜åŒ–é•œåƒä½“ç§¯ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸‹é¢ä»‹ç»ä¸¤ä¸ªå¯ä»¥åˆ†æé•œåƒä½“ç§¯çš„å·¥å…·ï¼š&lt;/p>
&lt;h3 id="docker-history">docker history&lt;/h3>
&lt;p>docker è‡ªå¸¦çš„ &lt;code>docker history&lt;/code> å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å¯ä»¥å±•ç¤ºæ‰€æœ‰é•œåƒå±‚çš„åˆ›å»ºæ—¶é—´ã€æŒ‡ä»¤ä»¥åŠä½“ç§¯ç­‰è¾ƒä¸ºåŸºç¡€çš„ä¿¡æ¯ï¼Œä½†å¯¹äºå¤æ‚çš„é•œåƒåˆ™æœ‰äº›ä¹åŠ›ã€‚ä½¿ç”¨æ–¹å¼è§ä¸Šæ–¹çš„ç¤ºä¾‹ã€‚&lt;/p>
&lt;h3 id="dive">dive&lt;/h3>
&lt;p>ç¬¬ä¸‰æ–¹çš„ &lt;code>dive&lt;/code> å·¥å…·ï¼Œè¯¥å·¥å…·å¯ä»¥åˆ†æé•œåƒå±‚ç»„æˆï¼Œå¹¶åˆ—å‡ºæ¯ä¸ªé•œåƒå±‚æ‰€åŒ…å«çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®šä½åˆ°å½±å“é•œåƒä½“ç§¯çš„æ„å»ºæŒ‡ä»¤ä»¥åŠå…·ä½“æ–‡ä»¶ã€‚&lt;/p>
&lt;p>ä»¥ &lt;code>golang:1.16&lt;/code> é•œåƒä¸ºä¾‹ï¼Œé¦–å…ˆ&lt;a href="https://github.com/wagoodman/dive#installation">å®‰è£… dive&lt;/a>ï¼Œç„¶åæ‰§è¡Œ &lt;code>dive golang:1.16&lt;/code>ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="docker-image-dive.png" alt="dive image">&lt;/p>
&lt;p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨å·¦ä¾§é€‰ä¸­é•œåƒå±‚åï¼Œåœ¨å³ä¾§çš„æ–‡ä»¶æ ‘è§†å›¾ä¸­å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è¯¥å±‚çš„å…·ä½“æ–‡ä»¶ï¼Œå¹¶èƒ½å¤Ÿç­›é€‰ç›¸æ¯”ä¸Šä¸€å±‚æ–°å¢ã€æ›´æ–°æˆ–åˆ é™¤çš„æ–‡ä»¶ã€‚åœ¨é€‰ä¸­çš„é•œåƒå±‚ä¸­ï¼Œç”±äºæ‰§è¡Œäº† &lt;code>apt-get&lt;/code> å®‰è£…ç¼–è¯‘ä¾èµ–ï¼Œå› æ­¤åœ¨ &lt;code>/usr/lib&lt;/code> ç›®å½•ä¸‹æ–°å¢äº† 150MB ä¾èµ–åº“æ–‡ä»¶ã€‚&lt;/p>
&lt;h2 id="ä¼˜åŒ–æŠ€å·§">ä¼˜åŒ–æŠ€å·§&lt;/h2>
&lt;p>ä¸‹é¢ä»‹ç»ä¸€äº›ä¼˜åŒ–æ•ˆæœæ¯”è¾ƒæ˜¾è‘—çš„ä¼˜åŒ–æŠ€å·§ã€‚&lt;/p>
&lt;h3 id="åˆ†é˜¶æ®µæ„å»ºä¸ä»é›¶æ„å»º">åˆ†é˜¶æ®µæ„å»ºä¸ä»é›¶æ„å»º&lt;/h3>
&lt;p>&lt;strong>åˆ†é˜¶æ®µæ„å»º&lt;/strong>ï¼ˆmulti-stage buildsï¼‰å’Œ&lt;strong>ä»é›¶æ„å»º&lt;/strong>ï¼ˆbuild from scratchï¼‰æ˜¯ä¼˜åŒ–é•œåƒä½“ç§¯çš„åŸºæœ¬æ‰‹æ®µå’Œå¿…å¤‡æŠ€å·§ã€‚è¯¥æŠ€å·§å°†é•œåƒæ„å»ºè¿‡ç¨‹åŒºåˆ†ä¸ºæ„å»ºå’Œè¿è¡Œç¯å¢ƒï¼Œåœ¨æ„å»ºç¯å¢ƒå®‰è£…ç¼–è¯‘å™¨ç­‰ä¾èµ–å¹¶ç¼–è¯‘æ‰€éœ€çš„äºŒè¿›åˆ¶åŒ…ï¼Œç„¶åå°†å…¶å¤åˆ¶åˆ°ä»…åŒ…å«å¿…è¦è¿è¡Œä¾èµ–çš„è¿è¡Œç¯å¢ƒä¸­ã€‚&lt;/p>
&lt;p>å¯¹ golang è¿™ç±»èƒ½å¤Ÿç¼–è¯‘é™æ€äºŒè¿›åˆ¶æ–‡ä»¶çš„è¯­è¨€æ¥è¯´åˆ†é˜¶æ®µæ„å»ºçš„æ•ˆæœå°¤ä¸ºæ˜æ˜¾ï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¼–è¯‘äº§ç”Ÿçš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åˆ° &lt;code>scratch&lt;/code> é•œåƒä¸­è¿è¡Œï¼ˆ&lt;code>scratch&lt;/code> æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç©ºé•œåƒï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> hell0.go .&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENV&lt;/span> &lt;span class="nv">CGO_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">RUN&lt;/span> go build hello.go&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> scratch&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>&lt;span class="m">0&lt;/span> /go/hello .&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;./hello&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœç›´æ¥ä½¿ç”¨ golang é•œåƒä½œä¸ºè¿è¡Œç¯å¢ƒï¼Œå…¶é•œåƒä½“ç§¯é€šå¸¸æ¥è¿‘ 1 ä¸ª Gï¼Œå…¶ä¸­å¤§éƒ¨åˆ†æ–‡ä»¶éƒ½ä¸æ˜¯åœ¨è¿è¡Œå®¹å™¨æ—¶æ‰€å¿…è¦çš„ã€‚
å°†ç¼–è¯‘ç»“æœæ‹·è´åˆ°è¿è¡Œç¯å¢ƒåï¼Œä½“ç§¯åªæœ‰å‡ å kb~mb ä¸ç­‰ï¼Œå¦‚æœéœ€è¦åœ¨è¿è¡Œå®¹å™¨ä¸­ä¿ç•™åŸºæœ¬çš„ç³»ç»Ÿå·¥å…·ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ alpine é•œåƒä½œä¸ºè¿è¡Œç¯å¢ƒã€‚&lt;/p>
&lt;p>å…³äºåˆ†é˜¶æ®µæ„å»ºå’Œä»é›¶æ„å»ºçš„æ›´å¤šç»†èŠ‚å¯å‚è€ƒ Docker å®˜æ–¹æ–‡æ¡£ä¸­çš„ &lt;a href="https://docs.docker.com/develop/develop-images/multistage-build/">Use multi-stage builds&lt;/a> å’Œ &lt;a href="https://docs.docker.com/develop/develop-images/baseimages/#create-a-simple-parent-image-using-scratch">Create a simple parent image using scratch&lt;/a>ã€‚&lt;/p>
&lt;h3 id="é¿å…äº§ç”Ÿæ— ç”¨çš„æ–‡æ¡£æˆ–ç¼“å­˜">é¿å…äº§ç”Ÿæ— ç”¨çš„æ–‡æ¡£æˆ–ç¼“å­˜&lt;/h3>
&lt;p>docker é•œåƒä¸åº”è¯¥åŒ…å«æ–‡æ¡£ã€ç¼“å­˜ç­‰å¯¹è¿è¡Œå®¹å™¨æ²¡æœ‰ä½œç”¨çš„å†…å®¹ã€‚&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é¿å…åœ¨æœ¬åœ°ä¿ç•™å®‰è£…ç¼“å­˜ã€‚&lt;/p>
&lt;p>å¤§éƒ¨åˆ†åŒ…ç®¡ç†å™¨ä¼šåœ¨å®‰è£…æ—¶ç¼“å­˜ä¸‹è½½çš„èµ„æºä»¥å¤‡ä¹‹åä½¿ç”¨ï¼Œä»¥ pip ä¸ºä¾‹ï¼Œä¼šå°†ä¸‹è½½çš„å“åº”å’Œæ„å»ºçš„ä¸­é—´æ–‡ä»¶ä¿å­˜åœ¨ &lt;code>~/.cache/pip&lt;/code> ç›®å½•ï¼Œåº”ä½¿ç”¨ &lt;code>--no-cache-dir&lt;/code> é€‰é¡¹ç¦ç”¨é»˜è®¤çš„ç¼“å­˜è¡Œä¸ºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é¿å…å®‰è£…æ–‡æ¡£ã€‚&lt;/p>
&lt;p>éƒ¨åˆ†åŒ…ç®¡ç†å™¨æä¾›äº†é€‰é¡¹å¯ä»¥ä¸å®‰è£…é™„å¸¦çš„æ–‡æ¡£ï¼Œå¦‚ dnf å¯ä½¿ç”¨ &lt;code>--nodocs&lt;/code> é€‰é¡¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é¿å…ç¼“å­˜åŒ…ç´¢å¼•ã€‚&lt;/p>
&lt;p>éƒ¨åˆ†åŒ…ç®¡ç†å™¨åœ¨æ‰§è¡Œå®‰è£…ä¹‹å‰ï¼Œä¼šå°è¯•æŸ¥è¯¢æ‰€æœ‰å·²å¯ç”¨ä»“åº“çš„åŒ…åˆ—è¡¨ã€ç‰ˆæœ¬ç­‰å…ƒä¿¡æ¯ç¼“å­˜åœ¨æœ¬åœ°ä½œä¸ºç´¢å¼•ã€‚ä¸ªåˆ«ä»“åº“çš„ç´¢å¼•ç¼“å­˜å¯è¾¾åˆ° 150 M ä»¥ä¸Šã€‚
æˆ‘ä»¬åº”è¯¥ä»…åœ¨å®‰è£…åŒ…æ—¶æŸ¥è¯¢ç´¢å¼•ï¼Œå¹¶åœ¨å®‰è£…å®Œæˆåæ¸…ç†ï¼Œä¸åº”è¯¥åœ¨å•ç‹¬çš„æŒ‡ä»¤ä¸­æ‰§è¡Œ &lt;code>yum makecache&lt;/code> è¿™ç±»ç¼“å­˜ç´¢å¼•çš„å‘½ä»¤ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶">åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶&lt;/h3>
&lt;p>è¿è¡Œå®¹å™¨æ—¶ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œä¸€å®šè¦åœ¨åˆ›å»ºçš„åŒä¸€å±‚æ¸…ç†ï¼Œå¦åˆ™ä¾ç„¶ä¼šä¿ç•™åœ¨æœ€ç»ˆçš„é•œåƒä¸­ã€‚&lt;/p>
&lt;p>é€šè¿‡åŒ…ç®¡ç†å®‰è£…åŒ…ï¼Œé€šå¸¸ä¼šäº§ç”Ÿå¤§é‡çš„ç¼“å­˜æ–‡ä»¶ï¼Œä¸€å®šè¦åœ¨åŒä¸€ &lt;code>RUN&lt;/code> æŒ‡ä»¤çš„ç»“å°¾å¤„ç«‹åˆ»æ¸…ç†ã€‚åœ¨å®‰è£…ä¾èµ–æ•°é‡è¾ƒå¤šæ—¶ï¼Œå¯ä»¥èŠ‚çœå¤§é‡çš„ç¼“å­˜ç©ºé—´ã€‚&lt;/p>
&lt;p>ä»¥ &lt;code>dnf&lt;/code> ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">RUN&lt;/span> dnf install -y --nodocs &amp;lt;PACKAGES&amp;gt; &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> dnf clean all &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf /var/cache/dnf&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ &lt;code>apt&lt;/code> ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">RUN&lt;/span> apt-get update &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt-get install -y &amp;lt;PACKAGES&amp;gt; &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> rm -rf /var/lib/apt/lists/*&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="c"># å®˜æ–¹çš„ ubuntu/debian é•œåƒ apt-get ä¼šåœ¨å®‰è£…åè‡ªåŠ¨æ‰§è¡Œ clean å‘½ä»¤&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åˆå¹¶å¤šä¸ªé•œåƒå±‚">åˆå¹¶å¤šä¸ªé•œåƒå±‚&lt;/h3>
&lt;p>ä¸Šæ–‡è§£é‡Šè¿‡ï¼Œåº”è¯¥é¿å…åœ¨ä¸åŒé•œåƒå±‚ä¸­æ›´æ–°æ–‡ä»¶è€Œé€ æˆé¢å¤–çš„ä½“ç§¯å ç”¨ã€‚å½“æ„å»ºçš„å±‚æ•°å¾ˆå¤šä¸”æ‰§è¡ŒæŒ‡ä»¤è¾ƒå¤æ‚æ—¶ï¼Œå¾ˆéš¾é¿å…åœ¨ä¸åŒçš„é•œåƒå±‚ä¸­æ›´æ–°æ–‡ä»¶ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ‰‹æ®µç²¾ç®€è¿™éƒ¨åˆ†é¢å¤–ä½“ç§¯ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨æœ€ç»ˆç”Ÿæˆé•œåƒæ—¶å°†æ‰€æœ‰é•œåƒå±‚åˆå¹¶æˆä¸€å±‚ï¼Œåœ¨ &lt;code>docker build&lt;/code> å‘½ä»¤ä¸­ä½¿ç”¨ &lt;code>â€”squash&lt;/code> å³å¯å®ç°ï¼ˆéœ€è¦&lt;a href="https://docs.docker.com/engine/reference/commandline/dockerd/#description">å¼€å¯ docker daemon çš„å®éªŒæ€§åŠŸèƒ½&lt;/a>ï¼‰ã€‚ä»¥æœ¬æ–‡å¼€å¤´çš„ Dockerfile ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">$ docker build -t squash-image --squash -f Dockerfile . &lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>$ docker &lt;span class="nb">history&lt;/span> squash-image&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>IMAGE CREATED CREATED BY SIZE COMMENT&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>55ded8881d63 &lt;span class="m">9&lt;/span> hours ago 0B merge sha256:95f1695b29044522250de1b0c1904aaf8670b991ec1064d086c0c15865051d5d to sha256:e66264b98777e12192600bf9b4d663655c98a090072e1bab49e233d7531d1294&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">11&lt;/span> hours ago /bin/sh -c &lt;span class="c1">#(nop) ENTRYPOINT [&amp;#34;/bin/ash&amp;#34;] 0B&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">11&lt;/span> hours ago /bin/sh -c rm -f /resource.tar 0B&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">11&lt;/span> hours ago /bin/sh -c touch /resource.tar 0B&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">11&lt;/span> hours ago /bin/sh -c &lt;span class="c1">#(nop) COPY file:66065d6e23e0bc52â€¦ 0B&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">7&lt;/span> weeks ago /bin/sh -c &lt;span class="c1">#(nop) CMD [&amp;#34;/bin/sh&amp;#34;] 0B&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&amp;lt;missing&amp;gt; &lt;span class="m">7&lt;/span> weeks ago /bin/sh -c &lt;span class="c1">#(nop) ADD file:8e81116368669ed3dâ€¦ 5.53MB&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€ç»ˆç”Ÿæˆçš„é•œåƒåªæœ‰ä¸€ä¸ªé•œåƒå±‚ï¼ŒåŒ…å«æœ€åå®é™…å­˜åœ¨çš„æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨åˆå¹¶æ‰€æœ‰é•œåƒå±‚çš„è¿‡ç¨‹ä¸­ï¼Œç›¸å½“äºç¦ç”¨äº† &lt;code>copy-on-write&lt;/code> ç‰¹æ€§ã€‚&lt;/p>
&lt;p>è¿™ç§åšæ³•çš„åå¤„åœ¨äºï¼Œé•œåƒåœ¨ä¿å­˜å’Œåˆ†å‘æ—¶æ˜¯å¯ä»¥å¤ç”¨é•œåƒå±‚çš„ï¼Œæ¨é€é•œåƒæ—¶ä¼šè·³è¿‡é•œåƒä»“åº“å·²å­˜åœ¨çš„é•œåƒå±‚ï¼Œæ‹‰å–é•œåƒæ—¶ä¼šè·³è¿‡æœ¬åœ°å·²æ‹‰å–è¿‡çš„é•œåƒå±‚ï¼Œè€Œåˆå¹¶æˆä¸€å±‚ååˆ™å¤±å»äº†è¿™ç§ä¼˜åŠ¿ã€‚&lt;/p>
&lt;p>å¯¹äºå¯èƒ½å’Œå…¶ä»–å…±ç”¨é•œåƒå±‚çš„åœºæ™¯ï¼Œå¯ä»¥é‡‡å–ä¸‹é¢ä¸€ç§æ–¹å¼ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ†é˜¶æ®µæ„å»ºï¼Œå°†éƒ¨åˆ†ä¸­é—´é•œåƒå±‚å‹ç¼©æˆä¸€å±‚ä½œä¸ºåŸºç¡€é•œåƒã€‚
åœ¨å¼€å‘å›¢é˜Ÿå†…éƒ¨ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šåœ¨å®˜æ–¹é•œåƒçš„åŸºç¡€ä¸Šæ·»åŠ æˆ–æ›´æ–°éƒ¨åˆ†ä¾èµ–ï¼Œç„¶åä½œä¸ºå›¢é˜Ÿå†…éƒ¨ç»Ÿä¸€ä½¿ç”¨çš„åŸºç¡€é•œåƒï¼Œè¿™ç§å¤ç”¨æ–¹å¼å¯ä»¥å¤§å¤§å‡å°‘å®é™…å ç”¨çš„é•œåƒä½“ç§¯ã€‚
æ›´è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ç±»åŸºç¡€é•œåƒå‹ç¼©æˆä¸€å±‚ã€‚ä¸‹é¢ä»¥ golang å®˜æ–¹é•œåƒä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> golang:1.16 as base&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> scratch&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>base / /&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ENTRYPOINT&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;/bin/bash&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‹ç¼©æˆä¸€å±‚åï¼Œ&lt;code>golang:1.16&lt;/code> çš„é•œåƒä½“ç§¯ä» 919MB å˜æˆ 913MBï¼Œå®˜æ–¹é•œåƒå·²ç»åšäº†å¾ˆå¤šä¼˜åŒ–æ‰€ä»¥èŠ‚çœç©ºé—´ååˆ†æœ‰é™ï¼Œä½†å¯¹äºå¼€å‘å›¢é˜Ÿå†…éƒ¨åˆ¶ä½œçš„åŸºç¡€é•œåƒï¼Œè¿™ç§ä¼˜åŒ–å¾€å¾€ä¼šå¸¦æ¥æ„å¤–æƒŠå–œã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="å¤åˆ¶æ–‡ä»¶çš„åŒæ—¶ä¿®æ”¹å…ƒä¿¡æ¯">å¤åˆ¶æ–‡ä»¶çš„åŒæ—¶ä¿®æ”¹å…ƒä¿¡æ¯&lt;/h3>
&lt;p>é¦–å…ˆå°†å¯æ‰§è¡Œæ–‡ä»¶æ·»åŠ åˆ°é•œåƒå†…ï¼Œç„¶åå†ä¿®æ”¹æ–‡ä»¶çš„æ‰§è¡Œæƒé™å’Œæ‰€å±ç”¨æˆ·ï¼Œè¿™ç±» COPY-RUN æŒ‡ä»¤åœ¨ Dockerfile ä¸­ååˆ†å¸¸è§ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">COPY&lt;/span> output/hello /usr/bin/hello&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> chmod +x /usr/bin/hello &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> chown normal:normal /usr/bin/hello&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†ç”±äºä¿®æ”¹æ–‡ä»¶å…ƒä¿¡æ¯ä¹Ÿä¼šå°†æ–‡ä»¶å¤åˆ¶åˆ°æ–°çš„é•œåƒå±‚ï¼Œä»¥ä¸ŠæŒ‡ä»¤ä¼šäº§ç”Ÿä¸¤ä»½ç›¸åŒçš„æ–‡ä»¶ã€‚åœ¨æ–‡ä»¶ä½“ç§¯è¾ƒå¤§æ—¶ï¼Œä¼šæ˜¾è‘—å¢åŠ æ•´ä¸ªé•œåƒçš„ä½“ç§¯ã€‚
äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å¤åˆ¶æ–‡ä»¶çš„åŒæ—¶å®Œæˆå¯¹æ–‡ä»¶å…ƒä¿¡æ¯çš„ä¿®æ”¹ï¼Œ&lt;code>COPY&lt;/code> å’Œ &lt;code>ADD&lt;/code> æŒ‡ä»¤éƒ½æä¾›äº†ä¿®æ”¹å…ƒä¿¡æ¯çš„ &lt;code>--chmod&lt;/code> å’Œ &lt;code>--chown&lt;/code> é€‰é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-docker" data-lang="docker">&lt;span class="line">&lt;span class="cl">&lt;span class="k">COPY&lt;/span> --chmod&lt;span class="o">=&lt;/span>&lt;span class="m">755&lt;/span> --chown&lt;span class="o">=&lt;/span>normal:normal output/hello /usr/bin/hello&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>--chmod&lt;/code> ç‰¹æ€§ç›®å‰è¿˜æœªæ·»åŠ åˆ°å®˜æ–¹æ–‡æ¡£ï¼Œä½¿ç”¨å‰éœ€è¦&lt;a href="https://docs.docker.com/develop/develop-images/build_enhancements/">å¼€å¯ docker çš„ buildkit ç‰¹æ€§&lt;/a>ï¼ˆåœ¨ &lt;code>docker build&lt;/code> å‘½ä»¤å‰æ·»åŠ  &lt;code>DOCKER_BUILDKIT=1&lt;/code> å³å¯ï¼‰ï¼Œç›®å‰åªæ”¯æŒ &lt;code>--chmod=755&lt;/code> å’Œ &lt;code>--chmod=0755&lt;/code> è¿™ç§è®¾ç½®æ–¹æ³•ï¼Œä¸æ”¯æŒ &lt;code>--chmod=+x&lt;/code>ã€‚&lt;/p>
&lt;p>æ³¨ï¼šç»æµ‹è¯•ï¼Œå½“ä½¿ç”¨ &lt;code>ADD&lt;/code> æŒ‡ä»¤ä¸”æºæ–‡ä»¶ä¸ºä¸‹è½½é“¾æ¥æ—¶ &lt;code>--chmod&lt;/code> é€‰é¡¹ä¸èµ·ä½œç”¨ï¼Œä¸æ¸…æ¥šè¿™æ˜¯ docker çš„ bug è¿˜æ˜¯ featureã€‚è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥ä½¿ç”¨ &lt;code>RUN&lt;/code> æŒ‡ä»¤ &lt;code>wget + chmod&lt;/code> æ¥æ›¿ä»£ &lt;code>ADD&lt;/code>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">Best practices for writing Dockerfiles | Docker Documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.redhat.com/sysadmin/tiny-containers">How to build tiny container images | Enable Sysadmin&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.vamc19.dev/posts/dockerfile-copy-chmod/">COPY --chmod reduced the size of my container image by 35%&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.ardanlabs.com/blog/2020/02/docker-images-part1-reducing-image-size.html">Docker Images : Part I - Reducing Image Size&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/docker/" term="Docker" label="Docker"/></entry><entry><title type="text">å¦‚ä½•ä½¿ç”¨ PostgreSQL 14 çš„æŒç»­å½’æ¡£å¤‡ä»½å’ŒåŸºäºæ—¶é—´ç‚¹æ¢å¤</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/postgresql-14-continuous-archiving-and-pitr/"/><id>https://waynerv.com/posts/postgresql-14-continuous-archiving-and-pitr/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-07-10T19:41:15+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">ç®€å•ä»‹ç»å¦‚ä½•ä½¿ç”¨ PostgreSQL 14 çš„æŒç»­å½’æ¡£å¤‡ä»½ä»¥åŠåŸºäºæ—¶é—´ç‚¹æ¢å¤åŠŸèƒ½ã€‚</summary><content type="html">&lt;h2 id="æŒç»­å½’æ¡£å¤‡ä»½">æŒç»­å½’æ¡£å¤‡ä»½&lt;/h2>
&lt;p>pg æœ‰ä¸‰ç§åŸºæœ¬çš„å¤‡ä»½æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>åˆ©ç”¨ &lt;code>pg_dump&lt;/code> è¿›è¡Œ sql dumpï¼Œå±äºé€»è¾‘å¤‡ä»½æ— æ³•æ¢å¤åˆ°æŒ‡å®šçŠ¶æ€ã€‚&lt;/li>
&lt;li>åŸºäºæ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ï¼Œéœ€è¦æ–‡ä»¶ç³»ç»Ÿæä¾›å¿«ç…§åŠŸèƒ½ä¿è¯ä¸€è‡´æ€§ï¼Œå¦åˆ™&lt;strong>å¿…é¡»&lt;/strong>åœæœºå¤‡ä»½ã€‚&lt;/li>
&lt;li>æŒç»­å½’æ¡£ï¼Œé¦–é€‰çš„é«˜å¯é æ€§å¤‡ä»½æŠ€æœ¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>WAL æ—¥å¿—æŒç»­å½’æ¡£æ˜¯å®ç°å½’æ¡£å¤‡ä»½çš„å…³é”®ï¼ŒæŠŠä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„å¤‡ä»½å’Œå½’æ¡£çš„ WAL æ–‡ä»¶ç»“åˆèµ·æ¥ï¼Œå½“éœ€è¦æ¢å¤æ—¶ï¼Œå…ˆæ¢å¤æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ï¼Œç„¶åé‡æ”¾å½’æ¡£çš„ WAL æ–‡ä»¶æŠŠç³»ç»Ÿæ¢å¤åˆ°å½“å‰ï¼ˆæˆ–æŒ‡å®šçš„æ—¶é—´ç‚¹ï¼‰çŠ¶æ€ã€‚&lt;/p>
&lt;p>æŒç»­å½’æ¡£çš„ä¼˜ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸éœ€è¦å®Œå…¨ä¸€è‡´çš„æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ï¼Œé€šè¿‡ä»é‡åšç‚¹é‡æ”¾ WAL åˆ°è¾¾ä¸€è‡´çŠ¶æ€ï¼Œå› æ­¤å¯ä½¿ç”¨ç®€å•å·¥å…·åœ¨ä¸åœæœºçŠ¶æ€ä¸‹åˆ¶ä½œåŸºç¡€å¤‡ä»½ã€‚&lt;/li>
&lt;li>ç®€å•åœ°æŒç»­å½’æ¡£ WAL æ–‡ä»¶å³å¯åœ¨æ— æ³•é¢‘ç¹å®Œå…¨å¤‡ä»½çš„æƒ…å†µä¸‹å®ç°è¿ç»­å¤‡ä»½ã€‚&lt;/li>
&lt;li>åˆ©ç”¨åŸºç¡€å¤‡ä»½å’Œ WAL å­˜æ¡£é‡æ”¾åˆ°æŒ‡å®šæ—¶é—´ç‚¹å¯ä»¥å°†æ•°æ®åº“æ¢å¤åˆ°åŸºç¡€å¤‡ä»½ä¹‹åçš„ä»»æ„æ—¶é—´ç‚¹ã€‚&lt;/li>
&lt;li>è¿ç»­åœ°ä¼ è¾“ WAL å½’æ¡£æ–‡ä»¶åˆ°å¦ä¸€å°å·²åº”ç”¨ç›¸åŒåŸºç¡€å¤‡ä»½çš„æœºå™¨ï¼Œå³å¯å®ç°ä¸»å¤‡å¤åˆ¶ç³»ç»Ÿã€‚&lt;/li>
&lt;/ul>
&lt;p>ç¼ºç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>åªèƒ½å¤‡ä»½æ¢å¤æ•´ä¸ªæ•°æ®åº“é›†ç°‡ï¼Œä¸æ”¯æŒæ›´ç»†ç²’åº¦ã€‚&lt;/li>
&lt;li>åŸºç¡€å¤‡ä»½å’ŒæŒç»­å½’æ¡£æ–‡ä»¶ä¼šå ç”¨å¤§é‡ç©ºé—´ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å¼€å¯-wal-å½’æ¡£">å¼€å¯ WAL å½’æ¡£&lt;/h3>
&lt;p>pg é»˜è®¤åœ¨ &lt;code>pg_wal&lt;/code> ç›®å½•æŒç»­ç”Ÿæˆ 16M å¤§å°çš„ WAL æ®µæ–‡ä»¶ï¼Œæ²¡æœ‰å¼€å¯å½’æ¡£æ¨¡å¼æ—¶ pg ä¼šå¯¹ WAL æ®µæ–‡ä»¶è¿›è¡Œæ¸…ç†å’Œå›æ”¶ã€‚&lt;/p>
&lt;p>å½’æ¡£è¿‡ç¨‹æ˜¯å°†æ£€æŸ¥ç‚¹ä¹‹å‰çš„ WAL æ®µæ–‡ä»¶ä» &lt;code>pg_wal&lt;/code> ç›®å½•ä¼ è¾“åˆ°æŒ‡å®šä½ç½®ï¼ˆå¦‚å¤åˆ¶åˆ°ç”¨æˆ·è‡ªå®šä¹‰çš„ç›®å½•ï¼‰ï¼Œä¼ è¾“æˆåŠŸååŸæœ‰çš„ WAL æ®µæ–‡ä»¶å°†è¢«æ¸…é™¤æˆ–å›æ”¶ï¼ŒæœªæˆåŠŸå°†ä¿ç•™æ–‡ä»¶å¹¶ä¸æ–­é‡è¯•å½’æ¡£å‘½ä»¤ã€‚&lt;/p>
&lt;p>pg å½’æ¡£è¿‡ç¨‹å…·æœ‰æé«˜å¯æ‰©å±•æ€§ï¼Œä¼ è¾“è¿‡ç¨‹å³æ‰§è¡Œç”¨æˆ·æä¾›çš„ä¸€æ¡ shell å‘½ä»¤ï¼Œä¼ è¾“çš„å…·ä½“æ–¹å¼å’Œç›®æ ‡ä½ç½®å®Œå…¨ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼Œä»…æ ¹æ®å‘½ä»¤è¿”å›ç åˆ¤æ–­å½’æ¡£æ˜¯å¦æˆåŠŸã€‚&lt;/p>
&lt;p>å¼€å¯ WAL å½’æ¡£çš„é…ç½®ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">wal_level&lt;/span> &lt;span class="o">=&lt;/span> replica &lt;span class="c1"># æˆ–æ›´é«˜çº§åˆ«&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">archive_mode&lt;/span> &lt;span class="o">=&lt;/span> on
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">archive_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;test ! -f /mnt/server/archivedir/%f &amp;amp;&amp;amp; cp %p /mnt/server/archivedir/%f&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…³äºå½’æ¡£å‘½ä»¤æœ‰ä»¥ä¸‹æ³¨æ„ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>å½’æ¡£å‘½ä»¤åƒä¸‡ä¸è¦ç›´æ¥è¦†ç›–ç›¸åŒåç§°çš„å½’æ¡£æ–‡ä»¶ï¼Œå› ä¸ºä¸åŒé›†ç°‡å¯èƒ½äº§ç”Ÿç›¸åŒåç§°çš„ WAL æ®µæ–‡ä»¶ï¼Œå½’æ¡£å‘½ä»¤åº”è¯¥åœ¨å½’æ¡£ä½ç½®å·²å­˜åœ¨å½’æ¡£æ–‡ä»¶æ—¶ä»¥éé›¶çŠ¶æ€ç è¿”å›ã€‚&lt;/li>
&lt;li>å½’æ¡£å‘½ä»¤åº”å½“ä¿ç•™ WAL æ®µæ–‡ä»¶çš„åŸå§‹æ–‡ä»¶åã€‚&lt;/li>
&lt;li>è®¾è®¡å½’æ¡£å‘½ä»¤æ—¶åº”è€ƒè™‘å¦‚ä½•è§£å†³æˆ–å¤„ç†æ½œåœ¨çš„å¼‚å¸¸æƒ…å†µï¼Œå¦åˆ™ä¼šå¯¼è‡´ &lt;code>pg_wal&lt;/code> ç›®å½•ä¸æ–­å¢é•¿ä»è€Œå¯¼è‡´ pg å› ç©ºé—´ä¸è¶³å…³é—­ã€‚&lt;/li>
&lt;li>æœ‰å¿…è¦å¼€å¯ &lt;code>logging_collector&lt;/code> å‚æ•°ï¼Œä¹‹åå½’æ¡£å‘½ä»¤çš„æ ‡å‡†é”™è¯¯è¾“å‡ºä¼šè¢«æ”¶é›†åˆ°æ•°æ®åº“æ—¥å¿—ä¸­ï¼Œæ–¹ä¾¿å¯¹å½’æ¡£è¿‡ç¨‹è°ƒè¯•ç›‘æ§ã€‚&lt;/li>
&lt;li>å½’æ¡£å‘½ä»¤åªä¼šè°ƒç”¨äºå·²å†™å®Œæ¯•çš„ WAL æ®µæ–‡ä»¶ï¼Œå¯¹äºå·¥ä½œè´Ÿè½½å¾ˆå°çš„æ•°æ®åº“ä¸€ä¸ª WAL æ®µæ–‡ä»¶å¯èƒ½å¾ˆé•¿æ—¶é—´éƒ½ä¸ä¼šåˆ‡æ¢ï¼Œè®¾ç½®è¾ƒå°çš„ &lt;code>archive_timeout&lt;/code> å¯ä»¥ç¼©çŸ­äº‹åŠ¡æ‰§è¡Œå®Œæ¯•åˆ°è¢«å¯é åœ°å½’æ¡£ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œä¹Ÿå¯é€šè¿‡æ‰§è¡Œ &lt;code>SELECT pg_switch_wal();&lt;/code> æ‰‹åŠ¨åˆ‡æ¢ WAL æ®µæ–‡ä»¶ï¼Œè¿™ä¹Ÿä¼šè§¦å‘å¯¹åˆ‡æ¢å‰ä½¿ç”¨çš„ WAL æ®µæ–‡ä»¶è¿›è¡Œå½’æ¡£ï¼Œè¯¥å‘½ä»¤åªèƒ½åœ¨ä¸»åº“æ‰§è¡Œã€‚&lt;/li>
&lt;li>å¦‚æœå‘½ä»¤è¢« SIGTERM ä»¥å¤–çš„ä¿¡å·æˆ–è€… shell çš„é”™è¯¯ï¼ˆå¦‚æœªæ‰¾åˆ°å‘½ä»¤ï¼‰ç»ˆæ­¢ï¼Œå½’æ¡£å°†è¢«ä¸­æ­¢ä¸”æœåŠ¡å™¨å°†ä¼šå…³é—­ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="åŸºç¡€å¤‡ä»½">åŸºç¡€å¤‡ä»½&lt;/h3>
&lt;p>åŸºç¡€å¤‡ä»½æ˜¯ç”±å¤šä¸ªé¡ºåºå‘½ä»¤ç»„æˆçš„é˜¶æ®µæ€§æ“ä½œï¼š&lt;/p>
&lt;ol>
&lt;li>æ‰§è¡Œ &lt;code>pg_start_backup&lt;/code> å¼€å§‹å¤‡ä»½ï¼Œæ•°æ®åº“ä¼šæ‰§è¡Œä¸€æ¬¡æ£€æŸ¥ç‚¹ï¼Œåœ¨å¤‡ä»½å¼€å§‹æ—¶åˆ»æ˜¾å¼åˆ›å»ºä¸€ä¸ªé‡åšç‚¹ï¼Œå°½é‡å°†æ­¤æ—¶é—´ç‚¹ä¹‹å‰çš„äº‹åŠ¡å†™å…¥ç£ç›˜ï¼ŒåŒæ—¶è®°å½•ä¸‹è¯¥æ£€æŸ¥ç‚¹çš„ LSN ä½ç½®ã€‚
ä¸ºäº†ä¸å½±å“åœ¨çº¿è¿è¡Œï¼Œè¯¥å‘½ä»¤é»˜è®¤é€šè¿‡åˆ†æ•£ IO çš„æ–¹å¼æ‰§è¡Œæ£€æŸ¥ç‚¹ï¼Œå› æ­¤å¯èƒ½æŒç»­è¾ƒé•¿æ—¶é—´æ‰è¿”å›ã€‚
&lt;code>pg_start_backup&lt;/code> è¿˜ä¼šå¼ºåˆ¶å¼€å¯æ•´é¡µå†™å…¥æ¨¡å¼ï¼Œä¿è¯åœ¨åŸºç¡€å¤‡ä»½æœŸé—´å¯¹æ•°æ®åº“çš„å†™å…¥å¯ä»¥å®Œå…¨å›æ”¾ã€‚&lt;/li>
&lt;li>&lt;code>pg_start_backup&lt;/code> æ‰§è¡ŒæˆåŠŸåï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¯¹æ•°æ®ç›®å½•è¿›è¡Œå½’æ¡£ï¼Œè·å¾—ä¸€ä»½æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ï¼Œæ³¨æ„ä¸åŒæ–‡ä»¶å¯èƒ½åœ¨ä¸åŒçš„æ—¶é—´ç‚¹è¢«å¤åˆ¶ï¼Œå› æ­¤æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½ä¸­æ•°æ®åº“çš„çŠ¶æ€å¯èƒ½ä¸ä¸€è‡´ã€‚pg é¢„æœŸè¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå¹¶é€šè¿‡é‡æ”¾åœ¨æ•´ä¸ªåŸºç¡€å¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µæ–‡ä»¶ä½¿å…¶åˆ°è¾¾ä¸€è‡´çŠ¶æ€ã€‚&lt;/li>
&lt;li>æ‰§è¡Œ &lt;code>pg_stop_backup&lt;/code>ï¼Œæ•°æ®åº“ä¼šå¼ºåˆ¶åˆ‡æ¢æ­£åœ¨ä½¿ç”¨çš„ WAL æ®µæ–‡ä»¶ï¼Œå¹¶è®°å½•åˆ‡æ¢å‰çš„æœ€åä¸€æ¡ LSNï¼Œç»“æŸ LSN å³ä¸ºæœ¬æ¬¡åŸºç¡€å¤‡ä»½å®é™…æ‰€å¤‡ä»½çš„ä¸€è‡´çŠ¶æ€ã€‚åŸºç¡€å¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µæ–‡ä»¶å°†è¢«å½’æ¡£ï¼Œç»“æŸæ“ä½œè¿˜ä¼šå‘é€ä¸€ä»½è®°å½•äº†è¿™äº› WAL æ®µæ–‡ä»¶åç§°çš„&lt;strong>å¤‡ä»½å†å²æ–‡ä»¶&lt;/strong>åˆ°å½’æ¡£ä½ç½®ï¼Œè¯¥æ–‡ä»¶çš„æ–‡ä»¶åè®°å½•äº†ä½¿ç”¨è¯¥åŸºç¡€å¤‡ä»½æ¢å¤æ—¶æ‰€éœ€è¦çš„ç¬¬ä¸€ä¸ª WAL æ®µæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹è®°å½•äº†æœ¬æ¬¡å¤‡ä»½çš„èµ·æ­¢æ—¶é—´æˆ³å’Œæ‰€éœ€è¦çš„èµ·æ­¢ WAL æ®µæ–‡ä»¶ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½çš„åŸºç¡€ä¸Šåº”ç”¨è¿™äº›å·²å½’æ¡£çš„ WAL æ®µæ–‡ä»¶ï¼Œå³å¯æ¢å¤åˆ°ç»“æŸ LSN æ‰€ä»£è¡¨çš„ä¸€è‡´çŠ¶æ€ã€‚&lt;/li>
&lt;li>ç»“æŸå¤‡ä»½åéœ€è¦åœ¨æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½çš„æ ¹ç›®å½•ä¸­&lt;strong>æ‰‹åŠ¨åˆ›å»º&lt;/strong> &lt;code>backup_label&lt;/code> æ–‡ä»¶ï¼Œå†…å®¹ä¸º &lt;code>pg_stop_backup&lt;/code> æ“ä½œæ‰€è¿”å›çš„è¾“å‡ºï¼ŒåŒæ—¶æœ€å¥½å•ç‹¬ä¿å­˜å¤‡ä»½å†å²æ–‡ä»¶ä¸­æ‰€è®°å½•çš„ WAL æ®µæ–‡ä»¶ï¼Œæ–‡ä»¶ç³»ç»Ÿå¤‡ä»½åŠ ä¸Šå¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µæ–‡ä»¶æ‰æ˜¯ä¸€ä»½æœ‰æ•ˆçš„åŸºç¡€å¤‡ä»½ï¼Œèƒ½å¤ŸæˆåŠŸæ¢å¤åˆ°æ•°æ®åº“åœ¨ç»“æŸå¤‡ä»½æ—¶æ‰€å¤„çš„ä¸€è‡´çŠ¶æ€ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;code>pg_start_backup&lt;/code> å’Œ &lt;code>pg_stop_backup&lt;/code> å‘½ä»¤çš„å…·ä½“ç»†èŠ‚å¯å‚è€ƒï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://www.2ndquadrant.com/en/blog/what-does-pg_start_backup-do/">what-does-pg_start_backup-do/&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-BACKUP">FUNCTIONS-ADMIN-BACKUP&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>åœ¨å®‰å…¨åœ°å½’æ¡£æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½å’Œå¤‡ä»½æœŸé—´ä½¿ç”¨çš„ WAL æ®µæ–‡ä»¶åï¼ˆåœ¨å¤‡ä»½å†å²æ–‡ä»¶ä¸­æŒ‡å®šï¼‰ï¼Œæ–‡ä»¶åç§°ä¸­æ•°å­—åºåˆ—å°äºå¤‡ä»½å†å²æ–‡ä»¶åç§°çš„ WAL æ®µæ–‡ä»¶å¯ä»¥è¢«åˆ é™¤ã€‚&lt;/p>
&lt;p>æ¢å¤éœ€è¦ä¸€ä¸ªåŸºç¡€å¤‡ä»½åŠ ä¸Šè¯¥åŸºç¡€å¤‡ä»½ä¹‹åäº§ç”Ÿçš„æŒç»­ WAL å½’æ¡£æ–‡ä»¶ï¼Œè€Œé‡æ”¾å¤§é‡ WAL å½’æ¡£æ–‡ä»¶è¾ƒä¸ºè€—æ—¶ï¼Œæ¨èçš„åšæ³•æ˜¯å®šæœŸåšä¸€æ¬¡åŸºç¡€å¤‡ä»½ï¼ŒåŒæ—¶æ¸…ç†åŸºç¡€å¤‡ä»½ä¹‹å‰çš„è¾ƒæ—©çš„ WAL å½’æ¡£æ–‡ä»¶ï¼ˆæ¸…ç†åæ— æ³•å†æ¢å¤åˆ°è¯¥æ—¶é—´ç‚¹ï¼‰ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨åº•å±‚-api-åˆ¶ä½œåŸºç¡€å¤‡ä»½">ä½¿ç”¨åº•å±‚ API åˆ¶ä½œåŸºç¡€å¤‡ä»½&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>ç¡®ä¿å½’æ¡£åŠŸèƒ½å·²å¼€å¯å¹¶å·¥ä½œæ­£å¸¸ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨è¶…çº§ç”¨æˆ·è¿æ¥åˆ°æ•°æ®åº“å¹¶æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆå¤‡ä»½æœŸé—´éœ€è¦ä¿æŒè¯¥è¿æ¥ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_start_backup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;label&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">false&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„æè¿°æ€§çš„æ ‡ç­¾ã€‚&lt;/li>
&lt;li>ç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦å¼€å¯å¿«é€Ÿæ£€æŸ¥ç‚¹ï¼Œå¼€å¯åä¼šæ‰§è¡Œå¿«é€Ÿæ£€æŸ¥ç‚¹ç«‹åˆ»å‘èµ·å¤§é‡ IOï¼Œå¯èƒ½ä¼šå½±å“å¤‡ä»½æœŸé—´çš„æ•°æ®åº“æ€§èƒ½ã€‚å…³é—­åä¼šåˆ†æ•£ IO é™ä½å¯¹æ•°æ®åº“å½±å“ï¼Œä½†éœ€è¦æ‰§è¡Œè¾ƒé•¿æ—¶é—´ã€‚&lt;/li>
&lt;li>ç¬¬ä¸‰ä¸ªå‚æ•°ä»£è¡¨æ˜¯å¦å¼€å¯ç‹¬å å¤‡ä»½ï¼Œæ–°ç‰ˆæœ¬å·²ä¸å»ºè®®å¼€å¯ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨ä»»æ„çš„æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½å·¥å…·å°†æ•°æ®ç›®å½•è¿›è¡Œå½’æ¡£ã€‚
å¦‚æœå¤‡ä»½å·¥å…·å› ä¸ºå¤åˆ¶æœŸé—´æ–‡ä»¶è¢«æ›´æ”¹è€Œä»¥éé›¶çŠ¶æ€ç è¿”å›ï¼Œè¯¥é”™è¯¯å¯ä»¥è¢«å¿½ç•¥ã€‚
æ•°æ®ç›®å½•ä¸‹çš„éƒ¨åˆ†ä¸´æ—¶å­ç›®å½•ã€æ–‡ä»¶æˆ–å­ç›®å½•ä¸­çš„æ–‡ä»¶ï¼ˆå¦‚ &lt;code>pg_wal&lt;/code>ï¼‰å¯ä»¥åœ¨å½’æ¡£æ—¶å¿½ç•¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨åŒä¸€è¿æ¥ä¸­ç»§ç»­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sql" data-lang="sql">&lt;span class="line">&lt;span class="cl">&lt;span class="k">SELECT&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="n">pg_stop_backup&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">false&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="k">true&lt;/span>&lt;span class="p">);&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‘½ä»¤å°†ç»ˆæ­¢å¤‡ä»½æ¨¡å¼ï¼Œå¹¶è‡ªåŠ¨åˆ‡æ¢ WAL æ®µæ–‡ä»¶ä½¿å¾—å¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µæ–‡ä»¶èƒ½å¤Ÿè¢«å½’æ¡£ï¼Œé»˜è®¤æƒ…å†µä¸‹è¿™äº› WAL ç«¯æ–‡ä»¶å½’æ¡£æˆåŠŸåè¯¥å‘½ä»¤æ‰ä¼šè¿”å›ï¼Œè¿”å›çš„ç¬¬äºŒä¸ªå­—æ®µè¾“å‡ºéœ€è¦å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½æ ¹ç›®å½•ä¸‹çš„ &lt;code>backup_label&lt;/code> æ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶åœ¨éç‹¬å å¤‡ä»½æ¨¡å¼éœ€è¦æ‰‹åŠ¨åˆ›å»ºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç»“æŸå‘½ä»¤æˆåŠŸè¿”å›åï¼Œè¯´æ˜å¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µæ–‡ä»¶å·²ç»è¢«å½’æ¡£ï¼Œæ­¤æ—¶å¤‡ä»½ç»“æŸã€‚å¯ä»¥å°†æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½å’Œè¿™äº› WAL æ®µæ–‡ä»¶ä¿å­˜åœ¨ä¸€èµ·ï¼Œå®ƒä»¬ç»„æˆäº†ä¸€ä»½å®Œæ•´çš„åŸºç¡€å¤‡ä»½ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="ä½¿ç”¨-pg_basebackup-åˆ¶ä½œåŸºç¡€å¤‡ä»½">ä½¿ç”¨ pg_basebackup åˆ¶ä½œåŸºç¡€å¤‡ä»½&lt;/h4>
&lt;p>&lt;code>pg_basebackup&lt;/code> å°è£…äº†åº•å±‚çš„ &lt;code>pg_start_backup&lt;/code> å’Œ &lt;code>pg_stop_backup&lt;/code> ç­‰å‘½ä»¤ï¼Œå¹¶æä¾›äº†ä¸€äº›éå¸¸æ–¹ä¾¿çš„ç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>æ”¯æŒå¯¹æ•°æ®ç›®å½•çš„æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½è¿›è¡Œå­˜æ¡£å‹ç¼©ï¼Œè‡ªåŠ¨å¿½ç•¥ä¸éœ€è¦çš„æ–‡ä»¶ï¼Œè‡ªåŠ¨å†™å…¥ &lt;code>backup_label&lt;/code> æ–‡ä»¶ã€‚&lt;/li>
&lt;li>è‡ªåŠ¨è®°å½•å¤‡ä»½æ–‡ä»¶çš„æ ¡éªŒå’Œï¼Œé˜²æ­¢å¤‡ä»½è¢«æ›´æ”¹ã€‚&lt;/li>
&lt;li>æ”¯æŒè‡ªåŠ¨è·å–å¤‡ä»½æœŸé—´ç”Ÿæˆçš„æ‰€æœ‰ WAL æ®µå½’æ¡£æ–‡ä»¶ï¼Œå¹¶å­˜æ”¾åˆ° &lt;code>pg_wal&lt;/code> æˆ–å…¶ä»–ç›®å½•ä¸­ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä½¿ç”¨ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pg_basebackup -D /backup/demo -Ft -z -Xs -c fast -P -v
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: initiating base backup, waiting &lt;span class="k">for&lt;/span> checkpoint to &lt;span class="nb">complete&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: checkpoint completed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: write-ahead log start point: 0/75ED8820 on timeline &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: starting background WAL receiver
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: created temporary replication slot &lt;span class="s2">&amp;#34;pg_basebackup_15233&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">244438/244438 kB &lt;span class="o">(&lt;/span>100%&lt;span class="o">)&lt;/span>, 1/1 tablespace
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: write-ahead log end point: 0/859200C8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: waiting &lt;span class="k">for&lt;/span> background process to finish streaming ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: syncing data to disk ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: renaming backup_manifest.tmp to backup_manifest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pg_basebackup: base backup completed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls /backup/demo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">backup_manifest base.tar.gz pg_wal.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ†åˆ«å°† &lt;code>base.tar.gz&lt;/code> å’Œ &lt;code>pg_wal.tar.gz&lt;/code> è§£å‹ï¼Œå¾—åˆ°æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½å’Œå¤‡ä»½æœŸé—´å†™å…¥çš„ WAL æ®µå½’æ¡£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat /backup/demo/backup_label
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START WAL LOCATION: 0/75ED8820 &lt;span class="o">(&lt;/span>file 000000010000000000000075&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CHECKPOINT LOCATION: 0/763C57B0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BACKUP METHOD: streamed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BACKUP FROM: primary
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START TIME: 2022-07-09 15:13:35 UTC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LABEL: pg_basebackup base backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START TIMELINE: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls -l /backup/demo/pg_wal
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">total &lt;span class="m">278532&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000075&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000076&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000077&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000078&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000079&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 00000001000000000000007F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000080&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000081&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000082&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000083&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000084&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> postgres postgres &lt;span class="m">16777216&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:13 &lt;span class="m">000000010000000000000085&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> postgres postgres &lt;span class="m">4096&lt;/span> Jul &lt;span class="m">9&lt;/span> 15:20 archive_status
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ•°æ®ç›®å½•ä¸­çš„ &lt;code>backup_label&lt;/code> æ–‡ä»¶å¹¶æ²¡æœ‰è®°å½•åŸºç¡€å¤‡ä»½ç»“æŸçš„ LSN ä½ç½®ï¼Œä½†å¯ä»¥åœ¨ WAL å½’æ¡£ç›®å½•ä¸‹å¯¹åº”çš„å¤‡ä»½å†å²æ–‡ä»¶ä¸­æŸ¥çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat 000000010000000000000075.00ED8820.backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START WAL LOCATION: 0/75ED8820 &lt;span class="o">(&lt;/span>file 000000010000000000000075&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STOP WAL LOCATION: 0/859200C8 &lt;span class="o">(&lt;/span>file 000000010000000000000085&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">CHECKPOINT LOCATION: 0/763C57B0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BACKUP METHOD: streamed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">BACKUP FROM: primary
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START TIME: 2022-07-09 15:13:35 UTC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LABEL: pg_basebackup base backup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">START TIMELINE: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STOP TIME: 2022-07-09 15:13:42 UTC
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">STOP TIMELINE: &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä½¿ç”¨è¯¥åŸºç¡€å¤‡ä»½æ¢å¤æ—¶ï¼Œæ¢å¤è¿›ç¨‹åœ¨é‡æ”¾äº† &lt;code>000000010000000000000085&lt;/code> WAL æ®µæ–‡ä»¶åï¼Œæ•°æ®åº“æ‰ä¼šè¿›å…¥ä¸€è‡´çŠ¶æ€ï¼Œä¹‹åæ•°æ®åº“æ‰èƒ½å¤Ÿæ¥å—è¿æ¥æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œå¦‚ä¸‹æ–¹çš„æ¢å¤æ—¥å¿—æ‰€ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:28.780 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;000000010000000000000084&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:29.024 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;000000010000000000000085&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:29.147 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: consistent recovery state reached at 0/859200C8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:29.148 UTC &lt;span class="o">[&lt;/span>21179&lt;span class="o">]&lt;/span> LOG: database system is ready to accept read-only connections
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:29.232 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;000000040000000000000086&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:29.480 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;000000040000000000000087&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä»å½’æ¡£å¤‡ä»½ä¸­æ¢å¤">ä»å½’æ¡£å¤‡ä»½ä¸­æ¢å¤&lt;/h2>
&lt;p>æ¢å¤çš„æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>åœæ­¢ pg æœåŠ¡å™¨è¿›ç¨‹ã€‚&lt;/li>
&lt;li>å¤‡ä»½å½“å‰æ•°æ®ç›®å½•ï¼Œå¦‚æœç©ºé—´ä¸å¤Ÿï¼Œè‡³å°‘è¦å¤‡ä»½ &lt;code>pg_wal&lt;/code> ç›®å½•ä¸‹è¿˜æœªå½’æ¡£çš„ WAL æ®µæ–‡ä»¶ã€‚&lt;/li>
&lt;li>ç§»é™¤æ•°æ®ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œå­ç›®å½•ã€‚&lt;/li>
&lt;li>å°†&lt;strong>æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½&lt;/strong>æ¢å¤åˆ°æ•°æ®ç›®å½•ï¼Œç¡®ä¿æ¢å¤åçš„æ–‡ä»¶å’Œç›®å½•æœ‰æ­£ç¡®çš„æƒé™ã€‚&lt;/li>
&lt;li>å¦‚æœåšæ–‡ä»¶ç³»ç»Ÿå¤‡ä»½æ—¶æ²¡æœ‰å¿½ç•¥ &lt;code>pg_wal&lt;/code> ç›®å½•ï¼Œç°åœ¨éœ€è¦æ¸…ç©ºæ¢å¤åçš„ &lt;code>pg_wal&lt;/code> ç›®å½•ï¼Œå°†æœªå½’æ¡£çš„ WAL æ®µæ–‡ä»¶å¤åˆ¶åˆ°è¯¥ç›®å½•ã€‚&lt;/li>
&lt;li>åœ¨æ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª &lt;code>recovery.signal&lt;/code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æŒ‡ç¤º pg åœ¨å¯åŠ¨æ—¶è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œå¹¶å°†åœ¨æ¢å¤æˆåŠŸåè‡ªåŠ¨åˆ é™¤ã€‚&lt;/li>
&lt;li>åœ¨é…ç½®æ–‡ä»¶ &lt;code>postgresql.conf&lt;/code> ä¸­è®¾ç½®å’Œæ¢å¤ç›¸å…³çš„å‚æ•°ï¼Œå¦‚ &lt;code>restore_command&lt;/code>ï¼Œä¸‹æ–‡ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚&lt;/li>
&lt;li>å¯åŠ¨ pg æœåŠ¡å™¨ã€‚æœåŠ¡å™¨å°†è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œå¹¶å¼€å§‹è·å–å’Œå¤„ç†æ¢å¤æ‰€éœ€çš„ WAL æ®µæ–‡ä»¶ã€‚å¦‚æœæ¢å¤è¿‡ç¨‹å› å¤–éƒ¨é”™è¯¯ï¼ˆå¦‚ä¸»æœºæ–­ç”µï¼‰è¢«ç»ˆæ­¢ï¼Œå¯ä»¥ç®€å•åœ°é‡å¯æœåŠ¡å™¨è®©å®ƒç»§ç»­æ¢å¤ã€‚æ¢å¤å®Œæˆåï¼ŒæœåŠ¡å™¨å°†åˆ é™¤ &lt;code>recovery.signal&lt;/code> æ–‡ä»¶ä»¥é˜²æ­¢é‡æ–°è¿›å…¥æ¢å¤æ¨¡å¼ï¼Œç„¶åå¼€å§‹æ­£å¸¸è¿è¡Œã€‚&lt;/li>
&lt;/ol>
&lt;p>æ¢å¤çš„æ“ä½œæµç¨‹å¹¶ä¸å¤æ‚ï¼Œå…¶å…³é”®ç‚¹åœ¨äºé€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¢å¤æ—¶è·å–å·²å½’æ¡£ WAL æ®µæ–‡ä»¶çš„æ–¹å¼ã€‚&lt;/li>
&lt;li>æ¢å¤éœ€è¦åˆ°è¾¾çš„ç›®æ ‡çŠ¶æ€ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æ¢å¤å‘½ä»¤">æ¢å¤å‘½ä»¤&lt;/h3>
&lt;p>æ¢å¤æ—¶å¿…é¡»è®¾ç½® &lt;code>restore_command&lt;/code> (ä¸‹æ–‡ç§°ä¹‹ä¸ºæ¢å¤å‘½ä»¤)æ¥å‘Šè¯‰ pg å¦‚ä½•è·å–å·²å½’æ¡£çš„ WAL æ®µæ–‡ä»¶ï¼Œä¸å­˜æ¡£å‘½ä»¤ç±»ä¼¼ï¼Œè¯¥å‘½ä»¤å®šä¹‰å¦‚ä½•å°† pg éœ€è¦çš„ç‰¹å®š WAL æ®µæ–‡ä»¶ï¼ˆä¹ŸåŒ…å«å…¶ä»–ç±»å‹æ–‡ä»¶ï¼‰é€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰çš„æ–¹å¼ä»å½’æ¡£ä½ç½®ä¼ è¾“åˆ°æ•°æ®ç›®å½•ä¸‹çš„ä¸´æ—¶ä½ç½®ï¼Œç„¶å pg ä¼šè¯»å–è¯¥ä¸´æ—¶æ–‡ä»¶æ‰§è¡Œé‡åšã€‚åœ¨è¯¥å‘½ä»¤ä¸­å¯ä»¥é€šè¿‡æ‰§è¡Œè„šæœ¬çš„æ–¹å¼ï¼Œè‡ªå®šä¹‰æ›´åŠ å¤æ‚çš„è¡Œä¸ºã€‚&lt;/p>
&lt;p>å¦‚æœå·²å½’æ¡£çš„ WAL æ®µæ–‡ä»¶å­˜æ”¾äº &lt;code>/backup/demo/pg_wal&lt;/code> ç›®å½•ï¼Œåˆ™ç¤ºä¾‹çš„æ¢å¤å‘½ä»¤ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">restore_command&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s1">&amp;#39;cp /backup/demo/pg_wal/%f %p&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è®¾è®¡æ¢å¤å‘½ä»¤æ—¶æœ‰ä»¥ä¸‹æ³¨æ„ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ¢å¤å‘½ä»¤ä¸€å®šè¦åœ¨ä¼ è¾“å¤±è´¥æˆ–ä¼ è¾“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä»¥éé›¶çŠ¶æ€ç è¿”å›ã€‚pg ä¼šå°è¯•é€šè¿‡æ¢å¤å‘½ä»¤è·å–ä¸€äº›å¹¶ä¸åœ¨å½’æ¡£ä½ç½®ä¸­çš„æ–‡ä»¶ï¼Œå› æ­¤æ¢å¤ä¸ä¼šå› ä¸ºæ¢å¤å‘½ä»¤å¤±è´¥è€Œç›´æ¥ä¸­æ­¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:24.762 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;00000003.history&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:24.766 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;00000004.history&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp: cannot stat &lt;span class="s1">&amp;#39;/var/lib/postgresql/archive/14/demo/00000005.history&amp;#39;&lt;/span>: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:24.771 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: starting point-in-time recovery to 2022-07-10 08:03:23.157122+00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:24.776 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;00000004.history&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:24.862 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;000000010000000000000076&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¦‚æœ pg æ— æ³•é€šè¿‡æ¢å¤å‘½ä»¤è·å–æŸä¸ªæ–‡ä»¶ï¼Œä¹‹åä¼šå°è¯•ä»æ•°æ®ç›®å½•ä¸‹çš„ &lt;code>pg_wal&lt;/code> ç›®å½•ä¸­å¯»æ‰¾ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¦‚æœå‘½ä»¤è¢« SIGTERM ä»¥å¤–çš„ä¿¡å·æˆ–è€… shell çš„é”™è¯¯ï¼ˆå¦‚æœªæ‰¾åˆ°å‘½ä»¤ï¼‰ç»ˆæ­¢ï¼Œæ¢å¤å°†è¢«ä¸­æ­¢ä¸”æœåŠ¡å™¨å°†ä¼šå…³é—­ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ¢å¤æ¨¡å¼">æ¢å¤æ¨¡å¼&lt;/h3>
&lt;p>æ¢å¤å®é™…ä¸Šæœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨æ•°æ®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>standby.signal&lt;/code> çš„æ–‡ä»¶ï¼ŒæœåŠ¡å™¨å¯åŠ¨åå°†è¿›å…¥ standby æ¨¡å¼ã€‚æœåŠ¡å™¨è¿›å…¥æ¢å¤çŠ¶æ€ï¼Œå¹¶ä¸”åœ¨è¾¾åˆ°å½’æ¡£çš„ WAL çš„æœ«ç«¯æ—¶ä¸ä¼šåœæ­¢æ¢å¤ï¼Œè€Œæ˜¯é€šè¿‡è¿æ¥åˆ°ç”±&lt;code>primary_conninfo&lt;/code> è®¾ç½®æŒ‡å®šçš„ä¸»æœåŠ¡å™¨æˆ–é€šè¿‡ä½¿ç”¨ &lt;code>restore_command&lt;/code> è·å–æ–°çš„ WAL æ®µï¼Œç»§ç»­å°è¯•æ¢å¤ã€‚&lt;/li>
&lt;li>åœ¨æ•°æ®ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå«åš &lt;code>recovery.signal&lt;/code> çš„æ–‡ä»¶ï¼ŒæœåŠ¡å™¨å¯åŠ¨åå°†è¿›å…¥ç›®æ ‡æ¢å¤æ¨¡å¼ã€‚ç›®æ ‡æ¢å¤æ¨¡å¼åœ¨å½’æ¡£çš„ WAL æ®µæ–‡ä»¶è¢«å®Œå…¨é‡æ”¾æˆ–è¾¾åˆ° &lt;code>recovery_target&lt;/code> æ—¶ç»“æŸã€‚&lt;/li>
&lt;/ul>
&lt;p>é€šå¸¸æƒ…å†µä¸‹ï¼Œstandby æ¨¡å¼è¢«ç”¨æ¥æä¾›é«˜å¯ç”¨å’Œæ‰©å±•åªè¯»åº“ï¼Œè€Œç›®æ ‡æ¢å¤åˆ™è¢«ç”¨æ¥æ¢å¤ä¸¢å¤±çš„æ•°æ®æˆ–å…‹éš†æ–°çš„æœåŠ¡å™¨ã€‚å¦‚æœåŒæ—¶åˆ›å»ºäº†&lt;code>standby.signal&lt;/code> å’Œ &lt;code>recovery.signal&lt;/code> æ–‡ä»¶ï¼Œåˆ™ä»¥ standby æ¨¡å¼ä¸ºä¼˜å…ˆã€‚&lt;/p>
&lt;h3 id="æ¢å¤ç›®æ ‡">æ¢å¤ç›®æ ‡&lt;/h3>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¢å¤æ¨¡å¼ä¼šå¤„ç†å®Œæ‰€æœ‰å¯ç”¨çš„ WAL æ®µæ–‡ä»¶ï¼Œå³é€šè¿‡é€’å¢ WAL æ®µå‘½åä¸­çš„åºåˆ—å·ä¸æ–­è·å–ä¸‹ä¸€ä¸ª WAL æ®µæ–‡ä»¶ï¼Œç›´åˆ°è·å–å¤±è´¥ä¸ºæ­¢ï¼Œæœ€åä¼šå°†æ•°æ®åº“æ¢å¤åˆ°ã€Œç›¸å¯¹æœ€æ–°ã€çš„çŠ¶æ€ã€‚å› æ­¤åœ¨æ¢å¤è¿‡ç¨‹ä¸­å‡ºç°çš„ç±»ä¼¼ã€Œæ–‡ä»¶æœªæ‰¾åˆ°ã€çš„é”™è¯¯é€šå¸¸æ˜¯æ­£å¸¸çš„ï¼Œå°¤å…¶æ˜¯åœ¨æ¢å¤ç»“æŸæ—¶ã€‚&lt;/p>
&lt;p>å¦‚æœä½ åªéœ€è¦æ¢å¤åˆ°åŸºç¡€å¤‡ä»½ç»“æŸåˆ°å½“å‰æ—¶åˆ»ä¹‹é—´çš„æŸä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œåˆ™éœ€è¦æŒ‡å®š&lt;strong>åœæ­¢ç‚¹&lt;/strong>ï¼Œå³æ¢å¤ç›®æ ‡ã€‚æ¢å¤ç›®æ ‡å¯ä»¥æ˜¯æ—¶é—´æˆ³ã€å‘½åçš„æ¢å¤ç‚¹å’Œäº‹åŠ¡ IDï¼Œåœ¨å®è·µä¸­ä½¿ç”¨åŸºäºæ—¶é—´ç‚¹æ¢å¤å±…å¤šã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥ä¸”ä»…å¯ä»ä»¥ä¸‹å‚æ•°ä¸­é€‰æ‹©ä¸€ä¸ªæ¥æŒ‡å®šæ¢å¤ç›®æ ‡ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>recovery_target&lt;/code>ï¼šå”¯ä¸€å¯ç”¨çš„å€¼æ˜¯ &lt;code>immediate&lt;/code>ï¼Œåˆ°è¾¾åŸºç¡€å¤‡ä»½ç»“æŸæ—¶çš„ä¸€è‡´çŠ¶æ€å³åœæ­¢æ¢å¤ã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_lsn&lt;/code>ï¼šè®¾ç½®æ¢å¤ç›®æ ‡ä¸ºæŒ‡å®šçš„ LSNã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_name&lt;/code>ï¼šè®¾ç½®æ¢å¤ç›®æ ‡ä¸ºæŒ‡å®šçš„å‘½åæ¢å¤ç‚¹ï¼ˆé€šè¿‡&lt;code>pg_create_restore_point()&lt;/code> åˆ›å»ºå‘½åæ¢å¤ç‚¹ï¼‰ã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_time&lt;/code>ï¼šè®¾ç½®æ¢å¤ç›®æ ‡ä¸ºæŒ‡å®šçš„æ—¶é—´æˆ³ã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_xid&lt;/code>ï¼šè®¾ç½®æ¢å¤ç›®æ ‡ä¸ºæŒ‡å®šçš„äº‹åŠ¡ IDã€‚&lt;/li>
&lt;/ul>
&lt;p>é€šè¿‡ä»¥ä¸‹é€‰é¡¹è¿›ä¸€æ­¥è®¾å®šæ˜¯å¦åŒ…æ‹¬æ¢å¤ç›®æ ‡ä»¥åŠåˆ°è¾¾åçš„è¡Œä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>recovery_target_inclusive&lt;/code>ï¼šæŒ‡å®šæ¢å¤æ—¶æ˜¯å¦åŒ…å«æ¢å¤ç›®æ ‡ï¼Œå³æ˜¯å¦é‡æ”¾åŒ…å«äº†ç›®æ ‡æ—¶é—´æˆ³ã€LSN æˆ–äº‹åŠ¡ ID çš„ WAL æ—¥å¿—æ¡ç›®ï¼Œå¦åˆ™å°†åœ¨è¯¥æ¢å¤ç›®æ ‡å‰åœæ­¢ã€‚é»˜è®¤å€¼ä¸º &lt;code>true&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_timeline&lt;/code>ï¼šæŒ‡å®šæ¢å¤æ—¶æ‰€åˆ°è¾¾çš„æ—¶é—´çº¿ï¼Œé€šå¸¸ä½¿ç”¨é»˜è®¤å€¼ &lt;code>latest&lt;/code>ï¼Œå³å½’æ¡£æ—¥å¿—ä¸­æœ€åç”Ÿæˆçš„æ—¶é—´çº¿ã€‚&lt;/li>
&lt;li>&lt;code>recovery_target_action&lt;/code>ï¼šæŒ‡å®šåˆ°è¾¾æ¢å¤ç›®æ ‡åæœåŠ¡å™¨å°†æ‰§è¡Œçš„åŠ¨ä½œï¼Œä»…åœ¨è®¾å®šäº†æ¢å¤ç›®æ ‡æ—¶ç”Ÿæ•ˆã€‚å¯æ‰§è¡Œä»¥ä¸‹ä¸‰ç§åŠ¨ä½œï¼š
&lt;ul>
&lt;li>&lt;code>pause&lt;/code>ï¼šæš‚åœæ¢å¤è¿›ç¨‹ã€‚æš‚åœæ—¶ç”¨æˆ·å¯æ ¹æ®ä»æ•°æ®åº“æŸ¥è¯¢åˆ°çš„å½“å‰çŠ¶æ€æ‰§è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚å¯ä»¥é€‰æ‹© resume è¢«æš‚åœçš„æ¢å¤è¿›ç¨‹ï¼Œè¿™ä¼šå¯¼è‡´æ¢å¤æ¨¡å¼ç»“æŸï¼›ä¹Ÿå¯ä»¥é€‰æ‹©æ›´æ”¹æ¢å¤ç›®æ ‡é…ç½®åé‡å¯æ•°æ®åº“æœåŠ¡å™¨ï¼Œé‡æ–°æ¢å¤åˆ°å¦ä¸€ç›®æ ‡ã€‚å¦‚æœæœåŠ¡å™¨å›  &lt;code>hot_standby=off&lt;/code> é…ç½®è€Œæ— æ³•æ¥å—æŸ¥è¯¢ï¼Œè¯¥é€‰é¡¹ç­‰åŒäº &lt;code>shutdown&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;code>promot&lt;/code>ï¼šç»“æŸæ¢å¤è¿›ç¨‹å¹¶åˆ›å»ºä¸€æ¡æ–°çš„æ—¶é—´çº¿ï¼Œå¼€å§‹æ¥å—æ•°æ®åº“è¿æ¥ã€‚&lt;/li>
&lt;li>&lt;code>shutdown&lt;/code>ï¼šç›´æ¥å…³é—­æœåŠ¡å™¨ã€‚æ­¤æ—¶ä¸ä¼šåˆ é™¤ &lt;code>recovery.signal&lt;/code> æ–‡ä»¶ï¼Œå¦‚æœæœåŠ¡å™¨é‡æ–°å¯åŠ¨å°†ç«‹åˆ»å†æ¬¡å…³é—­ï¼›å¦‚æœæ›´æ”¹æ¢å¤ç›®æ ‡é…ç½®åé‡å¯ï¼Œå°†è¿›å…¥æ¢å¤æ¨¡å¼ä»ä¸Šä¸€ä¸ªæ¢å¤ç›®æ ‡å¼€å§‹ç»§ç»­é‡æ”¾åˆ°æ–°çš„æ¢å¤ç›®æ ‡ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ¢å¤ç»ˆæ­¢">æ¢å¤ç»ˆæ­¢&lt;/h3>
&lt;p>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œå¦‚æœæ¢å¤è¿›ç¨‹åœ¨åˆ°è¾¾å·²é…ç½®çš„æ¢å¤ç›®æ ‡ä¹‹å‰ï¼Œå› å¤„ç†å®Œäº†å¯ç”¨çš„ WAL æ®µæ–‡ä»¶è€Œç»“æŸï¼Œæ¢å¤è¿›ç¨‹å°†ä»¥ FATAL é”™è¯¯é€€å‡ºå¯¼è‡´æœåŠ¡å™¨å…³é—­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:50.673 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;0000000400000000000000D1&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:50.865 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: restored log file &lt;span class="s2">&amp;#34;0000000400000000000000D2&amp;#34;&lt;/span> from archive
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp: cannot stat &lt;span class="s1">&amp;#39;/var/lib/postgresql/archive/14/demo/0000000400000000000000D3&amp;#39;&lt;/span>: No such file or directory
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.003 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: redo &lt;span class="k">done&lt;/span> at 0/D2CA8530 system usage: CPU: user: 5.91 s, system: 9.59 s, elapsed: 25.94 s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.003 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> LOG: last completed transaction was at log &lt;span class="nb">time&lt;/span> 2022-07-10 08:02:30.614229+00
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.003 UTC &lt;span class="o">[&lt;/span>21181&lt;span class="o">]&lt;/span> FATAL: recovery ended before configured recovery target was reached
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.015 UTC &lt;span class="o">[&lt;/span>21179&lt;span class="o">]&lt;/span> LOG: startup process &lt;span class="o">(&lt;/span>PID 21181&lt;span class="o">)&lt;/span> exited with &lt;span class="nb">exit&lt;/span> code &lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.015 UTC &lt;span class="o">[&lt;/span>21179&lt;span class="o">]&lt;/span> LOG: terminating any other active server processes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.026 UTC &lt;span class="o">[&lt;/span>21179&lt;span class="o">]&lt;/span> LOG: shutting down due to startup process failure
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2022-07-10 08:05:51.047 UTC &lt;span class="o">[&lt;/span>21179&lt;span class="o">]&lt;/span> LOG: database system is shut down
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæ¢å¤è¿›ç¨‹å‘ç°äº†æŸåçš„ WAL æ•°æ®ï¼Œæ¢å¤å°†ç«‹åˆ»åœæ­¢ä¸”æœåŠ¡å™¨æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥åœ¨æŸåç‚¹ä¹‹å‰æŒ‡å®šä¸€ä¸ªæ–°çš„æ¢å¤ç›®æ ‡ï¼Œç„¶åé‡æ–°è¿è¡Œæ¢å¤è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>å¦‚æœæ¢å¤ç”±äºå¤–éƒ¨åŸå› è€Œå¤±è´¥ï¼Œæ¯”å¦‚ç³»ç»Ÿå´©æºƒæˆ– WAL å½’æ¡£æ— æ³•è®¿é—®ï¼Œå¯ä»¥ç®€å•åœ°é‡æ–°å¯åŠ¨æœåŠ¡å™¨ç»§ç»­æ¢å¤ï¼Œæ¢å¤è¿›ç¨‹ä¼šä»å¤±è´¥çš„åœ°æ–¹é‡æ–°å¼€å§‹ã€‚æ¢å¤é‡å¯çš„å·¥ä½œæ–¹å¼å¾ˆåƒæ™®é€šçš„æ£€æŸ¥ç‚¹ï¼šæœåŠ¡å™¨å®šæœŸå°†å…¶æ‰€æœ‰çŠ¶æ€åˆ·æ–°åˆ°ç£ç›˜ï¼Œç„¶åæ›´æ–° &lt;code>pg_control&lt;/code> æ–‡ä»¶è®°å½•å¤„å·²ç†å®Œæˆçš„ WAL æ•°æ®ï¼Œåœ¨é‡å¯æ—¶ä¸å†éœ€è¦é‡æ–°å¤„ç†è¿™äº›æ•°æ®ã€‚&lt;/p>
&lt;h2 id="æ—¶é—´çº¿">æ—¶é—´çº¿&lt;/h2>
&lt;p>pg ä¸­å¼•å…¥äº†æ—¶é—´çº¿çš„æ¦‚å¿µï¼Œæ¯ä¸€æ¬¡æ¢å¤æˆåŠŸåéƒ½ä¼šåŸºäºæ¢å¤çš„æ—¶é—´çº¿åˆ›å»ºä¸€æ¡æ–°çš„æ—¶é—´çº¿ï¼Œæ—¶é—´çº¿ä¸»è¦ä½“ç°åœ¨ WAL æ®µæ–‡ä»¶çš„å‘½åä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># SELECT timeline_id FROM pg_control_checkpoint();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> timeline_id
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">postgres&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="c1"># SELECT pg_walfile_name(pg_current_wal_lsn());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> pg_walfile_name
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">000000020000000000000086&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">(&lt;/span>&lt;span class="m">1&lt;/span> row&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¶é—´çº¿ pg è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ—¶é—´çº¿å†å²æ–‡ä»¶ &lt;code>&amp;lt;timeline-ID&amp;gt;.history&lt;/code>ï¼Œè®°å½•äº†è¯¥æ—¶é—´çº¿çš„çˆ¶æ—¶é—´çº¿ã€‚å½“ä»åŒ…å«å¤šä¸ªæ—¶é—´çº¿çš„å­˜æ¡£ä¸­æ¢å¤æ—¶ï¼Œpg éœ€è¦æ—¶é—´çº¿å†å²æ–‡ä»¶æ¥ä¸æ–­å¾€å‰å›æº¯ï¼Œé€‰æ‹©æ­£ç¡®çš„ WAL æ®µæ–‡ä»¶åºåˆ—ã€‚å› æ­¤æ—¶é—´çº¿å†å²æ–‡ä»¶ä¹Ÿä¼šå½’æ¡£åˆ° WAL å½’æ¡£ä½ç½®ã€‚&lt;/p>
&lt;p>å¼•å…¥æ—¶é—´çº¿çš„å¥½å¤„æ˜¯ï¼Œç”¨æˆ·å¯ä»¥åŸºäºåŒä¸€å¤‡ä»½æ¢å¤ä¹‹åå†å¤‡ä»½ï¼Œé€šè¿‡æ—¶é—´çº¿æ¨¡æ‹Ÿå‡ºä¸€æ¡æ ‘çŠ¶çš„å¤‡ä»½å†å²ï¼Œç„¶åæ–¹ä¾¿åœ°åœ¨ä¸åŒåˆ†å‰ä¹‹é—´å®šä½å’Œåˆ‡æ¢ï¼Œä¸éœ€è¦æ‹…å¿ƒå®ƒä»¬ä¹‹é—´å› å‘½åå†²çªç­‰åŸå› é€ æˆæ··ä¹±ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹æ—¶é—´çº¿éå¸¸æœ‰ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç›´æ¥ä½¿ç”¨ WAL å½’æ¡£ä¸­æœ€è¿‘çš„æ—¶é—´çº¿ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æŒç»­å½’æ¡£çš„åŸºç¡€å¤‡ä»½æ˜¯ä¸€ä¸ªæœ‰å¼€å§‹å’Œç»“æŸåŠ¨ä½œçš„é˜¶æ®µæ€§è¿‡ç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å¼€å§‹æ—¶ pg ä¼šæ‰§è¡Œæ£€æŸ¥ç‚¹å¹¶å¼ºåˆ¶å¼€å¯ &lt;code>full_page_writes&lt;/code>ï¼Œåœ¨å¼€å§‹åˆ°ç»“æŸæœŸé—´ä»»ä½•æ—¶é—´ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½éƒ½å¯ä»¥å›é€€åˆ°å¼€å§‹æ—¶é—´ç‚¹è¿›è¡Œé‡æ”¾ã€‚&lt;/li>
&lt;li>ç»“æŸæ—¶ pg ä¼šå¼ºåˆ¶åˆ‡æ¢ä¸€æ¬¡ WAL æ®µæ—¥å¿—ï¼Œæ–‡ä»¶ç³»ç»Ÿå¤‡ä»½é‡æ”¾åˆ°ç»“æŸæ—¶è¢«å½’æ¡£çš„æœ€åä¸€æ¡ WAL æ®µæ—¥å¿—å°±ä¼šä½¿æ•°æ®åº“åˆ°è¾¾ä¸€è‡´çŠ¶æ€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å› æ­¤ä¸€ä»½å®Œæ•´æœ‰æ•ˆçš„å¤‡ä»½ï¼Œå¿…é¡»åŒ…å«&lt;strong>æ–‡ä»¶ç³»ç»Ÿå¤‡ä»½&lt;/strong>å’Œ&lt;strong>ç‰¹å®šçš„ WAL æ®µæ—¥å¿—&lt;/strong>ã€‚&lt;/p>
&lt;p>ä½œä¸ºä¹…è´Ÿç››åçš„å¼€æºæ•°æ®åº“ï¼Œpg çš„æŒç»­å½’æ¡£å¯ä»¥è¯„ä»·ä¸ºã€Œå¤§é“è‡³ç®€ã€ï¼šæ•´ä¸ªè¿‡ç¨‹ç”±ç®€å•ã€åŸºç¡€çš„æ•°æ®åº“æŒ‡ä»¤å’Œ OS å·¥å…·åä½œå®Œæˆï¼Œå®Œç¾å¥‘åˆ &lt;a href="https://en.wikipedia.org/wiki/Unix_philosophy">Unix å“²å­¦&lt;/a>ï¼›å½’æ¡£å’Œæ¢å¤çš„å…³é”®è¿‡ç¨‹ï¼ˆ&lt;code>archive_command&lt;/code> å’Œ &lt;code>restore_command&lt;/code>ï¼‰å®Œå…¨äº¤ç»™ç”¨æˆ·ï¼Œå…·å¤‡äº†æé«˜çš„å¯æ‰©å±•æ€§ï¼Œä½†ä¹Ÿå¯¹ç®¡ç†å‘˜çš„æŠ€æœ¯æ°´å¹³æœ‰ä¸€å®šçš„è¦æ±‚ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.postgresql.org/docs/14/continuous-archiving.html#BACKUP-PITR-RECOVERY">PostgreSQL: Documentation: 14: 26.3.Â Continuous Archiving and Point-in-Time Recovery (PITR)&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" term="æ•°æ®åº“" label="æ•°æ®åº“"/><category scheme="https://waynerv.com/tags/postgresql/" term="Postgresql" label="Postgresql"/><category scheme="https://waynerv.com/tags/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/" term="å¤‡ä»½æ¢å¤" label="å¤‡ä»½æ¢å¤"/></entry><entry><title type="text">æµ…æ Linux å¦‚ä½•æ¥æ”¶ç½‘ç»œå¸§</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/how-linux-process-input-frames/"/><id>https://waynerv.com/posts/how-linux-process-input-frames/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-04-25T17:54:58+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æœ¬æ–‡å°†ä»åˆå­¦è€…è§’åº¦ï¼Œä»‹ç» Linux å†…æ ¸å¦‚ä½•æ¥æ”¶ç½‘ç»œå¸§ï¼šä»ç½‘å¡è®¾å¤‡å®Œæˆæ•°æ®å¸§çš„æ¥æ”¶å¼€å§‹ï¼Œåˆ°æ•°æ®å¸§è¢«ä¼ é€’åˆ°ç½‘ç»œæ ˆä¸­çš„ç¬¬ä¸‰å±‚ç»“æŸã€‚</summary><content type="html">&lt;blockquote>
&lt;p>æœ¬æ–‡é¦–å‘äºå¾®ä¿¡è®¢é˜…å·ã€Œæ²ƒè¶£æŠ€æœ¯ã€ï¼Œè½¬è½½æ—¶è¯·æ³¨æ˜æ¥æºã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æœ¬æ–‡å°†ä»åˆå­¦è€…è§’åº¦ï¼Œä»‹ç» Linux å†…æ ¸å¦‚ä½•æ¥æ”¶ç½‘ç»œå¸§ï¼šä»ç½‘å¡è®¾å¤‡å®Œæˆæ•°æ®å¸§çš„æ¥æ”¶å¼€å§‹ï¼Œåˆ°æ•°æ®å¸§è¢«ä¼ é€’åˆ°ç½‘ç»œæ ˆä¸­çš„ç¬¬ä¸‰å±‚ç»“æŸã€‚é‡ç‚¹ä»‹ç»å†…æ ¸çš„å·¥ä½œæœºåˆ¶ï¼Œä¸ä¼šæ·±å…¥è¿‡å¤šä»£ç å±‚é¢çš„ç»†èŠ‚ï¼Œç¤ºä¾‹ä»£ç æ¥è‡ª Linux 2.6ã€‚&lt;/p>
&lt;h2 id="è®¾å¤‡çš„é€šçŸ¥æ‰‹æ®µ">è®¾å¤‡çš„é€šçŸ¥æ‰‹æ®µ&lt;/h2>
&lt;p>ä»è®¡ç®—æœºç¡¬ä»¶çš„è§’åº¦ï¼Œä¸€ä¸ªæ•°æ®å¸§ä»è¿›å…¥ç½‘å¡åˆ°æœ€åè¢«å†…æ ¸ç½‘ç»œæ ˆå¤„ç†çš„æ•´ä½“ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2022-04-21-soft-interrupt.png" alt="soft-interrupt">&lt;/p>
&lt;p>å½“ç½‘å¡è®¾å¤‡å®Œæˆä¸€ä¸ªæ•°æ®å¸§çš„æ¥æ”¶åï¼Œå¯èƒ½å°†æ•°æ®å¸§æš‚å­˜äºè®¾å¤‡å†…å­˜ï¼Œä¹Ÿå¯èƒ½é€šè¿‡ DMA(Direct memory access) ç›´æ¥å†™å…¥åˆ°ä¸»å†…å­˜çš„æ¥æ”¶ç¯ï¼ˆrx ringï¼‰ï¼Œæ¥ä¸‹æ¥å¿…é¡»é€šçŸ¥æ“ä½œç³»ç»Ÿå†…æ ¸å¯¹å·²æ¥æ”¶çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;p>ä¸‹é¢å°†è®¨è®ºå‡ ç§å¯èƒ½çš„é€šçŸ¥æ‰‹æ®µã€‚&lt;/p>
&lt;h3 id="è½®è¯¢">è½®è¯¢&lt;/h3>
&lt;p>è½®è¯¢ï¼ˆPollingï¼‰æŒ‡çš„æ˜¯ç”±å†…æ ¸ä¸»åŠ¨åœ°å»æ£€æŸ¥è®¾å¤‡ï¼Œæ¯”å¦‚å®šæœŸè¯»å–è®¾å¤‡çš„å†…å­˜å¯„å­˜å™¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ–°çš„æ¥æ”¶å¸§éœ€è¦å¤„ç†ã€‚è¿™ç§æ–¹å¼åœ¨è®¾å¤‡è´Ÿè½½è¾ƒé«˜æ—¶å“åº”æ•ˆç‡ä½ï¼Œåœ¨è®¾å¤‡è´Ÿè½½ä½æ—¶åˆå ç”¨ç³»ç»Ÿèµ„æºï¼Œæ“ä½œç³»ç»Ÿå¾ˆå°‘å•ç‹¬é‡‡ç”¨ï¼Œç»“åˆå…¶ä»–æœºåˆ¶åæ‰èƒ½å®ç°è¾ƒç†æƒ³çš„æ•ˆæœã€‚&lt;/p>
&lt;h3 id="ç¡¬ä»¶ä¸­æ–­">ç¡¬ä»¶ä¸­æ–­&lt;/h3>
&lt;p>å½“æ¥æ”¶åˆ°æ–°çš„æ•°æ®å¸§ç­‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè®¾å¤‡å°†ç”Ÿæˆä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ä¿¡å·ã€‚è¯¥ä¿¡å·é€šå¸¸ç”±è®¾å¤‡å‘é€ç»™ä¸­æ–­æ§åˆ¶å™¨ï¼Œç”±ä¸­æ–­æ§åˆ¶å™¨åˆ†å‘ç»™ CPUã€‚CPU æ¥å—ä¿¡å·åå°†ä»å½“å‰æ‰§è¡Œçš„ä»»åŠ¡ä¸­è¢«æ‰“æ–­ï¼Œè½¬è€Œæ‰§è¡Œç”±è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†ç¨‹åºæ¥å¤„ç†è®¾å¤‡äº‹ä»¶ã€‚ä¸­æ–­å¤„ç†ç¨‹åºä¼šå°†æ•°æ®å¸§æ‹·è´åˆ°å†…æ ¸çš„è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œå¹¶é€šçŸ¥å†…æ ¸åšè¿›ä¸€æ­¥å¤„ç†ã€‚è¿™ç§æŠ€æœ¯åœ¨ä½è´Ÿè½½æ—¶è¡¨ç°è‰¯å¥½ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæ•°æ®å¸§éƒ½ä¼šå¾—åˆ°åŠæ—¶å“åº”ï¼Œä½†åœ¨è´Ÿè½½è¾ƒé«˜æ—¶ï¼ŒCPU ä¼šè¢«é¢‘ç¹çš„ä¸­æ–­ä»è€Œå½±å“åˆ°å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œã€‚&lt;/p>
&lt;p>å¯¹æ¥æ”¶å¸§çš„å¤„ç†é€šå¸¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šé¦–å…ˆé©±åŠ¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†ç¨‹åºå°†å¸§å¤åˆ¶åˆ°å†…æ ¸å¯è®¿é—®çš„è¾“å…¥é˜Ÿåˆ—ä¸­ï¼Œç„¶åå†…æ ¸å°†å…¶ä¼ é€’ç»™ç›¸å…³åè®®çš„å¤„ç†ç¨‹åºç›´åˆ°æœ€åè¢«åº”ç”¨ç¨‹åºæ¶ˆè´¹ã€‚ç¬¬ä¸€éƒ¨åˆ†çš„ä¸­æ–­å¤„ç†ç¨‹åºæ˜¯åœ¨ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ï¼Œå¯ä»¥æŠ¢å ç¬¬äºŒéƒ¨åˆ†çš„æ‰§è¡Œï¼Œè¿™æ„å‘³ç€å¤åˆ¶æ¥æ”¶å¸§åˆ°è¾“å…¥é˜Ÿåˆ—çš„ç¨‹åºæ¯”æ¶ˆè´¹æ•°æ®å¸§çš„åè®®æ ˆç¨‹åºæœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚&lt;/p>
&lt;p>åœ¨é«˜æµé‡è´Ÿè½½ä¸‹ï¼Œä¸­æ–­å¤„ç†ç¨‹åºä¼šä¸æ–­æŠ¢å  CPUã€‚åæœæ˜¾è€Œæ˜“è§ï¼šè¾“å…¥é˜Ÿåˆ—æœ€ç»ˆå°†è¢«å¡«æ»¡ï¼Œä½†åº”è¯¥å»å‡ºé˜Ÿå¹¶å¤„ç†è¿™äº›å¸§çš„ç¨‹åºå¤„äºè¾ƒä½ä¼˜å…ˆçº§æ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚ç»“æœæ–°çš„æ¥æ”¶å¸§å› ä¸ºè¾“å…¥é˜Ÿåˆ—å·²æ»¡æ— æ³•åŠ å…¥é˜Ÿåˆ—ï¼Œè€Œæ—§çš„å¸§å› ä¸ºæ²¡æœ‰å¯ç”¨çš„ CPU èµ„æºä¸ä¼šè¢«å¤„ç†ã€‚è¿™ç§æƒ…å†µè¢«ç§°ä¸ºæ¥æ”¶æ´»é”ï¼ˆreceive-livelockï¼‰ã€‚&lt;/p>
&lt;p>ç¡¬ä»¶ä¸­æ–­çš„ä¼˜ç‚¹æ˜¯å¸§çš„æ¥æ”¶å’Œå¤„ç†ä¹‹é—´çš„å»¶è¿Ÿéå¸¸ä½ï¼Œä½†åœ¨é«˜è´Ÿè½½ä¸‹ä¼šä¸¥é‡å½±å“å…¶ä»–å†…æ ¸æˆ–ç”¨æˆ·ç¨‹åºçš„æ‰§è¡Œã€‚å¤§å¤šæ•°ç½‘ç»œé©±åŠ¨ä¼šä½¿ç”¨ç¡¬ä»¶ä¸­æ–­çš„æŸç§ä¼˜åŒ–ç‰ˆæœ¬ã€‚&lt;/p>
&lt;h4 id="ä¸€æ¬¡å¤„ç†å¤šä¸ªå¸§">ä¸€æ¬¡å¤„ç†å¤šä¸ªå¸§&lt;/h4>
&lt;p>ä¸€äº›è®¾å¤‡é©±åŠ¨ä¼šé‡‡ç”¨ä¸€ç§æ”¹è‰¯æ–¹å¼ï¼Œå½“ä¸­æ–­å¤„ç†ç¨‹åºè¢«æ‰§è¡Œæ—¶ï¼Œä¼šåœ¨æŒ‡å®šçš„çª—å£æ—¶é—´æˆ–å¸§æ•°é‡ä¸Šé™å†…æŒç»­åœ°å…¥é˜Ÿæ•°æ®å¸§ã€‚ç”±äºä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œæ—¶å…¶ä»–ä¸­æ–­å°†è¢«ç¦ç”¨ï¼Œå› æ­¤å¿…é¡»è®¾ç½®åˆç†çš„æ‰§è¡Œç­–ç•¥æ¥å’Œå…¶ä»–ä»»åŠ¡å…±äº« CPU èµ„æºã€‚&lt;/p>
&lt;p>è¯¥æ–¹å¼è¿˜å¯è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œè®¾å¤‡ä»…é€šè¿‡ç¡¬ä»¶ä¸­æ–­æ¥é€šçŸ¥å†…æ ¸æœ‰å¾…å¤„ç†çš„æ¥æ”¶å¸§ï¼Œå°†å…¥é˜Ÿå¹¶å¤„ç†æ¥æ”¶å¸§çš„å·¥ä½œäº¤ç»™å†…æ ¸çš„å…¶ä»–å¤„ç†ç¨‹åºæ¥æ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ Linux çš„æ–°æ¥å£ NAPI çš„å·¥ä½œæ–¹å¼ã€‚&lt;/p>
&lt;h4 id="è®¡æ—¶ä¸­æ–­">è®¡æ—¶ä¸­æ–­&lt;/h4>
&lt;p>é™¤äº†æ ¹æ®äº‹ä»¶ç«‹åˆ»ç”Ÿæˆä¸­æ–­ï¼Œè®¾å¤‡ä¹Ÿå¯åœ¨æœ‰æ¥æ”¶å¸§æ—¶ï¼Œä»¥å›ºå®šçš„é—´éš”å‘é€ä¸­æ–­ï¼Œä¸­æ–­å¤„ç†ç¨‹åºå°†æ£€æŸ¥è¿™æ®µé—´éš”æ—¶é—´å†…æ˜¯å¦æœ‰æ–°çš„å¸§ï¼Œå¹¶ä¸€æ¬¡æ€§å¤„ç†å®ƒä»¬ã€‚å¦‚æœæ‰€æœ‰æ¥æ”¶å¸§å·²ç»å¤„ç†å®Œæ¯•å¹¶ä¸”æ²¡æœ‰æ–°çš„å¸§ï¼Œè®¾å¤‡ä¼šåœæ­¢å‘é€ä¸­æ–­ã€‚&lt;/p>
&lt;p>è¿™ç§æ–¹å¼è¦æ±‚è®¾å¤‡åœ¨ç¡¬ä»¶å±‚é¢å®ç°è®¡æ—¶åŠŸèƒ½ï¼Œè€Œä¸”æ ¹æ®è®¡æ—¶é—´éš”é•¿çŸ­ä¼šå¸¦æ¥å›ºå®šçš„å¤„ç†å»¶è¿Ÿï¼Œä½†åœ¨é«˜è´Ÿè½½æ—¶å¯ä»¥æœ‰æ•ˆåœ°å‡å°‘ CPU å ç”¨å¹¶ä¸”é¿å…æ¥æ”¶æ´»é”ã€‚&lt;/p>
&lt;h3 id="åœ¨å®è·µä¸­çš„ç»„åˆ">åœ¨å®è·µä¸­çš„ç»„åˆ&lt;/h3>
&lt;p>ä¸åŒçš„é€šçŸ¥æœºåˆ¶æœ‰å…¶é€‚åˆçš„å·¥ä½œåœºæ™¯ï¼šä½è´Ÿè½½ä¸‹çº¯ä¸­æ–­æ¨¡å‹ä¿è¯äº†æä½å»¶è¿Ÿï¼Œä½†åœ¨é«˜è´Ÿè½½ä¸‹è¡¨ç°ç³Ÿç³•ï¼›è®¡æ—¶ä¸­æ–­åœ¨ä½è´Ÿè½½ä¸‹å¯èƒ½ä¼šå¼•å…¥è¿‡é«˜å»¶è¿Ÿå¹¶æµªè´¹ CPU æ—¶é—´ï¼Œä½†åœ¨é«˜è´Ÿè½½ä¸‹å¯¹å‡å°‘ CPU å ç”¨å’Œè§£å†³æ¥æ”¶æ´»é”æœ‰å¾ˆå¤§å¸®åŠ©ã€‚åœ¨å®è·µä¸­ï¼Œç½‘ç»œè®¾å¤‡å¾€å¾€ä¸ä¾èµ–æŸç§å•ä¸€æ¨¡å‹ï¼Œè€Œæ˜¯é‡‡å–ç»„åˆæ–¹æ¡ˆã€‚&lt;/p>
&lt;p>ä»¥ Linux 2.6 Vortex è®¾å¤‡æ‰€æ³¨å†Œçš„ä¸­æ–­å¤„ç†å‡½æ•° &lt;code>vortex_interrupt&lt;/code> ï¼ˆä½äº /drivers/net/3c59x.cï¼‰ä¸ºä¾‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾å¤‡ä¼šå°†å¤šä¸ªäº‹ä»¶å½’ç±»ä¸ºä¸€ç§ä¸­æ–­ç±»å‹ï¼ˆç”šè‡³è¿˜å¯ä»¥åœ¨å‘é€ä¸­æ–­ä¿¡å·å‰ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå°†å¤šä¸ªä¸­æ–­èšåˆæˆä¸€ä¸ªä¿¡å·å‘é€ï¼‰ã€‚ä¸­æ–­è§¦å‘ &lt;code>vortex_interrupt&lt;/code> çš„æ‰§è¡Œå¹¶ç¦ç”¨è¯¥ CPU ä¸Šçš„ä¸­æ–­ã€‚&lt;/li>
&lt;li>å¦‚æœä¸­æ–­æ˜¯ç”±æ¥æ”¶å¸§äº‹ä»¶ &lt;code>RxComplete&lt;/code> å¼•å‘ï¼Œå¤„ç†ç¨‹åºè°ƒç”¨å…¶ä»–ä»£ç å¤„ç†è®¾å¤‡æ¥æ”¶çš„å¸§ã€‚&lt;/li>
&lt;li>&lt;code>vortex_interrupt&lt;/code> åœ¨æ‰§è¡ŒæœŸé—´æŒç»­è¯»å–è®¾å¤‡å¯„å­˜å™¨ï¼Œæ£€æŸ¥è®¾å¤‡æ˜¯å¦æœ‰æ–°çš„ä¸­æ–­ä¿¡å·å‘å‡ºã€‚å¦‚æœæœ‰ä¸”ä¸­æ–­äº‹ä»¶ä¸º &lt;code>RxComplete&lt;/code>ï¼Œå¤„ç†ç¨‹åºå°†ç»§ç»­å¤„ç†æ¥æ”¶å¸§ï¼Œç›´åˆ°å·²å¤„ç†å¸§çš„æ•°é‡è¾¾åˆ°é¢„è®¾çš„ &lt;code>work_done&lt;/code>å€¼æ‰ç»“æŸã€‚è€Œå…¶ä»–ç±»å‹çš„ä¸­æ–­å°†è¢«å¤„ç†ç¨‹åºå¿½ç•¥ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="è½¯ä¸­æ–­å¤„ç†æœºåˆ¶">è½¯ä¸­æ–­å¤„ç†æœºåˆ¶&lt;/h2>
&lt;p>å½“ç¡¬ä»¶ä¸­æ–­ä¿¡å·åˆ°è¾¾ CPU åï¼Œéœ€è¦é€šè¿‡åˆç†çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ï¼Œæ‰èƒ½ä»¥è¾ƒä½å»¶è¿Ÿå¤„ç†æ¥æ”¶å¸§ï¼Œåˆé¿å…æ¥æ”¶æ´»é”å’Œé¥¥é¥¿ç­‰èµ„æºæŠ¢å é—®é¢˜ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªä¸­æ–­é€šå¸¸ä¼šè§¦å‘ä»¥ä¸‹äº‹ä»¶ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾å¤‡äº§ç”Ÿä¸€ä¸ªä¸­æ–­å¹¶é€šè¿‡ç¡¬ä»¶é€šçŸ¥å†…æ ¸ã€‚&lt;/li>
&lt;li>å¦‚æœå†…æ ¸æ²¡æœ‰æ­£åœ¨å¤„ç†å¦ä¸€ä¸ªä¸­æ–­ï¼ˆå³ä¸­æ–­æ²¡æœ‰è¢«ç¦ç”¨ï¼‰ï¼Œå®ƒå°†æ”¶åˆ°è¿™ä¸ªé€šçŸ¥ã€‚&lt;/li>
&lt;li>å†…æ ¸ç¦ç”¨æœ¬åœ° CPU çš„ä¸­æ–­ï¼Œå¹¶æ‰§è¡Œä¸æ”¶åˆ°çš„ä¸­æ–­ç±»å‹ç›¸å…³è”çš„å¤„ç†ç¨‹åºã€‚&lt;/li>
&lt;li>å†…æ ¸é€€å‡ºä¸­æ–­å¤„ç†ç¨‹åºï¼Œé‡æ–°å¯ç”¨æœ¬åœ° CPU çš„ä¸­æ–­ã€‚&lt;/li>
&lt;/ol>
&lt;p>CPU åœ¨æ‰§è¡Œä¸­æ–­å·å¯¹åº”å¤„ç†ç¨‹åºçš„æœŸé—´å¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œä¸­æ–­ä¼šè¢«ç¦ç”¨ã€‚è¿™æ„å‘³ç€ CPU åœ¨å¤„ç†æŸä¸ªä¸­æ–­æœŸé—´ï¼Œå®ƒæ—¢ä¸ä¼šå¤„ç†å…¶ä»–ä¸­æ–­ï¼Œä¹Ÿä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æŠ¢å ï¼ŒCPU èµ„æºç”±è¯¥ä¸­æ–­å¤„ç†ç¨‹åºç‹¬å ã€‚è¿™ç§è®¾è®¡å†³å®šå‡å°‘äº†ç«äº‰æ¡ä»¶çš„å¯èƒ½æ€§ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ½œåœ¨çš„æ€§èƒ½å½±å“ã€‚&lt;/p>
&lt;p>æ˜¾ç„¶ï¼Œä¸­æ–­å¤„ç†ç¨‹åºåº”å½“å°½å¯èƒ½å¿«åœ°å®Œæˆå·¥ä½œã€‚ä¸åŒçš„ä¸­æ–­äº‹ä»¶æ‰€éœ€è¦çš„å¤„ç†å·¥ä½œé‡å¹¶ä¸ç›¸åŒï¼Œæ¯”å¦‚å½“é”®ç›˜çš„æŒ‰é”®è¢«æŒ‰ä¸‹æ—¶ï¼Œè§¦å‘çš„ä¸­æ–­å¤„ç†å‡½æ•°åªéœ€è¦å°†è¯¥æŒ‰é”®çš„ç¼–ç è®°å½•ä¸‹æ¥ï¼Œè€Œä¸”è¿™ç§äº‹ä»¶çš„å‘ç”Ÿé¢‘ç‡ä¸ä¼šå¾ˆé«˜ï¼›è€Œå¤„ç†ç½‘ç»œè®¾å¤‡æ”¶åˆ°çš„æ–°æ•°æ®å¸§æ—¶ï¼Œéœ€è¦ä¸º &lt;code>skb&lt;/code> åˆ†é…å†…å­˜ç©ºé—´ï¼Œæ‹·è´æ¥æ”¶åˆ°çš„æ•°æ®ï¼ŒåŒæ—¶å®Œæˆä¸€äº›åˆå§‹åŒ–å·¥ä½œæ¯”å¦‚åˆ¤æ–­æ•°æ®æ‰€å±çš„ç½‘ç»œåè®®ç­‰ã€‚&lt;/p>
&lt;p>ä¸ºäº†å°½é‡å‡å°‘ CPU å¤„äºä¸­æ–­ä¸Šä¸‹æ–‡çš„æ—¶é—´ï¼Œæ“ä½œç³»ç»Ÿä¸ºä¸­æ–­å¤„ç†ç¨‹åºå¼•å…¥äº†ä¸Šã€ä¸‹åŠéƒ¨çš„æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="ä¸‹åŠéƒ¨å¤„ç†ç¨‹åº">ä¸‹åŠéƒ¨å¤„ç†ç¨‹åº&lt;/h3>
&lt;p>å³ä½¿ç”±ä¸­æ–­è§¦å‘çš„å¤„ç†åŠ¨ä½œéœ€è¦å¤§é‡çš„ CPU æ—¶é—´ï¼Œå¤§éƒ¨åˆ†åŠ¨ä½œé€šå¸¸æ˜¯å¯ä»¥ç­‰å¾…çš„ã€‚ä¸­æ–­å¯ä»¥ç¬¬ä¸€æ—¶é—´æŠ¢å  CPU æ‰§è¡Œï¼Œå› ä¸ºå¦‚æœæ“ä½œç³»ç»Ÿè®©ç¡¬ä»¶ç­‰å¾…å¤ªé•¿æ—¶é—´ï¼Œç¡¬ä»¶å¯èƒ½ä¼šä¸¢å¤±æ•°æ®ã€‚è¿™æ—¢é€‚ç”¨äºå®æ—¶çš„æ•°æ®ï¼Œä¹Ÿé€‚ç”¨äºåœ¨å›ºå®šå¤§å°ç¼“å†²åŒºä¸­å­˜å‚¨çš„æ•°æ®ã€‚å¦‚æœç¡¬ä»¶ä¸¢å¤±äº†æ•°æ®ï¼Œä¸€èˆ¬æ²¡æœ‰åŠæ³•å†æ¢å¤ï¼ˆä¸è€ƒè™‘å‘é€æ–¹é‡ä¼ çš„æƒ…å†µï¼‰ã€‚
å¦ä¸€æ–¹é¢ï¼Œå†…æ ¸æˆ–ç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹è¢«æ¨è¿Ÿæ‰§è¡Œæˆ–æŠ¢å æ—¶ï¼Œä¸€èˆ¬ä¸ä¼šæœ‰ä»€ä¹ˆæŸå¤±ï¼ˆå¯¹å®æ—¶æ€§æœ‰æé«˜è¦æ±‚çš„ç³»ç»Ÿé™¤å¤–ï¼Œå®ƒéœ€è¦ç”¨å®Œå…¨ä¸åŒçš„æ–¹å¼æ¥å¤„ç†è¿›ç¨‹å’Œä¸­æ–­ï¼‰ã€‚&lt;/p>
&lt;p>é‰´äºè¿™äº›è€ƒè™‘ï¼Œç°ä»£ä¸­æ–­å¤„ç†ç¨‹åºè¢«åˆ†ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ã€‚ä¸ŠåŠéƒ¨åˆ†æ‰§è¡Œåœ¨é‡Šæ”¾ CPU èµ„æºä¹‹å‰å¿…é¡»å®Œæˆçš„å·¥ä½œï¼Œå¦‚ä¿å­˜æ¥æ”¶çš„æ•°æ®ï¼›ä¸‹åŠéƒ¨åˆ†åˆ™æ‰§è¡Œå¯ä»¥åœ¨æ¨è¿Ÿåˆ°ç©ºé—²æ—¶å®Œæˆçš„å·¥ä½œï¼Œå¦‚å®Œæˆæ¥æ”¶æ•°æ®çš„è¿›ä¸€æ­¥å¤„ç†ã€‚&lt;/p>
&lt;p>ä½ å¯ä»¥è®¤ä¸ºä¸‹åŠéƒ¨æ˜¯ä¸€ä¸ªå¯ä»¥å¼‚æ­¥æ‰§è¡Œçš„ç‰¹å®šå‡½æ•°ã€‚å½“ä¸€ä¸ªä¸­æ–­è§¦å‘æ—¶ï¼Œæœ‰äº›å·¥ä½œå¹¶ä¸è¦æ±‚é©¬ä¸Šå®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™éƒ¨åˆ†å·¥ä½œåŒ…è£…ä¸ºä¸‹åŠéƒ¨å¤„ç†ç¨‹åºå»¶åæ‰§è¡Œã€‚
ä¸Šã€ä¸‹åŠéƒ¨å·¥ä½œæ¨¡å‹å¯ä»¥æœ‰æ•ˆç¼©çŸ­ CPU å¤„äºä¸­æ–­ä¸Šä¸‹æ–‡ï¼ˆå³ç¦ç”¨ä¸­æ–­ï¼‰çš„æ—¶é—´ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾å¤‡å‘ CPU å‘å‡ºä¸­æ–­ä¿¡å·ï¼Œé€šçŸ¥å®ƒæœ‰ç‰¹å®šäº‹ä»¶å‘ç”Ÿã€‚&lt;/li>
&lt;li>CPU æ‰§è¡Œä¸­æ–­ç›¸å…³çš„ä¸ŠåŠéƒ¨å¤„ç†å‡½æ•°ï¼Œç¦ç”¨ä¹‹åçš„ä¸­æ–­é€šçŸ¥ï¼Œç›´åˆ°å¤„ç†ç¨‹åºå®Œæˆå·¥ä½œï¼š
a. å°†ä¸€äº›æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç”¨äºå†…æ ¸åœ¨ä¹‹åè¿›ä¸€æ­¥å¤„ç†ä¸­æ–­äº‹ä»¶ã€‚
b. è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼Œä»¥ç¡®ä¿å†…æ ¸çŸ¥é“æœ‰å¾…å¤„ç†çš„ä¸­æ–­ã€‚
c. åœ¨ç»ˆæ­¢ä¹‹å‰é‡æ–°å¯ç”¨æœ¬åœ° CPU çš„ä¸­æ–­é€šçŸ¥ã€‚&lt;/li>
&lt;li>åœ¨ä¹‹åçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œå½“å†…æ ¸æ²¡æœ‰æ›´ç´§è¿«çš„ä»»åŠ¡å¤„ç†æ—¶ï¼Œä¼šæ£€æŸ¥ä¸ŠåŠéƒ¨å¤„ç†ç¨‹åºè®¾ç½®çš„æ ‡å¿—ä½ï¼Œå¹¶è°ƒç”¨å…³è”çš„ä¸‹åŠéƒ¨åˆ†å¤„ç†ç¨‹åºã€‚è°ƒç”¨ä¹‹åå®ƒä¼šé‡ç½®è¿™ä¸ªæ ‡å¿—ä½ï¼Œè¿›å…¥ä¸‹ä¸€è½®å¤„ç†ã€‚&lt;/li>
&lt;/ol>
&lt;p>Linux ä¸ºä¸‹åŠéƒ¨å¤„ç†å®ç°äº†å¤šç§ä¸åŒçš„æœºåˆ¶ï¼šè½¯ä¸­æ–­ã€å¾®ä»»åŠ¡å’Œå·¥ä½œé˜Ÿåˆ—ï¼Œè¿™äº›æœºåˆ¶åŒæ ·é€‚ç”¨äºæ“ä½œç³»ç»Ÿä¸­çš„å»¶æ—¶ä»»åŠ¡ã€‚ä¸‹åŠéƒ¨å¤„ç†æœºåˆ¶é€šå¸¸éƒ½æœ‰ä»¥ä¸‹å…±åŒç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>å®šä¹‰ä¸åŒçš„ç±»å‹ï¼Œå¹¶åœ¨ç±»å‹å’Œå…·ä½“çš„å¤„ç†ä»»åŠ¡ä¹‹é—´å»ºç«‹å…³è”ã€‚&lt;/li>
&lt;li>è°ƒåº¦å¤„ç†ä»»åŠ¡çš„æ‰§è¡Œã€‚&lt;/li>
&lt;li>é€šçŸ¥å†…æ ¸æœ‰å·²è°ƒåº¦çš„ä»»åŠ¡éœ€è¦æ‰§è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>æ¥ä¸‹æ¥ç€é‡ä»‹ç»å¤„ç†ç½‘ç»œæ•°æ®å¸§ç”¨åˆ°çš„è½¯ä¸­æ–­æœºåˆ¶ã€‚&lt;/p>
&lt;h3 id="è½¯ä¸­æ–­">è½¯ä¸­æ–­&lt;/h3>
&lt;p>è½¯ä¸­æ–­æœ‰ä»¥ä¸‹å‡ ç§å¸¸ç”¨ç±»å‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">enum&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">HI_SOFTIRQ&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TIMER_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NET_TX_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NET_RX_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">BLOCK_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">IRQ_POLL_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">TASKLET_SOFTIRQ&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ &lt;strong>NET_TX_SOFTIRQ&lt;/strong> å’Œ &lt;strong>NET_RX_SOFTIRQ&lt;/strong> ç”¨äºå¤„ç†ç½‘ç»œæ•°æ®çš„æ¥æ”¶å’Œå‘é€ã€‚&lt;/p>
&lt;h4 id="è°ƒåº¦ä¸æ‰§è¡Œæ—¶æœº">è°ƒåº¦ä¸æ‰§è¡Œæ—¶æœº&lt;/h4>
&lt;p>æ¯å½“ç½‘ç»œè®¾å¤‡æ¥æ”¶ä¸€ä¸ªå¸§åï¼Œä¼šå‘é€ç¡¬ä»¶ä¸­æ–­é€šçŸ¥å†…æ ¸è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºé€šè¿‡ä»¥ä¸‹å‡½æ•°åœ¨æœ¬åœ° CPU ä¸Šè§¦å‘è½¯ä¸­æ–­çš„è°ƒåº¦ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>__raise_softirq_irqoff&lt;/code>ï¼šåœ¨ä¸€ä¸ªä¸“é—¨çš„ bitmap ï¼ˆä½å›¾ï¼‰ç»“æ„ä¸­è®¾ç½®ä¸è½¯ä¸­æ–­ç±»å‹å¯¹åº”çš„æ¯”ç‰¹ä½ï¼Œå½“åç»­å¯¹è¯¥æ¯”ç‰¹ä½çš„æ£€æŸ¥ç»“æœä¸ºçœŸæ—¶ï¼Œè°ƒç”¨ä¸è½¯ä¸­æ–­å…³è”çš„å¤„ç†ç¨‹åºã€‚æ¯ä¸ª CPU ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ bitmapã€‚&lt;/li>
&lt;li>&lt;code>raise_softirq_irqoff&lt;/code>ï¼šå†…éƒ¨åŒ…è£…äº† &lt;code>__raise_softirq_irqoff&lt;/code> å‡½æ•°ã€‚å¦‚æœæ­¤å‡½æ•°ä¸æ˜¯ä»ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ï¼Œä¸”æŠ¢å æœªè¢«ç¦ç”¨ï¼Œå°†ä¼šé¢å¤–è°ƒåº¦ä¸€ä¸ª &lt;code>ksoftirqd&lt;/code> çº¿ç¨‹ã€‚&lt;/li>
&lt;li>&lt;code>raise_softirq&lt;/code>: å†…éƒ¨åŒ…è£…äº† &lt;code>raise_softirq_irqoff&lt;/code>ï¼Œä½†æ‰§è¡Œæ—¶ä¼šç¦ç”¨ CPU ä¸­æ–­ã€‚&lt;/li>
&lt;/ol>
&lt;p>åœ¨ç‰¹å®šçš„æ—¶æœºï¼Œå†…æ ¸ä¼šæ£€æŸ¥æ¯ä¸ª CPU ç‹¬æœ‰çš„ bitmap åˆ¤æ–­æ˜¯å¦æœ‰å·²è°ƒåº¦çš„è½¯ä¸­æ–­ç­‰å¾…æ‰§è¡Œï¼Œå¦‚æœæœ‰å°†ä¼šè°ƒç”¨ &lt;code>do_softirq&lt;/code> å¤„ç†è½¯ä¸­æ–­ã€‚å†…æ ¸å¤„ç†è½¯ä¸­æ–­çš„æ—¶æœºå¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>do_IRQ&lt;/p>
&lt;p>æ¯å½“å†…æ ¸æ”¶åˆ°ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­çš„ IRQ é€šçŸ¥æ—¶ï¼Œä¼šè°ƒç”¨ &lt;code>do_IRQ&lt;/code> æ¥æ‰§è¡Œä¸­æ–­å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚ä¸­æ–­å¤„ç†ç¨‹åºä¸­å¯èƒ½ä¼šè°ƒåº¦æ–°çš„è½¯ä¸­æ–­ï¼Œå› æ­¤åœ¨ &lt;code>do_IRQ&lt;/code> ç»“æŸæ—¶å¤„ç†è½¯ä¸­æ–­æ˜¯ä¸€ä¸ªå¾ˆè‡ªç„¶çš„è®¾è®¡ï¼Œä¹Ÿå¯ä»¥æœ‰æ•ˆçš„é™ä½å»¶è¿Ÿã€‚æ­¤å¤–ï¼Œå†…æ ¸çš„æ—¶é’Ÿä¸­æ–­è¿˜ä¿è¯äº†ä¸¤æ¬¡è½¯ä¸­æ–­å¤„ç†æ—¶æœºä¹‹é—´çš„æœ€å¤§æ—¶é—´é—´éš”ã€‚&lt;/p>
&lt;p>å¤§éƒ¨åˆ†æ¶æ„çš„å†…æ ¸ä¼šåœ¨é€€å‡ºä¸­æ–­ä¸Šä¸‹æ–‡æ­¥éª¤ &lt;code>irq_exit()&lt;/code> ä¸­è°ƒç”¨ &lt;code>do_softirq&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">__irq_entry&lt;/span> &lt;span class="nf">do_IRQ&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">pt_regs&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">regs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">exit_idle&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">irq_enter&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// handle irq with registered handler
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">irq_exit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_irq_regs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">old_regs&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ &lt;code>irq_exit()&lt;/code> ä¸­ï¼Œå¦‚æœå†…æ ¸å·²ç»é€€å‡ºä¸­æ–­ä¸Šä¸‹æ–‡ä¸”æœ‰å¾…æ‰§è¡Œçš„è½¯ä¸­æ–­ï¼Œå°†è°ƒç”¨ &lt;code>invoke_softirq()&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">void&lt;/span> &lt;span class="nf">irq_exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">account_system_vtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">current&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trace_hardirq_exit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sub_preempt_count&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">IRQ_EXIT_OFFSET&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">in_interrupt&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">local_softirq_pending&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">invoke_softirq&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rcu_irq_exit&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_enable_no_resched&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>invoke_softirq&lt;/code> æ˜¯å¯¹ &lt;code>do_softirq&lt;/code> çš„ç®€å•å°è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">invoke_softirq&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">force_irqthreads&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">do_softirq&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">wakeup_softirqd&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä»ä¸­æ–­å’Œå¼‚å¸¸äº‹ä»¶ï¼ˆåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨ï¼‰è¿”å›æ—¶ï¼Œè¿™éƒ¨åˆ†å¤„ç†é€»è¾‘ç›´æ¥å†™å…¥äº†æ±‡ç¼–ä»£ç ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>local_bh_enable&lt;/code> å¼€å¯è½¯ä¸­æ–­æ—¶ï¼Œå°†æ‰§è¡Œå¾…å¤„ç†çš„è½¯ä¸­æ–­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè½¯ä¸­æ–­çº¿ç¨‹ ksoftirqd_CPUnï¼Œè¯¥çº¿ç¨‹æ‰§è¡Œæ—¶ä¹Ÿä¼šå¤„ç†è½¯ä¸­æ–­ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>è½¯ä¸­æ–­æ‰§è¡Œæ—¶ CPU ä¸­æ–­æ˜¯å¼€å¯çš„ï¼Œè½¯ä¸­æ–­å¯ä»¥è¢«æ–°çš„ä¸­æ–­æŒ‚èµ·ã€‚ä½†å¦‚æœè½¯ä¸­æ–­çš„ä¸€ä¸ªå®ä¾‹å·²ç»åœ¨ä¸€ä¸ª CPU ä¸Šè¿è¡Œæˆ–æŒ‚èµ·ï¼Œå†…æ ¸å°†ç¦æ­¢è¯¥è½¯ä¸­æ–­ç±»å‹çš„æ–°è¯·æ±‚åœ¨ CPU ä¸Šè¿è¡Œï¼Œè¿™æ ·å¯ä»¥å¤§å¹…å‡å°‘è½¯ä¸­æ–­æ‰€éœ€çš„å¹¶å‘é”ã€‚&lt;/p>
&lt;h4 id="è½¯ä¸­æ–­çš„å¤„ç†">è½¯ä¸­æ–­çš„å¤„ç†&lt;/h4>
&lt;p>å½“æ‰§è¡Œè½¯ä¸­æ–­çš„æ—¶æœºè¾¾æˆï¼Œå†…æ ¸ä¼šæ‰§è¡Œ &lt;code>do_softirq&lt;/code> å‡½æ•°ã€‚&lt;/p>
&lt;p>&lt;code>do_softirq&lt;/code> é¦–å…ˆä¼šå°†å¾…æ‰§è¡Œçš„è½¯ä¸­æ–­ä¿å­˜ä¸€ä»½å‰¯æœ¬ã€‚åœ¨ &lt;code>do_softirq&lt;/code> è¿è¡Œæ—¶ï¼ŒåŒä¸€ä¸ªè½¯ä¸­æ–­ç±»å‹æœ‰å¯èƒ½è¢«è°ƒåº¦å¤šæ¬¡ï¼šè¿è¡Œè½¯ä¸­æ–­å¤„ç†ç¨‹åºæ—¶å¯ä»¥è¢«ç¡¬ä»¶ä¸­æ–­æŠ¢å ï¼Œå¤„ç†ä¸­æ–­æ—¶æœŸé—´å¯ä»¥é‡æ–°è®¾ç½® cpu çš„å¾…å¤„ç†è½¯ä¸­æ–­ bitmapï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰§è¡Œä¸€ä¸ªå¾…å¤„ç†çš„è½¯ä¸­æ–­æœŸé—´ï¼Œè¿™ä¸ªè½¯ä¸­æ–­å¯èƒ½ä¼šè¢«é‡æ–°è°ƒåº¦ã€‚å‡ºäºè¿™ä¸ªåŸå› ï¼Œ&lt;code>do_softirq&lt;/code> ä¼šé¦–å…ˆç¦ç”¨ä¸­æ–­ï¼Œå°†å¾…å¤„ç†è½¯ä¸­æ–­çš„ bitmap ä¿å­˜ä¸€ä»½å‰¯æœ¬åˆ°å±€éƒ¨å˜é‡ &lt;code>pending&lt;/code> ä¸­ï¼Œç„¶åå°†æœ¬åœ° CPU çš„è½¯ä¸­æ–­ bitmap ä¸­å¯¹åº”çš„ä½é‡ç½®ä¸º 0ï¼Œéšåé‡æ–°å¼€å¯ä¸­æ–­ã€‚æœ€åï¼ŒåŸºäºå‰¯æœ¬ &lt;code>pending&lt;/code> ä¾æ¬¡æ£€æŸ¥æ¯ä¸€ä½æ˜¯å¦ä¸º 1ï¼Œå¦‚æœæ˜¯åˆ™æ ¹æ®è½¯ä¸­æ–­ç±»å‹è°ƒç”¨å¯¹åº”çš„å¤„ç†ç¨‹åºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">do&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pending&lt;/span> &lt;span class="o">&amp;amp;&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">vec_nr&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">softirq_vec&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">prev_count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">preempt_count&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">kstat_incr_softirqs_this_cpu&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vec_nr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trace_softirq_entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vec_nr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">h&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trace_softirq_exit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">vec_nr&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unlikely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">prev_count&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="n">preempt_count&lt;/span>&lt;span class="p">()))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">printk&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">KERN_ERR&lt;/span> &lt;span class="s">&amp;#34;huh, entered softirq %u %s %p&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;with preempt_count %08x,&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34; exited with %08x?&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s">&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">vec_nr&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">softirq_to_name&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">vec_nr&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">action&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">prev_count&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">preempt_count&lt;/span>&lt;span class="p">());&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_count&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">prev_count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rcu_bh_qs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cpu&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">h&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pending&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pending&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç­‰å¾…ä¸­çš„è½¯ä¸­æ–­è°ƒç”¨æ¬¡åºå–å†³äºä½å›¾ä¸­æ ‡å¿—ä½çš„ä½ç½®ä»¥åŠæ‰«æè¿™äº›æ ‡å¿—çš„æ–¹å‘ï¼ˆç”±ä½ä½åˆ°é«˜ä½ï¼‰ï¼Œå¹¶ä¸æ˜¯ä»¥å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼æ‰§è¡Œçš„ã€‚&lt;/p>
&lt;p>å½“æ‰€æœ‰çš„å¤„ç†ç¨‹åºæ‰§è¡Œå®Œæ¯•åï¼Œ&lt;code>do_softirq&lt;/code> å†æ¬¡ç¦ç”¨ä¸­æ–­ï¼Œå¹¶é‡æ–°æ£€æŸ¥ CPU çš„å¾…å¤„ç†ä¸­æ–­ bitmapï¼Œå¦‚æœå‘ç°åˆæœ‰æ–°çš„å¾…å¤„ç†è½¯ä¸­æ–­ï¼Œåˆ™å†æ¬¡åˆ›å»ºä¸€ä»½å‰¯æœ¬é‡æ–°æ‰§è¡Œä¸Šè¿°æµç¨‹ã€‚è¿™ç§å¤„ç†æµç¨‹æœ€å¤šä¼šé‡å¤æ‰§è¡Œ &lt;strong>MAX_SOFTIRQ_RESTART&lt;/strong> æ¬¡ï¼ˆé€šå¸¸å€¼ä¸º 10ï¼‰ï¼Œä»¥é¿å…æ— é™æŠ¢å  CPU èµ„æºã€‚&lt;/p>
&lt;p>å½“å¤„ç†è½®æ¬¡åˆ°è¾¾ &lt;strong>MAX_SOFTIRQ_RESTART&lt;/strong> é˜ˆå€¼æ—¶ï¼Œ&lt;code>do_ softirq&lt;/code> å¿…é¡»ç»“æŸæ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶ä¾ç„¶æœ‰æœªæ‰§è¡Œçš„è½¯ä¸­æ–­ï¼Œå°†å”¤é†’ ksoftirqd çº¿ç¨‹æ¥å¤„ç†ã€‚ä½†æ˜¯ &lt;code>do_softirq&lt;/code> åœ¨å†…æ ¸ä¸­çš„è°ƒç”¨é¢‘ç‡å¾ˆé«˜ï¼Œå®é™…ä¸Šåç»­è°ƒç”¨çš„ &lt;code>do_softirq&lt;/code> å¯èƒ½ä¼šåœ¨ ksoftirqd çº¿ç¨‹è¢«è°ƒåº¦ä¹‹å‰å°±å¤„ç†å®Œäº†è¿™äº›è½¯ä¸­æ–­ã€‚&lt;/p>
&lt;h4 id="ksoftirqd-å†…æ ¸çº¿ç¨‹">ksoftirqd å†…æ ¸çº¿ç¨‹&lt;/h4>
&lt;p>æ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ ksoftirqdï¼ˆé€šå¸¸æ ¹æ® CPU åºå·å‘½åä¸º ksoftirqd_CPUnï¼‰,å½“ä¸Šæ–‡æè¿°çš„æœºåˆ¶æ— æ³•å¤„ç†å®Œæ‰€æœ‰çš„è½¯ä¸­æ–­æ—¶ï¼Œè¯¥ CPU ä½äºåå°çš„ ksoftirqd çº¿ç¨‹è¢«å”¤é†’ï¼Œå¹¶æ‰¿æ‹…èµ·åœ¨è·å¾—è°ƒåº¦åå°½å¯èƒ½å¤šçš„å¤„ç†å¾…æ‰§è¡Œè½¯ä¸­æ–­çš„èŒè´£ã€‚&lt;/p>
&lt;p>ksoftirqd å…³è”çš„ä»»åŠ¡å‡½æ•° &lt;code>run_ksoftirqd&lt;/code> å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">run_ksoftirqd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">void&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">__bind_cpu&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_INTERRUPTIBLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">kthread_should_stop&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">local_softirq_pending&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_enable_no_resched&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">schedule&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_RUNNING&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">local_softirq_pending&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Preempt disable stops cpu going offline.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> If already offline, we&amp;#39;ll be on wrong CPU:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm"> don&amp;#39;t process */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">cpu_is_offline&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">__bind_cpu&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">wait_to_die&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_irq_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">local_softirq_pending&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__do_softirq&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_irq_enable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_enable_no_resched&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cond_resched&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rcu_note_context_switch&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="kt">long&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="n">__bind_cpu&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_enable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_INTERRUPTIBLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_RUNNING&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nl">wait_to_die&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">preempt_enable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Wait for kthread_stop */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_INTERRUPTIBLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">kthread_should_stop&lt;/span>&lt;span class="p">())&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">schedule&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_INTERRUPTIBLE&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__set_current_state&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">TASK_RUNNING&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ksoftirqd åšçš„äº‹æƒ…å’Œ &lt;code>do_softirq&lt;/code> åŸºæœ¬ç›¸åŒï¼Œå…¶ä¸»è¦é€»è¾‘æ˜¯é€šè¿‡ while å¾ªç¯ä¸æ–­çš„è°ƒç”¨ &lt;code>__do_softirq&lt;/code> ï¼ˆè¯¥å‡½æ•°ä¹Ÿæ˜¯ &lt;code>do_softirq&lt;/code> çš„æ ¸å¿ƒé€»è¾‘ï¼‰ï¼Œåªæœ‰è¾¾åˆ°ä»¥ä¸‹ä¸¤ç§æ¡ä»¶æ—¶æ‰ä¼šåœæ­¢ï¼š&lt;/p>
&lt;ol>
&lt;li>æ²¡æœ‰å¾…å¤„ç†çš„è½¯ä¸­æ–­æ—¶ï¼Œæ­¤æ—¶ ksoftirqd ä¼šè°ƒç”¨ &lt;code>schedule()&lt;/code> è§¦å‘è°ƒåº¦ä¸»åŠ¨è®©å‡º CPU èµ„æºã€‚&lt;/li>
&lt;li>è¯¥çº¿ç¨‹æ‰§è¡Œå®Œæ¯•è¢«åˆ†é…çš„æ—¶é—´åˆ†ç‰‡ï¼Œè¢«è¦æ±‚è®©å‡º CPU èµ„æºç­‰å¾…ä¸‹ä¸€æ¬¡è°ƒåº¦ã€‚&lt;/li>
&lt;/ol>
&lt;p>ksoftirqd çº¿ç¨‹è®¾ç½®çš„è°ƒåº¦ä¼˜å…ˆçº§å¾ˆä½ï¼ŒåŒæ ·å¯ä»¥é¿å…è½¯ä¸­æ–­è¾ƒå¤šæ—¶æŠ¢å è¿‡å¤šçš„ CPU èµ„æºã€‚&lt;/p>
&lt;h2 id="ç½‘ç»œå¸§çš„æ¥æ”¶">ç½‘ç»œå¸§çš„æ¥æ”¶&lt;/h2>
&lt;p>åœ¨ &lt;code>do_softirq&lt;/code> ä¸­ï¼Œå†…æ ¸é€šè¿‡æ‰§è¡Œ &lt;code>h-&amp;gt;action(h);&lt;/code> è°ƒç”¨è¯¥è½¯ä¸­æ–­ç±»å‹æ‰€æ³¨å†Œçš„å¤„ç†ç¨‹åºï¼Œæœ¬æ–‡ä»…å…³æ³¨ä¸æ¥æ”¶ç½‘ç»œå¸§ç›¸å…³çš„è½¯ä¸­æ–­å¤„ç†ç¨‹åºã€‚&lt;/p>
&lt;p>Linux çš„ç½‘ç»œç³»ç»Ÿä¸»è¦ä½¿ç”¨ä»¥ä¸‹ä¸¤ç§è½¯ä¸­æ–­ç±»å‹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>NET_RX_SOFTIRQ&lt;/strong> ç”¨äºå¤„ç†æ¥æ”¶ï¼ˆå…¥ç«™ï¼‰ç½‘ç»œæ•°æ®&lt;/li>
&lt;li>&lt;strong>NET_TX_SOFTIRQ&lt;/strong> ç”¨äºå¤„ç†å‘é€ï¼ˆå‡ºæ ˆï¼‰ç½‘ç»œæ•°æ®&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>NET_RX_SOFTIRQ&lt;/strong> è½¯ä¸­æ–­å¤„ç†ç¨‹åºæ¥æ”¶ç½‘ç»œå¸§çš„æ•´ä½“æµç¨‹ç¤ºæ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2022-04-21-netif-rx-action.png" alt="netif-rx-action">&lt;/p>
&lt;p>åœ¨äº†è§£å…·ä½“çš„è½¯ä¸­æ–­å¤„ç†ç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç»“åˆ Linux çš„å…·ä½“å®ç°é‡æ–°å›é¡¾ä¸Šæ–‡ä»‹ç»è¿‡çš„é€šçŸ¥å¤„ç†æœºåˆ¶ã€‚&lt;/p>
&lt;h3 id="linux-new-api-napi">Linux New API (NAPI)&lt;/h3>
&lt;p>ç½‘å¡è®¾å¤‡æ¯æ¥æ”¶åˆ°ä¸€ä¸ªäºŒå±‚çš„ç½‘ç»œå¸§åï¼Œä½¿ç”¨ç¡¬ä»¶ä¸­æ–­æ¥å‘ CPU å‘å‡ºä¿¡å·ï¼Œé€šçŸ¥å…¶æœ‰æ–°çš„å¸§éœ€è¦å¤„ç†ã€‚æ”¶åˆ°ä¸­æ–­çš„CPUä¼šæ‰§è¡Œ &lt;code>do_IRQ&lt;/code> å‡½æ•°ï¼Œè°ƒç”¨ä¸ç¡¬ä»¶ä¸­æ–­å·å…³è”çš„å¤„ç†ç¨‹åºã€‚å¤„ç†ç¨‹åºé€šå¸¸æ˜¯ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºåœ¨åˆå§‹åŒ–æ—¶æ³¨å†Œçš„ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªä¸­æ–­å¤„ç†ç¨‹åºå°†åœ¨ç¦ç”¨ä¸­æ–­æ¨¡å¼ä¸‹æ‰§è¡Œï¼Œä½¿å¾— CPU æš‚æ—¶åœæ­¢æ¥æ”¶ä¸­æ–­ä¿¡å·ã€‚
ä¸­æ–­å¤„ç†ç¨‹åºä¼šæ‰§è¡Œä¸€äº›å¿…è¦çš„å³æ—¶ä»»åŠ¡ï¼Œå¹¶å°†å…¶ä»–ä»»åŠ¡è°ƒåº¦åˆ°ä¸‹åŠéƒ¨ä¸­å»¶è¿Ÿæ‰§è¡Œã€‚åœ¨ Linux ä¸­ï¼Œå…·ä½“æ¥è¯´ä¸­æ–­å¤„ç†ç¨‹åºä¼šåšè¿™äº›äº‹æƒ…ï¼š&lt;/p>
&lt;ol>
&lt;li>å°†ç½‘ç»œå¸§å¤åˆ¶åˆ° &lt;code>sk_buff&lt;/code> æ•°æ®ç»“æ„ä¸­ã€‚&lt;/li>
&lt;li>åˆå§‹åŒ–ä¸€äº› &lt;code>sk_buff&lt;/code> çš„å‚æ•°ï¼Œä¾›ä¸Šå±‚çš„ç½‘ç»œæ ˆä½¿ç”¨ã€‚ç‰¹åˆ«æ˜¯ &lt;code>skb-&amp;gt;protocol&lt;/code>ï¼Œå®ƒæ ‡è¯†äº†ä¸Šå±‚çš„åè®®å¤„ç†ç¨‹åºã€‚&lt;/li>
&lt;li>æ›´æ–°å…¶ä»–çš„è®¾å¤‡ä¸“ç”¨å‚æ•°ã€‚&lt;/li>
&lt;li>é€šè¿‡è°ƒåº¦è½¯ä¸­æ–­ &lt;strong>NET_RX_SOFTIRQ&lt;/strong> æ¥é€šçŸ¥å†…æ ¸è¿›ä¸€æ­¥å¤„ç†æ¥æ”¶å¸§ã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬ä¸Šæ–‡ä»‹ç»è¿‡è½®è¯¢å’Œä¸­æ–­é€šçŸ¥æœºåˆ¶ï¼ˆåŒ…æ‹¬å‡ ç§æ”¹è‰¯ç‰ˆæœ¬ï¼‰ï¼Œå®ƒä»¬æœ‰ä¸åŒçš„ä¼˜ç¼ºç‚¹ï¼Œé€‚ç”¨ä¸åŒçš„å·¥ä½œåœºæ™¯ã€‚Linux åœ¨ Linux v2.6 å¼•å…¥äº†ä¸€ç§æ··åˆäº†è½®è¯¢å’Œä¸­æ–­çš„ NAPI æœºåˆ¶æ¥é€šçŸ¥å¹¶å¤„ç†æ–°çš„æ¥æ”¶å¸§ã€‚NAPI åœ¨é«˜è´Ÿè½½åœºæ™¯ä¸‹æœ‰è‰¯å¥½è¡¨ç°ï¼Œè¿˜èƒ½æ˜¾è‘—çš„èŠ‚çœ CPU èµ„æºã€‚æœ¬æ–‡å°†é‡ç‚¹ä»‹ç» NAPI æœºåˆ¶ã€‚&lt;/p>
&lt;p>å½“è®¾å¤‡é©±åŠ¨æ”¯æŒ NAPI æ—¶ï¼Œè®¾å¤‡åœ¨æ¥æ”¶åˆ°ç½‘ç»œå¸§åä¾ç„¶ä½¿ç”¨ä¸­æ–­é€šçŸ¥å†…æ ¸ï¼Œä½†å†…æ ¸åœ¨å¼€å§‹å¤„ç†ä¸­æ–­åå°†ç¦ç”¨æ¥è‡ªè¯¥è®¾å¤‡çš„ä¸­æ–­ï¼Œå¹¶æŒç»­åœ°é€šè¿‡è½®è¯¢æ–¹å¼ä»è®¾å¤‡çš„è¾“å…¥ç¼“å†²åŒºæå–æ¥æ”¶å¸§è¿›è¡Œå¤„ç†ï¼Œç›´åˆ°ç¼“å†²åŒºä¸ºç©ºæ—¶ï¼Œç»“æŸå¤„ç†ç¨‹åºçš„æ‰§è¡Œå¹¶é‡æ–°å¯ç”¨è¯¥è®¾å¤‡çš„ä¸­æ–­é€šçŸ¥ã€‚NAPI ç»“åˆäº†è½®è¯¢å’Œä¸­æ–­çš„ä¼˜ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>ç©ºé—²çŠ¶æ€ä¸‹ï¼Œå†…æ ¸æ—¢ä¸éœ€è¦æµªè´¹èµ„æºå»åšè½®è¯¢ï¼Œä¹Ÿèƒ½åœ¨è®¾å¤‡æ¥æ”¶åˆ°æ–°çš„ç½‘ç»œå¸§åç«‹åˆ»å¾—åˆ°é€šçŸ¥ã€‚&lt;/li>
&lt;li>å†…æ ¸è¢«é€šçŸ¥åœ¨è®¾å¤‡ç¼“å†²åŒºæœ‰å¾…å¤„ç†çš„æ•°æ®ä¹‹åï¼Œä¸éœ€è¦å†æµªè´¹èµ„æºå»å¤„ç†ä¸­æ–­ï¼Œç®€å•é€šè¿‡è½®è¯¢å»å¤„ç†è¿™äº›æ•°æ®å³å¯ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¯¹å†…æ ¸æ¥è¯´ï¼ŒNAPI æœ‰æ•ˆå‡å°‘äº†é«˜è´Ÿè½½ä¸‹éœ€è¦å¤„ç†çš„ä¸­æ–­æ•°é‡ï¼Œå› æ­¤é™ä½äº† CPU å ç”¨ï¼Œæ­¤å¤–é€šè¿‡è½®è¯¢åœ°æ–¹å¼å»è®¿é—®è®¾å¤‡ï¼Œä¹Ÿèƒ½å¤Ÿå‡å°‘è®¾å¤‡ä¹‹é—´çš„äº‰æŠ¢ã€‚&lt;/p>
&lt;p>å†…æ ¸é€šè¿‡ä»¥ä¸‹æ•°æ®ç»“æ„æ¥å®ç° NAPIï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>poll&lt;/code>ï¼šç”¨äºä»è®¾å¤‡çš„å…¥ç«™é˜Ÿåˆ—ä¸­å‡ºé˜Ÿç½‘ç»œå¸§çš„è™šæ‹Ÿå‡½æ•°ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„å…¥ç«™é˜Ÿåˆ—ã€‚&lt;/li>
&lt;li>&lt;code>poll_list&lt;/code>: ä¸€ä¸ªç»´æŠ¤å¤„äºè½®è¯¢ä¸­çŠ¶æ€è®¾å¤‡çš„é“¾è¡¨ã€‚å¤šä¸ªè®¾å¤‡å¯ä»¥å…±ç”¨åŒä¸€ä¸ªä¸­æ–­ä¿¡å·ï¼Œå› æ­¤å†…æ ¸éœ€è¦è½®è¯¢å¤šä¸ªè®¾å¤‡ã€‚åŠ å…¥åˆ°åˆ—è¡¨ä¹‹åæ¥è‡ªè¯¥è®¾å¤‡çš„ä¸­æ–­å°†è¢«ç¦ç”¨ã€‚&lt;/li>
&lt;li>&lt;code>quota&lt;/code> å’Œ &lt;code>weight&lt;/code>ï¼šå†…æ ¸é€šè¿‡è¿™ä¸¤ä¸ªå€¼æ¥æ§åˆ¶æ¯æ¬¡ä»è®¾å¤‡ä¸­å‡ºé˜Ÿæ•°æ®çš„æ•°é‡ï¼Œquota æ•°é‡è¶Šå°æ„å‘³ä¸åŒè®¾å¤‡çš„æ•°æ®å¸§æ›´æœ‰æœºä¼šå¾—åˆ°å…¬å¹³çš„å¤„ç†æœºä¼šï¼Œä½†å†…æ ¸ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´åœ¨è®¾å¤‡ä¹‹å‰åˆ‡æ¢ï¼Œåä¹‹ä¾ç„¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>å½“è®¾å¤‡å‘é€ä¸­æ–­ä¿¡å·ä¸”è¢«æ¥æ”¶ä¹‹åï¼Œå†…æ ¸æ‰§è¡Œè¯¥è®¾å¤‡é©±åŠ¨æ³¨å†Œçš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚ä¸­æ–­å¤„ç†ç¨‹åºå°†è°ƒç”¨ &lt;code>napi_schedule&lt;/code> æ¥è°ƒåº¦è½®è¯¢ç¨‹åºçš„æ‰§è¡Œã€‚åœ¨ &lt;code>napi_schedule&lt;/code> ä¸­ï¼Œå¦‚æœå‘é€ä¸­æ–­çš„è®¾å¤‡æœªåœ¨ CPU çš„ &lt;code>poll_list&lt;/code> ä¸­ï¼Œå†…æ ¸å°†å…¶åŠ å…¥åˆ° &lt;code>poll_list&lt;/code>ï¼Œå¹¶é€šè¿‡ &lt;code>__raise_softirq_irqoff&lt;/code> è§¦å‘ &lt;strong>NET_RX_SOFTIRQ&lt;/strong> è½¯ä¸­æ–­çš„è°ƒåº¦ã€‚å…¶ä¸»è¦é€»è¾‘ä½äº &lt;code>____napi_schedule&lt;/code> ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/* Called with irq disabled */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">____napi_schedule&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">softnet_data&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">napi_struct&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">napi&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_add_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">napi&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__raise_softirq_irqoff&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NET_RX_SOFTIRQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="è¾“å…¥é˜Ÿåˆ—">è¾“å…¥é˜Ÿåˆ—&lt;/h4>
&lt;p>æ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ªå­˜æ”¾æ¥æ”¶ç½‘ç»œå¸§çš„è¾“å…¥é˜Ÿåˆ— &lt;code>input_pkt_queue&lt;/code>ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä½äº &lt;code>softnet_data&lt;/code> ç»“æ„ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="n">softnet_data&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">output_queue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">Qdisc&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">output_queue_tailp&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">list_head&lt;/span> &lt;span class="n">poll_list&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">completion_queue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff_head&lt;/span> &lt;span class="n">process_queue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* stats */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">processed&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">time_squeeze&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">cpu_collision&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">received_rps&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="n">dropped&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff_head&lt;/span> &lt;span class="n">input_pkt_queue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">napi_struct&lt;/span> &lt;span class="n">backlog&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç½‘å¡è®¾å¤‡é©±åŠ¨éƒ½ä¼šä½¿ç”¨è¿™ä¸ªè¾“å…¥é˜Ÿåˆ—ï¼Œå¯¹äºä½¿ç”¨ NAPI æœºåˆ¶çš„ç½‘å¡ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„è¾“å…¥é˜Ÿåˆ—ã€‚è¿™ä¸ªè¾“å…¥é˜Ÿåˆ—å¯èƒ½ä½äºè®¾å¤‡å†…å­˜ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸»å†…å­˜ä¸­çš„æ¥æ”¶ç¯ã€‚&lt;/p>
&lt;h3 id="æ¥æ”¶å¸§è½¯ä¸­æ–­å¤„ç†ç¨‹åº">æ¥æ”¶å¸§è½¯ä¸­æ–­å¤„ç†ç¨‹åº&lt;/h3>
&lt;p>&lt;strong>NET_RX_SOFTIRQ&lt;/strong> çš„å¤„ç†ç¨‹åºæ˜¯ &lt;code>net_rx_action&lt;/code>ã€‚å…¶éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kt">void&lt;/span> &lt;span class="nf">net_rx_action&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">softirq_action&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">softnet_data&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">sd&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">__get_cpu_var&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">softnet_data&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">long&lt;/span> &lt;span class="n">time_limit&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">jiffies&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">budget&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">netdev_budget&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_irq_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">list_empty&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">napi_struct&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">work&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// If softirq window is exhuasted or has run for 2 jiffies then exit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unlikely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">budget&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">time_after&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">jiffies&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">time_limit&lt;/span>&lt;span class="p">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">softnet_break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// Acces current first entry in poll_list
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">list_first_entry&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">napi_struct&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">poll_list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">weight&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">weight&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">work&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">test_bit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NAPI_STATE_SCHED&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">state&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">work&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">trace_napi_poll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">budget&lt;/span> &lt;span class="o">-=&lt;/span> &lt;span class="n">work&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// remove device or move device to tail
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unlikely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">work&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">weight&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">unlikely&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">napi_disable_pending&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_irq_enable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">napi_complete&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">local_irq_disable&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_move_tail&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">poll_list&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nl">out&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">net_rps_action_and_irq_enable&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">sd&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// schedule again before exit
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="nl">softnet_break&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sd&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">time_squeeze&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__raise_softirq_irqoff&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NET_RX_SOFTIRQ&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">goto&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“ &lt;code>net_rx_action&lt;/code> è¢«è°ƒåº¦æ‰§è¡Œåï¼š&lt;/p>
&lt;ol>
&lt;li>ä»å¤´å¼€å§‹éå† &lt;code>poll_list&lt;/code> é“¾è¡¨ä¸­çš„è®¾å¤‡ï¼Œè°ƒç”¨è®¾å¤‡çš„ &lt;code>poll&lt;/code> è™šæ‹Ÿå‡½æ•°å¤„ç†å…¥ç«™é˜Ÿåˆ—ä¸­çš„æ•°æ®å¸§ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä»‹ç»è¯¥è™šæ‹Ÿå‡½æ•°ã€‚&lt;/li>
&lt;li>poll è¢«è°ƒç”¨æ—¶æ‰€å¤„ç†çš„æ•°æ®å¸§æ•°é‡åˆ°è¾¾æœ€å¤§é˜ˆå€¼åï¼Œå³ä½¿è¯¥è®¾å¤‡çš„å…¥ç«™é˜Ÿåˆ—è¿˜æœªè¢«æ¸…ç©ºï¼Œä¹Ÿä¼šå°†è¯¥è®¾å¤‡ç§»åŠ¨åˆ° &lt;code>poll_list&lt;/code> çš„å°¾éƒ¨ï¼Œè½¬è€Œå»å¤„ç† &lt;code>poll_list&lt;/code> ä¸­çš„ä¸‹ä¸€ä¸ªè®¾å¤‡ã€‚&lt;/li>
&lt;li>å¦‚æœè®¾å¤‡çš„å…¥ç«™é˜Ÿåˆ—è¢«æ¸…ç©ºï¼Œè°ƒç”¨ &lt;code>napi_complete&lt;/code> å°†è®¾å¤‡ç§»å‡º &lt;code>poll_list&lt;/code> å¹¶å¼€å¯è¯¥è®¾å¤‡çš„ä¸­æ–­é€šçŸ¥ã€‚&lt;/li>
&lt;li>ä¸€ç›´æ‰§è¡Œè¯¥æµç¨‹ç›´åˆ° &lt;code>poll_list&lt;/code> è¢«æ¸…ç©ºï¼Œæˆ–è€… &lt;code>net_rx_action&lt;/code> æ‰§è¡Œå®Œäº†è¶³å¤Ÿçš„æ—¶é—´ç‰‡ï¼ˆä¸ºäº†ä¸è¿‡å¤šå ç”¨ CPU èµ„æºï¼‰ï¼Œè¿™ç§æƒ…å†µé€€å‡ºå‰ &lt;code>net_rx_action&lt;/code> ä¼šé‡æ–°è°ƒåº¦è‡ªå·±çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="poll-è™šæ‹Ÿå‡½æ•°">Poll è™šæ‹Ÿå‡½æ•°&lt;/h3>
&lt;p>åœ¨è®¾å¤‡é©±åŠ¨çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè®¾å¤‡ä¼šå°† &lt;code>dev-&amp;gt;poll&lt;/code> æŒ‡å‘ç”±é©±åŠ¨æä¾›çš„è‡ªå®šä¹‰å‡½æ•°ï¼Œå› æ­¤ä¸åŒé©±åŠ¨ä¼šä½¿ç”¨ä¸åŒçš„ poll å‡½æ•°ã€‚æˆ‘ä»¬å°†ä»‹ç»ç”± Linux æä¾›çš„é»˜è®¤ poll å‡½æ•° &lt;code>process_backlog&lt;/code>ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼ä¸å¤§å¤šæ•°é©±åŠ¨çš„ poll å‡½æ•°ç›¸ä¼¼ï¼Œå…¶ä¸»è¦çš„åŒºåˆ«åœ¨äºï¼Œ&lt;code>process_backlog&lt;/code> å·¥ä½œæ—¶ä¸ä¼šç¦ç”¨ä¸­æ–­ï¼Œç”±äºé NAPI è®¾å¤‡ä½¿ç”¨ä¸€ä¸ªå…±äº«çš„è¾“å…¥é˜Ÿåˆ—ï¼Œå› æ­¤ä»è¾“å…¥é˜Ÿåˆ—ä¸­å‡ºæ ˆæ•°æ®å¸§æ—¶éœ€è¦ä¸´æ—¶ç¦ç”¨ä¸­æ–­ä»¥å®ç°åŠ é”ï¼›è€Œ NAPI è®¾å¤‡ä½¿ç”¨å•ç‹¬çš„å…¥ç«™é˜Ÿåˆ—ï¼Œä¸”åŠ å…¥ &lt;code>poll_list&lt;/code> çš„è®¾å¤‡ä¼šè¢«å•ç‹¬ç¦ç”¨ä¸­æ–­ï¼Œå› æ­¤åœ¨ poll æ—¶ä¸éœ€è¦è€ƒè™‘åŠ é”çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>&lt;code>process_backlog&lt;/code> æ‰§è¡Œæ—¶ï¼Œé¦–å…ˆè®¡ç®—å‡ºè¯¥è®¾å¤‡çš„ quotaã€‚ç„¶åè¿›å…¥ä¸‹é¢çš„å¾ªç¯æµç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>ç¦ç”¨ä¸­æ–­ï¼Œä»è¯¥ CPU å…³è”çš„è¾“å…¥é˜Ÿåˆ—ä¸­å‡ºæ ˆæ•°æ®å¸§ï¼Œç„¶åé‡æ–°å¯ç”¨ä¸­æ–­ã€‚&lt;/li>
&lt;li>å¦‚æœå‡ºæ ˆæ—¶å‘ç°è¾“å…¥é˜Ÿåˆ—å·²ç©ºï¼Œåˆ™å°†è¯¥è®¾å¤‡ç§»å‡º &lt;code>poll_list&lt;/code>ï¼Œå¹¶ç»“æŸæ‰§è¡Œã€‚&lt;/li>
&lt;li>å¦‚æœè¾“å…¥é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œè°ƒç”¨ &lt;code>netif_receive_skb(skb)&lt;/code> å¤„ç†è¢«å‡ºæ ˆçš„æ•°æ®å¸§ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä»‹ç»è¯¥å‡½æ•°ã€‚&lt;/li>
&lt;li>æ£€æŸ¥ä»¥ä¸‹æ¡ä»¶ï¼Œå¦‚æœæœªæ»¡è¶³æ¡ä»¶åˆ™è·³è½¬åˆ°æ­¥éª¤ 1 ç»§ç»­å¾ªç¯ï¼š
&lt;ol>
&lt;li>å¦‚æœå·²å‡ºæ ˆçš„æ•°æ®å¸§æ•°é‡è¾¾åˆ°è¯¥è®¾å¤‡çš„ quota å€¼ï¼Œç»“æŸæ‰§è¡Œã€‚&lt;/li>
&lt;li>å¦‚æœå·²æ‰§è¡Œå®Œäº†è¶³å¤Ÿçš„ CPU æ—¶é—´ç‰‡ï¼Œç»“æŸæ‰§è¡Œã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;/ol>
&lt;h3 id="å¤„ç†æ¥æ”¶å¸§">å¤„ç†æ¥æ”¶å¸§&lt;/h3>
&lt;p>&lt;code>netif_receive_skb&lt;/code> æ˜¯ poll è™šæ‹Ÿå‡½æ•°ç”¨äºå¤„ç†æ¥æ”¶å¸§çš„å·¥å…·å‡½æ•°ï¼Œå®ƒä¸»è¦è°ƒç”¨äº† &lt;code>__netif_receive_skb(skb);&lt;/code> å¯¹æ•°æ®å¸§ä¾æ¬¡è¿›è¡Œä¸€ç³»åˆ—å¤„ç†å·¥ä½œï¼š&lt;/p>
&lt;ol>
&lt;li>å¤„ç†æ•°æ®å¸§çš„ bond åŠŸèƒ½ã€‚Linux èƒ½å¤Ÿå°†ä¸€ç»„è®¾å¤‡èšåˆæˆä¸€ä¸ª bond è®¾å¤‡ï¼Œæ•°æ®å¸§åœ¨è¿›å…¥ä¸‰å±‚å¤„ç†ä¹‹å‰ï¼Œä¼šåœ¨æ­¤å°†å…¶æ¥æ”¶è®¾å¤‡ &lt;code>skb-&amp;gt;dev&lt;/code> æ›´æ”¹ä¸º bond ä¸­çš„ä¸»è®¾å¤‡ã€‚&lt;/li>
&lt;li>ä¼ é€’ä¸€ä»½æ•°æ®å¸§å‰¯æœ¬ç»™å·²æ³¨å†Œçš„å„ä¸ªåè®®çš„å—…æ¢ç¨‹åºã€‚&lt;/li>
&lt;li>å¤„ç†ä¸€äº›éœ€è¦åœ¨äºŒå±‚å®Œæˆçš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬æ¡¥æ¥ã€‚å¦‚æœæ•°æ®å¸§ä¸éœ€è¦æ¡¥æ¥ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚&lt;/li>
&lt;li>ä¼ é€’ä¸€ä»½æ•°æ®å¸§å‰¯æœ¬ç»™ &lt;code>skb-&amp;gt;protocol&lt;/code> å¯¹åº”çš„ä¸”å·²æ³¨å†Œçš„ä¸‰å±‚åè®®å¤„ç†ç¨‹åºã€‚è‡³æ­¤æ•°æ®å¸§è¿›å…¥å†…æ ¸ç½‘ç»œæ ˆçš„æ›´ä¸Šå±‚ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„åè®®å¤„ç†ç¨‹åºæˆ–è€…æœªè¢«æ¡¥æ¥ç­‰åŠŸèƒ½æ¶ˆè´¹ï¼Œæ•°æ®å¸§å°†è¢«å†…æ ¸ä¸¢å¼ƒã€‚&lt;/p>
&lt;p>é€šå¸¸æ¥è¯´ï¼Œä¸‰å±‚åè®®å¤„ç†ç¨‹åºä¼šå¯¹æ•°æ®å¸§ä½œå¦‚ä¸‹å¤„ç†ï¼š&lt;/p>
&lt;ul>
&lt;li>å°†å®ƒä»¬ä¼ é€’ç»™ç½‘ç»œåè®®æ ˆä¸­æ›´ä¸Šå±‚çš„åè®®å¦‚ TCP, UDP, ICMPï¼Œæœ€åä¼ é€’ç»™åº”ç”¨è¿›ç¨‹ã€‚&lt;/li>
&lt;li>åœ¨ netfilter ç­‰æ•°æ®å¸§å¤„ç†æ¡†æ¶ä¸­è¢«ä¸¢å¼ƒã€‚&lt;/li>
&lt;li>å¦‚æœæ•°æ®å¸§çš„ç›®çš„åœ°ä¸æ˜¯æœ¬åœ°ä¸»æœºï¼Œå°†è¢«è½¬å‘åˆ°å…¶ä»–æœºå™¨ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯¹ Linux å¦‚ä½•æ¥æ”¶ç½‘ç»œå¸§çš„è®¨è®ºåˆ°æ­¤ç»“æŸï¼Œå¦‚æœå¯¹æ•°æ®å¸§åœ¨ä¸‰å±‚ç½‘ç»œæ ˆçš„å¤„ç†æµç¨‹æ„Ÿå…´è¶£ï¼Œå¯æŸ¥çœ‹ä½œè€…çš„å¦ä¸€ç¯‡æ–‡ç«  &lt;a href="https://www.waynerv.com/posts/understanding-netfilter-and-iptables/">æ·±å…¥ç†è§£ netfilter å’Œ iptables&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>Understanding Linux network internals-Christian Benvenuti -O'Reilly Media&lt;/li>
&lt;li>Linux å†…æ ¸æ·±åº¦è§£æ - ä½™åå…µ&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/networking/" term="Networking" label="Networking"/></entry><entry><title type="text">ä¸º Kubernetes é›†ç¾¤å¯ç”¨ Pod å®‰å…¨ç­–ç•¥</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/enable-pod-security-policy-for-cluster/"/><id>https://waynerv.com/posts/enable-pod-security-policy-for-cluster/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-03-30T18:13:13+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æœ€è¿‘æœ‰å®¢æˆ·åé¦ˆåœ¨å¼€å¯äº†å®‰å…¨ç­–ç•¥çš„é›†ç¾¤ä¸­éƒ¨ç½²äº§å“å¤±è´¥ï¼Œå› æ­¤ç ”ç©¶äº†ä¸€ä¸‹ Kubernetes çš„ pod å®‰å…¨ç­–ç•¥ã€‚</summary><content type="html">&lt;p>æœ€è¿‘æœ‰å®¢æˆ·åé¦ˆåœ¨å¼€å¯äº†å®‰å…¨ç­–ç•¥çš„é›†ç¾¤ä¸­éƒ¨ç½²äº§å“å¤±è´¥ï¼Œå› æ­¤ç ”ç©¶äº†ä¸€ä¸‹ Kubernetes æä¾›çš„ pod å®‰å…¨ç­–ç•¥ã€‚&lt;/p>
&lt;p>æ–‡ä¸­çš„æ¼”ç¤ºå’Œç¤ºä¾‹å‡åœ¨ v1.18.17 é›†ç¾¤ä¸­é€šè¿‡éªŒè¯ã€‚&lt;/p>
&lt;h2 id="pod-security-policies">Pod Security Policies&lt;/h2>
&lt;p>&lt;strong>Pod Security Policies&lt;/strong> ï¼ˆä¸‹æ–‡ç®€ç§° psp æˆ– pod å®‰å…¨ç­–ç•¥ï¼‰æ˜¯ä¸€ç§é›†ç¾¤çº§åˆ«çš„å…¨å±€èµ„æºï¼Œèƒ½å¤Ÿå¯¹ pod çš„åˆ›å»ºå’Œæ›´æ–°è¿›è¡Œç»†ç²’åº¦çš„æˆæƒæ§åˆ¶ã€‚å…·ä½“æ¥è¯´ï¼Œä¸€ä¸ª psp å¯¹è±¡å®šä¹‰äº†ä¸€ç»„å®‰å…¨æ€§æ¡ä»¶ï¼Œä¸€ä¸ª pod çš„ spec å­—æ®µå¿…é¡»æ»¡è¶³è¿™äº›æ¡ä»¶ä»¥åŠé€‚ç”¨ç›¸å…³å­—æ®µçš„é»˜è®¤å€¼ï¼Œå…¶åˆ›å»ºæˆ–æ›´æ–°è¯·æ±‚æ‰ä¼šè¢« apiserver æ‰€æ¥å—ã€‚&lt;/p>
&lt;p>å…·ä½“çš„ pod å­—æ®µå’Œå®‰å…¨æ¡ä»¶å¯è§æ–‡æ¡£ &lt;a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#what-is-a-pod-security-policy">what-is-a-pod-security-policy&lt;/a> ã€‚&lt;/p>
&lt;h3 id="å¯ç”¨-pod-security-policies">å¯ç”¨ Pod Security Policies&lt;/h3>
&lt;p>Kubernetes é»˜è®¤ä¸å¼€å¯ pod å®‰å…¨ç­–ç•¥åŠŸèƒ½ï¼Œåœ¨é›†ç¾¤ä¸­å¯ç”¨ pod å®‰å…¨ç­–ç•¥çš„æ­¥éª¤å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰æ­¥ï¼š&lt;/p>
&lt;ol>
&lt;li>åœ¨é›†ç¾¤ä¸­åˆ›å»ºæŒ‡å®šçš„å®‰å…¨ç­–ç•¥èµ„æºã€‚&lt;/li>
&lt;li>é€šè¿‡ RBAC æœºåˆ¶æˆäºˆ&lt;strong>åˆ›å»º pod çš„ user&lt;/strong> æˆ–è€…&lt;strong>è¢«åˆ›å»º pod çš„ service account&lt;/strong> ä½¿ç”¨å®‰å…¨ç­–ç•¥èµ„æºçš„æƒé™ï¼Œé€šå¸¸ä¼šå°†ä½¿ç”¨æƒé™æˆäºˆä¸€ç»„ users æˆ– service accountsã€‚&lt;/li>
&lt;li>å¯ç”¨ apiserver çš„ admission-controller æ’ä»¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ³¨æ„æ­¥éª¤ 1ã€2 å¯ä»¥å•ç‹¬æ‰§è¡Œï¼Œå› ä¸ºå®ƒä»¬ä¸ä¼šå¯¹é›†ç¾¤äº§ç”Ÿå®é™…å½±å“ï¼Œä½†éœ€è¦ç¡®ä¿æ­¥éª¤ 3 åœ¨å‰ä¸¤æ­¥ä¹‹åæ‰§è¡Œã€‚&lt;/p>
&lt;p>å› ä¸ºä¸€æ—¦å¯ç”¨ admission-controller æ’ä»¶ï¼Œapiserver ä¼šå¯¹æ‰€æœ‰çš„ pod åˆ›å»º/æ›´æ–°è¯·æ±‚å¼ºåˆ¶æ‰§è¡Œå®‰å…¨ç­–ç•¥æ£€æŸ¥ï¼Œå¦‚æœé›†ç¾¤ä¸­æ²¡æœ‰å¯ç”¨çš„ pod å®‰å…¨ç­–ç•¥èµ„æºæˆ–è€…æœªå¯¹å®‰å…¨ç­–ç•¥èµ„æºé¢„å…ˆæˆæƒï¼Œæ‰€æœ‰çš„ pod åˆ›å»º/æ›´æ–°è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ã€‚åŒ…æ‹¬ kube-system å‘½åç©ºé—´ä¸‹çš„ç³»ç»Ÿç®¡ç†ç»„ä»¶å¦‚ apiserver æœ¬èº«ï¼ˆç”±äº apiserver æ˜¯å— kubelet ç®¡ç†çš„é™æ€ podï¼Œå®é™…ä¸Šå®¹å™¨ä¾ç„¶ä¼šè¿è¡Œï¼‰ã€‚&lt;/p>
&lt;p>å¯ç”¨çš„æ•´ä½“æµç¨‹å¦‚ä¸‹ç¤ºæ„å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="2022-04-11-podsecuritypolicy-diagrams.png" alt="podsecuritypolicy">&lt;/p>
&lt;h4 id="åˆ›å»ºå®‰å…¨ç­–ç•¥èµ„æº">åˆ›å»ºå®‰å…¨ç­–ç•¥èµ„æº&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>åœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªå®½æ¾é™åˆ¶çš„ PodSecurityPolicy èµ„æºï¼Œå‘½åä¸º &lt;code>privileged&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">policy/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PodSecurityPolicy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">privileged&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seccomp.security.alpha.kubernetes.io/allowedProfileNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">privileged&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowPrivilegeEscalation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowedCapabilities&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;*&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostNetwork&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPorts&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">min&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">65535&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostIPC&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runAsUser&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;RunAsAny&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seLinux&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;RunAsAny&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">supplementalGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;RunAsAny&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fsGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;RunAsAny&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨é›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªä¸¥æ ¼é™åˆ¶çš„ PodSecurityPolicy èµ„æºï¼Œå‘½åä¸º &lt;code>restricted&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">policy/v1beta1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">PodSecurityPolicy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">annotations&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seccomp.security.alpha.kubernetes.io/allowedProfileNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;docker/default,runtime/default&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apparmor.security.beta.kubernetes.io/allowedProfileNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;runtime/default&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apparmor.security.beta.kubernetes.io/defaultProfileName&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;runtime/default&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">privileged&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Required to prevent escalations to root.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allowPrivilegeEscalation&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">requiredDropCapabilities&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ALL&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Allow core volume types.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">volumes&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;configMap&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;emptyDir&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;projected&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;secret&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;downwardAPI&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Assume that ephemeral CSI drivers &amp;amp; persistentVolumes set up by the cluster admin are safe to use.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;csi&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="s1">&amp;#39;persistentVolumeClaim&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostNetwork&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostIPC&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostPID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runAsUser&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Require the container to run without root privileges.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;MustRunAsNonRoot&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">seLinux&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># This policy assumes the nodes are using AppArmor rather than SELinux.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;RunAsAny&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">supplementalGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;MustRunAs&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ranges&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Forbid adding the root group.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">min&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">65535&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fsGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rule&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;MustRunAs&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">ranges&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># Forbid adding the root group.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">min&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">max&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">65535&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">readOnlyRootFilesystem&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">false&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h4 id="rbac-èº«ä»½è®¤è¯">RBAC èº«ä»½è®¤è¯&lt;/h4>
&lt;ol>
&lt;li>
&lt;p>åˆ†åˆ«åˆ›å»ºå¯è®¿é—®ä¸¤ç§å®‰å…¨ç­–ç•¥èµ„æºçš„ ClusterRoleï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">privileged-psp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;policy&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;podsecuritypolicies&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;use&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">privileged&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted-psp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">rules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">apiGroups&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;policy&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resources&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;podsecuritypolicies&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">verbs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;use&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">resourceNames&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">restricted&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡ ClusterRoleBinding ï¼ˆæˆ–è€… RoleBindingï¼‰å°†åˆ›å»ºçš„ ClusterRole ç»‘å®šåˆ°æŒ‡å®šå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ service accountï¼ˆä¹Ÿå¯ä»¥æˆæƒç»™æŒ‡å®šçš„ userï¼‰ã€‚&lt;/p>
&lt;p>åœ¨ Kubernetes ä¸­å¤§å¤šæ•° pod å¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨ user åˆ›å»ºçš„ï¼Œè€Œæ˜¯é€šå¸¸ä½œä¸º Deploymentã€ReplicaSet æˆ–å…¶ä»–æ¨¡æ¿ controller çš„å­èµ„æºï¼Œç”± controller é—´æ¥åˆ›å»ºã€‚æˆäºˆ controller ç”¨æˆ·å¯¹å®‰å…¨ç­–ç•¥çš„ä½¿ç”¨æƒç­‰åŒäºä¸ºè¯¥ controller åˆ›å»ºçš„æ‰€æœ‰ pod æˆäºˆä½¿ç”¨æƒï¼Œå› æ­¤æˆæƒçš„æ¨èåšæ³•æ˜¯æˆæƒç»™ç›®æ ‡ pod çš„ service accountã€‚&lt;/p>
&lt;p>ä¸ºäº†è¿›è¡Œåç»­çš„æµ‹è¯•ï¼Œæˆ‘ä»¬å°† &lt;code>privileged-psp&lt;/code> æˆæƒç»™ kubelet æ‰€ä½¿ç”¨çš„ &lt;code>system:nodes&lt;/code> ç”¨æˆ·å’Œ &lt;code>privileged-ns&lt;/code> å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ service accountï¼Œå°† &lt;code>restricted-psp&lt;/code> æˆæƒç»™ &lt;code>restricted-ns&lt;/code> å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ service accountï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">privileged-psp-bind&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">privileged-psp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># æˆæƒç»™æŒ‡å®šå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰ service accountï¼ˆæ¨èåšæ³•ï¼‰:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system:serviceaccounts:privileged-ns&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system:nodes&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kube-system&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRoleBinding&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted-psp-bind&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">roleRef&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterRole&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted-psp&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system:serviceaccounts:restricted-ns&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ &lt;code>subjects&lt;/code> å­—æ®µä¸‹æ·»åŠ æ›´å¤šè®°å½•è¿˜å¯ä»¥æˆæƒç»™æ‰€æœ‰çš„ service account æˆ–è€…æ‰€æœ‰å·²æˆæƒçš„ userï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">subjects&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># æˆæƒç»™æŒ‡å®šçš„ service account æˆ–è€…ç”¨æˆ·ï¼ˆä¸æ¨èï¼‰:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ServiceAccount&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;authorized service account name&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">namespace&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;authorized pod namespace&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">User&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;authorized user name&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># æˆæƒç»™æ‰€æœ‰çš„ service accounts:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system:serviceaccounts&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="c"># æˆæƒç»™æ‰€æœ‰å·²è®¤è¯çš„ç”¨æˆ·:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>- &lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Group&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiGroup&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">rbac.authorization.k8s.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">system:authenticated&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h4 id="å¯ç”¨-admission-controller-æ’ä»¶">å¯ç”¨ admission controller æ’ä»¶&lt;/h4>
&lt;p>åœ¨ apiserver å¯ç”¨ admission controller çš„ psp æ’ä»¶æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨å·²å­˜åœ¨çš„é›†ç¾¤ä¸­é€šè¿‡ä¿®æ”¹ apiserver çš„é™æ€ manifest æ–‡ä»¶ï¼Œä¸º apiserver å¢åŠ å¯åŠ¨å‚æ•° &lt;code>enable-admission-plugins=PodSecurityPolicy&lt;/code>ã€‚kubelet ä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å˜æ›´å¹¶é‡å¯ apiserverã€‚ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨ sed å¯¹åŸæœ‰å‚æ•°è¿›è¡Œäº†æ›¿æ¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sed -i &lt;span class="s1">&amp;#39;s/enable-admission-plugins=NodeRestriction/enable-admission-plugins=NodeRestriction,PodSecurityPolicy/&amp;#39;&lt;/span> /etc/kubernetes/manifests/kube-apiserver.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æˆ–è€…åœ¨åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œåœ¨ kubeadm é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é¢å¤–å‚æ•°ï¼ˆä¸æ¨èï¼Œé»˜è®¤ä¼šæ‹’ç»æ‰€æœ‰ pod çš„åˆ›å»ºï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">kubeadm.k8s.io/v1beta2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ClusterConfiguration&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">apiServer&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extraArgs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enable-admission-plugins&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;PodSecurityPolicy&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="éªŒè¯-psp-çš„å®‰å…¨é™åˆ¶">éªŒè¯ psp çš„å®‰å…¨é™åˆ¶&lt;/h3>
&lt;p>æ¥ä¸‹åˆ†åˆ«åœ¨ä¸Šæ–‡æˆæƒè¿‡çš„ &lt;code>privileged-ns&lt;/code> å’Œ &lt;code>restricted-ns&lt;/code> å‘½åç©ºé—´è¿›è¡Œæµ‹è¯•ï¼ŒéªŒè¯ psp å¯¹ pod è¯·æ±‚çš„é™åˆ¶ã€‚&lt;/p>
&lt;p>é¦–å…ˆå°è¯•åœ¨ &lt;code>restricted-ns&lt;/code> å‘½åç©ºé—´é€šè¿‡ deployment åˆ›å»ºä¸€ä¸ªéœ€è¦ä½¿ç”¨ &lt;code>hostNetwork&lt;/code> çš„ podï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">apps/v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx-hostnetwork&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">selector&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">matchLabels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">template&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">spec&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hostNetwork&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">containers&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">image&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">imagePullPolicy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Always&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">nginx-privileged&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ›å»ºå¹¶æŸ¥çœ‹ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl create -f hostnetwork-pod.yaml -n restricted-ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/nginx-hostnetwork created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get deploy -n restricted-ns nginx-hostnetwork
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-hostnetwork 0/1 &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> 21s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl -n restricted-ns get event &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;pod security policy&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">103s Warning FailedCreate deployment/nginx-hostnetwork Error creating: pods &lt;span class="s2">&amp;#34;nginx-hostnetwork-&amp;#34;&lt;/span> is forbidden: unable to validate against any pod security policy: &lt;span class="o">[&lt;/span>spec.securityContext.hostNetwork: Invalid value: true: Host network is not allowed to be used&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”±äºæˆæƒç»™è¯¥å‘½åç©ºé—´ service account çš„å®‰å…¨ç­–ç•¥èµ„æºç¦æ­¢ pod ä½¿ç”¨ hostNetworkï¼Œå› æ­¤è¯¥ deployment åˆ›å»º pod çš„è¯·æ±‚è¢«æ‹’ç»ã€‚&lt;/p>
&lt;p>æ¥ç€åœ¨ &lt;code>privileged-ns&lt;/code> å‘½åç©ºé—´æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ kubectl create -f deploy.yaml -n privileged-ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">deployment.apps/nginx-hostnetwork created
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get deploy -n privileged-ns nginx-hostnetwork
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY UP-TO-DATE AVAILABLE AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-hostnetwork 1/1 &lt;span class="m">1&lt;/span> &lt;span class="m">1&lt;/span> 34s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get po -n privileged-ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME READY STATUS RESTARTS AGE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx-hostnetwork-644cdd6598-twds9 0/1 Error &lt;span class="m">3&lt;/span> 77s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ kubectl get pod nginx-hostnetwork-644cdd6598-twds9 -o &lt;span class="nv">jsonpath&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;{.metadata.annotations}&amp;#39;&lt;/span> -n privileged-ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">map&lt;span class="o">[&lt;/span>kubernetes.io/psp:privileged&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆæƒç»™è¯¥å‘½åç©ºé—´ service account çš„å®‰å…¨ç­–ç•¥èµ„æºå…è®¸ pod ä½¿ç”¨ hostNetworkï¼Œå› æ­¤ pod æˆåŠŸè¢«åˆ›å»ºã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ pod çš„ &lt;code>metadata.annotations&lt;/code> å­—æ®µæ£€æŸ¥å…¶é€‚ç”¨çš„å®‰å…¨ç­–ç•¥èµ„æºã€‚&lt;/p>
&lt;h2 id="pod-security-admission">Pod Security Admission&lt;/h2>
&lt;p>ä» Kubernetes v1.21å¼€å§‹ï¼ŒPod Security Policy å°†è¢«å¼ƒç”¨ï¼Œå¹¶å°†åœ¨ v1.25 ä¸­åˆ é™¤ï¼ŒKubernetes åœ¨ 1.22 ç‰ˆæœ¬å¼•å…¥äº† Pod Security Admission ä½œä¸ºå…¶æ›¿ä»£è€…ã€‚&lt;/p>
&lt;h3 id="ä¸ºä»€ä¹ˆè¦æ›¿æ¢-psp">ä¸ºä»€ä¹ˆè¦æ›¿æ¢ psp&lt;/h3>
&lt;p>&lt;a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-auth/2579-psp-replacement">KEP-2579&lt;/a> è¯¦ç»†é˜è¿°äº†å¼•å…¥ Pod Security Admission æ›¿ä»£ Pod Security Policy çš„ä¸‰ç‚¹ä¸»è¦ç†ç”±ï¼š&lt;/p>
&lt;ol>
&lt;li>å°†ç­–ç•¥ä¸ç”¨æˆ·æˆ– service account ç»‘å®šçš„æ¨¡å‹å‰Šå¼±äº†å®‰å…¨æ€§ã€‚&lt;/li>
&lt;li>åŠŸèƒ½æ— æ³•æµç•…åˆ‡æ¢ï¼Œåœ¨æ²¡æœ‰å®‰å…¨ç­–ç•¥èµ„æºçš„æƒ…å†µä¸‹æ— æ³•å…³é—­æ£€æŸ¥ã€‚&lt;/li>
&lt;li>API ä¸ä¸€è‡´ä¸”ç¼ºä¹çµæ´»æ€§ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ–°çš„ Pod Security Admission æœºåˆ¶åœ¨æ˜“ç”¨æ€§å’Œçµæ´»æ€§ä¸Šéƒ½æœ‰äº†å¾ˆå¤§æå‡ï¼Œä»ä½¿ç”¨è§’åº¦æœ‰ä»¥ä¸‹å››ç‚¹æ˜¾è‘—ä¸åŒï¼š&lt;/p>
&lt;ol>
&lt;li>å¯ä»¥åœ¨é›†ç¾¤ä¸­é»˜è®¤å¼€å¯ï¼Œåªè¦ä¸è®¾ç½®çº¦æŸæ¡ä»¶å°±ä¸ä¼šè§¦å‘å¯¹ pod çš„æ ¡éªŒã€‚&lt;/li>
&lt;li>åªåœ¨å‘½åç©ºé—´çº§åˆ«ç”Ÿæ•ˆï¼Œå¯ä»¥ä¸ºä¸åŒå‘½åç©ºé—´é€šè¿‡æ·»åŠ æ ‡ç­¾çš„æ–¹å¼è®¾ç½®ä¸åŒçš„å®‰å…¨é™åˆ¶ã€‚&lt;/li>
&lt;li>å¯ä»¥ä¸ºç‰¹å®šçš„ç”¨æˆ·ã€å‘½åç©ºé—´æˆ–è€…è¿è¡Œæ—¶è®¾ç½®è±å…è§„åˆ™ã€‚&lt;/li>
&lt;li>æ ¹æ®å®è·µé¢„è®¾äº†ä¸‰ç§å®‰å…¨ç­‰çº§ï¼Œä¸éœ€è¦ç”±ç”¨æˆ·å•ç‹¬å»è®¾ç½®æ¯ä¸€é¡¹å®‰å…¨æ¡ä»¶ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="å·¥ä½œæ–¹å¼">å·¥ä½œæ–¹å¼&lt;/h3>
&lt;p>Pod Security Admission å°†åŸæ¥ Pod Security Policy çš„å®‰å…¨æ¡ä»¶åˆ’åˆ†æˆä¸‰ç§é¢„è®¾çš„å®‰å…¨ç­‰çº§ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>privileged&lt;/code>: ä¸å—é™ï¼Œå‘ pod æä¾›æ‰€æœ‰å¯ç”¨çš„æƒé™ã€‚&lt;/li>
&lt;li>&lt;code>baseline&lt;/code>ï¼šæœ€ä½é™åº¦çš„é™åˆ¶ç­–ç•¥ï¼Œé˜²æ­¢å·²çŸ¥çš„ç‰¹æƒå‡çº§ã€‚&lt;/li>
&lt;li>&lt;code>restricted&lt;/code>ï¼šä¸¥æ ¼é™åˆ¶ç­–ç•¥ï¼Œéµå¾ªå½“å‰ Pod åŠ å›ºçš„æœ€ä½³å®è·µã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸‰ç§ç­‰çº§ä»å®½æ¾åˆ°ä¸¥æ ¼é€’å¢ï¼Œå„è‡ªåŒ…å«äº†&lt;a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/#profile-details">ä¸åŒé™åº¦çš„å®‰å…¨æ¡ä»¶&lt;/a>ï¼Œé€‚ç”¨äºä¸åŒçš„ pod å·¥ä½œåœºæ™¯ã€‚æ­¤å¤–è¿˜å¯ä»¥å°†å®‰å…¨ç­‰çº§è®¾ç½®ä¸ºå›ºå®šçš„ Kubernetes ç‰ˆæœ¬ï¼Œè¿™æ ·å³ä½¿é›†ç¾¤å‡çº§åˆ°äº†æ–°çš„ç‰ˆæœ¬ä¸”æ–°ç‰ˆæœ¬çš„å®‰å…¨ç­‰çº§å®šä¹‰å‘ç”Ÿå˜åŒ–ï¼Œä¾ç„¶å¯ä»¥æŒ‰æ—§ç‰ˆæœ¬çš„å®‰å…¨æ¡ä»¶å¯¹ pod è¿›è¡Œæ£€éªŒã€‚&lt;/p>
&lt;p>å½“ pod ä¸å®‰å…¨ç­‰çº§å†²çªæ—¶ï¼Œæˆ‘ä»¬å¯é€šè¿‡ä¸‰ç§æ¨¡å¼æ¥é€‰æ‹©ä¸åŒçš„å¤„ç†æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>enforce&lt;/code>ï¼šåªå…è®¸ç¬¦åˆå®‰å…¨ç­‰çº§è¦æ±‚çš„ podï¼Œæ‹’ç»ä¸å®‰å…¨ç­‰çº§å†²çªçš„ podã€‚&lt;/li>
&lt;li>&lt;code>audit&lt;/code>ï¼šåªå°†å®‰å…¨ç­‰çº§å†²çªè®°å½•åœ¨é›†ç¾¤ event ä¸­ï¼Œä¸ä¼šæ‹’ç» podã€‚&lt;/li>
&lt;li>&lt;code>warn&lt;/code>ï¼šä¸å®‰å…¨ç­‰çº§å†²çªæ—¶ä¼šå‘ç”¨æˆ·è¿”å›ä¸€ä¸ªè­¦å‘Šä¿¡æ¯ï¼Œä½†ä¸ä¼šæ‹’ç» podã€‚&lt;/li>
&lt;/ul>
&lt;p>audit å’Œ warn æ¨¡å¼æ˜¯ç‹¬ç«‹çš„ï¼Œå¦‚æœåŒæ—¶éœ€è¦ä¸¤è€…çš„åŠŸèƒ½å¿…é¡»åˆ†åˆ«è®¾ç½®ä¸¤ç§æ¨¡å¼ã€‚&lt;/p>
&lt;p>åº”ç”¨å®‰å…¨ç­–ç•¥ä¸å†éœ€è¦åˆ›å»ºå•ç‹¬çš„é›†ç¾¤èµ„æºï¼Œåªéœ€åœ¨å¯ç”¨ Pod Security Admission åä¸ºå‘½åç©ºé—´è®¾ç½®å¦‚ä¸‹æ§åˆ¶æ ‡ç­¾ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">pod-security.kubernetes.io/&amp;lt;mode&amp;gt;&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;level&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">pod-security.kubernetes.io/&amp;lt;mode&amp;gt;-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;version&amp;gt;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åœ¨æ—§ç‰ˆæœ¬é›†ç¾¤ä¸­å¯ç”¨-psa">åœ¨æ—§ç‰ˆæœ¬é›†ç¾¤ä¸­å¯ç”¨ psa&lt;/h3>
&lt;p>è™½ç„¶ &lt;strong>Pod Security Admission&lt;/strong> æ˜¯ä¸€ä¸ªåœ¨ Kubernetes v1.22 å¼•å…¥çš„åŠŸèƒ½ï¼Œä½†æ—§ç‰ˆæœ¬å¯ä»¥é€šè¿‡å®‰è£… PodSecurityÂ admission webhook æ¥å¯ç”¨è¯¥åŠŸèƒ½ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">git clone https://github.com/kubernetes/pod-security-admission.git&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">cd pod-security-admission/webhook&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">make certs&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">kubectl apply -k .&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„æ­¥éª¤åœ¨ v1.18.17 é›†ç¾¤ä¸­æ‰§è¡Œæ—¶ä¼šæœ‰ä¸¤ä¸ªå…¼å®¹æ€§é—®é¢˜ï¼Œå…·ä½“é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>kubectl å†…ç½®çš„ kustomize ç‰ˆæœ¬ä¸æ”¯æŒ &amp;quot;replacements&amp;quot; å­—æ®µ:&lt;/p>
&lt;pre tabindex="0">&lt;code>$ kubectl apply -k .
error: json: unknown field &amp;#34;replacements&amp;#34;
&lt;/code>&lt;/pre>&lt;p>è§£å†³æ–¹æ¡ˆï¼šå®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ kusomize ç„¶ååœ¨åŒä¸€ç›®å½•æ‰§è¡Œ&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">$ kustomize build . | kubectl apply -f -&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>manifest/50-deployment.yaml&lt;/code> æ–‡ä»¶ä¸­å®šä¹‰çš„ &lt;code>Deployment.spec.template.spec.containers[0].securityContext&lt;/code> å­—æ®µåœ¨ v1.19 ç‰ˆæœ¬æ‰å¼€å§‹å¼•å…¥ï¼Œå› æ­¤ v1.18 éœ€è¦å°†è¯¥å­—æ®µä¿®æ”¹ä¸ºå¯¹åº”çš„ annotation ç‰ˆæœ¬ï¼Œè¯¦è§ &lt;a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#seccomp">Seccomp&lt;/a>ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>error: error validating &amp;#34;STDIN&amp;#34;: error validating data: ValidationError(Deployment.spec.template.spec.containers[0].securityContext): unknown field &amp;#34;seccompProfile&amp;#34; in io.k8s.api.core.v1.SecurityContext; if you choose to ignore these errors, turn validation off with --validate=false
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ol>
&lt;h3 id="éªŒè¯-psa-çš„å®‰å…¨é™åˆ¶">éªŒè¯ psa çš„å®‰å…¨é™åˆ¶&lt;/h3>
&lt;p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ &lt;code>psa-test&lt;/code> ç”¨äºæµ‹è¯•ï¼Œå¹¶å°†å…¶å®šä¹‰å¼ºåˆ¶åº”ç”¨ &lt;code>baseline&lt;/code> å®‰å…¨ç­‰çº§ï¼Œå¹¶å¯¹ &lt;code>restricted&lt;/code> ç­‰çº§è¿›è¡Œè­¦å‘Šå’Œå®¡è®¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">apiVersion&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">kind&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Namespace&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">metadata&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">psa-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">labels&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/enforce&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">baseline&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/enforce-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1.18&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="c"># We are setting these to our _desired_ `enforce` level.&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/audit&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/audit-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1.18&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/warn&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">restricted&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">pod-security.kubernetes.io/warn-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v1.18&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ç€åœ¨è¯¥å‘½åç©ºé—´ä¸­åˆ›å»ºä¸Šæ–‡ç¤ºä¾‹ä¸­ç”¨è¿‡çš„ deploymentï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="l">$ kubectl create -f hostnetwork-pod.yaml -n psa-test&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">deployment.apps/nginx-hostnetwork created&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">$ kubectl get deploy -n psa-test nginx-hostnetwork&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">NAME READY UP-TO-DATE AVAILABLE AGE&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">nginx-hostnetwork 0/1 0 0 17s&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="l">$ kubectl -n psa-test get event | grep PodSecurity&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">104s Warning FailedCreate replicaset/nginx-hostnetwork-644cdd6598 Error creating&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">admission webhook &amp;#34;pod-security-webhook.kubernetes.io&amp;#34; denied the request: pods &amp;#34;nginx-hostnetwork-644cdd6598-7rb5m&amp;#34; is forbidden: violates PodSecurity &amp;#34;baseline:v1.23&amp;#34;: host namespaces (hostNetwork=true)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ psp çš„ç¤ºä¾‹ç›¸æ¯”ï¼Œpsa å®ç°äº†åŸºæœ¬ä¸€è‡´çš„å®‰å…¨æ£€æŸ¥ç»“æœï¼Œä½†æ˜“ç”¨ç¨‹åº¦æœ‰äº†å¾ˆå¤§æå‡ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-auth/2579-psp-replacement">KEP-2579: Pod Security Admission Control&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">Pod Security Admission | Kubernetes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/#profile-details">Pod Security Standards | Kubernetes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/coryodaniel/kubernetes-assigning-pod-security-policies-with-rbac-2ad2e847c754">Kubernetes: Assigning Pod Security Policies with RBAC&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://banzaicloud.com/blog/pod-security-policy/">An illustrated deepdive into Pod Security Policies Â· Banzai Cloud&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/kubernetes/" term="Kubernetes" label="Kubernetes"/><category scheme="https://waynerv.com/tags/%E5%AE%89%E5%85%A8/" term="å®‰å…¨" label="å®‰å…¨"/><category scheme="https://waynerv.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" term="äº‘åŸç”Ÿ" label="äº‘åŸç”Ÿ"/></entry><entry><title type="text">æ·±å…¥ç†è§£ netfilter å’Œ iptables</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/understanding-netfilter-and-iptables/"/><id>https://waynerv.com/posts/understanding-netfilter-and-iptables/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2022-03-07T23:27:11+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">Netfilter é…åˆ iptables ä½¿å¾—åº”ç”¨å¯ä»¥æ“ä½œå†…æ ¸ç½‘ç»œæ ˆçš„æ•°æ®åŒ…å¤„ç†è§„åˆ™ï¼Œå®ç°é«˜æ•ˆçš„ç½‘ç»œè½¬å‘å’Œè¿‡æ»¤ã€‚å¾ˆå¤šå¸¸è§çš„ä¸»æœºé˜²ç«å¢™ç¨‹åºä»¥åŠ Kubernetes çš„ Service è½¬å‘éƒ½æ˜¯é€šè¿‡ iptables æ¥å®ç°çš„ã€‚</summary><content type="html">&lt;p>Netfilter ï¼ˆé…åˆ iptablesï¼‰ä½¿å¾—ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºå¯ä»¥æ³¨å†Œå†…æ ¸ç½‘ç»œæ ˆåœ¨å¤„ç†æ•°æ®åŒ…æ—¶åº”ç”¨çš„å¤„ç†è§„åˆ™ï¼Œå®ç°é«˜æ•ˆçš„ç½‘ç»œè½¬å‘å’Œè¿‡æ»¤ã€‚å¾ˆå¤šå¸¸è§çš„ä¸»æœºé˜²ç«å¢™ç¨‹åºä»¥åŠ Kubernetes çš„ Service è½¬å‘éƒ½æ˜¯é€šè¿‡ iptables æ¥å®ç°çš„ã€‚&lt;/p>
&lt;p>å…³äº netfilter çš„ä»‹ç»æ–‡ç« å¤§éƒ¨åˆ†åªæè¿°äº†æŠ½è±¡çš„æ¦‚å¿µï¼Œå®é™…ä¸Šå…¶å†…æ ¸ä»£ç çš„åŸºæœ¬å®ç°ä¸ç®—å¤æ‚ï¼Œæœ¬æ–‡ä¸»è¦å‚è€ƒ Linux å†…æ ¸ 2.6 ç‰ˆæœ¬ä»£ç ï¼ˆæ—©æœŸç‰ˆæœ¬è¾ƒä¸ºç®€å•ï¼‰ï¼Œä¸æœ€æ–°çš„ 5.x ç‰ˆæœ¬åœ¨å®ç°ä¸Šå¯èƒ½æœ‰è¾ƒå¤§å·®å¼‚ï¼Œä½†åŸºæœ¬è®¾è®¡å˜åŒ–ä¸å¤§ï¼Œä¸å½±å“ç†è§£å…¶åŸç†ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å‡è®¾è¯»è€…å·²å¯¹ TCP/IP åè®®æœ‰åŸºæœ¬äº†è§£ã€‚&lt;/p>
&lt;h2 id="netfilter-çš„è®¾è®¡ä¸å®ç°">Netfilter çš„è®¾è®¡ä¸å®ç°&lt;/h2>
&lt;p>netfilter çš„å®šä¹‰æ˜¯ä¸€ä¸ªå·¥ä½œåœ¨ Linux å†…æ ¸çš„ç½‘ç»œæ•°æ®åŒ…å¤„ç†æ¡†æ¶ï¼Œä¸ºäº†å½»åº•ç†è§£ netfilter çš„å·¥ä½œæ–¹å¼ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¹æ•°æ®åŒ…åœ¨ Linux å†…æ ¸ä¸­çš„å¤„ç†è·¯å¾„å»ºç«‹åŸºæœ¬è®¤è¯†ã€‚&lt;/p>
&lt;h3 id="æ•°æ®åŒ…çš„å†…æ ¸ä¹‹æ—…">æ•°æ®åŒ…çš„å†…æ ¸ä¹‹æ—…&lt;/h3>
&lt;p>æ•°æ®åŒ…åœ¨å†…æ ¸ä¸­çš„å¤„ç†è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å¤„ç†ç½‘ç»œæ•°æ®åŒ…çš„å†…æ ¸ä»£ç è°ƒç”¨é“¾ï¼Œå¤§ä½“ä¸Šä¹Ÿå¯æŒ‰ TCP/IP æ¨¡å‹åˆ†ä¸ºå¤šä¸ªå±‚çº§ï¼Œä»¥æ¥æ”¶ä¸€ä¸ª IPv4 çš„ tcp æ•°æ®åŒ…ä¸ºä¾‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨ç‰©ç†-ç½‘ç»œè®¾å¤‡å±‚ï¼Œç½‘å¡é€šè¿‡ DMA å°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…å†™å…¥å†…å­˜ä¸­çš„ &lt;code>ring buffer&lt;/code>ï¼Œç»è¿‡ä¸€ç³»åˆ—ä¸­æ–­å’Œè°ƒåº¦åï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸è°ƒç”¨ &lt;code>__skb_dequeue&lt;/code> å°†æ•°æ®åŒ…åŠ å…¥å¯¹åº”è®¾å¤‡çš„å¤„ç†é˜Ÿåˆ—ä¸­ï¼Œå¹¶è½¬æ¢æˆ &lt;code>sk_buffer&lt;/code> ç±»å‹ï¼ˆå³ socket buffer - å°†åœ¨æ•´ä¸ªå†…æ ¸è°ƒç”¨æ ˆä¸­æŒç»­ä½œä¸ºå‚æ•°ä¼ é€’çš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œä¸‹æ–‡æŒ‡ç§°çš„æ•°æ®åŒ…éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ &lt;code>sk_buffer&lt;/code>ï¼‰ï¼Œæœ€åè°ƒç”¨ &lt;code>netif_receive_skb&lt;/code> å‡½æ•°æŒ‰åè®®ç±»å‹å¯¹æ•°æ®åŒ…è¿›è¡Œåˆ†ç±»ï¼Œå¹¶è·³è½¬åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-network-path.png" alt="network-path">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡è®¾è¯¥æ•°æ®åŒ…ä¸º IP åè®®åŒ…ï¼Œå¯¹åº”çš„æ¥æ”¶åŒ…å¤„ç†å‡½æ•° &lt;code>ip_rcv&lt;/code> å°†è¢«è°ƒç”¨ï¼Œæ•°æ®åŒ…å¤„ç†è¿›å…¥ç½‘ç»œï¼ˆIPï¼‰å±‚ã€‚&lt;code>ip_rcv&lt;/code> æ£€æŸ¥æ•°æ®åŒ…çš„ IP é¦–éƒ¨å¹¶ä¸¢å¼ƒå‡ºé”™çš„åŒ…ï¼Œå¿…è¦æ—¶è¿˜ä¼šèšåˆè¢«åˆ†ç‰‡çš„ IP åŒ…ã€‚ç„¶åæ‰§è¡Œ &lt;code>ip_rcv_finish&lt;/code> å‡½æ•°ï¼Œå¯¹æ•°æ®åŒ…è¿›è¡Œè·¯ç”±æŸ¥è¯¢å¹¶å†³å®šæ˜¯å°†æ•°æ®åŒ…äº¤ä»˜æœ¬æœºè¿˜æ˜¯è½¬å‘å…¶ä»–ä¸»æœºã€‚å‡è®¾æ•°æ®åŒ…çš„ç›®çš„åœ°å€æ˜¯æœ¬ä¸»æœºï¼Œæ¥ç€æ‰§è¡Œçš„ &lt;code>dst_input&lt;/code> å‡½æ•°å°†è°ƒç”¨ &lt;code>ip_local_deliver&lt;/code> å‡½æ•°ã€‚&lt;code>ip_local_deliver&lt;/code> å‡½æ•°ä¸­å°†æ ¹æ® IP é¦–éƒ¨ä¸­çš„åè®®å·åˆ¤æ–­è½½è·æ•°æ®çš„åè®®ç±»å‹ï¼Œæœ€åè°ƒç”¨å¯¹åº”ç±»å‹çš„åŒ…å¤„ç†å‡½æ•°ã€‚æœ¬ä¾‹ä¸­å°†è°ƒç”¨ TCP åè®®å¯¹åº”çš„ &lt;code>tcp_v4_rcv&lt;/code> å‡½æ•°ï¼Œä¹‹åæ•°æ®åŒ…å¤„ç†è¿›å…¥ä¼ è¾“å±‚ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>tcp_v4_rcv&lt;/code> å‡½æ•°åŒæ ·è¯»å–æ•°æ®åŒ…çš„ TCP é¦–éƒ¨å¹¶è®¡ç®—æ ¡éªŒå’Œï¼Œç„¶ååœ¨æ•°æ®åŒ…å¯¹åº”çš„ TCP control buffer ä¸­ç»´æŠ¤ä¸€äº›å¿…è¦çŠ¶æ€åŒ…æ‹¬ TCP åºåˆ—å·ä»¥åŠ SACK å·ç­‰ã€‚è¯¥å‡½æ•°ä¸‹ä¸€æ­¥å°†è°ƒç”¨ &lt;code>__tcp_v4_lookup&lt;/code> æŸ¥è¯¢æ•°æ®åŒ…å¯¹åº”çš„ socketï¼Œå¦‚æœæ²¡æ‰¾åˆ°æˆ– socket çš„è¿æ¥çŠ¶æ€å¤„äº &lt;strong>TCP_TIME_WAIT&lt;/strong>ï¼Œæ•°æ®åŒ…å°†è¢«ä¸¢å¼ƒã€‚å¦‚æœ socket å¤„äºæœªåŠ é”çŠ¶æ€ï¼Œæ•°æ®åŒ…å°†é€šè¿‡è°ƒç”¨ &lt;code>tcp_prequeue&lt;/code> å‡½æ•°è¿›å…¥ &lt;code>prequeue&lt;/code> é˜Ÿåˆ—ï¼Œä¹‹åæ•°æ®åŒ…å°†å¯è¢«ç”¨æˆ·æ€çš„ç”¨æˆ·ç¨‹åºæ‰€å¤„ç†ã€‚ä¼ è¾“å±‚çš„å¤„ç†æµç¨‹è¶…å‡ºæœ¬æ–‡è®¨è®ºèŒƒå›´ï¼Œå®é™…ä¸Šè¿˜è¦å¤æ‚å¾ˆå¤šã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="netfilter-hooks">netfilter hooks&lt;/h3>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼è¿›å…¥ä¸»é¢˜ã€‚netfilter çš„é¦–è¦ç»„æˆéƒ¨åˆ†æ˜¯ netfilter hooksã€‚&lt;/p>
&lt;h4 id="hook-è§¦å‘ç‚¹">hook è§¦å‘ç‚¹&lt;/h4>
&lt;p>å¯¹äºä¸åŒçš„åè®®ï¼ˆIPv4ã€IPv6 æˆ– ARP ç­‰ï¼‰ï¼ŒLinux å†…æ ¸ç½‘ç»œæ ˆä¼šåœ¨è¯¥åè®®æ ˆæ•°æ®åŒ…å¤„ç†è·¯å¾„ä¸Šçš„é¢„è®¾ä½ç½®è§¦å‘å¯¹åº”çš„ hookã€‚åœ¨ä¸åŒåè®®å¤„ç†æµç¨‹ä¸­çš„è§¦å‘ç‚¹ä½ç½®ä»¥åŠå¯¹åº”çš„ hook åç§°ï¼ˆè“è‰²çŸ©å½¢å¤–éƒ¨çš„é»‘ä½“å­—ï¼‰å¦‚ä¸‹ï¼Œæœ¬æ–‡ä»…é‡ç‚¹å…³æ³¨ IPv4 åè®®ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-netfilter-flow.png" alt="netfilter-flow">&lt;/p>
&lt;p>æ‰€è°“çš„ hook å®è´¨ä¸Šæ˜¯ä»£ç ä¸­çš„æšä¸¾å¯¹è±¡ï¼ˆå€¼ä¸ºä»0å¼€å§‹é€’å¢çš„æ•´å‹ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">enum&lt;/span> &lt;span class="n">nf_inet_hooks&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_PRE_ROUTING&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_LOCAL_IN&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_FORWARD&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_LOCAL_OUT&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_POST_ROUTING&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_INET_NUMHOOKS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯ä¸ª hook åœ¨å†…æ ¸ç½‘ç»œæ ˆä¸­å¯¹åº”ç‰¹å®šçš„è§¦å‘ç‚¹ä½ç½®ï¼Œä»¥ IPv4 åè®®æ ˆä¸ºä¾‹ï¼Œæœ‰ä»¥ä¸‹ netfilter hooks å®šä¹‰ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-netfilter-hooks-stack.png" alt="netfilter-hooks-stack">&lt;/p>
&lt;ul>
&lt;li>NF_INET_PRE_ROUTING: è¿™ä¸ª hook åœ¨ IPv4 åè®®æ ˆçš„ &lt;code>ip_rcv&lt;/code> å‡½æ•°æˆ– IPv6 åè®®æ ˆçš„ &lt;code>ipv6_rcv&lt;/code> å‡½æ•°ä¸­æ‰§è¡Œã€‚æ‰€æœ‰æ¥æ”¶æ•°æ®åŒ…åˆ°è¾¾çš„ç¬¬ä¸€ä¸ª hook è§¦å‘ç‚¹ï¼ˆå®é™…ä¸Šæ–°ç‰ˆæœ¬ Linux å¢åŠ äº† INGRESS hook ä½œä¸ºæœ€æ—©è§¦å‘ç‚¹ï¼‰ï¼Œåœ¨è¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹å‰æ‰§è¡Œã€‚&lt;/li>
&lt;li>NF_INET_LOCAL_IN: è¿™ä¸ª hook åœ¨ IPv4 åè®®æ ˆçš„ &lt;code>ip_local_deliver()&lt;/code> å‡½æ•°æˆ– IPv6 åè®®æ ˆçš„ &lt;code>ip6_input()&lt;/code> å‡½æ•°ä¸­æ‰§è¡Œã€‚ç»è¿‡è·¯ç”±åˆ¤æ–­åï¼Œæ‰€æœ‰ç›®æ ‡åœ°å€æ˜¯æœ¬æœºçš„æ¥æ”¶æ•°æ®åŒ…åˆ°è¾¾æ­¤ hook è§¦å‘ç‚¹ã€‚&lt;/li>
&lt;li>NF_INET_FORWARD: è¿™ä¸ª hook åœ¨ IPv4 åè®®æ ˆçš„ &lt;code>ip_forward()&lt;/code> å‡½æ•°æˆ– IPv6 åè®®æ ˆçš„ &lt;code>ip6_forward()&lt;/code> å‡½æ•°ä¸­æ‰§è¡Œã€‚ç»è¿‡è·¯ç”±åˆ¤æ–­åï¼Œæ‰€æœ‰ç›®æ ‡åœ°å€ä¸æ˜¯æœ¬æœºçš„æ¥æ”¶æ•°æ®åŒ…åˆ°è¾¾æ­¤ hook è§¦å‘ç‚¹ã€‚&lt;/li>
&lt;li>NF_INET_LOCAL_OUT: è¿™ä¸ª hook åœ¨ IPv4 åè®®æ ˆçš„ &lt;code>__ip_local_out()&lt;/code> å‡½æ•°æˆ– IPv6 åè®®æ ˆçš„ &lt;code>__ip6_local_out()&lt;/code> å‡½æ•°ä¸­æ‰§è¡Œã€‚æ‰€æœ‰æœ¬æœºäº§ç”Ÿçš„å‡†å¤‡å‘å‡ºçš„æ•°æ®åŒ…ï¼Œåœ¨è¿›å…¥ç½‘ç»œæ ˆåé¦–å…ˆåˆ°è¾¾æ­¤ hook è§¦å‘ç‚¹ã€‚&lt;/li>
&lt;li>NF_INET_POST_ROUTING: è¿™ä¸ª hook åœ¨ IPv4 åè®®æ ˆçš„ &lt;code>ip_output()&lt;/code> å‡½æ•°æˆ– IPv6 åè®®æ ˆçš„ &lt;code>ip6_finish_output2()&lt;/code> å‡½æ•°ä¸­æ‰§è¡Œã€‚æœ¬æœºäº§ç”Ÿçš„å‡†å¤‡å‘å‡ºçš„æ•°æ®åŒ…æˆ–è€…è½¬å‘çš„æ•°æ®åŒ…ï¼Œåœ¨ç»è¿‡è·¯ç”±åˆ¤æ–­ä¹‹åï¼Œ å°†åˆ°è¾¾æ­¤ hook è§¦å‘ç‚¹ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="nf_hook-å®å’Œ-netfilter-å‘é‡">NF_HOOK å®å’Œ netfilter å‘é‡&lt;/h4>
&lt;p>æ‰€æœ‰çš„è§¦å‘ç‚¹ä½ç½®ç»Ÿä¸€è°ƒç”¨ &lt;code>NF_HOOK&lt;/code> è¿™ä¸ªå®æ¥è§¦å‘ hookï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="kr">inline&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="nf">NF_HOOK&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kt">uint8_t&lt;/span> &lt;span class="n">pf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">in&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">net_device&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">out&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">okfn&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">NF_HOOK_THRESH&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">pf&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">hook&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">in&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">out&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">okfn&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">INT_MIN&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>NF-HOOK&lt;/code> æ¥æ”¶çš„å‚æ•°å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>pf: æ•°æ®åŒ…çš„åè®®æ—ï¼Œå¯¹ IPv4 æ¥è¯´æ˜¯ &lt;code>NFPROTO_IPV4&lt;/code>ã€‚&lt;/li>
&lt;li>hook: ä¸Šå›¾ä¸­æ‰€ç¤ºçš„ netfilter hook æšä¸¾å¯¹è±¡ï¼Œå¦‚ NF_INET_PRE_ROUTING æˆ–NF_INET_LOCAL_OUTã€‚&lt;/li>
&lt;li>skb: SKB å¯¹è±¡ï¼Œè¡¨ç¤ºæ­£åœ¨è¢«å¤„ç†çš„æ•°æ®åŒ…ã€‚&lt;/li>
&lt;li>in: æ•°æ®åŒ…çš„è¾“å…¥ç½‘ç»œè®¾å¤‡ã€‚&lt;/li>
&lt;li>out: æ•°æ®åŒ…çš„è¾“å‡ºç½‘ç»œè®¾å¤‡ã€‚&lt;/li>
&lt;li>okfn: ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œè¯¥å‡½æ•°å°†åœ¨è¯¥ hook å³å°†ç»ˆæ­¢æ—¶è°ƒç”¨ï¼Œé€šå¸¸ä¼ å…¥æ•°æ®åŒ…å¤„ç†è·¯å¾„ä¸Šçš„ä¸‹ä¸€ä¸ªå¤„ç†å‡½æ•°ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>NF-HOOK&lt;/code> çš„è¿”å›å€¼æ˜¯ä»¥ä¸‹å…·æœ‰ç‰¹å®šå«ä¹‰çš„ netfilter å‘é‡ä¹‹ä¸€ï¼š&lt;/p>
&lt;ol>
&lt;li>NF_ACCEPT: åœ¨å¤„ç†è·¯å¾„ä¸Šæ­£å¸¸ç»§ç»­ï¼ˆå®é™…ä¸Šæ˜¯åœ¨ &lt;code>NF-HOOK&lt;/code> ä¸­æœ€åæ‰§è¡Œä¼ å…¥çš„ &lt;code>okfn&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>NF_DROP: ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œç»ˆæ­¢å¤„ç†ã€‚&lt;/li>
&lt;li>NF_STOLEN: æ•°æ®åŒ…å·²è½¬äº¤ï¼Œç»ˆæ­¢å¤„ç†ã€‚&lt;/li>
&lt;li>NF_QUEUE: å°†æ•°æ®åŒ…å…¥é˜Ÿåä¾›å…¶ä»–å¤„ç†ã€‚&lt;/li>
&lt;li>NF_REPEAT: é‡æ–°è°ƒç”¨å½“å‰ hookã€‚&lt;/li>
&lt;/ol>
&lt;p>å›å½’åˆ°æºç ï¼ŒIPv4 å†…æ ¸ç½‘ç»œæ ˆä¼šåœ¨ä»¥ä¸‹ä»£ç æ¨¡å—ä¸­è°ƒç”¨ &lt;code>NF_HOOK()&lt;/code>ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-NF_HOOK.png" alt="NF_HOOK">&lt;/p>
&lt;p>å®é™…è°ƒç”¨æ–¹å¼ä»¥ &lt;strong>&lt;a href="https://elixir.bootlin.com/linux/v2.6.39.4/source/net/ipv4/ip_forward.c#L115">&lt;code>net/ipv4/ip_forward.c&lt;/code>&lt;/a>&lt;/strong> å¯¹æ•°æ®åŒ…è¿›è¡Œè½¬å‘çš„æºç ä¸ºä¾‹ï¼Œåœ¨ &lt;code>ip_forward&lt;/code> å‡½æ•°ç»“å°¾éƒ¨åˆ†çš„ç¬¬ 115 è¡Œä»¥ &lt;strong>NF_INET_FORWARD&lt;/strong> hook ä½œä¸ºå…¥å‚è°ƒç”¨äº† &lt;strong>&lt;code>NF_HOOK&lt;/code>&lt;/strong> å®ï¼Œå¹¶å°†ç½‘ç»œæ ˆæ¥ä¸‹æ¥çš„å¤„ç†å‡½æ•° &lt;code>ip_forward_finish&lt;/code> ä½œä¸º &lt;code>okfn&lt;/code> å‚æ•°ä¼ å…¥**ï¼š**&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="kt">int&lt;/span> &lt;span class="nf">ip_forward&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="n">sk_buff&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.....(&lt;/span>&lt;span class="err">çœç•¥éƒ¨åˆ†ä»£ç &lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">rt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">rt_flags&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">RTCF_DOREDIRECT&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">opt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">srr&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">!&lt;/span>&lt;span class="n">skb_sec_path&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">ip_rt_send_redirect&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">skb&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">rt_tos2priority&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">iph&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">tos&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">NF_HOOK&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">NFPROTO_IPV4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">NF_INET_FORWARD&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">skb&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rt&lt;/span>&lt;span class="o">-&amp;gt;&lt;/span>&lt;span class="n">dst&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">dev&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">ip_forward_finish&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">.....(&lt;/span>&lt;span class="err">çœç•¥éƒ¨åˆ†ä»£ç &lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å›è°ƒå‡½æ•°ä¸ä¼˜å…ˆçº§">å›è°ƒå‡½æ•°ä¸ä¼˜å…ˆçº§&lt;/h3>
&lt;p>netfilter çš„å¦ä¸€ç»„æˆéƒ¨åˆ†æ˜¯ hook çš„å›è°ƒå‡½æ•°ã€‚å†…æ ¸ç½‘ç»œæ ˆæ—¢ä½¿ç”¨ hook æ¥ä»£è¡¨ç‰¹å®šè§¦å‘ä½ç½®ï¼Œä¹Ÿä½¿ç”¨ hook ï¼ˆçš„æ•´æ•°å€¼ï¼‰ä½œä¸ºæ•°æ®ç´¢å¼•æ¥è®¿é—®è§¦å‘ç‚¹å¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚&lt;/p>
&lt;p>å†…æ ¸çš„å…¶ä»–æ¨¡å—å¯ä»¥é€šè¿‡ netfilter æä¾›çš„ api å‘æŒ‡å®šçš„ hook æ³¨å†Œå›è°ƒå‡½æ•°ï¼ŒåŒä¸€ hook å¯ä»¥æ³¨å†Œå¤šä¸ªå›è°ƒå‡½æ•°ï¼Œé€šè¿‡æ³¨å†Œæ—¶æŒ‡å®šçš„ &lt;strong>priority&lt;/strong> å‚æ•°å¯æŒ‡å®šå›è°ƒå‡½æ•°åœ¨æ‰§è¡Œæ—¶çš„ä¼˜å…ˆçº§ã€‚&lt;/p>
&lt;p>æ³¨å†Œ hook çš„å›è°ƒå‡½æ•°æ—¶ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ª &lt;code>nf_hook_ops&lt;/code> ç»“æ„ï¼ˆæˆ–ç”±å¤šä¸ªè¯¥ç»“æ„ç»„æˆçš„æ•°ç»„ï¼‰ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="n">nf_hook_ops&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">list_head&lt;/span> &lt;span class="n">list&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* User fills in from here down. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nf_hookfn&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">hook&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">module&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">owner&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">u_int8_t&lt;/span> &lt;span class="n">pf&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">hooknum&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* Hooks are ordered in ascending priority. */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">int&lt;/span> &lt;span class="n">priority&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨å®šä¹‰ä¸­æœ‰ 3 ä¸ªé‡è¦æˆå‘˜ï¼š&lt;/p>
&lt;ul>
&lt;li>hook: å°†è¦æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œå‡½æ•°å‚æ•°å®šä¹‰ä¸ &lt;code>NF_HOOK&lt;/code> ç±»ä¼¼ï¼Œå¯é€šè¿‡ &lt;code>okfn&lt;/code> å‚æ•°åµŒå¥—å…¶ä»–å‡½æ•°ã€‚&lt;/li>
&lt;li>hooknum: æ³¨å†Œçš„ç›®æ ‡ hook æšä¸¾å€¼ã€‚&lt;/li>
&lt;li>priority: å›è°ƒå‡½æ•°çš„ä¼˜å…ˆçº§ï¼Œ&lt;strong>è¾ƒå°çš„å€¼ä¼˜å…ˆæ‰§è¡Œ&lt;/strong>ã€‚&lt;/li>
&lt;/ul>
&lt;p>å®šä¹‰ç»“æ„ä½“åå¯é€šè¿‡ &lt;code>int nf_register_hook(struct nf_hook_ops *reg)&lt;/code> æˆ– &lt;code>int nf_register_hooks(struct nf_hook_ops *reg, unsigned int n);&lt;/code> åˆ†åˆ«æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªå›è°ƒå‡½æ•°ã€‚åŒä¸€ netfilter hook ä¸‹æ‰€æœ‰çš„ &lt;code>nf_hook_ops&lt;/code> æ³¨å†Œåä»¥ priority ä¸ºé¡ºåºç»„æˆä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œæ³¨å†Œè¿‡ç¨‹ä¼šæ ¹æ® priority ä»é“¾è¡¨ä¸­æ‰¾åˆ°åˆé€‚çš„ä½ç½®ï¼Œç„¶åæ‰§è¡Œé“¾è¡¨æ’å…¥æ“ä½œã€‚&lt;/p>
&lt;p>åœ¨æ‰§è¡Œ &lt;code>NF-HOOK&lt;/code> å®è§¦å‘æŒ‡å®šçš„ hook æ—¶ï¼Œå°†è°ƒç”¨ &lt;code>nf_iterate&lt;/code> å‡½æ•°è¿­ä»£è¿™ä¸ª hook å¯¹åº”çš„ &lt;code>nf_hook_ops&lt;/code> é“¾è¡¨ï¼Œå¹¶ä¾æ¬¡è°ƒç”¨æ¯ä¸€ä¸ª &lt;code>nf_hook_ops&lt;/code> çš„æ³¨å†Œå‡½æ•°æˆå‘˜ &lt;code>hookfn&lt;/code>ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-netfilter-hookfn1.png" alt="netfilter-hookfn1">&lt;/p>
&lt;p>è¿™ç§é“¾å¼è°ƒç”¨å›è°ƒå‡½æ•°çš„å·¥ä½œæ–¹å¼ï¼Œä¹Ÿè®© netfilter hook è¢«ç§°ä¸º Chainï¼Œä¸‹æ–‡çš„ iptables ä»‹ç»ä¸­å°¤å…¶ä½“ç°äº†è¿™ä¸€å…³è”ã€‚&lt;/p>
&lt;p>æ¯ä¸ªå›è°ƒå‡½æ•°ä¹Ÿå¿…é¡»è¿”å›ä¸€ä¸ª netfilter å‘é‡ï¼›å¦‚æœè¯¥å‘é‡ä¸º &lt;strong>NF_ACCEPTï¼Œ&lt;/strong>&lt;code>nf_iterate&lt;/code> å°†ä¼šç»§ç»­è°ƒç”¨ä¸‹ä¸€ä¸ª &lt;code>nf_hook_ops&lt;/code> çš„å›è°ƒå‡½æ•°ï¼Œç›´åˆ°æ‰€æœ‰å›è°ƒå‡½æ•°è°ƒç”¨å®Œæ¯•åè¿”å› &lt;strong>NF_ACCEPT&lt;/strong>ï¼›å¦‚æœè¯¥å‘é‡ä¸º &lt;strong>NF_DROP&lt;/strong>ï¼Œå°†ä¸­æ–­éå†å¹¶ç›´æ¥è¿”å› &lt;strong>NF_DROPï¼›&lt;strong>å¦‚æœè¯¥å‘é‡ä¸º &lt;strong>NF_REPEAT&lt;/strong>ï¼Œå°†é‡æ–°æ‰§è¡Œè¯¥å›è°ƒå‡½æ•°&lt;/strong>ã€‚&lt;/strong> &lt;code>nf_iterate&lt;/code> çš„è¿”å›å€¼ä¹Ÿå°†ä½œä¸º &lt;code>NF-HOOK&lt;/code> çš„è¿”å›å€¼ï¼Œç½‘ç»œæ ˆå°†æ ¹æ®è¯¥å‘é‡å€¼åˆ¤æ–­æ˜¯å¦ç»§ç»­æ‰§è¡Œå¤„ç†å‡½æ•°ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-netfilter-hookfn2.png" alt="netfilter-hookfn2">&lt;/p>
&lt;p>netfilter hook çš„å›è°ƒå‡½æ•°æœºåˆ¶å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>å›è°ƒå‡½æ•°æŒ‰ä¼˜å…ˆçº§ä¾æ¬¡æ‰§è¡Œï¼Œåªæœ‰ä¸Šä¸€å›è°ƒå‡½æ•°è¿”å› &lt;strong>NF_ACCEPT&lt;/strong> æ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€å›è°ƒå‡½æ•°ã€‚&lt;/li>
&lt;li>ä»»ä¸€å›è°ƒå‡½æ•°éƒ½å¯ä»¥ä¸­æ–­è¯¥ hook çš„å›è°ƒå‡½æ•°æ‰§è¡Œé“¾ï¼ŒåŒæ—¶è¦æ±‚æ•´ä¸ªç½‘ç»œæ ˆä¸­æ­¢å¯¹æ•°æ®åŒ…çš„å¤„ç†ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="iptables">iptables&lt;/h2>
&lt;p>åŸºäºå†…æ ¸ netfilter æä¾›çš„ hook å›è°ƒå‡½æ•°æœºåˆ¶ï¼Œnetfilter ä½œè€… Rusty Russell è¿˜å¼€å‘äº† iptablesï¼Œå®ç°åœ¨ç”¨æˆ·ç©ºé—´ç®¡ç†åº”ç”¨äºæ•°æ®åŒ…çš„è‡ªå®šä¹‰è§„åˆ™ã€‚&lt;/p>
&lt;p>iptbles åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”¨æˆ·ç©ºé—´çš„ iptables å‘½ä»¤å‘ç”¨æˆ·æä¾›è®¿é—®å†…æ ¸ iptables æ¨¡å—çš„ç®¡ç†ç•Œé¢ã€‚&lt;/li>
&lt;li>å†…æ ¸ç©ºé—´çš„ iptables æ¨¡å—åœ¨å†…å­˜ä¸­ç»´æŠ¤è§„åˆ™è¡¨ï¼Œå®ç°è¡¨çš„åˆ›å»ºåŠæ³¨å†Œã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å†…æ ¸ç©ºé—´æ¨¡å—">å†…æ ¸ç©ºé—´æ¨¡å—&lt;/h3>
&lt;h4 id="xt_table-çš„åˆå§‹åŒ–">xt_table çš„åˆå§‹åŒ–&lt;/h4>
&lt;p>åœ¨å†…æ ¸ç½‘ç»œæ ˆä¸­ï¼Œiptables é€šè¿‡ &lt;code>xt_table&lt;/code> ç»“æ„å¯¹ä¼—å¤šçš„æ•°æ®åŒ…å¤„ç†è§„åˆ™è¿›è¡Œæœ‰åºç®¡ç†ï¼Œä¸€ä¸ª &lt;code>xt_table&lt;/code> å¯¹åº”ä¸€ä¸ªè§„åˆ™è¡¨ï¼Œå¯¹åº”çš„ç”¨æˆ·ç©ºé—´æ¦‚å¿µä¸º tableã€‚ä¸åŒçš„è§„åˆ™è¡¨æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹ä¸åŒçš„ netfilter hooks ç”Ÿæ•ˆã€‚&lt;/li>
&lt;li>åœ¨åŒä¸€ hook ä¸­æ£€æŸ¥ä¸åŒè§„åˆ™è¡¨çš„ä¼˜å…ˆçº§ä¸åŒã€‚&lt;/li>
&lt;/ul>
&lt;p>åŸºäºè§„åˆ™çš„æœ€ç»ˆç›®çš„ï¼Œiptables é»˜è®¤åˆå§‹åŒ–äº† 4 ä¸ªä¸åŒçš„è§„åˆ™è¡¨ï¼Œåˆ†åˆ«æ˜¯ rawã€ filterã€nat å’Œ mangleã€‚ä¸‹æ–‡ä»¥ filter ä¸ºä¾‹ä»‹ç» &lt;code>xt_table&lt;/code>çš„åˆå§‹åŒ–å’Œè°ƒç”¨è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>filter table çš„å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#define FILTER_VALID_HOOKS ((1 &amp;lt;&amp;lt; NF_INET_LOCAL_IN) | \
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp"> (1 &amp;lt;&amp;lt; NF_INET_FORWARD) | \
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">1&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="n">NF_INET_LOCAL_OUT&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">static&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="k">struct&lt;/span> &lt;span class="n">xt_table&lt;/span> &lt;span class="n">packet_filter&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">&amp;#34;filter&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">valid_hooks&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">FILTER_VALID_HOOKS&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">me&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">THIS_MODULE&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">af&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">NFPROTO_IPV4&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">.&lt;/span>&lt;span class="n">priority&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">NF_IP_PRI_FILTER&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="n">net&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ipv4&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">netfilter&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">iptable_filter&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ &lt;strong>&lt;a href="https://elixir.bootlin.com/linux/v2.6.39.4/source/net/ipv4/netfilter/iptable_filter.c#L87">iptable_filter.c&lt;/a>&lt;/strong> æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•° &lt;code>[iptable_filter_init](https://elixir.bootlin.com/linux/v2.6.39.4/C/ident/iptable_filter_init)&lt;/code> ****ä¸­ï¼Œè°ƒç”¨&lt;code>xt_hook_link&lt;/code> å¯¹ &lt;code>xt_table&lt;/code> ç»“æ„ packet_filter æ‰§è¡Œå¦‚ä¸‹åˆå§‹åŒ–è¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>é€šè¿‡ &lt;code>.valid_hooks&lt;/code> å±æ€§è¿­ä»£ &lt;code>xt_table&lt;/code> å°†ç”Ÿæ•ˆçš„æ¯ä¸€ä¸ª hookï¼Œå¯¹äº filter æ¥è¯´æ˜¯ &lt;strong>NF_INET_LOCAL_IN&lt;/strong>ï¼Œ&lt;strong>NF_INET_FORWARD&lt;/strong> å’Œ &lt;strong>NF_INET_LOCAL_OUT&lt;/strong> è¿™3ä¸ªhookã€‚&lt;/li>
&lt;li>å¯¹æ¯ä¸€ä¸ª hookï¼Œä½¿ç”¨ &lt;code>xt_table&lt;/code> çš„ priority å±æ€§å‘ hook æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸åŒ table çš„ priority å€¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">enum&lt;/span> &lt;span class="n">nf_ip_hook_priorities&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_RAW&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">300&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_MANGLE&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">150&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_NAT_DST&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_FILTER&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_SECURITY&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">50&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">NF_IP_PRI_NAT_SRC&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">100&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“æ•°æ®åŒ…åˆ°è¾¾æŸä¸€ hook è§¦å‘ç‚¹æ—¶ï¼Œä¼šä¾æ¬¡æ‰§è¡Œä¸åŒ table åœ¨è¯¥ hook ä¸Šæ³¨å†Œçš„æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œè¿™äº›å›è°ƒå‡½æ•°æ€»æ˜¯æ ¹æ®ä¸Šæ–‡çš„ priority å€¼ä»¥å›ºå®šçš„ç›¸å¯¹é¡ºåºæ‰§è¡Œï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-tables-priority.png" alt="tables-priority">&lt;/p>
&lt;h4 id="ipt_do_table">ipt_do_table()&lt;/h4>
&lt;p>filter æ³¨å†Œçš„ hook å›è°ƒå‡½æ•° &lt;a href="https://elixir.bootlin.com/linux/v2.6.39.4/C/ident/iptable_filter_hook">iptable_filter_hook&lt;/a> å°†å¯¹ &lt;code>xt_table&lt;/code> ç»“æ„æ‰§è¡Œå…¬å…±çš„è§„åˆ™æ£€æŸ¥å‡½æ•° &lt;a href="https://elixir.bootlin.com/linux/v2.6.39.4/C/ident/ipt_do_table">ipt_do_table&lt;/a>ã€‚&lt;code>ipt_do_table&lt;/code> æ¥æ”¶ &lt;code>skb&lt;/code>ã€&lt;code>hook&lt;/code> å’Œ &lt;code>xt_table&lt;/code>ä½œä¸ºå‚æ•°ï¼Œå¯¹ &lt;code>skb&lt;/code> æ‰§è¡Œåä¸¤ä¸ªå‚æ•°æ‰€ç¡®å®šçš„è§„åˆ™é›†ï¼Œè¿”å› netfilter å‘é‡ä½œä¸ºå›è°ƒå‡½æ•°çš„è¿”å›å€¼ã€‚&lt;/p>
&lt;p>åœ¨æ·±å…¥è§„åˆ™æ‰§è¡Œè¿‡ç¨‹å‰ï¼Œéœ€è¦å…ˆäº†è§£è§„åˆ™é›†å¦‚ä½•åœ¨å†…å­˜ä¸­è¡¨ç¤ºã€‚æ¯ä¸€æ¡è§„åˆ™ç”± 3 éƒ¨åˆ†ç»„æˆï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ª &lt;code>ipt_entry&lt;/code> ç»“æ„ä½“ã€‚é€šè¿‡ &lt;code>.next_offset&lt;/code> æŒ‡å‘ä¸‹ä¸€ä¸ª &lt;code>ipt_entry&lt;/code> çš„å†…å­˜åç§»åœ°å€ã€‚&lt;/li>
&lt;li>0 ä¸ªæˆ–å¤šä¸ª &lt;code>ipt_entry_match&lt;/code> ç»“æ„ä½“ï¼Œæ¯ä¸ªç»“æ„ä½“å¯ä»¥åŠ¨æ€çš„æ·»åŠ é¢å¤–æ•°æ®ã€‚&lt;/li>
&lt;li>1 ä¸ª &lt;code>ipt_entry_target&lt;/code> ç»“æ„ä½“ï¼Œ ç»“æ„ä½“å¯ä»¥åŠ¨æ€çš„æ·»åŠ é¢å¤–æ•°æ®ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;code>ipt_entry&lt;/code> ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="k">struct&lt;/span> &lt;span class="n">ipt_entry&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">ipt_ip&lt;/span> &lt;span class="n">ip&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">nfcache&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* ipt_entry + matches åœ¨å†…å­˜ä¸­çš„å¤§å°*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">u_int16_t&lt;/span> &lt;span class="n">target_offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* ipt_entry + matches + target åœ¨å†…å­˜ä¸­çš„å¤§å° */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">u_int16_t&lt;/span> &lt;span class="n">next_offset&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* è·³è½¬åæŒ‡å‘å‰ä¸€è§„åˆ™ */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">comefrom&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* æ•°æ®åŒ…è®¡æ•°å™¨ */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">struct&lt;/span> &lt;span class="n">xt_counters&lt;/span> &lt;span class="n">counters&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="cm">/* é•¿åº¦ä¸º0æ•°ç»„çš„ç‰¹æ®Šç”¨æ³•ï¼Œä½œä¸º match çš„å†…å­˜åœ°å€ */&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">unsigned&lt;/span> &lt;span class="kt">char&lt;/span> &lt;span class="n">elems&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>ipt_do_table&lt;/code> é¦–å…ˆæ ¹æ® hook ç±»å‹ä»¥åŠ &lt;code>xt_table.private.entries&lt;/code> å±æ€§è·³è½¬åˆ°å¯¹åº”çš„è§„åˆ™é›†å†…å­˜åŒºåŸŸï¼Œæ‰§è¡Œå¦‚ä¸‹è¿‡ç¨‹ï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-ipt_do_table.png" alt="ipt_do_table">&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆæ£€æŸ¥æ•°æ®åŒ…çš„ IP é¦–éƒ¨ä¸ç¬¬ä¸€æ¡è§„åˆ™ &lt;code>ipt_entry&lt;/code> çš„ &lt;code>.ipt_ip&lt;/code> å±æ€§æ˜¯å¦ä¸€è‡´ï¼Œå¦‚ä¸åŒ¹é…æ ¹æ® &lt;code>next_offset&lt;/code> å±æ€§è·³è½¬åˆ°ä¸‹ä¸€æ¡è§„åˆ™ã€‚&lt;/li>
&lt;li>è‹¥IP é¦–éƒ¨åŒ¹é… ï¼Œåˆ™å¼€å§‹ä¾æ¬¡æ£€æŸ¥è¯¥è§„åˆ™æ‰€å®šä¹‰çš„æ‰€æœ‰ &lt;code>ipt_entry_match&lt;/code> å¯¹è±¡ï¼Œä¸å¯¹è±¡å…³è”çš„åŒ¹é…å‡½æ•°å°†è¢«è°ƒç”¨ï¼Œæ ¹æ®è°ƒç”¨è¿”å›å€¼æœ‰è¿”å›åˆ°å›è°ƒå‡½æ•°ï¼ˆä»¥åŠæ˜¯å¦ä¸¢å¼ƒæ•°æ®åŒ…ï¼‰ã€è·³è½¬åˆ°ä¸‹ä¸€è§„åˆ™æˆ–ç»§ç»­æ£€æŸ¥ç­‰ç»“æœã€‚&lt;/li>
&lt;li>æ‰€æœ‰æ£€æŸ¥é€šè¿‡åè¯»å– &lt;code>ipt_entry_target&lt;/code>ï¼Œæ ¹æ®å…¶å±æ€§è¿”å› netfilter å‘é‡åˆ°å›è°ƒå‡½æ•°ã€ç»§ç»­ä¸‹ä¸€è§„åˆ™æˆ–è·³è½¬åˆ°æŒ‡å®šå†…å­˜åœ°å€çš„å…¶ä»–è§„åˆ™ï¼Œéæ ‡å‡† &lt;code>ipt_entry_target&lt;/code> è¿˜ä¼šè°ƒç”¨è¢«ç»‘å®šçš„å‡½æ•°ï¼Œä½†åªèƒ½è¿”å›å‘é‡å€¼ä¸èƒ½è·³è½¬å…¶ä»–è§„åˆ™ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="çµæ´»æ€§å’Œæ›´æ–°æ—¶å»¶">çµæ´»æ€§å’Œæ›´æ–°æ—¶å»¶&lt;/h4>
&lt;p>ä»¥ä¸Šæ•°æ®ç»“æ„ä¸æ‰§è¡Œæ–¹å¼ä¸º iptables æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥çµæ´»åœ°è‡ªå®šä¹‰æ¯æ¡è§„åˆ™çš„åŒ¹é…æ¡ä»¶å¹¶æ ¹æ®ç»“æœæ‰§è¡Œä¸åŒè¡Œä¸ºï¼Œç”šè‡³è¿˜èƒ½åœ¨é¢å¤–çš„è§„åˆ™é›†ä¹‹é—´æ ˆå¼è·³è½¬ã€‚&lt;/p>
&lt;p>ç”±äºæ¯æ¡è§„åˆ™é•¿åº¦ä¸ç­‰ã€å†…éƒ¨ç»“æ„å¤æ‚ï¼Œä¸”åŒä¸€è§„åˆ™é›†ä½äºè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œiptables ä½¿ç”¨å…¨é‡æ›¿æ¢çš„æ–¹å¼æ¥æ›´æ–°è§„åˆ™ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿä»ç”¨æˆ·ç©ºé—´ä»¥åŸå­æ“ä½œæ¥æ·»åŠ /åˆ é™¤è§„åˆ™ï¼Œä½†éå¢é‡å¼çš„è§„åˆ™æ›´æ–°ä¼šåœ¨è§„åˆ™æ•°é‡çº§è¾ƒå¤§æ—¶å¸¦æ¥ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼šå‡å¦‚åœ¨ä¸€ä¸ªå¤§è§„æ¨¡ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ iptables æ–¹å¼å®ç° Serviceï¼Œå½“ service æ•°é‡è¾ƒå¤šæ—¶ï¼Œå“ªæ€•æ›´æ–°ä¸€ä¸ª service ä¹Ÿä¼šæ•´ä½“ä¿®æ”¹ iptables è§„åˆ™è¡¨ã€‚å…¨é‡æäº¤çš„è¿‡ç¨‹ä¼š kernel lock è¿›è¡Œä¿æŠ¤ï¼Œå› æ­¤ä¼šæœ‰å¾ˆå¤§çš„æ›´æ–°æ—¶å»¶ã€‚&lt;/p>
&lt;h3 id="ç”¨æˆ·ç©ºé—´çš„-tableschains-å’Œ-rules">ç”¨æˆ·ç©ºé—´çš„ tablesã€chains å’Œ rules&lt;/h3>
&lt;p>ç”¨æˆ·ç©ºé—´çš„ iptables å‘½ä»¤è¡Œå¯ä»¥è¯»å–æŒ‡å®šè¡¨çš„æ•°æ®å¹¶æ¸²æŸ“åˆ°ç»ˆç«¯ï¼Œæ·»åŠ æ–°çš„è§„åˆ™ï¼ˆå®é™…ä¸Šæ˜¯æ›¿æ¢æ•´ä¸ª table çš„è§„åˆ™è¡¨ï¼‰ç­‰ã€‚&lt;/p>
&lt;p>iptables ä¸»è¦æ“ä½œä»¥ä¸‹å‡ ç§å¯¹è±¡ï¼š&lt;/p>
&lt;ul>
&lt;li>tableï¼šå¯¹åº”å†…æ ¸ç©ºé—´çš„ &lt;code>xt_table&lt;/code> ç»“æ„ï¼Œiptable çš„æ‰€æœ‰æ“ä½œéƒ½å¯¹æŒ‡å®šçš„ table æ‰§è¡Œï¼Œé»˜è®¤ä¸º filterã€‚&lt;/li>
&lt;li>chainï¼šå¯¹åº”æŒ‡å®š table é€šè¿‡ç‰¹å®š netfilter hook è°ƒç”¨çš„è§„åˆ™é›†ï¼Œæ­¤å¤–è¿˜å¯ä»¥è‡ªå®šä¹‰è§„åˆ™é›†ï¼Œç„¶åä» hook è§„åˆ™é›†ä¸­è·³è½¬è¿‡å»ã€‚&lt;/li>
&lt;li>ruleï¼šå¯¹åº”ä¸Šæ–‡ä¸­ &lt;code>ipt_entry&lt;/code>ã€&lt;code>ipt_entry_match&lt;/code> å’Œ &lt;code>ipt_entry_target&lt;/code>ï¼Œå®šä¹‰äº†å¯¹æ•°æ®åŒ…çš„åŒ¹é…è§„åˆ™ä»¥åŠåŒ¹é…åæ‰§è¡Œçš„è¡Œä¸ºã€‚&lt;/li>
&lt;li>matchï¼šå…·æœ‰å¾ˆå¼ºæ‰©å±•æ€§çš„è‡ªå®šä¹‰åŒ¹é…è§„åˆ™ã€‚&lt;/li>
&lt;li>targetï¼šå…·æœ‰å¾ˆå¼ºæ‰©å±•æ€§çš„è‡ªå®šä¹‰åŒ¹é…åè¡Œä¸ºã€‚&lt;/li>
&lt;/ul>
&lt;p>åŸºäºä¸Šæ–‡ä»‹ç»çš„ä»£ç è°ƒç”¨è¿‡ç¨‹æµç¨‹ï¼Œchain å’Œ rule æŒ‰å¦‚ä¸‹ç¤ºæ„å›¾æ‰§è¡Œï¼š&lt;/p>
&lt;p>&lt;img src="2022-03-07-iptables-chains.png" alt="iptables-chains">&lt;/p>
&lt;p>å¯¹äº iptables å…·ä½“çš„ç”¨æ³•å’ŒæŒ‡ä»¤æœ¬æ–‡ä¸åšè¯¦ç»†ä»‹ç»ï¼Œå¯å‚è€ƒ &lt;a href="https://www.digitalocean.com/community/tutorials/iptables-essentials-common-firewall-rules-and-commands">Iptables Essentials: Common Firewall Rules and Commands | DigitalOcean&lt;/a>ã€‚&lt;/p>
&lt;h2 id="conntrack">conntrack&lt;/h2>
&lt;p>ä»…ä»…é€šè¿‡3ã€4å±‚çš„é¦–éƒ¨ä¿¡æ¯å¯¹æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤æ˜¯ä¸å¤Ÿçš„ï¼Œæœ‰æ—¶å€™è¿˜éœ€è¦è¿›ä¸€æ­¥è€ƒè™‘è¿æ¥çš„çŠ¶æ€ã€‚netfilter é€šè¿‡å¦ä¸€å†…ç½®æ¨¡å— &lt;code>conntrack&lt;/code> è¿›è¡Œè¿æ¥è·Ÿè¸ªï¼ˆconnection trackingï¼‰ï¼Œä»¥æä¾›æ ¹æ®è¿æ¥è¿‡æ»¤ã€åœ°å€è½¬æ¢ï¼ˆNATï¼‰ç­‰æ›´è¿›é˜¶çš„ç½‘ç»œè¿‡æ»¤åŠŸèƒ½ã€‚ç”±äºéœ€è¦å¯¹è¿æ¥çŠ¶æ€è¿›è¡Œåˆ¤æ–­ï¼Œ&lt;code>conntrack&lt;/code> åœ¨æ•´ä½“æœºåˆ¶ç›¸åŒçš„åŸºç¡€ä¸Šï¼Œåˆé’ˆå¯¹åè®®ç‰¹ç‚¹æœ‰å•ç‹¬çš„å®ç°ã€‚&lt;/p>
&lt;p>æœ¬æ¥æ‰“ç®—ç»§ç»­ä»‹ç» &lt;code>conntrack&lt;/code> å’Œ NATï¼Œä½†è€ƒè™‘åˆ°ç¯‡å¹…è¿‡é•¿é‚ä½œç½¢ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…æ¨èé˜…è¯»&lt;a href="https://arthurchiao.art/blog/conntrack-design-and-implementation-zh/#hook-%E4%BC%98%E5%85%88%E7%BA%A7">è¿æ¥è·Ÿè¸ªï¼ˆconntrackï¼‰ï¼šåŸç†ã€åº”ç”¨åŠ Linux å†…æ ¸å®ç°&lt;/a>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://elixir.bootlin.com/linux/v2.6.39.4/source/include/linux/netfilter.h">netfilter.h - include/linux/netfilter.h - Linux source code (v2.6.39.4) - Bootlin&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.cs.dartmouth.edu/~sergey/netreads/path-of-packet/Network_stack.pdf">Network_stack.pdf&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.netfilter.org/documentation/HOWTO/netfilter-hacking-HOWTO.html#toc3">Linux netfilter Hacking HOWTO&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://link.springer.com/book/10.1007/978-1-4302-6197-1">Linux Kernel Networking: Implementation and Theory - Chapter 9: Netfilter&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.teldat.com/blog/nftables-and-netfilter-hooks-via-linux-kernel/">Netfilter framework providing hooks system for Nftables&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.digitalocean.com/community/tutorials/a-deep-dive-into-iptables-and-netfilter-architecture">A Deep Dive into Iptables and Netfilter Architecture | DigitalOcean&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://arthurchiao.art/blog/conntrack-design-and-implementation-zh/#hook-%E4%BC%98%E5%85%88%E7%BA%A7">è¿æ¥è·Ÿè¸ªï¼ˆconntrackï¼‰ï¼šåŸç†ã€åº”ç”¨åŠ Linux å†…æ ¸å®ç°&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://wiki.nftables.org/wiki-nftables/index.php/Netfilter_hooks">Netfilter hooks - nftables wiki&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.digitalocean.com/community/tutorials/iptables-essentials-common-firewall-rules-and-commands">Iptables Essentials: Common Firewall Rules and Commands | DigitalOcean&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.tigera.io/blog/comparing-kube-proxy-modes-iptables-or-ipvs/">Comparing kube-proxy modes: iptables or IPVS?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.tigera.io/blog/when-linux-conntrack-is-no-longer-your-friend/">Linux Conntrack: Why It Breaks Down and Avoiding the Problem&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://juejin.cn/post/7008945265021288484">èµ°è¿›Linuxå†…æ ¸ä¹‹Netfilteræ¡†æ¶ - æ˜é‡‘&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://flylib.com/books/en/3.475.1.101/1/">19.3 The Netfilter Architecture of Linux 2.4 | Linux Network Architecture&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/networking/" term="Networking" label="Networking"/><category scheme="https://waynerv.com/tags/netfilter/" term="netfilter" label="netfilter"/><category scheme="https://waynerv.com/tags/iptables/" term="iptables" label="iptables"/></entry><entry><title type="text">åˆ¶ä½œå¼€ç®±å³ç”¨çš„ Ubuntu qcow2 é•œåƒ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/create-out-of-box-ubuntu-qcow2-image/"/><id>https://waynerv.com/posts/create-out-of-box-ubuntu-qcow2-image/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-12-07T23:08:26+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">è®°å½•ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ Ubuntu è™šæ‹Ÿæœºé•œåƒçš„å®Œæ•´åˆ¶ä½œè¿‡ç¨‹ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥åˆ° OpenStack å’Œ Zstack ç­‰å¹³å°ä½¿ç”¨ã€‚</summary><content type="html">&lt;p>æœ€è¿‘è´Ÿè´£çš„ä¸€ä¸ªç»„ä»¶éœ€è¦é’ˆå¯¹ Ubuntu ç³»ç»Ÿåšå…¼å®¹æ€§é€‚é…ï¼Œç”±äºç»„ä»¶è¿è¡Œæ—¶ä¼šä¿®æ”¹ç³»ç»Ÿé…ç½®å¹¶å†™å…¥å¤§é‡æ–‡ä»¶ï¼Œæœ‰å¿…è¦ä½¿ç”¨è™šæ‹Ÿæœºæ¥å¼€å‘æµ‹è¯•ã€‚ä½†é€šå¸¸å¼€å‘ä½¿ç”¨çš„ Linux å‘è¡Œç‰ˆéƒ½æ˜¯ RedHat ç³»çš„ï¼Œæ‰¾éå…¬å¸ä¹Ÿæ²¡æœ‰èƒ½ç›´æ¥ç”¨çš„ Ubuntu è™šæ‹Ÿæœºé•œåƒï¼Œæœ€åè‡ªå·±æ‰‹æ“äº†ä¸€ä¸ªï¼Œè¿‡ç¨‹è®°å½•å¦‚ä¸‹ã€‚&lt;/p>
&lt;h2 id="ä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„-cloud-image">ä¸‹è½½æ‰€éœ€ç‰ˆæœ¬çš„ cloud image&lt;/h2>
&lt;p>é¦–å…ˆéœ€è¦ç¡®å®šæ‰€ä½¿ç”¨çš„ Ubuntu ç‰ˆæœ¬ï¼Œç„¶åä»&lt;a href="https://cloud-images.ubuntu.com/">å®˜æ–¹é•œåƒåˆ—è¡¨&lt;/a>ä¸­ä¸‹è½½ç›¸åº”çš„äº‘ä¸»æœºé•œåƒï¼Œäº‘ä¸»æœºé•œåƒé¢„è£…äº† cloud-initï¼Œå¯ä»¥æ›´æ–¹ä¾¿åœ°è¿è¡Œåœ¨ openstack ç­‰äº‘å¹³å°ä¸­ã€‚&lt;/p>
&lt;p>åœ¨é•œåƒåˆ—è¡¨é¡µé¢ï¼Œéœ€è¦æ ¹æ®å‘å¸ƒé¢‘ç‡ï¼ˆå¦‚ Releaseã€Daily buildsï¼‰ã€é•œåƒå¤§å°ï¼ˆå®Œæ•´åŒ…å’Œ Minimalï¼‰ä»¥åŠ Ubuntu ç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„é•œåƒï¼Œåœ¨é•œåƒä¸‹è½½é¡µé¢æœ‰è®¸å¤šä¸åŒç±»å‹çš„æ–‡ä»¶ï¼Œå¦‚æ ¡éªŒå’Œæ–‡ä»¶ã€manifest ä»¥åŠä¸åŒæ¶æ„çš„é•œåƒï¼Œæˆ‘ä»¬åªéœ€è¦æ–‡ä»¶åç¼€ä¸º &lt;code>.img&lt;/code> çš„ QEMU qcow2 é•œåƒã€‚``&lt;/p>
&lt;p>æœ¬ç¤ºä¾‹å°†é€‰æ‹© X86 æ¶æ„çš„ &lt;code>20.04-lts&lt;/code> ç‰ˆæœ¬ï¼Œæœ€ç»ˆæ‰€ä¸‹è½½çš„é•œåƒä¸º &lt;a href="https://cloud-images.ubuntu.com/releases/focal/release-20211129/ubuntu-20.04-server-cloudimg-amd64.img">ubuntu-20.04-server-cloudimg-amd64.img&lt;/a>ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>wget&lt;/code> å‘½ä»¤å°†å…¶ä¸‹è½½åˆ°æœ¬åœ°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">wget https://cloud-images.ubuntu.com/releases/focal/release-20211129/ubuntu-20.04-server-cloudimg-amd64.img
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="cloud-init">cloud-init&lt;/h3>
&lt;p>cloud-init æ˜¯ç”¨äºè·¨å¹³å°åˆå§‹åŒ–äº‘ä¸»æœºå®ä¾‹çš„è¡Œä¸šæ ‡å‡†æ–¹æ³•ã€‚å®ƒæ”¯æŒæ‰€æœ‰çš„ä¸»è¦å…¬æœ‰äº‘ä¾›åº”å•†ã€ç§æœ‰äº‘é…ç½®ç³»ç»Ÿå’Œè£¸æœºå®‰è£…ã€‚&lt;/p>
&lt;p>æœ‰äº† cloud-initï¼Œåªéœ€è¦æä¾›ç³»ç»Ÿé•œåƒå’Œè§„å®šçš„å…ƒæ•°æ®ï¼ˆä»¥åŠå¯é€‰çš„ç”¨æˆ·æ•°æ®å’Œä¾›åº”å•†æ•°æ®ï¼‰å³å¯åˆå§‹åŒ–ä¸€ä¸ªäº‘ä¸»æœºå®ä¾‹ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œcloud-init å°†è¯»å–æ‰€æä¾›çš„å…ƒæ•°æ®ï¼Œè¯†åˆ«å®ƒæ‰€è¿è¡Œçš„å¹³å°å¹¶å®Œæˆç›¸åº”çš„ç³»ç»Ÿåˆå§‹åŒ–æ­¥éª¤ã€‚åˆå§‹åŒ–è¿‡ç¨‹æ¶‰åŠè®¾ç½®ç½‘ç»œå’Œå­˜å‚¨è®¾å¤‡ï¼Œé…ç½® SSH è®¿é—®å¯†é’¥åŠå…¶ä»–ç³»ç»Ÿé…ç½®ï¼Œè¿˜å¯å°†å¯é€‰çš„ç”¨æˆ·æˆ–ä¾›åº”å•†æ•°æ®ä¼ é€’ç»™å®ä¾‹ã€‚&lt;/p>
&lt;p>cloud-init å¤§å¹…ç®€åŒ–äº†äº‘ä¸»æœºçš„å¤æ‚é…ç½®è¿‡ç¨‹ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ï¼Œå°±å¯ä»¥åœ¨ä¸åŒçš„äº‘å¹³å°åˆ›å»ºå‡ºç›¸åŒè§„æ ¼çš„ä¸»æœºå®ä¾‹ã€‚&lt;/p>
&lt;h2 id="é…ç½®æ¨¡æ¿é•œåƒ">é…ç½®æ¨¡æ¿é•œåƒ&lt;/h2>
&lt;p>ä¸‹è½½çš„åˆå§‹é•œåƒå¹¶ä¸èƒ½ç›´æ¥ä¸Šä¼ åˆ°äº‘ä¸»æœºå¹³å°ä½¿ç”¨ï¼Œå¦åˆ™åˆ›å»ºçš„è™šæ‹Ÿæœºæ— æ³•é€šè¿‡ SSH ç™»å½•ï¼Œä¼šæç¤ºå¦‚ä¸‹ç±»ä¼¼é”™è¯¯ï¼ˆSSH ç”¨æˆ·åªèƒ½ä½¿ç”¨é•œåƒé»˜è®¤çš„ &lt;code>ubuntu&lt;/code> ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ubuntu@10.10.40.125: Permission denied &lt;span class="o">(&lt;/span>publickey&lt;span class="o">)&lt;/span>.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸‹é¢éœ€è¦ä½¿ç”¨ä¸€äº›è™šæ‹Ÿæœºç®¡ç†å·¥å…·ï¼ŒåŸºäºæ¨¡æ¿é•œåƒè¿è¡Œä¸€ä¸ªè™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºä¸­å®Œæˆæ‰€éœ€é…ç½®ï¼Œæœ€ç»ˆå°†æ¨¡æ¿é•œåƒä¿®æ”¹è‡³å¯ç›´æ¥ä½¿ç”¨çš„é•œåƒã€‚&lt;/p>
&lt;h3 id="å®‰è£…è™šæ‹Ÿæœºç®¡ç†å·¥å…·">å®‰è£…è™šæ‹Ÿæœºç®¡ç†å·¥å…·&lt;/h3>
&lt;p>ä»¥ä¸‹å®‰è£…å‘½ä»¤åŸºäº &lt;code>CentOS&lt;/code>ï¼Œå…¶ä»–å‘è¡Œç‰ˆæœ¬ä¹Ÿå¯é€šè¿‡å¯¹åº”çš„åŒ…ç®¡ç†ç³»ç»Ÿä¸‹è½½æ‰€éœ€å·¥å…·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ yum install -y libvirt-client cloud-utils virt-install libguestfs-tools
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åˆ›å»ºæ¨¡æ¿é•œåƒå¹¶é…ç½®ç£ç›˜å¤§å°">åˆ›å»ºæ¨¡æ¿é•œåƒå¹¶é…ç½®ç£ç›˜å¤§å°&lt;/h3>
&lt;p>åŸºäºåˆå§‹é•œåƒåˆ›å»ºæ¨¡æ¿é•œåƒï¼Œå¹¶å‘½åä¸º &lt;code>root-disk.qcow2&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ qemu-img convert -f qcow2 -O qcow2 ubuntu-20.04-server-cloudimg-amd64.img root-disk.qcow2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ ¹æ®éœ€è¦ï¼Œè®¾ç½®åŸºäºè¯¥æ¨¡æ¿é•œåƒæ‰€åˆ›å»ºçš„è™šæ‹Ÿæœºç£ç›˜å¤§å°ï¼Œç¤ºä¾‹è®¾ç½®ä¸º 50Gï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ qemu-img resize root-disk.qcow2 50G
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å‡†å¤‡-cloud-init-é…ç½®">å‡†å¤‡ cloud-init é…ç½®&lt;/h3>
&lt;p>å‡è®¾å°†ä½¿ç”¨çš„é»˜è®¤ä¸»æœºåå’Œå¯†ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nv">VM_NAME&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;ubuntu-vm&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nv">PASSWORD&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;thisIsMyPassword&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”¨äºæµ‹è¯•å¼€å‘çš„è™šæ‹Ÿæœºï¼Œå¯é…ç½®ä¸ºç›´æ¥ä½¿ç”¨ &lt;code>root&lt;/code> ç”¨æˆ·å¹¶ä»¥å¯†ç ç™»å½•ï¼Œä½†åˆ‡å‹¿ç”¨äºç”Ÿäº§ç”¨é€”ã€‚ç”Ÿäº§ç¯å¢ƒé•œåƒéœ€ä½¿ç”¨æ™®é€šç”¨æˆ·åŠ  &lt;code>sudo&lt;/code> æƒé™ä»¥åŠ &lt;code>public key&lt;/code> ç­‰æ›´å®‰å…¨çš„ç™»å½•é€”å¾„ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª cloud-init çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰ä¸»æœºåå’Œå¯†ç ç­‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;#cloud-config
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">system_info:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> default_user:
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> name: ubuntu
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> home: /home/ubuntu
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">password: &lt;/span>&lt;span class="nv">$PASSWORD&lt;/span>&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">chpasswd: { expire: False }
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">hostname: &lt;/span>&lt;span class="nv">$VM_NAME&lt;/span>&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"># é…ç½® sshd å…è®¸ä½¿ç”¨å¯†ç ç™»å½•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">ssh_pwauth: True
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="p">|&lt;/span> tee cloud-init.cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœè¿˜éœ€è¦å¯¹ä¸»æœºåšæ›´å¤šé…ç½®ï¼Œå¯å‚è€ƒ &lt;code>cloud-init&lt;/code> çš„æ–‡æ¡£ç¤ºä¾‹ï¼š&lt;/p>
&lt;p>&lt;a href="https://cloudinit.readthedocs.io/en/latest/topics/examples.html#">Cloud config examples - cloud-init 21.4 documentation&lt;/a>&lt;/p>
&lt;p>ç„¶åä½¿ç”¨ &lt;code>cloud-localds&lt;/code> åŸºäºé…ç½®æ–‡ä»¶åˆ›å»º ISO é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cloud-localds cloud-init.iso cloud-init.cfg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸºäºæ¨¡æ¿é•œåƒä»¥åŠé…ç½®é•œåƒå®‰è£…è™šæ‹Ÿæœºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ virt-install &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --name &lt;span class="nv">$VM_NAME&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --memory &lt;span class="m">1024&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --disk root-disk.qcow2,device&lt;span class="o">=&lt;/span>disk,bus&lt;span class="o">=&lt;/span>virtio &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --disk cloud-init.iso,device&lt;span class="o">=&lt;/span>cdrom &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --os-type linux &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --os-variant ubuntu20.04 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --virt-type kvm &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --graphics none &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --network &lt;span class="nv">network&lt;/span>&lt;span class="o">=&lt;/span>default,model&lt;span class="o">=&lt;/span>virtio &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --import
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘½ä»¤è¿è¡ŒæˆåŠŸåä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„ç»ˆç«¯ä¼šè¯ï¼Œåœ¨è‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œä¹‹åï¼Œå°†å¯ä»¥ç”¨ä¸Šæ–‡è®¾ç½®çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•æ‰€åˆ›å»ºçš„è™šæ‹Ÿæœºã€‚&lt;/p>
&lt;h2 id="åˆå§‹åŒ–è™šæ‹Ÿæœº">åˆå§‹åŒ–è™šæ‹Ÿæœº&lt;/h2>
&lt;p>è¿›å…¥è¿è¡Œä¸­çš„è™šæ‹Ÿæœºåï¼Œæˆ‘ä»¬å¸Œæœ›è¿›è¡Œä¸€äº›ä¸ç™»å½•ç›¸å…³çš„åˆå§‹åŒ–é…ç½®ã€‚ä»¥ä¸‹æ“ä½œä»¥ Ubuntu 20.04 ä¸ºä¾‹ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€åŒºåˆ«ã€‚&lt;/p>
&lt;h3 id="å…è®¸ä»¥-root-ç”¨æˆ·ç™»å½•">å…è®¸ä»¥ &lt;code>root&lt;/code> ç”¨æˆ·ç™»å½•&lt;/h3>
&lt;p>Ubuntu 20.04 é»˜è®¤çš„ SSH é…ç½®ä¸å…è®¸ä»¥ root ç”¨æˆ·ç™»å½•ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ &lt;code>/etc/ssh/sshd_config&lt;/code> æ–‡ä»¶å°† &lt;code>PermitRootLogin prohibit-password&lt;/code> é…ç½®æ›´æ”¹ä¸º &lt;code>PermitRootLogin yes&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ sed -i &lt;span class="s1">&amp;#39;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/&amp;#39;&lt;/span> /etc/ssh/sshd_config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡å¯ SSH æœåŠ¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ systemctl restart ssh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è®¾ç½®-root-ç”¨æˆ·å¯†ç ">è®¾ç½® &lt;code>root&lt;/code> ç”¨æˆ·å¯†ç &lt;/h3>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ Ubuntu 20.04 æœªè®¾ç½® root ç”¨æˆ·å¯†ç ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨ root ç”¨æˆ·ç™»å½•ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡ &lt;code>passwd&lt;/code> å‘½ä»¤åˆå§‹åŒ– root ç”¨æˆ·çš„å¯†ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ passwd root
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯†ç è®¾ç½®å®Œæ¯•åï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥ &lt;code>ctrl&lt;/code>Â +Â &lt;code>]&lt;/code> é€€å‡ºè™šæ‹Ÿæœºä¼šè¯ï¼Œå¹¶é€šè¿‡ &lt;code>virsh&lt;/code> å‘½ä»¤è·å–è¿è¡Œä¸­è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼Œæµ‹è¯•æ˜¯å¦èƒ½é€šè¿‡ &lt;code>root&lt;/code> ç”¨æˆ· SSH ç™»å½•è™šæ‹Ÿæœºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ virsh domifaddr ubuntu-vm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Name MAC address Protocol Address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">----------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> vnet0 52:54:00:1b:3b:4f ipv4 192.168.122.201/24
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ssh root@192.168.122.201
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root@ubuntu-vm:~$
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç™»é™†æˆåŠŸåï¼Œå¯ä»¥åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå…¶ä»–åˆå§‹åŒ–æ“ä½œï¼Œå¦‚å®‰è£…åŸºç¡€ä¾èµ–ã€é…ç½®é•œåƒæºç­‰ã€‚&lt;/p>
&lt;p>æœ€ååœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œå…³é—­å‘½ä»¤é€€å‡ºä¼šè¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ shutdown -h now
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ¸…ç†ä¸å‹ç¼©é•œåƒ">æ¸…ç†ä¸å‹ç¼©é•œåƒ&lt;/h2>
&lt;p>åœ¨ &lt;code>virt-install&lt;/code> æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè™šæ‹Ÿæœºä¼šå°†è™šæ‹Ÿç½‘å¡çš„ Mac åœ°å€è®°å½•åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œä½†æ¯ä¸€æ¬¡åŸºäºé•œåƒå¯åŠ¨è™šæ‹Ÿæœºéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ Mac åœ°å€ï¼Œå› æ­¤éœ€è¦å°†é•œåƒä¸­å·²ç»å†™å…¥é…ç½®æ–‡ä»¶çš„ Mac åœ°å€æ¸…é™¤æ‰ã€‚&lt;/p>
&lt;p>é™¤äº†è¿›å…¥è™šæ‹Ÿæœºæ‰‹åŠ¨æ¸…é™¤ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ä¸Šæ–‡å·²å®‰è£…çš„ä¸“é—¨å·¥å…·æ¥æ¸…ç†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ virt-sysprep -d &lt;span class="nv">$VM_NAME&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 0.0&lt;span class="o">]&lt;/span> Examining the guest ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 25.7&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;abrt-data&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 25.7&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;backup-files&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.4&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;bash-history&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.4&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;blkid-tab&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;crash-data&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;cron-spool&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;dhcp-client-state&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;dhcp-server-state&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;dovecot-data&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.5&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;logfiles&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span> 26.7&lt;span class="o">]&lt;/span> Performing &lt;span class="s2">&amp;#34;machine-id&amp;#34;&lt;/span> ...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‘½ä»¤è¿˜å°†æ‰§è¡Œæ¸…é™¤æ“ä½œå†å²ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚&lt;/p>
&lt;p>æ¥ç€åœ¨ libvirt ä¸­æ³¨é”€å·²åˆ›å»ºçš„è™šæ‹Ÿæœºå®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ virsh undefine &lt;span class="nv">$VM_NAME&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">åŸŸ qfusion-vm å·²ç»è¢«å–æ¶ˆå®šä¹‰
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶å¯¹è™šæ‹Ÿæœºæ‰€åšçš„æ›´æ”¹éƒ½å·²å†™å…¥åˆ° &lt;code>root-disk.qcow2&lt;/code> æ¨¡æ¿é•œåƒä¸­ï¼Œå°†å…¶ä¸Šä¼ åˆ°äº‘ä¸»æœºå¹³å°çš„é•œåƒæœåŠ¡å™¨ï¼Œå°±å¯ä»¥åŸºäºå·²å†™å…¥çš„é…ç½®é‡å¤åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºå®ä¾‹ã€‚&lt;/p>
&lt;p>å¦‚æœæ­¤æ—¶é•œåƒä½“ç§¯è¾ƒå¤§ï¼Œå¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯å¯¹é•œåƒä½“ç§¯è¿›è¡Œå‹ç¼©ï¼Œå¹¶ä½¿ç”¨å‹ç¼©å¾—åˆ°çš„ &lt;code>ubuntu-20.04.qcow2&lt;/code> é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ qemu-img convert -f qcow2 -O qcow2 -c root-disk.qcow2 ubuntu-20.04.qcow2
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œé•œåƒå¤§å°ä» 7 ä¸ªå¤š G å‹ç¼©åˆ°äº† 500M å·¦å³ï¼Œæ•ˆæœæ˜¾è‘—ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://blog.programster.org/create-ubuntu-20-kvm-guest-from-cloud-image">https://blog.programster.org/create-ubuntu-20-kvm-guest-from-cloud-image&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.openstack.org/image-guide/ubuntu-image.html">https://docs.openstack.org/image-guide/ubuntu-image.html&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@art.vasilyev/use-ubuntu-cloud-image-with-kvm-1f28c19f82f8">https://medium.com/@art.vasilyev/use-ubuntu-cloud-image-with-kvm-1f28c19f82f8&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/qemu/" term="qemu" label="qemu"/><category scheme="https://waynerv.com/tags/kvm/" term="kvm" label="kvm"/></entry><entry><title type="text">å¦‚ä½•ä½¿ç”¨ docker buildx æ„å»ºè·¨å¹³å° Go é•œåƒ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/building-multi-architecture-images-with-docker-buildx/"/><id>https://waynerv.com/posts/building-multi-architecture-images-with-docker-buildx/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-09-02T20:07:08+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">ä¸€æ¬¡æ„å»ºå¤šå¤„éƒ¨ç½²çš„é•œåƒåˆ†å‘å¤§å¹…æé«˜äº†åº”ç”¨çš„äº¤ä»˜æ•ˆç‡ï¼Œä½†è·¨å¹³å°çš„éƒ¨ç½²ä¾ç„¶æ˜¯ä¸ªæŒ‘æˆ˜ã€‚å½“éœ€è¦éƒ¨ç½²åº”ç”¨åˆ° ARM æ¶æ„ç­‰å…¶ä»–å¹³å°æ—¶ï¼Œåˆ©ç”¨ docker buildx æ„å»ºè·¨å¹³å°çš„é•œåƒæ˜¯ä¸ªå¿«æ·é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚</summary><content type="html">&lt;p>åœ¨ä¸åŒæ“ä½œç³»ç»Ÿå’Œå¤„ç†å™¨æ¶æ„ä¸Šè¿è¡Œåº”ç”¨æ˜¯å¾ˆæ™®éçš„åœºæ™¯ï¼Œå› æ­¤ä¸ºä¸åŒå¹³å°å•ç‹¬æ„å»ºå‘å¸ƒç‰ˆæœ¬æ˜¯ä¸€ç§å¸¸è§åšæ³•ã€‚å½“æˆ‘ä»¬ç”¨æ¥å¼€å‘åº”ç”¨çš„å¹³å°ä¸éƒ¨ç½²çš„ç›®æ ‡å¹³å°ä¸åŒæ—¶ï¼Œå®ç°è¿™ä¸€ç›®æ ‡å¹¶ä¸å®¹æ˜“ã€‚ä¾‹å¦‚åœ¨ x86 æ¶æ„ä¸Šå¼€å‘ä¸€ä¸ªåº”ç”¨ç¨‹åºå¹¶å°†å…¶éƒ¨ç½²åˆ° ARM å¹³å°çš„æœºå™¨ä¸Šï¼Œé€šå¸¸éœ€è¦å‡†å¤‡ ARM å¹³å°çš„åŸºç¡€è®¾æ–½ç”¨äºå¼€å‘å’Œç¼–è¯‘ã€‚&lt;/p>
&lt;p>ä¸€æ¬¡æ„å»ºå¤šå¤„éƒ¨ç½²çš„é•œåƒåˆ†å‘å¤§å¹…æé«˜äº†åº”ç”¨çš„äº¤ä»˜æ•ˆç‡ï¼Œå¯¹äºéœ€è¦è·¨å¹³å°éƒ¨ç½²åº”ç”¨çš„åœºæ™¯ï¼Œåˆ©ç”¨ docker buildx æ„å»ºè·¨å¹³å°çš„é•œåƒä¹Ÿæ˜¯ä¸€ç§å¿«æ·é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;h2 id="å‰æ">å‰æ&lt;/h2>
&lt;p>å¤§éƒ¨åˆ†é•œåƒæ‰˜ç®¡å¹³å°æ”¯æŒå¤šå¹³å°é•œåƒï¼Œè¿™æ„å‘³ç€é•œåƒä»“åº“ä¸­å•ä¸ªæ ‡ç­¾å¯ä»¥åŒ…å«ä¸åŒå¹³å°çš„å¤šä¸ªé•œåƒï¼Œä»¥ &lt;code>docker hub&lt;/code> çš„ &lt;code>python&lt;/code> é•œåƒä»“åº“ä¸ºä¾‹ï¼Œ&lt;code>3.9.6&lt;/code> è¿™ä¸ªæ ‡ç­¾å°±åŒ…å«äº† 10 ä¸ªä¸åŒç³»ç»Ÿå’Œæ¶æ„çš„é•œåƒï¼ˆå¹³å° = ç³»ç»Ÿ + æ¶æ„ï¼‰ï¼š&lt;/p>
&lt;p>&lt;img src="2020-09-02-python-multi-arch-images.png" alt="Untitled">&lt;/p>
&lt;p>é€šè¿‡ &lt;code>docker pull&lt;/code> æˆ– &lt;code>docker run&lt;/code> æ‹‰å–ä¸€ä¸ªæ”¯æŒè·¨å¹³å°çš„é•œåƒæ—¶ï¼Œ&lt;code>docker&lt;/code> ä¼šè‡ªåŠ¨é€‰æ‹©ä¸å½“å‰è¿è¡Œå¹³å°ç›¸åŒ¹é…çš„é•œåƒã€‚ç”±äºè¯¥ç‰¹æ€§çš„å­˜åœ¨ï¼Œåœ¨è¿›è¡Œé•œåƒçš„è·¨å¹³å°åˆ†å‘æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹é•œåƒçš„æ¶ˆè´¹åšä»»ä½•å¤„ç†ï¼Œåªéœ€è¦å…³å¿ƒé•œåƒçš„ç”Ÿäº§ï¼Œå³å¦‚ä½•æ„å»ºè·¨å¹³å°çš„é•œåƒã€‚&lt;/p>
&lt;h2 id="docker-buildx">docker buildx&lt;/h2>
&lt;p>é»˜è®¤çš„ &lt;code>docker build&lt;/code> å‘½ä»¤æ— æ³•å®Œæˆè·¨å¹³å°æ„å»ºä»»åŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ä¸º &lt;code>docker&lt;/code> å‘½ä»¤è¡Œå®‰è£… &lt;code>buildx&lt;/code> æ’ä»¶æ‰©å±•å…¶åŠŸèƒ½ã€‚&lt;code>buildx&lt;/code> èƒ½å¤Ÿä½¿ç”¨ç”± &lt;a href="https://github.com/moby/buildkit">Moby BuildKit&lt;/a> æä¾›çš„æ„å»ºé•œåƒé¢å¤–ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿåˆ›å»ºå¤šä¸ª builder å®ä¾‹ï¼Œåœ¨å¤šä¸ªèŠ‚ç‚¹å¹¶è¡Œåœ°æ‰§è¡Œæ„å»ºä»»åŠ¡ï¼Œä»¥åŠè·¨å¹³å°æ„å»ºã€‚&lt;/p>
&lt;h3 id="å¯ç”¨-buildx">å¯ç”¨ Buildx&lt;/h3>
&lt;p>macOS æˆ– Windows ç³»ç»Ÿçš„ Docker Desktopï¼Œä»¥åŠ Linux å‘è¡Œç‰ˆé€šè¿‡ &lt;code>deb&lt;/code> æˆ–è€… &lt;code>rpm&lt;/code> åŒ…æ‰€å®‰è£…çš„ &lt;code>docker&lt;/code> å†…ç½®äº† &lt;code>buildx&lt;/code>ï¼Œä¸éœ€è¦å¦è¡Œå®‰è£…ã€‚&lt;/p>
&lt;p>å¦‚æœä½ çš„ &lt;code>docker&lt;/code> æ²¡æœ‰ &lt;code>buildx&lt;/code> å‘½ä»¤ï¼Œå¯ä»¥ä¸‹è½½äºŒè¿›åˆ¶åŒ…è¿›è¡Œå®‰è£…ï¼š&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆä» &lt;a href="https://github.com/docker/buildx/releases/latest">Docker buildx&lt;/a> é¡¹ç›®çš„ release é¡µé¢æ‰¾åˆ°é€‚åˆè‡ªå·±å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚&lt;/li>
&lt;li>ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶åˆ°æœ¬åœ°å¹¶é‡å‘½åä¸º &lt;code>docker-buildx&lt;/code>ï¼Œç§»åŠ¨åˆ° docker çš„æ’ä»¶ç›®å½• &lt;code>~/.docker/cli-plugins&lt;/code>ã€‚&lt;/li>
&lt;li>å‘äºŒè¿›åˆ¶æ–‡ä»¶æˆäºˆå¯æ‰§è¡Œæƒé™ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¦‚æœæœ¬åœ°çš„ &lt;code>docker&lt;/code> ç‰ˆæœ¬é«˜äº 19.03ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç›´æ¥åœ¨æœ¬åœ°æ„å»ºå¹¶å®‰è£…ï¼Œè¿™ç§æ–¹å¼æ›´ä¸ºæ–¹ä¾¿ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">DOCKER_BUILDKIT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker build --platform&lt;span class="o">=&lt;/span>&lt;span class="nb">local&lt;/span> -o . git://github.com/docker/buildx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir -p ~/.docker/cli-plugins
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mv buildx ~/.docker/cli-plugins/docker-buildx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ &lt;code>buildx&lt;/code> è¿›è¡Œæ„å»ºçš„æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">docker buildx build .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>buildx&lt;/code> å’Œ &lt;code>docker build&lt;/code> å‘½ä»¤çš„ä½¿ç”¨ä½“éªŒåŸºæœ¬ä¸€è‡´ï¼Œè¿˜æ”¯æŒ &lt;code>build&lt;/code> å¸¸ç”¨çš„é€‰é¡¹å¦‚ &lt;code>-t&lt;/code>ã€&lt;code>-f&lt;/code>ç­‰ã€‚&lt;/p>
&lt;h3 id="builder-å®ä¾‹">builder å®ä¾‹&lt;/h3>
&lt;p>&lt;code>docker buildx&lt;/code> é€šè¿‡ builder å®ä¾‹å¯¹è±¡æ¥ç®¡ç†æ„å»ºé…ç½®å’ŒèŠ‚ç‚¹ï¼Œå‘½ä»¤è¡Œå°†æ„å»ºä»»åŠ¡å‘é€è‡³ builder å®ä¾‹ï¼Œå†ç”± builder æŒ‡æ´¾ç»™ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹æ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥åŸºäºåŒä¸€ä¸ª &lt;code>docker&lt;/code> æœåŠ¡ç¨‹åºåˆ›å»ºå¤šä¸ª builder å®ä¾‹ï¼Œæä¾›ç»™ä¸åŒçš„é¡¹ç›®ä½¿ç”¨ä»¥éš”ç¦»å„ä¸ªé¡¹ç›®çš„é…ç½®ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸€ç»„è¿œç¨‹ &lt;code>docker&lt;/code> èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ª builder å®ä¾‹ç»„æˆæ„å»ºé˜µåˆ—ï¼Œå¹¶åœ¨ä¸åŒé˜µåˆ—ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ã€‚&lt;/p>
&lt;p>ä½¿ç”¨ &lt;code>docker buildx create&lt;/code> å‘½ä»¤å¯ä»¥åˆ›å»º builder å®ä¾‹ï¼Œè¿™å°†ä»¥å½“å‰ä½¿ç”¨çš„ docker æœåŠ¡ä¸ºèŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–°çš„ builder å®ä¾‹ã€‚è¦ä½¿ç”¨ä¸€ä¸ªè¿œç¨‹èŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨åˆ›å»ºç¤ºä¾‹æ—¶é€šè¿‡ &lt;code>DOCKER_HOST&lt;/code> ç¯å¢ƒå˜é‡æŒ‡å®šè¿œç¨‹ç«¯å£æˆ–æå‰åˆ‡æ¢åˆ°è¿œç¨‹èŠ‚ç‚¹çš„ &lt;code>docker context&lt;/code>ã€‚ä¸‹é¢ä»¥è¿œç¨‹èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªæ–°çš„ builder å®ä¾‹å¹¶é€šè¿‡å‘½ä»¤è¡Œé€‰é¡¹æŒ‡å®šå…¶é©±åŠ¨ã€ç›®æ ‡å¹³å°å’Œå®ä¾‹åç§°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">export&lt;/span> &lt;span class="nv">DOCKER_HOST&lt;/span>&lt;span class="o">=&lt;/span>tcp://10.10.150.66:2375
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker buildx create --driver docker-container --platform linux/amd64,linux/arm64 --name remote-builder
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote-builder
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>docker buildx ls&lt;/code> å°†åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ builder å®ä¾‹å’Œå®ä¾‹ä¸­çš„èŠ‚ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker buildx ls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">NAME/NODE DRIVER/ENDPOINT STATUS PLATFORMS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">remote-builder docker-container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> remote-builder0 tcp://10.10.150.66:2375 inactive linux/amd64*, linux/arm64*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">default * docker
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> default default running linux/amd64, linux/386
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®ä¾‹åˆ›å»ºä¹‹åå¯ä»¥ç»§ç»­å‘å®ƒæ·»åŠ æ–°çš„èŠ‚ç‚¹ï¼Œé€šè¿‡ &lt;code>docker buildx create&lt;/code> å‘½ä»¤çš„ &lt;code>--append &amp;lt;node&amp;gt;&lt;/code> é€‰é¡¹å¯å°†èŠ‚ç‚¹åŠ å…¥åˆ° &lt;code>--name &amp;lt;builder&amp;gt;&lt;/code> é€‰é¡¹æŒ‡å®šçš„ builder å®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> $ docker buildx create --name default --append remote-builder0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>docker buildx inspect&lt;/code>ã€&lt;code>docker buildx stop&lt;/code> å’Œ &lt;code>docker buildx rm&lt;/code> å‘½ä»¤ç”¨äºç®¡ç†ä¸€ä¸ªå®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚&lt;/p>
&lt;p>&lt;code>docker buildx use &amp;lt;builder&amp;gt;&lt;/code> å°†åˆ‡æ¢åˆ°æ‰€æŒ‡å®šçš„ builder å®ä¾‹ã€‚&lt;/p>
&lt;h3 id="æ„å»ºé©±åŠ¨">æ„å»ºé©±åŠ¨&lt;/h3>
&lt;p>buildx å®ä¾‹é€šè¿‡ä¸¤ç§æ–¹å¼æ¥æ‰§è¡Œæ„å»ºä»»åŠ¡ï¼Œä¸¤ç§æ‰§è¡Œæ–¹å¼è¢«ç§°ä¸ºä½¿ç”¨ä¸åŒçš„ã€Œé©±åŠ¨ã€ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>docker&lt;/code> é©±åŠ¨ï¼šä½¿ç”¨ Docker æœåŠ¡ç¨‹åºä¸­é›†æˆçš„ BuildKit åº“æ‰§è¡Œæ„å»ºã€‚&lt;/li>
&lt;li>&lt;code>docker-container&lt;/code> é©±åŠ¨ï¼šå¯åŠ¨ä¸€ä¸ªåŒ…å« BuildKit çš„å®¹å™¨å¹¶åœ¨å®¹å™¨ä¸­æ‰§è¡Œæ„å»ºã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>docker&lt;/code> é©±åŠ¨æ— æ³•ä½¿ç”¨ä¸€å°éƒ¨åˆ† &lt;code>buildx&lt;/code> çš„ç‰¹æ€§ï¼ˆå¦‚åœ¨ä¸€æ¬¡è¿è¡Œä¸­åŒæ—¶æ„å»ºå¤šä¸ªå¹³å°é•œåƒï¼‰ï¼Œæ­¤å¤–åœ¨é•œåƒçš„é»˜è®¤è¾“å‡ºæ ¼å¼ä¸Šä¹Ÿæœ‰æ‰€åŒºåˆ«ï¼š&lt;code>docker&lt;/code> é©±åŠ¨é»˜è®¤å°†æ„å»ºç»“æœä»¥ Docker é•œåƒæ ¼å¼ç›´æ¥è¾“å‡ºåˆ° &lt;code>docker&lt;/code> çš„é•œåƒç›®å½•ï¼ˆé€šå¸¸æ˜¯ &lt;code>/var/lib/overlay2&lt;/code>ï¼‰ï¼Œä¹‹åæ‰§è¡Œ &lt;code>docker images&lt;/code> å‘½ä»¤å¯ä»¥åˆ—å‡ºæ‰€è¾“å‡ºçš„é•œåƒï¼›è€Œ &lt;code>docker container&lt;/code> åˆ™éœ€è¦é€šè¿‡ &lt;code>--output&lt;/code> é€‰é¡¹æŒ‡å®šè¾“å‡ºæ ¼å¼ä¸ºé•œåƒæˆ–å…¶ä»–æ ¼å¼ã€‚&lt;/p>
&lt;p>ä¸ºäº†ä¸€æ¬¡æ€§æ„å»ºå¤šä¸ªå¹³å°çš„é•œåƒï¼Œä¸‹æ–‡å°†ä½¿ç”¨ &lt;code>docker container&lt;/code> é©±åŠ¨çš„ builder å®ä¾‹ã€‚&lt;/p>
&lt;h2 id="buildx-çš„è·¨å¹³å°æ„å»ºç­–ç•¥">buildx çš„è·¨å¹³å°æ„å»ºç­–ç•¥&lt;/h2>
&lt;p>æ ¹æ®æ„å»ºèŠ‚ç‚¹å’Œç›®æ ‡ç¨‹åºè¯­è¨€ä¸åŒï¼Œ&lt;code>buildx&lt;/code> æ”¯æŒä»¥ä¸‹ä¸‰ç§è·¨å¹³å°æ„å»ºç­–ç•¥ï¼š&lt;/p>
&lt;ol>
&lt;li>é€šè¿‡ QEMU çš„ç”¨æˆ·æ€æ¨¡å¼åˆ›å»ºè½»é‡çº§çš„è™šæ‹Ÿæœºï¼Œåœ¨è™šæ‹Ÿæœºç³»ç»Ÿä¸­æ„å»ºé•œåƒã€‚&lt;/li>
&lt;li>åœ¨ä¸€ä¸ª builder å®ä¾‹ä¸­åŠ å…¥å¤šä¸ªä¸åŒç›®æ ‡å¹³å°çš„èŠ‚ç‚¹ï¼Œé€šè¿‡åŸç”ŸèŠ‚ç‚¹æ„å»ºå¯¹åº”å¹³å°é•œåƒã€‚&lt;/li>
&lt;li>åˆ†é˜¶æ®µæ„å»ºå¹¶ä¸”äº¤å‰ç¼–è¯‘åˆ°ä¸åŒçš„ç›®æ ‡æ¶æ„ã€‚&lt;/li>
&lt;/ol>
&lt;p>QEMU é€šå¸¸ç”¨äºæ¨¡æ‹Ÿå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡ç”¨æˆ·æ€æ¨¡å¼è¿è¡Œï¼šä»¥ &lt;code>binfmt_misc&lt;/code> åœ¨å®¿ä¸»æœºç³»ç»Ÿä¸­æ³¨å†Œä¸€ä¸ªäºŒè¿›åˆ¶è½¬æ¢å¤„ç†ç¨‹åºï¼Œå¹¶åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€ç¿»è¯‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦å°†ç³»ç»Ÿè°ƒç”¨ä»ç›®æ ‡ CPU æ¶æ„è½¬æ¢ä¸ºå½“å‰ç³»ç»Ÿçš„ CPU æ¶æ„ã€‚æœ€ç»ˆçš„æ•ˆæœå°±åƒåœ¨ä¸€ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œç›®æ ‡ CPU æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚Docker Desktop å†…ç½®äº† QEMU æ”¯æŒï¼Œå…¶ä»–æ»¡è¶³è¿è¡Œè¦æ±‚çš„å¹³å°å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker run --privileged --rm tonistiigi/binfmt --install all
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ç§æ–¹å¼ä¸éœ€è¦å¯¹å·²æœ‰çš„ Dockerfile åšä»»ä½•ä¿®æ”¹ï¼Œå®ç°çš„æˆæœ¬å¾ˆä½ï¼Œä½†æ˜¾è€Œæ˜“è§æ•ˆç‡å¹¶ä¸é«˜ã€‚&lt;/p>
&lt;p>å°†ä¸åŒç³»ç»Ÿæ¶æ„çš„åŸç”ŸèŠ‚ç‚¹æ·»åŠ åˆ° builder å®ä¾‹ä¸­å¯ä»¥ä¸ºè·¨å¹³å°ç¼–è¯‘å¸¦æ¥æ›´å¥½çš„æ”¯æŒï¼Œè€Œä¸”æ•ˆç‡æ›´é«˜ï¼Œä½†éœ€è¦æœ‰è¶³å¤Ÿçš„åŸºç¡€è®¾æ–½æ”¯æŒã€‚&lt;/p>
&lt;p>å¦‚æœæ„å»ºé¡¹ç›®æ‰€ä½¿ç”¨çš„ç¨‹åºè¯­è¨€æ”¯æŒäº¤å‰ç¼–è¯‘ï¼ˆå¦‚ C å’Œ Goï¼‰ï¼Œå¯ä»¥åˆ©ç”¨ Dockerfile æä¾›çš„åˆ†é˜¶æ®µæ„å»ºç‰¹æ€§ï¼šé¦–å…ˆåœ¨å’Œæ„å»ºèŠ‚ç‚¹ç›¸åŒçš„æ¶æ„ä¸­ç¼–è¯‘å‡ºç›®æ ‡æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå†å°†è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æ¶æ„çš„å¦ä¸€é•œåƒä¸­ã€‚ä¸‹æ–‡ä¼šä½¿ç”¨ Go å®ç°ä¸€ä¸ªå…·ä½“çš„ç¤ºä¾‹ã€‚è¿™ç§æ–¹å¼ä¸éœ€è¦é¢å¤–çš„ç¡¬ä»¶ï¼Œä¹Ÿèƒ½å¾—åˆ°è¾ƒå¥½çš„æ€§èƒ½ï¼Œä½†åªæœ‰ç‰¹å®šç¼–ç¨‹è¯­è¨€èƒ½å¤Ÿå®ç°ã€‚&lt;/p>
&lt;h2 id="ä¸€æ¬¡æ„å»ºå¤šä¸ªæ¶æ„-go-é•œåƒå®è·µ">ä¸€æ¬¡æ„å»ºå¤šä¸ªæ¶æ„ Go é•œåƒå®è·µ&lt;/h2>
&lt;h3 id="æºä»£ç å’Œ-dockerfile">æºä»£ç å’Œ Dockerfile&lt;/h3>
&lt;p>ä¸‹é¢å°†ä»¥ä¸€ä¸ªç®€å•çš„ Go é¡¹ç›®ä½œä¸ºç¤ºä¾‹ï¼Œå‡è®¾ç¤ºä¾‹ç¨‹åºæ–‡ä»¶ &lt;code>main.go&lt;/code> å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s">&amp;#34;runtime&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Println&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello world!&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Running in [%s] architecture.\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">runtime&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">GOARCH&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®šä¹‰æ„å»ºè¿‡ç¨‹çš„ Dockerfile å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> --platform=$BUILDPLATFORM golang:1.14 as builder&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ARG&lt;/span> TARGETARCH&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /app&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> main.go /app/main.go&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$TARGETARCH&lt;/span> go build -a -o output/main main.go&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">FROM&lt;/span>&lt;span class="s"> alpine:latest&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /root&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> --from&lt;span class="o">=&lt;/span>builder /app/output/main .&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">CMD&lt;/span> /root/main&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ„å»ºè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ä¸€é˜¶æ®µä¸­ï¼Œæˆ‘ä»¬å°†æ‹‰å–ä¸€ä¸ªå’Œå½“å‰æ„å»ºèŠ‚ç‚¹ç›¸åŒå¹³å°çš„ &lt;code>golang&lt;/code> é•œåƒï¼Œå¹¶ä½¿ç”¨ Go çš„äº¤å‰ç¼–è¯‘ç‰¹æ€§å°†å…¶ç¼–è¯‘ä¸ºç›®æ ‡æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚&lt;/li>
&lt;li>ç„¶åæ‹‰å–ç›®æ ‡å¹³å°çš„ &lt;code>alpine&lt;/code> é•œåƒï¼Œå¹¶å°†ä¸Šä¸€é˜¶æ®µçš„ç¼–è¯‘ç»“æœæ‹·è´åˆ°é•œåƒä¸­ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æ‰§è¡Œè·¨å¹³å°æ„å»º">æ‰§è¡Œè·¨å¹³å°æ„å»º&lt;/h3>
&lt;p>æ‰§è¡Œæ„å»ºå‘½ä»¤æ—¶ï¼Œé™¤äº†æŒ‡å®šé•œåƒåç§°ï¼Œå¦å¤–ä¸¤ä¸ªé‡è¦çš„é€‰é¡¹æ˜¯æŒ‡å®šç›®æ ‡å¹³å°å’Œè¾“å‡ºæ ¼å¼ã€‚&lt;/p>
&lt;p>&lt;code>docker buildx build&lt;/code> é€šè¿‡ &lt;code>--platform&lt;/code> é€‰é¡¹æŒ‡å®šæ„å»ºçš„ç›®æ ‡å¹³å°ã€‚Dockerfile ä¸­çš„ FROM æŒ‡ä»¤å¦‚æœæ²¡æœ‰è®¾ç½® &lt;code>--platform&lt;/code> æ ‡å¿—ï¼Œå°±ä¼šä»¥ç›®æ ‡å¹³å°æ‹‰å–åŸºç¡€é•œåƒï¼Œæœ€ç»ˆç”Ÿæˆçš„é•œåƒä¹Ÿå°†å±äºç›®æ ‡å¹³å°ã€‚æ­¤å¤– Dockerfile ä¸­å¯é€šè¿‡ &lt;code>BUILDPLATFORM&lt;/code>ã€&lt;code>TARGETPLATFORM&lt;/code>ã€&lt;code>BUILDARCH&lt;/code> å’Œ &lt;code>TARGETARCH&lt;/code> ç­‰å‚æ•°ä½¿ç”¨è¯¥é€‰é¡¹çš„å€¼ã€‚å½“ä½¿ç”¨ &lt;code>docker-container&lt;/code> é©±åŠ¨æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹å¯ä»¥æ¥å—ç”¨é€—å·åˆ†éš”çš„å¤šä¸ªå€¼ä½œä¸ºè¾“å…¥ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡å¹³å°ï¼Œæ‰€æœ‰å¹³å°çš„æ„å»ºç»“æœå°†åˆå¹¶ä¸ºä¸€ä¸ªæ•´ä½“çš„é•œåƒåˆ—è¡¨ä½œä¸ºè¾“å‡ºï¼Œå› æ­¤æ— æ³•ç›´æ¥è¾“å‡ºä¸ºæœ¬åœ°çš„ &lt;code>docker images&lt;/code> é•œåƒã€‚&lt;/p>
&lt;p>&lt;code>docker buildx build&lt;/code> æ”¯æŒä¸°å¯Œçš„è¾“å‡ºè¡Œä¸ºï¼Œé€šè¿‡&lt;code>--output=[PATH,-,type=TYPE[,KEY=VALUE]&lt;/code> é€‰é¡¹å¯ä»¥æŒ‡å®šæ„å»ºç»“æœçš„è¾“å‡ºç±»å‹å’Œè·¯å¾„ç­‰ï¼Œå¸¸ç”¨çš„è¾“å‡ºç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š&lt;/p>
&lt;ul>
&lt;li>localï¼šæ„å»ºç»“æœå°†ä»¥æ–‡ä»¶ç³»ç»Ÿæ ¼å¼å†™å…¥ &lt;code>dest&lt;/code> æŒ‡å®šçš„æœ¬åœ°è·¯å¾„ï¼Œ å¦‚ &lt;code>--output type=local,dest=./output&lt;/code>ã€‚&lt;/li>
&lt;li>tarï¼šæ„å»ºç»“æœå°†åœ¨æ‰“åŒ…åå†™å…¥ &lt;code>dest&lt;/code> æŒ‡å®šçš„æœ¬åœ°è·¯å¾„ã€‚&lt;/li>
&lt;li>ociï¼šæ„å»ºç»“æœä»¥ OCI æ ‡å‡†é•œåƒæ ¼å¼å†™å…¥ &lt;code>dest&lt;/code> æŒ‡å®šçš„æœ¬åœ°è·¯å¾„ã€‚&lt;/li>
&lt;li>dockerï¼šæ„å»ºç»“æœä»¥ Docker æ ‡å‡†é•œåƒæ ¼å¼å†™å…¥ &lt;code>dest&lt;/code> æŒ‡å®šçš„æœ¬åœ°è·¯å¾„æˆ–åŠ è½½åˆ° &lt;code>docker&lt;/code> çš„é•œåƒåº“ä¸­ã€‚åŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡å¹³å°æ—¶æ— æ³•ä½¿ç”¨è¯¥é€‰é¡¹ã€‚&lt;/li>
&lt;li>imageï¼šä»¥é•œåƒæˆ–è€…é•œåƒåˆ—è¡¨è¾“å‡ºï¼Œå¹¶æ”¯æŒ &lt;code>push=true&lt;/code> é€‰é¡¹ç›´æ¥æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ŒåŒæ—¶æŒ‡å®šå¤šä¸ªç›®æ ‡å¹³å°æ—¶å¯ä½¿ç”¨è¯¥é€‰é¡¹ã€‚&lt;/li>
&lt;li>registryï¼š&lt;code>type=image,push=true&lt;/code> çš„ç²¾ç®€è¡¨ç¤ºã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯¹æœ¬ç¤ºä¾‹æˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹ &lt;code>docker buildx build&lt;/code> å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker buildx build --platform linux/amd64,linux/arm64,linux/arm -t registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo -o &lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>registry .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‘½ä»¤å°†åœ¨å½“å‰ç›®å½•åŒæ—¶æ„å»º &lt;code>linux/amd64&lt;/code>ã€ &lt;code>linux/arm64&lt;/code> å’Œ &lt;code>linux/arm&lt;/code> ä¸‰ç§å¹³å°çš„é•œåƒï¼Œå¹¶å°†è¾“å‡ºç»“æœç›´æ¥æ¨é€åˆ°è¿œç¨‹çš„é˜¿é‡Œäº‘é•œåƒä»“åº“ä¸­ã€‚&lt;/p>
&lt;p>æ„å»ºè¿‡ç¨‹å¯æ‹†è§£å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>docker&lt;/code> å°†æ„å»ºä¸Šä¸‹æ–‡ä¼ è¾“ç»™ builder å®ä¾‹ã€‚&lt;/li>
&lt;li>builder ä¸ºå‘½ä»¤è¡Œ &lt;code>--platform&lt;/code> é€‰é¡¹æŒ‡å®šçš„æ¯ä¸€ä¸ªç›®æ ‡å¹³å°æ„å»ºé•œåƒï¼ŒåŒ…æ‹¬æ‹‰å–åŸºç¡€é•œåƒå’Œæ‰§è¡Œæ„å»ºæ­¥éª¤ã€‚&lt;/li>
&lt;li>å¯¼å‡ºæ„å»ºç»“æœï¼Œé•œåƒæ–‡ä»¶å±‚è¢«æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚&lt;/li>
&lt;li>ç”Ÿæˆä¸€ä¸ªæ¸…å• JSON æ–‡ä»¶ï¼Œå¹¶å°†å…¶ä½œä¸ºé•œåƒæ ‡ç­¾æ¨é€ç»™è¿œç¨‹ä»“åº“ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="éªŒè¯æ„å»ºç»“æœ">éªŒè¯æ„å»ºç»“æœ&lt;/h3>
&lt;p>è¿è¡Œç»“æŸåå¯ä»¥é€šè¿‡ &lt;code>docker buildx imagetools&lt;/code> æ¢æŸ¥å·²æ¨é€åˆ°è¿œç¨‹ä»“åº“çš„é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker buildx imagetools inspect registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Name: registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">MediaType: application/vnd.docker.distribution.manifest.list.v2+json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Digest: sha256:e2c3c5b330c19ac9d09f8aaccc40224f8673e12b88ff59cb68971c36b76e95ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Manifests:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Name: registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest@sha256:cb6a7614ee3db03c8858e3680b1585f32a6fe3de9b371e37e25cf42a83f6e0ba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MediaType: application/vnd.docker.distribution.manifest.v2+json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Platform: linux/amd64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Name: registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest@sha256:034aa0077a452a6c2585f8b4969c7c85d5d2bf65f801fcc803a00d0879ce900e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MediaType: application/vnd.docker.distribution.manifest.v2+json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Platform: linux/arm64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Name: registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest@sha256:db0ee3a876fb789d2e733471385eef0a056f64ee12d9e7ef94e411469d054eb5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> MediaType: application/vnd.docker.distribution.manifest.v2+json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Platform: linux/arm/v7
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€ååœ¨ä¸åŒçš„å¹³å°ä»¥ &lt;code>latest&lt;/code> æ ‡ç­¾æ‹‰å–å¹¶è¿è¡Œé•œåƒï¼ŒéªŒè¯æ„å»ºç»“æœæ˜¯å¦æ­£ç¡®ã€‚
ä½¿ç”¨ Docker Desktop æ—¶ï¼Œå…¶æœ¬èº«é›†æˆçš„è™šæ‹ŸåŒ–åŠŸèƒ½å¯ä»¥è¿è¡Œä¸åŒå¹³å°çš„é•œåƒï¼Œå¯ä»¥ç›´æ¥ä»¥ &lt;code>sha256&lt;/code> å€¼æ‹‰å–é•œåƒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker run --rm registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest@sha256:cb6a7614ee3db03c8858e3680b1585f32a6fe3de9b371e37e25cf42a83f6e0ba
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hello world!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running in &lt;span class="o">[&lt;/span>amd64&lt;span class="o">]&lt;/span> architecture.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker run --rm registry.cn-hangzhou.aliyuncs.com/waynerv/arch-demo:latest@sha256:034aa0077a452a6c2585f8b4969c7c85d5d2bf65f801fcc803a00d0879ce900e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Hello world!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running in &lt;span class="o">[&lt;/span>arm64&lt;span class="o">]&lt;/span> architecture.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¦‚ä½•äº¤å‰ç¼–è¯‘-golang-çš„-cgo-é¡¹ç›®">å¦‚ä½•äº¤å‰ç¼–è¯‘ Golang çš„ CGO é¡¹ç›®&lt;/h2>
&lt;p>æ”¯æŒäº¤å‰ç¼–è¯‘åˆ°å¸¸è§çš„æ“ä½œç³»ç»Ÿå’Œ CPU æ¶æ„æ˜¯ Golang çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œä½†ä»¥ä¸Šç¤ºä¾‹ä¸­çš„è§£å†³æ–¹æ¡ˆåªé€‚ç”¨äºçº¯ Go ä»£ç ï¼Œå¦‚æœé¡¹ç›®ä¸­é€šè¿‡ &lt;code>cgo&lt;/code> è°ƒç”¨äº† C ä»£ç ï¼Œæƒ…å†µä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚&lt;/p>
&lt;h3 id="å‡†å¤‡äº¤å‰ç¼–è¯‘ç¯å¢ƒå’Œä¾èµ–">å‡†å¤‡äº¤å‰ç¼–è¯‘ç¯å¢ƒå’Œä¾èµ–&lt;/h3>
&lt;p>ä¸ºäº†èƒ½å¤Ÿé¡ºåˆ©ç¼–è¯‘ C ä»£ç åˆ°ç›®æ ‡å¹³å°ï¼Œé¦–å…ˆéœ€è¦åœ¨ç¼–è¯‘ç¯å¢ƒä¸­å®‰è£…ç›®æ ‡å¹³å°çš„ C äº¤å‰ç¼–è¯‘å™¨ï¼ˆé€šå¸¸åŸºäº &lt;code>gcc&lt;/code>ï¼‰ï¼Œå¸¸ç”¨çš„ Linux å‘è¡Œç‰ˆä¼šæä¾›å¤§éƒ¨åˆ†å¹³å°çš„äº¤å‰ç¼–è¯‘å™¨å®‰è£…åŒ…ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…ã€‚&lt;/p>
&lt;p>å…¶æ¬¡è¿˜éœ€è¦å®‰è£…ç›®æ ‡å¹³å°çš„ C æ ‡å‡†åº“ï¼ˆé€šå¸¸æ ‡å‡†åº“ä¼šä½œä¸ºäº¤å‰ç¼–è¯‘å™¨çš„å®‰è£…ä¾èµ–ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…ï¼‰ï¼Œå¦å¤–å–å†³äºä½ æ‰€è°ƒç”¨çš„ C ä»£ç çš„ä¾èµ–å…³ç³»ï¼Œå¯èƒ½è¿˜éœ€è¦å®‰è£…ä¸€äº›é¢å¤–çš„ C ä¾èµ–åº“ï¼ˆå¦‚ &lt;code>libopus-dev&lt;/code> ä¹‹ç±»ï¼‰ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°†ä½¿ç”¨ &lt;code>amd64&lt;/code> æ¶æ„çš„ &lt;code>golang:1.14&lt;/code> å®˜æ–¹é•œåƒä½œä¸ºåŸºç¡€é•œåƒæ‰§è¡Œç¼–è¯‘ï¼Œå…¶ä½¿ç”¨çš„ Linux å‘è¡Œç‰ˆä¸º Debianã€‚å‡è®¾äº¤å‰ç¼–è¯‘çš„ç›®æ ‡å¹³å°æ˜¯ &lt;code>linux/arm64&lt;/code>ï¼Œåˆ™éœ€è¦å‡†å¤‡çš„äº¤å‰ç¼–è¯‘å™¨ä¸º &lt;code>gcc-aarch64-linux-gnu&lt;/code>ï¼ŒC æ ‡å‡†åº“ä¸º &lt;code>libc6-dev-arm64-cross&lt;/code>ï¼Œå®‰è£…æ–¹å¼ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ apt-get install gcc-aarch64-linux-gnu
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>libc6-dev-arm64-cross&lt;/code> ä¼šåŒæ—¶è¢«å®‰è£…ã€‚&lt;/p>
&lt;p>å¾—ç›Šäº Debian åŒ…ç®¡ç†å™¨ &lt;code>dpkg&lt;/code> æä¾›çš„å¤šæ¶æ„å®‰è£…èƒ½åŠ›ï¼Œå‡å¦‚æˆ‘ä»¬çš„ä»£ç ä¾èµ– &lt;code>libopus-dev&lt;/code> ç­‰éæ ‡å‡†åº“ï¼Œå¯é€šè¿‡ &lt;code>&amp;lt;library&amp;gt;:&amp;lt;architecture&amp;gt;&lt;/code> çš„æ–¹å¼å®‰è£…å…¶ &lt;code>arm64&lt;/code> æ¶æ„çš„å®‰è£…åŒ…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ dpkg --add-architecture arm64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ apt-get update
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ apt-get install -y libopus-dev:arm64
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="äº¤å‰ç¼–è¯‘-cgo-ç¤ºä¾‹">äº¤å‰ç¼–è¯‘ CGO ç¤ºä¾‹&lt;/h3>
&lt;p>å‡è®¾æœ‰å¦‚ä¸‹ &lt;code>cgo&lt;/code> çš„ç¤ºä¾‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">package&lt;/span> &lt;span class="nx">main&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">/*
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">#include &amp;lt;stdlib.h&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cm">*/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;C&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="s">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Random&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">C&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">random&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">Seed&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">C&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">srandom&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">C&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nb">uint&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">i&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kd">func&lt;/span> &lt;span class="nf">main&lt;/span>&lt;span class="p">()&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">rand&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="nf">Random&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">fmt&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Printf&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Hello %d\n&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">rand&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°†ä½¿ç”¨çš„ Dockerfile å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-dockerfile" data-lang="dockerfile">&lt;span class="line">&lt;span class="cl">&lt;span class="k">FROM&lt;/span>&lt;span class="s"> --platform=$BUILDPLATFORM golang:1.14 as builder&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">ARG&lt;/span> TARGETARCH&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> apt-get update &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> apt-get install -y gcc-aarch64-linux-gnu&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">WORKDIR&lt;/span>&lt;span class="s"> /app&lt;/span>&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">COPY&lt;/span> . /app/&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">&lt;/span>&lt;span class="k">RUN&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$TARGETARCH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s2">&amp;#34;arm64&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span> &lt;span class="nv">CC&lt;/span>&lt;span class="o">=&lt;/span>aarch64-linux-gnu-gcc &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="nv">CC_FOR_TARGET&lt;/span>&lt;span class="o">=&lt;/span>gcc-aarch64-linux-gnu&lt;span class="p">;&lt;/span> &lt;span class="k">fi&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> &lt;span class="nv">CGO_ENABLED&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span> &lt;span class="nv">GOOS&lt;/span>&lt;span class="o">=&lt;/span>linux &lt;span class="nv">GOARCH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$TARGETARCH&lt;/span> &lt;span class="nv">CC&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CC&lt;/span> &lt;span class="nv">CC_FOR_TARGET&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$CC_FOR_TARGET&lt;/span> go build -a -ldflags &lt;span class="s1">&amp;#39;-extldflags &amp;#34;-static&amp;#34;&amp;#39;&lt;/span> -o /main main.go&lt;span class="err">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Dockerfile ä¸­é€šè¿‡ &lt;code>apt-get&lt;/code> å®‰è£…äº† &lt;code>gcc-aarch64-linux-gnu&lt;/code> ä½œä¸ºäº¤å‰ç¼–è¯‘å™¨ï¼Œç¤ºä¾‹ç¨‹åºè¾ƒä¸ºç®€å•å› æ­¤ä¸éœ€è¦é¢å¤–çš„ä¾èµ–åº“ã€‚åœ¨æ‰§è¡Œ &lt;code>go build&lt;/code> è¿›è¡Œç¼–è¯‘æ—¶ï¼Œéœ€è¦é€šè¿‡ &lt;code>CC&lt;/code> å’Œ &lt;code>CC_FOR_TARGET&lt;/code> ç¯å¢ƒå˜é‡æŒ‡å®šæ‰€ä½¿ç”¨çš„äº¤å‰ç¼–è¯‘å™¨ã€‚&lt;/p>
&lt;p>ä¸ºäº†åŸºäºåŒä¸€ä»½ Dockerfile æ‰§è¡Œå¤šä¸ªç›®æ ‡å¹³å°çš„ç¼–è¯‘ï¼ˆå‡è®¾ç›®æ ‡æ¶æ„åªæœ‰ &lt;code>amd64&lt;/code>/&lt;code>arm64&lt;/code>ï¼‰ï¼Œæœ€ä¸‹æ–¹çš„ &lt;code>RUN&lt;/code> æŒ‡ä»¤ä½¿ç”¨äº†ä¸€ä¸ªå°æŠ€å·§ï¼Œé€šè¿‡ Bash çš„æ¡ä»¶åˆ¤æ–­è¯­æ³•æ¥æ‰§è¡Œä¸åŒçš„ç¼–è¯‘å‘½ä»¤ï¼š&lt;/p>
&lt;ul>
&lt;li>å‡å¦‚æ„å»ºä»»åŠ¡çš„ç›®æ ‡å¹³å°æ˜¯ &lt;code>arm64&lt;/code>ï¼Œåˆ™æŒ‡å®š &lt;code>CC&lt;/code> å’Œ &lt;code>CC_FOR_TARGET&lt;/code> ç¯å¢ƒå˜é‡ä¸ºå·²å®‰è£…çš„äº¤å‰ç¼–è¯‘å™¨ï¼ˆæ³¨æ„å®ƒä»¬çš„å€¼æœ‰æ‰€ä¸åŒï¼‰ã€‚&lt;/li>
&lt;li>å‡å¦‚æ„å»ºä»»åŠ¡çš„ç›®æ ‡å¹³å°æ˜¯ &lt;code>amd64&lt;/code>ï¼Œåˆ™ä¸æŒ‡å®šäº¤å‰ç¼–è¯‘å™¨ç›¸å…³çš„å˜é‡ï¼Œæ­¤æ—¶å°†ä½¿ç”¨é»˜è®¤çš„ &lt;code>gcc&lt;/code> ä½œä¸ºç¼–è¯‘å™¨ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ€åä½¿ç”¨ buildx æ‰§è¡Œæ„å»ºçš„å‘½ä»¤å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">$ docker buildx build --platform linux/amd64,linux/arm64 -t registry.cn-hangzhou.aliyuncs.com/waynerv/cgo-demo -o &lt;span class="nv">type&lt;/span>&lt;span class="o">=&lt;/span>registry .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æœ‰äº† &lt;code>Buildx&lt;/code> æ’ä»¶çš„å¸®åŠ©ï¼Œåœ¨ç¼ºå°‘åŸºç¡€è®¾æ–½çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½ä½¿ç”¨ &lt;code>docker&lt;/code> æ–¹ä¾¿åœ°æ„å»ºè·¨å¹³å°çš„åº”ç”¨é•œåƒã€‚&lt;/p>
&lt;p>ä½†é»˜è®¤é€šè¿‡ QEMU è™šæ‹ŸåŒ–ç›®æ ‡å¹³å°æŒ‡ä»¤çš„æ–¹å¼æœ‰æ˜æ˜¾åœ°æ€§èƒ½ç“¶é¢ˆï¼Œå¦‚æœç¼–å†™åº”ç”¨çš„è¯­è¨€æ”¯æŒäº¤å‰ç¼–è¯‘ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»“åˆ &lt;code>buildx&lt;/code> å’Œäº¤å‰ç¼–è¯‘è·å¾—æ›´é«˜çš„æ•ˆç‡ã€‚&lt;/p>
&lt;p>æœ¬æ–‡æœ€åä»‹ç»äº†ä¸€ç§è¿›é˜¶åœºæ™¯çš„è§£å†³æ–¹æ¡ˆï¼šå¦‚ä½•å¯¹ä½¿ç”¨äº† CGO çš„ Golang é¡¹ç›®è¿›è¡Œäº¤å‰ç¼–è¯‘ï¼Œå¹¶ç»™å‡ºäº†ç¼–è¯‘åˆ° &lt;code>linux/arm64&lt;/code> å¹³å°çš„ç¤ºä¾‹ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.docker.com/desktop/multi-arch/">Leverage multi-CPU architecture support&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.docker.com/buildx/working-with-buildx/#build-with-buildx">Docker Buildx&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.docker.com/engine/reference/commandline/buildx_build/#output">docker buildx build&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://go.dev/blog/cgo">C? Go? Cgo! - go.dev&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dh1tw.de/2019/12/cross-compiling-golang-cgo-projects/">Cross-Compiling Golang (CGO) Projects&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/golang/" term="Golang" label="Golang"/><category scheme="https://waynerv.com/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" term="äº‘åŸç”Ÿ" label="äº‘åŸç”Ÿ"/><category scheme="https://waynerv.com/tags/docker/" term="Docker" label="Docker"/></entry><entry><title type="text">å¦‚ä½•æ‰‹åŠ¨å®‰è£… Nginx äºŒè¿›åˆ¶æ–‡ä»¶</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/how-to-install-nginx-binary-manually/"/><id>https://waynerv.com/posts/how-to-install-nginx-binary-manually/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-08-11T15:47:32+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯å¦‚ç¦»çº¿æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨åŒ…ç®¡ç†å™¨è€Œåªèƒ½ç”¨æ‰‹åŠ¨æ–¹å¼æ¥å®‰è£…ç‰¹å®šè½¯ä»¶ï¼Œæœ¬æ–‡å°†è®°å½•å¦‚ä½•å°†ä¸€ä¸ªå·²ç¼–è¯‘å¥½çš„ Nginx äºŒè¿›åˆ¶æ–‡ä»¶æ‰‹åŠ¨å®‰è£…åˆ° Linux ç³»ç»Ÿä¸­ã€‚</summary><content type="html">&lt;p>åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯å¦‚ç¦»çº¿æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨åŒ…ç®¡ç†å™¨è€Œåªèƒ½ç”¨æ‰‹åŠ¨æ–¹å¼æ¥å®‰è£…ç‰¹å®šè½¯ä»¶ï¼Œè¿™æ—¶æ¨èçš„åšæ³•æ˜¯ä»æºç è‡ªè¡Œç¼–è¯‘å®‰è£…ï¼Œé€šå¸¸æ¥è¯´ &lt;code>configure + make install&lt;/code> ä¸¤æ­¥å³å¯å®Œæˆã€‚&lt;/p>
&lt;p>å‡å¦‚æˆ‘ä»¬åªèƒ½è·å–å·²ç¼–è¯‘å¥½çš„ç¨‹åºæˆ–è€…æ²¡æœ‰ç¼–è¯‘ç¯å¢ƒï¼Œå°±åªèƒ½æ‰‹åŠ¨æ‰§è¡Œå®‰è£…æ­¥éª¤äº†ã€‚æœ¬æ–‡å°†è®°å½•å¦‚ä½•å°†ä¸€ä¸ªå·²ç¼–è¯‘å¥½çš„ Nginx äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…åˆ° Linux ç³»ç»Ÿä¸­ã€‚&lt;/p>
&lt;h2 id="prefix-é…ç½®">prefix é…ç½®&lt;/h2>
&lt;p>å¯¹å®‰è£… nginx æ¥è¯´ï¼Œæœ€éœ€è¦æ³¨æ„çš„æ˜¯ &lt;code>prefix&lt;/code> è·¯å¾„é…ç½®ï¼Œé»˜è®¤å€¼ä¸º &lt;code>/usr/local/nginx&lt;/code>ï¼Œå®ƒæ˜¯ nginx è¿è¡Œæ—¶çš„åŸºç¡€è·¯å¾„ï¼š&lt;/p>
&lt;ul>
&lt;li>nginx å°†ä»è¯¥è·¯å¾„å¯»æ‰¾é…ç½®æ–‡ä»¶ &lt;code>nginx.conf&lt;/code>ã€‚&lt;/li>
&lt;li>nginx ä½¿ç”¨çš„å…¶ä»–è·¯å¾„çš„é»˜è®¤å€¼ä¹Ÿå‡åŸºäºè¯¥è·¯å¾„ï¼Œå¦‚ &lt;code>{prefix}/logs/error.log&lt;/code>ã€‚&lt;/li>
&lt;li>nginx æ‰€è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å¯¹è·¯å¾„å‡ç›¸å¯¹äºè¯¥åŸºç¡€è·¯å¾„ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç”±äºè¯¥é…ç½®åœ¨ç¼–è¯‘æ—¶å·²å†™å…¥ç¨‹åºä¸­ï¼Œæ­¤æ—¶æ— æ³•å†æ›´æ”¹ï¼Œä½†ä»ç„¶å¯ä»¥é€šè¿‡ &lt;code>-c&lt;/code> é€‰é¡¹åœ¨è¿è¡Œ nginx æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚åœ¨ä¸ç¡®å®š &lt;code>prefix&lt;/code> çš„å€¼æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶å¹¶æ·»åŠ  &lt;code>-V&lt;/code> é€‰é¡¹æŸ¥çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">nginx -V
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">nginx version: nginx/1.21.1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">built by gcc 8.3.0 &lt;span class="o">(&lt;/span>Debian 8.3.0-6&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">built with OpenSSL 1.1.1d &lt;span class="m">10&lt;/span> Sep &lt;span class="m">2019&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">configure arguments: --prefix&lt;span class="o">=&lt;/span>/etc/nginx --sbin-path&lt;span class="o">=&lt;/span>/usr/sbin/nginx --modules-path&lt;span class="o">=&lt;/span>/usr/lib/nginx/modules --conf-path&lt;span class="o">=&lt;/span>/etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ‹·è´ç¨‹åºåˆ°å¯æ‰§è¡Œè·¯å¾„">æ‹·è´ç¨‹åºåˆ°å¯æ‰§è¡Œè·¯å¾„&lt;/h2>
&lt;p>æˆ‘ä»¬é¦–å…ˆéœ€è¦å°†äºŒè¿›åˆ¶æ–‡ä»¶ç§»åŠ¨åˆ°å®¿ä¸»æœºï¼Œæ­¤æ—¶å»ºè®®å°†å…¶æ”¾åœ¨å¯æ‰§è¡Œè·¯å¾„å¦‚ &lt;code>/usr/sbin/&lt;/code> ä¸‹ï¼Œä¹‹åå°±ä¸éœ€è¦å†æŒ‡å®šå…·ä½“çš„è·¯å¾„è€Œæ˜¯ç›´æ¥é€šè¿‡ &lt;code>nginx&lt;/code> å‘½ä»¤å³å¯æ‰§è¡Œç¨‹åºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">chmod &lt;span class="m">0755&lt;/span> nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mv nginx /usr/sbin/nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ·»åŠ -systemd-unit-æ–‡ä»¶">æ·»åŠ  Systemd Unit æ–‡ä»¶&lt;/h2>
&lt;p>å¯¹äº nginx è¿™ç±»é•¿æ—¶é—´è¿è¡ŒæœåŠ¡å™¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œæ‰˜ç®¡ï¼Œä»¥å®ç°å¼€æœºå¯åŠ¨ã€è‡ªåŠ¨é‡å¯ç­‰åŠŸèƒ½ã€‚æœ€æ¨èçš„åšæ³•æ˜¯ä½¿ç”¨ systemd ä½œä¸ºæ‰˜ç®¡ç¨‹åºï¼Œå®ƒä¹Ÿæ˜¯ç›®å‰å¤§éƒ¨åˆ† Linux å‘è¡Œç‰ˆçš„é»˜è®¤åˆå§‹åŒ–ç³»ç»Ÿã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªåç§°ä¸º &lt;code>nginx.service&lt;/code> çš„ Unit æ–‡ä»¶ï¼Œå¹¶ç½®äº &lt;code>/usr/lib/systemd/system&lt;/code> ç›®å½•ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">touch /usr/lib/systemd/system/nginx.service
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>nginx.service&lt;/code> çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Unit&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Description&lt;/span>&lt;span class="o">=&lt;/span>The nginx HTTP and reverse proxy server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">After&lt;/span>&lt;span class="o">=&lt;/span>network.target remote-fs.target nss-lookup.target
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Service&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Type&lt;/span>&lt;span class="o">=&lt;/span>forking
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PIDFile&lt;/span>&lt;span class="o">=&lt;/span>/run/nginx.pid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># SELinux context. This might happen when running `nginx -t` from the cmdline.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStartPre&lt;/span>&lt;span class="o">=&lt;/span>/usr/bin/rm -f /run/nginx.pid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStartPre&lt;/span>&lt;span class="o">=&lt;/span>/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecStart&lt;/span>&lt;span class="o">=&lt;/span>/usr/sbin/nginx -c /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ExecReload&lt;/span>&lt;span class="o">=&lt;/span>/bin/kill -s HUP &lt;span class="nv">$MAINPID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KillSignal&lt;/span>&lt;span class="o">=&lt;/span>SIGQUIT
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">TimeoutStopSec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">5&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">KillMode&lt;/span>&lt;span class="o">=&lt;/span>process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PrivateTmp&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>Install&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">WantedBy&lt;/span>&lt;span class="o">=&lt;/span>multi-user.target
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ Unit æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº† nginx è¿™ä¸€ &lt;code>service&lt;/code> èµ„æºï¼Œå¹¶è®¾ç½®äº†å¯åŠ¨å‘½ä»¤å’Œä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ã€‚&lt;/p>
&lt;h2 id="nginxconf--é…ç½®æ–‡ä»¶">&lt;code>nginx.conf&lt;/code> é…ç½®æ–‡ä»¶&lt;/h2>
&lt;p>æˆ‘ä»¬é€šè¿‡ &lt;code>nginx.conf&lt;/code> é…ç½®æ–‡ä»¶æ¥æ§åˆ¶ nginx çš„å…·ä½“è¡Œä¸ºï¼Œåœ¨ Unit æ–‡ä»¶ä¸­æˆ‘ä»¬å·²å°†é…ç½®æ–‡ä»¶è·¯å¾„å®šä¹‰ä¸º &lt;code>/etc/nginx/nginx.conf&lt;/code>ï¼Œå› æ­¤é€šè¿‡ &lt;code>systemctl&lt;/code> å·¥å…·å¯åŠ¨ nginx æ—¶éƒ½ä¼šä»è¯¥è·¯å¾„è¯»å–é…ç½®ï¼Œç°åœ¨åˆ›å»ºè¯¥æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir /etc/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">touch /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>nginx.conf&lt;/code> çš„å†…å®¹å¯æ ¹æ®æˆ‘ä»¬çš„éœ€è¦è‡ªè¡Œå®šä¹‰ï¼Œä½†éœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>pid&lt;/code> æŒ‡ä»¤çš„å€¼å¿…é¡»å’Œ Unit æ–‡ä»¶ä¿æŒä¸€è‡´ï¼Œå³ &lt;code>pid /run/nginx.pid;&lt;/code>ã€‚&lt;/li>
&lt;li>æ‰€æœ‰è·¯å¾„ç±»æŒ‡ä»¤çš„ç›®å½•å¿…é¡»æå‰å­˜åœ¨ï¼Œå¦‚ &lt;code>error_log&lt;/code>ã€ &lt;code>access_log&lt;/code> å’Œ &lt;code>include&lt;/code>ï¼Œnginx ä¼šè‡ªåŠ¨åˆ›å»º log æ–‡ä»¶ä½†å¹¶ä¸ä¼šåˆ›å»ºå…¶ç›®å½•ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ¨èå°†è®¿é—®æ—¥å¿—å’Œå¼‚å¸¸æ—¥å¿—ä¿å­˜äº &lt;code>/var/log/nginx&lt;/code> ç›®å½•ï¼Œå°† &lt;code>http&lt;/code> é…ç½®éƒ¨åˆ†çš„å­é…ç½®ç½®äº &lt;code>/etc/nginx/&lt;/code> ç›®å½•ä¸‹ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºè¿è¡Œæ‰€éœ€ç›®å½•">åˆ›å»ºè¿è¡Œæ‰€éœ€ç›®å½•&lt;/h2>
&lt;p>åœ¨ &lt;code>nginx.conf&lt;/code> ä¸­æŒ‡å®šçš„é…ç½®è·¯å¾„ï¼Œéƒ½éœ€è¦æå‰å°†è·¯å¾„ç›®å½•åˆ›å»ºå¥½ï¼Œå¦åˆ™å¯åŠ¨ nginx æ—¶å°†ä¼šæŠ¥é”™ï¼Œå‡è®¾æˆ‘ä»¬åœ¨ &lt;code>nginx.conf&lt;/code> ä¸­æŒ‡å®šäº†å¦‚ä¸‹è·¯å¾„ç±»é…ç½®ï¼ˆä»…å±•ç¤ºéƒ¨åˆ†ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">error_log /var/log/nginx/error.log&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pid /run/nginx.pid&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">http &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> access_log /var/log/nginx/access.log main&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> include /etc/nginx/mime.types&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> include /etc/nginx/conf.d/*.conf&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ™éœ€è¦æå‰å‡†å¤‡å¥½ &lt;code>/etc/nginx/mime.types&lt;/code> æ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä»¥ä¸‹ç›®å½•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkdir -p /var/log/nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p /run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p /etc/nginx/conf.d
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœæˆ‘ä»¬åœ¨ &lt;code>nginx.conf&lt;/code> ä¸­ä½¿ç”¨äº†ç›¸å¯¹è·¯å¾„ï¼Œåˆ™éœ€è¦åŸºäº &lt;code>prefix&lt;/code> è·¯å¾„åˆ›å»ºç›¸åº”çš„ç›®å½•ã€‚&lt;/p>
&lt;p>åˆ°æ­¤æˆ‘ä»¬å°±å®Œæˆäº†æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œã€‚&lt;/p>
&lt;h2 id="å¯åŠ¨æˆ–é‡å¯-nginx">å¯åŠ¨æˆ–é‡å¯ nginx&lt;/h2>
&lt;p>ç°åœ¨å¯ä»¥é€šè¿‡ systemd æ¥å¯åŠ¨ nginx äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">systemctl start nginx &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> systemctl &lt;span class="nb">enable&lt;/span> nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„åœ¨ &lt;code>systemctl status nginx&lt;/code> çš„ç»“æœä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šåœ¨åˆå§‹çš„å¯åŠ¨æ—¥å¿—ä¸­çœ‹åˆ°å¦‚ä¸‹è­¦å‘Šï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>alert&lt;span class="o">]&lt;/span>: could not open error log file: open&lt;span class="o">()&lt;/span> &lt;span class="s2">&amp;#34;/usr/local/nginx/logs/error.log&amp;#34;&lt;/span> failed &lt;span class="o">(&lt;/span>13: Permission denied&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ˜¯å› ä¸º nginx åœ¨è¯»å– &lt;code>nginx.conf&lt;/code> ä¹‹å‰å°±ä¼šå…ˆæ‰“å¼€é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œæ­¤æ—¶å°†ä½¿ç”¨ç¼–è¯‘æ—¶æŒ‡å®šçš„ &lt;code>error-log-path&lt;/code> è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º &lt;code>{prefix}/logs/error.log&lt;/code>ï¼Œåœ¨è¯»å–äº† &lt;code>nginx.conf&lt;/code> ä¹‹åå°±ä¼šä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ &lt;code>error_log&lt;/code> æŒ‡å®šçš„è·¯å¾„ï¼Œå› æ­¤è¯¥é”™è¯¯åªæ˜¯ä¸€ä¸ªè­¦å‘Šï¼Œä¸ä¼šå½±å“ nginx çš„å¯åŠ¨ã€‚&lt;/p>
&lt;p>åœ¨é€šè¿‡ &lt;code>reload&lt;/code> é‡å¯ nginx æ—¶ï¼Œä¹Ÿéœ€è¦æ³¨æ„æ·»åŠ  &lt;code>-c&lt;/code> é€‰é¡¹æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">nginx -s reload -c /etc/nginx/nginx.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.nginx.com/nginx/admin-guide/installing-nginx/installing-nginx-open-source/#compiling-and-installing-from-source">Compiling and Installing from Source&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://serverfault.com/questions/308890/nginx-permission-13/338461">Nginx Permission 13&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://serverfault.com/questions/691310/nginx-relative-path-to-include">nginx relative path to include&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/nginx/" term="Nginx" label="Nginx"/></entry><entry><title type="text">å®¹å™¨æŠ€æœ¯åŸç†(äº”)ï¼šæ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»å’Œå…±äº«</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/container-fundamentals-filesystem-isolation-and-sharing/"/><id>https://waynerv.com/posts/container-fundamentals-filesystem-isolation-and-sharing/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-07-27T14:38:20+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">Unix ç³»ç»Ÿä¸­æ‰€æœ‰å¯è®¿é—®çš„æ–‡ä»¶éƒ½è¢«ç»„ç»‡åœ¨ä¸€ä¸ªå·¨å¤§çš„æ ‘çŠ¶æ–‡ä»¶å±‚æ¬¡ç»“æ„ä¸­ï¼Œè¿™é¢—æ–‡ä»¶æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ &lt;code>/&lt;/code> ç›®å½•ã€‚</summary><content type="html">&lt;h2 id="èƒŒæ™¯çŸ¥è¯†">èƒŒæ™¯çŸ¥è¯†&lt;/h2>
&lt;p>Unix ç³»ç»Ÿä¸­æ‰€æœ‰å¯è®¿é—®çš„æ–‡ä»¶éƒ½è¢«ç»„ç»‡åœ¨ä¸€ä¸ªå·¨å¤§çš„æ ‘çŠ¶æ–‡ä»¶å±‚æ¬¡ç»“æ„ä¸­ï¼Œè¿™é¢—æ–‡ä»¶æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ &lt;code>/&lt;/code> ç›®å½•ã€‚è¿™äº›æ–‡ä»¶å¯ä»¥åˆ†æ•£ä¿å­˜åœ¨ä¸åŒçš„è®¾å¤‡ä¸­ï¼Œå‰ææ˜¯æˆ‘ä»¬ä½¿ç”¨ &lt;code>mount&lt;/code> ç³»ç»Ÿè°ƒç”¨å°†è¿™äº›è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°æ–‡ä»¶æ ‘ä¸­ã€‚&lt;/p>
&lt;h3 id="ç›®å½•-vs-æ–‡ä»¶ç³»ç»Ÿ">ç›®å½• VS æ–‡ä»¶ç³»ç»Ÿ&lt;/h3>
&lt;p>äº†è§£æ–‡ä»¶ç³»ç»Ÿå’Œç›®å½•ä¹‹é—´çš„åŒºåˆ«æ˜¯å¾ˆé‡è¦çš„ã€‚æ–‡ä»¶ç³»ç»Ÿæ˜¯å­˜å‚¨è®¾å¤‡å¦‚ç¡¬ç›˜çš„ä¸€ä¸ªéƒ¨åˆ†ï¼Œå®ƒè¢«åˆ†é…æ¥ä¿å­˜æ–‡ä»¶æ•°æ®ã€‚åœ¨ç›®å½•ä¸ŠæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿåï¼Œå¯ä»¥è®¿é—®è¿™éƒ¨åˆ†å­˜å‚¨çš„æ–‡ä»¶ã€‚æ–‡ä»¶ç³»ç»Ÿè¢«æŒ‚è½½åï¼Œå¯¹ç»ˆç«¯ç”¨æˆ·æ¥è¯´è®¿é—®èµ·æ¥å°±åƒæ™®é€šç›®å½•ä¸€æ ·ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¸¸å¸¸æåˆ° &lt;code>ext&lt;/code> ã€&lt;code>xfs&lt;/code> å’Œ &lt;code>zfs&lt;/code> æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„ç±»å‹ï¼Œä¸åŒç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿå­˜å–å’Œç®¡ç†æ•°æ®çš„æ–¹å¼ä¸åŒï¼ŒLinux æ”¯æŒå¤šç§ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯-rootfs">ä»€ä¹ˆæ˜¯ &lt;code>rootfs&lt;/code>&lt;/h3>
&lt;p>&lt;code>rootfs&lt;/code> ï¼ˆRoot Filesystemï¼‰æ˜¯åˆ†å±‚æ–‡ä»¶æ ‘çš„é¡¶ç«¯ã€‚å®ƒåŒ…å«å¯¹ç³»ç»Ÿè¿è¡Œè‡³å…³é‡è¦çš„æ–‡ä»¶å’Œç›®å½•ï¼ŒåŒ…æ‹¬è®¾å¤‡ç›®å½•å’Œç”¨äºå¯åŠ¨ç³»ç»Ÿçš„ç¨‹åºã€‚&lt;code>rootfs&lt;/code> è¿˜åŒ…å«äº†è®¸å¤šæŒ‚è½½ç‚¹ï¼Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿå¯ä»¥é€šè¿‡è¿™äº›æŒ‚è½½ç‚¹è¿æ¥åˆ° &lt;code>rootfs&lt;/code> çš„æ–‡ä»¶æ ‘ä¸­ã€‚&lt;code>rootfs&lt;/code> é€šå¸¸ç”± Linux å‘è¡Œç‰ˆæä¾›ï¼Œä¸€ä¸ªå…¸å‹çš„ &lt;code>rootfs&lt;/code> å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ls /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">boot etc home lib64 mnt proc run srv tmp var
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bin dev lib media opt root sbin sys usr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–è¿›ç¨‹ä¼šå°† &lt;code>rootfs&lt;/code> æŒ‚è½½åˆ° &lt;code>/&lt;/code> ç›®å½•ï¼Œä¹‹åå†æŒ‚è½½å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿåˆ°å…¶å­ç›®å½•ä¸­ã€‚è¿™æœŸé—´æ‰€æœ‰çš„ &lt;code>mount&lt;/code> ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šè¢«è®°å½•åˆ°åˆå§‹åŒ–è¿›ç¨‹çš„ &lt;code>mount table&lt;/code> ä¸­ï¼Œæ‰€æœ‰çš„è¿›ç¨‹éƒ½æœ‰ä¸€å¼ ç‹¬ç«‹çš„ &lt;code>mount table&lt;/code>ï¼Œè®°å½•äº &lt;code>/proc/{PID}/mounts&lt;/code> ä¸­ã€‚ä½†ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç›´æ¥ä½¿ç”¨åˆå§‹åŒ–è¿›ç¨‹çš„ &lt;code>mount table&lt;/code>ã€‚&lt;/p>
&lt;h2 id="mount-namespace-çš„æœ¬è´¨å’Œå·¥ä½œæ–¹å¼">mount namespace çš„æœ¬è´¨å’Œå·¥ä½œæ–¹å¼&lt;/h2>
&lt;p>æ¯ä¸ªè¿›ç¨‹å¯ä»¥åˆ›å»ºå±äºè‡ªå·±çš„ &lt;code>mount table&lt;/code>ï¼Œä½†å‰ææ˜¯å¿…é¡»å…ˆå¤åˆ¶çˆ¶è¿›ç¨‹çš„ &lt;code>mount table&lt;/code>ï¼Œä¹‹åå†è°ƒç”¨ &lt;code>mount&lt;/code> å‘ç”Ÿçš„æ›´æ”¹éƒ½åªä¼šå½±å“å½“å‰è¿›ç¨‹çš„ &lt;code>mount table&lt;/code>ï¼Œè¿™å°±æ˜¯ mount namespace çš„å·¥ä½œåŸç†ã€‚å¦‚æœå¤šä¸ªè¿›ç¨‹åœ¨åŒä¸€ mount namespace å†…ï¼Œå…¶ä¸­ä¸€ä¸ªè¿›ç¨‹å¯¹ &lt;code>mount table&lt;/code> çš„æ›´æ”¹å¯¹å…¶ä»–è¿›ç¨‹æ¥è¯´ä¹Ÿæ˜¯å¯è§çš„ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬æ¥å®é™…æŸ¥çœ‹ç³»ç»Ÿä¸­å½“å‰å­˜åœ¨çš„æ‰€æœ‰ mount namespaceï¼Œè¿™éœ€è¦å€ŸåŠ©ä¹‹å‰çš„æ–‡ç« ä¸­ä»‹ç»è¿‡çš„ &lt;code>cinf&lt;/code> å·¥å…·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf &lt;span class="p">|&lt;/span> grep mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NAMESPACE TYPE NPROCS USERS CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026531840&lt;/span> mnt &lt;span class="m">130&lt;/span> 0,32,70,81,89,998,999 /sbin/init splash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026531860&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532320&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">997&lt;/span> /usr/sbin/chronyd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532389&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‘½ä»¤çš„è¾“å‡ºç»è¿‡ä¸€å®šå¤„ç†ä»¥å±•ç¤ºæ›´æ¸…æ™°çš„ä¿¡æ¯ï¼Œä»è¿›ç¨‹æ•°é‡ï¼ˆNPROCSï¼‰å¯ä»¥çœ‹åˆ°ç»å¤§éƒ¨åˆ†è¿›ç¨‹éƒ½ä½äºç”±åˆå§‹åŒ–è¿›ç¨‹ &lt;code>/sbin/init&lt;/code> åˆ›å»ºçš„ &lt;code>4026531840&lt;/code> mount namspace ä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ–°çš„è¿›ç¨‹å¹¶ä¸ä¼šåˆ›å»ºæ–°çš„ mount namespaceï¼Œå¦‚æœä½ æ‰“å°è¿™äº›è¿›ç¨‹çš„ &lt;code>mount table&lt;/code> å³ &lt;code>/proc/{PID}/mounts&lt;/code> ï¼Œä¼šå‘ç°è¾“å‡ºç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚&lt;/p>
&lt;p>åˆ›å»ºä¸€ä¸ªæ–°çš„ mount namespace æ—¶ï¼Œä¼šåœ¨æ–°çš„ mount namspace ä¸­åˆ›å»ºä¸€ä¸ªæ¥è‡ªçˆ¶å‘½åç©ºé—´çš„æŒ‚è½½ç‚¹å‰¯æœ¬ã€‚æˆ‘ä»¬å°†é€šè¿‡ &lt;code>unshare -m&lt;/code> åˆ›å»ºä¸€ä¸ªæ–°çš„ mount namespace æ¥éªŒè¯ï¼Œè¿˜å°†è¦ç”¨åˆ°æˆ‘ä»¬åœ¨å‰é¢çš„æ–‡ç« ä¸­é€šè¿‡ Docker é•œåƒåˆ›å»ºçš„ &lt;code>filesystem bundle&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mycontainer/rootfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">PS1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;\u@new-mnt$ &amp;#39;&lt;/span> unshare -Umr
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¯¥å‘½ä»¤åæˆ‘ä»¬è¿›å…¥åˆ°äº†ä¸€ä¸ªæ–°çš„ mount namespace ä¸­ï¼Œä½†ä¾ç„¶èƒ½çœ‹åˆ°å®¿ä¸»æœºä¸­çš„æ‰€æœ‰æŒ‚è½½ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ df -h
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ–‡ä»¶ç³»ç»Ÿ å®¹é‡ å·²ç”¨ å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/sdb3 119G 28G 86G 25% /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 7.8G &lt;span class="m">0&lt;/span> 7.8G 0% /dev/shm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 1.6G 1.9M 1.6G 1% /run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 5.0M 4.0K 5.0M 1% /run/lock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 1.6G 84K 1.6G 1% /run/user/121
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 1.6G 68K 1.6G 1% /run/user/0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tmpfs 4.0M &lt;span class="m">0&lt;/span> 4.0M 0% /sys/fs/cgroup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/sdb2 94G 5.8G 83G 7% /home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/sda2 96M 30M 67M 31% /boot/efi
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åè¿‡æ¥å½“æˆ‘ä»¬åœ¨æ–°çš„ mount namespace æ‰§è¡Œæ–°çš„æŒ‚è½½ï¼Œä»å®¿ä¸»æœºçœ‹ä¸åˆ°ç›¸åº”çš„è®°å½•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in new mount namspace&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mount -t tmpfs tmpfs /mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ findmnt &lt;span class="p">|&lt;/span> grep mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€/mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> tmpfs tmpfs rw,relatime,inode64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in host&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ findmnt &lt;span class="p">|&lt;/span> grep mnt
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™å°±æ˜¯ mount namespace çš„å·¥ä½œæ–¹å¼ã€‚&lt;/p>
&lt;h3 id="åœ¨å®¹å™¨ä¸­åˆ›å»ºæ–°çš„-mount-namespace">åœ¨å®¹å™¨ä¸­åˆ›å»ºæ–°çš„ mount namespace&lt;/h3>
&lt;p>ç°åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨æ¥çœ‹çœ‹ mount namespace çš„å˜åŒ–ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ runc run mybox
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸€ä¸ªæ–°çš„çª—å£ä¸­ï¼Œæˆ‘ä»¬ä»å®¿ä¸»æœºç¯å¢ƒä½¿ç”¨ &lt;code>cinf&lt;/code> æŸ¥è¯¢ namespaceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf &lt;span class="p">|&lt;/span> grep mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026531840&lt;/span> mnt &lt;span class="m">134&lt;/span> 0,32,70,81,89,998,999 /usr/lib/systemd/systemd --swi
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026531860&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532320&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">997&lt;/span> /usr/sbin/chronyd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532325&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532389&lt;/span> mnt &lt;span class="m">1&lt;/span> &lt;span class="m">0&lt;/span> sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¼šå‘ç°å¢åŠ äº†ä¸€ä¸ªæ–°çš„ mount namespace &lt;code>4026532325&lt;/code>ï¼Œåˆ›å»ºè¯¥ mount namespace çš„è¿›ç¨‹æ­£æ˜¯å®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf --namespace &lt;span class="m">4026532325&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PID PPID NAME CMD NTHREADS CGROUPS STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">7656&lt;/span> &lt;span class="m">7646&lt;/span> sh sh &lt;span class="m">1&lt;/span> 11:blkio:/mybox 10:devices:/mybox 9:pids:/mybox S &lt;span class="o">(&lt;/span>sleeping&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8:cpu,cpuacct:/mybox 7:net_cls,net_prio:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6:freezer:/mybox 5:memory:/mybox 4:cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3:hugetlb:/mybox 2:perf_event:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1:name&lt;span class="o">=&lt;/span>systemd:/user.slice/user-0.slice/session-1231.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ runc ps mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UID PID PPID C STIME TTY TIME CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">7656&lt;/span> &lt;span class="m">7646&lt;/span> &lt;span class="m">0&lt;/span> 14:39 pts/0 00:00:00 sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ›å»ºæ–°çš„ mount namspace å¹¶ä¸ä¼šåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ &lt;code>mount table&lt;/code>ï¼Œè€Œæ˜¯åœ¨çˆ¶è¿›ç¨‹çš„ mount namspace çš„å‰¯æœ¬ä¸Šè¿›è¡Œå˜æ›´ï¼Œå› æ­¤åœ¨åˆ›å»ºå®¹å™¨æ—¶ï¼Œæ–°çš„å®¹å™¨å®¹å™¨æ‹¥æœ‰å®¿ä¸»æœºçš„å…¨éƒ¨æŒ‚è½½ç‚¹ï¼Œè¿™æ˜¾ç„¶ä¸æˆ‘ä»¬çš„é¢„æœŸæ˜¯ä¸ç¬¦çš„ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨ &lt;code>filesystem bundle&lt;/code> ä¸­çš„ &lt;code>rootfs&lt;/code> ä¸ºå®¹å™¨å»ºç«‹ä¸€ä¸ªéš”ç¦»çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™è¦æ±‚æˆ‘ä»¬åœ¨æ–°çš„ mount namespace ä¸­ &lt;code>unmount&lt;/code> å½“å‰ &lt;code>rootfs&lt;/code>ï¼Œå¹¶å°† &lt;code>filesystem bundle&lt;/code> ä¸­çš„ &lt;code>rootfs&lt;/code> &lt;code>mount&lt;/code> åˆ° &lt;code>/&lt;/code> ç›®å½•ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«åœ¨å®¹å™¨å’Œå®¿ä¸»æœºä¸­ä½¿ç”¨ &lt;code>ls -id&lt;/code> æ‰“å° &lt;code>/&lt;/code> ç›®å½•çš„ &lt;code>inode&lt;/code> å·ç äºˆä»¥éªŒè¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åœ¨å®¹å™¨ä¸­æ‰“å° / ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls -id /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">7077890&lt;/span> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åœ¨å®¿ä¸»æœºä¸­æ‰“å° filesystem bundle ä¸­ rootfs æ‰€åœ¨ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls -id /mycontainer/rootfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">7077890&lt;/span> /mycontainer/rootfs
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ &lt;code>mount&lt;/code> æ— æ³•å®ç°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä½¿æ‰€æœ‰çš„è¿›ç¨‹åœæ­¢ä½¿ç”¨å½“å‰çš„ &lt;code>rootfs&lt;/code>ï¼Œå½“å‰çš„ &lt;code>rootfs&lt;/code> ä¸€å®šå¤„äºä½¿ç”¨çŠ¶æ€è€Œä¸èƒ½è¢« &lt;code>unmount&lt;/code>ã€‚ä½†å¯ä»¥é‡‡å–å¦ä¸€ç§é€”å¾„ï¼šä½¿ç”¨ &lt;code>pivot_root&lt;/code> ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå…è®¸æˆ‘ä»¬å°† &lt;code>rootfs&lt;/code> é‡æ–°æŒ‚è½½åˆ°ä¸€ä¸ªé &lt;code>/&lt;/code> çš„ä½ç½®ï¼ŒåŒæ—¶åœ¨ &lt;code>/&lt;/code> ç›®å½•ä¸ŠæŒ‚è½½ä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œå¹¶å°†æ‰€æœ‰å½“å‰è¿›ç¨‹çš„æ ¹ç›®å½•åˆ‡æ¢ä¸ºæ–°ç›®å½•ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥é¡ºåˆ© &lt;code>unmount&lt;/code> åŸæ¥çš„ &lt;code>rootfs&lt;/code>ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨-pivot_root-æˆ–-chroot-åˆ‡æ¢æ ¹ç›®å½•">ä½¿ç”¨ pivot_root æˆ– chroot åˆ‡æ¢æ ¹ç›®å½•&lt;/h2>
&lt;p>&lt;code>pivot_root&lt;/code> æ˜¯ç”± Linux æä¾›çš„ä¸€ç§ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€ä¸ª mount namespace ä¸­çš„æ‰€æœ‰è¿›ç¨‹çš„æ ¹ç›®å½•å’Œå½“å‰å·¥ä½œç›®å½•åˆ‡æ¢åˆ°ä¸€ä¸ªæ–°çš„ç›®å½•ã€‚&lt;code>pivot_root&lt;/code> çš„ä¸»è¦ç”¨é€”æ˜¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå…ˆæŒ‚è½½ä¸€ä¸ªä¸´æ—¶çš„ &lt;code>rootfs&lt;/code> å®Œæˆç‰¹å®šåŠŸèƒ½ï¼Œç„¶åå†åˆ‡æ¢åˆ°çœŸæ­£çš„ &lt;code>rootfs&lt;/code>ã€‚&lt;/p>
&lt;p>åˆ›å»ºå®¹å™¨çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨åˆ›å»ºæ–°çš„ mount namespace ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>pivot_root()&lt;/code> å°†å®¹å™¨å†…è¿›ç¨‹çš„æ ¹ç›®å½•åˆ‡æ¢åˆ° &lt;code>filesystem bundle&lt;/code> ä¸­çš„ &lt;code>rootfs&lt;/code> æ‰€åœ¨ç›®å½•ã€‚&lt;/p>
&lt;h3 id="chroot-å‘½ä»¤çš„ä½¿ç”¨ç¤ºä¾‹">chroot å‘½ä»¤çš„ä½¿ç”¨ç¤ºä¾‹&lt;/h3>
&lt;p>é™¤äº† &lt;code>pivot_root&lt;/code> ï¼ŒLinux è¿˜æä¾›äº† &lt;code>chroot&lt;/code> ç³»ç»Ÿè°ƒç”¨èƒ½å¤Ÿå°†å½“å‰è¿›ç¨‹çš„æ ¹ç›®å½•æ›´æ”¹ä¸ºä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œæ–°çš„æ ¹ç›®å½•è¿˜å°†è¢«å½“å‰è¿›ç¨‹çš„æ‰€æœ‰å­è¿›ç¨‹æ‰€ç»§æ‰¿ã€‚&lt;/p>
&lt;p>ä¸Šæ–‡æåˆ°çš„ &lt;code>pivot_root&lt;/code> å’Œ &lt;code>chroot&lt;/code> éƒ½æ˜¯ç”± Linux å†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬åˆ†åˆ«éƒ½æœ‰å‘½ä»¤è¡Œç¨‹åºå®ç°äº†å¯¹ç³»ç»Ÿè°ƒç”¨çš„ç®€å•å°è£…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ &lt;code>chroot&lt;/code> å‘½ä»¤ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ‡æ¢åˆ°æœ‰æ•ˆçš„ filesystem bundle ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ chroot rootfs /bin/sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿›å…¥åˆ°ä¸€ä¸ªæ–°çš„shellä¸­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">bin dev etc home old proc root sys tmp usr var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æ–°çš„ shell ç¨‹åºä¸­ï¼Œæ‰§è¡Œ &lt;code>ls&lt;/code> è¿”å›çš„æ˜¯ &lt;code>/mycontainer/rootfs&lt;/code> ç›®å½•ä¸‹çš„æ–‡ä»¶å†…å®¹ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºæ ¹ç›®å½•ä¸‹çš„å†…å®¹ã€‚é€šè¿‡ &lt;code>chroot&lt;/code> å‘½ä»¤ï¼Œåœ¨ä¸éœ€è¦ &lt;code>mount namespace&lt;/code> çš„æƒ…å†µä¸‹æˆ‘ä»¬ä¹Ÿå®ç°åˆ‡æ¢å®¹å™¨å†…è¿›ç¨‹æ ¹ç›®å½•çš„æ•ˆæœã€‚&lt;/p>
&lt;p>ç›¸æ¯” &lt;code>chroot&lt;/code>ï¼Œ&lt;code>pivot_root&lt;/code> ç³»ç»Ÿè°ƒç”¨é…åˆ mount namspace æ›´åŠ å®‰å…¨ï¼Œå®¹å™¨è¿è¡Œæ—¶ä¼šä¼˜å…ˆä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œä½† &lt;code>chroot&lt;/code> ä¹Ÿæ˜¯ä¸€ç§å¯é€‰çš„æ–¹å¼ã€‚åœ¨ &lt;code>runC&lt;/code> çš„å®ç°ä¸­æœ‰ä»¥ä¸‹ï¼ˆGolangï¼‰ä»£ç ç‰‡æ®µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NoPivotRoot&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">msMoveRoot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Rootfs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Namespaces&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Contains&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">configs&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NEWNS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">pivotRoot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">config&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Rootfs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">err&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nf">chroot&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¿½ç•¥ç¬¬ä¸€ä¸ªç”±ç”¨æˆ·æŒ‡å®šçš„ã€Œä¸åˆ‡æ¢æ ¹ç›®å½•ã€çš„é€‰æ‹©åˆ†æ”¯ï¼Œå…¶ä½™åˆ†æ”¯ä»£è¡¨ä¸¤ç§åˆ‡æ¢æ ¹ç›®å½•çš„æ–¹å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœåˆ›å»ºäº†æ–°çš„ mount namespace ï¼Œå°†ä½¿ç”¨ &lt;code>pivot_root&lt;/code> ç³»ç»Ÿè°ƒç”¨ã€‚&lt;/li>
&lt;li>å¦‚æœæ²¡æœ‰åˆ›å»ºæ–°çš„ mount namespaceï¼Œç›´æ¥ä½¿ç”¨ &lt;code>chroot&lt;/code> ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="bind-mount-åœ¨å®¿ä¸»æœºå’Œå®¹å™¨é—´å…±äº«æ–‡ä»¶">bind mount ï¼šåœ¨å®¿ä¸»æœºå’Œå®¹å™¨é—´å…±äº«æ–‡ä»¶&lt;/h2>
&lt;p>å»ºç«‹éš”ç¦»çš„æ–‡ä»¶ç³»ç»Ÿä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ç§æœºåˆ¶ä»å®¹å™¨è®¿é—®å®¿ä¸»æœºçš„éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿï¼Œæˆ–è€…å°†å®¹å™¨è¿è¡Œè¿‡ç¨‹äº§ç”Ÿçš„æ•°æ®æŒä¹…åŒ–åˆ°å®¿ä¸»æœºä¸­ã€‚&lt;/p>
&lt;p>bind mount ï¼ˆç»‘å®šæŒ‚è½½ï¼‰æ˜¯ç”± Linux æä¾›çš„ä¸€ç§æŒ‚è½½ç±»å‹ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•å†æ¬¡æŒ‚è½½åˆ°ä¸€ä¸ªæ–°çš„ç›®æ ‡è·¯å¾„ï¼ŒæŒ‚è½½åä»æ–°æ—§ä¸¤ä¸ªè·¯å¾„éƒ½èƒ½è®¿é—®åˆ°åŸæ¥çš„æ•°æ®ï¼Œä»ä¸¤ä¸ªè·¯å¾„å¯¹æ•°æ®çš„ä¿®æ”¹ä¹Ÿéƒ½ä¼šç”Ÿæ•ˆï¼Œç›®æ ‡è·¯å¾„çš„åŸæœ‰å†…å®¹å°†ä¼šè¢«éšè—ã€‚ä»¥å¦‚ä¸‹ç›®å½•ç»“æ„ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ tree .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ a.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Â Â  â”œâ”€â”€ b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Â Â  â””â”€â”€ b.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤å°† A ç»‘å®šæŒ‚è½½åˆ° B ç›®å½•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mount --bind A B
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹‹åä» A å’Œ B ç›®å½•éƒ½å¯ä»¥è®¿é—®åŸ A ç›®å½•çš„æ–‡ä»¶å†…å®¹ï¼Œè€Œ B ç›®å½•çš„åŸå†…å®¹å°†è¢«éšè—ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ tree .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ a.conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Â Â  â”œâ”€â”€ a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Â Â  â””â”€â”€ a.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ bind mount åœ¨å®¿ä¸»æœºå’Œå®¹å™¨ä¹‹é—´å…±äº«æ–‡ä»¶ï¼Œå°†å®¿ä¸»æœºä¸­çš„ç›®å½•ç”šè‡³æ˜¯å—è®¾å¤‡æŒ‚è½½åˆ°å®¹å™¨ä¸­ã€‚&lt;/p>
&lt;h3 id="åœ¨å®¹å™¨ä¸­ä½¿ç”¨-bind-mount">åœ¨å®¹å™¨ä¸­ä½¿ç”¨ bind mount&lt;/h3>
&lt;p>ä¸‹é¢æˆ‘ä»¬å°†åœ¨å®¹å™¨å»ºç«‹ä¸€ä¸ªè¿æ¥åˆ°å®¿ä¸»æœºçš„ bind mountã€‚å®¹å™¨è¿è¡Œæ—¶çš„å®ç°æ–¹å¼æ˜¯ä¿®æ”¹ &lt;code>filesystem bundle&lt;/code> ä¸­çš„ &lt;code>config.json&lt;/code>ï¼Œåœ¨ JSON å¯¹è±¡çš„ &lt;code>mounts&lt;/code> åˆ—è¡¨ä¸­åŠ å…¥ä»¥ä¸‹å¯¹è±¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;destination&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/host_dir&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;bind&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;source&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;/mycontainer/host&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;options&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;bind&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™å‘Šè¯‰å®¹å™¨è¿è¡Œæ—¶ï¼Œå°†å®¿ä¸»æœºä¸­çš„ &lt;code>/mycontainer/host&lt;/code> ç›®å½•ï¼ˆå¦‚æœä½¿ç”¨ç›¸å¯¹è·¯å¾„åˆ™æ˜¯ç›¸å¯¹äº &lt;code>filesystem bundle&lt;/code> çš„ç›®å½•å³ &lt;code>host&lt;/code>ï¼‰ï¼ŒæŒ‚è½½åˆ°å®¹å™¨ä¸­ &lt;code>rootfs&lt;/code> çš„ &lt;code>/host_dir&lt;/code> ç›®å½•ã€‚å®¿ä¸»æœºä¸­çš„ &lt;code>host&lt;/code> ç›®å½•å¿…é¡»æå‰å­˜åœ¨ï¼Œè€Œå®¹å™¨ä¸­çš„ &lt;code>host_dir&lt;/code> ä¸å­˜åœ¨æ—¶å°†ç”±å®¹å™¨è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºã€‚ç°åœ¨æˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸­åˆ›å»º &lt;code>host&lt;/code> ç›®å½•å¹¶å¡«å……ä¸€ä¸ªæ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ touch mkdir/hello
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åè¿è¡Œå®¹å™¨ï¼Œæˆ‘ä»¬å°†åœ¨å®¹å™¨çš„ &lt;code>/host_dir&lt;/code> ç›®å½•ä¸­çœ‹åˆ°å®¿ä¸»æœº &lt;code>/mycontainer/host&lt;/code> ç›®å½•çš„å†…å®¹ï¼Œåœ¨å®¹å™¨å†…ä¿®æ”¹è¯¥ç›®å½•å†…çš„æ–‡ä»¶ä¹Ÿå°†åœ¨å®¿ä¸»æœºå¯è§ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in container&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls /host_dir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hello
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ touch /host_dir/world
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in host&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ls /mycontainer/host
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hello world
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œä¸”ï¼Œç”±äºç»‘å®šæŒ‚è½½çš„è¿‡ç¨‹å‘ç”Ÿåœ¨å®¹å™¨çš„ mount namespace ä¸­ï¼Œå®¿ä¸»æœºå¹¶ä¸çŸ¥é“è¯¥æŒ‚è½½ç‚¹çš„å­˜åœ¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in container&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cat /proc/self/mounts &lt;span class="p">|&lt;/span> grep host_dir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/sdb3 /host_dir ext4 rw,relatime,errors&lt;span class="o">=&lt;/span>remount-ro &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># in host&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cat /proc/self/mounts &lt;span class="p">|&lt;/span> grep host_dir
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ç³»åˆ—çš„ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æåˆ°ç»‘å®šæŒ‚è½½çš„æŒ‚è½½ç‚¹ä½äºå®¹å™¨çš„å¯å†™å±‚ä¸­ï¼Œè™½ç„¶å®¹å™¨åˆ é™¤åæ•´ä¸ªå¯å†™å±‚å°†è¢«åˆ é™¤ï¼Œä½†å®¹å™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„å†™å…¥æ•°æ®ä¾ç„¶ä¼šä¿ç•™åœ¨å®¿ä¸»æœºçš„æŒ‚è½½è·¯å¾„ï¼Œå› æ­¤å¯é€šè¿‡è¯¥é€”å¾„æŒä¹…åŒ–å®¹å™¨ä¸­çš„æ•°æ®ã€‚&lt;/p>
&lt;h3 id="docker-volumes-æ˜¯ä»€ä¹ˆ">docker volumes æ˜¯ä»€ä¹ˆ&lt;/h3>
&lt;p>Dcoekr æä¾›äº† Volumesï¼ˆè¯¥æœ¯è¯­å¹¶ä¸å­˜åœ¨äº OCI è§„èŒƒä¸­ï¼‰æ¥å°†å®¹å™¨ä¸­çš„æ•°æ®æŒä¹…åŒ–ï¼Œåº•å±‚çš„å®ç°æ–¹å¼ä¹Ÿæ˜¯ä½¿ç”¨ bind mountï¼Œå°†å®¿ä¸»æœºä¸­çš„è·¯å¾„ç»‘å®šæŒ‚è½½åˆ°å®¹å™¨ä¸­ï¼Œç›¸æ¯”ä¹‹ä¸‹ Docker æä¾›äº†æ›´å‹å¥½çš„å‘½ä»¤è¡Œæ¥å£ï¼Œæ­¤å¤–è¿˜æä¾›äº† &lt;code>named volume&lt;/code>ï¼Œï¼ˆåœ¨ Linux ç³»ç»Ÿä¸­ï¼‰æœ¬è´¨æ˜¯ä¸éœ€è¦åœ¨å®¿ä¸»æœºä¸­æŒ‡å®šå·²å­˜åœ¨çš„ç›®å½•ï¼Œè€Œæ˜¯ç”± Docker æ¥ç®¡ç†ï¼Œåœ¨å…¶å®¿ä¸»æœºçš„æ•°æ®ç›®å½•ä¸­å»ºç«‹ä¸€ä¸ªå•ç‹¬çš„ç›®å½•ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬è®¨è®ºäº†å’Œå®¹å™¨æ–‡ä»¶ç³»ç»Ÿæœ‰å…³çš„å‡ ä¸ªæ–¹é¢ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ mount namespace åœ¨å®¹å™¨ä¸­å»ºç«‹å•ç‹¬çš„æ–‡ä»¶ç³»ç»Ÿç¯å¢ƒï¼Œä½†æ­¤æ—¶å¹¶æœªä¸å®¿ä¸»æœºå®Œå…¨éš”ç¦»ã€‚&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>pivot_root&lt;/code> å°†å®¹å™¨ä¸­çš„æ ¹ç›®å½•åˆ‡æ¢åˆ°é•œåƒæä¾›çš„ &lt;code>rootfs&lt;/code> ä¸­ï¼Œä½¿å…¶æ— æ³•è®¿é—®å®¿ä¸»æœºçš„å…¶ä»–è·¯å¾„è€Œå®ç°éš”ç¦»ã€‚&lt;/li>
&lt;li>ä½¿ç”¨ bind mount åœ¨å®¿ä¸»æœºå’Œå®¹å™¨é—´å…±äº«æ•°æ®æˆ–å°†å®¹å™¨è¿è¡Œæ—¶ç”Ÿæˆçš„æ•°æ®æŒä¹…åŒ–ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://pierrchen.blogspot.com/2018/05/understand-container-4.html">Understand Container 4: Mount and Jail&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man8/mount.8.html">mount(8) â€” Linux manual page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.redhat.com/sysadmin/mount-namespaces">Building a container by hand using namespaces: The mount namespace&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.halolinux.us/kernel-reference/mounting-the-root-filesystem.html">Mounting the Root Filesystem&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.ibm.com/docs/en/aix/7.1?topic=management-file-systems">File systems&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man2/pivot_root.2.html">pivot_root(2) â€” Linux manual page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://lists.linuxcontainers.org/pipermail/lxc-devel/2011-September/002065.html">DIfference between chroot &amp;amp; pivot_root&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.quora.com/What-is-the-purpose-of-pivot_root-system-call-in-Linux">What is the purpose of pivot_root system call in Linux?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://unix.stackexchange.com/questions/198590/what-is-a-bind-mount">What is a bind mount?&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/%E5%AE%B9%E5%99%A8/" term="å®¹å™¨" label="å®¹å™¨"/><category scheme="https://waynerv.com/tags/namespace/" term="Namespace" label="Namespace"/><category scheme="https://waynerv.com/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" term="æ–‡ä»¶ç³»ç»Ÿ" label="æ–‡ä»¶ç³»ç»Ÿ"/></entry><entry><title type="text">å®¹å™¨æŠ€æœ¯åŸç†(å››)ï¼šä½¿ç”¨ Capabilities å®ç°æƒé™æ§åˆ¶</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/container-fundamentals-permission-control-using-capabilities/"/><id>https://waynerv.com/posts/container-fundamentals-permission-control-using-capabilities/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-07-22T15:45:56+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">&lt;code>root&lt;/code> ç”¨æˆ·æ‹¥æœ‰æœ€é«˜ç‰¹æƒæ—©å°±æˆäº†è¿‡å»å¼ï¼ŒLinux å†…æ ¸åœ¨ 2.2 ç‰ˆæœ¬å°±å¼•å…¥äº†ä¸€ç§æ–°çš„æƒé™æ£€æŸ¥æœºåˆ¶ - capabilitiesã€‚</summary><content type="html">&lt;p>å¦‚æœä½ ä½¿ç”¨ &lt;code>runc&lt;/code> è¿è¡Œä¸€ä¸ªå®¹å™¨å¹¶æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œä¼šå¾—åˆ°æœ‰è¶£çš„ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ whoami
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ id -u root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hostname: sethostname: Operation not permitted
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å³ä½¿æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ &lt;code>UID&lt;/code> ä¸º 0 çš„ &lt;code>root&lt;/code> ç”¨æˆ·ï¼Œä¹Ÿæ²¡æœ‰æƒé™æ‰§è¡Œä¿®æ”¹ hostname çš„æ“ä½œã€‚&lt;/p>
&lt;p>å®é™…ä¸Š &lt;code>root&lt;/code> ç”¨æˆ·æ‹¥æœ‰æœ€é«˜ç‰¹æƒæ—©å°±æˆäº†è¿‡å»å¼ï¼ŒLinux å†…æ ¸åœ¨ 2.2 ç‰ˆæœ¬å°±å¼•å…¥äº†ä¸€ç§æ–°çš„æƒé™æ£€æŸ¥æœºåˆ¶ - capabilitiesã€‚&lt;/p>
&lt;h2 id="æ¯”è¶…çº§ç”¨æˆ·æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶">æ¯”è¶…çº§ç”¨æˆ·æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶&lt;/h2>
&lt;p>ä¼ ç»Ÿçš„ Linux æƒé™æ£€æŸ¥æ¨¡å‹è¾ƒä¸ºç®€å•ï¼Œå†…æ ¸åœ¨è¿›è¡Œæƒé™æ£€æŸ¥æ—¶åªä¼šåŒºåˆ†ä¸¤ç±»è¿›ç¨‹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç‰¹æƒè¿›ç¨‹ï¼Œå…¶æœ‰æ•ˆç”¨æˆ· IDä¸º 0ï¼Œè¯¥ç”¨æˆ·ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„è¶…çº§ç”¨æˆ·æˆ– &lt;code>root&lt;/code>ã€‚&lt;/li>
&lt;li>éç‰¹æƒè¿›ç¨‹ï¼Œæœ‰æ•ˆç”¨æˆ· ID ä¸ä¸º 0ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç‰¹æƒè¿›ç¨‹å°†ç›´æ¥ç»•è¿‡å†…æ ¸çš„æ‰€æœ‰æ£€æŸ¥ï¼Œéç‰¹æƒè¿›ç¨‹åˆ™éœ€è¦åŸºäºè¿›ç¨‹çš„æœ‰æ•ˆç”¨æˆ· ID å’Œæœ‰æ•ˆç”¨æˆ·ç»„ ID ç­‰å‡­è¯æ‰§è¡Œæ£€æŸ¥ã€‚&lt;/p>
&lt;p>ä¸ºäº†é€‚åº”æ›´å¤æ‚çš„æƒé™éœ€æ±‚ï¼Œä» 2.2 ç‰ˆæœ¬èµ· Linux å†…æ ¸èƒ½å¤Ÿè¿›ä¸€æ­¥å°†è¶…çº§ç”¨æˆ·çš„æƒé™åˆ†è§£ä¸ºç»†é¢—ç²’åº¦çš„å•å…ƒï¼Œè¿™äº›å•å…ƒç§°ä¸º capabilitiesã€‚ä¾‹å¦‚ï¼Œcapability &lt;code>CAP_CHOWN&lt;/code> å…è®¸ç”¨æˆ·å¯¹æ–‡ä»¶çš„ UID å’Œ GID è¿›è¡Œä»»æ„ä¿®æ”¹ï¼Œå³æ‰§è¡Œ &lt;code>chown&lt;/code> å‘½ä»¤ã€‚å‡ ä¹æ‰€æœ‰ä¸è¶…çº§ç”¨æˆ·ç›¸å…³çš„ç‰¹æƒéƒ½è¢«åˆ†è§£æˆäº†å•ç‹¬çš„ capabilityã€‚&lt;/p>
&lt;p>capabilities çš„å¼•å…¥æœ‰ä»¥ä¸‹å¥½å¤„ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»è¶…çº§ç”¨æˆ·çš„æƒé™ä¸­ç§»é™¤éƒ¨åˆ† capability ä»¥å‰Šå¼±å…¶æƒé™ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚&lt;/li>
&lt;li>å¯ä»¥æ ¹æ®éœ€æ±‚éå¸¸ç²¾å‡†åœ°å‘æ™®é€šç”¨æˆ·æˆäºˆéƒ¨åˆ†ç‰¹æ®Šæƒé™ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ç‰¹æƒå®¹å™¨çš„å®‰å…¨é£é™©">ç‰¹æƒå®¹å™¨çš„å®‰å…¨é£é™©&lt;/h2>
&lt;p>å®¹å™¨é€šè¿‡ namespace æ¥éš”ç¦»è¿›ç¨‹å’Œèµ„æºï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„èµ„æºéƒ½å¯ä»¥è¢« namespace åŒ–ï¼Œå®¹å™¨å’Œå®¿ä¸»æœºå¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œæ¯”å¦‚å®¹å™¨å’Œå®¿ä¸»æœºä¸­çš„æ—¶é—´å°±æ˜¯å…±äº«çš„ã€‚å¦‚æœå®¹å™¨ä¸­çš„è¿›ç¨‹æ‹¥æœ‰ä¸€åˆ‡ç‰¹æƒï¼Œå®ƒå¯ä»¥è¿è¡Œç›´æ¥è®¿é—®ç¡¬ä»¶çš„ï¼ˆæ¶æ„ï¼‰ç¨‹åºç”šè‡³ç›´æ¥ä¿®æ”¹å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤æœ‰å¿…è¦å¯¹å®¹å™¨ä¸­çš„æ“ä½œè¿›è¡Œä¸€å®šçš„é™åˆ¶ï¼Œå¦åˆ™ä¼šå½±å“åˆ°å®¿ä¸»æœºçš„ç¨³å®šæ€§ï¼Œç”šè‡³å¸¦æ¥ä¸¥é‡çš„å®‰å…¨é£é™©ã€‚&lt;/p>
&lt;p>å‡ºäºä»¥ä¸Šè€ƒè™‘ï¼Œé»˜è®¤æƒ…å†µä¸‹å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ç™½åå•çš„æ–¹å¼åœ¨åˆ›å»ºå®¹å™¨æ—¶åŠ å…¥ä¸€éƒ¨åˆ†çš„ capabilitiesï¼Œåœ¨å®¹å™¨ä¸­å³ä½¿ä½ æ˜¯è¶…çº§ç”¨æˆ·ä¹Ÿæ²¡æœ‰æƒé™æ‰§è¡Œç‰¹å®šçš„æ“ä½œã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å®ä¾‹åŠ æ·±å¯¹å®¹å™¨ä¸­ capabilities çš„è®¤è¯†ã€‚&lt;/p>
&lt;h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ&lt;/h2>
&lt;p>æˆ‘ä»¬å°†åœ¨å®¹å™¨ä¸­ä½¿ç”¨é¢å¤–çš„å·¥å…·åº“ &lt;code>libcap&lt;/code> å®ç°å’Œ capabilities çš„äº¤äº’ï¼Œä¸ºæ­¤éœ€è¦å°†å…¶å®‰è£…åˆ°ä¸€ä¸ª &lt;code>filesystem bundle&lt;/code> ä¸­ï¼Œè¿™ç§æ–¹å¼åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­å·²æœ‰ä»‹ç»ï¼Œå…·ä½“æ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»º bundle çš„é¡¶å±‚ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir /mycontainer2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /mycontainer2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»ºç”¨äºå­˜æ”¾ root filesystem çš„ rootfs ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir rootfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ©ç”¨ Docker å¯¼å‡ºå·²å®‰è£… libcap å®¹å™¨çš„ root filesystem &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">docker &lt;span class="nb">export&lt;/span> &lt;span class="k">$(&lt;/span>docker create cmd.cat/capsh&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> tar -C rootfs -xvf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»ºä¸€ä¸ª config.json ä½œä¸ºæ•´ä¸ª bundle çš„ spec&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">runc spec
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åå°±å¯ä»¥ä½¿ç”¨ &lt;code>runc run&lt;/code> ä» &lt;code>/mycontainer2&lt;/code> ç›®å½•è¿è¡Œä¸€ä¸ªå·²å®‰è£…è¯¥åº“çš„åŸºç¡€å®¹å™¨äº†ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºå®¹å™¨æ—¶æ·»åŠ -capabilities">åˆ›å»ºå®¹å™¨æ—¶æ·»åŠ  capabilities&lt;/h2>
&lt;p>åœ¨å¼€å¤´çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ— æ³•åœ¨å®¹å™¨ä¸­ä»¥ &lt;code>root&lt;/code> ç”¨æˆ·è®¾ç½® hostnameï¼Œæ˜¯å› ä¸ºç¼ºå°‘äº† &lt;code>CAP_SYS_ADMIN&lt;/code> è¿™ä¸€ capabilityï¼Œå®ƒå¹¶æœªåŒ…å«åœ¨å®¹å™¨é»˜è®¤æ·»åŠ  capabilities çš„ç™½åå•ä¸­ã€‚&lt;/p>
&lt;p>åœ¨ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»è¿‡å®¹å™¨è¿è¡Œæ—¶ä¼šæ ¹æ® &lt;code>bundle&lt;/code> ä¸­çš„ &lt;code>config.json&lt;/code> ï¼Œä¸ºå…¶åˆ›å»ºçš„å®¹å™¨è®¾ç½®è¿è¡Œå‚æ•°å’Œæ‰§è¡Œç¯å¢ƒï¼Œè¿™ä¸€è¿‡ç¨‹ä¹ŸåŒ…æ‹¬äº†è®¾ç½®å®¹å™¨å†…è¿›ç¨‹çš„ capabilitiesã€‚&lt;/p>
&lt;p>é€šè¿‡ä¿®æ”¹ &lt;code>config.json&lt;/code> ï¼Œå‘ JSON ä¸­çš„ &lt;code>process.capabilities&lt;/code> å¯¹è±¡çš„ &lt;code>bounding&lt;/code>ï¼Œ&lt;code>permitted&lt;/code> å’Œ &lt;code>effective&lt;/code> åˆ—è¡¨ä¸­åŠ å…¥ &lt;code>&amp;quot;CAP_SYS_ADMIN&amp;quot;&lt;/code>ï¼Œè¯¥ capability å°†åŠ å…¥åˆ°å®¹å™¨ &lt;code>init&lt;/code> è¿›ç¨‹çš„å¯¹åº” capabilities é›†åˆä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;capabilities&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;bounding&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_AUDIT_WRITE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_KILL&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_NET_BIND_SERVICE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_SYS_ADMIN&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;effective&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_AUDIT_WRITE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_KILL&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_NET_BIND_SERVICE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_SYS_ADMIN&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;inheritable&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_AUDIT_WRITE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_KILL&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_NET_BIND_SERVICE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;permitted&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_AUDIT_WRITE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_KILL&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_NET_BIND_SERVICE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_SYS_ADMIN&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;ambient&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_AUDIT_WRITE&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_KILL&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;CAP_NET_BIND_SERVICE&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="capabilities-çš„æŠ€æœ¯ç»†èŠ‚">capabilities çš„æŠ€æœ¯ç»†èŠ‚&lt;/h3>
&lt;p>capabilities å¯ä»¥åº”ç”¨äºæ–‡ä»¶å’Œè¿›ç¨‹ï¼ˆæˆ–çº¿ç¨‹ï¼ŒLinux å†…æ ¸ä¸åŒºåˆ†è¿›ç¨‹å’Œçº¿ç¨‹ï¼‰ï¼Œæ–‡ä»¶çš„ capabilities å­˜å‚¨åœ¨æ–‡ä»¶çš„æ‰©å±•å±æ€§ä¸­ï¼Œæ‰©å±•å±æ€§åœ¨æ„å»ºé•œåƒæ—¶ä¼šè¢«æ¸…ç†æ‰ï¼Œæ‰€ä»¥åœ¨å®¹å™¨ä¸­æˆ‘ä»¬åŸºæœ¬ä¸éœ€è¦è€ƒè™‘æ–‡ä»¶çš„ capabilitiesã€‚&lt;/p>
&lt;p>è¿›ç¨‹çš„ capabilities é€šè¿‡æ¯ä¸ªè¿›ç¨‹å•ç‹¬ç»´æŠ¤çš„ 5 ä¸ª capability é›†åˆæ¥æ§åˆ¶ï¼Œæ¯ä¸ªé›†åˆä¸­éƒ½åŒ…å« 0 ä¸ªæˆ–å¤šä¸ª capabilitiesï¼š&lt;/p>
&lt;ul>
&lt;li>Permittedï¼šè¿›ç¨‹æ‰€èƒ½å¤Ÿä½¿ç”¨çš„ capabilities çš„è¶…é›†&lt;/li>
&lt;li>Inheritableï¼šè¿›ç¨‹åœ¨æ‰§è¡Œ &lt;code>exec()&lt;/code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿè¢«æ–°çš„æ´¾ç”Ÿè¿›ç¨‹æ‰€ç»§æ‰¿çš„ capabilities&lt;/li>
&lt;li>Effectiveï¼šå†…æ ¸å¯¹è¿›ç¨‹æ‰§è¡Œæƒé™æ£€æŸ¥æ—¶æ‰€ä½¿ç”¨çš„é›†åˆ&lt;/li>
&lt;li>Boundingï¼šInheritable é›†åˆçš„è¶…é›†ï¼Œä¸€ä¸ªcapability å¿…é¡»åœ¨ Bounding é›†åˆä¸­æ‰èƒ½æ·»åŠ åˆ°Inheritable&lt;/li>
&lt;li>Ambientï¼šéç‰¹æƒç¨‹åºæ‰§è¡Œ &lt;code>exec()&lt;/code> ç³»ç»Ÿè°ƒç”¨æ—¶å°†ä¿ç•™çš„ capabilities&lt;/li>
&lt;/ul>
&lt;p>å¦‚ä¸Šæ‰€ç¤ºæˆ‘ä»¬å‘ &lt;code>init&lt;/code> è¿›ç¨‹çš„ Permittedã€Bounding å’Œ Effective é›†åˆä¸­åŠ å…¥äº† &lt;code>CAP_SYS_ADMIN&lt;/code>ï¼Œå› æ­¤ &lt;code>init&lt;/code> è¿›ç¨‹å°†é€šè¿‡å†…æ ¸å¯¹ &lt;code>CAP_SYS_ADMIN&lt;/code> çš„æ£€æŸ¥ã€‚&lt;/p>
&lt;p>ä¸‹é¢æˆ‘ä»¬æ ¹æ®æ–°çš„ &lt;code>config.json&lt;/code> è¿è¡Œä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œç°åœ¨å¯ä»¥ä¿®æ”¹ hostname äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc run mybox2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname super
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">super
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œä»¥ä¸Šæ“ä½œæ—¶ï¼Œæˆ‘ä»¬ä½äºä½œä¸ºå®¹å™¨ &lt;code>init&lt;/code> è¿›ç¨‹çš„ &lt;code>sh&lt;/code> è¿›ç¨‹ä¸­ï¼Œå¦‚æœåœ¨å®¹å™¨ä¸­ç»§ç»­åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œæ˜¯å¦ä¹Ÿä¼šå…·æœ‰æ–°åŠ å…¥çš„ capabilityï¼Ÿæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼Œåœ¨ä¸€ä¸ªæ–°çš„çª—å£ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc &lt;span class="nb">exec&lt;/span> -t mybox2 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">super
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname hello
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ hostname
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hello
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¿®æ”¹ hostname çš„æ“ä½œæ‰§è¡ŒæˆåŠŸï¼Œå› ä¸ºæ–°åˆ›å»ºçš„è¿›ç¨‹å®Œå…¨å¤åˆ¶äº† &lt;code>init&lt;/code> è¿›ç¨‹çš„ capabilitiesã€‚&lt;/p>
&lt;h2 id="å®¹å™¨è¿è¡Œæ—¶æ·»åŠ -capabilities">å®¹å™¨è¿è¡Œæ—¶æ·»åŠ  capabilities&lt;/h2>
&lt;p>é™¤äº†ä¿®æ”¹ &lt;code>config.json&lt;/code> åŠ å…¥ capabilitiesï¼Œæˆ‘ä»¬è¿˜èƒ½å¤Ÿåœ¨å®¹å™¨è¿è¡Œæ—¶é˜¶æ®µæ·»åŠ  capabilitiesã€‚&lt;/p>
&lt;p>é¦–å…ˆå°† &lt;code>config.json&lt;/code> è¿˜åŸï¼Œç„¶åè¿è¡Œä¸€ä¸ªæ–°çš„å®¹å™¨ &lt;code>mybox3&lt;/code>ï¼Œåœ¨æ–°çš„ &lt;code>sh&lt;/code> è¿›ç¨‹ä¸­ç¡®è®¤å·²ç»ä¸å†å…·æœ‰ &lt;code>CAP_SYS_ADMIN&lt;/code>ã€‚&lt;/p>
&lt;p>ç„¶åé€šè¿‡ &lt;code>runc exec&lt;/code> åœ¨è¯¥å®¹å™¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶é€šè¿‡ &lt;code>--cap&lt;/code> é€‰é¡¹ä¸ºè¯¥è¿›ç¨‹æ·»åŠ  &lt;code>CAP_SYS_ADMIN&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">runc &lt;span class="nb">exec&lt;/span> --cap CAP_SYS_ADMIN mybox3 /bin/hostname origin
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æ“ä½œçš„åŸç†æ˜¯ï¼Œæ—¢ç„¶ &lt;code>runc&lt;/code> èƒ½å¤Ÿæ ¹æ® &lt;code>config.json&lt;/code> è®¾ç½® &lt;code>init&lt;/code> è¿›ç¨‹çš„ capabilities é›†åˆï¼Œå®ƒåŒæ ·ä¹Ÿèƒ½ä¸ºå®¹å™¨å†…è¿è¡Œçš„å…¶ä»–è¿›ç¨‹è®¾ç½®ã€‚&lt;/p>
&lt;h2 id="æŸ¥çœ‹è¿›ç¨‹å…·æœ‰çš„-capabilities">æŸ¥çœ‹è¿›ç¨‹å…·æœ‰çš„ capabilities&lt;/h2>
&lt;h3 id="capsh">capsh&lt;/h3>
&lt;p>åœ¨å®¹å™¨å†…æ‰§è¡Œ &lt;code>capsh --print&lt;/code> èƒ½å¤Ÿè·å–åˆ°æ›´å¤šå…³äº capabilities çš„ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ capsh --print
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Current: &lt;span class="o">=&lt;/span> cap_kill,cap_net_bind_service,cap_audit_write+eip cap_sys_admin+ep
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Bounding &lt;span class="nb">set&lt;/span> &lt;span class="o">=&lt;/span>cap_kill,cap_net_bind_service,cap_sys_admin,cap_audit_write
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Ambient &lt;span class="nb">set&lt;/span> &lt;span class="o">=&lt;/span>cap_kill,cap_net_bind_service,cap_audit_write
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Securebits: 00/0x0/1&lt;span class="err">&amp;#39;&lt;/span>b0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> secure-noroot: no &lt;span class="o">(&lt;/span>unlocked&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> secure-no-suid-fixup: no &lt;span class="o">(&lt;/span>unlocked&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> secure-keep-caps: no &lt;span class="o">(&lt;/span>unlocked&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> secure-no-ambient-raise: no &lt;span class="o">(&lt;/span>unlocked&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">uid&lt;/span>&lt;span class="o">=&lt;/span>0&lt;span class="o">(&lt;/span>root&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">gid&lt;/span>&lt;span class="o">=&lt;/span>0&lt;span class="o">(&lt;/span>root&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">groups&lt;/span>&lt;span class="o">=&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥å‘½ä»¤æ‰“å°äº†å½“å‰è¿›ç¨‹æ‰€å…·æœ‰çš„ capabilitiesã€‚&lt;/p>
&lt;p>åœ¨ &lt;code>Current&lt;/code> å’Œ &lt;code>Bounding set&lt;/code> ä¸­åŒ…å«äº†æˆ‘ä»¬é€šè¿‡ &lt;code>config.json&lt;/code> åŠ å…¥çš„ &lt;code>cap_sys_admin&lt;/code>ã€‚capability æœ«å°¾çš„ &lt;code>+eip&lt;/code> ä»£è¡¨äº†è¯¥ capability åŒæ—¶å­˜åœ¨äº Effectiveï¼ŒInheritable å’Œ Permitted é›†åˆä¸­ã€‚&lt;/p>
&lt;h3 id="pscap">pscap&lt;/h3>
&lt;p>é¦–å…ˆåœ¨å®¿ä¸»æœºè·å–å®¹å™¨ä¸­å·²è¿è¡Œè¿›ç¨‹çš„ PIDï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc ps mybox2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UID PID PPID C STIME TTY TIME CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">9592&lt;/span> &lt;span class="m">9580&lt;/span> &lt;span class="m">0&lt;/span> 14:39 pts/0 00:00:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">9776&lt;/span> &lt;span class="m">9765&lt;/span> &lt;span class="m">0&lt;/span> 14:46 pts/1 00:00:00 sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨å®¿ä¸»æœºä¸­å®‰è£… &lt;code>pscap&lt;/code> ç¨‹åºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ apt-get install libcap-ng-utils
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ ¹æ®è·å¾—çš„ PIDï¼ŒæŸ¥çœ‹å®¹å™¨ä¸­è¿›ç¨‹æ‰€å…·æœ‰çš„ capabilitiesï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pscap &lt;span class="p">|&lt;/span> grep &lt;span class="s2">&amp;#34;9592\|9776&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">9580&lt;/span> &lt;span class="m">9592&lt;/span> root sh kill, net_bind_service, sys_admin, audit_write
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">9765&lt;/span> &lt;span class="m">9776&lt;/span> root sh kill, net_bind_service, sys_admin, audit_write
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://pierrchen.blogspot.com/2018/05/container-deep-dive-3-linux-capabilities.html">Understand Container 3: Linux Capabilities&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities(7) â€” Linux manual page&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dockerlabs.collabnix.com/advanced/security/capabilities/">dockerlabs-Capabilities&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://fuckcloudnative.io/posts/linux-capabilities-why-they-exist-and-how-they-work/">Linux Capabilities å…¥é—¨æ•™ç¨‹ï¼šæ¦‚å¿µç¯‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.trendmicro.com/en_us/research/19/l/why-running-a-privileged-container-in-docker-is-a-bad-idea.html">Why A Privileged Container in Docker Is a Bad Idea&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/%E5%AE%B9%E5%99%A8/" term="å®¹å™¨" label="å®¹å™¨"/><category scheme="https://waynerv.com/tags/capabilities/" term="Capabilities" label="Capabilities"/></entry><entry><title type="text">å®¹å™¨æŠ€æœ¯åŸç†(ä¸‰)ï¼šä½¿ç”¨ Cgroups å®ç°èµ„æºé™åˆ¶</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/container-fundamentals-resource-limitation-using-cgroups/"/><id>https://waynerv.com/posts/container-fundamentals-resource-limitation-using-cgroups/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-07-21T17:38:06+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">cgroups æ˜¯ç”± Linux å†…æ ¸æä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿé™åˆ¶ã€æ ¸ç®—å’Œéš”ç¦»ä¸€ç»„è¿›ç¨‹æ‰€ä½¿ç”¨çš„ç³»ç»Ÿèµ„æºï¼ˆå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ I/Oã€ç½‘ç»œç­‰ï¼‰ã€‚</summary><content type="html">&lt;p>cgroupsï¼ˆcontrol groupsï¼‰æ˜¯ç”± Linux å†…æ ¸æä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿé™åˆ¶ã€æ ¸ç®—å’Œéš”ç¦»ä¸€ç»„è¿›ç¨‹æ‰€ä½¿ç”¨çš„ç³»ç»Ÿèµ„æºï¼ˆå¦‚ CPUã€å†…å­˜ã€ç£ç›˜ I/Oã€ç½‘ç»œç­‰ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²äº†è§£ Namespace åœ¨å®¹å™¨æŠ€æœ¯ä¸­æ‰®æ¼”çš„è§’è‰²ï¼Œå¦‚æœè¯´ Namespace æ§åˆ¶äº†å®¹å™¨ä¸­çš„è¿›ç¨‹èƒ½çœ‹åˆ°ä»€ä¹ˆï¼Œé‚£ä¹ˆ cgroups åˆ™æ§åˆ¶äº†å®¹å™¨ä¸­çš„è¿›ç¨‹èƒ½ä½¿ç”¨å¤šå°‘èµ„æºã€‚Namespace å®ç°äº†è¿›ç¨‹çš„éš”ç¦»ï¼Œcgroups åˆ™å®ç°äº†èµ„æºçš„é™åˆ¶ï¼Œåè€…åŒæ ·æ˜¯æ„å»ºå®¹å™¨çš„åŸºç¡€ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å°†æ²¿è¢­ Namespace æ–‡ç« çš„è¡Œæ–‡æ€è·¯ï¼Œå®é™…åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œè§‚å¯Ÿå®¿ä¸»æœºä¸­ cgroups çš„å˜åŒ–ï¼Œæ¥å®é™…å±•ç¤º cgroups å¦‚ä½•å·¥ä½œï¼Œç„¶åäº†è§£å¦‚ä½•è‡ªè¡Œé…ç½® cgroupsã€‚&lt;/p>
&lt;h2 id="cgroup-åœ¨ä½•æ—¶åˆ›å»º">cgroup åœ¨ä½•æ—¶åˆ›å»º&lt;/h2>
&lt;p>Linux å†…æ ¸é€šè¿‡ä¸€ä¸ªå«åš &lt;code>cgroupfs&lt;/code> çš„ä¼ªæ–‡ä»¶ç³»ç»Ÿæ¥æä¾›ç®¡ç† cgroup çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>lscgroup&lt;/code> å‘½ä»¤æ¥åˆ—å‡ºç³»ç»Ÿä¸­å·²æœ‰çš„ cgroupï¼Œè¯¥å‘½ä»¤å®é™…ä¸Šéå†äº† &lt;code>/sys/fs/cgroup/&lt;/code> ç›®å½•ä¸­çš„æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ lscgroup &lt;span class="p">|&lt;/span> tee cgroup.a
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;em>å¦‚æœä½ ä½¿ç”¨çš„ Linux å‘è¡Œç‰ˆæ²¡æœ‰ &lt;code>lscgroup&lt;/code>&lt;/em> å‘½ä»¤ï¼Œå¯é€šè¿‡ &lt;a href="https://command-not-found.com/lscgroup">command-not-found.com&lt;/a> æä¾›çš„æŒ‡ä»¤ä¸‹è½½å®‰è£…ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°†è¾“å‡ºç»“æœä¿å­˜åˆ° &lt;code>cgroup.a&lt;/code> æ–‡ä»¶ä¸­ã€‚æ¥ç€åœ¨å¦ä¸€çª—å£ä¸­æ ¹æ® Namespace æ–‡ç« ä¸­çš„æ­¥éª¤å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ runc run mybox
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å›åˆ°åŸæ¥çš„çª—å£å†æ¬¡æ‰§è¡Œ &lt;code>lsgroup&lt;/code> å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ lscgroup &lt;span class="p">|&lt;/span> tee group.b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨å¯¹æ¯”ä¸¤æ¬¡ &lt;code>lscgroup&lt;/code> å‘½ä»¤çš„è¾“å‡ºç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ diff group.a group.b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; perf_event:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; freezer:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; net_cls,net_prio:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; cpu,cpuacct:/user.slice/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; blkio:/user.slice/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; hugetlb:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; pids:/user.slice/user-0.slice/session-5.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; memory:/user.slice/user-0.slice/session-5.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; devices:/user.slice/mybox
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ç»“æœä¸­å¯çœ‹åˆ°ï¼Œ&lt;code>mybox&lt;/code> å®¹å™¨åˆ›å»ºåï¼Œç³»ç»Ÿä¸­ä¸“é—¨ä¸ºå…¶åˆ›å»ºäº†æ‰€æœ‰ç±»å‹çš„æ–°çš„ cgroupã€‚&lt;/p>
&lt;h2 id="cgroup-å¦‚ä½•æ§åˆ¶å®¹å™¨çš„èµ„æº">cgroup å¦‚ä½•æ§åˆ¶å®¹å™¨çš„èµ„æº&lt;/h2>
&lt;p>cgroup æ‰€æ§åˆ¶çš„å¯¹è±¡æ˜¯è¿›ç¨‹ï¼Œå®ƒæ§åˆ¶ä¸€ä¸ªæˆ–ä¸€ç»„è¿›ç¨‹æ‰€èƒ½ä½¿ç”¨å¤šå°‘å†…å­˜/CPU/ç½‘ç»œç­‰ç­‰ã€‚ä¸€ä¸ª cgroup çš„ &lt;code>tasks&lt;/code> åˆ—è¡¨ä¸­è®°å½•äº†å…¶æ‰€æ§åˆ¶è¿›ç¨‹çš„ PIDï¼Œè¯¥ &lt;code>tasks&lt;/code> å®é™…ä¸Šä¹Ÿæ˜¯ &lt;code>cgroupfs&lt;/code> ä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="init-è¿›ç¨‹">init è¿›ç¨‹&lt;/h3>
&lt;p>æˆ‘ä»¬é¦–å…ˆåœ¨å®¿ä¸»æœºä¸­æ‰“å°å‡ºå®¹å™¨ä¸­çš„è¿›ç¨‹ä¿¡æ¯ï¼Œæ‰¾åˆ°å®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc ps mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UID PID PPID C STIME TTY TIME CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">2250&lt;/span> &lt;span class="m">2240&lt;/span> &lt;span class="m">0&lt;/span> 15:28 pts/0 00:00:00 sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»»æ„æ‰“å°ä¸€äº›ç±»å‹çš„ cgroup çš„ &lt;code>tasks&lt;/code> åˆ—è¡¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat /sys/fs/cgroup/memory/user.slice/user-0.slice/session-5.scope/mybox/tasks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2250&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cat /sys/fs/cgroup/blkio/user.slice/mybox/tasks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2250&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸€è¿‡ç¨‹ç®€å•æ˜äº†ï¼šå®¹å™¨åˆ›å»ºä¹‹åï¼Œå®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹ä¼šè¢«åŠ å…¥åˆ°ä¸ºè¯¥å®¹å™¨æ‰€åˆ›å»ºçš„ cgroups ä¹‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>/proc/$PID/cgroup&lt;/code> å¾—åˆ°æ›´è‚¯å®šçš„ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat /proc/2250/cgroup
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:devices:/user.slice/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">11:memory:/user.slice/user-0.slice/session-5.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">10:pids:/user.slice/user-0.slice/session-5.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">9:hugetlb:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8:cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">7:rdma:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">6:blkio:/user.slice/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">5:cpu,cpuacct:/user.slice/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">4:net_cls,net_prio:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">3:freezer:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">2:perf_event:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1:name&lt;span class="o">=&lt;/span>systemd:/user.slice/user-0.slice/session-5.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">0::/user.slice/user-0.slice/session-5.scope
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å®¹å™¨ä¸­çš„å…¶ä»–è¿›ç¨‹">å®¹å™¨ä¸­çš„å…¶ä»–è¿›ç¨‹&lt;/h3>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨ &lt;code>mybox&lt;/code> å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åœ¨ mybox å®¹å™¨ä¸­è¿è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ top -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>çœ‹çœ‹æ˜¯å¦ä¼šåˆ›å»ºæ–°çš„ cgroupï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ lscgroup &lt;span class="p">|&lt;/span> tee group.c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ diff group.b group.c
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ²¡æœ‰è¾“å‡ºä»»ä½•ç»“æœï¼Œè¯´æ˜æ²¡æœ‰åˆ›å»ºæ–°çš„ cgroupã€‚æ—¢ç„¶ cgroup å¯ä»¥æ§åˆ¶ä¸€ç»„è¿›ç¨‹ï¼Œæˆ‘ä»¬çŒœæµ‹åœ¨å·²è¿è¡Œå®¹å™¨ä¸­æ–°å»ºçš„è¿›ç¨‹ï¼Œä¹Ÿéƒ½ä¼šåŠ å…¥åˆ° &lt;code>init&lt;/code> è¿›ç¨‹æ‰€å±çš„ cgroups ä¸­ã€‚&lt;/p>
&lt;p>ä¸‹é¢å¼€å§‹éªŒè¯ï¼Œé¦–å…ˆæ‰¾åˆ°æ–°å»ºè¿›ç¨‹çš„ PIDï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc ps mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UID PID PPID C STIME TTY TIME CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">2250&lt;/span> &lt;span class="m">2240&lt;/span> &lt;span class="m">0&lt;/span> 15:28 pts/0 00:00:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">2576&lt;/span> &lt;span class="m">2250&lt;/span> &lt;span class="m">0&lt;/span> 15:59 pts/0 00:00:00 top -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ–°è¿›ç¨‹çš„ PID æ˜¯ 2576ï¼Œç„¶åæ‰“å°è¯¥è¿›ç¨‹çš„ cgroups ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat /proc/2576/cgroup
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¾“å‡ºå’Œ PID 2250 è¿›ç¨‹çš„è¾“å‡ºå®Œå…¨ä¸€è‡´ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“å°å…¶ä¸­ä¸€ä¸ª cgroup çš„ &lt;code>tasks&lt;/code> åˆ—è¡¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat /sys/fs/cgroup/blkio/user.slice/mybox/tasks
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2250&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2576&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®Œå…¨ç¬¦åˆé¢„æœŸã€‚å®é™…ä¸Šå‘ &lt;code>tasks&lt;/code> æ–‡ä»¶ç›´æ¥å†™å…¥è¿›ç¨‹çš„ PID å°±å®ç°äº†å°†è¿›ç¨‹åŠ å…¥åˆ°è¯¥ cgroup ä¸­ã€‚å½“ä¸€ä¸ªå®¹å™¨è¢«åˆ›å»ºæ—¶ï¼Œå°†ä¸ºæ¯ç§ç±»å‹çš„èµ„æºåˆ›å»ºä¸€ä¸ªæ–°çš„ cgroupï¼Œåœ¨å®¹å™¨ä¸­è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹éƒ½å°†åŠ å…¥åˆ°è¿™äº› cgroup ä¸­ã€‚&lt;/p>
&lt;p>é€šè¿‡æ§åˆ¶å®¹å™¨ä¸­è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹ï¼Œcgroups å®ç°äº†å¯¹å®¹å™¨çš„èµ„æºé™åˆ¶ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•é…ç½®-cgroup">å¦‚ä½•é…ç½® cgroup&lt;/h2>
&lt;p>ä¸‹é¢æˆ‘ä»¬å°†ä»¥å†…å­˜ cgroup ä¸ºä¾‹ï¼Œäº†è§£å¦‚ä½•é…ç½® cgroup ä»¥å®ç°å¯¹ &lt;code>mybox&lt;/code> å®¹å™¨çš„å†…å­˜é™åˆ¶ã€‚&lt;/p>
&lt;p>é…ç½® cgroup æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥ä¿®æ”¹ &lt;code>cgroupfs&lt;/code> ä¸­çš„æŒ‡å®šæ–‡ä»¶ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡ &lt;code>runc&lt;/code> æˆ– &lt;code>docker&lt;/code> ç­‰é«˜é˜¶å·¥å…·å®ç°ã€‚&lt;/p>
&lt;h3 id="æ–‡ä»¶ç³»ç»Ÿæ–¹å¼">æ–‡ä»¶ç³»ç»Ÿæ–¹å¼&lt;/h3>
&lt;p>é€šè¿‡ &lt;code>cgroupfs&lt;/code> çš„æ–¹å¼ï¼ŒæŸ¥çœ‹/ä¿®æ”¹è¯¥ cgroup ç›®å½•ä¸‹çš„ç‰¹å®šæ–‡ä»¶å³å¯æŸ¥çœ‹/è®¾ç½®è¯¥ cgroup çš„é™é¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cat /sys/fs/cgroup/memory/user.slice/user-0.slice/session-5.scope/mybox/memory.limit_in_bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">9223372036854771712&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¿®æ”¹ &lt;code>memory.limit_in_bytes&lt;/code> æ–‡ä»¶å³å¯è®¾ç½®æœ€å¤§å¯ç”¨å†…å­˜ï¼Œç°åœ¨æˆ‘ä»¬å¹¶æœªå¯¹è¯¥å®¹å™¨è®¾ç½®ä»»ä½•é™åˆ¶ï¼Œå› æ­¤å†…å­˜é™åˆ¶çš„å½“å‰å€¼æ˜¯ä¸€ä¸ªæ— æ„ä¹‰çš„ç‰¹åˆ«å¤§çš„å€¼ï¼Œç°åœ¨æˆ‘ä»¬å‘è¯¥æ–‡ä»¶ç›´æ¥å†™å…¥æ–°çš„å€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;100000000&amp;#34;&lt;/span> &amp;gt; /sys/fs/cgroup/memory/user.slice/user-0.slice/session-5.scope/mybox/memory.limit_in_bytes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™æ ·å°±è®¾ç½®äº†æ–°çš„å†…å­˜é™åˆ¶ã€‚å†™å…¥æ–°çš„é™åˆ¶å€¼åï¼Œå®¹å™¨ä¸­çš„æ‰€æœ‰è¿›ç¨‹ä¸èƒ½ä½¿ç”¨æ€»å…±è¶…è¿‡ 100M çš„å†…å­˜ï¼Œè¶…è¿‡åå°†æ ¹æ® &lt;code>memory.oom_control&lt;/code> æ–‡ä»¶ä¸­è®¾ç½®çš„ &lt;code>OOM&lt;/code> ç­–ç•¥ &lt;code>kill&lt;/code> æˆ– &lt;code>sleep&lt;/code> å®¹å™¨ä¸­çš„è¿›ç¨‹ã€‚&lt;/p>
&lt;h3 id="é«˜é˜¶å·¥å…·æ–¹å¼">é«˜é˜¶å·¥å…·æ–¹å¼&lt;/h3>
&lt;p>é€šè¿‡é«˜é˜¶å·¥å…·æä¾›çš„é€”å¾„æ¥é…ç½® cgroup æ˜¯ä¸€ç§æ›´å‹å¥½çš„æ–¹å¼ï¼Œè™½ç„¶è¿™äº›å·¥å…·èƒŒåçš„å®ç°ä¹Ÿæ˜¯å¦‚ä¸Šæ‰€è¿°æ›´æ”¹ &lt;code>cgroupfs&lt;/code>ã€‚&lt;/p>
&lt;p>å¯¹äº &lt;code>runc&lt;/code> æ¥è¯´ï¼Œéœ€è¦ä¿®æ”¹ &lt;code>filesystem bundle&lt;/code> ä¸­çš„ &lt;code>config.json&lt;/code> æ–‡ä»¶æ¥é…ç½® cgroupã€‚è®¾ç½®å†…å­˜é™åˆ¶éœ€è¦å¦‚ä¸‹ä¿®æ”¹ JSON å¯¹è±¡ä¸­çš„ &lt;code>linux.resources&lt;/code> å­—æ®µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;resources&amp;#34;&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;memory&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;limit&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">100000&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;reservation&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">200000&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äº &lt;code>docker&lt;/code> æ¥è¯´æ›´ä¸ºç®€å•ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªé¢å‘ç”¨æˆ·çš„å°è£…å¥½çš„å·¥å…·ï¼Œæ‰§è¡Œ &lt;code>docker run&lt;/code> å‘½ä»¤æ—¶é€šè¿‡ &lt;code>--memory&lt;/code> é€‰é¡¹å³å¯æŒ‡å®šå†…å­˜é™åˆ¶ã€‚å®é™…ä¸Šè¯¥å‚æ•°ä¼šè¢«å†™å…¥åˆ° &lt;code>config.json&lt;/code> ç”±è¿è¡Œæ—¶å®ç° &lt;code>runc&lt;/code> ä½¿ç”¨ï¼Œå†ç”± &lt;code>runc&lt;/code> å»æ›´æ”¹ &lt;code>cgroupfs&lt;/code>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://pierrchen.blogspot.com/2018/04/container-deep-dive-2-linux-cgroups.html">Understand Container 2: Linux cgroups&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Cgroups">cgroups-wikipedia&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.docker.com/config/containers/resource_constraints/#limit-a-containers-access-to-memory">Limit a containerâ€™s access to memory&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/opencontainers/runtime-spec/blob/master/config-linux.md#memory">Control groups - Memory&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/%E5%AE%B9%E5%99%A8/" term="å®¹å™¨" label="å®¹å™¨"/><category scheme="https://waynerv.com/tags/cgroups/" term="Cgroups" label="Cgroups"/></entry><entry><title type="text">å®¹å™¨æŠ€æœ¯åŸç†(äºŒ)ï¼šä½¿ç”¨ Namespace å®ç°è¿›ç¨‹éš”ç¦»</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/container-fundamentals-process-isolation-using-namespace/"/><id>https://waynerv.com/posts/container-fundamentals-process-isolation-using-namespace/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-07-21T12:45:11+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">Namespace æ˜¯ç”± Linux å†…æ ¸æä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€äº›ç³»ç»Ÿèµ„æºåŒ…è£…åˆ°ä¸€ä¸ªæŠ½è±¡çš„ç©ºé—´ä¸­ï¼Œå¹¶ä½¿å¾—è¯¥ç©ºé—´ä¸­çš„è¿›ç¨‹ä»¥ä¸ºè¿™äº›èµ„æºæ˜¯ç³»ç»Ÿä¸­ä»…æœ‰çš„èµ„æºã€‚Namespace æ˜¯æ„å»ºå®¹å™¨æŠ€æœ¯çš„åŸºçŸ³ã€‚</summary><content type="html">&lt;p>Namespace æ˜¯ç”± Linux å†…æ ¸æä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿå°†ä¸€äº›ç³»ç»Ÿèµ„æºåŒ…è£…åˆ°ä¸€ä¸ªæŠ½è±¡çš„ç©ºé—´ä¸­ï¼Œå¹¶ä½¿å¾—è¯¥ç©ºé—´ä¸­çš„è¿›ç¨‹ä»¥ä¸ºè¿™äº›èµ„æºæ˜¯ç³»ç»Ÿä¸­ä»…æœ‰çš„èµ„æºã€‚Namespace æ˜¯æ„å»ºå®¹å™¨æŠ€æœ¯çš„åŸºçŸ³ï¼Œå®ƒä½¿å¾—å®¹å™¨å†…çš„è¿›ç¨‹åªèƒ½çœ‹åˆ°å®¹å™¨å†…çš„è¿›ç¨‹å’Œèµ„æºï¼Œå®ç°ä¸å®¿ä¸»ç³»ç»Ÿä»¥åŠå…¶ä»–å®¹å™¨çš„è¿›ç¨‹å’Œèµ„æºéš”ç¦»ã€‚&lt;/p>
&lt;p>Namespace æŒ‰æ“ä½œçš„ç³»ç»Ÿèµ„æºä¸åŒæœ‰å¾ˆå¤šç§ç±»ï¼Œæ¯”å¦‚ cgroup namespaceï¼Œmount namespace ç­‰ç­‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»…ä»¥ pid namespace ä¸ºä¾‹ï¼Œä»¥ &lt;code>runC&lt;/code> ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶å®ç°ï¼Œæ¥æ¼”ç¤ºå½“æˆ‘ä»¬æ‰§è¡Œå¯¹å®¹å™¨çš„æ“ä½œæ—¶ï¼Œnamespace æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚&lt;/p>
&lt;p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»ä»‹ç»è¿‡ï¼Œç»å¤§éƒ¨åˆ†å®¹å™¨ç³»ç»Ÿéƒ½ä½¿ç”¨ &lt;code>runC&lt;/code> ä½œä¸ºåº•å±‚çš„è¿è¡Œæ—¶å®ç°ï¼Œå¦‚æœä½ æ˜¯åœ¨ Linux å‘è¡Œç‰ˆç³»ç»Ÿä¸­ä½¿ç”¨ &lt;code>docker&lt;/code> ï¼Œç”šè‡³ä¸éœ€è¦ä¸“é—¨å®‰è£…å°±èƒ½ä½¿ç”¨ &lt;code>runc&lt;/code> å‘½ä»¤ã€‚&lt;/p>
&lt;h2 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ&lt;/h2>
&lt;h3 id="filesystem-bundle">filesystem bundle&lt;/h3>
&lt;p>&lt;code>runC&lt;/code> åªèƒ½ä» &lt;code>filesystem bundle&lt;/code> ä¸­æ‰§è¡Œå®¹å™¨ï¼ˆ&lt;code>filesystem bundle&lt;/code> é¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªæ»¡è¶³ç‰¹å®šç»“æ„çš„æ–‡ä»¶å¤¹ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code>docker&lt;/code> æ¥å‡†å¤‡ä¸€ä¸ªå¯ç”¨çš„ &lt;code>bundle&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»º bundle çš„é¡¶å±‚ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»ºç”¨äºå­˜æ”¾ root filesystem çš„ rootfs ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir rootfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ©ç”¨ Docker å¯¼å‡º busybox å®¹å™¨çš„ root filesystem &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker &lt;span class="nb">export&lt;/span> &lt;span class="k">$(&lt;/span>docker create busybox&lt;span class="k">)&lt;/span> &lt;span class="p">|&lt;/span> tar -C rootfs -xvf -
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åˆ›å»ºä¸€ä¸ª config.json ä½œä¸ºæ•´ä¸ª bundle çš„ spec&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ runc spec
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶æ•´ä¸ª &lt;code>bundle&lt;/code> çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ tree -L &lt;span class="m">2&lt;/span> /mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/mycontainer
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ config.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ rootfs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ etc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ proc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ sys
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ usr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ç³»ç»Ÿç›‘æµ‹å·¥å…·">ç³»ç»Ÿç›‘æµ‹å·¥å…·&lt;/h3>
&lt;p>ä¸ºäº†å®Œæˆæ¼”ç¤ºï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›ç¬¬ä¸‰æ–¹çš„ç³»ç»Ÿç›‘æµ‹å·¥å…·ä½œä¸ºè¾…åŠ©ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>ç›‘æµ‹è¿›ç¨‹çš„å¯åŠ¨ä»¥è·å¾—å®¹å™¨ä¸­è¿è¡Œè¿›ç¨‹çš„ PIDï¼Œå¦‚ ubuntu ä¸­çš„ &lt;code>forkstat&lt;/code> ï¼Œå®ƒå¯ä»¥å®æ—¶åœ°ç›‘æµ‹ &lt;code>fork()&lt;/code>, &lt;code>exec()&lt;/code> å’Œ &lt;code>exit()&lt;/code> ç­‰ç³»ç»Ÿè°ƒç”¨ï¼Œå®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ apt install forkstat
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æŸ¥çœ‹ namespace ä¿¡æ¯ï¼Œå¦‚ &lt;code>[cinf](https://github.com/mhausenblas/cinf)&lt;/code> ï¼Œå®ƒæ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ–¹ä¾¿åœ°åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰ namespace æˆ–æŸ¥çœ‹æŸä¸ª namespce è¯¦ç»†ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå®‰è£…æ–¹å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ curl -s -L https://github.com/mhausenblas/cinf/releases/latest/download/cinf_linux_amd64.tar.gz &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> -o cinf.tar.gz &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> tar xvzf cinf.tar.gz cinf &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> mv cinf /usr/local/bin &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> rm cinf*
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h2 id="ä½¿ç”¨-runc-è¿è¡Œå®¹å™¨">ä½¿ç”¨ runc è¿è¡Œå®¹å™¨&lt;/h2>
&lt;p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªçª—å£ä¸­è¿è¡Œ &lt;code>forkstat&lt;/code> ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ forkstat -e &lt;span class="nb">exec&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ç€å¦å¤–æ–°å»ºä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œåˆ‡æ¢åˆ° &lt;code>/mycontainer&lt;/code> ç›®å½•ï¼Œä½¿ç”¨ &lt;code>runC&lt;/code> è¿è¡Œå®¹å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc run mybox
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œåä¼šç›´æ¥è¿›å…¥åˆ°æ–°åˆ›å»ºçš„å®¹å™¨ä¸­ï¼Œè¿è¡Œ &lt;code>ps&lt;/code> å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">PID USER TIME COMMAND
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> root 0:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">7&lt;/span> root 0:00 ps
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>forkstat&lt;/code> çª—å£å°†ä¼šæœ‰ä»¥ä¸‹è¾“å‡ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Time Event PID Info Duration Process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33040&lt;/span> runc run mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33047&lt;/span> runc init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33049&lt;/span> dumpe2fs -h /dev/sdb3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33050&lt;/span> dumpe2fs -h /dev/sdb3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33047&lt;/span> runc init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:22 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33052&lt;/span> sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:35:37 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33062&lt;/span> ps
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»åŒæ­¥æ‰“å°çš„ç»“æœå¯ä»¥åˆ¤æ–­ï¼Œ &lt;code>ps&lt;/code> å’Œ &lt;code>forkstat&lt;/code> æ‰€åˆ†åˆ«è¾“å‡ºçš„ &lt;code>sh&lt;/code> æˆ– &lt;code>ps&lt;/code> å®é™…ä¸Šæ˜¯åŒä¸€ä¸ªè¿›ç¨‹ï¼Œä½†ç”±äºå®¹å™¨ä¸­çš„è¿›ç¨‹ä½äºä¸€ä¸ªå•ç‹¬çš„ pid namespace ä¸­ï¼Œå®ƒä»¬åœ¨å®¹å™¨ä¸­æ‹¥æœ‰å¦å¤–çš„ PIDï¼Œè€Œä¸”å®ƒä»¬ä»¥ä¸ºè‡ªå·±æ˜¯å®¹å™¨ä¸­å”¯ä¸€å­˜åœ¨çš„è¿›ç¨‹ï¼Œå› æ­¤ PID ä¼šä» 1 å¼€å§‹ã€‚&lt;/p>
&lt;h3 id="æ‰¾åˆ°è¿›ç¨‹æ‰€å±çš„-namespace">æ‰¾åˆ°è¿›ç¨‹æ‰€å±çš„ namespace&lt;/h3>
&lt;p>ç°åœ¨æ¥æ‰¾å‡ºå®¹å™¨æ‰€ä½¿ç”¨çš„ pid namespaceï¼Œä¸ºæ­¤éœ€è¦è°ƒæ•´ä¸€ä¸‹ &lt;code>ps&lt;/code> å‘½ä»¤çš„è¾“å‡ºæ ¼å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ps -p &lt;span class="m">33052&lt;/span> -o pid,pidns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">PID PIDNS
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">33052&lt;/span> &lt;span class="m">4026532395&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>PIDNS å³ pid namespaceï¼Œä»¥ä¸Šå‘½ä»¤å¯å¾—åˆ° PID ä¸º 33052 çš„ &lt;code>sh&lt;/code> è¿›ç¨‹å±äº 4026532395 è¿™ä¸ª pid namespaceã€‚æ—¢ç„¶å·²ç»æœ‰äº†å®¹å™¨ä¸­è¿›ç¨‹çš„ PIDï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡å®¿ä¸»æœºçš„ &lt;code>/proc&lt;/code> æ–‡ä»¶ç³»ç»Ÿè·å¾—è¯¥è¿›ç¨‹æ‰€å±çš„æ‰€æœ‰ namespaceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ll /proc/33052/ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:37 cgroup -&amp;gt; &lt;span class="s1">&amp;#39;cgroup:[4026531835]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 ipc -&amp;gt; &lt;span class="s1">&amp;#39;ipc:[4026532394]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 mnt -&amp;gt; &lt;span class="s1">&amp;#39;mnt:[4026532383]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 net -&amp;gt; &lt;span class="s1">&amp;#39;net:[4026532397]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 pid -&amp;gt; &lt;span class="s1">&amp;#39;pid:[4026532395]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:37 pid_for_children -&amp;gt; &lt;span class="s1">&amp;#39;pid:[4026532395]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:37 &lt;span class="nb">time&lt;/span> -&amp;gt; &lt;span class="s1">&amp;#39;time:[4026531834]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:37 time_for_children -&amp;gt; &lt;span class="s1">&amp;#39;time:[4026531834]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 user -&amp;gt; &lt;span class="s1">&amp;#39;user:[4026531837]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">21&lt;/span> 12:36 uts -&amp;gt; &lt;span class="s1">&amp;#39;uts:[4026532393]&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰“å°ç»“æœå±•ç¤ºäº†ä¸€ä¸ªè¿›ç¨‹æ‰€å±çš„ namespaceï¼š&lt;/p>
&lt;ol>
&lt;li>æ¯ä¸ª namespace éƒ½æ˜¯ä¸€ä¸ªè½¯é“¾æ¥ï¼Œè½¯é“¾æ¥çš„åç§°æŒ‡ç¤ºäº† namespace çš„ç±»å‹ï¼Œå¦‚ cgroup è¡¨ç¤º cgroup namespaceï¼Œ pid è¡¨ç¤º pid namespaceã€‚&lt;/li>
&lt;li>æ¯ä¸ªè½¯é“¾æ¥æŒ‡å‘è¯¥è¿›ç¨‹æ‰€å±çš„çœŸæ­£ namespace å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç”¨ &lt;code>inode&lt;/code> å·ç è¡¨ç¤ºï¼Œæ¯ä¸ª &lt;code>inode&lt;/code> å·ç åœ¨å®¿ä¸»ç³»ç»Ÿä¸­éƒ½æ˜¯å”¯ä¸€çš„ã€‚&lt;/li>
&lt;li>å¦‚æœæœ‰ä¸¤ä¸ªè¿›ç¨‹çš„åŒä¸€ç±»å‹ namespace è½¯é“¾æ¥éƒ½æŒ‡å‘åŒä¸€ä¸ª &lt;code>inode&lt;/code> ï¼Œè¯´æ˜ä»–ä»¬å±äºåŒä¸€ä¸ª namespaceã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;em>å®é™…ä¸Šæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¼šå±äºè‡³å°‘ä¸€ä¸ª namespaceï¼ŒLinux ç³»ç»Ÿåœ¨å¯åŠ¨æ—¶å°±ä¼šä¸ºæ‰€æœ‰ç±»å‹åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ namespace ä¾›è¿›ç¨‹ä½¿ç”¨ã€‚&lt;/em>&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å°è¯•åœ¨å®¹å™¨å†…è·å¾— &lt;code>sh&lt;/code> æ‰€å±çš„ namespaceï¼Œæ­¤æ—¶éœ€è¦åœ¨å®¹å™¨å†…ä½¿ç”¨ 1 è¿™ä¸ª PIDï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ls -l /proc/1/ns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 cgroup -&amp;gt; cgroup:&lt;span class="o">[&lt;/span>4026531835&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 ipc -&amp;gt; ipc:&lt;span class="o">[&lt;/span>4026532394&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 mnt -&amp;gt; mnt:&lt;span class="o">[&lt;/span>4026532383&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 net -&amp;gt; net:&lt;span class="o">[&lt;/span>4026532397&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 pid -&amp;gt; pid:&lt;span class="o">[&lt;/span>4026532395&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 pid_for_children -&amp;gt; pid:&lt;span class="o">[&lt;/span>4026532395&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 &lt;span class="nb">time&lt;/span> -&amp;gt; time:&lt;span class="o">[&lt;/span>4026531834&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 time_for_children -&amp;gt; time:&lt;span class="o">[&lt;/span>4026531834&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 user -&amp;gt; user:&lt;span class="o">[&lt;/span>4026531837&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">lrwxrwxrwx &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> Jul &lt;span class="m">21&lt;/span> 04:37 uts -&amp;gt; uts:&lt;span class="o">[&lt;/span>4026532393&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è§‚å¯Ÿ-namespace-ä¸­çš„è¿›ç¨‹">è§‚å¯Ÿ namespace ä¸­çš„è¿›ç¨‹&lt;/h3>
&lt;p>ä¸‹é¢æˆ‘ä»¬å°†ä» namespace çš„è§’åº¦ï¼Œæ¥è§‚æµ‹ pid namespace ä¸­çš„æ‰€æœ‰è¿›ç¨‹ã€‚Linux ç³»ç»Ÿå¹¶æœªæä¾›ç±»ä¼¼çš„åŠŸèƒ½ï¼Œå› æ­¤éœ€è¦å€ŸåŠ©ä¸Šæ–‡å®‰è£…çš„ &lt;code>cinf&lt;/code> å·¥å…·æ¥å®ç°ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf -namespace &lt;span class="m">4026532395&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PID PPID NAME CMD NTHREADS CGROUPS STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">33052&lt;/span> &lt;span class="m">33052&lt;/span> sh sh &lt;span class="m">1&lt;/span> 12:devices:/user.slice/mybox S &lt;span class="o">(&lt;/span>sleeping&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11:blkio:/user.slice/mybox 10:rdma:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 9:memory:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8:net_cls,net_prio:/mybox 7:freezer:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6:pids:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5:cpu,cpuacct:/user.slice/mybox 4:cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3:perf_event:/mybox 2:hugetlb:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1:name&lt;span class="o">=&lt;/span>systemd:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0::/user.slice/user-0.slice/session-590.scope
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›®å‰è¿™ä¸ª namespace ä¸­åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯æˆ‘ä»¬æ‰€åˆ›å»ºå®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹ã€‚å½“ä¸€ä¸ªæ–°çš„å®¹å™¨è¢«åˆ›å»ºæ—¶ï¼Œç³»ç»Ÿå°†åˆ›å»ºä¸€äº›æ–°çš„ namespaceï¼Œå®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹å°†è¢«åŠ å…¥åˆ°è¿™äº› namespaceã€‚&lt;/p>
&lt;p>å¯¹äº pid namespace æ¥è¯´ï¼Œå®¹å™¨ä¸­è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹åªèƒ½çœ‹åˆ°ä½äºåŒä¸€ pid namespace å³ &lt;code>pid:[4026532395]&lt;/code> ä¸­çš„å…¶ä»–è¿›ç¨‹ã€‚&lt;code>sh&lt;/code> è¿›ç¨‹åœ¨å®¹å™¨ä¸­è¢«è®¤ä¸ºæ˜¯ç³»ç»Ÿè¿è¡Œçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ŒPID ä¸º 1ï¼Œä½†åœ¨å®¿ä¸»æœºä¸­åªæ˜¯ä¸€ä¸ª PID ä¸º 33052 çš„æ™®é€šè¿›ç¨‹ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åŒ namespace ä¸­æ‹¥æœ‰ä¸åŒçš„ PIDï¼Œè¿™å°±æ˜¯ pid namespace çš„ä½œç”¨ã€‚æŸç§ç¨‹åº¦ä¸Šï¼Œå®¹å™¨å°±æ„å‘³ç€ä¸€ä¸ªæ–°çš„ namespace é›†åˆã€‚&lt;/p>
&lt;h2 id="åœ¨å®¹å™¨ä¸­åˆ›å»ºæ–°çš„è¿›ç¨‹">åœ¨å®¹å™¨ä¸­åˆ›å»ºæ–°çš„è¿›ç¨‹&lt;/h2>
&lt;p>åˆ›å»ºä¸€ä¸ªæ–°çš„ç»ˆç«¯çª—å£ï¼Œåœ¨å·²è¿è¡Œçš„å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc &lt;span class="nb">exec&lt;/span> mybox /bin/top -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä» &lt;code>forkstat&lt;/code> çª—å£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ–°åˆ›å»ºè¿›ç¨‹çš„ PIDï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Time Event PID Info Duration Process
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:40:23 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33132&lt;/span> runc &lt;span class="nb">exec&lt;/span> mybox /bin/top -b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:40:23 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33140&lt;/span> runc init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:40:23 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33140&lt;/span> runc init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">12:40:23 &lt;span class="nb">exec&lt;/span> &lt;span class="m">33142&lt;/span> /bin/top -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®é™…ä¸Šè¿˜æœ‰æ›´ç›´æ¥çš„æ–¹å¼ä»å®¿ä¸»æœºä¸­æŸ¥çœ‹å®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code>runC&lt;/code> æä¾›çš„ &lt;code>ps&lt;/code> å­å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ runc ps mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">UID PID PPID C STIME TTY TIME CMD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">33052&lt;/span> &lt;span class="m">33040&lt;/span> &lt;span class="m">0&lt;/span> 12:35 pts/0 00:00:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">root &lt;span class="m">33142&lt;/span> &lt;span class="m">33132&lt;/span> &lt;span class="m">0&lt;/span> 12:40 pts/1 00:00:00 /bin/top -b
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥ä¾ç„¶ä½¿ç”¨ &lt;code>cinf&lt;/code> æ¥æ‰¾å‡ºæ–°åˆ›å»ºè¿›ç¨‹æ‰€å±çš„ namespaceï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf --pid &lt;span class="m">33142&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> NAMESPACE TYPE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532383&lt;/span> mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532393&lt;/span> uts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532394&lt;/span> ipc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532395&lt;/span> pid
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026532397&lt;/span> net
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">4026531837&lt;/span> user
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ç»“æœæ¥çœ‹ï¼Œå¹¶æ²¡æœ‰æ–°çš„å‘½åç©ºé—´è¢«åˆ›å»ºï¼Œ32608 è¿›ç¨‹çš„ namespace å’Œ mybox å®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹- &lt;code>sh&lt;/code> æ‰€å±çš„ namespace æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®¹å™¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œåªæ˜¯å°†è¿™ä¸ªè¿›ç¨‹åŠ å…¥åˆ°äº†å®¹å™¨ &lt;code>init&lt;/code> è¿›ç¨‹æ‰€å±çš„ namespaceã€‚&lt;/p>
&lt;p>ä¸‹é¢æ¥åˆ—å‡º 4026532395 namespace æ‰€æ‹¥æœ‰çš„æ‰€æœ‰è¿›ç¨‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cinf --namespace &lt;span class="m">4026532395&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> PID PPID NAME CMD NTHREADS CGROUPS STATE
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">33052&lt;/span> &lt;span class="m">33040&lt;/span> sh sh &lt;span class="m">1&lt;/span> 12:devices:/user.slice/mybox S &lt;span class="o">(&lt;/span>sleeping&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11:blkio:/user.slice/mybox 10:rdma:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 9:memory:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8:net_cls,net_prio:/mybox 7:freezer:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6:pids:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5:cpu,cpuacct:/user.slice/mybox 4:cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3:perf_event:/mybox 2:hugetlb:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1:name&lt;span class="o">=&lt;/span>systemd:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0::/user.slice/user-0.slice/session-590.scope
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">33142&lt;/span> &lt;span class="m">33132&lt;/span> top top -b &lt;span class="m">1&lt;/span> 12:devices:/user.slice/mybox S &lt;span class="o">(&lt;/span>sleeping&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 11:blkio:/user.slice/mybox 10:rdma:/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 9:memory:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 8:net_cls,net_prio:/mybox 7:freezer:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 6:pids:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 5:cpu,cpuacct:/user.slice/mybox 4:cpuset:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 3:perf_event:/mybox 2:hugetlb:/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 1:name&lt;span class="o">=&lt;/span>systemd:/user.slice/user-0.slice/session-590.scope/mybox
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> 0::/user.slice/user-0.slice/session-590.scope
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœåœ¨å®¹å™¨å†…è¿è¡Œ &lt;code>ps -ef&lt;/code> ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹åˆ°è¿™äº›è¿›ç¨‹ï¼Œç”±äº pid namespace çš„åŸå› å®ƒä»¬çš„ PID å°†ä¼šæœ‰æ‰€ä¸åŒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">PID USER TIME COMMAND
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> root 0:00 sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">19&lt;/span> root 0:00 top -b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">20&lt;/span> root 0:00 ps -ef
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œ&lt;code>docker/runc exec&lt;/code> å®é™…ä¸Šå°±æ˜¯åœ¨å·²åˆ›å»ºå®¹å™¨çš„ namespace ä¸­è¿è¡Œä¸€ä¸ªæ–°çš„è¿›ç¨‹ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå°†åˆ›å»ºä¸€äº›æ–°çš„ namespaceï¼Œ &lt;code>init&lt;/code> è¿›ç¨‹å°†è¢«åŠ å…¥åˆ°è¿™äº› namespaceï¼›åœ¨ä¸€ä¸ªå®¹å™¨ä¸­è¿è¡Œä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œæ–°è¿›ç¨‹å°†åŠ å…¥åˆ›å»ºå®¹å™¨æ—¶æ‰€åˆ›å»ºçš„ namespaceã€‚&lt;/p>
&lt;p>å®é™…ä¸Šåˆ›å»ºå®¹å™¨æ—¶æ–°å»º namespace è¿™ç§è¡Œä¸ºæ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šæ–°å»ºçš„å®¹å™¨ä½¿ç”¨å·²æœ‰çš„ namespaceã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://pierrchen.blogspot.com/2018/04/linux-namespaces-in-action-using-runc.html">Understand Container 1: Linux Namespaces&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/opencontainers/runc/blob/master/README.md#creating-an-oci-bundle">Creating an OCI Bundle&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://jarekprzygodzki.dev/post/monitor-new-process-creation/">Monitoring new process creation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Linux_namespaces">Linux namespaces&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/%E5%AE%B9%E5%99%A8/" term="å®¹å™¨" label="å®¹å™¨"/><category scheme="https://waynerv.com/tags/namespace/" term="Namespace" label="Namespace"/></entry><entry><title type="text">å®¹å™¨æŠ€æœ¯åŸç†(ä¸€)ï¼šä»æ ¹æœ¬ä¸Šè®¤è¯†å®¹å™¨é•œåƒ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/container-fundamentals-learn-container-with-oci-spec/"/><id>https://waynerv.com/posts/container-fundamentals-learn-container-with-oci-spec/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-07-20T13:24:03+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">OCI è§„èŒƒæ˜¯äº‹å®ä¸Šçš„å®¹å™¨æ ‡å‡†ï¼Œå·²ç»è¢«å¤§éƒ¨åˆ†å®¹å™¨å®ç°ä»¥åŠå®¹å™¨ç¼–æ’ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼Œå®ƒæè¿°äº†å®¹å™¨å¦‚ä½•è¢«åˆ›å»ºå’Œè¿è¡Œï¼Œäº†è§£ OCI è§„èŒƒæœ‰åŠ©äºå¯¹å®¹å™¨æŠ€æœ¯å»ºç«‹æ›´æœ¬è´¨å…¨é¢çš„è®¤çŸ¥ã€‚</summary><content type="html">&lt;h2 id="ä»-oci-è§„èŒƒè¯´èµ·">ä» OCI è§„èŒƒè¯´èµ·&lt;/h2>
&lt;p>OCIï¼ˆOpen Container Initiativeï¼‰è§„èŒƒæ˜¯äº‹å®ä¸Šçš„å®¹å™¨æ ‡å‡†ï¼Œå·²ç»è¢«å¤§éƒ¨åˆ†å®¹å™¨å®ç°ä»¥åŠå®¹å™¨ç¼–æ’ç³»ç»Ÿæ‰€é‡‡ç”¨ï¼ŒåŒ…æ‹¬ Docker å’Œ Kubernetesã€‚å®ƒçš„å‡ºç°æ˜¯ä¸€æ®µå…³äºå¼€æºå•†ä¸šåŒ–çš„æœ‰è¶£å†å²ï¼šå®ƒç”± Dokcer å…¬å¸ä½œä¸ºé¢†å¤´è€…åœ¨ 2015 å¹´æ¨å‡ºï¼Œä½†å¦‚ä»Š Docker å…¬å¸åœ¨å®¹å™¨è¡Œä¸šä¸­å·²ç»æˆäº†æ‰“å·¥ä»”ã€‚&lt;/p>
&lt;p>ä» OCI è§„èŒƒå¼€å§‹äº†è§£å®¹å™¨é•œåƒï¼Œå¯ä»¥è®©æˆ‘ä»¬å¯¹å®¹å™¨æŠ€æœ¯å»ºç«‹æ›´å…¨é¢æ¸…æ™°çš„è®¤çŸ¥ï¼Œè€Œä¸æ˜¯å›¿äºå®ç°ç»†èŠ‚ã€‚OCI è§„èŒƒåˆ†ä¸º &lt;code>Image spec&lt;/code> å’Œ &lt;code>Runtime spec&lt;/code> ä¸¤éƒ¨åˆ†ï¼Œå®ƒä»¬åˆ†åˆ«è¦†ç›–äº†å®¹å™¨ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒé˜¶æ®µï¼š&lt;/p>
&lt;p>&lt;img src="2021-07-20-oci-spec.png" alt="">&lt;/p>
&lt;h2 id="é•œåƒè§„èŒƒ">é•œåƒè§„èŒƒ&lt;/h2>
&lt;p>é•œåƒè§„èŒƒå®šä¹‰äº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªç¬¦åˆ OCI è§„èŒƒçš„é•œåƒï¼Œå®ƒè§„å®šäº†é•œåƒçš„æ„å»ºç³»ç»Ÿéœ€è¦è¾“å‡ºçš„å†…å®¹å’Œæ ¼å¼ï¼Œè¾“å‡ºçš„å®¹å™¨é•œåƒå¯ä»¥è¢«è§£åŒ…æˆä¸€ä¸ª &lt;code>runtime bundle&lt;/code> ï¼Œ&lt;code>runtime bundle&lt;/code> æ˜¯ç”±ç‰¹å®šæ–‡ä»¶å’Œç›®å½•ç»“æ„ç»„æˆçš„ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä»ä¸­å¯ä»¥æ ¹æ®è¿è¡Œæ—¶æ ‡å‡†è¿è¡Œå®¹å™¨ã€‚&lt;/p>
&lt;h3 id="é•œåƒé‡Œé¢éƒ½æœ‰ä»€ä¹ˆ">é•œåƒé‡Œé¢éƒ½æœ‰ä»€ä¹ˆ&lt;/h3>
&lt;p>è§„èŒƒè¦æ±‚é•œåƒå†…å®¹å¿…é¡»åŒ…æ‹¬ä»¥ä¸‹ 3 éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Image Manifest&lt;/strong>ï¼šæä¾›äº†é•œåƒçš„é…ç½®å’Œæ–‡ä»¶ç³»ç»Ÿå±‚å®šä½ä¿¡æ¯ï¼Œå¯ä»¥çœ‹ä½œæ˜¯é•œåƒçš„ç›®å½•ï¼Œæ–‡ä»¶æ ¼å¼ä¸º &lt;code>json&lt;/code> ã€‚&lt;/li>
&lt;li>&lt;strong>Image Layer Filesystem Changeset&lt;/strong>ï¼šåºåˆ—åŒ–ä¹‹åçš„æ–‡ä»¶ç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿå˜æ›´ï¼Œå®ƒä»¬å¯æŒ‰é¡ºåºä¸€å±‚å±‚åº”ç”¨ä¸ºä¸€ä¸ªå®¹å™¨çš„ rootfsï¼Œå› æ­¤é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºä¸€ä¸ª &lt;code>layer&lt;/code>ï¼ˆä¸ä¸‹æ–‡æåˆ°çš„é•œåƒå±‚åŒä¹‰ï¼‰ï¼Œæ–‡ä»¶æ ¼å¼å¯ä»¥æ˜¯ &lt;code>tar&lt;/code> ï¼Œ&lt;code>gzip&lt;/code> ç­‰å­˜æ¡£æˆ–å‹ç¼©æ ¼å¼ã€‚&lt;/li>
&lt;li>&lt;strong>Image Configuration&lt;/strong>ï¼šåŒ…å«äº†é•œåƒåœ¨è¿è¡Œæ—¶æ‰€ä½¿ç”¨çš„æ‰§è¡Œå‚æ•°ä»¥åŠæœ‰åºçš„ rootfs å˜æ›´ä¿¡æ¯ï¼Œæ–‡ä»¶ç±»å‹ä¸º &lt;code>json&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;em>rootfs (root file system)å³ &lt;code>/&lt;/code> æ ¹æŒ‚è½½ç‚¹æ‰€æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿæ‰€åŒ…å«çš„æ–‡ä»¶ã€é…ç½®å’Œç›®å½•ï¼Œä½†å¹¶ä¸åŒ…æ‹¬æ“ä½œç³»ç»Ÿå†…æ ¸ï¼ŒåŒä¸€å°æœºå™¨ä¸Šçš„æ‰€æœ‰å®¹å™¨éƒ½å…±äº«å®¿ä¸»æœºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ã€‚&lt;/em>&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ &lt;code>Docker&lt;/code> å’Œ &lt;code>nginx&lt;/code> ä¸ºä¾‹æ¢ç´¢ä¸€ä¸ªé•œåƒçš„å®é™…å†…å®¹ã€‚æ‹‰å–ä¸€ä¸ªæœ€æ–°ç‰ˆæœ¬çš„ &lt;code>nginx&lt;/code> é•œåƒå°†å…¶ &lt;code>save&lt;/code> ä¸º tar åŒ…åè§£å‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ docker pull nginx
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ docker save nginx -o nginx-img.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ mkdir nginx-img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ tar -xf nginx-img.tar --directory&lt;span class="o">=&lt;/span>nginx-img
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¾—åˆ° &lt;code>nginx-img&lt;/code> ç›®å½•ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">nginx-img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 013a6edf61f54428da349193e7a2077a714697991d802a1c5298b07dbe0519c9
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 2bf70c858e6c8243c4713064cf43dea840866afefe52089a3b339f06576b930e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 4cdc5dd7eaadff5080649e8d0014f2f8d36d4ddf2eff2fdf577dd13da85c5d2f.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 761c908ee54e7ccd769e815f38e3040f7b3ff51f1c04f55aac12b9ea3d544cfe
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ d18832ef411b346c36b7ba42a6c2e3f77097026fb80651c2d870f19c6fd9ccef
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ layer.tar
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ VERSION
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ manifest.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ repositories
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¦–å…ˆæŸ¥çœ‹ &lt;code>manifest.json&lt;/code> æ–‡ä»¶çš„å†…å®¹ï¼Œå³è¯¥é•œåƒçš„ Image Manifestï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ python -m json.tool manifest.json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Config&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;4cdc5dd7eaadff5080649e8d0014f2f8d36d4ddf2eff2fdf577dd13da85c5d2f.json&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Layers&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f/layer.tar&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;2bf70c858e6c8243c4713064cf43dea840866afefe52089a3b339f06576b930e/layer.tar&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;013a6edf61f54428da349193e7a2077a714697991d802a1c5298b07dbe0519c9/layer.tar&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;761c908ee54e7ccd769e815f38e3040f7b3ff51f1c04f55aac12b9ea3d544cfe/layer.tar&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;d18832ef411b346c36b7ba42a6c2e3f77097026fb80651c2d870f19c6fd9ccef/layer.tar&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd/layer.tar&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;RepoTags&amp;#34;&lt;/span>: &lt;span class="o">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;nginx:latest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­è®°è½½äº† &lt;code>Config&lt;/code> å’Œ &lt;code>Layers&lt;/code> çš„æ–‡ä»¶å®šä½ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ ‡å‡†ä¸­æ‰€è§„å®šçš„ Image Layer Filesystem Changeset å’Œ Image Configurationã€‚&lt;/p>
&lt;p>&lt;code>Config&lt;/code> å­˜æ”¾åœ¨å¦ä¸€ä¸ª json æ–‡ä»¶ä¸­ï¼Œå†…å®¹è¾ƒå¤šæˆ‘ä»¬ä¸åšå±•ç¤ºï¼Œå…·ä½“åŒ…å«äº†ä»¥ä¸‹ä¿¡æ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>é•œåƒçš„é…ç½®ï¼Œåœ¨é•œåƒè§£å‹æˆ &lt;code>runtime bundle&lt;/code> åå°†å†™å…¥è¿è¡Œæ—¶é…ç½®æ–‡ä»¶ã€‚&lt;/li>
&lt;li>é•œåƒçš„ &lt;code>layers&lt;/code> ä¹‹é—´çš„ Diff IDã€‚&lt;/li>
&lt;li>é•œåƒçš„æ„å»ºå†å²ç­‰å…ƒä¿¡æ¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>Layers&lt;/code> åˆ—è¡¨ä¸­çš„ tar åŒ…å…±åŒç»„æˆäº†ç”Ÿæˆå®¹å™¨çš„ rootfsï¼Œå®¹å™¨çš„é•œåƒæ˜¯åˆ†å±‚æ„å»ºçš„ï¼Œ &lt;code>Layers&lt;/code> ä¸­çš„å…ƒç´ é¡ºåºè¿˜ä»£è¡¨äº†é•œåƒå±‚å åŠ çš„é¡ºåºï¼Œæ‰€æœ‰ &lt;code>layer&lt;/code> ç»„æˆä¸€ä¸ªç”±ä¸‹å¾€ä¸Šå åŠ çš„æ ˆå¼çš„ç»“æ„ã€‚é¦–å…ˆçœ‹ä¸€ä¸‹åŸºç¡€å±‚å³ç¬¬ä¸€æ¡è®°å½•ä¸­çš„å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mkdir base
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ tar -xf 490a3e67a61048564048a15d501b8e075d951d0dbba8098d5788bb8453f2371f/layer.tar --directory&lt;span class="o">=&lt;/span>base
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>base&lt;/code> ç›®å½•ä¸­è§£å‹å¾—åˆ°çš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">28&lt;/span> root root &lt;span class="m">4096&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 etc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">7&lt;/span> root root &lt;span class="m">85&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">34&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 lib64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 media
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 opt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 proc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> root root &lt;span class="m">37&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">30&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 sbin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 srv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 sys
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxrwxrwt &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">10&lt;/span> root root &lt;span class="m">105&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 usr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">11&lt;/span> root root &lt;span class="m">139&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™å·²ç»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ rootfsï¼Œå†è§‚å¯Ÿæœ€ä¸Šé¢ä¸€å±‚ &lt;code>layer&lt;/code> æ‰€å¾—åˆ°çš„æ–‡ä»¶å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">96bfd5bf4ab4c2513fb43534d51e816c4876620767858377d14dcc5a7de5f1fd/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ docker-entrypoint.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ 30-tune-worker-processes.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­åªæœ‰ä¸€ä¸ª shell è„šæœ¬æ–‡ä»¶ï¼Œè¿™è¯´æ˜é•œåƒçš„æ„å»ºè¿‡ç¨‹æ˜¯å¢é‡çš„ï¼Œæ¯ä¸€å±‚éƒ½åªåŒ…å«äº†å’Œæ›´ä½ä¸€å±‚ç›¸æ¯”æ‰€å˜æ›´çš„æ–‡ä»¶å†…å®¹ï¼Œè¿™ä¹Ÿæ˜¯å®¹å™¨é•œåƒå¾—ä»¥ä¿æŒè¾ƒå°ä½“ç§¯çš„åŸå› ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•åœ¨é•œåƒå±‚ä¸­åˆ é™¤ä¸€ä¸ªæ–‡ä»¶">å¦‚ä½•åœ¨é•œåƒå±‚ä¸­åˆ é™¤ä¸€ä¸ªæ–‡ä»¶&lt;/h3>
&lt;p>&lt;code>Layers&lt;/code> ä¸­çš„æ¯ä¸€å±‚éƒ½æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´é›†ï¼ˆChangeSetï¼‰ï¼Œå˜æ›´é›†åŒ…å«æ–°å¢ã€ä¿®æ”¹å’Œåˆ é™¤ä¸‰ç§å˜æ›´ï¼Œæ–°å¢æˆ–ä¿®æ”¹ï¼ˆæ›¿æ¢ï¼‰æ–‡ä»¶çš„æƒ…å†µè¾ƒå¥½å¤„ç†ï¼Œä½†å¦‚ä½•åœ¨åº”ç”¨å˜æ›´é›†æ—¶åˆ é™¤ä¸€ä¸ªæ–‡ä»¶å‘¢ï¼Œç­”æ¡ˆæ˜¯ç”¨ Whiteouts è¡¨ç¤ºè¦åˆ é™¤çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ã€‚&lt;/p>
&lt;p>Whiteouts æ–‡ä»¶æ˜¯ä¸€ä¸ªå…·æœ‰ç‰¹æ®Šæ–‡ä»¶åçš„ç©ºæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸­é€šè¿‡åœ¨è¦åˆ é™¤çš„è·¯å¾„åŸºæœ¬åç§°æ·»åŠ å‰ç¼€ &lt;code>.wh.&lt;/code> æ ‡å¿—ä¸€ä¸ªï¼ˆæ›´ä½ä¸€å±‚ä¸­çš„ï¼‰è·¯å¾„åº”è¯¥è¢«åˆ é™¤ã€‚å‡å¦‚åœ¨æŸä¸ª &lt;code>layer&lt;/code> æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./etc/my-app.d/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./etc/my-app.d/default.cfg
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./bin/my-app-tools
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./etc/my-app-config
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚æœåœ¨åº”ç”¨çš„æ›´é«˜å±‚ &lt;code>layer&lt;/code> ä¸­å«æœ‰ &lt;code>./etc/.wh.my-app-config&lt;/code> ï¼Œåº”ç”¨è¯¥å±‚å˜æ›´æ—¶åŸæœ‰çš„ &lt;code>./etc/my-app-config&lt;/code> è·¯å¾„å°†è¢«åˆ é™¤ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•å°†å¤šä¸ªé•œåƒå±‚åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ">å¦‚ä½•å°†å¤šä¸ªé•œåƒå±‚åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ&lt;/h3>
&lt;p>è§„èŒƒä¸­å¯¹äºå¦‚ä½•å°†å¤šä¸ªé•œåƒå±‚åº”ç”¨æˆä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿåªæœ‰åŸç†æ€§çš„æè¿°ï¼Œå‡å¦‚æˆ‘ä»¬è¦åœ¨ &lt;code>layer A&lt;/code> çš„åŸºç¡€ä¸Šåº”ç”¨ &lt;code>Layer B&lt;/code> ï¼š&lt;/p>
&lt;ul>
&lt;li>é¦–å…ˆå°† &lt;code>Layer A&lt;/code> ä¸­çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ä»¥ä¿ç•™æ–‡ä»¶å±æ€§çš„æ–¹å¼å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¿«ç…§ç›®å½• &lt;code>A.snapshot&lt;/code>&lt;/li>
&lt;li>ç„¶ååœ¨å¿«ç…§ç›®å½•ä¸­æ‰§è¡Œ &lt;code>Layer B&lt;/code> æ‰€åŒ…å«çš„æ–‡ä»¶å˜æ›´ï¼Œæ‰€æœ‰çš„æ›´æ”¹ä¸ä¼šå½±å“åŸæœ‰çš„å˜æ›´é›†ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨å®è·µä¸­ä¼šé‡‡ç”¨è”åˆæ–‡ä»¶ç³»ç»Ÿç­‰æ›´ä¸ºé«˜æ•ˆçš„å®ç°ã€‚&lt;/p>
&lt;h4 id="ä»€ä¹ˆæ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿ">ä»€ä¹ˆæ˜¯è”åˆæ–‡ä»¶ç³»ç»Ÿ&lt;/h4>
&lt;p>è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆUnion File Systemï¼‰ä¹Ÿå« UnionFSï¼Œä¸»è¦çš„åŠŸèƒ½æ˜¯å°†å¤šä¸ªä¸åŒä½ç½®çš„ç›®å½•è”åˆæŒ‚è½½ï¼ˆunion mountï¼‰åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ã€‚&lt;/p>
&lt;p>ä¸‹é¢ä»¥ Ubuntu å‘è¡Œç‰ˆä»¥åŠ &lt;code>unionfs-fuse&lt;/code> å®ç°ä¸ºä¾‹æ¼”ç¤ºè”åˆæŒ‚è½½çš„æ•ˆæœï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é¦–å…ˆä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£… &lt;code>unionfs-fuse&lt;/code>ï¼Œè¿™æ˜¯ UnionFS çš„ä¸€ä¸ªå®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ apt install unionfs-fuse
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç„¶ååˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">A
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ x
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ x
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åˆ›å»ºç›®å½• C å¹¶å°† Aã€B ç›®å½•è”åˆæŒ‚è½½åˆ° C ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ unionfs ./B:./A ./C
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æŒ‚è½½å C ç›®å½•å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ x
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¦‚æœæˆ‘ä»¬åˆ†åˆ«ç¼–è¾‘ Aã€B ç›®å½•ä¸­çš„ x æ–‡ä»¶ï¼Œä¼šå‘ç°è®¿é—®ç›®å½• C ä¸­ x æ–‡ä»¶å¾—åˆ°çš„æ˜¯ B/x çš„å†…å®¹ï¼ˆå› ä¸º B åœ¨æŒ‚è½½æ—¶ä½äºæ›´ä¸Šå±‚ï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="docker-ä¸­çš„-overlayfs-æ˜¯å¦‚ä½•å·¥ä½œçš„">Docker ä¸­çš„ OverlayFS æ˜¯å¦‚ä½•å·¥ä½œçš„&lt;/h3>
&lt;p>Docker ç›®å‰åœ¨å¤§éƒ¨åˆ†å‘è¡Œç‰ˆæœ¬ä¸­ä½¿ç”¨çš„è”åˆæ–‡ä»¶ç³»ç»Ÿå®ç°æ˜¯ &lt;code>overlay2&lt;/code> ï¼Œç›¸æ¯”å…¶ä»–å®ç°å®ƒæ›´åŠ çš„è½»é‡å’Œé«˜æ•ˆï¼Œä¸‹é¢ä»¥å®ä¾‹æ¥ç®€å•äº†è§£å…¶å·¥ä½œæ–¹å¼ã€‚&lt;/p>
&lt;p>æ¥ç€ä¸Šé¢ &lt;code>nginx&lt;/code> é•œåƒçš„ä¾‹å­ï¼Œæ‹‰å–é•œåƒåç›¸åº”çš„ &lt;code>layer&lt;/code> è§£å‹åœ¨ &lt;code>/var/lib/docker/overlay2&lt;/code> ç›®å½•ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ll /var/lib/docker/overlay2 &lt;span class="p">|&lt;/span> tee layers.a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:20 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">3&lt;/span> root root &lt;span class="m">47&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:04 560df35d349e6a750f1139db22d4cb52cba2a1f106616dc1c0c68b3cf11e3df6
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:20 769a9f5d698522d6e55bd9882520647bd84375a751a67a8ccad1f7bb1ca066dd
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:20 97aaf293fef495f0f06922d422a6187a952ec6ab29c0aa94cd87024c40e1a7e8
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:20 a91fb6955249dadfb34a3f5f06d083c192f2774fbec5fbb1db42a04e918432c0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">brw------- &lt;span class="m">1&lt;/span> root root 253, &lt;span class="m">1&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:00 backingFsBlockDev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:20 fa29ec8cfe5a6c0b2cd1486f27a20a02867126edf654faad7f3520a220f3705f
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx-----x &lt;span class="m">2&lt;/span> root root &lt;span class="m">278&lt;/span> 7æœˆ &lt;span class="m">20&lt;/span> 17:25 l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬å°†è¾“å‡ºç»“æœä¿å­˜åˆ° &lt;code>layers.a&lt;/code> æ–‡ä»¶ä¸­ä¾›ä¹‹åå¯¹æ¯”ã€‚å…¶ä¸­ 6 ä¸ªåç§°ç‰¹åˆ«é•¿çš„ç›®å½•ä¸­å­˜æ”¾äº†é•œåƒçš„ 6 ä¸ª &lt;code>layer&lt;/code> ï¼ˆç›®å½•åç§°å’Œ &lt;code>manifest.json&lt;/code> ä¸­çš„åç§°å¹¶ä¸å¯¹åº”ï¼‰ï¼Œ &lt;code>l&lt;/code> ç›®å½•ä¸­åŒ…å«äº†æŒ‡å‘ &lt;code>layers&lt;/code> æ–‡ä»¶å¤¹çš„è½¯é“¾æ¥ï¼Œä¸»è¦ç›®çš„æ˜¯åœ¨æ‰§è¡Œ &lt;code>mount&lt;/code> å‘½ä»¤æ—¶ç¼©çŸ­ç›®å½•æ ‡è¯†ç¬¦çš„é•¿åº¦ä»¥é¿å…è¶…å‡ºé¡µå¤§å°é™åˆ¶ã€‚&lt;/p>
&lt;p>æ¯ä¸ª &lt;code>layer&lt;/code> æ–‡ä»¶å¤¹åŒ…å«çš„å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ &lt;span class="nb">cd&lt;/span> /var/lib/docker/overlay2/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ ll 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw------- &lt;span class="m">1&lt;/span> root root &lt;span class="m">0&lt;/span> 7æœˆ &lt;span class="m">15&lt;/span> 17:00 committed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">3&lt;/span> root root &lt;span class="m">33&lt;/span> 7æœˆ &lt;span class="m">15&lt;/span> 17:00 diff
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">26&lt;/span> 7æœˆ &lt;span class="m">15&lt;/span> 17:00 link
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rw-r--r-- &lt;span class="m">1&lt;/span> root root &lt;span class="m">86&lt;/span> 7æœˆ &lt;span class="m">15&lt;/span> 17:00 lower
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 7æœˆ &lt;span class="m">15&lt;/span> 17:00 work
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>link&lt;/code> è®°å½•äº† &lt;code>l&lt;/code> ç›®å½•ä¸­çš„çŸ­é“¾æ¥ï¼Œ &lt;code>lower&lt;/code> ä¸­è®°å½•è¯¥ &lt;code>layer&lt;/code> çš„æ›´ä½ä¸€å±‚ï¼ˆå¦‚æœæ²¡æœ‰è¯¥æ–‡ä»¶è¯´æ˜å½“å‰ &lt;code>layer&lt;/code> å·²ç»æ˜¯æœ€åº•ä¸‹ä¸€å±‚å³åŸºç¡€å±‚ï¼‰ï¼Œ &lt;code>work&lt;/code> ç›®å½•è¢« &lt;code>overlay2&lt;/code> å†…éƒ¨æ‰€ä½¿ç”¨ï¼Œ &lt;code>diff&lt;/code> ç›®å½•ä¸­å­˜æ”¾äº†è¯¥ &lt;code>layer&lt;/code> æ‰€åŒ…å«çš„æ–‡ä»¶ç³»ç»Ÿå†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ll 335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc/diff/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 docker-entrypoint.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">20&lt;/span> root root &lt;span class="m">4096&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 etc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> root root &lt;span class="m">56&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxrwxrwt &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">7&lt;/span> root root &lt;span class="m">66&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 usr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">5&lt;/span> root root &lt;span class="m">41&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬å°è¯•åŸºäºè¯¥é•œåƒè¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œçœ‹çœ‹åœ¨å®¹å™¨é˜¶æ®µçš„è”åˆæŒ‚è½½æ•ˆæœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ docker run -d --name nginx_container nginx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œ &lt;code>mount&lt;/code> å‘½ä»¤å¯ç¡®è®¤æ–°å¢äº†ä¸€ä¸ªå¯è¯»å†™çš„ &lt;code>overlay&lt;/code> æŒ‚è½½ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mount &lt;span class="p">|&lt;/span> grep overlay
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">overlay on /var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged &lt;span class="nb">type&lt;/span> overlay &lt;span class="o">(&lt;/span>rw,relatime,lowerdir&lt;span class="o">=&lt;/span>/var/lib/docker/overlay2/l/6Y7DPCTGLB6JHUPVBGTOEK2QFN:/var/lib/docker/overlay2/l/QMEEOSTJM2QON4M7PJJBB4KDEF:/var/lib/docker/overlay2/l/XNN2MRN4KWITFTZYLFUSLBP322:/var/lib/docker/overlay2/l/6DC6VDOMBZMLBZBT3QSOWLCR37:/var/lib/docker/overlay2/l/NXYWG253WSMELQKF2E2NH2GWCG:/var/lib/docker/overlay2/l/M4SO5XMO4VXRIJIGUHDMTATWH3:/var/lib/docker/overlay2/l/QI3P6ONJSLQI26DVPFGWIZI2EW,upperdir&lt;span class="o">=&lt;/span>/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/diff,workdir&lt;span class="o">=&lt;/span>/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/work&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æŒ‚è½½ç‚¹ä¸­å³åŒ…å«äº†æ‰€æœ‰é•œåƒå±‚ &lt;code>layer&lt;/code> ç»„åˆè€Œæˆçš„ä¸€ä¸ª rootfsï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ll /var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 boot
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">43&lt;/span> 7æœˆ &lt;span class="m">16&lt;/span> 16:52 dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">41&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 docker-entrypoint.d
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-rwxrwxr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">1202&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 docker-entrypoint.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">19&lt;/span> 7æœˆ &lt;span class="m">16&lt;/span> 16:52 etc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 home
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">56&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">34&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 lib64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 media
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 mnt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 opt
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 proc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwx------ &lt;span class="m">2&lt;/span> root root &lt;span class="m">37&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 root
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">23&lt;/span> 7æœˆ &lt;span class="m">16&lt;/span> 16:52 run
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">4096&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 sbin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 srv
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">2&lt;/span> root root &lt;span class="m">6&lt;/span> 6æœˆ &lt;span class="m">13&lt;/span> 18:30 sys
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxrwxrwt &lt;span class="m">1&lt;/span> root root &lt;span class="m">6&lt;/span> 7æœˆ &lt;span class="m">7&lt;/span> 03:39 tmp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">66&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 usr
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">drwxr-xr-x &lt;span class="m">1&lt;/span> root root &lt;span class="m">19&lt;/span> 6æœˆ &lt;span class="m">21&lt;/span> 08:00 var
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é™¤äº†å°†åŸæ¥çš„é•œåƒå±‚è”åˆæŒ‚è½½åˆ°å¦‚ä¸Šæ‰€ç¤ºçš„ &lt;code>merged&lt;/code> ç›®å½•ï¼Œé€šè¿‡ &lt;code>diff&lt;/code> å‘½ä»¤å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨è¿è¡ŒæˆåŠŸå &lt;code>/var/lib/docker/overlay2&lt;/code> è¿˜ä¼šæ–°å¢ä¸¤ä¸ª &lt;code>layer&lt;/code> ç›®å½•ï¼Œ&lt;code>merged&lt;/code> ä¹Ÿä½äºå…¶ä¸­ä¸€ä¸ªç›®å½•ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ ll /var/lib/docker/overlay2 &lt;span class="p">|&lt;/span> tee layers.b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ diff layers.a layers.b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; drwx-----x &lt;span class="m">5&lt;/span> root root &lt;span class="m">69&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:08 bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; drwx-----x &lt;span class="m">4&lt;/span> root root &lt;span class="m">72&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:08 bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011-init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt; drwx-----x &lt;span class="m">2&lt;/span> root root &lt;span class="m">210&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:08 l
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; drwx-----x &lt;span class="m">2&lt;/span> root root &lt;span class="m">278&lt;/span> 7æœˆ &lt;span class="m">19&lt;/span> 10:08 l
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ &lt;code>inspect&lt;/code> å‘½ä»¤æ¢æŸ¥å·²è¿è¡Œå®¹å™¨çš„ &lt;code>GraphDriver&lt;/code>ï¼Œå¯ä»¥æ›´æ¸…æ™°åœ°çœ‹åˆ°ä¸é•œåƒç›¸æ¯”å®¹å™¨çš„ &lt;code>layers&lt;/code> æ‰€å‘ç”Ÿçš„å˜åŒ– :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ docker inspect nginx_container
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;GraphDriver&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Data&amp;#34;&lt;/span>: &lt;span class="o">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;LowerDir&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011-init/diff:/var/lib/docker/overlay2/97aaf293fef495f0f06922d422a6187a952ec6ab29c0aa94cd87024c40e1a7e8/diff:/var/lib/docker/overlay2/fa29ec8cfe5a6c0b2cd1486f27a20a02867126edf654faad7f3520a220f3705f/diff:/var/lib/docker/overlay2/769a9f5d698522d6e55bd9882520647bd84375a751a67a8ccad1f7bb1ca066dd/diff:/var/lib/docker/overlay2/a91fb6955249dadfb34a3f5f06d083c192f2774fbec5fbb1db42a04e918432c0/diff:/var/lib/docker/overlay2/335aaf02cbde069ddf7aa0077fecac172d4b2f0240975ab0ebecc3f94f1420cc/diff:/var/lib/docker/overlay2/560df35d349e6a750f1139db22d4cb52cba2a1f106616dc1c0c68b3cf11e3df6/diff&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;MergedDir&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/merged&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;UpperDir&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/diff&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;WorkDir&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;/var/lib/docker/overlay2/bab121ecb1d54b787b7b1834810baf212b035e28ca8d7875a09b1af837116011/work&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">}&lt;/span>,
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Name&amp;#34;&lt;/span>: &lt;span class="s2">&amp;#34;overlay2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>LowerDir&lt;/code> ä¸­è®°å½•äº†åŸæœ‰çš„é•œåƒå±‚æ–‡ä»¶ç³»ç»Ÿï¼Œå¦å¤–åœ¨æœ€ä¸Šå±‚è¿˜æ–°å¢äº†ä¸€ä¸ª &lt;code>init&lt;/code> å±‚ï¼Œå®ƒä»¬åœ¨å®¹å™¨è¿è¡Œé˜¶æ®µéƒ½æ˜¯åªè¯»çš„ï¼›&lt;code>MergedDir&lt;/code> ä¸­è®°å½•äº†å°† &lt;code>LowerDir&lt;/code> çš„æ‰€æœ‰ç›®å½•è¿›è¡Œè”åˆæŒ‚è½½çš„æŒ‚è½½ç‚¹ï¼›&lt;code>UpperDir&lt;/code> ä¹Ÿæ˜¯æ–°å¢çš„ä¸€ä¸ª &lt;code>layer&lt;/code> ï¼Œæ­¤æ—¶ä½äºä»¥ä¸Šæ‰€æœ‰ &lt;code>layers&lt;/code> çš„æœ€ä¸Šå±‚ï¼Œä¸å…¶ä»–é•œåƒå±‚ç›¸æ¯”å®ƒæ˜¯å¯è¯»å†™çš„ã€‚å®¹å™¨é˜¶æ®µçš„ &lt;code>layers&lt;/code> ç¤ºæ„å›¾å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-07-20-image-layers.png" alt="">&lt;/p>
&lt;p>åˆ›å»ºå®¹å™¨æ—¶æ‰€æ–°å¢çš„å¯å†™ &lt;code>layer&lt;/code> æˆ‘ä»¬ç§°ä¸º &lt;code>container layer&lt;/code>ï¼Œå®¹å™¨è¿è¡Œé˜¶æ®µå¯¹æ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´éƒ½åªä¼šå†™å…¥åˆ°è¯¥ &lt;code>layer&lt;/code> ä¸­ï¼ŒåŒ…æ‹¬å¯¹æ–‡ä»¶çš„æ–°å¢ã€ä¿®æ”¹å’Œåˆ é™¤ï¼Œè€Œä¸ä¼šæ”¹å˜æ›´ä½å±‚çš„åŸæœ‰é•œåƒå†…å®¹ï¼Œè¿™æå¤§æå‡äº†é•œåƒçš„åˆ†å‘æ•ˆç‡ã€‚åœ¨é•œåƒå±‚å’Œ &lt;code>container layer&lt;/code> ä¹‹é—´çš„ &lt;code>init&lt;/code> å±‚è®°å½•äº†å®¹å™¨åœ¨å¯åŠ¨æ—¶å†™å…¥çš„ä¸€äº›é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸€è¿‡ç¨‹å‘ç”Ÿåœ¨æ–°å¢è¯»å†™å±‚ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æŠŠè¿™äº›æ•°æ®å†™å…¥åˆ°åŸå§‹é•œåƒä¸­ã€‚&lt;/p>
&lt;p>è¿™ä¸¤ä¸ªæ–°å¢çš„å±‚ä»…åœ¨å®¹å™¨è¿è¡Œé˜¶æ®µå­˜åœ¨ï¼Œå®¹å™¨åˆ é™¤åå®ƒä»¬ä¹Ÿä¼šè¢«åˆ é™¤ã€‚åŒä¸€ä¸ªé•œåƒå¯ä»¥åˆ›å»ºå¤šä¸ªä¸åŒçš„å®¹å™¨ï¼Œä»…éœ€è¦åˆ›å»ºå¤šä¸ªä¸åŒçš„å¯å†™å±‚ï¼›è¿è¡Œæ—¶æ›´æ”¹è¿‡çš„å®¹å™¨ä¹Ÿå¯ä»¥é‡æ–°æ‰“åŒ…ä¸ºä¸€ä¸ªæ–°çš„é•œåƒï¼Œå°†å¯å†™å±‚æ·»åŠ åˆ°æ–°é•œåƒçš„åªè¯»å±‚ä¸­å³å¯ã€‚&lt;/p>
&lt;h4 id="ä¸ºä»€ä¹ˆå®¹å™¨çš„è¯»å†™æ•ˆç‡ä¸å¦‚åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿ">ä¸ºä»€ä¹ˆå®¹å™¨çš„è¯»å†™æ•ˆç‡ä¸å¦‚åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿ&lt;/h4>
&lt;p>ä¸ºäº†æœ€å°åŒ– I/O ä»¥åŠç¼©å‡é•œåƒä½“ç§¯ï¼Œå®¹å™¨çš„è”åˆæ–‡ä»¶ç³»ç»Ÿåœ¨è¯»å†™æ–‡ä»¶æ—¶ä¼šé‡‡å–å†™æ—¶å¤åˆ¶ç­–ç•¥ï¼ˆcopy-on-writeï¼‰ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•å­˜åœ¨äºé•œåƒä¸­çš„è¾ƒä½å±‚ï¼Œè€Œå¦ä¸€ä¸ªå±‚ï¼ˆåŒ…æ‹¬å¯å†™å±‚ï¼‰éœ€è¦å¯¹å…¶è¿›è¡Œè¯»å–è®¿é—®æ—¶ï¼Œä¼šç›´æ¥è®¿é—®è¾ƒä½å±‚çš„æ–‡ä»¶ã€‚å½“å¦ä¸€ä¸ªå±‚ç¬¬ä¸€æ¬¡éœ€è¦å†™å…¥è¯¥æ–‡ä»¶æ—¶ï¼ˆåœ¨æ„å»ºé•œåƒæˆ–è¿è¡Œå®¹å™¨æ—¶ï¼‰ï¼Œè¯¥æ–‡ä»¶ä¼šè¢«å¤åˆ¶åˆ°è¯¥å±‚å¹¶è¢«ä¿®æ”¹ã€‚è¿™ä¸€ä¸¾æªå¤§å¤§å‡å°‘äº†å®¹å™¨çš„å¯åŠ¨æ—¶é—´ï¼ˆå¯åŠ¨æ—¶æ–°å»ºçš„å¯å†™å±‚åªæœ‰å¾ˆå°‘çš„æ–‡ä»¶å†™å…¥ï¼‰ï¼Œä½†å®¹å™¨è¿è¡Œåæ¯æ¬¡ç¬¬ä¸€æ¬¡ä¿®æ”¹æŸä¸ªæ–‡ä»¶éƒ½éœ€è¦å…ˆå°†æ•´ä¸ªæ–‡ä»¶å¤åˆ¶åˆ° &lt;code>container layer&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>ä»¥ä¸ŠåŸå› å¯¼è‡´å®¹å™¨è¿è¡Œæ—¶çš„è¯»å†™æ•ˆç‡ä¸å¦‚åŸç”Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯å†™å…¥æ•ˆç‡ï¼‰ï¼Œåœ¨ &lt;code>container layer&lt;/code> ä¸­ä¸é€‚åˆè¿›è¡Œå¤§é‡çš„æ–‡ä»¶è¯»å†™ï¼Œé€šå¸¸å»ºè®®å°†é¢‘ç¹å†™å…¥çš„æ•°æ®åº“ã€æ—¥å¿—æ–‡ä»¶æˆ–ç›®å½•ç­‰å•ç‹¬æŒ‚è½½å‡ºå»ï¼Œå¦‚ä½¿ç”¨ Docker æä¾›çš„ &lt;code>Volume&lt;/code>ï¼Œæ­¤æ—¶ç›®å½•å°†é€šè¿‡ç»‘å®šæŒ‚è½½ï¼ˆBind Mountï¼‰ç›´æ¥æŒ‚è½½åœ¨å¯è¯»å†™å±‚ä¸­ï¼Œç»•è¿‡äº†å†™æ—¶å¤åˆ¶å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚&lt;/p>
&lt;h2 id="è¿è¡Œæ—¶è§„èŒƒ">è¿è¡Œæ—¶è§„èŒƒ&lt;/h2>
&lt;p>è¿è¡Œæ—¶è§„èŒƒæè¿°äº†å®¹å™¨çš„é…ç½®ã€æ‰§è¡Œç¯å¢ƒå’Œç”Ÿå‘½å‘¨æœŸã€‚å®ƒè¯¦ç»†æè¿°äº†ä¸åŒå®¹å™¨è¿è¡Œæ—¶æ¶æ„çš„é…ç½®æ–‡ä»¶ &lt;code>config.json&lt;/code> çš„å­—æ®µæ ¼å¼ï¼Œå¦‚ä½•åœ¨æ‰§è¡Œç¯å¢ƒä¸­åº”ç”¨ã€æ³¨å…¥è¿™äº›é…ç½®ï¼Œä»¥ç¡®ä¿å®¹å™¨å†…è¿è¡Œçš„ç¨‹åºåœ¨ä¸åŒè¿è¡Œæ—¶ä¹‹é—´ç¯å¢ƒä¸€è‡´ï¼Œå¹¶é€šè¿‡å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå®šä¹‰äº†ä¸€å¥—ç»Ÿä¸€çš„æ“ä½œè¡Œä¸ºã€‚&lt;/p>
&lt;h3 id="å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ">å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ&lt;/h3>
&lt;p>è§„èŒƒæ‰€å®šä¹‰çš„&lt;a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#lifecycle">å®¹å™¨ç”Ÿå‘½å‘¨æœŸ&lt;/a>ï¼Œæè¿°äº†å®¹å™¨ä»åˆ›å»ºåˆ°é€€å‡ºæ‰€å‘ç”Ÿçš„äº‹ä»¶æ„æˆçš„æ—¶é—´çº¿ï¼Œè¯¥æ—¶é—´çº¿ä¸­å®šä¹‰äº† 13 ä¸ªä¸åŒçš„äº‹ä»¶ï¼Œä¸‹å›¾æè¿°äº†æ—¶é—´çº¿ä¸­å®¹å™¨çŠ¶æ€çš„å˜åŒ–ï¼š&lt;/p>
&lt;p>&lt;img src="2021-07-20-runtime-lifecycle.png" alt="">&lt;/p>
&lt;p>è§„èŒƒä¸­åªå®šä¹‰äº†4ç§&lt;a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#state">å®¹å™¨çŠ¶æ€&lt;/a>ï¼Œè¿è¡Œæ—¶å®ç°å¯ä»¥åœ¨è§„èŒƒçš„åŸºç¡€ä¸Šæ·»åŠ å…¶ä»–çŠ¶æ€ï¼ŒåŒæ—¶æ ‡å‡†è¿˜è§„å®šäº†è¿è¡Œæ—¶å¿…é¡»æ”¯æŒçš„&lt;a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md#operations">æ“ä½œ&lt;/a>ï¼š&lt;/p>
&lt;ul>
&lt;li>Query Stateï¼ŒæŸ¥è¯¢å®¹å™¨çš„å½“å‰çŠ¶æ€&lt;/li>
&lt;li>Createï¼Œæ ¹æ®é•œåƒåŠé…ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨ï¼Œä½†æ˜¯ä¸è¿è¡Œç”¨æˆ·æŒ‡å®šç¨‹åº&lt;/li>
&lt;li>Startï¼Œåœ¨ä¸€ä¸ªå·²åˆ›å»ºçš„å®¹å™¨ä¸­è¿è¡Œç”¨æˆ·æŒ‡å®šç¨‹åº&lt;/li>
&lt;li>Killï¼Œå‘é€ç‰¹å®šä¿¡å·ç»ˆæ­¢å®¹å™¨è¿›ç¨‹&lt;/li>
&lt;li>Deleteï¼Œåˆ é™¤å·²åœæ­¢å®¹å™¨æ‰€åˆ›å»ºçš„èµ„æº&lt;/li>
&lt;/ul>
&lt;p>æ¯ä¸ªæ“ä½œä¹‹å‰æˆ–ä¹‹åè¿˜ä¼šè§¦å‘ä¸åŒçš„ hooksï¼Œç¬¦åˆè§„èŒƒçš„è¿è¡Œæ—¶å¿…é¡»æ‰§è¡Œè¿™äº› hooksã€‚&lt;/p>
&lt;h3 id="å®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹">å®¹å™¨çš„æœ¬è´¨æ˜¯è¿›ç¨‹&lt;/h3>
&lt;p>è¿è¡Œæ—¶è§„èŒƒä¸­ä½¿ç”¨äº† &lt;code>container process&lt;/code> è¿™ä¸€æ¦‚å¿µï¼Œ&lt;code>container process&lt;/code> ç­‰åŒäºä¸Šæ–‡æåˆ°çš„ç”¨æˆ·æŒ‡å®šç¨‹åºå’Œå®¹å™¨è¿›ç¨‹ï¼Œæœ‰äº›åœºæ™¯ä¹Ÿä¼šç§°è¯¥è¿›ç¨‹ä¸ºå®¹å™¨çš„ &lt;code>init&lt;/code> è¿›ç¨‹ã€‚è¿è¡Œä¸€ä¸ªå®¹å™¨å¿…é¡»åœ¨ &lt;code>config.json&lt;/code> ä¸­å®šä¹‰å®¹å™¨çš„ &lt;code>container process&lt;/code>ï¼Œå¯å®šä¹‰çš„å­—æ®µåŒ…æ‹¬å‘½ä»¤å‚æ•°ã€ç¯å¢ƒå‚æ•°å’Œæ‰§è¡Œè·¯å¾„ç­‰ç­‰ã€‚&lt;/p>
&lt;p>å®¹å™¨çŠ¶æ€çš„å˜åŒ–ï¼Œå®é™…ä¸Šåæ˜ çš„æ˜¯ &lt;code>container process&lt;/code> çš„å˜åŒ–ã€‚æˆ‘ä»¬å¯ä»¥å°†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå’ŒçŠ¶æ€å˜åŒ–åˆ’åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;code>container process&lt;/code> æ‰§è¡Œä¹‹å‰ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¿è¡Œæ—¶æ‰§è¡Œ &lt;code>create&lt;/code> å‘½ä»¤ï¼Œæ ¹æ® &lt;code>config.json&lt;/code> åˆ›å»ºæŒ‡å®šçš„èµ„æºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>èµ„æºåˆ›å»ºæˆåŠŸåï¼Œå®¹å™¨è¿›å…¥ &lt;code>created&lt;/code> çŠ¶æ€ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>æ‰§è¡Œ &lt;code>container process&lt;/code>ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¿è¡Œæ—¶æ‰§è¡Œ &lt;code>start&lt;/code> å‘½ä»¤ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¿è¡Œæ—¶è¿è¡Œç”¨æˆ·æŒ‡å®šç¨‹åºï¼Œå³ &lt;code>container process&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®¹å™¨è¿›å…¥ &lt;code>running&lt;/code> çŠ¶æ€ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;code>container process&lt;/code> è¿›ç¨‹ç»“æŸï¼Œç»“æŸçš„åŸå› å¯èƒ½æ˜¯è¯¥ç¨‹åºæ‰§è¡Œç»“æŸã€å‡ºé”™æˆ–å´©æºƒï¼Œä»¥åŠè¿è¡Œæ—¶é€šè¿‡ &lt;code>kill&lt;/code> å‘½ä»¤å‘å…¶å‘å‡ºç»ˆæ­¢ä¿¡å·ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å®¹å™¨è¿›å…¥ &lt;code>stoppped&lt;/code> çŠ¶æ€ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¿è¡Œæ—¶æ‰§è¡Œ &lt;code>delete&lt;/code> å‘½ä»¤ï¼Œæ‰€æœ‰é€šè¿‡ &lt;code>create&lt;/code> å‘½ä»¤åˆ›å»ºçš„èµ„æºè¢«æ¸…é™¤ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>å®¹å™¨è¿è¡Œæ—¶çš„æ ¸å¿ƒå°±æ˜¯ &lt;code>container process&lt;/code>ï¼šé•œåƒæ–‡ä»¶ç³»ç»Ÿæ»¡è¶³è¿è¡Œè¿›ç¨‹æ‰€éœ€çš„ä¾èµ–ï¼Œè¿è¡Œæ—¶æ‰€ä½œçš„å‡†å¤‡å·¥ä½œæ˜¯ä¸ºäº†æ­£ç¡®çš„è¿è¡Œè¯¥è¿›ç¨‹ï¼Œè¿è¡Œæ—¶æŒç»­çš„ç›‘æµ‹è¯¥è¿›ç¨‹çš„çŠ¶æ€ï¼Œä¸€æ—¦è¯¥è¿›ç¨‹ç»“æŸå³å®£å‘Šå®¹å™¨ï¼ˆæš‚æ—¶ï¼‰æ­»äº¡ï¼Œè¿è¡Œæ—¶è¿›è¡Œæ”¶å°¾çš„æ¸…ç†å·¥ä½œã€‚&lt;/p>
&lt;p>å½“ç„¶å®¹å™¨ä¸­ä¹Ÿå¯ä»¥è¿è¡Œå…¶ä»–è¿›ç¨‹ï¼Œä½†è¿™äº›è¿›ç¨‹åªæ˜¯å…±ç”¨ &lt;code>container process&lt;/code> çš„ç¯å¢ƒã€‚&lt;/p>
&lt;h2 id="å®ç°å’Œç”Ÿæ€">å®ç°å’Œç”Ÿæ€&lt;/h2>
&lt;p>Docker å‘ OCI è§„èŒƒæçŒ®äº†å…¶å®¹å™¨è¿è¡Œæ—¶ &lt;code>runC&lt;/code> é¡¹ç›®ï¼Œä½œä¸ºè¯¥è§„èŒƒçš„æ ‡å‡†å®ç°ã€‚ç›®å‰å·²æœ‰çš„å¤§éƒ¨åˆ†å®¹å™¨é¡¹ç›®éƒ½ç›´æ¥å°† &lt;code>runC&lt;/code> ä½œä¸ºè¿è¡Œæ—¶å®ç°ã€‚&lt;/p>
&lt;p>ä¸‹å›¾å¯ä»¥æ¦‚æ‹¬å®¹å™¨ç”Ÿæ€å†… Docker ç›¸å…³çš„ç»„ç»‡åŠé¡¹ç›®ä¹‹é—´çš„å…³ç³»ï¼š&lt;/p>
&lt;p>&lt;img src="2021-07-20-runc.png" alt="">&lt;/p>
&lt;p>Kubernetes å®šä¹‰äº† CRIï¼ˆContainer Runtime Interfaceï¼‰ä»¥å®ç°å¯æ›¿æ¢çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œç›®å‰æœ‰ &lt;code>cri-containerd&lt;/code> ã€&lt;code>cri-o&lt;/code> å’Œ &lt;code>docker&lt;/code> ç­‰å‡ ç§å®ç°ï¼Œä½†å®ƒä»¬å®é™…ä¸Šä¹Ÿéƒ½åŸºäº &lt;code>runC&lt;/code>ï¼š&lt;/p>
&lt;p>&lt;img src="2021-07-20-k8s-cri.png" alt="">&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://pierrchen.blogspot.com/2018/04/oci-open-container-spec-that-rules-all.html">Understand Container: OCI Specification&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/opencontainers/image-spec/blob/main/spec.md">Open Container Initiative Image Format Specification&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://github.com/opencontainers/runtime-spec/blob/master/spec.md">Open Container Initiative Runtime Specification&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://docs.docker.com/storage/storagedriver/">About storage drivers&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">Use the OverlayFS storage driver&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.kawabangga.com/posts/4224">Docker (å®¹å™¨) çš„åŸç†&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ·±å…¥å‰–æKubernetes - å¼ ç£Š&lt;/p>
&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/linux/" term="Linux" label="Linux"/><category scheme="https://waynerv.com/tags/%E5%AE%B9%E5%99%A8/" term="å®¹å™¨" label="å®¹å™¨"/><category scheme="https://waynerv.com/tags/kubernetes/" term="Kubernetes" label="Kubernetes"/><category scheme="https://waynerv.com/tags/docker/" term="Docker" label="Docker"/></entry><entry><title type="text">ç©¶æçš„ Python å¼€æºé¡¹ç›®æ¨¡æ¿</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/ultimate-python-open-source-project-template/"/><id>https://waynerv.com/posts/ultimate-python-open-source-project-template/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-06-25T18:08:49+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æˆ‘çš„ Notion é‡Œé¢èººç€å¾ˆå¤šå…³äºå¼€æºé¡¹ç›®çš„ ideaï¼Œæœ‰äº› GitHub ä»“åº“éƒ½å»ºå¥½äº†ï¼Œä½†çœŸæ­£å¼€å§‹çš„å¯¥å¯¥æ— å‡ ã€‚é™¤äº†æ²¡æœ‰æ—¶é—´æˆ–è€…éœ€è¦æŒæ¡æ–°çš„æŠ€æœ¯æ ˆï¼Œè¿˜æœ‰ä¸€ä¸ªâ€¦â€¦</summary><content type="html">&lt;p>æˆ‘çš„ Notion é‡Œé¢èººç€å¾ˆå¤šå…³äºå¼€æºé¡¹ç›®çš„ ideaï¼Œæœ‰äº› GitHub ä»“åº“éƒ½å»ºå¥½äº†ï¼Œä½†çœŸæ­£å¼€å§‹çš„å¯¥å¯¥æ— å‡ ã€‚é™¤äº†æ²¡æœ‰æ—¶é—´æˆ–è€…éœ€è¦æŒæ¡æ–°çš„æŠ€æœ¯æ ˆï¼Œè¿˜æœ‰ä¸€ä¸ªé‡å¤§é˜»ç¢æ˜¯æˆ‘è§‰å¾—å¼€å§‹ä¸€ä¸ªæ–°çš„é¡¹ç›®éå¸¸ç¹çï¼Œå°¤å…¶å¯¹äº Python é¡¹ç›®æ¥è¯´ã€‚&lt;/p>
&lt;p>åˆ¶ä½œä¸€ä¸ªé¡¹ç›®å¯åŠ¨æ¨¡æ¿ï¼Œä¹Ÿæ˜¯å¼€å§‹ä¸€ä¸ªæ–°å¼€æºé¡¹ç›®çš„å¥½ ideaã€‚ä¸¤å¹´å‰æˆ‘æ›¾ç»æ¥è§¦è¿‡ cookiecutter ï¼ˆä¸€ä¸ªé¡¹ç›®ç”Ÿæˆå·¥å…·ï¼‰ï¼›åœ¨å‘å¸ƒäº†å‡ ä¸ªé¡¹ç›®åï¼Œå¯¹äº Python æ‰“åŒ…å‘å¸ƒåˆ° PyPI çš„æµç¨‹ä¹Ÿæ¯”è¾ƒç†Ÿæ‚‰äº†ï¼›ä½•å†µåœ¨ GitHub ä¸Šè¿˜çœ‹è¿‡è®¸å¤šç±»ä¼¼çš„é¡¹ç›®æ¨¡æ¿ï¼Œå¯ä»¥ fork ååœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œè‡ªå®šä¹‰ã€‚ä¸€åˆ‡éƒ½æ°´åˆ°æ¸ æˆï¼Œè¿™åº”è¯¥ä¸æ˜¯ä¸ªå¾ˆéš¾çš„äº‹ã€‚&lt;/p>
&lt;p>ä¸è¿‡æˆ‘è¿˜æ˜¯ç»è¿‡ä¸€æ®µæ—¶é—´çš„æµ‹è¯•å’Œåå¤æ‰“ç£¨ï¼Œæ‰ç»ˆäºå®Œæˆä¸€ä»½ Python å¼€æºé¡¹ç›®æ¨¡æ¿ï¼š&lt;a href="https://github.com/waynerv/cookiecutter-pypackage">Cookiecutter PyPackage&lt;/a>ï¼Œæ ‡é¢˜ä¸­çš„ã€Œç©¶æã€æœ‰å¤¸å¤§ä¹‹å«Œï¼Œä½†å†…å®¹çš„ç¡®æ˜¯ç›¸å½“å…¨é¢ã€‚æ¨¡æ¿çš„ä½¿ç”¨æ–¹æ³•åœ¨é¡¹ç›®æ–‡æ¡£ä¸­æœ‰è¯¦ç»†ä»‹ç»ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†äº«æˆ‘åœ¨æ¨¡æ¿ä¸­æ‰€é€‰æ‹©çš„å·¥å…·ä»¥åŠé€‰æ‹©å®ƒä»¬çš„ç†ç”±ã€‚&lt;/p>
&lt;h2 id="åŒ…ç®¡ç†å·¥å…·">åŒ…ç®¡ç†å·¥å…·&lt;/h2>
&lt;p>Python çš„åŒ…ç®¡ç†å·¥å…·å¤ªå¤šäº†ï¼Œè€Œä¸”å¹¶æ²¡æœ‰æ‰€è°“çš„ä¸»æµï¼Œè¿™æ˜¯ Python è¯­è¨€é«˜åº¦ç¤¾åŒºåŒ–çš„ä¸€ä¸ªå†å²å¼Šç«¯ï¼Œå¾ˆéš¾æƒ³è±¡ä¸€é—¨å‘å±•äº†è¿‘ 30 å¹´çš„è¯­è¨€ï¼Œè¿˜åœ¨ä¸æ–­å‡ºç°æ–°çš„ PEP å’Œå¼€æºå·¥å…·æ¥æ”¹å–„å…¶åŸºç¡€çš„åŒ…ç®¡ç†æµç¨‹ï¼Œç”¨æˆ·éœ€è¦ä¸ºæ­¤ä»˜å‡ºç›¸å½“å¤§çš„å­¦ä¹ æˆæœ¬ã€‚æœ€è¿‘å‡ºç°çš„æ–°è¯­è¨€å¦‚ Go å’Œ Rustï¼ŒåŸºæœ¬éƒ½å†…ç½®äº†ä¸€å¥—å®Œæ•´çš„å·¥å…·é“¾ã€‚&lt;/p>
&lt;p>é‚£å°±ä»ä¸€ä¼—å·¥å…·ä¸­æŒ‘ä¸€ä¸ªç®€å•çœäº‹çš„å§ã€‚æˆ‘ä»¬éœ€è¦å®ƒæ¥åšä¸‹é¢è¿™äº›äº‹æƒ…ï¼š&lt;/p>
&lt;ul>
&lt;li>ç®¡ç†åŒ…çš„ä¾èµ–&lt;/li>
&lt;li>å°†é¡¹ç›®æ‰“åŒ…æˆèƒ½å¤Ÿåˆ†å‘çš„æ ¼å¼&lt;/li>
&lt;li>å°†æ‰“å¥½çš„åŒ…ä¸Šä¼ åˆ° PyPI&lt;/li>
&lt;li>é¡ºä¾¿å†ç®¡ç†è™šæ‹Ÿç¯å¢ƒå•¥çš„&lt;/li>
&lt;/ul>
&lt;p>ç”¨ä¼ ç»Ÿçš„ &lt;code>pip&lt;/code> + &lt;code>requirements.txt&lt;/code> + &lt;code>Setuptools&lt;/code> + &lt;code>twine&lt;/code> + &lt;code>venv&lt;/code> åšå®Œè¿™ä¸€å¥—æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œä½†æ˜¯ç”¨åˆ°çš„å·¥å…·å¤ªå¤šäº†ï¼Œå¦‚æœèƒ½ç”¨ä¸€ä¸ªå·¥å…·æ¥åšè¿™äº›ä¹Ÿè®¸ä¼šæ›´å¥½ã€‚ &lt;code>Poetry&lt;/code> å°±æ˜¯è¿™æ ·çš„ä¸€ä¸ªå·¥å…·ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´çš„ä½“éªŒæˆ‘è§‰å¾—è¿˜ä¸é”™ï¼Œæœ€å–œæ¬¢çš„ç‰¹æ€§æ˜¯å¯ä»¥ä¸€æ¬¡æ€§åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šä¾èµ–ç‰ˆæœ¬ï¼Œä¸ç”¨å†æ‰‹åŠ¨ç¼–è¾‘ &lt;code>requirements.txt&lt;/code> å’Œ &lt;code>setup.py&lt;/code> ä¸­çš„ &lt;code>install_requires&lt;/code> äº†ã€‚&lt;/p>
&lt;p>å¦å¤– &lt;code>Poetry&lt;/code> è¿˜ä½¿ç”¨äº† &lt;code>pyproject.toml&lt;/code> ä½œä¸ºåŒ…çš„å…ƒä¿¡æ¯æ–‡ä»¶ï¼Œç”¨æ¥æ›¿æ¢äº† &lt;code>setup.py&lt;/code> + &lt;code>requirements.txt&lt;/code>ï¼Œå¦‚æœä½ å¯¹ &lt;code>pyproject.toml&lt;/code> è¿™ç§æ ¼å¼ä¸å¤ªç†Ÿæ‚‰ï¼Œæ¨èé˜…è¯»ï¼š&lt;a href="https://snarky.ca/what-the-heck-is-pyproject-toml/">What the heck is pyproject.toml?&lt;/a>&lt;/p>
&lt;h2 id="æ£€æŸ¥å·¥å…·">æ£€æŸ¥å·¥å…·&lt;/h2>
&lt;p>å¯¹ Python å¼€æºé¡¹ç›®æ¥è¯´ flake8ï¼Œpylintï¼Œ isort è¿™ç±» linter/formatter å·¥å…·åº”è¯¥æ˜¯å¿…å¤‡äº†ï¼Œå¦‚æœä½ å‘ç°å“ªä¸ªæµè¡Œçš„é¡¹ç›®ä¸­æ²¡æœ‰ï¼Œè¿™å¯æ˜¯ä¸€ä¸ªè´¡çŒ®å¼€æºçš„å¥½æœºä¼šï¼Œèµ¶ç´§å»æ PR å§ã€‚åœ¨ä¹‹å‰çš„ä¸€ç¯‡åšå®¢&lt;a href="https://www.waynerv.com/posts/build-automatic-code-quality-workflow/">æ„å»ºä¿éšœä»£ç è´¨é‡çš„è‡ªåŠ¨åŒ–å·¥ä½œæµ&lt;/a>ä¸­ï¼Œæˆ‘æ›¾ç»è¯¦ç»†ä»‹ç»è¿‡äº†è¿™äº›å·¥å…·çš„å®‰è£…å’Œä½¿ç”¨æ–¹æ³•ã€‚&lt;/p>
&lt;p>åœ¨æ¨¡æ¿ä¸­ä¸€å…±é…ç½®äº†å¦‚ä¸‹æ£€æŸ¥å·¥å…·ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è§„èŒƒé£æ ¼æ£€æŸ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>flake8&lt;/li>
&lt;li>flake8-docstrings&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ï¼š&lt;/p>
&lt;ul>
&lt;li>black&lt;/li>
&lt;li>isort&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>é™æ€ç±»å‹æ£€æŸ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>mypy&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>ç›¸åº”çš„é…ç½®é¡¹éƒ½ä¿å­˜åœ¨ &lt;code>setup.cfg&lt;/code> å’Œ &lt;code>pyproject.yaml&lt;/code> ï¼Œé¢„è®¾çš„è§„åˆ™ä¸ç®—ç‰¹åˆ«ä¸¥æ ¼ï¼Œå¦‚æœæƒ³æ›´å®½æ¾ä¸€ç‚¹å¯ä»¥æŠŠ &lt;code>mypy&lt;/code> å’Œ &lt;code>flake8-docstrings&lt;/code> å»æ‰ï¼Œå¹¶è‡ªè¡Œä¿®æ”¹æ£€æŸ¥é¡¹ã€‚&lt;/p>
&lt;h2 id="pre-commit">Pre-commit&lt;/h2>
&lt;p>ä¸ºäº†è‡ªåŠ¨åŒ–åœ°å¯¹ä»£ç è¿è¡Œä¸Šé¢ä»‹ç»çš„æ£€æŸ¥å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶é›†æˆåˆ° pre-commit hooks ä¸­ï¼Œè¿™æ ·å®ƒä»¬å°±ä¼šåœ¨æ¯æ¬¡é€šè¿‡ &lt;code>git&lt;/code> æäº¤ä»£ç æ—¶å¯¹æ›´æ”¹è¿‡çš„æ–‡ä»¶è¿è¡Œã€‚ä½¿ç”¨ pre-commit æ—¶éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>hooks ä»…å¯¹æ›´æ”¹è¿‡çš„æ–‡ä»¶è¿è¡Œï¼Œæ¢å¥è¯è¯´åœ¨è¿è¡Œæ—¶å·²ç»é€šè¿‡å‘½ä»¤è¡Œä¼ å…¥äº†ç›®æ ‡æ–‡ä»¶å‚æ•°ï¼Œé€šå¸¸æˆ‘ä»¬è¿˜ä¼šåœ¨å·¥å…·çš„é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ &lt;code>include&lt;/code> ç±»ä¼¼çš„å­—æ®µè®¾ç½®ä½œç”¨èŒƒå›´ï¼Œå› æ­¤è¦ç¡®è®¤ä¸¤è€…æ˜¯å¦èƒ½å¤ŸåŒæ—¶ç”Ÿæ•ˆï¼Œæ¯”å¦‚ &lt;code>isort&lt;/code> å°±éœ€è¦åœ¨ hooks é…ç½®æ–‡ä»¶ &lt;code>.pre-commit-config.yaml&lt;/code> ä¸­æ·»åŠ  &lt;code>args: [ &amp;quot;--filter-files&amp;quot; ]&lt;/code> é€‰é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">- repo: https://github.com/pycqa/isort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rev: 5.7.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hooks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - id: isort
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> args: &lt;span class="o">[&lt;/span> &lt;span class="s2">&amp;#34;--filter-files&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æ¯ä¸€ä¸ª hooks ä¼šåœ¨ç”± pre-commit ç®¡ç†çš„å•ç‹¬è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œï¼Œç”±æ­¤ä¼šå¼•å‘ä¸€ä¸ªå¸¸è§çš„é—®é¢˜ï¼šåœ¨é¡¹ç›®çš„å¼€å‘è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œ mypy å’Œé€šè¿‡ pre-commit è¿è¡Œ mypy å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœï¼Œå…¶åŸå› æ˜¯ pre-commit è¿è¡Œçš„ mypy æ‰€å¤„ç¯å¢ƒæ— æ³•æ£€æµ‹åˆ°å…¶ä»–ç¬¬ä¸‰æ–¹çš„åŒ…ã€‚è¿™æ—¶å¯é€šè¿‡æ·»åŠ  &lt;code>additional_dependencies&lt;/code> å‚æ•°å°è¯•è§£å†³ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">- repo: https://gitlab.woqutech.com/Quality/python-code-check/mirrors-mypy.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> rev: &lt;span class="s2">&amp;#34;v0.812&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> hooks:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - id: mypy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> additional_dependencies:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s1">&amp;#39;pydantic&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - &lt;span class="s1">&amp;#39;click&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•&lt;/h2>
&lt;h3 id="pytest">Pytest&lt;/h3>
&lt;p>å•å…ƒæµ‹è¯•ç”¨ &lt;code>unittest&lt;/code> æˆ–è€… &lt;code>pytest&lt;/code> éƒ½å¯ä»¥ï¼Œé€‰æ‹©åè€…çš„åŸå› æ˜¯ä¹‹å‰ç”¨çš„æ¯”è¾ƒå¤šï¼Œè€Œä¸”å¯ä»¥é€šè¿‡ &lt;code>pytest-cov&lt;/code> å¾ˆæ–¹ä¾¿åœ°é›†æˆè®¡ç®—æµ‹è¯•è¦†ç›–ç‡åŠŸèƒ½ï¼Œåç»­è¿˜å¯ä»¥åœ¨ CI ä¸­é›†æˆ &lt;code>Codecov&lt;/code>ã€‚&lt;/p>
&lt;h3 id="makefile">Makefile&lt;/h3>
&lt;p>æ‰‹åŠ¨è¿è¡Œä¸€ç³»åˆ—æ£€æŸ¥æˆ–è€…æ„å»ºå·¥å…·æ˜¯éå¸¸ç¹ççš„ï¼Œå› æ­¤æˆ‘åŠ å…¥äº†ä¸€ä¸ª &lt;code>Makefile&lt;/code> å¯ä»¥å°†æ‰¹é‡çš„å‘½ä»¤å’Œé€‰é¡¹é€šè¿‡å¿«æ·å‘½ä»¤æ¥æ‰§è¡Œã€‚&lt;/p>
&lt;h3 id="tox">Tox&lt;/h3>
&lt;p>æˆ‘ä»¬çš„é¡¹ç›®é€šå¸¸ä¸æ­¢æ”¯æŒä¸€ä¸ª Python ï¼ˆmajor æˆ– minorï¼‰ç‰ˆæœ¬ï¼Œä¸åŒçš„è¯­è¨€ç‰ˆæœ¬ä¸‹å¯¹ç¨‹åºè¿è¡Œä¸Šè¿°æ£€æŸ¥å¯èƒ½å¾—åˆ°ä¸åŒçš„ç»“æœï¼Œä½†æ‰‹åŠ¨åˆ‡æ¢ç‰ˆæœ¬ä»¥æ£€æŸ¥ç¨‹åºè¡Œä¸ºçš„æˆæœ¬éå¸¸é«˜æ˜‚ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ° &lt;code>tox&lt;/code> äº†ï¼Œå®ƒå¯ä»¥è‡ªåŠ¨ä»¥ä¸åŒçš„ Python ç‰ˆæœ¬åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œåœ¨ä¸åŒç¯å¢ƒä¸­åˆ†åˆ«å®‰è£…å½“å‰é¡¹ç›®ä»¥åŠä¾èµ–ï¼Œæœ€åè¿è¡Œä¸€ç³»åˆ—é¢„å®šä¹‰çš„æµ‹è¯•æµç¨‹ï¼Œå¯¹æµè¡Œçš„ Python å¼€æºé¡¹ç›®æ¥è¯´åŸºæœ¬æ˜¯æ ‡é…ã€‚&lt;/p>
&lt;p>é™¤äº†å•å…ƒæµ‹è¯•ï¼Œ &lt;code>tox&lt;/code> ä¸­è¿˜åŠ å…¥äº†é£æ ¼æ£€æŸ¥ï¼Œæ ¼å¼åŒ–ï¼Œæ–‡æ¡£åŠåŒ…çš„æ„å»ºä»»åŠ¡ã€‚æœ€åé…åˆ &lt;code>tox-gh-actions&lt;/code> è¿™ä¸€æ’ä»¶åœ¨ GitHub Actions ä¸­è¿è¡Œ toxï¼Œå¯ä»¥ç¡®ä¿æ‰€æœ‰çš„æµ‹è¯•ä»»åŠ¡éƒ½å°†åœ¨ CI ä¸­è‡ªåŠ¨è¿è¡Œã€‚&lt;/p>
&lt;h2 id="æ–‡æ¡£ç”Ÿæˆ">æ–‡æ¡£ç”Ÿæˆ&lt;/h2>
&lt;p>å¯¹äº Python é¡¹ç›®æ¥è¯´æ–‡æ¡£ç”Ÿæˆå·¥å…·é€šå¸¸æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼šSphinx æˆ–è€… Mkdocsï¼Œæˆ‘æ›¾ç»å†™è¿‡ä¸€ç¯‡å…³äºä½¿ç”¨ Sphinx çš„åšå®¢ï¼š&lt;a href="https://www.waynerv.com/posts/use-sphinx-auto-generate-api-reference/">ä½¿ç”¨ Sphinx ä¸ºé¡¹ç›®è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£&lt;/a>ã€‚åœ¨æ¨¡æ¿ä¸­æˆ‘é€‰æ‹©åè€…çš„ç†ç”±å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>Mkdocs ä»¥ markdown ä½œä¸ºé»˜è®¤æ ¼å¼ï¼Œè€Œä¸éœ€è¦å†™ä»»ä½• &lt;code>.rst&lt;/code> æ–‡æ¡£ã€‚&lt;/li>
&lt;li>Mkdocs çš„é…ç½®æ›´ä¸ºç®€å•ï¼Œæ‰€æœ‰çš„é…ç½®éƒ½åœ¨ &lt;code>mkdocs.yml&lt;/code> æ–‡ä»¶ä¸­&lt;/li>
&lt;li>&lt;code>mkdocs-material&lt;/code> ä¸»é¢˜éå¸¸èµã€‚&lt;/li>
&lt;li>Mkdocs å¯ä»¥é€šè¿‡ &lt;code>mkdocs serve&lt;/code> å‘½ä»¤å®æ—¶é¢„è§ˆæ–‡æ¡£æ•ˆæœã€‚&lt;/li>
&lt;li>Mkdocs æ‹¥æœ‰ä¼—å¤šæ’ä»¶å’Œæ‰©å±•ï¼Œå¤§éƒ¨åˆ† Sphinx å…·æœ‰çš„ç‰¹æ€§éƒ½æœ‰æ›¿ä»£å®ç°ï¼Œæ¯”å¦‚é€šè¿‡ &lt;code>mkdocstrings&lt;/code> å®ç° &lt;code>autodoc&lt;/code> çš„è‡ªåŠ¨ç”Ÿæˆä»£ç æ–‡æ¡£åŠŸèƒ½ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="ci-è‡ªåŠ¨åŒ–">CI è‡ªåŠ¨åŒ–&lt;/h2>
&lt;p>æˆ‘ä»¬å°†ä½¿ç”¨å…è´¹çš„ GitHub Actions ä½œä¸º CIï¼Œè‡ªåŠ¨æ‰§è¡Œä¸€ç³»åˆ—çš„æµ‹è¯•ã€æ„å»ºå’Œå‘å¸ƒä»»åŠ¡ã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨è¿è¡Œæµ‹è¯•">è‡ªåŠ¨è¿è¡Œæµ‹è¯•&lt;/h3>
&lt;p>é›†æˆäº† &lt;code>tox&lt;/code> çš„å¦ä¸€å¤§å¥½å¤„ï¼Œæ˜¯å¯ä»¥è½»æ¾åœ°é€šè¿‡ &lt;code>tox-gh-actions&lt;/code> ä¸ Actions é›†æˆï¼Œåˆ†åˆ«ä»¥ä¸åŒçš„ Python ç‰ˆæœ¬ä»¥åŠä¸åŒçš„æ¶æ„å¹³å°åˆ›å»ºå¤šä¸ªè¿è¡Œæœºå™¨ï¼Œå¹¶è¡Œåœ°æ‰§è¡Œæµ‹è¯•ä»»åŠ¡ã€‚è¿è¡Œçš„æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-25-github-workflow.png" alt="">&lt;/p>
&lt;p>æ¯ä¸€æ¬¡ &lt;code>push&lt;/code> æˆ–è€… &lt;code>pull_request&lt;/code> éƒ½å°†ä»¥ä¸åŒçš„å¹³å°å’Œ Python ç‰ˆæœ¬è¿è¡Œå®Œæ•´çš„æµ‹è¯•æµç¨‹ã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨å‘å¸ƒåˆ°-pypi">è‡ªåŠ¨å‘å¸ƒåˆ° PyPI&lt;/h3>
&lt;p>å‚è€ƒ PyPa å‘å¸ƒçš„ &lt;a href="https://packaging.python.org/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/">Publishing package distribution releases using GitHub Actions CI/CD workflows&lt;/a>ï¼Œæˆ‘ä»¬å°†é¡¹ç›®é…ç½®ä¸ºï¼šå½“å‘è¿œç¨‹ä»“åº“æ¨é€æ ‡ç­¾æ—¶ï¼Œè‡ªåŠ¨å°†é¡¹ç›®æ‰“åŒ…ååˆ†åˆ«å‘å¸ƒåˆ° TestPyPI å’Œ PyPIã€‚&lt;/p>
&lt;h3 id="è‡ªåŠ¨åˆ›å»º-github-release">è‡ªåŠ¨åˆ›å»º GitHub Release&lt;/h3>
&lt;p>GitHub çš„ Release åŠŸèƒ½å¯ä»¥è®©å…³æ³¨é¡¹ç›®çš„ç”¨æˆ·å¿«æ·åœ°è·å–æœ€æ–°ç‰ˆæœ¬å’Œå†å²è®°å½•ï¼Œä½†æ‰‹åŠ¨å‘å¸ƒæ˜¯ä¸å¯èƒ½åœ°ï¼Œä¸€å®šè¦åšæˆè‡ªåŠ¨çš„ã€‚è¿™å¥—è‡ªåŠ¨åŒ–çš„å·¥ä½œæµå¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>å‚ç…§ &lt;a href="https://keepachangelog.com/en/1.1.0/">keep a changelog&lt;/a> ä¸ºé¡¹ç›®ç»´æŠ¤ä¸€ä¸ªç¬¦åˆå…¶æ ‡å‡†çš„ &lt;code>CHANGELOG.md&lt;/code> ç‰ˆæœ¬å†å²æ–‡ä»¶ã€‚&lt;/li>
&lt;li>å‘è¿œç¨‹ä»“åº“æ¨é€æ ‡ç­¾ä»¥å‘å¸ƒæ–°ç‰ˆæœ¬å¹¶è§¦å‘ä¸‹é¢çš„æµç¨‹ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>changelog-reader-action&lt;/code> è¿™ä¸€ action ä» &lt;code>CHANGELOG.md&lt;/code> æ–‡ä»¶ä¸­æŒ‰è§„åˆ™è§£æå‡ºæœ€æ–°ç‰ˆæœ¬çš„ç‰ˆæœ¬ä¿¡æ¯ã€‚&lt;/li>
&lt;li>æ‰§è¡Œé¡¹ç›®çš„æ„å»ºå¾—åˆ°æœ€æ–°ç‰ˆæœ¬çš„åŒ…ã€‚&lt;/li>
&lt;li>é€šè¿‡ &lt;code>action-gh-release&lt;/code> è¿™ä¸€ action æ ¹æ®ä¸Šé¢è§£æå¾—åˆ°çš„ç‰ˆæœ¬å†å²ä¿¡æ¯è‡ªåŠ¨åˆ›å»ºæ–°çš„ Realeaseï¼Œå¹¶ä»¥æ„å»ºå¥½çš„åŒ…ä½œä¸ºé™„ä»¶ã€‚&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/python/" term="Python" label="Python"/><category scheme="https://waynerv.com/tags/ci/" term="CI" label="CI"/><category scheme="https://waynerv.com/tags/%E5%BC%80%E6%BA%90/" term="å¼€æº" label="å¼€æº"/></entry><entry><title type="text">ä½¿ç”¨ Sphinx ä¸ºé¡¹ç›®è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/use-sphinx-auto-generate-api-reference/"/><id>https://waynerv.com/posts/use-sphinx-auto-generate-api-reference/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-06-07T21:15:32+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">å¯¹äºä¸€ä¸ªä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œé«˜è´¨é‡çš„æ–‡æ¡£ä¸ä»£ç åŒæ ·é‡è¦ï¼Œç³Ÿç³•çš„æ–‡æ¡£ä¼šå°†å¤§éƒ¨åˆ†æ½œåœ¨ç”¨æˆ·æ‹’ä¹‹é—¨å¤–ã€‚ ä»æµè¡Œçš„å¼€æºé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€äº›â€¦â€¦</summary><content type="html">&lt;p>å¯¹äºä¸€ä¸ªä¼˜ç§€çš„å¼€æºé¡¹ç›®ï¼Œé«˜è´¨é‡çš„æ–‡æ¡£ä¸ä»£ç åŒæ ·é‡è¦ï¼Œç³Ÿç³•çš„æ–‡æ¡£ä¼šå°†å¤§éƒ¨åˆ†æ½œåœ¨ç”¨æˆ·æ‹’ä¹‹é—¨å¤–ã€‚&lt;/p>
&lt;p>ä»æµè¡Œçš„å¼€æºé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€äº›å…³äºæ–‡æ¡£çš„æœ€ä½³å®è·µï¼š&lt;/p>
&lt;ul>
&lt;li>æ–‡æ¡£å’Œä»£ç åº“åœ¨ä¸€ä¸ªä»“åº“ä¸­ç»´æŠ¤ä»¥åšåˆ°åŒæ­¥æ›´æ–°ï¼ˆä¸ªåˆ«ä½“é‡è¶…å¤§çš„é¡¹ç›®ä¾‹å¤–ï¼‰&lt;/li>
&lt;li>ä½¿ç”¨çº¯æ–‡æœ¬æ ¼å¼ç¼–å†™æ–‡æ¡£ï¼Œå¦‚ &lt;code>markdown&lt;/code> æˆ– &lt;code>reStructText&lt;/code>ï¼Œç„¶åé€šè¿‡ç”Ÿæˆå·¥å…·å°†å…¶è½¬æ¢æˆæ˜“äºé˜…è¯»ä¸”æ ·å¼ä¸°å¯Œçš„é™æ€ç½‘é¡µï¼Œè¿›ä¸€æ­¥å¯é€šè¿‡ CI å°†é™æ€ç½‘é¡µæ‰˜ç®¡åˆ°å¯å…¬å¼€è®¿é—®çš„ç«™ç‚¹&lt;/li>
&lt;li>åœ¨æ–‡æ¡£ä¸­ç›´æ¥å¼•ç”¨å®é™…çš„ä»£ç ï¼Œå¹¶æä¾› API æ–‡æ¡£&lt;/li>
&lt;/ul>
&lt;p>API æ–‡æ¡£é€šå¸¸ä½äºæ–‡æ¡£ä¸­çš„ &lt;code>API Reference&lt;/code> æˆ– &lt;code>References&lt;/code> ç« èŠ‚ï¼Œå®ƒèƒ½èŠ‚çœç”¨æˆ·æŸ¥é˜…æºç çš„æ—¶é—´ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç†è§£é¡¹ç›®çš„å†…éƒ¨ç»„æˆã€‚å¯¹äºä½œä¸ºåº“ï¼ˆè€Œéåº”ç”¨ï¼‰çš„é¡¹ç›®è€Œè¨€ï¼Œæä¾›ç»„ç»‡è‰¯å¥½çš„ API æ–‡æ¡£å°¤ä¸ºé‡è¦ï¼Œå¦‚ &lt;a href="https://flask.palletsprojects.com/en/2.0.x/#api-reference">Flask&lt;/a>ã€&lt;a href="https://click.palletsprojects.com/en/8.0.x/api/#module-click">Click&lt;/a> ç­‰ï¼Œæœ¬æ–‡å°±å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ &lt;a href="https://www.sphinx-doc.org/en/master/index.html">Sphinx&lt;/a> ä¸ºé¡¹ç›®è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ã€‚&lt;/p>
&lt;p>ç¤ºä¾‹é¡¹ç›®æ‰€ä½¿ç”¨çš„çš„å®Œæ•´æºç å·²æ¨é€åˆ° GitHub çš„ &lt;a href="https://github.com/waynerv/sphinx-apidoc-demo">demo&lt;/a> ä»“åº“ä¸­ã€‚&lt;/p>
&lt;h2 id="ä¸ºä»€ä¹ˆæ˜¯-sphinx">ä¸ºä»€ä¹ˆæ˜¯ Sphinx&lt;/h2>
&lt;p>æœ‰è®¸å¤šå¼€æºå·¥å…·å¯ä»¥ç”¨æ¥å°†çº¯æ–‡æœ¬è½¬æ¢ä¸ºé™æ€ç½‘é¡µï¼Œé€‰æ‹© Sphinx çš„ç†ç”±æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç»å…¸è€ç‰Œï¼Œä½¿ç”¨ç›¸å½“å¹¿æ³›ï¼ŒPython çš„å®˜æ–¹æ–‡æ¡£ä¹Ÿæ˜¯ç”¨å®ƒæ‰€ç”Ÿæˆ&lt;/li>
&lt;li>åŠŸèƒ½å…¨é¢ï¼Œæ”¯æŒå„ç§ä¸»é¢˜å’Œæ’ä»¶ï¼Œå’Œ Python å…·æœ‰è¯­è¨€ä¸Šçš„äº²å’Œæ€§&lt;/li>
&lt;li>èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°æ ¹æ®ä»£ç çš„æ–‡æ¡£å­—ç¬¦ä¸²è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£&lt;/li>
&lt;/ul>
&lt;p>Sphinx çš„é»˜è®¤æ–‡æœ¬æ ¼å¼æ˜¯ &lt;a href="https://docutils.sourceforge.io/rst.html">reStructuredText&lt;/a>ï¼ˆç®€ç§° rstï¼‰ï¼Œå®ƒæ˜¯ä¸€ç§æå…¶å¼ºå¤§çš„æ ‡è®°è¯­è¨€ï¼Œé…åˆ Sphinx å¯ä»¥å®ç°å¾ˆå¤š markdown æ‰€ä¸å…·å¤‡çš„è§£æã€å¼•ç”¨ç‰¹æ€§ï¼Œç¼ºç‚¹æ˜¯è§„åˆ™å’ŒæŒ‡ä»¤è¾ƒä¸ºå¤æ‚ã€‚è¿™åŸæœ¬å¹¶ä¸ç®—ç¼ºç‚¹ï¼Œä½†éšç€ markdown çš„æµè¡Œï¼Œäººä»¬ä¼¼ä¹æ— æ³•å†æ¥å—ä»»ä½•æ¯” markdown æ›´å¤æ‚ä¸€ç‚¹çš„æ ‡è®°è¯­è¨€äº†ã€‚&lt;/p>
&lt;p>ä¸è¿‡è¿™å¹¶ä¸æ˜¯é—®é¢˜ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å€ŸåŠ© &lt;a href="https://myst-parser.readthedocs.io/en/latest/">&lt;code>MyST&lt;/code>&lt;/a> è§£æå™¨å®ç° Sphinx å’Œ markdown çš„å®Œå…¨å…¼å®¹ï¼Œæ¥ä¸‹æ¥çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬å°†æ··åˆä½¿ç”¨ &lt;code>md&lt;/code> å’Œ &lt;code>rst&lt;/code> ä¸¤ç§æ ¼å¼ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åªä½¿ç”¨ä»»æ„ä¸€ç§æ ¼å¼ã€‚&lt;/p>
&lt;h2 id="æ–°å»ºæ–‡æ¡£é¡¹ç›®">æ–°å»ºæ–‡æ¡£é¡¹ç›®&lt;/h2>
&lt;h3 id="å®‰è£…-sphinx">å®‰è£… Sphinx&lt;/h3>
&lt;p>ç¤ºä¾‹å°†æ˜¯ä¸€ä¸ª Python è¯­è¨€é¡¹ç›®ï¼Œå› æ­¤æœ€ç›´æ¥çš„æ–¹å¼å½“ç„¶æ˜¯é€šè¿‡ pip å®‰è£…ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pip install sphinx
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äºå…¶ä»–è¯­è¨€åŠå¹³å°ï¼Œ Sphinx ä¹Ÿæä¾›äº†ä¸°å¯Œçš„å®‰è£…é€”å¾„ï¼Œè¯¦è§ &lt;a href="https://www.sphinx-doc.org/en/master/usage/installation.html#installing-sphinx">Installing Sphinx&lt;/a>ã€‚&lt;/p>
&lt;h3 id="è®¾ç½®æ–‡æ¡£æºç›®å½•">è®¾ç½®æ–‡æ¡£æºç›®å½•&lt;/h3>
&lt;p>æˆ‘ä»¬å°†åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­ç»´æŠ¤ä»£ç å’Œæ–‡æ¡£ï¼Œå› æ­¤é¦–å…ˆéœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª &lt;code>docs&lt;/code> æ–‡ä»¶å¤¹ï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–åç§°ï¼‰ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰å’Œæ–‡æ¡£æœ‰å…³çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¯¥æ–‡ä»¶å¤¹ä½œä¸º Sphinx å·¥ä½œçš„æºç›®å½•ï¼ˆ&lt;a href="https://www.sphinx-doc.org/en/master/glossary.html#term-source-directory">source directory&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;h3 id="åˆå§‹åŒ–é¡¹ç›®">åˆå§‹åŒ–é¡¹ç›®&lt;/h3>
&lt;p>åˆ‡æ¢åˆ° &lt;code>docs&lt;/code> ç›®å½•ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœ¨è¯¥ç›®å½•åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ Sphinx æ–‡æ¡£é¡¹ç›®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">sphinx-quickstart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥æ ¹æ®å‘½ä»¤è¡Œæç¤ºå®Œæˆåˆå§‹åŒ–é¡¹ç›®çš„å„é¡¹é…ç½®ï¼Œå¦‚å¡«å†™é¡¹ç›®åç§°å’Œä½œè€…ï¼Œå¯¹äºä¸ç†è§£çš„é€‰é¡¹å›è½¦ä½¿ç”¨é»˜è®¤é€‰é¡¹å³å¯ã€‚&lt;/p>
&lt;p>åˆå§‹åŒ–åçš„ &lt;code>docs&lt;/code> ç›®å½•å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">docs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ Makefile
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ _build
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ _static
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ _templates
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ conf.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ index.rst
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ make.bat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">3&lt;/span> directories, &lt;span class="m">4&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­æœ€é‡è¦çš„æ˜¯ &lt;code>conf.py&lt;/code> æ–‡ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ª Sphinx å°†ä¼šè¿è¡Œçš„ Python æ¨¡å—ï¼Œä¿å­˜ç€åˆšåˆšé€šè¿‡å‘½ä»¤è¡Œè¾“å…¥çš„é…ç½®ï¼Œè¿˜å¯ä»¥ç¼–è¾‘æ–‡ä»¶æ¥ä¿®æ”¹é…ç½®æˆ–æ·»åŠ æ’ä»¶ï¼Œå¹¶é€šè¿‡è¯¥æ–‡ä»¶è¿è¡Œéœ€è¦çš„ Python ä»£ç ã€‚&lt;/p>
&lt;p>&lt;code>Makefile&lt;/code> å’Œ &lt;code>make.bat&lt;/code> æä¾›äº†ä¸€äº›å¿«æ·å‘½ä»¤ï¼Œåœ¨ &lt;code>docs&lt;/code> ç›®å½•æ‰§è¡Œ &lt;code>make html&lt;/code> å³å¯é€šè¿‡æºæ–‡ä»¶ç”Ÿæˆé™æ€ç½‘é¡µã€‚&lt;/p>
&lt;p>&lt;code>index.rst&lt;/code> æ˜¯æ–‡æ¡£æºæ–‡ä»¶çš„é¦–é¡µï¼Œæ–‡æ¡£é‡Œæœ‰ä¸€äº›é»˜è®¤çš„æ ·æ¿å†…å®¹ï¼Œé€šå¸¸æˆ‘ä»¬å°†å…¶ä½œä¸ºè®¿é—®å…¶ä»–é¡µé¢çš„å…¥å£ç›®å½•ã€‚&lt;/p>
&lt;p>æ­¤æ—¶å·²ç»å¯ä»¥è¿è¡Œ &lt;code>make html&lt;/code> ç”Ÿæˆé™æ€ç½‘é¡µç”¨äºé¢„è§ˆï¼Œç”Ÿæˆçš„ HTML é¡µé¢ä¿å­˜åœ¨ &lt;code>_build/html&lt;/code> ç›®å½•ã€‚ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€åæ•ˆæœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-07-sphinx-index.png" alt="">&lt;/p>
&lt;p>å¦‚æœå¯¹é»˜è®¤çš„æ ·å¼ä¸æ»¡æ„ï¼Œè¿˜å¯ä»¥åœ¨ &lt;a href="https://sphinx-themes.org/">Sphinx Themes Gallery&lt;/a> æ‰¾åˆ°å¤§é‡å¯ä»¥è½»æ¾æ›¿æ¢çš„æ–‡æ¡£ä¸»é¢˜ã€‚&lt;/p>
&lt;h2 id="åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨&lt;/h2>
&lt;h3 id="åˆè¯†-restructuredtext">åˆè¯† reStructuredText&lt;/h3>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬å€ŸåŠ© &lt;code>index.rst&lt;/code> ç®€å•è®¤è¯†ä¸€ä¸‹ reStructuredText æ ¼å¼ã€‚&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æ ‡é¢˜&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Welcome&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">sphinx&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">demo&lt;/span>&lt;span class="s1">&amp;#39;s documentation!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======================================&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æ–‡æœ¬çš„ä¸‹ä¸€è¡Œè¿ç»­è¾“å…¥åŒä¸€æ ‡ç‚¹ç¬¦å·ï¼Œå³å¯å°†æ–‡æœ¬æ ‡è®°ä¸ºæ ‡é¢˜ï¼Œå¦å¤–è¿˜æœ‰å¾ˆè¿åç›´è§‰çš„ä¸¤ç‚¹è¦æ±‚ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¬¦å·çš„é•¿åº¦éœ€è¦è¶…å‡ºæ–‡æœ¬&lt;/li>
&lt;li>æ— æ³•æ˜¾å¼åœ°æŒ‡å®šæ ‡é¢˜çº§åˆ«ï¼Œå¦‚æœè§£æåˆ°å¦ä¸€ç§ç¬¦å·æ ‡è®°çš„æ ‡é¢˜ï¼Œå°†æ ¹æ®å‡ºç°é¡ºåºæŒ‡å®šä¸ºæ–°çš„æ ‡é¢˜çº§åˆ«ï¼Œå¦‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Secondary&lt;/span> &lt;span class="n">Title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">----------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Third&lt;/span> &lt;span class="n">Title&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">~~~~~~~~~~~~&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›¸æ¯” markdown ç›´æ¥ä½¿ç”¨ç¬¦å·çš„ä¸ªæ•°æŒ‡ç¤ºæ ‡é¢˜çº§åˆ«ï¼Œè¿™ç§è§„åˆ™å¹¶ä¸ç®—ç›´è§‚ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç›®å½•æ ‘&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">..&lt;/span> &lt;span class="n">toctree&lt;/span>&lt;span class="p">::&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">maxdepth&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">caption&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Contents&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">install&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">reference&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½¢å¦‚ &lt;code>.. {directive}::&lt;/code> è¿™æ ·çš„æ–‡æœ¬åœ¨ &lt;code>rst&lt;/code> ä¸­è¢«ç§°ä¸ºæŒ‡ä»¤ï¼Œå¯ä»¥å®ç°å„ç§ç‰¹æ®Šæ•ˆæœï¼Œæ¯”å¦‚ &lt;code>.. toctree::&lt;/code> å°†åœ¨å½“å‰ä½ç½®æ’å…¥ä¸€é¢—ç›®å½•æ ‘ã€‚åœ¨æŒ‡ä»¤çš„ä¸‹ä¸€è¡Œå¯ä»¥é€šè¿‡ &lt;code>:{option}: value&lt;/code> æŒ‡å®šé€‰é¡¹ï¼Œå¦‚ä¸Šç¤ºä¾‹ä¸­æŒ‡å®šäº†è¯¥ç›®å½•æ ‘çš„æœ€å¤§æ·±åº¦å’Œæ ‡é¢˜ã€‚&lt;/p>
&lt;p>å†å¾€ä¸‹å°±æ˜¯ç›®å½•æ ‘çš„æ¡ç›®äº†ï¼ŒSphinx å°†æ ¹æ®æ¡ç›®åç§°å¦‚ &lt;code>install&lt;/code> ä½œä¸ºç›¸å¯¹è·¯å¾„åœ¨æºç›®å½•å³ &lt;code>docs&lt;/code> ä¸­å¯»æ‰¾åä¸º &lt;code>install.rst&lt;/code> æˆ– &lt;code>install.md&lt;/code> çš„æ–‡ä»¶ï¼Œå¹¶ç”ŸæˆæŒ‡å‘è¯¥æ–‡ä»¶çš„é“¾æ¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¼•ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Indices&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">tables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">genindex&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">modindex&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™éƒ¨åˆ†å†…å®¹åŒ…å«äº† 3 ç§æ ¼å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>é¦–å…ˆæ˜¯æˆ‘ä»¬ä¸Šé¢ä»‹ç»è¿‡çš„æ ‡é¢˜ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç„¶åæ˜¯å’Œ markdown ç±»ä¼¼åœ°é€šè¿‡ &lt;code>*&lt;/code> æ¸²æŸ“åˆ—è¡¨é¡¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœ€åæ˜¯ &lt;code>:ref:`label_name` &lt;/code>ï¼Œç”Ÿæˆä¸€æ¡æŒ‡å‘ &lt;code>label_name&lt;/code> æ ‡ç­¾çš„äº¤å‰å¼•ç”¨ï¼Œè¿™æ—¶éœ€è¦é€šè¿‡ &lt;code>.. _label_name:&lt;/code> æŒ‡ä»¤æå‰åˆ›å»ºä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æ ‡ç­¾ï¼Œå¦‚ä¸ºä¸€ä¸ªæ ‡é¢˜åˆ›å»ºæ ‡ç­¾ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">..&lt;/span> &lt;span class="n">_label_name&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Section&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">cross&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">reference&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">--------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬ä»…ç®€å•ä»‹ç»å‡ ç§åœ¨ &lt;code>index.rst&lt;/code> ä¸­å‡ºç°è¿‡çš„æ ¼å¼ï¼Œå®é™…ä¸Š reStructuredText èƒ½å®ç°çš„åŠŸèƒ½è¿œä¸é™äºæ­¤ã€‚&lt;/p>
&lt;h3 id="æ·»åŠ -markdown-æ”¯æŒ">æ·»åŠ  markdown æ”¯æŒ&lt;/h3>
&lt;p>ä¸º Sphinx æ·»åŠ  markdown æ”¯æŒéå¸¸ç®€å•ã€‚&lt;/p>
&lt;p>é¦–å…ˆå®‰è£… &lt;code>MyST&lt;/code> æ’ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pip install myst-parser
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ç€ä¿®æ”¹ &lt;code>conf.py&lt;/code> æ–‡ä»¶ï¼Œæ‰¾åˆ° &lt;code>extensions = []&lt;/code> æ‰€åœ¨çš„ä¸€è¡Œï¼Œå‘è¯¥åˆ—è¡¨ä¸­æ·»åŠ  &lt;code>&amp;quot;myst_parser&amp;quot;&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">extensions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;myst_parser&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¹‹åæºç›®å½•ä¸­æ‰€æœ‰çš„ &lt;code>.md&lt;/code> æ–‡ä»¶å°±ä¼šåƒ &lt;code>.rst&lt;/code> ä¸€æ ·è¢« Sphinx æ­£å¸¸è§£æã€‚&lt;/p>
&lt;h3 id="æ·»åŠ æ–°çš„æ–‡æ¡£å†…å®¹">æ·»åŠ æ–°çš„æ–‡æ¡£å†…å®¹&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>å‘é¦–é¡µæ·»åŠ æ–°çš„æ–‡æœ¬æ®µè½&lt;/p>
&lt;p>åœ¨å·²æœ‰çš„æ ‡é¢˜å’ŒæŒ‡ä»¤ä¹‹å¤–ç›´æ¥æ’å…¥æ–‡æœ¬å³å¯ï¼Œå¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Welcome&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">sphinx&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">demo&lt;/span>&lt;span class="s1">&amp;#39;s documentation!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">..&lt;/span> &lt;span class="n">toctree&lt;/span>&lt;span class="p">::&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">maxdepth&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">caption&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Contents&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Indices&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">tables&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">genindex&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">modindex&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">*&lt;/span> &lt;span class="p">:&lt;/span>&lt;span class="n">ref&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">search&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">æ–°å†…å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">======&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">è¿™æ˜¯ä¸€ä¸ªæ–°çš„æ®µè½&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”Ÿæˆ HTML é¡µé¢å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-07-sphinx-new-content.png" alt="">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ·»åŠ æ–°çš„ &lt;code>.rst&lt;/code> æ–‡ä»¶&lt;/p>
&lt;p>åœ¨ &lt;code>docs&lt;/code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ &lt;code>install.rst&lt;/code> ï¼Œåœ¨æ–‡ä»¶ä¸­å†™å…¥æ ‡é¢˜ï¼Œç„¶ååœ¨é¦–é¡µæ–‡ä»¶ä¸­æ·»åŠ ç›¸åº”çš„ç›®å½•æ¡ç›®æˆ–è€…å¼•ç”¨ï¼Œæœ¬ä¾‹ä¸­æˆ‘ä»¬æ·»åŠ åˆ°ç›®å½•æ ‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">..&lt;/span> &lt;span class="n">toctree&lt;/span>&lt;span class="p">::&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">maxdepth&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">:&lt;/span>&lt;span class="n">caption&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Contents&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">install&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ·»åŠ æ–°æ–‡ä»¶æ—¶éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>æ–°æ–‡ä»¶ä¸­éœ€è¦è‡³å°‘æœ‰ä¸€ä¸ªæ ‡é¢˜ï¼Œå¦åˆ™ä¸ä¼šç”Ÿæˆç›¸åº”çš„é“¾æ¥ï¼Œä¸”é“¾æ¥é»˜è®¤ä¼šä½¿ç”¨è¯¥æ ‡é¢˜ä½œä¸ºå±•ç¤ºæ–‡æœ¬ã€‚&lt;/li>
&lt;li>åœ¨å¼•ç”¨ä¸­æ·»åŠ å­ç›®å½•å‰ç¼€å³å¯åœ¨æºç›®å½•ä¸­é€šè¿‡å­ç›®å½•ç®¡ç†æ–‡ä»¶ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>æ·»åŠ æ–°çš„ &lt;code>.md&lt;/code> æ–‡ä»¶&lt;/p>
&lt;p>æˆ‘ä»¬å°è¯•åœ¨ &lt;code>docs&lt;/code> ä¸­åˆ›å»ºä¸€ä¸ªå­ç›®å½• &lt;code>references&lt;/code> ï¼Œç„¶ååœ¨è¯¥ç›®å½•ä¸­æ·»åŠ  &lt;code>api_reference.md&lt;/code> æ–‡ä»¶ï¼Œæ¥ç€åœ¨ &lt;code>index.rst&lt;/code> æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹å¼•ç”¨æ–°æ·»åŠ çš„æ–‡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Appendix&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=========&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">:&lt;/span>&lt;span class="n">doc&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="err">`&lt;/span>&lt;span class="n">references&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">api_reference&lt;/span>&lt;span class="err">`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®è´¨ä¸Šä¸æ·»åŠ  &lt;code>.rst&lt;/code> æ–‡ä»¶å®Œå…¨ç›¸åŒï¼Œå› æ­¤æ–°çš„æ–‡æ¡£ä¸­ä¹Ÿéœ€è¦åŒ…å«æ ‡é¢˜æ‰èƒ½ç”Ÿæˆé“¾æ¥ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>æœ€ç»ˆé€šè¿‡ &lt;code>make html&lt;/code> ç”Ÿæˆçš„ HTML é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-07-sphinx-new-file.png" alt="">&lt;/p>
&lt;h2 id="ç”Ÿæˆ-api-æ–‡æ¡£">ç”Ÿæˆ API æ–‡æ¡£&lt;/h2>
&lt;p>ä»¥ä¸Šä»‹ç»çš„å†…å®¹ï¼Œå·²ç»è¶³å¤Ÿä¸ºé¡¹ç›®ç¼–å†™ä¸€èˆ¬çš„æ–‡æœ¬å†…å®¹æ–‡æ¡£ï¼Œæœ€åæ¥çœ‹å¦‚ä½•é€šè¿‡ä»£ç è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£ã€‚&lt;/p>
&lt;p>ä»¥å•æ–‡ä»¶æ¨¡å—ä½œä¸ºç¤ºä¾‹ï¼Œç»“æœåŒæ ·é€‚ç”¨äºå¤šæ–‡ä»¶çš„åŒ…å’Œæ¨¡å—ï¼Œå‡è®¾æˆ‘ä»¬çš„ä»£ç ä½äºæ ¹ç›®å½•ä¸‹çš„ &lt;code>main.py&lt;/code> æ–‡ä»¶ï¼ˆå³ &lt;code>main&lt;/code> æ¨¡å—ï¼‰ä¸­ï¼Œå†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Human&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Foo class&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">gender&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Make a virtual human.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param sex: gender of human.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param name: name of human.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gender&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gender&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">speak&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">words&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;speak some words.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :param words: words to speak.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: None
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">words&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">get_intro&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;get man&amp;#39;s introduction.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> :return: self introduction string.
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;Name: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">;Gender: &lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gender&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¯ç”¨æ‰©å±•">å¯ç”¨æ‰©å±•&lt;/h3>
&lt;p>Sphinx é€šè¿‡ &lt;code>autodoc&lt;/code> æ‰©å±•å¯¼å…¥æºä»£ç å¹¶è§£æå…¶æ–‡æ¡£å­—ç¬¦ä¸²è½¬æ¢æˆæ–‡æ¡£ã€‚æ­¤å¤–è¿˜å¯é€šè¿‡ &lt;code>viewcode&lt;/code> æ‰©å±•ç›´æ¥ä»æ–‡æ¡£è®¿é—® API å¯¹åº”çš„æºä»£ç é¡µé¢ã€‚&lt;/p>
&lt;p>é¦–å…ˆç¼–è¾‘ &lt;code>conf.py&lt;/code> æ–‡ä»¶ä»¥å¯ç”¨æ‰©å±•ï¼Œåœ¨ extensions é…ç½®é¡¹ä¸­åŠ å…¥ä¸¤ä¸ªæ‰©å±•é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-c" data-lang="c">&lt;span class="line">&lt;span class="cl">&lt;span class="n">extensions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">sphinx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">autodoc&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="n">sphinx&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">ext&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">viewcode&lt;/span>&lt;span class="err">&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ºäº†è·å–æ–‡æ¡£å­—ç¬¦ä¸²ï¼ŒSphinx éœ€è¦èƒ½å¤Ÿå¯¼å…¥æ–‡æ¡£æ‰€åœ¨çš„ä»£ç æ¨¡å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„æºç æ¨¡å—å¿…é¡»ä½äº Sphinx çš„å¯¼å…¥å±‚çº§ç»“æ„ä¸­ï¼Œè¿™æœ‰è®¸å¤šç§å®ç°é€”å¾„ï¼Œæœ¬ä¾‹é€‰æ‹©åœ¨ &lt;code>conf.py&lt;/code> ä¸­å°†ä»£ç æ¨¡å—æ‰€åœ¨çš„ç›®å½•ï¼ˆå³ &lt;code>conf.py&lt;/code> æ–‡ä»¶æ‰€åœ¨çš„ä¸Šä¸€çº§ç›®å½•ï¼‰åŠ å…¥åˆ° &lt;code>sys.path&lt;/code> ä¸­ï¼Œåœ¨ &lt;code>conf.py&lt;/code> ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">os&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">sys&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">sys&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">insert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">abspath&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;..&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>éœ€è¦æ³¨æ„è¢« Sphinx å¯¼å…¥æ—¶æ¨¡å—ä¸­çš„ä»£ç ä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥éš”ç¦»æ¨¡å—ä¸­çš„æ‰§è¡Œé€»è¾‘ä»¥é¿å…äº§ç”Ÿå‰¯ä½œç”¨ï¼Œå¦‚å°†å…¶åŒ…è£¹åœ¨ &lt;code>if __name__ == '__main__'&lt;/code> ä»£ç å—ä¸­ã€‚&lt;/p>
&lt;h3 id="å¯¼å…¥æ–‡æ¡£">å¯¼å…¥æ–‡æ¡£&lt;/h3>
&lt;p>æœ€åï¼Œåœ¨ &lt;code>references/api_reference.md&lt;/code> æ–‡æ¡£ä¸­é€šè¿‡ &lt;code>automodule&lt;/code> æŒ‡ä»¤å¯¼å…¥ &lt;code>main&lt;/code> æ¨¡å—çš„æ–‡æ¡£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-markdown" data-lang="markdown">&lt;span class="line">&lt;span class="cl">&lt;span class="gh"># API Reference
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="gh">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â€‹```{eval-rst}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.. automodule:: main
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> :members:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â€‹```
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ³¨æ„ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>é™¤äº† &lt;code>automodule&lt;/code> ï¼Œè¿˜å¯ä½¿ç”¨ &lt;code>autoclass&lt;/code> ã€ &lt;code>autofunction&lt;/code> ç­‰æŒ‡ä»¤ä¸ºå…¶ä»–ç±»å‹çš„ Python å¯¹è±¡è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä¸ºäº†åœ¨ markdown æ ¼å¼ä¸­ä½¿ç”¨ &lt;code>autodoc&lt;/code> ï¼Œéœ€è¦ä½¿ç”¨ &lt;code>eval-rst&lt;/code> æŒ‡ä»¤å¯¹å¯¼å…¥æ–‡æ¡£çš„æŒ‡ä»¤åšä¸€å±‚å°è£…ï¼Œè¯¦è§ &lt;a href="https://myst-parser.readthedocs.io/en/latest/using/howto.html#use-sphinx-ext-autodoc-in-markdown-files">Use sphinx.ext.autodoc in Markdown files&lt;/a>ï¼Œå®ƒç­‰ä»·äº &lt;code>.rst&lt;/code> æ–‡ä»¶çš„å¦‚ä¸‹å†™æ³•ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>.. automodule:: main
:members:
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ul>
&lt;p>&lt;code>references/api_reference.md&lt;/code> ç”Ÿæˆçš„é¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-07-sphinx-autodoc.png" alt="">&lt;/p>
&lt;p>é€šè¿‡é¡µé¢å³ä¾§çš„ &lt;code>[source]&lt;/code> é“¾æ¥è¿˜èƒ½å¤Ÿç›´æ¥ä»æ–‡æ¡£é¡µé¢è·³è½¬åˆ°ç›¸åº”çš„æºä»£ç ï¼š&lt;/p>
&lt;p>&lt;img src="2021-06-07-sphinx-viewcode.png" alt="">&lt;/p>
&lt;h3 id="æ–‡æ¡£å­—ç¬¦ä¸²é£æ ¼">æ–‡æ¡£å­—ç¬¦ä¸²é£æ ¼&lt;/h3>
&lt;p>ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ reStructuredText é£æ ¼ç¼–å†™æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå¦‚æœä½ æ›´å–œæ¬¢ &lt;a href="https://numpydoc.readthedocs.io/en/latest/format.html#docstring-standard">NumPy&lt;/a> æˆ– &lt;a href="https://github.com/google/styleguide/blob/gh-pages/pyguide.md#38-comments-and-docstrings">Google &lt;/a>é£æ ¼çš„æ–‡æ¡£å­—ç¬¦ä¸²ï¼Œå¯ä»¥å¯ç”¨ &lt;code>napoleon&lt;/code> æ‰©å±•ä¸ä¹‹å…¼å®¹ã€‚&lt;code>napoleon&lt;/code> æ˜¯ä¸€ä¸ªé¢„å¤„ç†å™¨ï¼Œåœ¨ &lt;code>autodoc&lt;/code> å¤„ç†æ–‡æ¡£å­—ç¬¦ä¸²ä¹‹å‰å°†å…¶è½¬æ¢ä¸ºæ­£ç¡®çš„ reStructuredText æ–‡æœ¬ã€‚&lt;/p>
&lt;p>å¯ç”¨æ–¹æ³•åŒæ ·æ˜¯ä¿®æ”¹ &lt;code>conf.py&lt;/code> æ–‡ä»¶çš„ extensions é…ç½®é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># conf.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Add napoleon to the extensions list&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">extensions&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;sphinx.ext.napoleon&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ç”¨å &lt;code>autodoc&lt;/code> å°†èƒ½å¤ŸåŒæ—¶æ”¯æŒ reStructuredTextã€NumPy åŠ Google ä¸‰ç§ä¸åŒé£æ ¼çš„æ–‡æ¡£å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;h2 id="å…¶ä»–é€”å¾„">å…¶ä»–é€”å¾„&lt;/h2>
&lt;p>é™¤äº† Sphinx ï¼Œä½¿ç”¨ &lt;a href="https://www.mkdocs.org/">MkDocs&lt;/a> é…åˆ &lt;a href="https://github.com/mkdocstrings/mkdocstrings">&lt;code>mkdocstrings&lt;/code>&lt;/a> æ‰©å±•åŒ…ä¹Ÿèƒ½å®ç°è‡ªåŠ¨ä»æºç ç”Ÿæˆæ–‡æ¡£ã€‚ç›¸æ¯”ä¹‹ä¸‹ MkDocs é…ç½®æ›´åŠ ç®€å•ï¼ŒåŸç”Ÿæ”¯æŒ markdown ä¸”å¯ä»¥è¿è¡Œé¢„è§ˆç”¨çš„å¼€å‘æœåŠ¡å™¨ï¼Œç›®å‰åœ¨ Python é¡¹ç›®ä¸­ä¹Ÿéå¸¸æµè¡Œã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://www.sphinx-doc.org/en/master/usage/quickstart.html#autodoc">Getting Started - Sphinx documentation&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://myst-parser.readthedocs.io/en/latest/using/howto.html#use-sphinx-ext-autodoc-in-markdown-files">How-To Guides&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/sphinx/" term="Sphinx" label="Sphinx"/></entry><entry><title type="text">Python æ—¶é—´å¤„ç†æ ‡å‡†åº“ï¼štime ä¸ datetime æ¨¡å—</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/differences-bettween-time-and-datetime-in-python/"/><id>https://waynerv.com/posts/differences-bettween-time-and-datetime-in-python/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-04-29T17:07:23+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">Python ä¸­å†…ç½®äº†è®¸å¤šå’Œæ“ä½œæ—¶é—´æœ‰å…³çš„ APIï¼Œå®ƒä»¬åˆ†å¸ƒåœ¨ timeï¼Œdatetime ç­‰æ ‡å‡†åº“ä¸­ï¼Œåœ¨ä½¿ç”¨æ—¶å¾ˆå®¹æ˜“æ··æ·†ï¼Œæœ¬æ–‡å°†åŠ›æ±‚æ¸…æ™°åœ°é˜è¿°å®ƒä»¬çš„ç”¨æ³•å’ŒåŒºåˆ«ã€‚</summary><content type="html">&lt;p>Python ä¸­å†…ç½®äº†è®¸å¤šå’Œæ“ä½œæ—¶é—´æœ‰å…³çš„ APIï¼Œå®ƒä»¬åˆ†å¸ƒåœ¨ &lt;code>time&lt;/code> ï¼Œ &lt;code>datetime&lt;/code> ç­‰æ ‡å‡†åº“ä¸­ï¼Œç”¨æ³•ç¹å¤šä¸”å®¹æ˜“æ··æ·†ï¼Œæœ¬æ–‡å°†åŠ›æ±‚æ¸…æ™°åœ°é˜è¿°è¿™äº› API çš„å…³é”®éƒ¨åˆ†å’ŒåŒºåˆ«ï¼Œå¸®åŠ©ä½ äº†è§£å¹¶æŒæ¡å…¶ç”¨æ³•ã€‚&lt;/p>
&lt;p>ä¸‹æ–‡å°†åˆ†åˆ«ä»‹ç»æ¯ä¸ªæ¨¡å—çš„ä¸»è¦ç›®çš„ã€æ ¸å¿ƒå¯¹è±¡ã€å¸¸ç”¨æ–¹æ³•ä»¥åŠç”¨é€”ï¼Œå¹¶åœ¨æœ€ååšåˆ†æå¯¹æ¯”ï¼Œå¦‚æœå·²ç»äº†è§£è¿™äº›ç»†èŠ‚å¯ä»¥ç›´æ¥è·³è½¬åˆ°ç»“å°¾çš„æ€»ç»“å¯¹æ¯”éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>å¦å¤–æœ¬æ–‡å°†é¿å…æ¶‰åŠå­—ç¬¦ä¸²æ ¼å¼åŒ–ã€æ—¶åŒºã€å†¬å¤ä»¤æ—¶ç­‰æ›´å¤æ‚æ·±å…¥çš„è¯é¢˜ã€‚&lt;/p>
&lt;h2 id="time-æ¨¡å—">time æ¨¡å—&lt;/h2>
&lt;p>æ¦‚æ‹¬æ¥è¯´ï¼Œ&lt;code>time&lt;/code> æ¨¡å—é€šè¿‡ç³»ç»Ÿåº•å±‚çš„è®¡æ—¶å™¨è·å–è‡ª &lt;code>epoch&lt;/code> ä»¥æ¥ç»è¿‡çš„æ€»ç§’æ•°ï¼ˆå¯èƒ½ä¸ºæµ®ç‚¹æ•°ï¼‰ï¼Œå³æˆ‘ä»¬å¸¸è¯´çš„ POSIX æ—¶é—´æˆ³ï¼ˆtimestampï¼‰ã€‚å®ƒçš„ç”¨æ³•è¾ƒä¸ºä½é˜¶ï¼Œé€‚åˆç”¨åšç²¾ç¡®è®¡æ—¶ã€‚å¯¹ Unix ç³»ç»Ÿæ¥è¯´ï¼Œ &lt;code>epoch&lt;/code> ä¸º &lt;code>1970å¹´1æœˆ1æ—¥ 00:00:00ï¼ˆUTCï¼‰&lt;/code>ï¼Œå› æ­¤è¯¥æ¨¡å—ä¹Ÿå¯ä»¥å°†æ—¶é—´æˆ³è½¬æ¢ä¸ºå…·ä½“çš„æ—¥æœŸæ—¶é—´ï¼Œä½†è¡¨ç¤ºæ—¥æœŸæ—¶é—´çš„å¯¹è±¡ç»“æ„éå¸¸ç®€å•ï¼Œä¸é€‚åˆè¿›è¡Œå¤æ‚çš„æ“ä½œå’Œè¡¨ç¤ºã€‚&lt;/p>
&lt;h3 id="æ ¸å¿ƒå¯¹è±¡">æ ¸å¿ƒå¯¹è±¡&lt;/h3>
&lt;p>&lt;code>time&lt;/code> æ¨¡å—çš„ API ä¸­åªæœ‰ä¸€ä¸ªç±»ï¼š &lt;code>time.struct_time&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>struct_time&lt;/code> æ˜¯ä¸€ä¸ªè½¬æ¢ &lt;code>epoch&lt;/code> ä»¥æ¥ç»è¿‡ç§’æ•°å¾—åˆ°çš„ç»“æ„åŒ–çš„æ—¶é—´å¯¹è±¡ï¼Œå®ƒæä¾›äº†ç±»ä¼¼ &lt;code>namedtuple&lt;/code> çš„ APIï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡æˆ–å±æ€§åç§°è·å–å¯¹è±¡çš„å¹´æœˆæ—¥æ—¶åˆ†ç§’ç­‰å±æ€§ã€‚è°ƒç”¨ &lt;code>gmtime()&lt;/code> ï¼Œ&lt;code>localtime()&lt;/code>ï¼Œ&lt;code>strptime()&lt;/code> ç­‰æ–¹æ³•å¯å¾—åˆ° &lt;code>struct_time&lt;/code> å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">localtime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">39&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">14&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">119&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tm_mon&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code>struct_time&lt;/code> å®ä¾‹å®è´¨æ˜¯ä¸€ä¸ªæ•°å­—ç»„æˆçš„ç±»å…ƒç¥–åºåˆ—ï¼Œè¯¥æ¨¡å—ä¸­æ¥æ”¶ &lt;code>struct_time&lt;/code> å®ä¾‹ä½œä¸ºå‚æ•°çš„å‡½æ•°éƒ½å¯ä»¥ç›´æ¥æ¥æ”¶ä¸€ä¸ªåŒæ ·é•¿åº¦çš„å…ƒç¥–ã€‚å®ƒåªèƒ½ç®€å•çš„è®°å½•é€šè¿‡æ¢ç®—æ—¶é—´æˆ³å¾—åˆ°çš„å¹´æœˆæ—¥æ—¶åˆ†ç­‰å±æ€§ï¼Œæ²¡æœ‰æä¾›æ”¯æŒé¢å¤–æ“ä½œçš„å…¶ä»–æ–¹æ³•ï¼Œå› æ­¤å®è·µä¸­çš„ç”¨é€”éå¸¸æœ‰é™ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">localtime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">localtime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">st2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">st1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Traceback&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">most&lt;/span> &lt;span class="n">recent&lt;/span> &lt;span class="n">call&lt;/span> &lt;span class="n">last&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">File&lt;/span> &lt;span class="s2">&amp;#34;&amp;lt;input&amp;gt;&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">line&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">module&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">st2&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">st1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ne">TypeError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">unsupported&lt;/span> &lt;span class="n">operand&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;time.struct_time&amp;#39;&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="s1">&amp;#39;time.struct_time&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¸¸è§ç”¨é€”ä¸å‡½æ•°">å¸¸è§ç”¨é€”ä¸å‡½æ•°&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>è®¡æ—¶&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>time.time()&lt;/code> ä»¥æµ®ç‚¹æ•°çš„å½¢å¼è¿”å›è‡ª &lt;code>epoch&lt;/code> ä»¥æ¥ç»è¿‡çš„æ—¶é—´ç§’æ•°ã€‚å¸¸è§ç”¨æ³•æ˜¯é€šè¿‡è®¡ç®—ä¸¤æ¬¡è°ƒç”¨ä¹‹é—´çš„é—´éš”æ¥å¾—å‡ºç¨‹åºæ‰§è¡Œæ—¶é—´ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">1619665423.683973&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>time.sleep(seconds)&lt;/code> æš‚åœè°ƒç”¨çº¿ç¨‹çš„æ‰§è¡Œï¼Œæš‚åœæ—¶é—´ä¸ºç»™å®šçš„ç§’æ•°ã€‚ç»å¸¸ç”¨äºæµ‹è¯•æ¨¡æ‹Ÿï¼Œå®é™…çš„æš‚åœæ—¶é—´å¯èƒ½è¶…å‡ºç»™å®šç§’æ•°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>time.perf_counter()&lt;/code> æ˜¯è®¡ç®—è¾ƒçŸ­æ—¶é—´é—´éš”çš„æ›´å¥½æ–¹æ³•ï¼Œç»“æœæ›´ä¸ºç²¾ç¡®ï¼Œåœ¨è®¡ç®—æ‰§è¡Œæ—¶é—´æ—¶å¯æ›¿ä»£ä¸Šè¿°çš„ &lt;code>time.time()&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">start&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perf_counter&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">perf_counter&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">end&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">start&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">2.731515233999744&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>åœ¨ &lt;code>struct_time&lt;/code> å’Œæ—¶é—´æˆ³ä¹‹é—´è¿›è¡Œè½¬æ¢&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>time.gmtime([secs])&lt;/code> å°†ç»™å®šç§’æ•°è½¬æ¢ä¸ºä¸€ä¸ª UTC æ—¶åŒº &lt;code>struct_time&lt;/code> å¯¹è±¡ï¼Œè‹¥æœªæä¾›ç§’æ•°å°†ä½¿ç”¨ &lt;code>time.time()&lt;/code> å¾—åˆ°çš„è¿”å›å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">now&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gmtime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">51&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">119&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">gmtime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">51&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">56&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">119&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>time.localtime([secs])&lt;/code> å°†ç»™å®šç§’æ•°è½¬æ¢ä¸ºä¸€ä¸ªæœ¬åœ°æ—¶åŒºçš„ &lt;code>struct_time&lt;/code> å¯¹è±¡ï¼Œè‹¥æœªæä¾›ç§’æ•°å°†ä½¿ç”¨ &lt;code>time.time()&lt;/code> å¾—åˆ°çš„è¿”å›å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">localtime&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">53&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">38&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">119&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>time.mktime(t)&lt;/code> å°†ä¸€ä¸ª &lt;code>struct_time&lt;/code> å¯¹è±¡è½¬æ¢ä¸ºç§’æ•°ï¼Œè¯¥å¯¹è±¡å°†è¢«å½“åšæœ¬åœ°æ—¶åŒºå¤„ç†ï¼Œæ•ˆæœåˆšå¥½ä¸ &lt;code>time.localtime([secs])&lt;/code> ç›¸åã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">mktime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">localtime&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">1619672313.0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>åœ¨ &lt;code>struct_time&lt;/code> å’Œå­—ç¬¦ä¸²ä¹‹é—´è¿›è¡Œè½¬æ¢&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>time.strftime(format[, t])&lt;/code> å°†ä¸€ä¸ª &lt;code>struct_time&lt;/code> å¯¹è±¡æŒ‰æŒ‡å®šçš„ &lt;code>format&lt;/code> ç¼–ç æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œ&lt;code>t&lt;/code> çš„é»˜è®¤å€¼æ˜¯ &lt;code>time.localtime()&lt;/code> çš„è¿”å›å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%H:%M:%S&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;13:10:37&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>time.strptime(string[, format])&lt;/code> å°†ä¸€ä¸ªå­—ç¬¦ä¸²æŒ‰æŒ‡å®šçš„ &lt;code>format&lt;/code> ç¼–ç è§£æä¸º &lt;code>struct_time&lt;/code> å¯¹è±¡ï¼Œ&lt;code>format&lt;/code> çš„é»˜è®¤å€¼ä¸º &lt;code>&amp;quot;%a %b %d %H:%M:%S %Y&amp;quot;&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strptime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;30 Nov 00&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s2"> %b %y&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2000&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">11&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">335&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¦‚ä¸Šç¤ºä¾‹ï¼Œè§£ææ—¶æœªæä¾›çš„æ—¶é—´å•ä½å°†ä½¿ç”¨é»˜è®¤å€¼å¡«å……ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="datetime-æ¨¡å—">datetime æ¨¡å—&lt;/h2>
&lt;p>&lt;code>datetime&lt;/code> æ¨¡å—æ”¯æŒæ—¥æœŸå’Œæ—¶é—´çš„è¿ç®—ï¼Œä½†å®ç°çš„é‡ç‚¹æ˜¯ä¸ºè¾“å‡ºæ ¼å¼åŒ–å’Œæ“ä½œæä¾›é«˜æ•ˆçš„å±æ€§æå–ã€‚&lt;/p>
&lt;p>&lt;code>datetime&lt;/code> æ¨¡å—æä¾›äº†ä¸€äº›ç”¨äºæ“ä½œæ—¥æœŸå’Œæ—¶é—´çš„ç±»ã€‚è¯¥æ¨¡å—çš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½éƒ½å›´ç»•ç€ä»¥ä¸‹ 4 ä¸ªç±»ï¼ˆä»¥åŠå¦å¤–ä¸¤ä¸ªå…³äºæ—¶åŒºçš„ç±»ï¼‰çš„æ–¹æ³•å’Œå±æ€§æ¥å®ç°ã€‚ä¸€ä¸ªå®¹æ˜“è®©äººæ··æ·†çš„ç‚¹æ˜¯ï¼Œè™½ç„¶å®ƒä»¬å…¨éƒ½æ˜¯ Python ç±»ï¼Œä½†åœ¨å‘½åä¸­å¹¶æœªéµå¾ªé¦–å­—æ¯å¤§å†™çš„æƒ¯ä¾‹ï¼Œåœ¨å¯¼å…¥æ—¶çœ‹ä¸Šå»å°±åƒæ˜¯ &lt;code>datetime&lt;/code> ä¸‹çš„å­åŒ…æˆ–è€…å­æ¨¡å—ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°†ç®€è¦ä»‹ç»æ¯ä¸€ä¸ªç±»&lt;strong>å¸¸ç”¨çš„&lt;/strong>å®ä¾‹æ„é€ æ–¹å¼ã€æ”¯æŒçš„æ“ä½œç¬¦ã€å®ä¾‹æ–¹æ³•ä»¥åŠå®ä¾‹å±æ€§ã€‚&lt;/p>
&lt;h3 id="date">&lt;code>date&lt;/code>&lt;/h3>
&lt;p>è¡¨ç¤ºæ—¥æœŸç±»å‹ã€‚&lt;/p>
&lt;h4 id="å®ä¾‹æ„é€ æ–¹å¼">å®ä¾‹æ„é€ æ–¹å¼&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>å®ä¾‹åŒ– &lt;code>date&lt;/code> ç±»ï¼Œéœ€è¦ä¼ å…¥æ—¥æœŸå¯¹åº”çš„å¹´æœˆæ—¥å‚æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>date.fromtimestamp(timestamp)&lt;/code> ç±»æ–¹æ³•ï¼Œéœ€è¦ä¼ å…¥çš„å‚æ•°ä¸ºé€šè¿‡ &lt;code>time&lt;/code> æ¨¡å—è·å–çš„ &lt;code>epoch&lt;/code> ä»¥æ¥ç§’æ•°ï¼ˆå³æ—¶é—´æˆ³ï¼‰ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>date.today()&lt;/code> ç±»æ–¹æ³•ï¼Œå®è´¨æ˜¯ä»¥å½“å‰æ—¶é—´æˆ³ä½œä¸ºå‚æ•°è°ƒç”¨ &lt;code>date.fromtimestamp()&lt;/code> ç±»æ–¹æ³•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>date.fromisoformat(date_string)&lt;/code> ç±»æ–¹æ³•ï¼Œè¿™æ˜¯ä¸€ç§è¾ƒä¸ºç›´è§‚çš„åˆ›å»ºæ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromisoformat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;2021-04-29&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="æ”¯æŒçš„æ“ä½œç¬¦">æ”¯æŒçš„æ“ä½œç¬¦&lt;/h4>
&lt;ul>
&lt;li>æ”¯æŒä¸å¦ä¸€ &lt;code>date&lt;/code> å¯¹è±¡è¿›è¡Œ &lt;code>==&lt;/code>ï¼Œ&lt;code>â‰¤&lt;/code>ï¼Œ&lt;code>&amp;lt;&lt;/code>ï¼Œ&lt;code>â‰¥&lt;/code>ï¼Œ&lt;code>&amp;gt;&lt;/code> ç­‰æ¯”è¾ƒæ“ä½œã€‚&lt;/li>
&lt;li>æ”¯æŒä¸ &lt;code>timedelta&lt;/code> å¯¹è±¡è¿›è¡ŒåŠ å‡æ“ä½œï¼Œç»“æœä¾ç„¶ä¸º &lt;code>date&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;li>æ”¯æŒä¸å¦ä¸€ &lt;code>date&lt;/code> å¯¹è±¡è¿›è¡Œç›¸å‡æ“ä½œï¼Œå¾—åˆ° &lt;code>timedelta&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;li>æ”¯æŒå“ˆå¸Œã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹æ–¹æ³•">å®ä¾‹æ–¹æ³•&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>strftime(self, fmt)&lt;/code> æŒ‰æŒ‡å®šçš„ &lt;code>fmt&lt;/code> æ ¼å¼åŒ–ç¼–ç è¿”å›å½“å‰ &lt;code>date&lt;/code> å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">today&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%Y-%m-&lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;2021-04-29&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>isoformat(self)&lt;/code> è¿”å›å½“å‰ &lt;code>date&lt;/code> å¯¹è±¡çš„ &lt;code>iso&lt;/code> å­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">isoformat&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;2021-04-29&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>timetuple(self)&lt;/code> å°†å½“å‰ &lt;code>date&lt;/code> å¯¹è±¡è½¬æ¢æˆ &lt;code>time&lt;/code> æ¨¡å—çš„ &lt;code>struct_time&lt;/code> å¯¹è±¡å¹¶è¿”å›ï¼Œæ—¶åˆ†ç§’ç­‰å±æ€§ä½¿ç”¨é»˜è®¤å€¼å¡«å……ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timetuple&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">struct_time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tm_year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mon&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_mday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_min&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_sec&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_wday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_yday&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">119&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">tm_isdst&lt;/span>&lt;span class="o">=-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>replace(self, year=None, month=None, day=None)&lt;/code> è¿”å›æ›¿æ¢å½“å‰ &lt;code>date&lt;/code> å¯¹è±¡çš„æŸä¸€å±æ€§åçš„å‰¯æœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">day&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>weekday(self)&lt;/code> è¿”å›å½“å‰ &lt;code>date&lt;/code> å¯¹è±¡æ‰€å±çš„æ˜ŸæœŸï¼Œä» 0 å¼€å§‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">weekday&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">3&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹å±æ€§">å®ä¾‹å±æ€§&lt;/h4>
&lt;ul>
&lt;li>&lt;code>year&lt;/code>&lt;/li>
&lt;li>&lt;code>month&lt;/code>&lt;/li>
&lt;li>&lt;code>day&lt;/code>&lt;/li>
&lt;/ul>
&lt;h3 id="time">&lt;code>time&lt;/code>&lt;/h3>
&lt;p>è¡¨ç¤ºæ—¶é—´ï¼ˆæ—¶åˆ†ç§’ï¼‰ç±»å‹ã€‚&lt;/p>
&lt;h4 id="å®ä¾‹æ„é€ æ–¹å¼-1">å®ä¾‹æ„é€ æ–¹å¼&lt;/h4>
&lt;p>&lt;code>time&lt;/code> ä¸æ”¯æŒé€šè¿‡æ—¶é—´æˆ³æ„é€ å®ä¾‹ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å®ä¾‹åŒ– &lt;code>time&lt;/code> ç±»å¹¶ä¼ å…¥å¯¹åº”å‚æ•°ã€‚éœ€è¦ä¼ å…¥æ—¶é—´å¯¹åº”çš„æ—¶åˆ†ç§’å¾®ç§’ç­‰å‚æ•°ï¼Œå‚æ•°å‡æœ‰å–å€¼èŒƒå›´ä¸”é»˜è®¤å€¼ä¸º 0ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡è°ƒç”¨&lt;code>fromisoformat(cls, time_string)&lt;/code> ç±»æ–¹æ³•ï¼Œä» &lt;code>iso&lt;/code> å­—ç¬¦ä¸²ä¸­åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromisoformat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;17:32:10&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">32&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="æ”¯æŒçš„æ“ä½œç¬¦-1">æ”¯æŒçš„æ“ä½œç¬¦&lt;/h4>
&lt;ul>
&lt;li>æ”¯æŒä¸å¦ä¸€ &lt;code>time&lt;/code> å¯¹è±¡è¿›è¡Œ &lt;code>==&lt;/code>ï¼Œ&lt;code>â‰¤&lt;/code>ï¼Œ&lt;code>&amp;lt;&lt;/code>ï¼Œ&lt;code>â‰¥&lt;/code>ï¼Œ&lt;code>&amp;gt;&lt;/code> ç­‰æ¯”è¾ƒæ“ä½œã€‚&lt;/li>
&lt;li>æ”¯æŒå“ˆå¸Œã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>time&lt;/code> å¯¹è±¡ä¸æ”¯æŒä¸ &lt;code>time&lt;/code> æˆ– &lt;code>timedelta&lt;/code> è¿›è¡ŒåŠ å‡æ“ä½œï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®¡ç®—ä¸¤ä¸ª &lt;code>time&lt;/code> å¯¹è±¡ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>datetime.combine()&lt;/code> å°†å®ƒä»¬å¤„ç†ä¸ºæ—¥æœŸç›¸åŒçš„ &lt;code>datetime&lt;/code> å¯¹è±¡å†è¿›è¡Œè®¡ç®—:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">combine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">today&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">t2&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">combine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">today&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">t1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4440&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å®ä¾‹æ–¹æ³•-1">å®ä¾‹æ–¹æ³•&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>&lt;code>strftime(self, fmt)&lt;/code> æŒ‰æŒ‡å®šçš„ &lt;code>fmt&lt;/code> æ ¼å¼åŒ–ç¼–ç è¿”å›å½“å‰ &lt;code>time&lt;/code> å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromisoformat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;17:32:10&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strftime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;%Hh %Mm %Ss&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;17h 32m 10s&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>isoformat(self)&lt;/code> è¿”å›å½“å‰ &lt;code>time&lt;/code> å¯¹è±¡çš„ &lt;code>iso&lt;/code> å­—ç¬¦ä¸²è¡¨ç¤ºã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">minute&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">27&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">second&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">55&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">isoformat&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;17:27:55&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>replace(self,hour=None,minute=None,second=None,microsecond=None, tzinfo=True, *,fold=None)&lt;/code> è¿”å›æ›¿æ¢å½“å‰ &lt;code>time&lt;/code> å¯¹è±¡çš„æŸä¸€å±æ€§åçš„å‰¯æœ¬ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">t&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">replace&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">hour&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">27&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">55&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹å±æ€§-1">å®ä¾‹å±æ€§&lt;/h4>
&lt;ul>
&lt;li>&lt;code>hour&lt;/code>&lt;/li>
&lt;li>&lt;code>minute&lt;/code>&lt;/li>
&lt;li>&lt;code>second&lt;/code>&lt;/li>
&lt;li>ä»¥åŠ &lt;code>micorsecond&lt;/code> ï¼Œ&lt;code>tzinfo&lt;/code>ï¼Œ&lt;code>fold&lt;/code> ç­‰å±æ€§&lt;/li>
&lt;/ul>
&lt;h3 id="datetime">&lt;code>datetime&lt;/code>&lt;/h3>
&lt;p>è¡¨ç¤ºåŒ…å«æ—¥æœŸæ—¶åˆ†çš„æ—¶é—´ç±»å‹ï¼Œæ˜¯ &lt;code>date&lt;/code> çš„å­ç±»ï¼Œå› æ­¤ä¹Ÿç»§æ‰¿äº† &lt;code>date&lt;/code> çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ã€‚å®ƒçš„å®ä¾‹è¿˜å¯ä»¥è§†ä½œ &lt;code>date&lt;/code> å’Œ &lt;code>time&lt;/code> å®ä¾‹çš„ç»„åˆä½“ï¼Œå› æ­¤åŒæ—¶å…·å¤‡äº†ä¸¤ç§å¯¹è±¡çš„å¤§éƒ¨åˆ†æ–¹æ³•å’Œå±æ€§ã€‚&lt;/p>
&lt;p>ä¸‹æ–‡çš„ä»‹ç»ä¸­ä¸åŒ…å«ä» &lt;code>date&lt;/code> ç»§æ‰¿çš„æ–¹æ³•å’Œå±æ€§ã€‚&lt;/p>
&lt;h4 id="å®ä¾‹æ„é€ æ–¹å¼-2">å®ä¾‹æ„é€ æ–¹å¼&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>å®ä¾‹åŒ– &lt;code>datetime&lt;/code> ç±»å¹¶ä¼ å…¥å¯¹åº”å‚æ•°ï¼Œæ¥æ”¶å‚æ•°ä¸º &lt;code>date&lt;/code> å’Œ &lt;code>time&lt;/code> å®ä¾‹åŒ–å‚æ•°çš„ç»„åˆï¼Œå…¶ä¸­æ—¥æœŸå‚æ•°ä¸ºå¿…å¡«å‚æ•°ï¼Œå…¶ä»–å‚æ•°æœ‰é»˜è®¤å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">year&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">month&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">day&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>datetime.now()&lt;/code> æˆ– &lt;code>datetime.utcnow()&lt;/code> ç±»æ–¹æ³•ï¼ŒåŒºåˆ«ä¸ºå®ä¾‹çš„å¯¹åº”æ—¶åŒºä¸åŒã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">53&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">648203&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcnow&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">671572&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è°ƒç”¨ &lt;code>datetime.fromtimestamp(timestamp)&lt;/code> æˆ– &lt;code>datetime.utcfromtimestamp(timestamp)&lt;/code> ç±»æ–¹æ³•å¹¶ä¼ å…¥æ—¶é—´æˆ³ï¼ŒåŒºåˆ«ä¸ºå®ä¾‹çš„å¯¹åº”æ—¶åŒºä¸åŒã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="nn">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">utcfromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">798136&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromtimestamp&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">())&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">26&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">251251&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡è°ƒç”¨ &lt;code>datetime.fromisoformat(time_string)&lt;/code> ç±»æ–¹æ³•ï¼Œä» &lt;code>iso&lt;/code> å­—ç¬¦ä¸²ä¸­åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fromisoformat&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;2021-04-29 16:09:32&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">32&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡è°ƒç”¨ &lt;code>datetime.combine(date, time)&lt;/code> ç±»æ–¹æ³•ï¼Œä» &lt;code>date&lt;/code> å®ä¾‹å’Œ &lt;code>time&lt;/code> å®ä¾‹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ &lt;code>datetime&lt;/code> å®ä¾‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">combine&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">today&lt;/span>&lt;span class="p">(),&lt;/span> &lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">datetime&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">12&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡è°ƒç”¨ &lt;code>datetime.strptime(date_string, format)&lt;/code> ç±»æ–¹æ³•ï¼Œè§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="æ”¯æŒçš„æ“ä½œç¬¦-2">æ”¯æŒçš„æ“ä½œç¬¦&lt;/h4>
&lt;ul>
&lt;li>&lt;code>datetime&lt;/code> æ”¯æŒä¸ &lt;code>date&lt;/code> è¿›è¡Œç›¸ç­‰æ¯”è¾ƒï¼Œä½†ç»“æœä¸€å®šä¸º &lt;code>False&lt;/code> ï¼Œé™¤æ­¤ä¹‹å¤–åªæ”¯æŒä¸å¦ä¸€ &lt;code>datetime&lt;/code> å¯¹è±¡æ‰§è¡Œ &lt;code>==&lt;/code>ï¼Œ&lt;code>â‰¤&lt;/code>ï¼Œ&lt;code>&amp;lt;&lt;/code>ï¼Œ&lt;code>â‰¥&lt;/code>ï¼Œ&lt;code>&amp;gt;&lt;/code> ç­‰æ¯”è¾ƒæ“ä½œã€‚&lt;/li>
&lt;li>æ”¯æŒä¸ &lt;code>timedelta&lt;/code> ç›¸åŠ ï¼Œç»“æœä¸º &lt;code>datetime&lt;/code>ï¼›æ”¯æŒä¸ &lt;code>timedelta&lt;/code> å¯¹è±¡è¿›è¡ŒåŠ å‡ï¼Œç»“æœä¾ç„¶ä¸º &lt;code>datetime&lt;/code> å¯¹è±¡ï¼Œä¸å¦ä¸€ &lt;code>datetime&lt;/code> å¯¹è±¡è¿›è¡Œç›¸å‡ï¼Œå¾—åˆ° &lt;code>timedelta&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;li>åŒæ ·æ”¯æŒå“ˆå¸Œã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹æ–¹æ³•-2">å®ä¾‹æ–¹æ³•&lt;/h4>
&lt;p>é™¤äº†ä» &lt;code>date&lt;/code> ç»§æ‰¿çš„ &lt;code>strftime()&lt;/code>ã€&lt;code>timetuple()&lt;/code>ã€&lt;code>isoformat()&lt;/code> å’Œ &lt;code>replace()&lt;/code>ç­‰æ–¹æ³•å¤–ï¼Œè¿˜æ‹¥æœ‰ä»¥ä¸‹æ–¹æ³•ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>timestamp(self)&lt;/code> è¿”å›ä¸€ä¸ªæµ®ç‚¹æ•°æ ¼å¼çš„ POSIX æ—¶é—´æˆ³ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timestamp&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">1619685580.762657&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>date(self)&lt;/code> è¿”å›ä¸€ä¸ªä»£è¡¨æ—¥æœŸéƒ¨åˆ†çš„ &lt;code>date&lt;/code> å¯¹è±¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">date&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2021&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">29&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>&lt;code>time(self)&lt;/code> è¿”å›ä¸€ä¸ªä»£è¡¨æ—¶åˆ†éƒ¨åˆ†çš„ &lt;code>time&lt;/code> å¯¹è±¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">time&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">39&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">40&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">762657&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹å±æ€§-2">å®ä¾‹å±æ€§&lt;/h4>
&lt;p>åŒæ—¶å…·æœ‰&lt;code>date&lt;/code> å’Œ &lt;code>time&lt;/code> å®ä¾‹çš„æ‰€æœ‰å±æ€§ã€‚&lt;/p>
&lt;h3 id="timedelta">&lt;code>timedelta&lt;/code>&lt;/h3>
&lt;p>è¡¨ç¤ºä¸¤ä¸ª &lt;code>datetime&lt;/code> å¯¹è±¡ä¹‹é—´çš„å·®å¼‚ã€‚&lt;/p>
&lt;h4 id="å®ä¾‹æ„é€ æ–¹å¼-3">å®ä¾‹æ„é€ æ–¹å¼&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>å®ä¾‹åŒ– &lt;code>timedelta&lt;/code> ç±»å¹¶ä¼ å…¥å¯¹åº”å‚æ•°ï¼Œæ¥æ”¶å‚æ•°ä¸ &lt;code>datetime&lt;/code> ç±»åŸºæœ¬ç›¸åŒä½†ä¸åŒ…æ‹¬å¹´ï¼Œé»˜è®¤å€¼å‡ä¸º 0ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¯¹ä¸¤ä¸ª &lt;code>datetime&lt;/code> æ‰§è¡Œç›¸å‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt2&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">dt1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">microseconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">476390&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="æ”¯æŒçš„æ“ä½œç¬¦-3">æ”¯æŒçš„æ“ä½œç¬¦&lt;/h4>
&lt;ul>
&lt;li>
&lt;p>åªæ”¯æŒä¸å¦ä¸€ &lt;code>timedelta&lt;/code> è¿›è¡Œæ¯”è¾ƒï¼Œè¿›è¡Œ &lt;code>==&lt;/code>ï¼Œ&lt;code>â‰¤&lt;/code>ï¼Œ&lt;code>&amp;lt;&lt;/code>ï¼Œ&lt;code>â‰¥&lt;/code>ï¼Œ&lt;code>&amp;gt;&lt;/code> ç­‰æ¯”è¾ƒæ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>timedelta&lt;/code> å¯¹è±¡æ”¯æŒæ”¯æŒåŠ å‡æ“ä½œï¼Œ&lt;code>datetime&lt;/code> ä¸ &lt;code>timedelta&lt;/code> ç›¸åŠ æˆ–ç›¸å‡ä»ç„¶è¿”å› &lt;code>datetime&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>timedelta&lt;/code> è¿˜æ”¯æŒä¹˜é™¤æ¨¡é™¤ç­‰æ“ä½œç¬¦ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ”¯æŒå“ˆå¸Œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>timedelta&lt;/code> æ˜¯æœ‰ç¬¦å·çš„ï¼Œæ”¯æŒ &lt;code>abs()&lt;/code> å‡½æ•°ï¼Œå¯è¿”å›ä¸¤ä¸ª &lt;code>datetime&lt;/code> ä¹‹é—´çš„ç»å¯¹é—´éš”ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">dt2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">now&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">td&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dt1&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">dt2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">td&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">86395&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">microseconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">573188&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">td&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">total_seconds&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">-&lt;/span>&lt;span class="mf">4.426812&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">td&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">microseconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">426812&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h4 id="å®ä¾‹æ–¹æ³•-3">å®ä¾‹æ–¹æ³•&lt;/h4>
&lt;ul>
&lt;li>&lt;code>total_seconds(self)&lt;/code> è¿”å›è¯¥æ—¶é—´é—´éš”çš„æ‰€æœ‰ç§’æ•°ã€‚&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">minutes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">35&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">total_seconds&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">215.0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="å®ä¾‹å±æ€§-3">å®ä¾‹å±æ€§&lt;/h4>
&lt;p>&lt;code>timedelta&lt;/code> åªé€šè¿‡ &lt;code>days&lt;/code> ã€&lt;code>seconds&lt;/code>ï¼Œ&lt;code>microseconds&lt;/code> è¿™ 3 ç§å•ä½è¿›è¡Œç»„åˆæ¥ä¿å­˜æ—¶é—´é—´éš”ï¼Œå¯é€šè¿‡å¯¹åº”å±æ€§è·å–æ•°å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">minutes&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">35&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">seconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">215&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">microseconds&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">datetime&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">timedelta&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">days&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">seconds&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="æ€»ç»“å¯¹æ¯”">æ€»ç»“å¯¹æ¯”&lt;/h2>
&lt;h3 id="time-ä¸-datetime-æ¨¡å—çš„åŒºåˆ«">&lt;code>time&lt;/code> ä¸ &lt;code>datetime&lt;/code> æ¨¡å—çš„åŒºåˆ«ï¼š&lt;/h3>
&lt;ul>
&lt;li>&lt;code>time&lt;/code> æ¨¡å—ï¼Œè·å–ç³»ç»Ÿæ—¶é—´æˆ³ï¼Œä¸»è¦ç”¨äºè®¡æ—¶æˆ–è¡¨ç¤ºæŸä¸€æ—¶é—´ç‚¹ï¼Œå¯ä»¥é€šè¿‡æ•°å€¼å…ƒç¥–è¡¨ç¤ºç»“æ„åŒ–çš„æ—¥æœŸæ—¶é—´ï¼Œä½†ä¸æ”¯æŒè¿›ä¸€æ­¥çš„è½¬æ¢æˆ–æ“ä½œã€‚&lt;/li>
&lt;li>&lt;code>datetime&lt;/code> æ¨¡å—ï¼ŒåŸºäºæ—¶é—´æˆ³æ„å»ºé«˜é˜¶çš„æ—¥æœŸã€æ—¶é—´ã€é—´éš”ç­‰å¯¹è±¡ï¼Œæ”¯æŒä¸°å¯Œçš„è½¬æ¢æ–¹å¼å’Œæ“ä½œã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="datetime-æ¨¡å—ä¸­ä¸åŒå¯¹è±¡çš„åŒºåˆ«">&lt;code>datetime&lt;/code> æ¨¡å—ä¸­ä¸åŒå¯¹è±¡çš„åŒºåˆ«ï¼š&lt;/h3>
&lt;ul>
&lt;li>&lt;code>date&lt;/code> åªè¡¨ç¤ºæ—¥æœŸã€‚æ”¯æŒä¸ &lt;code>date&lt;/code> æˆ– &lt;code>timedelta&lt;/code> è¿›è¡ŒåŠ å‡æ“ä½œ.&lt;/li>
&lt;li>&lt;code>time&lt;/code> åªè¡¨ç¤ºæ—¶åˆ†ã€‚ä¸æ”¯æŒä¸ &lt;code>time&lt;/code> æˆ– &lt;code>timedelta&lt;/code> è¿›è¡ŒåŠ å‡æ“ä½œï¼Œè®¡ç®—é—´éš”éœ€è¦å…ˆè½¬æ¢æˆ &lt;code>datetime&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;li>&lt;code>datetime&lt;/code> åŒæ—¶è¡¨ç¤ºæ—¥æœŸå’Œæ—¶åˆ†çš„æ—¶é—´å¯¹è±¡ã€‚åŒæ—¶å…·å¤‡ &lt;code>date&lt;/code> å’Œ &lt;code>time&lt;/code> å¯¹è±¡çš„è¡Œä¸ºå’Œå±æ€§ï¼Œå¯ä»¥ä»ä¸­è§£æå‡ºå•ç‹¬çš„ &lt;code>date&lt;/code> å’Œ &lt;code>time&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;li>&lt;code>timedelta&lt;/code> è¡¨ç¤ºä¸¤ä¸ªæ—¶é—´ä¹‹é—´çš„é—´éš”ã€‚åªé€šè¿‡ &lt;code>days&lt;/code> ã€&lt;code>seconds&lt;/code>ï¼Œ&lt;code>microseconds&lt;/code> è¿™ 3 ç§å•ä½æ¥è¡¨ç¤ºã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸è§£æ">å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸è§£æ&lt;/h3>
&lt;p>å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸è§£æï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>time.struct_time&lt;/code>ã€&lt;code>datetime.date&lt;/code>ã€&lt;code>datetime.time&lt;/code>ã€&lt;code>datetime.datetime&lt;/code> ç­‰å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ &lt;code>strftime()&lt;/code> ï¼ˆstring formatï¼‰å®ä¾‹æ–¹æ³•æˆ–å‡½æ•°è½¬æ¢ä¸ºæŒ‡å®šæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‰¹å®šæ ¼å¼çš„å­—ç¬¦ä¸²ä»…å¯ä»¥é€šè¿‡ &lt;code>strptime()&lt;/code>ï¼ˆstring parseï¼‰ç±»æ–¹æ³•æˆ–å‡½æ•°ç›´æ¥è½¬æ¢ä¸º&lt;code>time.struct_time&lt;/code>ã€&lt;code>datetime.datetime&lt;/code> å¯¹è±¡ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ISO æ ¼å¼å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸è§£æï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>datetime.date&lt;/code>ã€&lt;code>datetime.time&lt;/code>ã€&lt;code>datetime.datetime&lt;/code> ç­‰å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ &lt;code>isoformat()&lt;/code> å®ä¾‹æ–¹æ³•è½¬æ¢ä¸º ISO 8601 æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ISO 8601 æ ¼å¼çš„å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡ &lt;code>fromisoformat()&lt;/code> ç±»æ–¹æ³•ç›´æ¥è½¬æ¢ä¸º&lt;code>datetime.date&lt;/code>ã€&lt;code>datetime.time&lt;/code>ã€&lt;code>datetime.datetime&lt;/code> å¯¹è±¡ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="å›¾è¡¨">å›¾è¡¨&lt;/h3>
&lt;p>ç”¨ä¸€å¼ &lt;a href="http://www.plantuml.com/plantuml/png/hLHDhzCm4BpxLrYFIoALSgzKzCI52pUELVNan4uRYEF8NYFuzzYhr67fAlZ0RJzcnfl9sgy1b8Te9t4VjP63Sz2vds99nR4V5pM3XD6QXBAB4AabNt8khTDnCY_o2NaCu6CFRpaMPjOoSLQYLc08-TsNyNQ7pzwOcUWyWCSSy1sKPpjhiCFJPWBrrsnVmO_pxJ7IfobIVW1FyZ6umNchu2rtYjJb_SVDhfCi9pQj4EVprfAzctyO3_9y5biHoTJ1LMDolPfGw0BXsbPnRfOI24OoWzhlI0ZG2d80jVP4q-FWdIte1aAxmyNfdakC1i4m0xlkst5Zj0SiHEYt6ZgUowQ7F-ocognzHHpYCfc66QQ6HcOgKbIhsg3UsMwSJPCB1pow5MIb_uyI1fmQVXn6pR_Wn0lsavdBU98XTk1L3rBD3kx68sZzVUAPm4oejFvGLBfVKl4IQr0_I25K3uC1Fn2HmWqDu2K-9Vb4BHVbWqbxojxOb9xAuWtexs3XSaYDA_ql1PwF8cYwE5Ku3FQn8gNihIYL1S4fIECcohL5IkNQ4W7au_Mcpp1duxCf6wLyIYarZ3crU0pgE8BqcLKk3-l6Ii1sXqTzmxHUW3UVux-QMKSx_GO0">æ—¶åºå›¾&lt;/a>æ€»ç»“ä¸Šæ–‡å†…å®¹ï¼š&lt;/p>
&lt;p>&lt;img src="datetime-sequence.png" alt="datetime-sequence">&lt;/p>
&lt;ul>
&lt;li>&lt;code>[ts]&lt;/code> è¡¨ç¤ºè¯¥å‚æ•°å…·æœ‰é»˜è®¤å€¼æ˜¯å¯é€‰çš„ã€‚&lt;/li>
&lt;li>è¯·æ³¨æ„åŒºåˆ†å›¾ä¸­çš„å®ä¾‹æ–¹æ³•ã€ç±»æ–¹æ³•ä»¥åŠæ¨¡å—å‡½æ•°ï¼š
&lt;ul>
&lt;li>åç§°ä¸­ä»¥ &lt;code>time.&lt;/code> å¼€å¤´çš„å‡ä¸º &lt;code>time&lt;/code> æ¨¡å—çš„å‡½æ•°&lt;/li>
&lt;li>åç§°ä¸­ä»¥ &lt;code>obj.&lt;/code> å¼€å¤´çš„å‡ä¸º &lt;code>date&lt;/code>ã€&lt;code>time&lt;/code> æˆ– &lt;code>datetime&lt;/code> å¯¹è±¡çš„å®ä¾‹æ–¹æ³•&lt;/li>
&lt;li>å…¶ä½™åç§°çš„å‡½æ•°å‡ä¸ºç±»æ–¹æ³•&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/python/" term="Python" label="Python"/></entry><entry><title type="text">ç†è§£ Python ä¸­çš„æè¿°ç¬¦</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/python-descriptor-in-detail/"/><id>https://waynerv.com/posts/python-descriptor-in-detail/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-04-15T21:32:47+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æè¿°ç¬¦ï¼ˆdescriptorï¼‰æ˜¯ Python ä¸­çš„ä¸€ä¸ªè¿›é˜¶æ¦‚å¿µï¼Œä¹Ÿæ˜¯è®¸å¤š Python å†…éƒ¨æœºåˆ¶çš„å®ç°åŸºç¡€ï¼Œæœ¬æ–‡å°†å¯¹å…¶åšé€‚å½“æ·±å…¥çš„ä»‹ç»ã€‚</summary><content type="html">&lt;p>æè¿°ç¬¦æ˜¯ Python ä¸­çš„ä¸€ä¸ªè¿›é˜¶æ¦‚å¿µï¼Œä¹Ÿæ˜¯è®¸å¤š Python å†…éƒ¨æœºåˆ¶çš„å®ç°åŸºç¡€ï¼Œæœ¬æ–‡å°†å¯¹å…¶åšé€‚å½“æ·±å…¥çš„ä»‹ç»ã€‚&lt;/p>
&lt;h2 id="æè¿°ç¬¦çš„å®šä¹‰">æè¿°ç¬¦çš„å®šä¹‰&lt;/h2>
&lt;p>æè¿°ç¬¦çš„å®šä¹‰å¾ˆç®€å•ï¼Œå®ç°äº†ä¸‹åˆ—&lt;em>ä»»æ„ä¸€ä¸ªæ–¹æ³•&lt;/em>çš„ Python å¯¹è±¡å°±æ˜¯ä¸€ä¸ªæè¿°ç¬¦ï¼ˆdescriptorï¼‰ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>__get__(self, obj, type=None)&lt;/code>&lt;/li>
&lt;li>&lt;code>__set__(self, obj, value)&lt;/code>&lt;/li>
&lt;li>&lt;code>__delete__(self, obj)&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>è¿™äº›æ–¹æ³•çš„å‚æ•°å«ä¹‰å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>self&lt;/code> æ˜¯å½“å‰å®šä¹‰çš„æè¿°ç¬¦å¯¹è±¡å®ä¾‹ã€‚&lt;/li>
&lt;li>&lt;code>obj&lt;/code> æ˜¯è¯¥æè¿°ç¬¦å°†ä½œç”¨çš„å¯¹è±¡å®ä¾‹ã€‚&lt;/li>
&lt;li>&lt;code>type&lt;/code> æ˜¯è¯¥æè¿°ç¬¦ä½œç”¨çš„å¯¹è±¡çš„ç±»å‹ï¼ˆå³æ‰€å±çš„ç±»ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸Šè¿°æ–¹æ³•ä¹Ÿè¢«ç§°ä¸º&lt;em>æè¿°ç¬¦åè®®&lt;/em>ï¼ŒPython ä¼šåœ¨ç‰¹å®šçš„æ—¶æœºæŒ‰åè®®ä¼ å…¥å‚æ•°è°ƒç”¨æŸä¸€æ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬æœªæŒ‰åè®®çº¦å®šçš„å‚æ•°å®šä¹‰æ–¹æ³•ï¼Œè°ƒç”¨å¯èƒ½ä¼šå‡ºé”™ã€‚&lt;/p>
&lt;h2 id="æè¿°ç¬¦çš„ä½œç”¨">æè¿°ç¬¦çš„ä½œç”¨&lt;/h2>
&lt;p>&lt;strong>æè¿°ç¬¦å¯ä»¥ç”¨æ¥æ§åˆ¶å¯¹å±æ€§çš„è®¿é—®è¡Œä¸ºï¼Œå®ç°è®¡ç®—å±æ€§ã€æ‡’åŠ è½½å±æ€§ã€å±æ€§è®¿é—®æ§åˆ¶ç­‰åŠŸèƒ½&lt;/strong>ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Descriptor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;__get__(): Accessing x from the class&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;__get__(): Accessing x from the object&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;X from descriptor&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__set__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;__set__(): Setting x on the object&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">instance&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;_x&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Foo&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Descriptor&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæè¿°ç¬¦å®ä¾‹ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ &lt;code>Foo&lt;/code> ç±»çš„ &lt;code>x&lt;/code> å±æ€§å˜é‡ã€‚ç°åœ¨è®¿é—® &lt;code>Foo.x&lt;/code> ï¼Œä¼šå‘ç° Python è‡ªåŠ¨è°ƒç”¨äº†è¯¥å±æ€§æ‰€ç»‘å®šçš„æè¿°ç¬¦å®ä¾‹çš„ &lt;code>__get__()&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="fm">__get__&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">Accessing&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">the&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="err">&amp;lt;&lt;/span>&lt;span class="nc">class&lt;/span> &lt;span class="s1">&amp;#39;__main__.Foo&amp;#39;&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Descriptor&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x106e138e0&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ &lt;code>foo&lt;/code>ï¼Œå¹¶é€šè¿‡ &lt;code>foo&lt;/code> å¯¹è±¡è®¿é—® &lt;code>x&lt;/code> å±æ€§ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">foo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Foo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="fm">__get__&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">Accessing&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">the&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Foo&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x105dc9340&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">X&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">descriptor&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŒæ ·æ‰§è¡Œäº†æè¿°ç¬¦æ‰€å®šä¹‰çš„ç›¸åº”æ–¹æ³•ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å°è¯•å¯¹ &lt;code>foo&lt;/code> å¯¹è±¡çš„ &lt;code>x&lt;/code> è¿›è¡Œèµ‹å€¼ï¼Œä¹Ÿä¼šè°ƒç”¨æè¿°ç¬¦çš„ &lt;code>__set__()&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="fm">__set__&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">Setting&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="n">on&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Foo&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x105dc9340&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="fm">__get__&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">Accessing&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">the&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Foo&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x105dc9340&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">X&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">descriptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;_x&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŒç†ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æè¿°ç¬¦ä¸­å®šä¹‰äº† &lt;code>__delete__()&lt;/code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†åœ¨æ‰§è¡Œ &lt;code>del foo.x&lt;/code> æ—¶è¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>æè¿°ç¬¦åœ¨å±æ€§æŸ¥æ‰¾è¿‡ç¨‹ä¸­ä¼šè¢« &lt;code>.&lt;/code> ç‚¹æ“ä½œç¬¦è°ƒç”¨ï¼Œä¸”åªæœ‰åœ¨ä½œä¸ºç±»å˜é‡ä½¿ç”¨æ—¶æ‰æœ‰æ•ˆã€‚&lt;/p>
&lt;p>å¦‚æœç›´æ¥èµ‹å€¼ç»™å®ä¾‹å±æ€§ï¼Œæè¿°ç¬¦ä¸ä¼šç”Ÿæ•ˆã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; foo.__dict__[&amp;#39;y&amp;#39;] = Descriptor()
&amp;gt;&amp;gt;&amp;gt; print(foo.y)
&amp;lt;__main__.Descriptor object at 0x100f0d130&amp;gt;
&lt;/code>&lt;/pre>&lt;p>å¦‚æœç”¨ &lt;code>some_class.__dict__[descriptor_name]&lt;/code> çš„æ–¹å¼é—´æ¥è®¿é—®æè¿°ç¬¦ï¼Œä¹Ÿä¸ä¼šè°ƒç”¨æè¿°ç¬¦çš„åè®®æ–¹æ³•ï¼Œè€Œæ˜¯è¿”å›æè¿°ç¬¦å®ä¾‹æœ¬èº«ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>print(Foo.__dict__[&amp;#39;x&amp;#39;])
&amp;lt;__main__.Descriptor object at 0x10b66d8e0&amp;gt;
&lt;/code>&lt;/pre>&lt;h2 id="æè¿°ç¬¦çš„ç±»å‹">æè¿°ç¬¦çš„ç±»å‹&lt;/h2>
&lt;p>æ ¹æ®æ‰€å®ç°çš„åè®®æ–¹æ³•ä¸åŒï¼Œæè¿°ç¬¦åˆå¯åˆ†ä¸ºä¸¤ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>è‹¥å®ç°äº† &lt;code>__set__()&lt;/code> æˆ– &lt;code>__delete__()&lt;/code> ä»»ä¸€æ–¹æ³•ï¼Œè¯¥æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ•°æ®æè¿°ç¬¦ï¼ˆ&lt;code>data descriptor&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>è‹¥ä»…å®ç° &lt;code>__get__()&lt;/code> æ–¹æ³•ï¼Œè¯¥æè¿°ç¬¦æ˜¯ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦ï¼ˆ&lt;code>non-data descriptor&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸¤è€…çš„åœ¨è¡¨ç°è¡Œä¸ºä¸Šå­˜åœ¨å·®å¼‚ï¼š&lt;/p>
&lt;ul>
&lt;li>æ•°æ®æè¿°ç¬¦æ€»æ˜¯ä¼šè¦†ç›–å®ä¾‹å­—å…¸ &lt;code>__dict__&lt;/code> ä¸­çš„å±æ€§ã€‚&lt;/li>
&lt;li>è€Œéæ•°æ®æè¿°å¯èƒ½ä¼šè¢«å®ä¾‹å­—å…¸ &lt;code>__dict__&lt;/code> ä¸­å®šä¹‰çš„å±æ€§æ‰€è¦†ç›–ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­æˆ‘ä»¬å·²ç»å±•ç¤ºæ•°æ®æè¿°ç¬¦çš„æ•ˆæœï¼Œæ¥ä¸‹æ¥å»æ‰ &lt;code>__set__()&lt;/code> æ–¹æ³•å®ç°ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">NonDataDescriptor&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">instance&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;__get__(): Accessing y from the class&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">owner&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;__get__(): Accessing y from the object&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">instance&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;Y from non-data descriptor&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Bar&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">NonDataDescriptor&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">bar&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Bar&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“ &lt;code>bar.__dict__&lt;/code> ä¸å­˜åœ¨é”®ä¸º &lt;code>y&lt;/code> çš„å±æ€§æ—¶ï¼Œè®¿é—® &lt;code>bar.y&lt;/code> å’Œ &lt;code>foo.x&lt;/code> çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Y&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">non&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">data&lt;/span> &lt;span class="n">descriptor&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†å¦‚æœæˆ‘ä»¬ç›´æ¥ä¿®æ”¹ &lt;code>bar&lt;/code> å¯¹è±¡çš„ &lt;code>__dict__&lt;/code>ï¼Œå‘å…¶ä¸­æ·»åŠ  &lt;code>y&lt;/code> å±æ€§ï¼Œåˆ™è¯¥å¯¹è±¡å±æ€§å°†è¦†ç›–åœ¨ &lt;code>Bar&lt;/code> ç±»ä¸­å®šä¹‰çš„ &lt;code>y&lt;/code> æè¿°ç¬¦ï¼Œè®¿é—® &lt;code>bar.y&lt;/code> å°†ä¸å†è°ƒç”¨æè¿°ç¬¦çš„ &lt;code>__get__()&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;y&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€Œåœ¨ä¸Šæ–‡çš„æ•°æ®æè¿°ç¬¦ç¤ºä¾‹ä¸­ï¼Œå³ä½¿æˆ‘ä»¬ä¿®æ”¹ &lt;code>foo.__dict__&lt;/code>ï¼Œå¯¹ &lt;code>x&lt;/code> å±æ€§çš„è®¿é—®å§‹ç»ˆéƒ½ç”±æè¿°ç¬¦æ‰€æ§åˆ¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="s1">&amp;#39;x&amp;#39;&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="fm">__get__&lt;/span>&lt;span class="p">():&lt;/span> &lt;span class="n">Accessing&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="kn">from&lt;/span> &lt;span class="nn">the&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Foo&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x102b40340&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸‹æ–‡ä¸­æˆ‘ä»¬ä¼šä»‹ç»è¿™ä¸¤è€…çš„å·®å¼‚æ˜¯å¦‚ä½•å®ç°çš„ã€‚&lt;/p>
&lt;h2 id="æè¿°ç¬¦çš„å®ç°">æè¿°ç¬¦çš„å®ç°&lt;/h2>
&lt;p>æè¿°ç¬¦æ§åˆ¶å±æ€§è®¿é—®çš„å…³é”®ï¼Œåœ¨äºä»æ‰§è¡Œ &lt;code>foo.x&lt;/code> åˆ° &lt;code>__get()__&lt;/code> æ–¹æ³•è¢«è°ƒç”¨è¿™ä¸­é—´æ‰€å‘ç”Ÿçš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="å¯¹è±¡å±æ€§å¦‚ä½•ä¿å­˜">å¯¹è±¡å±æ€§å¦‚ä½•ä¿å­˜&lt;/h3>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹è±¡çš„å±æ€§ä¿å­˜åœ¨ &lt;code>__dict__&lt;/code> å±æ€§ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>æ ¹æ® Python æ–‡æ¡£ä»‹ç»ï¼Œ&lt;code>object.__dict__&lt;/code> æ˜¯ä¸€ä¸ªå­—å…¸æˆ–å…¶ä»–çš„æ˜ å°„ç±»å‹å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨ä¸€ä¸ªå¯¹è±¡çš„ï¼ˆå¯å†™ï¼‰å±æ€§ã€‚&lt;/li>
&lt;li>é™¤äº†ä¸€äº› Python çš„å†…ç½®å¯¹è±¡ä»¥å¤–ï¼Œå¤§éƒ¨åˆ†è‡ªå®šä¹‰çš„å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª &lt;code>__dict__&lt;/code> å±æ€§ã€‚&lt;/li>
&lt;li>è¿™ä¸ªå±æ€§åŒ…å«äº†æ‰€æœ‰ä¸ºè¯¥å¯¹è±¡å®šä¹‰çš„å±æ€§ï¼Œ&lt;code>__dict__&lt;/code> ä¹Ÿè¢«ç§°ä¸º &lt;code>mappingproxy&lt;/code> å¯¹è±¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä»ä¹‹å‰çš„ç¤ºä¾‹ç»§ç»­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;_x&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“æˆ‘ä»¬è®¿é—® &lt;code>foo.x&lt;/code> ï¼ŒPython æ˜¯å¦‚ä½•åˆ¤æ–­åº”è¯¥è°ƒç”¨æè¿°ç¬¦æ–¹æ³•è¿˜æ˜¯ä» &lt;code>__dict__&lt;/code> ä¸­è·å–å¯¹åº”å€¼çš„å‘¢ï¼Ÿå…¶ä¸­èµ·å…³é”®ä½œç”¨çš„æ˜¯ &lt;code>.&lt;/code> è¿™ä¸ªç‚¹æ“ä½œç¬¦ã€‚&lt;/p>
&lt;h3 id="å¯¹è±¡å±æ€§å¦‚ä½•è®¿é—®">å¯¹è±¡å±æ€§å¦‚ä½•è®¿é—®&lt;/h3>
&lt;p>ç‚¹æ“ä½œç¬¦çš„æŸ¥æ‰¾é€»è¾‘ä½äº &lt;code>object.__getattribute__()&lt;/code> æ–¹æ³•ä¸­ï¼Œæ¯ä¸€æ¬¡å‘å¯¹è±¡æ‰§è¡Œç‚¹æ“ä½œç¬¦éƒ½ä¼šè°ƒç”¨å¯¹è±¡çš„è¯¥æ–¹æ³•ã€‚CPython ä¸­è¯¥æ–¹æ³•ç”± C å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ç­‰ä»· Python ç‰ˆæœ¬ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">object_getattribute&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate PyObject_GenericGetAttr() in Objects/object.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">null&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">object&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">objtype&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">cls_var&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">getattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">objtype&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">descr_get&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">getattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls_var&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;__get__&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">null&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">descr_get&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">null&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls_var&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;__set__&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ow">or&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls_var&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;__delete__&amp;#39;&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">descr_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls_var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">objtype&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># data descriptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;__dict__&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">name&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">vars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">vars&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="c1"># instance variable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">descr_get&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">null&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">descr_get&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">cls_var&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">objtype&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># non-data descriptor&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">cls_var&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">null&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">cls_var&lt;/span> &lt;span class="c1"># class variable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç†è§£ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œå½“æˆ‘ä»¬è®¿é—® &lt;code>object.name&lt;/code> æ—¶ä¼šä¾æ¬¡æ‰§è¡Œä¸‹åˆ—è¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆä» &lt;code>obj&lt;/code> æ‰€å±çš„ç±» &lt;code>objtype&lt;/code> ä¸­æŸ¥æ‰¾ &lt;code>name&lt;/code> å±æ€§ï¼Œå¦‚æœå¯¹åº”çš„ç±»å˜é‡ &lt;code>cls_var&lt;/code> å­˜åœ¨ï¼Œå°è¯•è·å– &lt;code>cls_var&lt;/code> æ‰€å±çš„ç±»çš„ &lt;code>__get__&lt;/code> å±æ€§ã€‚&lt;/li>
&lt;li>å¦‚æœ &lt;code>__get__&lt;/code> å±æ€§å­˜åœ¨ï¼Œå³è¯´æ˜ &lt;code>cls_var&lt;/code> ï¼ˆè‡³å°‘ï¼‰æ˜¯ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦ã€‚æ¥ä¸‹æ¥å°†åˆ¤æ–­è¯¥æè¿°ç¬¦æ˜¯å¦ä¸ºæ•°æ®æè¿°ç¬¦ï¼ˆåˆ¤æ–­æœ‰æ—  &lt;code>__set__&lt;/code> æˆ– &lt;code>__delete__&lt;/code> å±æ€§ï¼‰ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨åœ¨æè¿°ç¬¦ä¸­å®šä¹‰çš„ &lt;code>__get__&lt;/code> æ–¹æ³•ï¼Œå¹¶ä¼ å…¥å½“å‰å¯¹è±¡ &lt;code>obj&lt;/code> å’Œå½“å‰å¯¹è±¡æ‰€å±ç±» &lt;code>objtype&lt;/code> ä½œä¸ºå‚æ•°ï¼Œæœ€åè¿”å›è°ƒç”¨ç»“æœï¼ŒæŸ¥æ‰¾ç»“æŸï¼Œæ•°æ®æè¿°ç¬¦å®Œå…¨è¦†ç›–äº†å¯¹å¯¹è±¡æœ¬èº« &lt;code>__dict__&lt;/code> çš„è®¿é—®ã€‚&lt;/li>
&lt;li>å¦‚æœ &lt;code>cls_var&lt;/code> ä¸ºéæ•°æ®æè¿°ç¬¦ï¼ˆä¹Ÿå¯èƒ½å¹¶éæè¿°ç¬¦ï¼‰ï¼Œæ­¤æ—¶å°†å°è¯•åœ¨å¯¹è±¡çš„å­—å…¸ &lt;code>__dict__&lt;/code> ä¸­æŸ¥æ‰¾ &lt;code>name&lt;/code> å±æ€§ï¼Œè‹¥æœ‰åˆ™è¿”å›è¯¥å±æ€§å¯¹åº”çš„å€¼ã€‚&lt;/li>
&lt;li>å¦‚æœåœ¨ obj çš„ &lt;code>__dict__&lt;/code> ä¸­æœªæ‰¾åˆ° &lt;code>name&lt;/code> å±æ€§ï¼Œä¸” &lt;code>cls_var&lt;/code> ä¸ºéæ•°æ®æè¿°ç¬¦ï¼Œåˆ™è°ƒç”¨åœ¨æè¿°ç¬¦ä¸­å®šä¹‰çš„ &lt;code>__get__&lt;/code> æ–¹æ³•ï¼Œå’Œä¸Šæ–‡ä¸€æ ·ä¼ å…¥ç›¸åº”å‚æ•°å¹¶è¿”å›è°ƒç”¨ç»“æœã€‚&lt;/li>
&lt;li>å¦‚æœ &lt;code>cls_var&lt;/code> ä¸æ˜¯æè¿°ç¬¦ï¼Œåˆ™å°†å…¶ç›´æ¥è¿”å›ã€‚&lt;/li>
&lt;li>å¦‚æœæœ€åè¿˜æ²¡æ‰¾åˆ°ï¼Œå”¤èµ· &lt;code>AttributeError&lt;/code> å¼‚å¸¸ã€‚&lt;/li>
&lt;/ol>
&lt;p>åœ¨ä»¥ä¸Šè¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬ä» &lt;code>obj&lt;/code> æ‰€å±çš„ç±» &lt;code>objtype&lt;/code> ä¸­è·å– &lt;code>name&lt;/code> å±æ€§æ—¶ï¼Œè‹¥ &lt;code>objtype&lt;/code> ä¸­æ²¡æ‰¾åˆ°å°†å°è¯•ä»å…¶æ‰€ç»§æ‰¿çš„çˆ¶ç±»ä¸­æŸ¥æ‰¾ï¼Œå…·ä½“çš„é¡ºåºå–å†³äº &lt;code>cls.__mro__&lt;/code> ç±»æ–¹æ³•çš„è¿”å›ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">Foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__mro__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">class&lt;/span> &lt;span class="err">&amp;#39;&lt;/span>&lt;span class="nc">__main__&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Foo&lt;/span>&lt;span class="s1">&amp;#39;&amp;gt;, &amp;lt;class &amp;#39;&lt;/span>&lt;span class="nb">object&lt;/span>&lt;span class="s1">&amp;#39;&amp;gt;)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ï¼Œ&lt;strong>æè¿°ç¬¦åœ¨ &lt;code>object.__getattribute__()&lt;/code> æ–¹æ³•ä¸­æ ¹æ®ä¸åŒæ¡ä»¶è¢«è°ƒç”¨ï¼Œè¿™å°±æ˜¯æè¿°ç¬¦æ§åˆ¶å±æ€§è®¿é—®çš„å·¥ä½œæœºåˆ¶&lt;/strong>ã€‚å¦‚æœæˆ‘ä»¬é‡è½½ &lt;code>object.__getattribute__()&lt;/code> æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å–æ¶ˆæ‰€æœ‰çš„æè¿°ç¬¦è°ƒç”¨ã€‚&lt;/p>
&lt;h3 id="__getattr__-æ–¹æ³•">&lt;code>__getattr__&lt;/code> æ–¹æ³•&lt;/h3>
&lt;p>å®é™…ä¸Šï¼Œå±æ€§æŸ¥æ‰¾å¹¶ä¸ä¼šç›´æ¥è°ƒç”¨ &lt;code>object.__getattribute__()&lt;/code> ï¼Œç‚¹æ“ä½œç¬¦ä¼šé€šè¿‡ä¸€ä¸ªè¾…åŠ©å‡½æ•°æ¥æ‰§è¡Œå±æ€§æŸ¥æ‰¾ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">getattr_hook&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate slot_tp_getattr_hook() in Objects/typeobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__getattribute__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span> &lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">),&lt;/span> &lt;span class="s1">&amp;#39;__getattr__&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__getattr__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">name&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="c1"># __getattr__&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å› æ­¤ï¼Œå¦‚æœ &lt;code>obj.__getattribute__()&lt;/code> çš„ç»“æœå¼•å‘å¼‚å¸¸ï¼Œä¸”å­˜åœ¨ &lt;code>obj.__getattr__()&lt;/code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†è¢«æ‰§è¡Œã€‚å¦‚æœç”¨æˆ·ç›´æ¥è°ƒç”¨ &lt;code>obj.__getattribute__()&lt;/code>ï¼Œ&lt;code>__getattr__()&lt;/code> çš„è¡¥å……æŸ¥æ‰¾æœºåˆ¶å°±ä¼šè¢«ç»•è¿‡ã€‚&lt;/p>
&lt;p>å‡å¦‚ä¸º &lt;code>Foo&lt;/code> ç±»æ·»åŠ è¯¥æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Foo&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Descriptor&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__getattr__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> is indeed not found&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">foo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">Foo&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶ååˆ†åˆ«è°ƒç”¨ &lt;code>foo.z&lt;/code> å’Œ &lt;code>bar.z&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">foo&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">z&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">z&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="n">indeed&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="n">found&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">z&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;Bar&amp;#39;&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">has&lt;/span> &lt;span class="n">no&lt;/span> &lt;span class="n">attribute&lt;/span> &lt;span class="s1">&amp;#39;z&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥è¡Œä¸ºä»…åœ¨å¯¹è±¡æ‰€å±çš„ç±»å®šä¹‰äº† &lt;code>__getattr__()&lt;/code>æ–¹æ³•æ—¶æ‰ç”Ÿæ•ˆï¼Œåœ¨å¯¹è±¡ä¸­å®šä¹‰ &lt;code>__getattr__&lt;/code> æ–¹æ³•ï¼Œå³åœ¨ &lt;code>obj.__dict__&lt;/code> ä¸­æ·»åŠ è¯¥å±æ€§æ˜¯æ— æ•ˆçš„ï¼Œè¿™ä¸€ç‚¹åŒæ ·é€‚ç”¨äº &lt;code>__getattribute__()&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__getattr__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="k">lambda&lt;/span> &lt;span class="n">item&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="sa">f&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="si">{&lt;/span>&lt;span class="n">item&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s1"> is indeed not found&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__dict__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="s1">&amp;#39;__getattr__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="n">function&lt;/span> &lt;span class="o">&amp;lt;&lt;/span>&lt;span class="k">lambda&lt;/span>&lt;span class="o">&amp;gt;&lt;/span> &lt;span class="n">at&lt;/span> &lt;span class="mh">0x1086e1430&lt;/span>&lt;span class="o">&amp;gt;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">bar&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">z&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s1">&amp;#39;Bar&amp;#39;&lt;/span> &lt;span class="nb">object&lt;/span> &lt;span class="n">has&lt;/span> &lt;span class="n">no&lt;/span> &lt;span class="n">attribute&lt;/span> &lt;span class="s1">&amp;#39;z&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="python-å†…éƒ¨çš„æè¿°ç¬¦">Python å†…éƒ¨çš„æè¿°ç¬¦&lt;/h2>
&lt;p>é™¤äº†ä¸€äº›è‡ªå®šä¹‰çš„åœºæ™¯ï¼ŒPython æœ¬èº«çš„è¯­è¨€æœºåˆ¶ä¸­å°±å¤§é‡ä½¿ç”¨äº†æè¿°ç¬¦ã€‚&lt;/p>
&lt;h3 id="property">property&lt;/h3>
&lt;p>&lt;code>property&lt;/code> çš„å…·ä½“æ•ˆæœæˆ‘ä»¬ä¸å†èµ˜è¿°ï¼Œä¸‹é¢æ˜¯å…¶å¸¸è§çš„è¯­æ³•ç³–ç”¨æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">C&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@property&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">x&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;I&amp;#39;m the &amp;#39;x&amp;#39; property.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">setter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">x&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@x&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">deleter&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">x&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>property&lt;/code> æœ¬èº«æ˜¯ä¸€ä¸ªå®ç°äº†æè¿°ç¬¦åè®®çš„ç±»ï¼Œå®ƒè¿˜å¯ä»¥é€šè¿‡ä»¥ä¸‹ç­‰ä»·æ–¹å¼ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">C&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">None&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">getx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">setx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">value&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">delx&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">del&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">_x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">property&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">getx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">setx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">delx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;I&amp;#39;m the &amp;#39;x&amp;#39; property.&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ä¸Šé¢ä¾‹å­ä¸­ &lt;code>property(getx, setx, delx, &amp;quot;I'm the 'x' property.&amp;quot;)&lt;/code> åˆ›å»ºäº†ä¸€ä¸ªæè¿°ç¬¦å®ä¾‹ï¼Œå¹¶èµ‹å€¼ç»™äº† &lt;code>x&lt;/code>ã€‚&lt;code>property&lt;/code> ç±»çš„å®ç°ä¸ä¸‹é¢çš„ Python ä»£ç ç­‰ä»·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Property&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate PyProperty_Type() in Objects/descrobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fget&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fset&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fdel&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">doc&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fget&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fget&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fset&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fset&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fdel&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fdel&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">doc&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">fget&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="ow">not&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">doc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">fget&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__doc__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__doc__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">doc&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">objtype&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># æè¿°ç¬¦åè®®æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fget&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;unreadable attribute&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fget&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__set__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># æè¿°ç¬¦åè®®æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fset&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;can&amp;#39;t set attribute&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fset&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">value&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__delete__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># æè¿°ç¬¦åè®®æ–¹æ³•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fdel&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">raise&lt;/span> &lt;span class="ne">AttributeError&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;can&amp;#39;t delete attribute&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fdel&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">getter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fget&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># å®ä¾‹åŒ–ä¸€ä¸ªæ‹¥æœ‰ fget å±æ€§çš„æè¿°ç¬¦å¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="n">fget&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fset&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fdel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__doc__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">setter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fset&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># å®ä¾‹åŒ–ä¸€ä¸ªæ‹¥æœ‰ fset å±æ€§çš„æè¿°ç¬¦å¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fget&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fset&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fdel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__doc__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">deleter&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fdel&lt;/span>&lt;span class="p">):&lt;/span> &lt;span class="c1"># å®ä¾‹åŒ–ä¸€ä¸ªæ‹¥æœ‰ fdel å±æ€§çš„æè¿°ç¬¦å¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">)(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fget&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">fset&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">fdel&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__doc__&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>property&lt;/code> åœ¨æè¿°ç¬¦å®ä¾‹çš„å­—å…¸å†…ä¿å­˜è¯»ã€å†™ã€åˆ é™¤å‡½æ•°ï¼Œç„¶ååœ¨åè®®æ–¹æ³•è¢«è°ƒç”¨æ—¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åº”å‡½æ•°ï¼Œå®ç°å¯¹å±æ€§çš„è¯»ã€å†™ä¸åˆ é™¤çš„æ§åˆ¶ã€‚&lt;/p>
&lt;h3 id="å‡½æ•°">å‡½æ•°&lt;/h3>
&lt;p>æ²¡é”™ï¼Œæ¯ä¸€ä¸ªæˆ‘ä»¬å®šä¹‰çš„å‡½æ•°å¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦å®ä¾‹ã€‚&lt;/p>
&lt;p>è¿™é‡Œä½¿ç”¨æè¿°ç¬¦çš„ç›®çš„ï¼Œæ˜¯è®©åœ¨ç±»å®šä¹‰ä¸­æ‰€å®šä¹‰çš„&lt;strong>å‡½æ•°&lt;/strong>åœ¨é€šè¿‡å¯¹è±¡è°ƒç”¨æ—¶æˆä¸º&lt;strong>ç»‘å®šæ–¹æ³•&lt;/strong>ï¼ˆbound methodï¼‰ã€‚&lt;/p>
&lt;p>æ–¹æ³•åœ¨è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨ä¼ å…¥å¯¹è±¡å®ä¾‹ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™æ˜¯æ–¹æ³•å’Œæ™®é€šå‡½æ•°çš„å”¯ä¸€åŒºåˆ«ã€‚é€šå¸¸æˆ‘ä»¬ä¼šåœ¨å®šä¹‰æ–¹æ³•æ—¶ï¼Œå°†è¿™ä¸ªå½¢å‚æŒ‡å®šä¸º &lt;code>self&lt;/code>ã€‚æ–¹æ³•å¯¹è±¡çš„ç±»å®šä¹‰ä¸ä¸‹é¢çš„ä»£ç ç­‰ä»·ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">MethodType&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate PyMethod_Type in Objects/classobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__func__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">func&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__self__&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">obj&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__call__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">func&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__func__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">obj&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__self__&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">args&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">**&lt;/span>&lt;span class="n">kwargs&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®ƒåœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­æ¥æ”¶ä¸€ä¸ªå‡½æ•° &lt;code>func&lt;/code> å’Œä¸€ä¸ªå¯¹è±¡ &lt;code>obj&lt;/code>ï¼Œå¹¶åœ¨è°ƒç”¨æ—¶å°† &lt;code>obj&lt;/code> ä¼ å…¥ &lt;code>func&lt;/code> ä¸­ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="k">class&lt;/span> &lt;span class="nc">D&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span> &lt;span class="k">return&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">D&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">D&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">d&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œå½“é€šè¿‡ç±»å±æ€§è°ƒç”¨ &lt;code>f&lt;/code> æ—¶ï¼Œå…¶è¡Œä¸ºå°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å‡½æ•°ï¼Œå¯ä»¥å°†ä»»æ„å¯¹è±¡ä½œä¸º &lt;code>self&lt;/code> å‚æ•°ä¼ å…¥ï¼›å½“é€šè¿‡å®ä¾‹å±æ€§è®¿é—® &lt;code>f&lt;/code> æ—¶ï¼Œå…¶æ•ˆæœå˜æˆäº†ç»‘å®šæ–¹æ³•è°ƒç”¨ï¼Œå› æ­¤åœ¨è°ƒç”¨æ—¶ä¼šè‡ªåŠ¨å°†ç»‘å®šçš„å¯¹è±¡ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚
æ˜¾ç„¶åœ¨é€šè¿‡å®ä¾‹è®¿é—®å±æ€§æ—¶åˆ›å»ºä¸€ä¸ª &lt;code>MethodType&lt;/code> å¯¹è±¡ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æè¿°ç¬¦å®ç°çš„æ•ˆæœã€‚&lt;/p>
&lt;p>å‡½æ•°çš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">Function&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">objtype&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Simulate func_descr_get() in Objects/funcobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">obj&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">MethodType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ &lt;code>def f()&lt;/code> å®šä¹‰å‡½æ•°æ—¶ï¼Œç­‰ä»·äº&lt;code> f = Function()&lt;/code> ï¼Œå³åˆ›å»ºä¸€ä¸ªéæ•°æ®æè¿°ç¬¦å®ä¾‹å¹¶èµ‹å€¼ç»™ &lt;code>f&lt;/code> å˜é‡ã€‚&lt;/p>
&lt;p>å½“æˆ‘ä»¬é€šè¿‡ç±»æ–¹æ³•è®¿é—®è¯¥å±æ€§æ—¶ï¼Œè°ƒç”¨ &lt;code>__get__()&lt;/code> æ–¹æ³•è¿”å›äº†å‡½æ•°å¯¹è±¡æœ¬èº«ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; D.f
&amp;lt;function D.f at 0x10f1903a0&amp;gt;
&lt;/code>&lt;/pre>&lt;p>å½“æˆ‘ä»¬é€šè¿‡å¯¹è±¡å®ä¾‹è®¿é—®è¯¥å±æ€§æ—¶ï¼Œ è°ƒç”¨ &lt;code>__get__()&lt;/code> æ–¹æ³•åˆ›å»ºä¸€ä¸ªä½¿ç”¨ä»¥ä¸Šå‡½æ•°å’Œå¯¹è±¡æ‰€åˆå§‹åŒ–çš„ &lt;code>MethodType&lt;/code> å¯¹è±¡ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;gt;&amp;gt;&amp;gt; d.f
&amp;lt;bound method D.f of &amp;lt;__main__.D object at 0x10eb6fb50&amp;gt;&amp;gt;
&lt;/code>&lt;/pre>&lt;p>æ¦‚æ‹¬åœ°è¯´ï¼Œå‡½æ•°ä½œä¸ºå¯¹è±¡æœ‰ä¸€ä¸ª &lt;code>__get__()&lt;/code> æ–¹æ³•ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªéæ•°æ®æè¿°ç¬¦å®ä¾‹ï¼Œè¿™æ ·å½“å®ƒä»¬ä½œä¸ºå±æ€§è®¿é—®æ—¶å°±å¯ä»¥è½¬æ¢ä¸ºç»‘å®šæ–¹æ³•ã€‚éæ•°æ®æè¿°ç¬¦å°†é€šè¿‡å®ä¾‹è°ƒç”¨ &lt;code>obj.f(*args)&lt;/code> è½¬æ¢ä¸º &lt;code>f(obj, *args)&lt;/code>ï¼Œé€šè¿‡ç±»è°ƒç”¨ &lt;code>cls.f(*args)&lt;/code> è½¬æ¢æˆ &lt;code>f(*args)&lt;/code>ã€‚&lt;/p>
&lt;h3 id="classmethod">classmethod&lt;/h3>
&lt;p>&lt;code>classmethod&lt;/code> æ˜¯åœ¨å‡½æ•°æè¿°ç¬¦åŸºç¡€ä¸Šå®ç°çš„å˜ç§ï¼Œå…¶ç”¨æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">F&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@classmethod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">cls&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">cls&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="vm">__name__&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">x&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;F&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">F&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;F&amp;#39;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ç­‰ä»· Python å®ç°å¦‚ä¸‹ï¼Œæœ‰äº†ä¸Šé¢çš„é“ºå«ä¼šå¾ˆå®¹æ˜“ç†è§£ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">ClassMethod&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate PyClassMethod_Type() in Objects/funcobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">cls&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="bp">cls&lt;/span> &lt;span class="ow">is&lt;/span> &lt;span class="kc">None&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">cls&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">type&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="nb">hasattr&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s1">&amp;#39;__get__&amp;#39;&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">cls&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">MethodType&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="bp">cls&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>@classmethod&lt;/code> è¿”å›ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦ï¼Œå®ç°äº†å°†é€šè¿‡å®ä¾‹è°ƒç”¨ &lt;code>obj.f(*args)&lt;/code> è½¬æ¢ä¸º &lt;code>f(type(obj), *args)&lt;/code>ï¼Œé€šè¿‡ç±»è°ƒç”¨ &lt;code>cls.f(*args)&lt;/code> è½¬æ¢æˆ &lt;code>f(*args)&lt;/code>ã€‚&lt;/p>
&lt;h3 id="staticmethod">staticmethod&lt;/h3>
&lt;p>&lt;code>staticmethod&lt;/code> å®ç°çš„æ•ˆæœæ˜¯ï¼Œä¸ç®¡æˆ‘ä»¬é€šè¿‡å®ä¾‹è°ƒç”¨è¿˜æ˜¯é€šè¿‡ç±»è°ƒç”¨ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åŸå§‹çš„å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">E&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nd">@staticmethod&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mi">10&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">E&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="n">E&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mi">30&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ç­‰ä»· Python å®ç°å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">class&lt;/span> &lt;span class="nc">StaticMethod&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;Emulate PyStaticMethod_Type() in Objects/funcobject.c&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__init__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">def&lt;/span> &lt;span class="fm">__get__&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="bp">self&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">obj&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">objtype&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">None&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="bp">self&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">f&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è°ƒç”¨ &lt;code>__get__()&lt;/code> æ–¹æ³•æ—¶è¿”å›äº†ä¿å­˜åœ¨ &lt;code>__dict__&lt;/code> ä¸­çš„å‡½æ•°å¯¹è±¡æœ¬èº«ï¼Œå› æ­¤ä¸ä¼šè¿›ä¸€æ­¥è§¦å‘å‡½æ•°çš„æè¿°ç¬¦è¡Œä¸ºã€‚&lt;/p>
&lt;p>&lt;code>@staticmethod&lt;/code> è¿”å›ä¸€ä¸ªéæ•°æ®æè¿°ç¬¦ï¼Œå®ç°äº†å°†é€šè¿‡å®ä¾‹è°ƒç”¨ &lt;code>obj.f(*args)&lt;/code> è½¬æ¢ä¸º &lt;code>f(*args)&lt;/code>ï¼Œé€šè¿‡ç±»è°ƒç”¨ &lt;code>cls.f(*args)&lt;/code> ä¹Ÿè½¬æ¢æˆ &lt;code>f(*args)&lt;/code>ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.python.org/3/howto/descriptor.html">Descriptor HowTo Guide&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/3/reference/datamodel.html#implementing-descriptors">Python Refenrence - Data model - Implementing Descriptors&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://realpython.com/python-descriptors/">Python Descriptors: An Introduction&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.peterlamut.com/2018/11/04/python-attribute-lookup-explained-in-detail/">Python attribute lookup explained in detail&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/python/" term="Python" label="Python"/></entry><entry><title type="text">è‡ªå·±ç¼–è¯‘ä¸€ä¸ªæœ€æ–°ç‰ˆæœ¬çš„ Python3</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/compiling-a-latest-python/"/><id>https://waynerv.com/posts/compiling-a-latest-python/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-04-06T10:15:32+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æœ€è¿‘æƒ³çœ‹çœ‹ Python 3.10 çš„æ¨¡å¼åŒ¹é…æ–°ç‰¹æ€§ï¼Œåˆšå¥½ä¹Ÿäº†è§£äº†ä¸€äº›ç¼–è¯‘ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œäºæ˜¯å°è¯•ä¸‹åœ¨å¹³æ—¶ä½¿ç”¨çš„æµ‹è¯•æœºä¸Šç¼–è¯‘ä¸€ä»½æœ€æ–°çš„ Pythonã€‚ å·¥â€¦â€¦</summary><content type="html">&lt;p>æœ€è¿‘æƒ³çœ‹çœ‹ Python 3.10 çš„æ¨¡å¼åŒ¹é…æ–°ç‰¹æ€§ï¼Œåˆšå¥½ä¹Ÿäº†è§£äº†ä¸€äº›ç¼–è¯‘ç›¸å…³çš„åŸºç¡€çŸ¥è¯†ï¼Œäºæ˜¯å°è¯•ä¸‹åœ¨å¹³æ—¶ä½¿ç”¨çš„æµ‹è¯•æœºä¸Šç¼–è¯‘ä¸€ä»½æœ€æ–°çš„ Pythonã€‚&lt;/p>
&lt;h2 id="å·¥ä½œç¯å¢ƒ">å·¥ä½œç¯å¢ƒ&lt;/h2>
&lt;p>æµ‹è¯•æœºçš„æ“ä½œç³»ç»Ÿæ˜¯ Ubuntu 20.10ï¼Œå·²å®‰è£…æœ‰ &lt;code>gcc&lt;/code> ã€&lt;code>git&lt;/code> ç­‰åŸºç¡€çš„å¼€å‘å·¥å…·ã€‚ç»éªŒè¯ä»¥ä¸‹æ­¥éª¤åŒæ ·é€‚ç”¨äº macOS 11ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">uname -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Linux waynerv-woqutech 5.8.0-48-generic &lt;span class="c1">#54-Ubuntu SMP Fri Mar 19 14:25:20 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä¸‹è½½æºç ">ä¸‹è½½æºç &lt;/h2>
&lt;p>ä» CPython çš„å®˜æ–¹ä»“åº“ &lt;a href="https://github.com/python/cpython">https://github.com/python/cpython&lt;/a> å…‹éš†æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git clone https://github.com/python/cpython.git
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ªä»“åº“çš„æ–‡ä»¶ä½“ç§¯å¾ˆå¤§ï¼Œå¦‚æœå…‹éš†æ—¶é‡åˆ°ç½‘ç»œé—®é¢˜ï¼Œå¯å°è¯•ä½¿ç”¨ Gitee çš„ã€ŒåŒæ­¥ GitHub ä»“åº“ã€åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="é…ç½®">é…ç½®&lt;/h2>
&lt;p>æ ¸å¿ƒçš„ CPython ç¼–è¯‘å™¨åªéœ€è¦ä¸€ä¸ªåŸºæœ¬çš„ C ç¼–è¯‘å™¨å°±å¯ä»¥ç¼–è¯‘ï¼Œä½†ä¸€äº›æ‰©å±•æ¨¡å—ä¼šéœ€è¦å¼€å‘å¤´æ–‡ä»¶æ¥æä¾›ä¸€äº›é¢å¤–çš„åº“ï¼ˆå¦‚å‹ç¼©åŠŸèƒ½éœ€è¦çš„&lt;code>zlib&lt;/code>åº“ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç”¨æ“ä½œç³»ç»Ÿæä¾›çš„åŒ…ç®¡ç†å™¨ï¼ˆå¦‚&lt;code>apt&lt;/code>ï¼‰å®‰è£… Python æ—¶ä¼šéœ€è¦ &lt;code>python3-dev&lt;/code> ç­‰ç­‰ä¸€å¤§å †ä¾èµ–ã€‚&lt;/p>
&lt;p>ç”±äºæˆ‘å¹¶ä¸æ‰“ç®—å°†è‡ªè¡Œç¼–è¯‘çš„ Python ç”¨äºå¼€å‘æˆ–ç”Ÿäº§ï¼Œå› æ­¤å°†è·³è¿‡å®‰è£…ä¾èµ–è¿™ä¸€æ­¥ã€‚&lt;/p>
&lt;p>é¦–å…ˆè¿›å…¥æˆ‘ä»¬æ‰€å…‹éš†çš„ä»“åº“ç›®å½•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> cpython
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åéœ€è¦è¿›è¡Œé…ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./configure --prefix&lt;span class="o">=&lt;/span>/root/build-python
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåç»­çš„ &lt;code>make install&lt;/code> å‘½ä»¤ä¼šå°†ç¼–è¯‘å¾—åˆ°çš„æ–‡ä»¶å®‰è£…åˆ° &lt;code>/usr/local/bin&lt;/code> æˆ– &lt;code>/usr/local/lib&lt;/code>ï¼Œè¿™å¯èƒ½ä¼šè¦†ç›–ç³»ç»Ÿå·²æœ‰çš„å®‰è£…æ–‡ä»¶ï¼Œä¸ºäº†ä¸å’Œç³»ç»Ÿå·²å®‰è£…çš„ Python ç‰ˆæœ¬äº§ç”Ÿå†²çªï¼Œæˆ‘ä»¬é€šè¿‡æŒ‡å®š &lt;code>--prefix&lt;/code> é€‰é¡¹å°†å…¶å®‰è£…åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„ç›®å½•ã€‚&lt;/p>
&lt;h2 id="ç¼–è¯‘">ç¼–è¯‘&lt;/h2>
&lt;p>é…ç½®ç»“æŸåè¿è¡Œç¼–è¯‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make -s -j &lt;span class="m">4&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œç¼–è¯‘æ—¶å¯é€šè¿‡ &lt;code>-j&lt;/code> é€‰é¡¹æŒ‡å®šå¹¶è¡Œçš„ä»»åŠ¡æ•°é‡æ¥åŠ å¿«é€Ÿåº¦ï¼Œé€šå¸¸æˆ‘ä»¬å°†å…¶è®¾ç½®ä¸ºç¼–è¯‘æœºå™¨çš„ CPU æ•°é‡ï¼Œå¯ä»¥ç»“åˆ &lt;code>nproc&lt;/code> å‘½ä»¤ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make -s -j &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>nproc&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>-s&lt;/code> é€‰é¡¹æ„ä¸º &lt;code>silence&lt;/code>ï¼Œå³ä¸æ‰“å°ç¼–è¯‘çš„è¿‡ç¨‹æ—¥å¿—ï¼Œä¹Ÿå¯å¯ç”¨ã€‚&lt;/p>
&lt;p>ç¼–è¯‘çš„è¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒè€—æ—¶ï¼ŒæˆåŠŸåçš„è¾“å‡ºå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Python build finished successfully!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The necessary bits to build these optional modules were not found:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_bz2 _curses _curses_panel
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_dbm _gdbm _hashlib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_lzma _sqlite3 _ssl
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_tkinter _uuid readline
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">To find the necessary bits, look in setup.py in detect_modules&lt;span class="o">()&lt;/span> &lt;span class="k">for&lt;/span> the module&lt;span class="err">&amp;#39;&lt;/span>s name.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The following modules found by detect_modules&lt;span class="o">()&lt;/span> in setup.py, have been
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">built by the Makefile instead, as configured by the Setup files:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">_abc &lt;span class="nb">pwd&lt;/span> &lt;span class="nb">time&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Could not build the ssl module!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Python requires an OpenSSL 1.0.2 or 1.1 compatible libssl with X509_VERIFY_PARAM_set1_host&lt;span class="o">()&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">LibreSSL 2.6.4 and earlier &lt;span class="k">do&lt;/span> not provide the necessary APIs, https://github.com/libressl-portable/portable/issues/381
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”±äºæˆ‘ä»¬æ²¡æœ‰å®‰è£…ä¾èµ–ï¼Œæ‰€ä»¥æç¤ºæœ‰éƒ¨åˆ†æ¨¡å—æœªæ‰¾åˆ°ï¼Œä½†ä¸å½±å“ä½¿ç”¨ Python çš„åŸºæœ¬åŠŸèƒ½ã€‚&lt;/p>
&lt;h2 id="å®‰è£…">å®‰è£…&lt;/h2>
&lt;p>ç¼–è¯‘æˆåŠŸåå…¶å®å·²ç»å¯ä»¥è¿è¡Œ Python äº†ã€‚ä¸Šè¿°æ„å»ºè¿‡ç¨‹ä¼šåœ¨å½“å‰ç›®å½•ï¼ˆé&lt;code>--prefix&lt;/code>æŒ‡å®šçš„ç›®å½•ï¼‰ç”Ÿæˆä¸€ä¸ªåä¸º &lt;code>python&lt;/code> çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆmacOS ä¸‹æ˜¯ &lt;code>python.exe&lt;/code>ï¼‰ï¼Œè¿è¡Œå®ƒå³å¯å¯åŠ¨ Python è§£é‡Šå™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./python
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®ƒä¼šä½¿ç”¨å½“å‰ç›®å½•ä¸­ç¼–è¯‘ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ä½œä¸ºèµ„æºæ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬å°†å…¶å®‰è£…åˆ°åœ¨é…ç½®æ­¥éª¤ä¸­æŒ‡å®šçš„ç›®å½•ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®‰è£…è¿‡ç¨‹ä¼šè¿›è¡Œå¤§é‡çš„èµ„æºå¤åˆ¶ï¼Œå¹¶è°ƒç”¨ Python è§£é‡Šå™¨å°†ä½¿ç”¨ Python å®ç°çš„æ ‡å‡†åº“ç¼–è¯‘ä¸ºå­—èŠ‚ç ï¼ˆ&lt;code>.pyc&lt;/code>ï¼‰ï¼Œæ­¤å¤–é»˜è®¤è¿˜ä¼šå®‰è£… &lt;code>setuptools&lt;/code> å’Œ &lt;code>pip&lt;/code> è¿™ä¸¤ä¸ª Python åŒ…ï¼Œå› æ­¤å½“æˆ‘ä»¬å®‰è£…è¾ƒæ–°ç‰ˆæœ¬çš„ Python ç‰ˆæœ¬æ—¶ï¼ŒåŸºæœ¬ä¸å†éœ€è¦æ‰‹åŠ¨å®‰è£… &lt;code>pip&lt;/code>ã€‚&lt;/p>
&lt;p>å®‰è£…å®Œæˆååˆ‡æ¢åˆ° &lt;code>/root/build-python&lt;/code> ç›®å½•ä¸‹ï¼Œå¹¶æŸ¥çœ‹å…¶ç›®å½•ç»“æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> /root/build-python
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tree -L &lt;span class="m">2&lt;/span> .
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ 2to3 -&amp;gt; 2to3-3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ 2to3-3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ idle3 -&amp;gt; idle3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ idle3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ pip3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ pip3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ pydoc3 -&amp;gt; pydoc3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ pydoc3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ python3 -&amp;gt; python3.10
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ python3.10 &lt;span class="c1"># Python å¯æ‰§è¡Œæ–‡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ python3.10-config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ python3-config -&amp;gt; python3.10-config
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ include
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ python3.10 &lt;span class="c1"># å¤´æ–‡ä»¶ç›®å½•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ libpython3.10.a &lt;span class="c1"># é™æ€åº“æ–‡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ pkgconfig
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ python3.10 &lt;span class="c1"># æ ‡å‡†åº“æ–‡ä»¶åŠ site-packages&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ man
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æ‰§è¡Œ &lt;code>./bin/python3&lt;/code> å³å¯è¿è¡Œæˆ‘ä»¬è‡ªå·±ç¼–è¯‘å®‰è£…å¥½çš„ Pythonï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Python 3.10.0a6+ &lt;span class="o">(&lt;/span>heads/master:80017752ba, Apr &lt;span class="m">6&lt;/span> 2021, 13:47:23&lt;span class="o">)&lt;/span> &lt;span class="o">[&lt;/span>GCC 10.2.0&lt;span class="o">]&lt;/span> on linux
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Type &lt;span class="s2">&amp;#34;help&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;copyright&amp;#34;&lt;/span>, &lt;span class="s2">&amp;#34;credits&amp;#34;&lt;/span> or &lt;span class="s2">&amp;#34;license&amp;#34;&lt;/span> &lt;span class="k">for&lt;/span> more information.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¤§åŠŸå‘Šæˆï¼å¯ä»¥çœ‹åˆ°è¿è¡Œçš„ Python ç‰ˆæœ¬æ˜¯ &lt;code>3.10.0a6+&lt;/code>ï¼Œä¸€ä¸ªå°šæœªå‘å¸ƒçš„å¼€å‘ä¸­ç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬éœ€è¦å…¶ä»–ç¨³å®šç‰ˆæœ¬çš„ Pythonï¼Œåªéœ€è¦åœ¨æºç ä»“åº“ä¸­ &lt;code>git checkout&lt;/code> åˆ°æŒ‡å®šçš„ release æ ‡ç­¾ï¼Œç„¶åå†é‡æ–°è¿è¡Œé…ç½®-ç¼–è¯‘-å®‰è£… 3 ä¸ªæ­¥éª¤å°±å¯ä»¥äº†ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://devguide.python.org/setup/#getting-started">Python Developerâ€™s Guide: Getting Started&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/python/" term="Python" label="Python"/><category scheme="https://waynerv.com/tags/%E7%BC%96%E8%AF%91/" term="ç¼–è¯‘" label="ç¼–è¯‘"/></entry><entry><title type="text">[CSAPP] è®¡ç®—æœºå¦‚ä½•è¡¨ç¤ºæµ®ç‚¹æ•°</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/csapp-ieee-floating-intro/"/><id>https://waynerv.com/posts/csapp-ieee-floating-intro/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-03-29T22:48:53+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">è®¡ç®—æœºæ— æ³•ç²¾ç¡®åœ°è¡¨ç¤ºæ‰€æœ‰å®æ•°ï¼Œæœ¬æ–‡ä½œä¸ºã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹çš„å­¦ä¹ ç¬”è®°ï¼Œå°†ä»‹ç»è®¡ç®—æœºåœ¨åº•å±‚å¦‚ä½•ä½¿ç”¨ IEEE754 æ ‡å‡†æ¥è¡¨ç¤ºæµ®ç‚¹æ•°ã€‚</summary><content type="html">&lt;p>å¦‚æœä½ æ›¾ç»ä½¿ç”¨è¿‡ Python æˆ–è€… JavaScript è¿›è¡Œæµ®ç‚¹æ•°è®¡ç®—ï¼Œå¯èƒ½ä¼šé‡åˆ°ç±»ä¼¼ä¸‹é¢çš„æƒ…å†µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;gt;&amp;gt;&amp;gt;&lt;/span> &lt;span class="mf">0.1&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="mf">0.2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">0.30000000000000004&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶åŸå› æ˜¯ç¨‹åºåœ¨è¿è¡Œæ—¶ï¼Œæ‰€ä½¿ç”¨çš„æµ®ç‚¹æ•°ç±»å‹å¹¶æ²¡æœ‰ç²¾ç¡®åœ°è¡¨ç¤º &lt;code>0.1&lt;/code> å’Œ &lt;code>0.2&lt;/code> ï¼Œè‡ªç„¶ç»“æœä¹Ÿå°±ä¸ç­‰äº &lt;code>0.3&lt;/code>ã€‚å€Ÿç€è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸€ä¸‹è®¡ç®—æœºåœ¨åº•å±‚æ˜¯å¦‚ä½•è¡¨ç¤ºè¿™ç±»æµ®ç‚¹æ•°çš„ã€‚&lt;/p>
&lt;h2 id="è®¡ç®—æœºæ— æ³•ç²¾ç¡®åœ°è¡¨ç¤ºæ‰€æœ‰å®æ•°">è®¡ç®—æœºæ— æ³•ç²¾ç¡®åœ°è¡¨ç¤ºæ‰€æœ‰å®æ•°&lt;/h2>
&lt;p>è¿™æ˜¯ä¸€ä¸ªéœ€è¦æ˜ç¡®çš„å‰æã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è‹¥æƒ³ç²¾ç¡®çš„è¡¨ç¤ºæŸä¸ªé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¿…é¡»æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼šæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ç§ä¸å…¶ä»–å…ƒç´ ä¸åŒçš„è¡¨ç¤ºã€‚è®¡ç®—æœºé€šè¿‡å¤šä¸ªä½çš„ 0 å’Œ 1 æ¥è¡¨ç¤ºä¿¡æ¯ï¼Œè€Œå®æ•°æ˜¯æ— é™çš„ï¼Œè®¡ç®—æœºçš„ç¡¬ä»¶èµ„æºå´æ˜¯æœ‰é™çš„ï¼Œè¿™å°±æ³¨å®šäº†è®¡ç®—æœºæ— æ³•ç²¾ç¡®åœ°è¡¨ç¤ºæ‰€æœ‰å®æ•°ã€‚æœ€ä¼˜è§£æ˜¯æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸€ç§åˆé€‚çš„è¡¨ç¤ºæ–¹æ³•ï¼Œåˆ©ç”¨æœ‰é™çš„ç¡¬ä»¶èµ„æºï¼ˆå°½å¯èƒ½çŸ­çš„ä½æ•°ï¼‰ï¼Œå°½å¯èƒ½ç²¾ç¡®åœ°è¡¨ç¤ºå°½å¯èƒ½å¤§çš„æ•°å€¼èŒƒå›´ã€‚&lt;/p>
&lt;h2 id="äºŒè¿›åˆ¶å°æ•°">äºŒè¿›åˆ¶å°æ•°&lt;/h2>
&lt;p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ç”¨äºŒè¿›åˆ¶æ¥è¡¨ç¤ºå°æ•°å‘¢ï¼Ÿ&lt;/p>
&lt;p>é¦–å…ˆè€ƒè™‘åè¿›åˆ¶æ˜¯å¦‚ä½•ç”¨å°æ•°ç‚¹æ¥è¡¨ç¤ºå°æ•°çš„ï¼š$d_md_{mâˆ’1}...d_1d_0.d_{âˆ’1}d_{âˆ’2}...d_{âˆ’n}$ï¼Œæ¯ä¸€ä½çš„å€¼ $d_i$ å–å€¼èŒƒå›´æ˜¯ 0-9ï¼Œä¸Šè¿°è¡¨ç¤ºæ‰€ä»£è¡¨çš„æ•°å€¼ $d$ ä¸ºï¼š&lt;/p>
&lt;p>$d = \displaystyle\sum_{{ i = -n}}^m 10^i Ã— d_i$&lt;/p>
&lt;p>å°æ•°ç‚¹å·¦è¾¹ç¬¬ m ä½ï¼ˆä» 0 å¼€å§‹ï¼‰å…·æœ‰ $10^m$ çš„åŠ æƒï¼Œå³è¾¹ç¬¬ n ä½ï¼ˆä» 1 å¼€å§‹ï¼‰å…·æœ‰ $10^{-n}$ çš„åŠ æƒã€‚ä¸¾ä¾‹æ¥è¯´ $12.34_{10}$ å³ä»£è¡¨ $1Ã—10^1+2Ã—10^0+3Ã—10_{âˆ’1}+4Ã—10_{âˆ’2}=12\frac{34}{100}$ ã€‚&lt;/p>
&lt;p>åŒæ ·åœ°ï¼Œå¯¹äºŒè¿›åˆ¶è¡¨ç¤ºï¼š$b_mb_{mâˆ’1}...b_1b_0.b_{âˆ’1}b_{âˆ’2}...b_{âˆ’n}$ï¼Œæ¯ä¸€ä½çš„å€¼ $b_i$ çš„å–å€¼èŒƒå›´æ˜¯ 0-1ï¼Œæ‰€ä»£è¡¨çš„æ•°å€¼ $b$ ä¸ºï¼š&lt;/p>
&lt;p>$b = \displaystyle\sum_{{ i = -n}}^m 2^i Ã— b_i$&lt;/p>
&lt;p>å°æ•°ç‚¹å·¦è¾¹ç¬¬ m ä½ï¼ˆä» 0 å¼€å§‹ï¼‰å…·æœ‰ $2^m$ çš„åŠ æƒï¼Œå³è¾¹ç¬¬ n ä½ï¼ˆä» 1 å¼€å§‹ï¼‰å…·æœ‰ $2^{-n}$ çš„åŠ æƒã€‚ä¸¾ä¾‹æ¥è¯´ $101.11_{2}$ å³ä»£è¡¨ $1Ã—2^2+0Ã—2^1+1Ã—2^0+1Ã—2_{âˆ’1}+1Ã—2_{âˆ’2}=5\frac{3}{4}$ ã€‚&lt;/p>
&lt;p>å¦‚åŒåè¿›åˆ¶å°æ•°ç‚¹å·¦ç§»é™¤ä»¥ 10ï¼Œå³ç§»ä¹˜ä»¥ 10 çš„è§„åˆ™ï¼ŒäºŒè¿›åˆ¶å°æ•°ç‚¹ä¹Ÿæœ‰å·¦ç§»é™¤ä»¥ 2ï¼Œå³ç§»ä¹˜ä»¥ 2 çš„è§„åˆ™ã€‚ç”±äºè®¡ç®—æœºåªèƒ½è¿›è¡Œæœ‰é™ä½æ•°çš„ç¼–ç ï¼Œå› æ­¤ä»ä¸Šè¿° b çš„æ±‚å€¼å…¬å¼å¯çŸ¥ï¼Œè¿™ç§æ–¹æ³•åªèƒ½ç²¾ç¡®çš„è¡¨ç¤ºèƒ½å¤Ÿå†™ä½œ $x Ã— 2^y$ çš„å€¼ã€‚&lt;/p>
&lt;h2 id="ieee-754-æµ®ç‚¹æ•°">IEEE 754 æµ®ç‚¹æ•°&lt;/h2>
&lt;p>ç”¨ $b_mb_{mâˆ’1}...b_1b_0.b_{âˆ’1}b_{âˆ’2}...b_{âˆ’n}$ è¿™ç§æ–¹å¼æ¥è¡¨ç¤ºå¾ˆå°çš„æ•°æˆ–è€…å¾ˆå¤§çš„æ•°æ˜¯éå¸¸ä½æ•ˆçš„ï¼Œæ¯”å¦‚è¡¨ç¤º $5 Ã— 2^{500}$ å°±éœ€è¦è‡³å°‘ 100 ä½ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´èªæ˜çš„è¡¨ç¤ºæ–¹å¼ï¼Œæ—¢ç„¶äºŒè¿›åˆ¶èƒ½å¤Ÿè¡¨ç¤ºçš„æ•°å¯ä»¥å½’çº³ä¸º $x Ã— 2^y$ï¼Œæˆ‘ä»¬å¯ä»¥ä»…è¡¨ç¤º $x$ å’Œ $y$ã€‚&lt;/p>
&lt;p>IEEE 754 æµ®ç‚¹æ•°æ ‡å‡†æ˜¯å¦‚ä»Šæœ€æµè¡Œå’Œé€šç”¨çš„æµ®ç‚¹æ•°è¡¨ç¤ºæ ‡å‡†ã€‚å®ƒç”¨ $V = (âˆ’1)^s Ã— M Ã— 2^E$ çš„å½¢å¼æ¥è¡¨ç¤ºä¸€ä¸ªæ•°å­—ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¬¦å·ä½ $s$ å†³å®šè¯¥æ•°å­—æ˜¯æ­£æ•°ï¼ˆ$s=0$ï¼‰è¿˜æ˜¯è´Ÿæ•°ï¼ˆ$s=1$ï¼‰ã€‚æ•°å€¼ 0 æ˜¯ä¸€ç§ç‰¹æ®Šçš„æƒ…å†µï¼Œæˆ‘ä»¬ä¼šåœ¨ä¹‹åè§£é‡Šã€‚&lt;/li>
&lt;li>æœ‰æ•ˆæ•° $M$ æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å°æ•°ï¼Œå®ƒçš„å–å€¼èŒƒå›´ä¸º 1 å’Œæ— é™è¶‹è¿‘äº 2 ä¹‹é—´ï¼Œæˆ–è€…ä¸º 0 å’Œæ— é™è¶‹è¿‘äº 1 ä¹‹é—´ã€‚å…·ä½“å¤„äºå“ªä¸ªå–å€¼èŒƒå›´ç”±æŒ‡æ•°éƒ¨åˆ†çš„æ¯”ç‰¹ä½æ˜¯å¦å…¨éƒ¨ä¸º 0 æ¥å†³å®šã€‚&lt;/li>
&lt;li>æŒ‡æ•° $E$ å¯èƒ½ä¸ºæ­£æ•°ä¹Ÿå¯èƒ½ä¸ºè´Ÿæ•°ï¼Œé€šè¿‡ 2 çš„æŒ‡æ•°å¹‚å¯¹æœ€ç»ˆè¡¨ç¤ºçš„æµ®ç‚¹æ•°è¿›è¡ŒåŠ æƒã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;img src="2021-03-30-floating-fields.png" alt="">&lt;/p>
&lt;p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ IEEE æµ®ç‚¹æ•°æ˜¯å¦‚ä½•åœ¨è®¡ç®—æœºä¸­å·¥ä½œçš„ã€‚IEEE æµ®ç‚¹æ•°åœ¨è®¡ç®—æœºä¸­æœ€å¸¸è§çš„å®é™…è¡¨ç¤ºåˆ†åˆ«æ˜¯ 32 ä½ï¼ˆå•ç²¾åº¦ï¼‰å’Œ 64 ä½ï¼ˆåŒç²¾åº¦ï¼‰ï¼Œå…¶åŒ…å«çš„æ¯”ç‰¹ä½å¯ä»¥åˆ’åˆ†ä¸º 3 éƒ¨åˆ†ï¼ˆå¦‚ä¸Šå›¾ï¼‰ï¼š&lt;/p>
&lt;ul>
&lt;li>æœ€å·¦è¾¹çš„å•ä¸ªæ¯”ç‰¹ä½ s ä»£è¡¨ç¬¦å·ä½ $s$ çš„å€¼ã€‚&lt;/li>
&lt;li>ç”± k ä¸ªæ¯”ç‰¹ä½æ„æˆçš„æŒ‡æ•°éƒ¨åˆ† &lt;strong>exp&lt;/strong> $= e_{k-1}...e_1e_0$ å¯¹æŒ‡æ•° $E$ è¿›è¡Œç¼–ç ã€‚&lt;/li>
&lt;li>ç”± n ä¸ªæ¯”ç‰¹ä½æ„æˆçš„å°æ•°éƒ¨åˆ† &lt;strong>frac&lt;/strong> $= f_{n-1}...f_1f_0$ å¯¹æœ‰æ•ˆæ•° $M$ è¿›è¡Œç¼–ç ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨å•ç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºä¸­ï¼Œs ä¸º 1 ä½ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º 8 ä½ï¼ˆk=8ï¼‰ï¼Œå°æ•°éƒ¨åˆ†ä¸º 23 ä½ï¼ˆn=23ï¼‰ï¼Œæ€»å…± 32 ä½ã€‚&lt;/p>
&lt;p>åœ¨åŒç²¾åº¦æµ®ç‚¹æ•°è¡¨ç¤ºä¸­ï¼Œs ä¸º 1 ä½ï¼ŒæŒ‡æ•°éƒ¨åˆ†ä¸º 11 ä½ï¼ˆk=11ï¼‰ï¼Œå°æ•°éƒ¨åˆ†ä¸º 52 ä½ï¼ˆn=52ï¼‰ï¼Œæ€»å…± 64 ä½ã€‚&lt;/p>
&lt;p>å–å†³äºæŒ‡æ•°éƒ¨åˆ†çš„æ¯”ç‰¹ä½çš„å€¼ï¼Œé€šè¿‡ä»¥ä¸Šè¡¨ç¤ºç¼–ç å¾—åˆ°çš„å€¼å¯åˆ†ä¸ºä¸‹é¢ 3 ç§æƒ…å†µã€‚&lt;/p>
&lt;p>&lt;img src="2021-03-30-floating-3-cases.png" alt="">&lt;/p>
&lt;h3 id="è§„èŒƒåŒ–çš„å€¼normalized">è§„èŒƒåŒ–çš„å€¼ï¼ˆNormalizedï¼‰&lt;/h3>
&lt;p>è§„èŒƒåŒ–çš„å€¼æ˜¯æœ€å¸¸è§çš„æƒ…å†µï¼Œå‘ç”Ÿåœ¨å½“æŒ‡æ•°ï¼ˆexpï¼‰éƒ¨åˆ†çš„æ¯”ç‰¹ä½æ—¢éå…¨éƒ¨éƒ½æ˜¯ 0ï¼Œä¹Ÿéå…¨éƒ¨éƒ½æ˜¯ 1 æ—¶ï¼Œå³å…¶æ•´æ•°è¡¨ç¤º $0 &amp;lt; exp &amp;lt; 255$ æ—¶ã€‚&lt;/p>
&lt;p>è¿™æ—¶æŒ‡æ•°éƒ¨åˆ†ä¼šè¢«è§£é‡Šä¸ºä¸€ä¸ªåç½®å½¢å¼çš„æœ‰ç¬¦å·æ•´æ•° $E$ï¼Œè®¡ç®—æ–¹å¼ä¸º $E = e - Bias$ï¼Œå…¶ä¸­ $e$ æ˜¯ç”±æŒ‡æ•°éƒ¨åˆ†æ‰€æœ‰æ¯”ç‰¹ä½ $e_{k-1}...e_1e_0$ è¡¨ç¤ºçš„æœ‰ç¬¦å·æ•´æ•°ï¼Œè€Œ $Bias$ æ˜¯ä¸€ä¸ªå–å†³äºæŒ‡æ•°éƒ¨åˆ†æ¯”ç‰¹ä½é•¿åº¦ k çš„å¸¸æ•° $2^{k-1}-1$ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ä¸º 127ï¼Œ åŒç²¾åº¦æµ®ç‚¹æ•°ä¸º 1023ï¼‰ï¼Œå› æ­¤æŒ‡æ•° $E$ çš„å–å€¼èŒƒå›´ä¸º -126 åˆ° 127ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ï¼‰æˆ–è€… -1022 åˆ° 1023ï¼ˆåŒç²¾åº¦æµ®ç‚¹æ•°ï¼‰ã€‚&lt;/p>
&lt;p>å°æ•°éƒ¨åˆ†ä¼šè¢«è§£é‡Šä¸ºä¸€ä¸ªå°æ•°å€¼ $f$ï¼Œ$f$ çš„å–å€¼èŒƒå›´ä¸º $0 &amp;lt;= f &amp;lt; 1$ï¼Œå…¶äºŒè¿›åˆ¶è¡¨ç¤ºä¸º $0.f_{n-1}...f_1f_0$ã€‚æˆ‘ä»¬é»˜è®¤å…¶å°æ•°ç‚¹ä½äºæœ€å·¦è¾¹ï¼Œå°æ•°éƒ¨åˆ†çš„æ¯”ç‰¹ä½å‡è¡¨ç¤ºå°æ•°ç‚¹å³è¾¹çš„å€¼ã€‚è€Œæœ‰æ•ˆæ•° $M = 1 + f$ï¼Œæ­¤æ—¶ $M$ å¯çœ‹ä½œäºŒè¿›åˆ¶è¡¨ç¤ºä¸º $1.f_{n-1}...f_1f_0$ï¼Œå…¶å–å€¼èŒƒå›´ä¸º $1 &amp;lt;= M &amp;lt; 2$ã€‚è¿™é‡Œçš„ä¸€ä¸ªæŠ€å·§æ˜¯ï¼Œæˆ‘ä»¬å¯¹å°æ•°ç‚¹å·¦è¾¹çš„ä¸€ä½å–å›ºå®šå€¼ï¼ˆ0 æˆ– 1ï¼‰ï¼Œå› æ­¤ä¸éœ€è¦ç”¨æ¯”ç‰¹ä½æ˜¾å¼åœ°å»è¡¨ç¤ºå®ƒï¼Œä»è€Œå¤šäº‰å–åˆ°äº†ä¸€ä¸ªæ¯”ç‰¹ä½æ¥è¡¨ç¤ºå°æ•°éƒ¨åˆ†ï¼Œè¿›ä¸€æ­¥æ‰©å¤§äº†å°æ•°éƒ¨åˆ†çš„è¡¨ç¤ºèŒƒå›´å’Œç²¾åº¦ã€‚&lt;/p>
&lt;h3 id="éè§„èŒƒåŒ–çš„å€¼denormalized">éè§„èŒƒåŒ–çš„å€¼ï¼ˆDenormalizedï¼‰&lt;/h3>
&lt;p>å½“ exp éƒ¨åˆ†çš„æ¯”ç‰¹ä½å…¨éƒ¨éƒ½æ˜¯ 0 æ—¶ï¼Œæˆ‘ä»¬ç§°æ­¤æ—¶æµ®ç‚¹æ•°è¡¨ç¤ºçš„æ•°å€¼å½¢å¼ä¸ºéè§„èŒƒåŒ–çš„å€¼ã€‚&lt;/p>
&lt;p>è¿™ç§æƒ…å†µä¸‹ï¼ŒæŒ‡æ•° $E = 1 - Bias$ï¼Œ$E$ æˆä¸ºäº†ä¸€ä¸ªå¸¸æ•°ï¼Œå•ç²¾åº¦æ ¼å¼ä¸‹ä¸º -126ï¼ŒåŒç²¾åº¦æ ¼å¼ä¸‹ä¸º -1022ï¼›æœ‰æ•ˆæ•° $M = f$ï¼Œå³ä¸å†éšå¼åœ°åœ¨æœ€å·¦è¾¹æ·»åŠ ä¸€ä¸ªå€¼ä¸º 1 çš„æ¯”ç‰¹ä½ï¼Œå…¶å–å€¼èŒƒå›´ä¹Ÿå˜ä¸º $0 &amp;lt;= M &amp;lt; 1$ã€‚&lt;/p>
&lt;p>éè§„èŒƒåŒ–è¡¨ç¤ºæœ‰ä¸¤ä¸ªç›®çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸€æ˜¯ä¸ºäº†è¡¨ç¤º 0ï¼Œç”±äºè§„èŒƒåŒ–å€¼ä¸­ $1 &amp;lt;= M &amp;lt; 2$ï¼Œå› æ­¤ä¸ç®¡æŒ‡æ•°éƒ¨åˆ†å–ä»€ä¹ˆå€¼ï¼Œæ‰€è¡¨ç¤ºçš„æ•°å­— $V$ éƒ½ä¸å¯èƒ½ä¸º 0ã€‚è€Œåœ¨éè§„èŒƒåŒ–å€¼ä¸­ $0 &amp;lt;= M &amp;lt; 1$ï¼Œå½“ M çš„å€¼ä¸º 0 æ—¶ï¼Œæ‰€è¡¨ç¤ºçš„æ•°å­— $V$ ä¹Ÿä¸º 0ï¼Œæ­¤æ—¶æŒ‡æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†çš„æ‰€æœ‰æ¯”ç‰¹ä½å‡ä¸º 0ã€‚åœ¨ IEEE æ ‡å‡†ä¸­ï¼Œå–å†³äºæ­¤æ—¶ç¬¦å·ä½ $s$ çš„å€¼ï¼Œ0 ä¹Ÿæœ‰æ­£è´Ÿç¬¦å·ã€‚å½“ $s=0$ æ—¶ï¼Œç”¨æ¥è¡¨ç¤ºè¯¥æµ®ç‚¹æ•°çš„æ‰€æœ‰æ¯”ç‰¹ä½å…¨éƒ¨ä¸º 0ï¼Œ $V = +0.0$ï¼›å½“ $s=1$ æ—¶ï¼Œ$V = -0.0$ã€‚åœ¨ IEEE æ ‡å‡†ä¸­ï¼Œ +0.0 å’Œ -0.0 åœ¨æŸäº›åœºæ™¯ä¸‹æ˜¯ä¸åŒçš„ã€‚&lt;/li>
&lt;li>äºŒæ˜¯ä¸ºäº†è¡¨ç¤ºéå¸¸è¶‹è¿‘äº 0 çš„æ•°ã€‚ç›¸æ¯”è§„èŒƒåŒ–å€¼ï¼Œéè§„èŒƒåŒ–è¡¨ç¤ºèƒ½å¤Ÿè¡¨ç¤ºæ›´åŠ æ¥è¿‘äº 0 çš„æ•°å­—ï¼Œä¸”åœ¨è¡¨ç¤ºçš„å€¼éå¸¸è¶‹è¿‘äº 0 æ—¶ï¼Œè¿™äº›å€¼çš„åˆ†å¸ƒèƒ½ä¿æŒç›¸å¯¹å‡åŒ€ï¼Œè¿™ç§èƒ½åŠ›ä¹Ÿå«ã€Œæ¸è¿›ä¸‹æº¢ã€ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ç‰¹æ®Šå€¼special">ç‰¹æ®Šå€¼ï¼ˆSpecialï¼‰&lt;/h3>
&lt;p>æœ€åä¸€ç§æƒ…å†µæ˜¯å½“ exp éƒ¨åˆ†çš„æ¯”ç‰¹ä½å…¨éƒ¨éƒ½æ˜¯ 1 æ—¶ã€‚&lt;/p>
&lt;p>è‹¥å°æ•°éƒ¨åˆ†çš„æ¯”ç‰¹ä½ä¹Ÿå…¨éƒ¨æ˜¯ 0ï¼Œå…¶è¡¨ç¤ºçš„å€¼ $V$ ä»£è¡¨æ— é™å¤§ï¼šå½“ $s=0$ æ—¶ï¼Œ $v = + âˆ$ï¼›å½“ $s=1$ æ—¶ï¼Œ $V = -âˆ$ã€‚æ— é™å¤§å¯ä»¥ç”¨æ¥è¡¨ç¤ºå°†ä¼šæº¢å‡ºçš„è®¡ç®—ç»“æœï¼Œå¦‚å°†ä¸¤ä¸ªæå¤§çš„æ•°ç›¸ä¹˜ï¼Œæˆ–è€…é™¤ä»¥0æ—¶ã€‚&lt;/p>
&lt;p>è‹¥å°æ•°éƒ¨åˆ†çš„æ¯”ç‰¹ä½ä¸å…¨ä¸º 0ï¼Œå…¶è¡¨ç¤ºçš„å€¼ $V$ ä»£è¡¨ &lt;code>NaN&lt;/code>ï¼ˆ&lt;strong>N&lt;/strong>ot &lt;strong>a&lt;/strong> &lt;strong>N&lt;/strong>umberï¼‰ã€‚è¿™ç§å€¼é€šå¸¸ç”¨æ¥ä½œä¸ºæŸäº›è®¡ç®—ç»“æœä¸æ˜¯çœŸå®æ•°å­—æˆ–è€…æ— é™å¤§çš„æ“ä½œçš„è¿”å›å€¼ï¼Œå¦‚ $\sqrt{-1}$ æˆ–è€… $âˆ - âˆ$ã€‚åœ¨æŸäº›åº”ç”¨ä¸­è¿˜ä¼šç”¨æ¥è¡¨ç¤ºå°šæœªåˆå§‹åŒ–çš„æ•°æ®ã€‚&lt;/p>
&lt;h3 id="ç¤ºä¾‹">ç¤ºä¾‹&lt;/h3>
&lt;p>æˆ‘ä»¬å‡å®šä¸€ä¸ª 8 ä½çš„æµ®ç‚¹æ•°è¡¨ç¤ºä½œä¸ºç¤ºä¾‹ï¼Œå…¶æŒ‡æ•°éƒ¨åˆ†é•¿åº¦ä¸º 4ï¼Œå°æ•°éƒ¨åˆ†é•¿åº¦ä¸º 3ï¼Œåç½®å€¼ä¸º 7ï¼Œå³ $k=4$ï¼Œ$n=3$ï¼Œ$Bias=7$ã€‚å…¶æŒ‡æ•°ï¼ˆExponentï¼‰ä»¥åŠå°æ•°ï¼ˆFractionï¼‰ç­‰å„ä¸ªéƒ¨åˆ†çš„å€¼ä»¥åŠæ‰€è¡¨ç¤ºçš„åè¿›åˆ¶å€¼å¦‚ä¸‹å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="2021-03-30-floating-examples.png" alt="">&lt;/p>
&lt;p>ä»ä¸­æˆ‘ä»¬å¯ä»¥å‘ç° IEEE æµ®ç‚¹æ•°çš„ä¸€äº›è§„å¾‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è™½ç„¶ä½¿ç”¨äº†ä¸åŒçš„è®¡ç®—æ–¹å¼ï¼Œä½†éè§„èŒƒåŒ–å€¼å¯ä»¥å¹³æ»‘åœ°è¿‡æ¸¡åˆ°è§„èŒƒåŒ–å€¼ï¼Œå¦‚ä¸Šæœ€å¤§çš„éè§„èŒƒåŒ–å€¼ä¸º $\frac{7}{512}$ï¼Œè€Œæœ€å°çš„è§„èŒƒåŒ–å€¼ä¸º $\frac{8}{512}$ã€‚&lt;/li>
&lt;li>éšç€æµ®ç‚¹æ•°çš„é€’å¢ï¼Œå…¶æ¯”ç‰¹ä½è¡¨ç¤ºæ‰€è§£é‡Šåœ°æ— ç¬¦å·æ•´æ•°ä¹Ÿéšä¹‹é€’å¢ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨ç›¸å¯¹ç®€å•çš„æ— ç¬¦å·æ•´æ•°çš„æ’åºè§„åˆ™æ¥å¯¹æµ®ç‚¹æ•°è¿›è¡Œæ’åºï¼Œè¿™å¹¶éå·§åˆï¼Œè€Œæ˜¯æœ‰æ„è®¾è®¡çš„ã€‚&lt;/li>
&lt;/ol></content><category scheme="https://waynerv.com/categories/%E7%AC%94%E8%AE%B0%E6%80%BB%E7%BB%93/" term="ç¬”è®°æ€»ç»“" label="ç¬”è®°æ€»ç»“"/><category scheme="https://waynerv.com/tags/csapp/" term="CSAPP" label="CSAPP"/></entry><entry><title type="text">æ·±å…¥ç†è§£ git cherry-pick æ“ä½œ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/git-cherry-pick-intro/"/><id>https://waynerv.com/posts/git-cherry-pick-intro/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-01-26T16:49:50+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">åœ¨å‰é¢å‡ ç¯‡è®²è§£ Git è¿›é˜¶ç”¨æ³•çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† Git çš„å·¥ä½œåŸç†ï¼Œä»¥åŠ rebaseï¼Œmergeï¼Œcheckoutï¼Œ reset ç­‰å¤šç§æ“ä½œçš„ä½¿ç”¨â€¦â€¦</summary><content type="html">&lt;p>åœ¨å‰é¢å‡ ç¯‡è®²è§£ Git è¿›é˜¶ç”¨æ³•çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº† Git çš„å·¥ä½œåŸç†ï¼Œä»¥åŠ &lt;code>rebase&lt;/code>ï¼Œ&lt;code>merge&lt;/code>ï¼Œ&lt;code>checkout&lt;/code>ï¼Œ &lt;code>reset&lt;/code> ç­‰å¤šç§æ“ä½œçš„ä½¿ç”¨åœºæ™¯å’Œç”¨æ³•ï¼ŒåŸºæœ¬ä¸Šåœ¨ä½¿ç”¨ Git æ—¶ä½ å·²ç»å¯ä»¥æ— æ‰€ç•æƒ§äº†ï¼Œä½ å¯ä»¥è‡ªå¦‚çš„ä¿®æ”¹æäº¤å†å²ï¼Œå¹¶ä¿è¯ä¸ä¼šä¸¢å¤±ä»»ä½•æ›´æ”¹ã€‚ä»Šå¤©æˆ‘ä»¬æ¥è¡¥ä¸Šæœ€åä¸€ç¯ï¼Œäº†è§£ä½¿ç”¨åœºæ™¯ä¸å¤šä½†å´èƒ½è¾¾åˆ°å¥‡æ•ˆçš„ &lt;code>cherry-pick&lt;/code> å‘½ä»¤ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•ä½¿ç”¨-git-cherry-pick">å¦‚ä½•ä½¿ç”¨ git cherry-pick&lt;/h2>
&lt;p>Git å‘½ä»¤æ–‡æ¡£çš„æè¿°ä¸ä¸€å®šç›´è§‚æ˜“æ‡‚ï¼Œä½†ç»å¯¹å‡†ç¡®ï¼Œæ–‡æ¡£å¯¹ &lt;code>git cherry-pick&lt;/code> æè¿°æ˜¯ï¼š &lt;code>Apply the changes introduced by some existing commits&lt;/code>ï¼Œå³åº”ç”¨æŸäº›å·²æœ‰æäº¤æ‰€å¼•å…¥çš„æ›´æ”¹ã€‚é€šå¸¸æˆ‘ä»¬ä¼šè¯´ &lt;code>cherry-pick&lt;/code> æ˜¯å°†æŸä¸ªï¼ˆäº›ï¼‰æäº¤ä»ä¸€ä¸ªåˆ†æ”¯ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œè¿™ç§è¯´æ³•æ›´åŠ å®¹æ˜“ç†è§£ï¼Œä½†åé¢æˆ‘ä»¬ä¼šè§£é‡Šä¸ºä½•æ–‡æ¡£çš„æè¿°æ‰æ˜¯æœ€å‡†ç¡®çš„ã€‚&lt;/p>
&lt;p>å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹æäº¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-jsx" data-lang="jsx">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">a&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="nx">master&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">\&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="nx">feature&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬æƒ³æŠŠ &lt;code>e&lt;/code> å’Œ &lt;code>f&lt;/code> ä¸¤ä¸ªæäº¤ç§»åŠ¨åˆ° &lt;code>master&lt;/code> åˆ†æ”¯ï¼Œé¦–å…ˆéœ€è¦åˆ‡æ¢åˆ° &lt;code>master&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>cherry-pick&lt;/code> å‘½ä»¤çš„ç”¨æ³•ç®€å•æ˜äº†ï¼Œå¯¹éœ€è¦ç§»åŠ¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªæäº¤æ‰§è¡Œ &lt;code>cherry-pick&lt;/code> å³å¯ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬ç”¨å­—æ¯æŒ‡ä»£å®é™…çš„æäº¤ &lt;code>SHA-1&lt;/code> IDï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git cherry-pick f g
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œåçš„æäº¤å†å²å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-jsx" data-lang="jsx">&lt;span class="line">&lt;span class="cl">&lt;span class="nx">a&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">b&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">c&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">d&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">f&lt;/span>&lt;span class="s1">&amp;#39; - g&amp;#39;&lt;/span> &lt;span class="nx">master&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">\&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nx">e&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">f&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="nx">g&lt;/span> &lt;span class="nx">feature&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®é™…çš„ç»“æœæ˜¯åœ¨ &lt;code>master&lt;/code> åˆ†æ”¯åˆ›å»ºäº† &lt;code>f'&lt;/code> å’Œ &lt;code>g'&lt;/code> ä¸¤ä¸ªæ–°çš„æäº¤ï¼Œå®ƒä»¬æ‹¥æœ‰å’Œ &lt;code>f&lt;/code> ã€&lt;code>g&lt;/code> ä¸åŒçš„ ID ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯&lt;/h2>
&lt;p>ä»ä¸Šé¢çš„å‘½ä»¤è§£é‡Šæ¥çœ‹ï¼Œ&lt;code>cherry-pick&lt;/code> å®ç°çš„æ•ˆæœæ¯”è¾ƒç®€å•ï¼Œè€Œä¸”å’Œ &lt;code>merge&lt;/code>ã€&lt;code>rebase&lt;/code> çœ‹ä¸Šå»æœ‰æ‰€é‡åˆï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ &lt;code>cherry-pick&lt;/code> çš„å®é™…ä½¿ç”¨åœºæ™¯ã€‚&lt;/p>
&lt;h3 id="ç´§æ€¥-bug-ä¿®å¤">ç´§æ€¥ bug ä¿®å¤&lt;/h3>
&lt;p>é€šå¸¸åœ¨ä¸€ä¸ªäº§å“çš„ Git å·¥ä½œæµä¸­ï¼Œä¼šæœ‰è‡³å°‘ä¸€ä¸ªå‘å¸ƒåˆ†æ”¯å’Œå¼€å‘ä¸»åˆ†æ”¯ã€‚å½“å‘ç°ä¸€ä¸ª bug æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°½å¿«å‘å·²å‘å¸ƒçš„äº§å“æä¾›ä¿®å¤è¡¥ä¸ï¼ŒåŒæ—¶ä¹Ÿè¦å°†è¡¥ä¸æ•´åˆåˆ°å¼€å‘ä¸»åˆ†æ”¯ä¸­ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬å‘å¸ƒäº†ä¸€ä¸ªç‰ˆæœ¬å¹¶å·²ç»å¼€å§‹å¼€å‘ä¸€äº›æ–°çš„åŠŸèƒ½ï¼Œåœ¨æ–°åŠŸèƒ½å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆå‘ç°äº†ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ bugã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç´§æ€¥ä¿®å¤æäº¤å¯¹è¿™ä¸ªé”™è¯¯è¿›è¡Œä¿®å¤ï¼Œå¹¶åœ¨å¼€å‘ä¸»åˆ†æ”¯è¿›è¡Œé›†æˆæµ‹è¯•ã€‚è¿™ä¸ªæ–°çš„è¡¥ä¸æäº¤åœ¨åˆå…¥å¼€å‘ä¸»åˆ†æ”¯åå¯ä»¥ç›´æ¥ &lt;code>cherry-pick&lt;/code> åˆ°å‘å¸ƒåˆ†æ”¯ï¼Œåœ¨å½±å“æ›´å¤šç”¨æˆ·ä¹‹å‰ä¿®å¤è¿™ä¸ª bugã€‚è¿‡ç¨‹ç¤ºæ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="Jan-26-2021-git-cherry-pick.gif" alt="Jan-26-2021-git-cherry-pick">&lt;/p>
&lt;p>åœ¨ä¸Šé¢çš„åŠ¨å›¾ä¸­ï¼Œæˆ‘ä»¬åœ¨å¼€å‘ä¸»åˆ†æ”¯ &lt;code>master&lt;/code> æ·»åŠ äº†ä¸€äº›æ–°çš„åŠŸèƒ½æäº¤ï¼Œä¿®å¤äº†ä¸€äº› bug å¹¶åˆå…¥äº†ä¸¤ä¸ª &lt;code>bugfix&lt;/code> åˆ†æ”¯ï¼Œç„¶ååˆå°† &lt;code>bugfix&lt;/code> åˆ†æ”¯ä¸­çš„æ‰€æœ‰æäº¤ &lt;code>cherry-pick&lt;/code> åˆ°äº† &lt;code>release&lt;/code> åˆ†æ”¯ã€‚åœ¨æœ‰äº› Git å·¥ä½œæµä¸­æƒ…å†µä¼šæœ‰æ‰€ä¸åŒï¼Œå¯èƒ½ä¼šåŸºäº &lt;code>release&lt;/code> åˆ†æ”¯åˆ›å»º &lt;code>bugfix&lt;/code> åˆ†æ”¯ï¼Œå¹¶åœ¨åˆå…¥ &lt;code>release&lt;/code> å &lt;code>cherry-pick&lt;/code> è¿™äº›æäº¤åˆ° &lt;code>master&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä»æ”¾å¼ƒçš„åˆ†æ”¯ä¸­æŒ‘å‡ºä¸ªåˆ«æäº¤">ä»æ”¾å¼ƒçš„åˆ†æ”¯ä¸­æŒ‘å‡ºä¸ªåˆ«æäº¤&lt;/h3>
&lt;p>æœ‰æ—¶å› ä¸ºéœ€æ±‚çš„å˜åŒ–ä¸€ä¸ªåŠŸèƒ½åˆ†æ”¯å¯èƒ½ä¼šè¿‡æ—¶ï¼Œè€Œä¸ä¼šè¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¸­ã€‚æœ‰æ—¶ï¼Œä¸€ä¸ª &lt;code>Pull Request&lt;/code> å¯èƒ½ä¼šåœ¨æ²¡æœ‰åˆå¹¶çš„æƒ…å†µä¸‹è¢«å…³é—­ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>git log&lt;/code> å’Œ &lt;code>git reflog&lt;/code> ç­‰å‘½ä»¤ï¼Œä»ä¸­æ‰¾å‡ºä¸€äº›æœ‰ç”¨çš„æäº¤ï¼Œå¹¶æŠŠå®ƒä»¬ &lt;code>cherry-pick&lt;/code> åˆ°ä¸»åˆ†æ”¯ã€‚&lt;/p>
&lt;h3 id="å…¶ä»–åœºæ™¯">å…¶ä»–åœºæ™¯&lt;/h3>
&lt;p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ä½¿ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ä½ åœ¨æ²¡æœ‰æ„è¯†åˆ°çš„æƒ…å†µä¸‹åœ¨ä¸€ä¸ªé”™è¯¯çš„åˆ†æ”¯ä¸Šåˆ›å»ºäº†ä¸€ä¸ªæäº¤ï¼Œä½ å¯ä»¥ä½¿ç”¨ &lt;code>cherry-pick&lt;/code> å°†å…¶ç§»åŠ¨åˆ°æ­£ç¡®çš„åˆ†æ”¯ä¸Šå»ï¼›æˆ–è€…å‡ºäºæŸäº›åŸå› ä½ æƒ³å°†å›¢é˜Ÿæˆå‘˜åœ¨å¦ä¸€ä¸ªåˆ†æ”¯å¼€å‘çš„æŸä¸ªæäº¤æ‹¿åˆ°ä½ è‡ªå·±çš„åˆ†æ”¯ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚&lt;/p>
&lt;p>ä»ä»¥ä¸Šæœ‰é™çš„åœºæ™¯æ¥çœ‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ &lt;code>rebase&lt;/code> æˆ–è€… &lt;code>merge&lt;/code> é…åˆ &lt;code>reset&lt;/code> ç­‰å‘½ä»¤ä¹Ÿèƒ½å®ç°åŒæ ·çš„æ•ˆæœï¼Œä½†æ˜¯ &lt;code>cherry-pick&lt;/code> çš„ä¼˜åŠ¿åœ¨äºå®ƒè¶³å¤Ÿåœ°ç®€å•ç›´æ¥ï¼Œä¸€æ¡å‘½ä»¤å°±èƒ½å®ç°åŸæœ¬éœ€è¦ä¸€ç³»åˆ—å‘½ä»¤æ¥å®ç°çš„æ“ä½œã€‚ä½†æˆ‘ä»¬ä¾ç„¶éœ€è¦è°¨æ…çš„ä½¿ç”¨ &lt;code>cherry-pick&lt;/code> ï¼Œå¹¶æ„è¯†åˆ°å®ƒçš„ä¸€äº›å±é™©ä¹‹å¤„ã€‚&lt;/p>
&lt;h2 id="æ·±å…¥ç†è§£-cherry-pick">æ·±å…¥ç†è§£ &lt;code>cherry-pick&lt;/code>&lt;/h2>
&lt;p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåˆšåˆšé€šè¿‡æäº¤ A æ·»åŠ äº† &lt;code>main.py&lt;/code> çš„ä»£ç ä»“åº“ï¼Œ&lt;code>main.py&lt;/code> çš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ &lt;code>new-feature&lt;/code> åˆ†æ”¯è¿›è¡Œåç»­çš„ä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout -b new-feature
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæäº¤ Bï¼ŒåŠ å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶ &lt;code>setup.py&lt;/code> å¹¶å¯¹ &lt;code>main.py&lt;/code> åšå¦‚ä¸‹ä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Git is easy&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ç€æˆ‘ä»¬åˆåˆ›å»ºäº†ä¸€ä¸ªæäº¤ Cï¼ŒåŠ å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶ &lt;code>README.md&lt;/code> å¹¶ç»§ç»­å¯¹ &lt;code>main.py&lt;/code> æ·»åŠ ä¸€è¡Œä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="vm">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;Git is easy&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;But sometimes it can be difficult&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€åæˆ‘ä»¬å†åˆ‡æ¢å›ä¸€å¼€å§‹çš„ &lt;code>master&lt;/code> ï¼Œå¹¶å¯¹ &lt;code>new-feature&lt;/code> çš„æœ€æ–°æäº¤ C æ‰§è¡Œ &lt;code>cherry-pick&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git cherry-pick new-feature
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¿‡ç¨‹å¾ˆç®€å•ï¼Œå¦‚ä¸‹ç¤ºæ„ï¼š&lt;/p>
&lt;p>&lt;img src="Jan-26-2021-git-cherry-pick2.gif" alt="Jan-26-2021-git-cherry-pick2">&lt;/p>
&lt;p>ä½†ç°åœ¨æˆ‘ä»¬æ¥çŒœä¸€çŒœï¼Œç°åœ¨çš„ &lt;code>master&lt;/code> æœ‰å‡ ä¸ªæ–‡ä»¶ï¼Ÿ &lt;code>main.py&lt;/code> ä¼šæœ‰å‡ è¡Œ &lt;code>print&lt;/code> è¯­å¥ï¼Ÿ&lt;/p>
&lt;p>æ­£ç¡®çš„ç­”æ¡ˆæ˜¯ï¼šæˆ‘ä»¬ä¼šé­é‡åˆå¹¶å†²çª ğŸ˜ã€‚åœ¨è§£å†³å†²çªåï¼Œæˆ‘ä»¬ä¼šæ‹¥æœ‰ä¸€ä¸ªä¿®æ”¹è¿‡çš„ &lt;code>main.py&lt;/code> æ–‡ä»¶ï¼Œä»¥åŠåœ¨æäº¤ C ä¸­æ–°æ·»åŠ çš„ &lt;code>README.md&lt;/code> æ–‡ä»¶ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆç»“æœä¼šæ˜¯è¿™æ ·ï¼Ÿå€Ÿæ­¤ç¤ºä¾‹ï¼Œæˆ‘ä»¬æ¥æ·±å…¥æ¢ç©¶ä¸€ç•ª &lt;code>cherry-pick&lt;/code> å®é™…çš„æ‰§è¡Œè¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="åº”ç”¨å“ªäº›æ›´æ”¹">åº”ç”¨å“ªäº›æ›´æ”¹&lt;/h3>
&lt;p>åœ¨ &lt;a href="https://www.waynerv.com/posts/git-undo-intro/#%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2">Git æ’¤é”€æ“ä½œæµ…æ&lt;/a>ä¸­æˆ‘ä»¬äº†è§£åˆ°æ¯ä¸€ä¸ªæäº¤éƒ½æ˜¯ä¸€ä»½å®Œæ•´çš„æ–‡ä»¶å¿«ç…§ï¼Œä½†ä»ç¤ºä¾‹æ¥çœ‹ï¼Œ&lt;code>cherry-pick&lt;/code> çš„è¿‡ç¨‹æ˜¾ç„¶å¹¶æ²¡æœ‰åº”ç”¨ç›®æ ‡æäº¤ä¸­çš„æ‰€æœ‰æ–‡ä»¶å†…å®¹ï¼ˆå¦åˆ™å½“å‰ &lt;code>master&lt;/code> å°†åŒ…å«åœ¨æäº¤ B ä¸­åŠ å…¥çš„ &lt;code>setup.py&lt;/code> æ–‡ä»¶ï¼‰ï¼Œè€Œæ˜¯ä»…ä»…å½±å“äº†ç›®æ ‡æäº¤ä¸­æ›´æ”¹è¿‡çš„æ–‡ä»¶ï¼ˆ &lt;code>README.md&lt;/code> å’Œ &lt;code>main.py&lt;/code> ï¼‰ã€‚ç”±æ­¤å¯è§ï¼Œã€Œå°†æŸä¸ªæäº¤ä»ä¸€ä¸ªåˆ†æ”¯ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ã€è¿™ä¸€è¯´æ³•å¹¶ä¸å‡†ç¡®ï¼Œ &lt;code>cherry-pick&lt;/code> åªä¼šåº”ç”¨åœ¨ç›®æ ‡æäº¤ä¸­å¼•å…¥çš„æ›´æ”¹ï¼Œå³åœ¨è¯¥æäº¤ä¸­æ›´æ”¹è¿‡çš„æ–‡ä»¶ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•åº”ç”¨">å¦‚ä½•åº”ç”¨&lt;/h3>
&lt;p>åœ¨ç¡®å®šäº† &lt;code>cherry-pick&lt;/code> åªä¼šåº”ç”¨ç›®æ ‡æäº¤ä¸­æ›´æ”¹è¿‡çš„æ–‡ä»¶åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹åº”ç”¨æ›´æ”¹çš„å…·ä½“è¿‡ç¨‹ã€‚ã€Œåº”ç”¨ã€åœ¨å†…éƒ¨å…¶å®å°±æ˜¯åƒ &lt;code>merge&lt;/code> ä¸€æ ·æ‰§è¡Œäº†ä¸€æ¬¡ä¸‰è·¯åˆå¹¶ã€‚å…³äº Git çš„ä¸‰è·¯åˆå¹¶ç®—æ³•æˆ‘ä»¬åœ¨ &lt;a href="https://www.waynerv.com/posts/git-merge-intro/#%E9%80%92%E5%BD%92%E4%B8%89%E8%B7%AF%E5%90%88%E5%B9%B6%E7%AE%97%E6%B3%95">Git åˆå¹¶æ“ä½œæµ…æ&lt;/a>ä¸­å·²æœ‰è¯¦ç»†ä»‹ç»ã€‚è¿™æ¬¡æˆ‘ä»¬æ¢ä¸€ç§æ–¹å¼æ¥è¡¨ç¤ºä¸‰è·¯åˆå¹¶ä¸­çš„å„æ–¹ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ &lt;code>git cherry-pick &amp;lt;commit C&amp;gt;&lt;/code> æ—¶ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>LOCAL&lt;/strong>ï¼šåœ¨è¯¥æäº¤åŸºç¡€ä¸Šæ‰§è¡Œåˆå¹¶ï¼ˆå³å½“å‰æ‰€åœ¨åˆ†æ”¯çš„ HEADï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>REMOTE&lt;/strong>ï¼šä½ æ­£åœ¨ &lt;code>cherry-pick&lt;/code> çš„ç›®æ ‡æäº¤ï¼ˆå³ &lt;code>&amp;lt;commit C&amp;gt;&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>BASE&lt;/strong>ï¼šä½ è¦ &lt;code>cherry-pick&lt;/code> çš„æäº¤çš„çˆ¶æäº¤ï¼ˆå³ C^ï¼ŒC çš„ä¸Šä¸€æ¬¡æäº¤ï¼‰ï¼Œé€šå¸¸ä¸º LOCAL å’Œ REMOTE çš„å…±åŒç¥–å…ˆæäº¤ï¼ˆä½†ä¹Ÿå¯èƒ½ä¸æ˜¯ï¼Œæ¯”å¦‚åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ‰§è¡Œ &lt;code>cherry-pick&lt;/code> æ—¶ï¼Œå°±æ˜¯ä»¥ BASE ä½œä¸ºåŸºç¡€ï¼Œä»¥ LOCAL å’Œ REMOTE ä½œä¸ºè¦åˆå¹¶çš„å†…å®¹è¿›è¡Œä¸‰è·¯åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶çš„ç»“æœä½œä¸ºä¸€ä¸ªæ–°çš„æäº¤æ·»åŠ åˆ° LOCAL ä¹‹åï¼ˆç®—æ³•æ‰§è¡Œçš„å…·ä½“è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡ŒéªŒè¯ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é¦–å…ˆå°†ç¤ºä¾‹ä»“åº“ Git çš„ &lt;code>merge.conflictstyle&lt;/code> æ›´æ”¹ä¸º &lt;code>diff3&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git config merge.conflictstyle diff3
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç„¶åé‡æ–°æ‰§è¡Œä¸Šé¢çš„ç¤ºä¾‹æ­¥éª¤ï¼Œå¹¶æŸ¥çœ‹å‘ç”Ÿåˆå¹¶å†²çªçš„ &lt;code>main.py&lt;/code> çš„æ–‡ä»¶å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="nv">__name__&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="s1">&amp;#39;__main__&amp;#39;&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> print&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;Hello world&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&lt;/span>&amp;lt; HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">||||||&lt;/span>&lt;span class="p">|&lt;/span> parent of 77b3860 &lt;span class="o">(&lt;/span>C&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> print&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;Git is easy&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> print&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;Git is easy&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> print&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;But sometimes it can be difficult&amp;#39;&lt;/span>&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; 77b3860 &lt;span class="o">(&lt;/span>C&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç›¸æ¯”å¸¸è§„çš„ &lt;code>diff&lt;/code> å±•ç¤ºçš„ LOCAL å’Œ REMOTE ä¸¤æ–¹å¯¹æ¯”ï¼Œ&lt;code>diff3&lt;/code> ä¼šé€šè¿‡ &lt;code>|||||||&lt;/code> å¤šå±•ç¤ºä¸€æ–¹æ¥è‡ª BASE çš„å†…å®¹ã€‚ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥ç¡®è®¤ï¼ŒBASE æ­£æ˜¯æäº¤ C çš„çˆ¶æäº¤ï¼ˆå³æäº¤ Bï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="å¤„ç†å†²çª">å¤„ç†å†²çª&lt;/h3>
&lt;p>&lt;code>cherry-pick&lt;/code> å‡ºç°å†²çªæ—¶çš„å¤„ç†æ–¹å¼ä¸ &lt;code>rebase&lt;/code> å’Œ &lt;code>merge&lt;/code> ä¸€è‡´ï¼Œæˆ‘ä»¬é€šè¿‡ &lt;code>git status&lt;/code> æŸ¥çœ‹å‘ç”Ÿå†²çªçš„æ–‡ä»¶ï¼Œä¿®æ”¹è¿™äº›æ–‡ä»¶å¹¶åˆ é™¤å…¶ä¸­çš„ç‰¹æ®Šæ ‡è®°ï¼Œé€šè¿‡ &lt;code>git add&lt;/code> å°†å…¶æ ‡è®°ä¸ºå†²çªå·²è§£å†³ï¼Œæœ€å &lt;code>git commit&lt;/code> æäº¤æ›´æ”¹ã€‚&lt;/p>
&lt;p>åœ¨è§£å†³å†²çªè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è§£å†³æ‰€æœ‰å†²çªåæ‰§è¡Œ &lt;code>git cherry-pick --continue&lt;/code> æäº¤æ‰€æœ‰å†…å®¹ï¼Œä½¿ç”¨ &lt;code>git cherry-pick --skip&lt;/code> åœ¨å¤„ç†å¤šä¸ªæäº¤æ—¶è·³è¿‡æ­¤æäº¤ï¼Œæˆ–ä½¿ç”¨ &lt;code>git cherry-pick --abort&lt;/code> å–æ¶ˆ &lt;code>cherry-pick&lt;/code> æ“ä½œï¼Œæ¢å¤åˆ°æ‰§è¡Œæ“ä½œä¹‹å‰çš„çŠ¶æ€ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>&lt;code>git cherry-pick&lt;/code> çš„ç”¨é€”å¹¶ä¸å¹¿æ³›ï¼Œåœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¼šå¾ˆæœ‰ç”¨ï¼Œä½†ç”±äºå…¶åˆå¹¶æœºåˆ¶æœ‰å¼•å…¥æ„æƒ³ä¸åˆ°çš„æ–‡ä»¶æ›´æ”¹çš„é£é™©ï¼Œåœ¨ä½¿ç”¨æ—¶æˆ‘ä»¬åº”è¯¥è°¨æ…è€ƒè™‘å¯èƒ½å‘ç”Ÿçš„ç»“æœã€‚&lt;/p>
&lt;p>&lt;code>cherry-pick&lt;/code> è¿˜æœ‰ä¸¤ä¸ªå®¹æ˜“äº§ç”Ÿçš„è¯¯è§£éœ€è¦æ¾„æ¸…ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>cherry-pick&lt;/code> å¹¶ä¸ä¼šåº”ç”¨æäº¤æ‰€ä»£è¡¨çš„æ•´ä¸ªæ–‡ä»¶å¿«ç…§ï¼Œè€Œæ˜¯åªä¼šå½±å“è¯¥åœ¨æäº¤ä¸­æ–°å¢ã€åˆ é™¤æˆ–æ›´æ”¹çš„æ–‡ä»¶ã€‚&lt;/li>
&lt;li>&lt;code>cherry-pick&lt;/code> å¹¶ä¸æ˜¯ç®€å•çš„åº”ç”¨ç›®æ ‡æäº¤ä¸å…¶çˆ¶æäº¤çš„ &lt;code>diff&lt;/code> å†…å®¹ï¼Œè€Œæ˜¯ä¼šåœ¨å†…éƒ¨ä»¥è¯¥çˆ¶æäº¤ä½œä¸ºåŸºç¡€åœ¨å½“å‰åˆ†æ”¯æŒ‡å‘æäº¤å’Œç›®æ ‡æäº¤ä¹‹é—´è¿›è¡Œä¸€æ¬¡ä¸‰è·¯åˆå¹¶ï¼Œå› æ­¤æœ‰å¯èƒ½å‘ç”Ÿåˆå¹¶å†²çªã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://git-scm.com/docs/git-cherry-pick">git-cherry-pick-documentation&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.atlassian.com/git/tutorials/cherry-pick">Git Cherry Pick Tutorial&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://think-like-a-git.net/sections/rebase-from-the-ground-up/cherry-picking-explained.html">CHERRY-PICKING EXPLAINED&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/52932137/10224392">what does git cherry-pick {commit-hash} do?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/10058070/10224392">In a Git cherry-pick or rebase merge conflict, how are BASE (aka â€œthe ancestorâ€), LOCAL, and REMOTE determined?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/questions/27417656/should-diff3-be-default-conflictstyle-on-git">Should diff3 be default conflictstyle on git?&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/git/" term="Git" label="Git"/></entry><entry><title type="text">git å·¥ä½œåŸç†ä¸æ’¤é”€æ“ä½œå›¾è§£</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/git-undo-intro/"/><id>https://waynerv.com/posts/git-undo-intro/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-01-09T12:53:49+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">ç»å¤§éƒ¨åˆ†ç¨‹åºå‘˜ä¸€å®šæœç´¢è¿‡ã€Œå¦‚ä½•æ’¤é”€ git æäº¤ã€ï¼Œ&lt;code>git checkout&lt;/code>ã€&lt;code>git reset&lt;/code> æˆ– &lt;code>git revert&lt;/code> æ˜¯æš‚æ—¶çš„ç­”æ¡ˆï¼ŒæŒæ¡ä¸€å®šçš„ git å·¥ä½œåŸç†æ‰èƒ½ä¸€åŠ³æ°¸é€¸åœ°è§£å†³ç±»ä¼¼é—®é¢˜ã€‚</summary><content type="html">&lt;p>ã€Œå¦‚ä½•æ’¤é”€ git æäº¤ã€æ˜¯ç»å¤§éƒ¨åˆ†ç¨‹åºå‘˜ä¸€å®šæœç´¢è¿‡çš„é—®é¢˜ï¼Œå°±ç®—ä½ å¯ä»¥ç”¨æŸä¸ªç­”æ¡ˆä¸­çš„å‘½ä»¤æš‚æ—¶è¿‡å…³ï¼Œå†æ¬¡é‡åˆ°ç±»ä¼¼é—®é¢˜æ—¶åˆå¯èƒ½ä¸€å¤´é›¾æ°´ï¼šä¸ºä»€ä¹ˆè¿™æ¬¡æœåˆ°çš„å‘½ä»¤ä¸ä¸€æ ·ï¼Ÿ&lt;code>git checkout&lt;/code>ã€&lt;code>git reset&lt;/code>ã€&lt;code>git revert&lt;/code> è¿™äº›å‘½ä»¤æˆ‘åˆ°åº•è¯¥ç”¨å“ªä¸ªï¼Ÿ&lt;/p>
&lt;p>ä¹‹æ‰€ä»¥è¿™æ ·ï¼Œæ˜¯å› ä¸ºä½ çš„éœ€æ±‚å¹¶ä¸èƒ½ç®€å•åœ°æè¿°ä¸ºã€Œæ’¤é”€ã€æŸæ¬¡æäº¤ï¼Œè€Œå¯èƒ½æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æˆ‘åœ¨æœ¬åœ°ä¿®æ”¹äº†ä¸€äº›æ–‡ä»¶è¿˜æœªæäº¤ï¼Œä½†æˆ‘æƒ³æ”¾å¼ƒæŸäº›æ–‡ä»¶çš„æ›´æ”¹ã€‚&lt;/li>
&lt;li>æˆ‘ä¸å°å¿ƒ &lt;code>git add&lt;/code> äº†é”™è¯¯çš„æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä¸æƒ³æŠŠå®ƒå’Œå…¶ä»–æ–‡ä»¶ä¸€èµ·æäº¤äº†ã€‚&lt;/li>
&lt;li>æˆ‘åˆšåˆšæ‰§è¡Œçš„æäº¤æ·»åŠ äº†ä¸è¯¥æäº¤çš„æ–‡ä»¶ï¼Œæˆ‘æƒ³å–æ¶ˆè¿™æ¬¡æäº¤ï¼Œä½†ä¿ç•™ï¼ˆæˆ–ä¸ä¿ç•™ï¼‰å¯¹æœ¬åœ°æ–‡ä»¶æ‰€ä½œçš„ä¿®æ”¹ã€‚&lt;/li>
&lt;li>æˆ‘ä¸å°å¿ƒåœ¨ä¸€ä¸ªæäº¤ä¸­å¼•å…¥äº† Bug å¹¶ä¸”è¿˜æ¨é€åˆ°äº†è¿œç¨‹åˆ†æ”¯ï¼Œç°åœ¨æƒ³å›æ»šåˆ°åŸæ¥çš„çŠ¶æ€ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¯¹äºå„ç§å¤æ‚çš„æƒ…å½¢ï¼ŒGit éƒ½æä¾›äº†å¯¹åº”çš„æ–¹æ¡ˆæ¥è§£å†³ï¼Œä½†ç”±äºå‘½ä»¤å¾ˆå¤šä¸”åŒä¸€å‘½ä»¤è¿˜æœ‰å¾ˆå¤šé€‰é¡¹ï¼Œæƒ³è¦è®°ä½å®ƒä»¬ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚ä»¥ &lt;code>reset&lt;/code> ã€ &lt;code>checkout&lt;/code> ä¸ºä¾‹ï¼Œåœ¨æ·»åŠ ä¸åŒé€‰é¡¹å¹¶å¯¹ä¸åŒå‚æ•°æ‰§è¡Œåï¼Œå°±èƒ½å®ç° 6 ç§ä¸åŒä½†åˆå¾ˆå¸¸ç”¨çš„æ•ˆæœã€‚&lt;/p>
&lt;p>å¯¹äºå¤æ‚çš„é—®é¢˜ï¼Œæˆ‘ä»¬åº”è¯¥å°è¯•å»äº†è§£å…¶èƒŒåçš„æœ¬è´¨ã€‚å¸¦ç€è¿™ç§æƒ³æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ‰§è¡Œè¿™äº›æ“ä½œæ—¶ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œå¸Œæœ›ä½ åœ¨é˜…è¯»æœ¬æ–‡åï¼Œèƒ½å¤Ÿå¯¹ Git çš„æ’¤é”€æ“ä½œè¿ç”¨è‡ªå¦‚ï¼Œè§£å†³å¤§éƒ¨åˆ†ä¸æ’¤é”€ç›¸å…³çš„å®é™…é—®é¢˜ï¼ˆå®é™…ä¸Šæœ¬æ–‡è¿˜éç³»ç»Ÿåœ°ä»‹ç»äº† Git çš„å†…éƒ¨å¯¹è±¡å’Œå·¥ä½œåŸç†ï¼‰ã€‚&lt;/p>
&lt;h2 id="git-ä¸­çš„æ’¤é”€">Git ä¸­çš„æ’¤é”€&lt;/h2>
&lt;p>é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼ŒGit ä¸­å¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šä¼ ç»Ÿæ–‡æœ¬å¤„ç†è½¯ä»¶éƒ½ä¼šæä¾›çš„ &lt;code>undo&lt;/code> ï¼ˆæ’¤é”€ï¼‰åŠŸèƒ½ï¼ŒGit æœ¬èº«ä¹Ÿä¸æ˜¯ä¸€ä¸ªæ–‡æœ¬å¤„ç†è½¯ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªå†…å®¹å¯»å€æ–‡ä»¶ç³»ç»Ÿï¼Œä½ æ‰€æäº¤çš„æ›´æ”¹éƒ½ä¼šè¢«ä¿å­˜åˆ°ç³»ç»Ÿä¸­ã€‚è™½ç„¶ä¸èƒ½ &lt;code>undo&lt;/code> ï¼Œä½†å®ƒå°±åƒæ—¶å…‰æœºä¸€æ ·ï¼Œå¯ä»¥å°†ä¿å­˜çš„æ–‡ä»¶æ¢å¤åˆ°è¿‡å»çš„æŸä¸ªçŠ¶æ€ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼ŒGit åŒæ—¶ç®¡ç†ç€ä¸‰é¢—ä¸åŒçš„ã€Œæ ‘ã€çš„çŠ¶æ€ï¼Œå½“æˆ‘ä»¬è®¨è®ºã€Œæ’¤é”€ã€è¿™ä¸ªæ“ä½œæ—¶ï¼Œé™¤äº†é€‰æ‹©éœ€è¦æ¢å¤åˆ°çš„æ—¶é—´ç‚¹ï¼Œè¿˜éœ€è¦æ˜ç¡®æƒ³æ›´æ”¹å“ªå‡ é¢—æ ‘ã€‚&lt;/p>
&lt;p>å–å†³äºä½ æƒ³æ“ä½œçš„æ ‘ï¼Œä½ éœ€è¦ç”¨åˆ° &lt;code>checkout&lt;/code> ã€&lt;code>reset&lt;/code>ã€&lt;code>revert&lt;/code> ç­‰ä¸åŒçš„å‘½ä»¤ã€‚å› æ­¤åœ¨äº†è§£å…·ä½“çš„å‘½ä»¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹è¿™ä¸‰æ£µæ ‘ã€‚&lt;/p>
&lt;h2 id="git-çš„ä¸‰æ£µæ ‘">Git çš„ä¸‰æ£µæ ‘&lt;/h2>
&lt;p>è¿™ä¸‰æ£µæ ‘åˆ†åˆ«æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>å·¥ä½œåŒºï¼ˆWorking Directoryï¼‰&lt;/li>
&lt;li>æš‚å­˜åŒºï¼ˆStaging Indexï¼‰&lt;/li>
&lt;li>æäº¤å†å²ï¼ˆCommit Historyï¼‰&lt;/li>
&lt;/ul>
&lt;p>è™½ç„¶æˆ‘ä»¬ç”¨æ ‘æ¥å½¢å®¹å®ƒä»¬ï¼Œä½†éœ€è¦å…ˆæ˜ç¡®çš„ä¸€ç‚¹æ˜¯ï¼Œæ ‘å¹¶ä¸ä»£è¡¨å®ƒä»¬çœŸå®çš„æ•°æ®ç»“æ„ã€‚ã€Œæ ‘ã€åœ¨è¿™é‡Œçš„å®é™…æ„æ€æ˜¯ã€Œæ–‡ä»¶çš„é›†åˆã€ï¼Œè€Œä¸æ˜¯æŒ‡ç‰¹å®šçš„æ•°æ®ç»“æ„ã€‚åœ¨æ–‡ä¸­æˆ‘ä»¬ä¸ä¼šå»æ·±å…¥æ¢ç©¶å®ƒä»¬çš„åº•å±‚å®ç°ï¼Œè€Œæ˜¯é‡ç‚¹äº†è§£å®ƒä»¬çš„æ¦‚å¿µåŠç›¸äº’å…³ç³»ã€‚&lt;/p>
&lt;h3 id="å·¥ä½œåŒº">å·¥ä½œåŒº&lt;/h3>
&lt;p>å·¥ä½œåŒºå³å­˜æ”¾å½“å‰æ“ä½œæ–‡ä»¶çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿç›®å½•ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥æŠŠå®ƒå½“æˆä¸€ä¸ªæ²™ç›’ï¼Œåœ¨å…¶ä¸­éšæ„åœ°æ·»åŠ æˆ–ç¼–è¾‘æ–‡ä»¶ï¼Œç„¶åå†å°†ä¿®æ”¹åçš„æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºå¹¶è®°å½•åˆ°æäº¤å†å²ä¸­ã€‚&lt;/p>
&lt;p>Git å¯ä»¥æŠŠå·¥ä½œåŒºä¸­çš„æ–‡ä»¶å¤„ç†ã€å‹ç¼©æˆä¸€ä¸ªæäº¤å¯¹è±¡ï¼ˆç¨åä¼šè§£é‡Šè¿™ä¸€æ¦‚å¿µï¼‰ï¼Œä¹Ÿèƒ½å°†å–å¾—çš„æäº¤å¯¹è±¡è§£åŒ…æˆæ–‡ä»¶åŒæ­¥åˆ°å·¥ä½œåŒºä¸­ã€‚&lt;/p>
&lt;h3 id="æš‚å­˜åŒº">æš‚å­˜åŒº&lt;/h3>
&lt;p>æš‚å­˜åŒºä¿å­˜ç€ä¸‹ä¸€æ¬¡æ‰§è¡Œ &lt;code>git commit&lt;/code> æ—¶å°†åŠ å…¥åˆ°æäº¤å†å²ä¸­çš„å†…å®¹ã€‚&lt;/p>
&lt;p>Git æŠŠå®ƒä½œä¸ºå·¥ä½œåŒºä¸æäº¤å†å²ä¹‹é—´çš„ä¸­é—´åŒºåŸŸï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹æäº¤å†…å®¹è¿›è¡Œç»„ç»‡ï¼šæˆ‘ä»¬å¯èƒ½ä¼šåœ¨å·¥ä½œåŒºåŒæ—¶æ›´æ”¹å¤šä¸ªå®Œå…¨ä¸ç›¸å¹²çš„æ–‡ä»¶ï¼Œè¿™æ—¶å¯ä»¥å°†å®ƒä»¬åˆ†åˆ«æ”¾å…¥æš‚å­˜åŒºï¼Œå¹¶åœ¨ä¸åŒçš„æäº¤ä¸­åŠ å…¥æäº¤å†å²ã€‚æ­¤å¤–æš‚å­˜åŒºè¿˜ç”¨äºåˆå¹¶å†²çªæ—¶å­˜æ”¾æ–‡ä»¶çš„ä¸åŒç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>é™¤éæ˜¯ä¸€ä¸ªåˆšåˆšåˆå§‹åŒ–çš„ Git ä»“åº“ï¼Œå¦åˆ™æš‚å­˜åŒºå¹¶ä¸æ˜¯ç©ºçš„ï¼Œå®ƒä¼šå¡«å……æœ€è¿‘ä¸€æ¬¡æäº¤æ‰€å¯¹åº”çš„æ–‡ä»¶å¿«ç…§ï¼Œå› æ­¤å½“æˆ‘ä»¬åŸºäºæœ€è¿‘ä¸€æ¬¡æäº¤åœ¨å·¥ä½œåŒºåšäº†ä¸€äº›ä¿®æ”¹ä¹‹åï¼Œ&lt;code>git status&lt;/code> ä¼šå°†å·¥ä½œåŒºçš„æ–‡ä»¶ä¸æš‚å­˜åŒºçš„æ–‡ä»¶å¿«ç…§è¿›è¡Œå¯¹æ¯”ï¼Œ å¹¶æç¤ºæˆ‘ä»¬æœ‰å“ªäº›åšäº†ä¿®æ”¹çš„æ–‡ä»¶å°šæœªåŠ å…¥æš‚å­˜åŒºã€‚&lt;/p>
&lt;h4 id="index-æ–‡ä»¶">Index æ–‡ä»¶&lt;/h4>
&lt;p>æš‚å­˜åŒºå¹¶ä¸åƒå·¥ä½œåŒºæœ‰å¯è§çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•ï¼Œæˆ–è€…åƒæäº¤å†å²ä¸€æ ·é€šè¿‡ &lt;code>.git/objects&lt;/code> ç›®å½•ä¿å­˜ç€æ‰€æœ‰æäº¤å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰å®é™…å­˜åœ¨çš„ç›®å½•æˆ–æ–‡ä»¶å¤¹ï¼Œå®ƒçš„å®ä½“æ˜¯ä½äº &lt;code>.git&lt;/code> ç›®å½•çš„ &lt;code>index&lt;/code> æ–‡ä»¶ã€‚ &lt;code>index&lt;/code> æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«ç€ä¸€ä¸ªç”±è·¯å¾„åç§°ã€æƒé™å’Œ &lt;code>blob&lt;/code> å¯¹è±¡çš„ SHA-1 å€¼ç»„æˆçš„æœ‰åºåˆ—è¡¨ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>git ls-files&lt;/code> å‘½ä»¤æŸ¥çœ‹ &lt;code>index&lt;/code> ä¸­çš„å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git ls-files --stage
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> 30d74d258442c7c65512eafab474568dd706c430 &lt;span class="m">0&lt;/span> README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> 9c1cab9a57432098de869e202ed73161af33d182 &lt;span class="m">0&lt;/span> main.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>index&lt;/code> ä¸­è®°å½•äº†æš‚å­˜åŒºæ–‡ä»¶çš„è·¯å¾„åç§°å’Œ SHA-1 IDï¼Œæ–‡ä»¶å†…å®¹å·²ç»ä½œä¸º &lt;code>blob&lt;/code> å¯¹è±¡ä¿å­˜åˆ°äº† &lt;code>.git/objects&lt;/code> ç›®å½•ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ tree .git/objects -L &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">.git/objects
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ &lt;span class="m">30&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ d74d258442c7c65512eafab474568dd706c430
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ 9c
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ 1cab9a57432098de869e202ed73161af33d182
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ info
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ pack
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">4&lt;/span> directories, &lt;span class="m">2&lt;/span> files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>blob&lt;/code> å¯¹è±¡æ˜¯ Git ç”¨æ¥ä¿å­˜æ–‡ä»¶æ•°æ®çš„äºŒè¿›åˆ¶å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ ID å–å¾—å¯¹åº”çš„ &lt;code>blob&lt;/code> å¯¹è±¡ï¼Œç”¨ &lt;code>git cat-file&lt;/code> å‘½ä»¤æ‰“å°å…¶å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git cat-file -p 30d74d258442c7c65512eafab474568dd706c430
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">This is a README file.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å½“æˆ‘ä»¬å°†ä¸€ä¸ªä¿®æ”¹è¿‡çš„æ–‡ä»¶åŠ å…¥æš‚å­˜åŒºåï¼Œå¦‚æœåˆåœ¨å·¥ä½œåŒºå¯¹æ–‡ä»¶è¿›è¡Œäº†æ–°çš„ä¿®æ”¹ï¼Œéœ€è¦é‡æ–°å°†å…¶åŠ å…¥æš‚å­˜åŒºï¼Œå› ä¸ºæš‚å­˜åŒºä»¥ &lt;code>blob&lt;/code> å¯¹è±¡ä¿å­˜çš„åªæ˜¯æ–‡ä»¶åŠ å…¥æ—¶çš„å†…å®¹ã€‚&lt;/p>
&lt;p>åœ¨ &lt;code>index&lt;/code> æ–‡ä»¶ä¸­ï¼Œè¿˜è®°å½•äº†æ¯ä¸€ä¸ªæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´å’Œæœ€åä¿®æ”¹æ—¶é—´ç­‰å…ƒä¿¡æ¯ï¼Œå®ƒé€šè¿‡å¼•ç”¨å®é™…çš„æ•°æ®å¯¹è±¡åŒ…å«äº†ä¸€ä»½å®Œæ•´çš„æ–‡ä»¶å¿«ç…§ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å¯¹æ¯” SHA-1 æ ¡éªŒå’Œå®ç°ä¸å·¥ä½œåŒºæ–‡ä»¶ä¹‹é—´çš„å¿«é€Ÿæ¯”è¾ƒã€‚&lt;/p>
&lt;h3 id="æäº¤å†å²">æäº¤å†å²&lt;/h3>
&lt;p>æäº¤å†å²æ˜¯å·¥ä½œåŒºæ–‡ä»¶åœ¨ä¸åŒæ—¶é—´çš„æ–‡ä»¶å¿«ç…§ï¼ˆå¿«ç…§å³æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å†…å®¹å’Œå…ƒä¿¡æ¯ï¼‰ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>git log&lt;/code> å‘½ä»¤æŸ¥çœ‹å½“å‰åˆ†æ”¯çš„æäº¤å†å²ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit ea4c48a0984880bda4031f0713229229c12793e4 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Author: Waynerv &amp;lt;waynerv@notmyemail.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed Jan &lt;span class="m">6&lt;/span> 21:05:44 &lt;span class="m">2021&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add main file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit b15cc74d6d85435660fcacce1305a54273880479
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Author: Waynerv &amp;lt;waynerv@notmyemail.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed Jan &lt;span class="m">6&lt;/span> 21:05:06 &lt;span class="m">2021&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> add ignore file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit e137e9b81cc5dfc5b1c9c7d06b861553d5c42491
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Author: Waynerv &amp;lt;waynerv@notmyemail.com&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Date: Wed Jan &lt;span class="m">6&lt;/span> 21:04:39 &lt;span class="m">2021&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> first commit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¯ä¸€ä¸ªæäº¤éƒ½ä¼šæœ‰ä¸€ä¸ª 40 ä½çš„ã€ŒIDã€ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ea4c48a0984880bda4031f0713229229c12793e4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Git é€šè¿‡ã€Œæäº¤å¯¹è±¡ã€æ¥å‚¨å­˜æ¯ä¸€æ¬¡æäº¤ã€‚è¿™ä¸ª ID æ˜¯ä»¥å¯¹è±¡å†…å®¹è¿›è¡Œ SHA-1 è®¡ç®—å¾—åˆ°çš„å“ˆå¸Œå€¼ï¼Œä¸åŒçš„å†…å®¹ä¸€å®šä¼šå¾—åˆ°ä¸åŒçš„ç»“æœï¼ŒGit æ—¢æŠŠå®ƒä½œä¸ºæ¯ä¸€ä¸ªå¯¹è±¡ï¼ˆä¸ä»…ä»…æ˜¯æäº¤å¯¹è±¡ï¼‰çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¹Ÿç”¨ä½œ &lt;code>.git/objects&lt;/code> ç›®å½•ä¸­çš„åœ°å€ï¼ˆå…¶ä¸­å­˜å‚¨ç€å®é™…çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ ID æ‰¾åˆ°å¯¹åº”çš„å¯¹è±¡å¹¶æ‰“å°å…¶å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git cat-file -p ea4c48a0984880bda4031f0713229229c12793e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tree 9e761342b98484aac2d8734f45fc2d0fde3e29db
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">parent b15cc74d6d85435660fcacce1305a54273880479
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">author Waynerv &amp;lt;waynerv@notmyemail.com&amp;gt; &lt;span class="m">1609938344&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">committer Waynerv &amp;lt;waynerv@notmyemail.com&amp;gt; &lt;span class="m">1609938344&lt;/span> +0800
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">add main application file
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¸ªæäº¤å¯¹è±¡çš„å†…å®¹åŒ…å«ä¸‰éƒ¨åˆ†ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹åº”çš„ &lt;code>tree&lt;/code> å¯¹è±¡çš„ ID&lt;/li>
&lt;li>çˆ¶æäº¤å¯¹è±¡çš„ ID&lt;/li>
&lt;li>ä½œè€…ã€æäº¤è€…åŠæäº¤ä¿¡æ¯ç­‰å…ƒä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;p>&lt;code>tree&lt;/code> å¯¹è±¡ä¸»è¦ç”±å…¶ä»– &lt;code>tree&lt;/code> å¯¹è±¡å’Œ &lt;code>blob&lt;/code> å¯¹è±¡çš„ ID ä»¥åŠè·¯å¾„åç§°ç»„æˆï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git ls-tree 9e761342b98484aac2d8734f45fc2d0fde3e29db
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> blob 723ef36f4e4f32c4560383aa5987c575a30c6535 .gitignore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> blob 30d74d258442c7c65512eafab474568dd706c430 README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">100644&lt;/span> blob 9c1cab9a57432098de869e202ed73161af33d182 main.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">040000&lt;/span> tree 556af47de72b597f532f63b63983be433f137e57 tests
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å°±åƒç›®å½•é€’å½’åœ°åŒ…å«å…¶ä»–ç›®å½•å’Œæ–‡ä»¶ä¸€æ ·ï¼Œä¸€ä¸ª &lt;code>tree&lt;/code> å¯¹è±¡å³å¯è¡¨ç¤ºæ•´ä¸ªå·¥ä½œåŒºä¸­æ‰€æœ‰å·²æäº¤ç›®å½•åŠæ–‡ä»¶çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´æäº¤å†å²ä¸­çš„æ¯ä¸€ä¸ªæäº¤éƒ½åŒ…å«ç€ä¸€ä»½å®Œæ•´çš„æŸä¸€æ—¶åˆ»çš„æ–‡ä»¶å¿«ç…§ï¼Œå¹¶é€šè¿‡ä¿å­˜ä¸Šä¸€æ¬¡æäº¤çš„å¼•ç”¨å½¢æˆè¿ç»­çš„æ–‡ä»¶å¿«ç…§å†å²ã€‚&lt;/p>
&lt;h3 id="å·¥ä½œæµç¨‹">å·¥ä½œæµç¨‹&lt;/h3>
&lt;p>åœ¨ç»§ç»­å‰ï¼Œæˆ‘ä»¬éœ€è¦ç®€å•äº†è§£ä¸‹åˆ†æ”¯å’Œ HEADã€‚&lt;/p>
&lt;p>åœ¨ Git ä¸­æˆ‘ä»¬å°† SHA-1 å€¼ç”¨åšæäº¤å¯¹è±¡ï¼ˆä»¥åŠ &lt;code>tree&lt;/code> å’Œ &lt;code>blob&lt;/code> å¯¹è±¡ï¼‰çš„ IDï¼Œé€šè¿‡ ID æ“ä½œæäº¤å¯¹è±¡ä»¥åŠæäº¤å¯¹è±¡å¼•ç”¨çš„æ–‡ä»¶å¿«ç…§ã€‚ä½†å¤§éƒ¨åˆ†æ—¶å€™ï¼Œè®°ä½ä¸€ä¸ª ID æ˜¯éå¸¸å›°éš¾çš„ï¼Œå› æ­¤ Git ç”¨ä¸€ä¸ªæ–‡ä»¶æ¥ä¿å­˜ SHA-1 å€¼ï¼Œè¿™ä¸ªæ–‡ä»¶çš„åå­—å³ä½œä¸ºã€Œå¼•ç”¨ï¼ˆrefsï¼‰ã€æ¥æ›¿ä»£åŸå§‹çš„ SHA-1 å€¼ã€‚&lt;/p>
&lt;p>è¿™ç±»åŒ…å« SHA-1 å€¼çš„æ–‡ä»¶ä¿å­˜åœ¨ &lt;code>.git/refs&lt;/code> ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ &lt;code>.git/refs/heads&lt;/code> ç›®å½•ä¸­æ‰¾åˆ°ä»£è¡¨å„ä¸ªåˆ†æ”¯å¼•ç”¨çš„æ–‡ä»¶ï¼Œå°è¯•æ‰“å° &lt;code>master&lt;/code> æ–‡ä»¶çš„å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/refs/heads/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a0984880bda4031f0713229229c12793e4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™åŸºæœ¬å°±æ˜¯ Git åˆ†æ”¯çš„æœ¬è´¨ï¼šä¸€ä¸ªæŒ‡å‘æŸä¸€ç³»åˆ—æäº¤ä¹‹é¦–çš„æŒ‡é’ˆæˆ–å¼•ç”¨ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è¿˜ç”¨ HEAD æ¥æŒ‡å‘æœ€è¿‘çš„ä¸€æ¬¡æäº¤ï¼ŒHEAD æ–‡ä»¶é€šå¸¸æ˜¯ä¸€ä¸ªç¬¦å·å¼•ç”¨ï¼ˆsymbolic referenceï¼‰ï¼ŒæŒ‡å‘ç›®å‰æ‰€åœ¨çš„åˆ†æ”¯ã€‚ æ‰€è°“ç¬¦å·å¼•ç”¨ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘å…¶ä»–å¼•ç”¨çš„å¼•ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: refs/heads/master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒHEAD æ–‡ä»¶å¯èƒ½ä¼šåŒ…å«ä¸€ä¸ª git å¯¹è±¡çš„ SHA-1 å€¼ã€‚ å½“ä½ åœ¨æ£€å‡ºä¸€ä¸ªæ ‡ç­¾ã€æäº¤æˆ–è¿œç¨‹åˆ†æ”¯ï¼Œè®©ä½ çš„ä»“åº“å˜æˆÂ ã€Œ&lt;a href="https://git-scm.com/docs/git-checkout#_detached_head">åˆ†ç¦» HEAD&lt;/a>ã€çŠ¶æ€æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout ea4c48a0984880bda4031f0713229229c12793e4
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ cat .git/HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a0984880bda4031f0713229229c12793e4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æœ€åï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸Šæ–‡ä»‹ç»çš„ä¸‰æ£µæ ‘ä¹‹é—´çš„å·¥ä½œæµç¨‹ï¼š&lt;/p>
&lt;p>&lt;img src="git-three-trees.png" alt="Untitled">&lt;/p>
&lt;ol>
&lt;li>å‡è®¾æˆ‘ä»¬è¿›å…¥åˆ°ä¸€ä¸ªæ–°ç›®å½•ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª &lt;code>README&lt;/code> æ–‡ä»¶ã€‚æ­¤æ—¶æš‚å­˜åŒºä¸ºç©ºï¼Œæäº¤å†å²ä¸ºç©ºï¼ŒHEAD å¼•ç”¨æŒ‡å‘æœªåˆ›å»ºçš„ &lt;code>master&lt;/code> åˆ†æ”¯ã€‚&lt;/li>
&lt;li>ç°åœ¨æˆ‘ä»¬æƒ³æäº¤è¯¥æ–‡ä»¶ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡ &lt;code>git add&lt;/code> å°†å…¶æ·»åŠ åˆ°æš‚å­˜åŒºã€‚æ­¤æ—¶ Git å°†åœ¨ &lt;code>.git/objects&lt;/code> ç›®å½•ä¸­ä»¥è¯¥æ–‡ä»¶çš„å†…å®¹ç”Ÿæˆä¸€ä¸ª &lt;code>blob&lt;/code> å¯¹è±¡ï¼Œå¹¶å°† &lt;code>blob&lt;/code> å¯¹è±¡çš„ä¿¡æ¯æ·»åŠ åˆ° &lt;code>.git/index&lt;/code> æ–‡ä»¶ä¸­ã€‚&lt;/li>
&lt;li>æ¥ç€è¿è¡Œ &lt;code>git commit&lt;/code> ï¼Œå®ƒä¼šå–å¾—æš‚å­˜åŒºä¸­çš„å†…å®¹ç”Ÿæˆä¸€ä¸ª &lt;code>tree&lt;/code> å¯¹è±¡ï¼Œè¯¥ &lt;code>tree&lt;/code> å¯¹è±¡å³ä¸ºå·¥ä½œåŒºæ–‡ä»¶çš„æ°¸ä¹…å¿«ç…§ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥ &lt;code>tree&lt;/code> å¯¹è±¡çš„æäº¤å¯¹è±¡ï¼Œæœ€åæ›´æ–° &lt;code>master&lt;/code> æŒ‡å‘æœ¬æ¬¡æäº¤ã€‚&lt;/li>
&lt;li>å‡å¦‚æˆ‘ä»¬åœ¨å·¥ä½œåŒºç¼–è¾‘äº†æ–‡ä»¶ï¼ŒGit ä¼šå°†å…¶ä¸æš‚å­˜åŒºç°æœ‰æ–‡ä»¶å¿«ç…§è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ &lt;code>git add&lt;/code> äº†æ›´æ”¹çš„æ–‡ä»¶åï¼Œæ ¹æ®æ–‡ä»¶å½“å‰å†…å®¹ç”Ÿæˆæ–°çš„ &lt;code>blob&lt;/code> å¯¹è±¡å¹¶æ›´æ–° &lt;code>.git/index&lt;/code> æ–‡ä»¶ä¸­çš„å¼•ç”¨ IDã€‚&lt;code>git commit&lt;/code> çš„è¿‡ç¨‹ä¸ä¹‹å‰ç±»ä¼¼ï¼Œä½†æ˜¯æ–°çš„æäº¤å¯¹è±¡ä¼šä»¥ HEAD å¼•ç”¨æŒ‡å‘çš„æäº¤ä½œä¸ºçˆ¶æäº¤ï¼Œç„¶åæ›´æ–°å…¶å¼•ç”¨çš„ &lt;code>master&lt;/code> æŒ‡å‘æ–°åˆ›å»ºçš„æäº¤ã€‚&lt;/li>
&lt;li>å½“æˆ‘ä»¬ &lt;code>git checkout&lt;/code> ä¸€ä¸ªåˆ†æ”¯æˆ–æäº¤æ—¶ï¼Œå®ƒä¼šä¿®æ”¹ HEAD æŒ‡å‘æ–°çš„åˆ†æ”¯å¼•ç”¨æˆ–æäº¤ï¼Œå°†æš‚å­˜åŒºå¡«å……ä¸ºè¯¥æ¬¡æäº¤çš„æ–‡ä»¶å¿«ç…§ï¼Œç„¶åå°†æš‚å­˜åŒºçš„å†…å®¹è§£åŒ…å¤åˆ¶åˆ°å·¥ä½œåŒºä¸­ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å¸¸è§çš„æ’¤é”€å‘½ä»¤">å¸¸è§çš„ã€Œæ’¤é”€ã€å‘½ä»¤&lt;/h2>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ä½¿ç”¨å¦‚ä¸‹çš„ Git ä»“åº“ä½œä¸ºåŸºå‡†ç¤ºä¾‹ï¼Œä»‹ç»ä¸€äº›å¸¸è§çš„ã€Œæ’¤é”€ã€å‘½ä»¤ã€‚å‡è®¾å·¥ä½œåŒºä¸­å·²å­˜åœ¨è¿™äº›æ–‡ä»¶ï¼Œä¸”å¼€å§‹ä»‹ç»æ¯ä¸ªå‘½ä»¤æ—¶ç¤ºä¾‹ä»“åº“éƒ½ä¼šå›åˆ°åˆå§‹çŠ¶æ€ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git add README.md &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> git commit -m &lt;span class="s2">&amp;#34;first commit&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git add .gitignore &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> git commit -m &lt;span class="s2">&amp;#34;add ignore file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git add main.py &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> git commit -m &lt;span class="s2">&amp;#34;add main file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git log --pretty&lt;span class="o">=&lt;/span>oneline
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span> add main file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b15cc74 add ignore file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e137e9b first commit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ºäº†æ–¹ä¾¿å±•ç¤ºæˆ‘ä»¬å°†åªå– SHA-1 ID çš„å‰ 7 ä½ï¼Œä½† Git ä¾ç„¶èƒ½å‡†ç¡®çš„æ‰¾åˆ°å¯¹åº”çš„æäº¤ã€‚&lt;/p>
&lt;h3 id="git-checkout">git checkout&lt;/h3>
&lt;p>&lt;code>checkout&lt;/code> æœ‰ä¸¤ç§å·¥ä½œæ–¹å¼ï¼šåœ¨å‘½ä»¤å‚æ•°ä¸­å¸¦æ–‡ä»¶è·¯å¾„ä¸ä¸å¸¦ã€‚ä¸¤ç§æ–¹å¼çš„å…·ä½“è¡Œä¸ºæœ‰å¾ˆå¤§åŒºåˆ«ã€‚&lt;/p>
&lt;h4 id="ä¸å¸¦è·¯å¾„">ä¸å¸¦è·¯å¾„&lt;/h4>
&lt;p>ä¸å¸¦è·¯å¾„çš„&lt;code>git checkout [commit or branch]&lt;/code> ç”¨äºã€Œæ£€å‡ºã€æŸä¸ªæäº¤æˆ–åˆ†æ”¯ï¼Œæ£€å‡ºå¯ä»¥ç†è§£ä¸ºã€Œæ‹¿å‡ºæ¥æŸ¥çœ‹ã€ï¼Œå› æ­¤è¿™ä¸ªæ“ä½œå¯¹å·¥ä½œåŒºæ˜¯å®‰å…¨çš„ã€‚&lt;code>git checkout [commit]&lt;/code> ä¼šæ›´æ–°æ‰€æœ‰çš„ä¸‰æ£µæ ‘ï¼Œä½¿å…¶å’Œ &lt;code>[commit]&lt;/code> çš„çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œä½†ä¿ç•™å·¥ä½œåŒºå’Œæš‚å­˜åŒºæ‰€åšçš„æ›´æ”¹ã€‚&lt;/p>
&lt;p>å‡å¦‚æˆ‘ä»¬åœ¨å·¥ä½œåŒºæ–°å¢äº† &lt;code>tests/test.py&lt;/code> æ–‡ä»¶ï¼Œå¹¶åŠ å…¥åˆ°äº†æš‚å­˜åŒºä¸­ï¼Œç„¶å &lt;code>checkout&lt;/code> åˆ°ä¸Šä¸€ä¸ªæäº¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git add tests/test.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git checkout b15cc74
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>checkout&lt;/code> å‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-checkout.gif" alt="Jan-11-2021-git-checkout">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é¦–å…ˆ HEAD ä¼šç›´æ¥æŒ‡å‘ &lt;code>b15cc74&lt;/code> æäº¤ï¼Œè¿›å…¥åˆ†ç¦» HEAD çŠ¶æ€ï¼Œå³ä¸å†æŒ‡å‘åˆ†æ”¯å¼•ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b15cc74
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç„¶åå°†æå– &lt;code>b15cc74&lt;/code> æäº¤çš„æ–‡ä»¶å¿«ç…§ä¾æ¬¡æ›´æ–°åˆ°æš‚å­˜åŒºä»¥åŠå·¥ä½œåŒºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‹¥å·¥ä½œåŒºä¸æš‚å­˜åŒºå­˜åœ¨æœªæäº¤çš„æœ¬åœ°æ›´æ”¹ï¼Œ&lt;code>checkout&lt;/code> è¿˜ä¼šå°è¯•å°†æ–‡ä»¶å¿«ç…§ä¸æœ¬åœ°æ›´æ”¹åšç®€å•çš„åˆå¹¶ï¼Œè‹¥åˆå¹¶å¤±è´¥ï¼Œå°†ä¼šä¸­æ­¢æ“ä½œå¹¶æ¢å¤åˆ° &lt;code>checkout&lt;/code> ä¹‹å‰çš„çŠ¶æ€ã€‚å› æ­¤&lt;code>checkout&lt;/code> å¯¹å·¥ä½œåŒºæ˜¯å®‰å…¨çš„ï¼Œå®ƒä¸ä¼šä¸¢å¼ƒå·¥ä½œåŒºæ‰€åšçš„æ›´æ”¹ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>&lt;code>git checkout [branch]&lt;/code> çš„æ‰§è¡Œè¿‡ç¨‹ä¸ä¸Šé¢ç±»ä¼¼ï¼Œä½†æ˜¯ HEAD ä¼šæŒ‡å‘ &lt;code>[branch]&lt;/code> è¿™ä¸ªåˆ†æ”¯å¼•ç”¨ã€‚&lt;/p>
&lt;h4 id="å¸¦è·¯å¾„">å¸¦è·¯å¾„&lt;/h4>
&lt;p>å½“ &lt;code>git checkout&lt;/code> åƒä¸‹é¢è¿™æ ·åœ¨å‘½ä»¤å‚æ•°ä¸­å¸¦æ–‡ä»¶è·¯å¾„æ—¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout b15cc74 README.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-checkout-file.gif" alt="Jan-11-2021-git-checkout-file">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å®ƒä¼šæ‰¾åˆ°è¯¥æäº¤ï¼Œå¹¶åœ¨è¯¥æäº¤çš„æ–‡ä»¶å¿«ç…§ä¸­åŒ¹é…æ–‡ä»¶è·¯å¾„å¯¹åº”çš„æ–‡ä»¶ï¼Œä½†å¹¶&lt;strong>ä¸ä¼šç§»åŠ¨&lt;/strong> HEADï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: refs/heads/master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å°†åŒ¹é…åˆ°çš„æ–‡ä»¶å¿«ç…§è¦†ç›–åˆ°æš‚å­˜åŒºä»¥åŠå·¥ä½œåŒºã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‹¥å·¥ä½œåŒºä¸æš‚å­˜åŒºå­˜åœ¨å¯¹è¯¥æ–‡ä»¶çš„æœ¬åœ°æ›´æ”¹ï¼Œè¯¥æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚å› æ­¤&lt;code>checkout&lt;/code> å¸¦æ–‡ä»¶è·¯å¾„æ—¶å¯¹å·¥ä½œåŒºæ˜¯ä¸å®‰å…¨çš„ï¼Œå®ƒä¼šä¸¢å¼ƒå·¥ä½œåŒºå¯¹è¯¥æ–‡ä»¶æ‰€åšçš„æ›´æ”¹ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="git-reset">git reset&lt;/h3>
&lt;p>&lt;code>git reset&lt;/code> çš„ä¸»è¦ä½œç”¨æ˜¯å°† HEAD é‡ç½®ä¸ºæŒ‡å®šçš„æäº¤ã€‚ä¸ &lt;code>checkout&lt;/code> çš„åŒºåˆ«åœ¨äºï¼Œå®ƒå¯¹æäº¤å†å²çš„æ›´æ”¹å¹¶ä¸ä»…ä»…åªæ˜¯æ›´æ–° HEAD æœ¬èº«ï¼Œå¦‚æœ HEAD åŸæ¥æŒ‡å‘æŸä¸ªåˆ†æ”¯å¼•ç”¨ï¼Œåˆ™ä¼šå°†åˆ†æ”¯å¼•ç”¨ä¹Ÿæ›´æ–°ä¸ºæŒ‡å‘æ–°çš„æäº¤ã€‚&lt;/p>
&lt;p>å®ƒçš„å·¥ä½œæ–¹å¼æ›´å¤šäº†ï¼Œæœ‰ &lt;code>â€”soft&lt;/code>ã€ &lt;code>--mixed&lt;/code>ã€&lt;code>--hard&lt;/code> ä¸‰ç§ä¸»è¦çš„å‘½ä»¤é€‰é¡¹ï¼Œåˆ†åˆ«å¯¹åº”æ›´æ–°ä¸åŒæ•°é‡çš„æ ‘ï¼š&lt;/p>
&lt;p>&lt;img src="iShot2021-01-07-git-reset.png" alt="iShot2021-01-07 22.21.30">&lt;/p>
&lt;h4 id="--soft">&lt;code>--soft&lt;/code>&lt;/h4>
&lt;p>å½“å‘½ä»¤è¡Œé€‰é¡¹ä¸º &lt;code>--soft&lt;/code> æ—¶ï¼Œ&lt;code>git reset&lt;/code> åªä¼šå¯¹æäº¤å†å²è¿›è¡Œé‡ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout master &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cat .git/refs/heads/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å·²ç»ä½äº &lt;span class="s1">&amp;#39;master&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git reset --soft b15cc74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ä½äºåˆ†æ”¯ master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è¦æäº¤çš„å˜æ›´ï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ï¼ˆä½¿ç”¨ &lt;span class="s2">&amp;#34;git restore --staged &amp;lt;æ–‡ä»¶&amp;gt;...&amp;#34;&lt;/span> ä»¥å–æ¶ˆæš‚å­˜ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> æ–°æ–‡ä»¶ï¼š main.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-reset-soft.gif" alt="Jan-11-2021-git-reset-soft">&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é¦–å…ˆå°† HEAD åŠå…¶æŒ‡å‘çš„åˆ†æ”¯å¼•ç”¨æŒ‡å‘ &lt;code>b15cc74&lt;/code> æäº¤ï¼Œæœ¬ç¤ºä¾‹ä¸­ HEAD åŸæœ¬æŒ‡å‘ &lt;code>master&lt;/code> ï¼Œæ‰§è¡Œæ“ä½œä¹‹åä¾ç„¶æŒ‡å‘ &lt;code>master&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/HEAD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ref: refs/heads/master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½† &lt;code>master&lt;/code> åˆ†æ”¯å¼•ç”¨å´ä»åŸæ¥æŒ‡å‘ &lt;code>ea4c48a&lt;/code> å˜æˆäº†æŒ‡å‘ &lt;code>b15cc74&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ cat .git/refs/heads/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b15cc74
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è‹¥ HEAD åŸæœ¬å¤„äºåˆ†ç¦» HEAD çŠ¶æ€ï¼Œåˆ™åªä¼šæ›´æ–° HEAD æœ¬èº«ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>reset --soft&lt;/code> åˆ°æ­¤å°±å·²ç»ç»“æŸäº†ï¼Œå®ƒä¸ä¼šå†å¯¹æš‚å­˜åŒºä»¥åŠå·¥ä½œåŒºè¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œæš‚å­˜åŒºå’Œå·¥ä½œåŒºä¾ç„¶ä¿ç•™ç€åŸæ¥çš„ &lt;code>ea4c48a&lt;/code> æäº¤ä¹‹åçš„æ–‡ä»¶å¿«ç…§ä¸æ–‡ä»¶ï¼Œå› æ­¤è¿è¡Œ &lt;code>git status&lt;/code> æˆ‘ä»¬å°†çœ‹åˆ°æš‚å­˜åŒºä¸­æœ‰å¾…æäº¤çš„å˜æ›´ï¼Œå·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­çš„æœ¬åœ°æ›´æ”¹ä¹Ÿéƒ½ä¼šå¾—åˆ°ä¿ç•™ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="--mixed">&lt;code>--mixed&lt;/code>&lt;/h4>
&lt;p>&lt;code>--mixed&lt;/code> é€‰é¡¹æ˜¯ &lt;code>git reset&lt;/code> å‘½ä»¤çš„é»˜è®¤é€‰é¡¹ï¼Œ&lt;code>git reset [commit]&lt;/code> å³ç­‰åŒäº &lt;code>git reset --mixed [commit]&lt;/code>ã€‚å®ƒé™¤äº†é‡ç½®æäº¤å†å²ï¼Œè¿˜ä¼šæ›´æ–°æš‚å­˜åŒºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout master &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cat .git/refs/heads/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å·²ç»ä½äº &lt;span class="s1">&amp;#39;master&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git reset --mixed b15cc74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ä½äºåˆ†æ”¯ master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœªè·Ÿè¸ªçš„æ–‡ä»¶:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ï¼ˆä½¿ç”¨ &lt;span class="s2">&amp;#34;git add &amp;lt;æ–‡ä»¶&amp;gt;...&amp;#34;&lt;/span> ä»¥åŒ…å«è¦æäº¤çš„å†…å®¹ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> main.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æäº¤ä¸ºç©ºï¼Œä½†æ˜¯å­˜åœ¨å°šæœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼ˆä½¿ç”¨ &lt;span class="s2">&amp;#34;git add&amp;#34;&lt;/span> å»ºç«‹è·Ÿè¸ªï¼‰
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-reset-mixed.gif" alt="Jan-11-2021-git-reset-mixed">&lt;/p>
&lt;ol>
&lt;li>æ›´æ–° HEAD æŒ‡å‘ &lt;code>b15cc74&lt;/code> æäº¤ï¼Œé‡ç½®æäº¤å†å²çš„è¿‡ç¨‹ä¸ &lt;code>--soft&lt;/code> å®Œå…¨ç›¸åŒã€‚&lt;/li>
&lt;li>ä¹‹åè¿˜ä¼šæ›´æ–°æš‚å­˜åŒºï¼Œå°†å…¶å¡«å……ä¸º &lt;code>b15cc74&lt;/code> æäº¤çš„æ–‡ä»¶å¿«ç…§ï¼Œæš‚å­˜åŒºä¸­çš„åŸæœ‰å†…å®¹å°†ä¼šä¸¢å¤±ã€‚&lt;/li>
&lt;li>ä¸ä¼šå¯¹å·¥ä½œåŒºè¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå·¥ä½œåŒºä¾ç„¶ä¿ç•™ç€åŸæ¥çš„ &lt;code>ea4c48a&lt;/code> æäº¤ä¹‹åçš„æ–‡ä»¶ï¼Œå› æ­¤è¿è¡Œ &lt;code>git status&lt;/code> æˆ‘ä»¬å°†çœ‹åˆ°æœ‰æœªè·Ÿè¸ªçš„æ–‡ä»¶å¾…åŠ å…¥æš‚å­˜åŒºï¼Œå·¥ä½œåŒºä¸­çš„æœ¬åœ°æ›´æ”¹ä¹Ÿä¼šå¾—åˆ°ä¿ç•™ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="--hard">&lt;code>--hard&lt;/code>&lt;/h4>
&lt;p>&lt;code>--hard&lt;/code> æ˜¯ &lt;code>reset&lt;/code> æœ€&lt;strong>ç›´æ¥&lt;/strong>ã€æœ€&lt;strong>å±é™©&lt;/strong>ä»¥åŠæœ€&lt;strong>å¸¸ç”¨&lt;/strong>çš„é€‰é¡¹ã€‚ &lt;code>git reset â€”hard [commit]&lt;/code> ä¼šå°†æ‰€æœ‰çš„ä¸‰æ£µæ ‘éƒ½æ›´æ–°ä¸ºæŒ‡å®šæäº¤çš„çŠ¶æ€ï¼Œå·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­æ‰€æœ‰æœªæäº¤çš„æ›´æ”¹éƒ½ä¼šæ°¸ä¹…ä¸¢å¤±ï¼Œä½†è¢«é‡ç½®çš„æäº¤ä»æœ‰åŠæ³•æ‰¾å›ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬åŒæ ·æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git checkout master &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> cat .git/refs/heads/master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å·²ç»ä½äº &lt;span class="s1">&amp;#39;master&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git reset --hard b15cc74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HEAD ç°åœ¨ä½äº b15cc74 add gitignore file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ä½äºåˆ†æ”¯ master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ— æ–‡ä»¶è¦æäº¤ï¼Œå¹²å‡€çš„å·¥ä½œåŒº
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-reset-hard.gif" alt="Jan-11-2021-git-reset-hard">&lt;/p>
&lt;ol>
&lt;li>æ›´æ–° HEAD æŒ‡å‘ &lt;code>b15cc74&lt;/code> æäº¤ï¼Œé‡ç½®æäº¤å†å²çš„è¿‡ç¨‹ä¸ &lt;code>--soft&lt;/code> åŠ &lt;code>--mixed&lt;/code> é€‰é¡¹ç›¸åŒã€‚&lt;/li>
&lt;li>æ›´æ–°æš‚å­˜åŒºï¼Œå°†å…¶å¡«å……ä¸º &lt;code>b15cc74&lt;/code> æäº¤çš„æ–‡ä»¶å¿«ç…§ï¼Œæš‚å­˜åŒºä¸­çš„åŸæœ‰å†…å®¹å°†ä¼šä¸¢å¤±ã€‚&lt;/li>
&lt;li>æ›´æ–°å·¥ä½œåŒºï¼Œå°†å…¶å¡«å……ä¸º &lt;code>b15cc74&lt;/code> æäº¤çš„æ–‡ä»¶å¿«ç…§ï¼Œå·¥ä½œåŒºä¸­çš„åŸæœ‰å†…å®¹å°†ä¼šä¸¢å¤±ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ­£å¦‚ä¸Šé¢æ‰€è¯´ï¼Œ&lt;code>reset â€”hard&lt;/code> ä¼šå°†å·¥ä½œåŒºã€æš‚å­˜åŒºå’Œæäº¤å†å²éƒ½é‡ç½®ä¸ºåˆšåˆšæ–°å¢äº† &lt;code>b15cc74&lt;/code> æäº¤æ—¶çš„çŠ¶æ€ï¼Œå¹¶ç®€å•ç²—æš´åœ°è¦†ç›–æ‰å·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„åŸæœ‰å†…å®¹ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸å±é™©çš„æ“ä½œï¼Œå› ä¸ºå·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æœªæäº¤æ›´æ”¹ä¸¢å¤±åæ— æ³•å†é€šè¿‡ Git æ‰¾å›ã€‚&lt;/p>
&lt;h4 id="æ‰¾å›æäº¤å†å²">æ‰¾å›æäº¤å†å²&lt;/h4>
&lt;p>&lt;code>reset&lt;/code> åä¸¢å¤±çš„æäº¤å†å²ä»ç„¶èƒ½å¤Ÿæ¢å¤ï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯æ›´æ–°äº† HEAD æŒ‡å‘çš„æäº¤ï¼Œè€Œæ²¡æœ‰å¯¹å®é™…çš„æäº¤å¯¹è±¡åšä»»ä½•æ›´æ”¹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>git reflog&lt;/code> æ‰¾åˆ° HEAD æ›¾ç»æŒ‡å‘è¿‡çš„æäº¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git reflog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">b15cc74 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master&lt;span class="o">)&lt;/span> HEAD@&lt;span class="o">{&lt;/span>0&lt;span class="o">}&lt;/span>: reset: moving to b15cc74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ea4c48a HEAD@&lt;span class="o">{&lt;/span>1&lt;span class="o">}&lt;/span>: checkout: moving from master to master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»ä¸­å¯ä»¥æ‰¾åˆ° &lt;code>master&lt;/code> åŸæ¥æ‰€æŒ‡å‘çš„ &lt;code>ea4c48a&lt;/code> æäº¤ï¼Œå†æ‰§è¡Œ &lt;code>git reset --hard ea4c48a&lt;/code> å°±èƒ½æ¢å¤åŸæ¥çš„æäº¤å†å²ã€‚&lt;/p>
&lt;h4 id="ä¸è¦-reset-å…¬å…±åˆ†æ”¯">ä¸è¦ reset å…¬å…±åˆ†æ”¯&lt;/h4>
&lt;p>å¦ä¸€ä¸ªå…³äº &lt;code>reset&lt;/code>çš„å®è·µæ˜¯ï¼Œä¸è¦åœ¨å…¬å…±åˆ†æ”¯ä¸Šæ‰§è¡Œ &lt;code>reset&lt;/code>ã€‚å…¬å…±åˆ†æ”¯æ˜¯æŒ‡ä½ ä¸å…¶ä»–å›¢é˜Ÿæˆå‘˜åä½œå¼€å‘çš„åˆ†æ”¯ã€‚&lt;/p>
&lt;p>å½“ä»»ä½•æäº¤è¢«æ¨é€åˆ°å…¬å…±åˆ†æ”¯åï¼Œå¿…é¡»å‡è®¾å…¶ä»–å¼€å‘è€…å·²ç»ä¾èµ–å®ƒã€‚åˆ é™¤å…¶ä»–äººå·²ç»åœ¨ç»§ç»­å¼€å‘çš„æäº¤ï¼Œä¼šç»™åä½œå¸¦æ¥ä¸¥é‡çš„é—®é¢˜ã€‚è€Œä¸”ä½ éœ€è¦å¼ºåˆ¶æ¨é€æ‰èƒ½å°†ä½  &lt;code>reset&lt;/code> åçš„åˆ†æ”¯æäº¤åˆ°è¿œç¨‹ä»“åº“ï¼Œå½“å…¶ä»–äººæ‹‰å–è¿™ä¸ªå…¬å…±åˆ†æ”¯æ—¶ï¼Œä»–ä»¬çš„æäº¤å†å²ä¼šçªç„¶æ¶ˆå¤±ä¸€éƒ¨åˆ†ã€‚&lt;/p>
&lt;p>å› æ­¤ï¼Œè¯·ç¡®ä¿åœ¨æœ¬åœ°çš„å®éªŒåˆ†æ”¯ä¸Šä½¿ç”¨ &lt;code>git reset&lt;/code>ï¼Œè€Œä¸è¦é‡ç½®å·²ç»å‘å¸ƒåˆ°å…¬å…±åˆ†æ”¯çš„æäº¤ã€‚å¦‚æœä½ éœ€è¦ä¿®å¤ä¸€ä¸ªå…¬å…±æäº¤å¼•å…¥çš„é—®é¢˜ï¼Œè¯·çœ‹ä¹‹åå°†ä»‹ç»çš„ä¸“é—¨ä¸ºæ­¤ç›®çš„è®¾è®¡çš„ &lt;code>git revert&lt;/code>ã€‚&lt;/p>
&lt;h4 id="å–æ¶ˆæš‚å­˜æ–‡ä»¶">å–æ¶ˆæš‚å­˜æ–‡ä»¶&lt;/h4>
&lt;p>å’Œ &lt;code>checkout&lt;/code> ä¸€æ ·ï¼Œ&lt;code>git reset&lt;/code> ä¹Ÿèƒ½å¯¹æ–‡ä»¶è·¯å¾„æ‰§è¡Œï¼Œå¸¸ç”¨äºå°†å·²åŠ å…¥æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶æˆ–æ–‡ä»¶é›†åˆå–æ¶ˆæš‚å­˜ã€‚&lt;/p>
&lt;p>å‡è®¾æˆ‘ä»¬åœ¨å·¥ä½œåŒºæ–°å¢äº† &lt;code>hello.py&lt;/code> å’Œ &lt;code>world.py&lt;/code> ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¹¶åŒæ—¶åŠ å…¥äº†æš‚å­˜åŒºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git add .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬æ„è¯†åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸åº”è¯¥æ”¾åœ¨ä¸€ä¸ªæäº¤ä¸­ï¼Œå› æ­¤éœ€è¦å°†å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶å–æ¶ˆæš‚å­˜ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git reset world.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git status
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ä½äºåˆ†æ”¯ master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ‚¨çš„åˆ†æ”¯ä¸ä¸Šæ¸¸åˆ†æ”¯ &lt;span class="s1">&amp;#39;origin/master&amp;#39;&lt;/span> ä¸€è‡´ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">è¦æäº¤çš„å˜æ›´ï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ï¼ˆä½¿ç”¨ &lt;span class="s2">&amp;#34;git restore --staged &amp;lt;æ–‡ä»¶&amp;gt;...&amp;#34;&lt;/span> ä»¥å–æ¶ˆæš‚å­˜ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> æ–°æ–‡ä»¶ï¼š hello.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æœªè·Ÿè¸ªçš„æ–‡ä»¶:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ï¼ˆä½¿ç”¨ &lt;span class="s2">&amp;#34;git add &amp;lt;æ–‡ä»¶&amp;gt;...&amp;#34;&lt;/span> ä»¥åŒ…å«è¦æäº¤çš„å†…å®¹ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> world.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ­¤æ—¶æš‚å­˜åŒºä¸­åªæœ‰ &lt;code>hello.py&lt;/code> æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«æäº¤å®ƒä»¬ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git commit -m &lt;span class="s2">&amp;#34;add hello.py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># åœ¨å¦ä¸€ä¸ªæäº¤ä¸­æäº¤ world.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git add world.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git commit -m &lt;span class="s2">&amp;#34;add world.py&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®é™…ä¸Š &lt;code>reset&lt;/code> å¸¦æ–‡ä»¶è·¯å¾„å‘½ä»¤çš„å®Œæ•´å½¢å¼æ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git reset &lt;span class="o">[&lt;/span>&amp;lt;tree-ish&amp;gt;&lt;span class="o">]&lt;/span> &amp;lt;pathspec&amp;gt;â€¦
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æ“ä½œçš„å®è´¨ï¼Œæ˜¯ä» &lt;code>&amp;lt;tree-ish&amp;gt;&lt;/code> æå– &lt;code>&amp;lt;pathspec&amp;gt;&lt;/code> å¯¹åº”çš„æ–‡ä»¶å¿«ç…§æ›´æ–°åˆ°æš‚å­˜åŒºï¼Œ&lt;code>&amp;lt;tree-ish&amp;gt;&lt;/code>å¯ä»¥æ˜¯æäº¤æˆ–åˆ†æ”¯ï¼Œé»˜è®¤å€¼ä¸º HEADï¼Œå› æ­¤é»˜è®¤ä¼šå°†æš‚å­˜åŒºçš„æŒ‡å®šè·¯å¾„æ¢å¤åˆ° HEAD æäº¤çš„çŠ¶æ€ã€‚ &lt;code>git reset world.py&lt;/code> å‘½ä»¤çš„å®é™…è¿‡ç¨‹æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>ä» HEAD æäº¤ä¸­åŒ¹é… &lt;code>world.py&lt;/code> å¯¹åº”çš„æ–‡ä»¶å¿«ç…§ã€‚&lt;/li>
&lt;li>å°†åŒ¹é…åˆ°çš„æ–‡ä»¶å¿«ç…§å¤åˆ¶åˆ°æš‚å­˜åŒºã€‚&lt;/li>
&lt;/ol>
&lt;p>å› æ­¤ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹äº†æŸä¸ªæ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒºï¼Œ&lt;code>reset&lt;/code> åä¼šè¢«æ›¿æ¢æˆåŸæœ¬çš„æ–‡ä»¶ç‰ˆæœ¬ï¼›æ–°å¢çš„æ–‡ä»¶ä¼šä»æš‚å­˜åŒºä¸­ç§»é™¤ï¼ˆå› ä¸ºä¸Šä¸€æ¬¡æäº¤ä¸­æ²¡æœ‰è¯¥æ–‡ä»¶ï¼‰ï¼Œå®é™…å®ç°äº†å°†æ–‡ä»¶å–æ¶ˆæš‚å­˜çš„æ•ˆæœã€‚&lt;/p>
&lt;h3 id="git-revert">git revert&lt;/h3>
&lt;p>&lt;code>git revert&lt;/code> å‘½ä»¤ç”¨äºå›æ»šæŸä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰æäº¤å¼•å…¥çš„æ›´æ”¹ã€‚&lt;/p>
&lt;p>å…¶ä»–çš„ã€Œæ’¤é”€ã€å‘½ä»¤å¦‚ &lt;code>git checkout&lt;/code> å’Œ &lt;code>git reset&lt;/code>ï¼Œä¼šå°† HEAD æˆ–åˆ†æ”¯å¼•ç”¨é‡æ–°æŒ‡å‘åˆ°æŒ‡å®šçš„æäº¤ï¼Œ&lt;code>git revert&lt;/code> å‘½ä»¤ä¹Ÿå¯ä»¥æ¥å—ä¸€ä¸ªæŒ‡å®šçš„æäº¤ï¼Œä½†å¹¶ä¸ä¼šå°†ä»»ä½•å¼•ç”¨ç§»åŠ¨åˆ°è¿™ä¸ªæäº¤ä¸Šã€‚&lt;code>revert&lt;/code> æ“ä½œä¼šæ¥æ”¶æŒ‡å®šçš„æäº¤ï¼Œåè½¬è¯¥æäº¤å¼•å…¥çš„æ›´æ”¹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„ã€Œå›æ»šæäº¤ã€è®°å½•åè½¬æ›´æ”¹ï¼Œç„¶åæ›´æ–°åˆ†æ”¯å¼•ç”¨ï¼Œä½¿å…¶æŒ‡å‘è¯¥æäº¤ã€‚å¦‚ä»¥ä¸‹åŠ¨å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Jan-11-2021-git-revert.gif" alt="Jan-11-2021-git-revert">&lt;/p>
&lt;p>ç›¸æ¯” &lt;code>reset&lt;/code> ï¼Œ&lt;code>revert&lt;/code> ä¼šåœ¨æäº¤å†å²ä¸­å¢åŠ ä¸€ä¸ªæ–°çš„æäº¤ï¼Œè€Œä¸ä¼šå¯¹ä¹‹å‰çš„æäº¤è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚ é»˜è®¤æƒ…å†µä¸‹ &lt;code>revert&lt;/code> ä¼šè‡ªåŠ¨æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š&lt;/p>
&lt;ul>
&lt;li>å°†åè½¬æŒ‡å®šæäº¤çš„æ›´æ”¹åˆå¹¶åˆ°å·¥ä½œåŒº&lt;/li>
&lt;li>å°†æ›´æ”¹æ·»åŠ åˆ°æš‚å­˜åŒº&lt;/li>
&lt;li>åˆ›å»ºæ–°çš„æäº¤&lt;/li>
&lt;/ul>
&lt;p>å› æ­¤å®ƒè¦æ±‚æˆ‘ä»¬æä¾›ä¸€ä¸ªå¹²å‡€çš„æš‚å­˜åŒºï¼ˆå³å’Œ HEAD æäº¤çŠ¶æ€ä¸€è‡´ï¼‰ï¼Œä¸”è¦æ±‚å·¥ä½œåŒºçš„æœ¬åœ°æ›´æ”¹ä¸ä¼šè¢«åˆå¹¶æ“ä½œè¦†ç›–ï¼Œå¦åˆ™å›æ»šä¼šå¤±è´¥ã€‚æˆ‘ä»¬å¯ä»¥æ·»åŠ  &lt;code>--no-commit&lt;/code> å‘½ä»¤é€‰é¡¹æ¥è¿›å…¥äº¤äº’æ¨¡å¼æ‰‹åŠ¨æ‰§è¡Œã€Œåˆ›å»ºæ–°çš„æäº¤ã€ï¼Œæ­¤æ—¶ &lt;code>revert&lt;/code> æ“ä½œä¼šå°†åè½¬çš„æ›´æ”¹åº”ç”¨åˆ°å·¥ä½œåŒºå’Œæš‚å­˜åŒºç­‰å¾…æäº¤ï¼Œä¸”ä¸è¦æ±‚æš‚å­˜åŒºä¸ HEAD ä¸€è‡´ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬é€šè¿‡ç¤ºä¾‹æ¥æ¼”ç¤ºè¿™ä¸€è¿‡ç¨‹ï¼Œç°åœ¨æˆ‘ä»¬æƒ³å›æ»š &lt;code>b15cc74&lt;/code> è¿™ä¸ªæäº¤ï¼Œè¿™ä¸ªæäº¤ä¸­åŠ å…¥äº† &lt;code>.gitignore&lt;/code> æ–‡ä»¶ï¼Œé¢„æœŸçš„ç»“æœæ˜¯ä¼šæ–°å¢ä¸€ä¸ªåˆ é™¤è¯¥æ–‡ä»¶çš„æäº¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git revert b15cc74
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨ç»ˆç«¯æ‰§è¡Œè¯¥å‘½ä»¤åå°†ç›´æ¥è·³è½¬åˆ°ä¸€ä¸ªç¼–è¾‘å™¨ç•Œé¢ï¼Œå¯ä»¥ä¿®æ”¹æ–°æäº¤çš„æäº¤ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Revert &lt;span class="s2">&amp;#34;add gitignore file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">This reverts commit b15cc74d6d85435660fcacce1305a54273880479.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¯·ä¸ºæ‚¨çš„å˜æ›´è¾“å…¥æäº¤è¯´æ˜ã€‚ä»¥ &amp;#39;#&amp;#39; å¼€å§‹çš„è¡Œå°†è¢«å¿½ç•¥ï¼Œè€Œä¸€ä¸ªç©ºçš„æäº¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¯´æ˜å°†ä¼šç»ˆæ­¢æäº¤ã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¿å­˜å &lt;code>revert&lt;/code> å‘½ä»¤æ‰§è¡Œç»“æŸï¼Œå¹¶è¾“å‡ºä»¥ä¸‹ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">åˆ é™¤ .gitignore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>master 6bb25da&lt;span class="o">]&lt;/span> Revert &lt;span class="s2">&amp;#34;add gitignore file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="m">1&lt;/span> file changed, &lt;span class="m">1&lt;/span> deletion&lt;span class="o">(&lt;/span>-&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> delete mode &lt;span class="m">100644&lt;/span> .gitignore
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç»“æœç¬¦åˆé¢„æœŸï¼Œæ–°å¢äº†ä¸€ä¸ªåˆ é™¤ &lt;code>.gitignore&lt;/code> æ–‡ä»¶çš„ &lt;code>6bb25da&lt;/code> æäº¤ï¼Œå¹¶ä¸” &lt;code>master&lt;/code> å½“å‰æŒ‡å‘äº†è¯¥æäº¤ã€‚&lt;/p>
&lt;p>ä½†å¦‚æœæˆ‘ä»¬åœ¨ä¸€å¼€å§‹å¯¹å·¥ä½œåŒºä¸­çš„æ–‡ä»¶åšè¿‡æ›´æ”¹ä¸”åŠ å…¥åˆ°äº†æš‚å­˜åŒºï¼Œæ‰§è¡Œ &lt;code>revert&lt;/code> çš„ç»“æœå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git revert b15cc74
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">error: æ‚¨çš„æœ¬åœ°ä¿®æ”¹å°†è¢«è¿˜åŸè¦†ç›–ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æç¤ºï¼šæäº¤æ‚¨çš„ä¿®æ”¹æˆ–è´®è—åå†ç»§ç»­ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fatal: è¿˜åŸå¤±è´¥
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="revert-çš„ä¼˜åŠ¿">revert çš„ä¼˜åŠ¿&lt;/h4>
&lt;p>è™½ç„¶æ•ˆæœä¸ &lt;code>reset&lt;/code> ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨ &lt;code>revert&lt;/code> æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š&lt;/p>
&lt;ul>
&lt;li>å®ƒä¸ä¼šæ”¹å˜ä¹‹å‰çš„æäº¤å†å²ï¼Œè¿™ä½¿å¾— &lt;code>revert&lt;/code> å¯¹äºå·²ç»æ¨é€åˆ°å…±äº«ä»“åº“çš„æäº¤æ˜¯ä¸€ä¸ªã€Œå®‰å…¨ã€çš„æ“ä½œï¼Œå®ƒä¼šå®Œæ•´çš„è®°å½•æŸä¸ªæäº¤è¢«åŠ å…¥åŠå›æ»šçš„è¿‡ç¨‹ã€‚&lt;/li>
&lt;li>å®ƒå¯ä»¥å›æ»šæäº¤å†å²ä¸Šä»»æ„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ç‚¹çš„æäº¤ï¼Œè€Œ &lt;code>reset&lt;/code> åªèƒ½é‡ç½®ä»æŒ‡å®šæäº¤èµ·ä¹‹åçš„æ‰€æœ‰å†å²ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯&lt;/h3>
&lt;p>æˆ‘ä»¬åˆ†åˆ«ä»‹ç»äº† &lt;code>checkout&lt;/code> ã€&lt;code>reset&lt;/code> ã€&lt;code>revert&lt;/code> ä¸‰ä¸ªå‘½ä»¤çš„ä¸»è¦ç”¨æ³•ï¼Œä¸‹é¢çš„è¡¨æ ¼æ¦‚æ‹¬äº†å®ƒä»¬çš„å¸¸è§ä½¿ç”¨åœºæ™¯ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th style="text-align:left">å‘½ä»¤&lt;/th>
&lt;th>ä½œç”¨å¯¹è±¡&lt;/th>
&lt;th>å¸¸ç”¨åœºæ™¯&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git reset&lt;/code>&lt;/td>
&lt;td>æäº¤&lt;/td>
&lt;td>æ”¾å¼ƒç§äººåˆ†æ”¯ä¸Šçš„æäº¤æˆ–è€…è¿˜æœªæäº¤çš„æœ¬åœ°æ›´æ”¹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git reset&lt;/code>&lt;/td>
&lt;td>æ–‡ä»¶&lt;/td>
&lt;td>å°†ä¸€ä¸ªæ–‡ä»¶å–æ¶ˆæš‚å­˜&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git checkout&lt;/code>&lt;/td>
&lt;td>æäº¤&lt;/td>
&lt;td>åˆ‡æ¢åˆ†æ”¯æˆ–è€…æŸ¥çœ‹ä¸€ä¸ªä¹‹å‰çš„æäº¤&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git checkout&lt;/code>&lt;/td>
&lt;td>æ–‡ä»¶&lt;/td>
&lt;td>å°†æ–‡ä»¶æ¢å¤åˆ°æŒ‡å®šæäº¤æ—¶çš„çŠ¶æ€å¹¶ä¸¢å¼ƒåœ¨å·¥ä½œåŒºä¸­å¯¹è¯¥æ–‡ä»¶çš„æ›´æ”¹&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git revert&lt;/code>&lt;/td>
&lt;td>æäº¤&lt;/td>
&lt;td>åœ¨å…¬å…±åˆ†æ”¯ä¸Šæ’¤é”€ä¸€ä¸ªæäº¤&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td style="text-align:left">&lt;code>git revert&lt;/code>&lt;/td>
&lt;td>æ–‡ä»¶&lt;/td>
&lt;td>æ— &lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="å…¶ä»–æ›¿ä»£å‘½ä»¤">å…¶ä»–æ›¿ä»£å‘½ä»¤&lt;/h2>
&lt;p>æˆ‘ä»¬ä»‹ç»äº† &lt;code>checkout&lt;/code> ã€&lt;code>reset&lt;/code> ã€&lt;code>revert&lt;/code> ä¸‰ä¸ªå‘½ä»¤å…± 7 ç§å’Œæ’¤é”€ç›¸å…³çš„ç”¨æ³•ï¼Œè€Œè¿™äº›å‘½ä»¤è¿˜æœ‰è®¸å¤šå…¶ä»–çš„é€‰é¡¹å’Œç”¨é€”ï¼Œåœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ï¼Œå³ä½¿æ˜¯è€æ‰‹ä¹Ÿå¯èƒ½éœ€è¦ä¸æ—¶åœ°å¯¹ç…§æ‰‹å†Œã€‚ä¹Ÿè®¸æ˜¯æ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼ŒGit åœ¨ 2.23 ç‰ˆæœ¬ä¸­åˆå‘å¸ƒäº† &lt;code>resetore&lt;/code> å’Œ &lt;code>switch&lt;/code> ä¸¤ä¸ªæ–°å‘½ä»¤ï¼Œæ–°å‘½ä»¤èƒ½æ›¿ä»£ä¸Šé¢çš„éƒ¨åˆ†ç”¨æ³•ä¸”ç”¨é€”æ›´ä¸ºä¸“ä¸€ã€‚&lt;/p>
&lt;h3 id="git-restore">git restore&lt;/h3>
&lt;p>&lt;code>restore&lt;/code> å‘½ä»¤ç”¨äºè¿˜åŸå·¥ä½œåŒºæˆ–æš‚å­˜åŒºä¸­çš„æŒ‡å®šæ–‡ä»¶æˆ–æ–‡ä»¶é›†åˆï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git restore &lt;span class="o">[&lt;/span>--source&lt;span class="o">=&lt;/span>&amp;lt;tree&amp;gt;&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--staged&lt;span class="o">]&lt;/span> &lt;span class="o">[&lt;/span>--worktree&lt;span class="o">]&lt;/span> &amp;lt;pathspec&amp;gt;â€¦
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»å®šä¹‰å’Œå‘½ä»¤è¡Œå½¢å¼æ¥ç†è§£ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿˜åŸå³æ¢å¤åˆ°è¿‡å»æŸä¸€çŠ¶æ€ï¼Œæ„å‘³ç€è¯¥å‘½ä»¤éœ€è¦æŒ‡å®šå·²æœ‰çš„æŸä¸ªæ–‡ä»¶å¿«ç…§ï¼ˆæäº¤ã€åˆ†æ”¯ç­‰ï¼‰ä½œä¸ºæ•°æ®æºï¼Œé€šè¿‡ &lt;code>source&lt;/code> é€‰é¡¹è®¾ç½®ã€‚&lt;/li>
&lt;li>å¯ä»¥é€‰æ‹©å¯¹å·¥ä½œåŒºï¼ˆ&lt;code>--worktree&lt;/code> ï¼‰ã€æš‚å­˜åŒºï¼ˆ&lt;code>--staged&lt;/code> ï¼‰æˆ–ä¸¤è€…åŒæ—¶ç”Ÿæ•ˆï¼Œé»˜è®¤å€¼ä¸ºä»…å·¥ä½œåŒºã€‚å½“æŒ‡å®šçš„ä½ç½®ä¸ºå·¥ä½œåŒºæ—¶ï¼Œé»˜è®¤æ•°æ®æºä¸ºæš‚å­˜åŒºçš„æ–‡ä»¶å¿«ç…§ï¼›å½“æŒ‡å®šçš„ä½ç½®åŒ…å«æš‚å­˜åŒºæ—¶ï¼Œé»˜è®¤æ•°æ®æºä¸º HEADã€‚&lt;/li>
&lt;li>å¯ä»¥é€‰æ‹©å¯¹æŒ‡å®šçš„æ–‡ä»¶æˆ–ä¸€äº›æ–‡ä»¶ç”Ÿæ•ˆï¼Œé€šè¿‡ &lt;code>&amp;lt;pathspec&amp;gt;&lt;/code> å‚æ•°æŒ‡å®šã€‚&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ä¹‹å‰çš„ Git ä»“åº“ä½œä¸ºç¤ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬ä¿®æ”¹äº† &lt;code>main.py&lt;/code> å¹¶å·²ç»åŠ å…¥åˆ°äº†æš‚å­˜åŒºï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æˆ‘ä»¬æƒ³å°† &lt;code>main.py&lt;/code> å–æ¶ˆæš‚å­˜ï¼Œå³å°†æš‚å­˜åŒºä¸­çš„ &lt;code>main.py&lt;/code> è¿˜åŸä¸º HEAD ä¸­çš„å†…å®¹ï¼Œæ­¤æ—¶ HEAD æ˜¯é»˜è®¤çš„ &lt;code>source&lt;/code> ï¼Œå› æ­¤å¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git restore --staged main.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æ–‡ä»¶å°†è¢«å–æ¶ˆæš‚å­˜ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç°åœ¨æˆ‘ä»¬æƒ³æ”¾å¼ƒå·¥ä½œåŒºä¸­å¯¹è¯¥æ–‡ä»¶çš„æ›´æ”¹ï¼Œå¯ä»¥é€‰æ‹©å°†å…¶è¿˜åŸä¸ºæš‚å­˜åŒºä¸­çš„å†…å®¹ï¼Œå› ä¸ºæ­¤æ—¶æš‚å­˜åŒºä¸­çš„å†…å®¹å’Œ HEAD ç›¸åŒï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git restore main.py
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>è¿™åªæ˜¯æœ€åŸºç¡€çš„ç”¨æ³•ï¼Œè¿˜å¯ä»¥æŒ‡å®š &lt;code>--source&lt;/code> ä¸ºä»»æ„æäº¤ ID å°†æ–‡ä»¶è¿˜åŸä¸ºè¯¥æäº¤ä¸­çš„çŠ¶æ€ã€‚&lt;/p>
&lt;p>&lt;code>git restore [--source=&amp;lt;tree-ish&amp;gt;] --staged &amp;lt;pathspec&amp;gt;...&lt;/code> å’Œ &lt;code>git reset [&amp;lt;tree-ish&amp;gt;] &amp;lt;pathspec&amp;gt;&lt;/code> åœ¨ä½¿ç”¨ä¸Šæ˜¯ç­‰ä»·çš„ã€‚è¾ƒæ–°ç‰ˆæœ¬çš„ Git ä¼šåœ¨å‘½ä»¤è¡Œä¸­æç¤ºä½¿ç”¨ &lt;code>restore&lt;/code> å‘½ä»¤æ¥å–æ¶ˆæš‚å­˜æˆ–ä¸¢å¼ƒå·¥ä½œåŒºçš„æ”¹åŠ¨ã€‚&lt;/p>
&lt;h3 id="git-switch">git switch&lt;/h3>
&lt;p>&lt;code>git switch&lt;/code> å‘½ä»¤ä¸“é—¨ç”¨äºåˆ‡æ¢åˆ†æ”¯ï¼Œå¯ä»¥ç”¨æ¥æ›¿ä»£ &lt;code>checkout&lt;/code> çš„éƒ¨åˆ†ç”¨é€”ã€‚&lt;/p>
&lt;p>åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯ï¼ˆ &lt;code>-C&lt;/code> å¤§å°å†™çš†å¯ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git switch -C &amp;lt;new-branch&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åˆ‡æ¢åˆ°å·²æœ‰åˆ†æ”¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git switch &amp;lt;branch&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å’Œ &lt;code>checkout&lt;/code> ä¸€æ ·ï¼Œ &lt;code>switch&lt;/code> å¯¹å·¥ä½œåŒºæ˜¯å®‰å…¨çš„ï¼Œå®ƒä¼šå°è¯•åˆå¹¶å·¥ä½œåŒºå’Œæš‚å­˜åŒºä¸­çš„æœ¬åœ°æ›´æ”¹ï¼Œå¦‚æœæ— æ³•å®Œæˆåˆå¹¶åˆ™ä¼šä¸­æ­¢æ“ä½œï¼Œæœ¬åœ°æ›´æ”¹ä¼šè¢«ä¿ç•™ã€‚&lt;/p>
&lt;p>&lt;code>switch&lt;/code> çš„ä½¿ç”¨æ–¹å¼ç®€å•ä¸”ä¸“ä¸€ï¼Œå®ƒæ— æ³•åƒ &lt;code>checkout&lt;/code> ä¸€æ ·å¯¹æŒ‡å®šæäº¤ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ git switch ea4c48a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">fatal: æœŸæœ›ä¸€ä¸ªåˆ†æ”¯ï¼Œå¾—åˆ°æäº¤ &lt;span class="s1">&amp;#39;ea4c48a&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ">å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ&lt;/h2>
&lt;h3 id="æ’¤é”€æœ¬åœ°åˆ†æ”¯æäº¤">æ’¤é”€æœ¬åœ°åˆ†æ”¯æäº¤&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>git reset&lt;/code> ï¼Œå–å†³äºä½ æ˜¯å¦éœ€è¦ä¿ç•™è¯¥æäº¤ä¹‹åçš„æ›´æ”¹ï¼Œæ·»åŠ  &lt;code>--soft&lt;/code> ã€&lt;code>â€”hard&lt;/code> ç­‰é€‰é¡¹ã€‚&lt;/p>
&lt;h3 id="å›æ»šè¿œç¨‹ä¸»å¹²åˆ†æ”¯ä¸Šçš„æäº¤">å›æ»šè¿œç¨‹ä¸»å¹²åˆ†æ”¯ä¸Šçš„æäº¤&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>git revert&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ä¿®æ”¹ä¸Šä¸€æ¬¡æäº¤çš„å†…å®¹">ä¿®æ”¹ä¸Šä¸€æ¬¡æäº¤çš„å†…å®¹&lt;/h3>
&lt;p>å¦‚æœè¯¥æäº¤è¿˜æœªè¿›å…¥å…¬å…±åˆ†æ”¯ï¼Œæœ€ç›´æ¥çš„æ–¹å¼æ˜¯ä½¿ç”¨ &lt;code>git commit --amend&lt;/code>ã€‚å¦‚æœè¯¥æäº¤å·²ç»ä½äºå…¬å…±åˆ†æ”¯ï¼Œåº”è¯¥ä½¿ç”¨ &lt;code>git revert&lt;/code>ã€‚&lt;/p>
&lt;h3 id="æš‚å­˜æ›´æ”¹åå†æ¢å¤">æš‚å­˜æ›´æ”¹åå†æ¢å¤&lt;/h3>
&lt;p>ä¸€ä¸ªå¾ˆå¸¸è§çš„åœºæ™¯æ˜¯ï¼Œæˆ‘ä»¬åœ¨å½“å‰åˆ†æ”¯ä¿®æ”¹äº†ä¸€äº›æ–‡ä»¶ï¼Œä½†è¿˜ä¸è¶³ä»¥ç»„ç»‡æˆæäº¤æˆ–è€…åŒ…å«äº†å¤šä¸ªæäº¤çš„å†…å®¹ï¼Œçªç„¶æœ‰ç´§æ€¥æƒ…å†µéœ€è¦å¼€å§‹ä¸€é¡¹æ–°çš„ä»»åŠ¡ï¼Œæ­¤æ—¶æˆ‘ä»¬å¸Œæœ›å¯ä»¥å°†å·¥ä½œåŒºå’Œæš‚å­˜åŒºçš„æœ¬åœ°æ›´æ”¹æš‚æ—¶ä¿å­˜èµ·æ¥ï¼Œä»¥å¤‡åœ¨å…¶ä»–å·¥ä½œå®Œæˆåå¯ä»¥ä»è¿™é‡Œç»§ç»­ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å½“ç„¶å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„åˆ†æ”¯ç„¶åé‡ç½®æˆ–åˆå¹¶æ¥å®ç°ç›®çš„ï¼Œä½†é‚£æ ·å¤æ‚è€Œç¹çã€‚è€Œ &lt;code>git stash&lt;/code> å‘½ä»¤åˆ™å¯ä»¥å¾ˆå¥½çš„æ»¡è¶³éœ€æ±‚ï¼Œå®ƒä¼šå°†æœ¬åœ°æ›´æ”¹ä¿å­˜èµ·æ¥ï¼Œå¹¶å°†å·¥ä½œåŒºå’Œæš‚å­˜åŒºæ¢å¤åˆ°ä¸ HEAD æäº¤ç›¸åŒ¹é…çš„çŠ¶æ€ã€‚æ­¤æ—¶æˆ‘ä»¬å¯ä»¥åˆ‡æ¢åˆ°å…¶ä»–åˆ†æ”¯æˆ–è€…ç»§ç»­åœ¨å½“å‰åˆ†æ”¯å®Œæˆå…¶ä»–ä»»åŠ¡ï¼Œä¹‹åå†å°†æš‚å­˜çš„å†…å®¹å–å›ã€‚&lt;/p>
&lt;p>&lt;code>git stash&lt;/code> çš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ä¿å­˜å½“å‰æ›´æ”¹ï¼ˆæ·»åŠ  -u é€‰é¡¹ä»¥åŒ…æ‹¬æœªè·Ÿè¸ªçš„æ–°æ–‡ä»¶ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git stash -u
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å®Œæˆå…¶ä»–ä»»åŠ¡......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æ¢å¤æš‚å­˜çš„æ›´æ”¹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git stash pop
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>stash&lt;/code> çš„å®è´¨ä¹Ÿæ˜¯å°†æœ¬åœ°æ›´æ”¹ä¿å­˜ä¸ºä¸€æ¬¡æ–°çš„æäº¤ï¼Œç„¶åå†å°†è¯¥æäº¤æ¢å¤åˆ°å·¥ä½œåŒºå’Œæš‚å­˜åŒºï¼Œä½†å®ƒä¸ä¼šå½±å“å½“å‰çš„æäº¤å†å²ã€‚&lt;code>stash&lt;/code> è¿˜æœ‰æ›´å¤šè¿›é˜¶ç”¨æ³•ï¼Œæ¯”å¦‚æŒ‡å®šæš‚å­˜çš„æ–‡ä»¶è·¯å¾„ã€æš‚å­˜å¤šæ¬¡å¹¶æ‹©ä¸€æ¢å¤ç­‰ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>åœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬é¦–å…ˆäº†è§£äº†ä¸€äº›å¿…è¦çš„ Git å†…éƒ¨æœºåˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ &lt;code>blob&lt;/code> ã€&lt;code>tree&lt;/code> å’Œæäº¤å¯¹è±¡ç­‰å†…éƒ¨å¯¹è±¡ä¿å­˜æ•°æ®ï¼Œæ¯æ¬¡æäº¤éƒ½æ˜¯ä¸€ä»½å®Œæ•´çš„æ–‡ä»¶å¿«ç…§ã€‚&lt;/li>
&lt;li>SHA-1 IDã€åˆ†æ”¯å¼•ç”¨åŠ HEAD çš„å®è´¨ã€‚&lt;/li>
&lt;li>ç®¡ç†ä¸‰æ£µæ ‘çš„çŠ¶æ€ï¼šå·¥ä½œåŒºã€æš‚å­˜åŒºã€æäº¤å†å²ã€‚&lt;/li>
&lt;li>åˆ›å»ºä¸€æ¬¡æäº¤çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç„¶åé€šè¿‡ç¤ºä¾‹åˆ†åˆ«ä»‹ç»äº† &lt;code>checkout&lt;/code> ã€&lt;code>reset&lt;/code> å’Œ &lt;code>revert&lt;/code> çš„åŸºæœ¬ç”¨æ³•ä¸åŒºåˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>checkout&lt;/code>
&lt;ul>
&lt;li>ä¸å¸¦è·¯å¾„ï¼šå°†å·¥ä½œåŒºã€æš‚å­˜åŒºæ›´æ–°ä¸ºæŒ‡å®šæäº¤çš„çŠ¶æ€ï¼Œä½†ä¼šä¿ç•™æœ¬åœ°æ›´æ”¹ã€‚&lt;/li>
&lt;li>å¸¦è·¯å¾„ï¼šå°†æŒ‡å®šæ–‡ä»¶æ›´æ–°ä¸ºæŒ‡å®šæäº¤çš„çŠ¶æ€ï¼Œä¸ä¼šä¿ç•™æœ¬åœ°æ›´æ”¹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>reset&lt;/code>
&lt;ul>
&lt;li>&lt;code>â€”soft&lt;/code>ï¼šä»…å°† HEAD åŠå…¶æŒ‡å‘çš„åˆ†æ”¯å¼•ç”¨ç§»åŠ¨åˆ°æŒ‡å®šæäº¤ã€‚&lt;/li>
&lt;li>&lt;code>â€”mixed&lt;/code>ï¼šé™¤äº†æ›´æ”¹æäº¤å†å²ï¼Œè¿˜å°†æš‚å­˜åŒºä¹Ÿæ›´æ–°ä¸ºæŒ‡å®šæäº¤çš„å†…å®¹ã€‚&lt;/li>
&lt;li>&lt;code>â€”hard&lt;/code>ï¼šé™¤äº†æ›´æ”¹æäº¤å†å²å’Œæš‚å­˜åŒºï¼Œè¿˜å°†å·¥ä½œåŒºä¹Ÿæ›´æ–°ä¸ºæŒ‡å®šæäº¤çš„å†…å®¹ï¼Œå·¥ä½œåŒºçš„æœ¬åœ°æ›´æ”¹ä¼šæ°¸ä¹…ä¸¢å¤±ã€‚&lt;/li>
&lt;li>å¯¹æ–‡ä»¶è·¯å¾„ä½¿ç”¨å¯ä»¥å°†æ–‡ä»¶å–æ¶ˆæš‚å­˜ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;code>revert&lt;/code>
&lt;ul>
&lt;li>åˆ›å»ºä¸€ä¸ªæ–°çš„æäº¤ä»¥æ’¤é”€æŒ‡å®šæäº¤å¼•å…¥çš„æ›´æ”¹ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>è¿˜ä»‹ç»äº†ä¸¤ä¸ªæ–°ç‰ˆæœ¬å¼•å…¥çš„æ›´ä¸“ä¸€çš„å‘½ä»¤ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>restore&lt;/code>ï¼šå°†å·¥ä½œåŒºæˆ–æš‚å­˜åŒºçš„æŒ‡å®šæ–‡ä»¶è¿˜åŸä¸ºæŒ‡å®šæäº¤æ—¶çš„çŠ¶æ€ã€‚&lt;/li>
&lt;li>&lt;code>switch&lt;/code>ï¼šåˆ‡æ¢åˆ°å·²æœ‰åˆ†æ”¯æˆ–è€…åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>æœ€åç»™å‡ºäº†ä¸€äº›å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå¹¶ä»‹ç»äº† &lt;code>git stash&lt;/code> çš„ç”¨æ³•ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E9%87%8D%E7%BD%AE%E6%8F%AD%E5%AF%86#_git_reset">Git å·¥å…· - é‡ç½®æ­å¯†&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%92%A4%E6%B6%88%E6%93%8D%E4%BD%9C">Git åŸºç¡€ - æ’¤æ¶ˆæ“ä½œ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.atlassian.com/git/tutorials/undoing-changes">Undoing Commits &amp;amp; Changes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/blue-harvest-tech-blog/git-2-23-0-forget-about-checkout-and-switch-to-restore-ac2682b737b3">Git 2.23.0: Forget about checkout, and switch to restore&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%BC%95%E7%94%A8">Git å†…éƒ¨åŸç† - Git å¼•ç”¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/hackernoon/understanding-git-index-4821a0765cf">Understanding Git â€” Index&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.blog/2020-12-17-commits-are-snapshots-not-diffs/">Commits are snapshots, not diffs&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://shafiul.github.io//gitbook/7_the_git_index.html">The Git Index&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mincong.io/2018/04/28/git-index/#:~:text=The%20index%20is%20a%20binary,Git%3A%20they%20are%20used%20interchangeably.">Git: Understanding the Index File&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tom.preston-werner.com/2009/05/19/the-git-parable.html">The Git Parable&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/git/" term="Git" label="Git"/></entry><entry><title type="text">æ„å»ºä¿éšœä»£ç è´¨é‡çš„è‡ªåŠ¨åŒ–å·¥ä½œæµ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/build-automatic-code-quality-workflow/"/><id>https://waynerv.com/posts/build-automatic-code-quality-workflow/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2021-01-04T11:28:01+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">ä»£ç è´¨é‡æ˜¯ç¨‹åºå‘˜çš„èŒä¸šåº•çº¿ï¼Œç»´æŠ¤åº•çº¿ä¸èƒ½å…¨é è‡ªè§‰ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•å°† flake8ã€blackã€pre-commit ç­‰å·¥å…·é›†æˆåˆ°æ—¥å¸¸çš„å·¥ä½œæµä¸­ï¼Œçœå¿ƒçœåŠ›çš„æŒç»­ä¿éšœä»£ç è´¨é‡ã€‚</summary><content type="html">&lt;p>åœ¨æˆ‘çœ‹æ¥ï¼Œä»£ç è´¨é‡å°±æ˜¯ç¨‹åºå‘˜çš„èŒä¸šåº•çº¿ã€‚ç»´æŠ¤åº•çº¿ä¸èƒ½å…¨é è‡ªè§‰ï¼Œå› æ­¤æœ¬æ–‡å°†ä»‹ç»å‡ ç§è‡ªåŠ¨åŒ–çš„å·¥å…·ï¼Œå¹¶å±•ç¤ºå¦‚ä½•å°†å®ƒä»¬é›†æˆåˆ°æ—¥å¸¸çš„å·¥ä½œæµä¸­ï¼Œçœå¿ƒçœåŠ›çš„æŒç»­ä¿éšœä»£ç è´¨é‡ã€‚&lt;/p>
&lt;h2 id="linter">Linter&lt;/h2>
&lt;p>Linter æ˜¯ä¸€ç±»ç”¨äºæ ‡è®°ç¨‹åºé”™è¯¯ã€bugã€é£æ ¼é”™è¯¯å’Œå¯ç–‘ç»“æ„çš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œæ¯”å¦‚ Python ä¸­çš„ &lt;code>Pylint&lt;/code>ã€ &lt;code>flake8&lt;/code>ï¼ŒJavaScript ä¸­çš„ &lt;code>EsLint&lt;/code>ï¼Œè¿™ç±»å·¥å…·ä¼šæ‰¾åˆ°ä½ ä»£ç ä¸­çš„é”™è¯¯ï¼Œå¹¶ç»™å‡ºå¦‚ä½•ä¿®å¤çš„æç¤ºã€‚&lt;/p>
&lt;h3 id="ä¸ºä½•è¦ä½¿ç”¨-linter">ä¸ºä½•è¦ä½¿ç”¨ Linter&lt;/h3>
&lt;p>äººæ€»æ˜¯ä¼šç²—å¿ƒå’ŒçŠ¯é”™ï¼Œå€ŸåŠ© Linter æˆ‘ä»¬å¯ä»¥å‘ç°ä»£ç ä¸­ä¸æ˜“å¯Ÿè§‰æˆ–é—æ¼çš„é”™è¯¯ï¼Œå¹¶è¿›è¡Œçº æ­£ã€‚ä½¿ç”¨ Linter æœ‰ä»¥ä¸‹å¥½å¤„ï¼š&lt;/p>
&lt;ul>
&lt;li>æ ¹æ® &lt;a href="https://www.python.org/dev/peps/pep-0008/">PEP8&lt;/a> ç­‰è¯­è¨€è§„èŒƒæŒç»­çš„æç¤ºä¸çº æ­£ï¼Œå¸®åŠ©ä½ å†™å‡ºæ›´å¥½çš„ä»£ç &lt;/li>
&lt;li>å‡å°‘ä»£ç ä¸­çš„æ ¼å¼é”™è¯¯ã€ç¬”è¯¯åŠç³Ÿç³•çš„é£æ ¼ç­‰ä½çº§é”™è¯¯&lt;/li>
&lt;li>èŠ‚çœå›¢é˜Ÿæˆå‘˜ review ä½ ä»£ç çš„æ—¶é—´ï¼Œæé«˜åä½œæ•ˆç‡&lt;/li>
&lt;li>é…ç½®ç®€å•ï¼Œä»…éœ€å‡ æ­¥å³å¯ä¸Šæ‰‹&lt;/li>
&lt;/ul>
&lt;h3 id="flake8-ä½¿ç”¨ç¤ºä¾‹">&lt;code>flake8&lt;/code> ä½¿ç”¨ç¤ºä¾‹&lt;/h3>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬ä»¥ Python ä¸­çš„ &lt;code>flake8&lt;/code> ä¸ºä¾‹ï¼Œä»‹ç»å…¶ç”¨æ³•ã€‚&lt;/p>
&lt;p>é¦–å…ˆé€šè¿‡ &lt;code>pip&lt;/code> å®‰è£… &lt;code>flake8&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pip install flake8
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>flake8&lt;/code> çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œç›´æ¥ä»¥éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶æˆ–æ•´ä¸ªç›®å½•çš„è·¯å¾„ä½œä¸º &lt;code>flake8&lt;/code> å‘½ä»¤çš„å‚æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ flake8 . &lt;span class="c1"># æ£€æŸ¥å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./__init__.py:4:1: E402 module level import not at top of file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./__init__.py:4:1: F401 &lt;span class="s1">&amp;#39;.md_toc.main&amp;#39;&lt;/span> imported but unused
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./__init__.py:4:25: W292 no newline at end of file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./md_toc.py:6:18: E999 SyntaxError: non-default argument follows default argument
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./md_toc.py:28:80: E501 line too long &lt;span class="o">(&lt;/span>&lt;span class="m">108&lt;/span> &amp;gt; &lt;span class="m">79&lt;/span> characters&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./md_toc.py:48:80: E501 line too long &lt;span class="o">(&lt;/span>&lt;span class="m">113&lt;/span> &amp;gt; &lt;span class="m">79&lt;/span> characters&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¿è¡Œç»“æœä¸­ï¼Œ &lt;code>flake8&lt;/code> ä¸ä»…æŒ‡å‡ºäº†å…·ä½“çš„é”™è¯¯åŸå› ï¼Œè¿˜ç»™å‡ºäº†å‡ºé”™çš„æ–‡ä»¶ä½ç½®åŠä»£ç æ‰€åœ¨è¡Œæ•°ã€‚&lt;/p>
&lt;p>æ›´å¤šå…¶ä»–çš„é€‰é¡¹å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è·å–å¸®åŠ©ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ flake8 --help
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>flake8&lt;/code> çš„å¯è‡ªå®šä¹‰ç¨‹åº¦å¾ˆé«˜ï¼Œé™¤äº†åœ¨è¿è¡Œæ—¶æ·»åŠ å‘½ä»¤é€‰é¡¹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶æ¥è‡ªå®šä¹‰æ£€æŸ¥è§„åˆ™ã€‚æ–¹æ³•æ˜¯åœ¨è¿è¡Œ &lt;code>flake8&lt;/code> çš„é¡¹ç›®æ ¹ç›®å½•æ·»åŠ  &lt;code>.flake8&lt;/code> æ–‡ä»¶ï¼Œå¹¶å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[flake8]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">max-line-length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">120 # é€‚å½“æé«˜æœ€å¤§è¡Œé•¿åº¦&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">max-complexity&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">24 # è®¾ç½®æœ€å¤§å¤æ‚åº¦ä¸º24&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">ignore&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">F401, W503, E203 # å¿½ç•¥è¿™äº›é”™è¯¯ç±»å‹&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">exclude&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s"># å¿½ç•¥ä»¥ä¸‹æ–‡ä»¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> .git,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> __pycache__,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> scripts,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> logs,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> upload,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> build,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> dist,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> docs,
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s"> migrations&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>flake8&lt;/code> è¿˜å¯ä»¥æ·»åŠ æ’ä»¶å®ç°æ›´å¤šæ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³å¼ºåˆ¶è¦æ±‚ç¼–å†™å‡½æ•° &lt;code>docstring&lt;/code>ï¼Œå¯ä»¥å®‰è£… &lt;code>flake8-docstrings&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pip install flake8-docstrings
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é‡æ–°è¿è¡Œæ£€æŸ¥åï¼Œä¼šå‘ç°ç»“æœä¸­å¤šå‡ºäº†å¦‚ä¸‹é”™è¯¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">./__init__.py:1:1: D104 Missing docstring in public package
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">./md_toc.py:6:1: D103 Missing docstring in public &lt;span class="k">function&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ›´å¤šå…¶ä»–åŠŸèƒ½å’Œæ’ä»¶å¯æŸ¥çœ‹ &lt;code>flake8&lt;/code> çš„&lt;a href="https://flake8.pycqa.org/en/latest/index.html">æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>é™¤äº† &lt;code>flake8&lt;/code> ä»¥å¤–ï¼ŒPython è¿˜æœ‰ä»¥ä¸‹ Linter å¯ä¾›é€‰æ‹©ï¼Œå®ƒä»¬çš„ç”¨æ³•å¤§åŒå°å¼‚ï¼Œä½†åœ¨æ£€æŸ¥èŒƒå›´ã€å®¹å¿åº¦ç­‰æ–¹é¢æœ‰æ‰€åŒºåˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/PyCQA/pylint">Pylint&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/PyCQA/pyflakes">Pyflakes&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pypi.python.org/pypi/PyChecker">Pychecker&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pypi.python.org/pypi/pep8">Pep8&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="static-type-checker">Static Type Checker&lt;/h2>
&lt;p>Python ä» &lt;a href="https://www.python.org/dev/peps/pep-0484/">PEP 484&lt;/a> å¼•å…¥ &lt;code>Type Hints&lt;/code> ï¼ˆç±»å‹æç¤ºï¼‰ä»¥æ¥ï¼Œé…å¥—çš„å·¥å…·é“¾ç”Ÿæ€ä¹Ÿåœ¨é€æ¸æˆç†Ÿï¼Œå‡ºç°äº†å¦‚ &lt;code>mypy&lt;/code>ã€ &lt;code>pyright&lt;/code> ç­‰é™æ€ç±»å‹æ£€æŸ¥å·¥å…·ã€‚&lt;/p>
&lt;p>å®ƒä»¬å¯ä»¥æ ¹æ® Python ä»£ç ä¸­çš„ç±»å‹æç¤ºè¿›è¡Œé™æ€ç±»å‹æ£€æŸ¥ï¼Œä¸éœ€è¦è¿è¡Œç¨‹åºå°±å¯ä»¥æ‰¾åˆ°ç¨‹åºä¸­çš„é”™è¯¯ã€‚è€Œä¸”å¦‚æœæœ‰é—ç•™ä»£ç ä¸å¥½å¤„ç†ï¼Œè¿˜å¯ä»¥åœ¨ç¨‹åºä¸­æ··åˆä½¿ç”¨åŠ¨æ€å’Œé™æ€ç±»å‹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä»¥ &lt;code>mypy&lt;/code> åšç®€å•ç¤ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># test_mypy.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">greeting&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&amp;gt;&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="s1">&amp;#39;Hello &amp;#39;&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">greeting&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é€šè¿‡ &lt;code>pip&lt;/code> å®‰è£… &lt;code>mypy&lt;/code> :&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pip install mypy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹è¯¥æ–‡ä»¶è¿è¡Œæ£€æŸ¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ mypy test_mypy.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">test_mypy.py:4: error: Argument &lt;span class="m">1&lt;/span> to &lt;span class="s2">&amp;#34;greeting&amp;#34;&lt;/span> has incompatible &lt;span class="nb">type&lt;/span> &lt;span class="s2">&amp;#34;int&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> expected &lt;span class="s2">&amp;#34;str&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Found &lt;span class="m">1&lt;/span> error in &lt;span class="m">1&lt;/span> file &lt;span class="o">(&lt;/span>checked &lt;span class="m">1&lt;/span> &lt;span class="nb">source&lt;/span> file&lt;span class="o">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨æ£€æŸ¥ç»“æœä¸­ï¼Œ &lt;code>mypy&lt;/code> æç¤ºæˆ‘ä»¬åœ¨è°ƒç”¨ &lt;code>greeting()&lt;/code> æ—¶ä¼ å…¥çš„å‚æ•°ç±»å‹å‡ºé”™ã€‚&lt;/p>
&lt;h3 id="ç±»å‹æç¤ºå¸¦æ¥çš„å¥½å¤„">ç±»å‹æç¤ºå¸¦æ¥çš„å¥½å¤„&lt;/h3>
&lt;p>é™æ€ç±»å‹æ£€æŸ¥å·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬åƒé™æ€è¯­è¨€ä¸€æ ·åœ¨è¿è¡Œä»£ç ä¹‹å‰å°±æ•è·åˆ°æŸäº›é”™è¯¯ï¼Œä½†éœ€è¦æˆ‘ä»¬åœ¨ç¨‹åºä¸­åŠ å…¥å¤§é‡çš„ç±»å‹æç¤ºæ‰èƒ½å®Œæ•´å‘æŒ¥å…¶ä½œç”¨ã€‚è™½ç„¶ç¨å¾®åŠ å¤§äº†å·¥ä½œé‡ï¼Œä½†å¼•å…¥ç±»å‹æç¤ºè¿˜ä¼šå¸¦æ¥ä»¥ä¸‹å¥½å¤„ï¼š&lt;/p>
&lt;ul>
&lt;li>ç›¸æ¯”ä¼ ç»Ÿçš„Â &lt;a href="https://link.zhihu.com/?target=https%3A//realpython.com/documenting-python-code/">docstrings&lt;/a>ï¼Œç±»å‹æç¤ºé…åˆè‰¯å¥½çš„å‘½åæ—¢èƒ½ä½œä¸ºè§£é‡Šæ–‡æ¡£ï¼Œä¹Ÿèƒ½ç”¨äºè‡ªåŠ¨æ£€æŸ¥ã€‚&lt;/li>
&lt;li>å¯ä»¥ä½¿ IDE é€šè¿‡ç±»å‹æ¨æ–­æä¾›æ›´å¥½çš„ä»£ç è¡¥å…¨å’Œæç¤ºåŠŸèƒ½ã€‚&lt;/li>
&lt;li>å¼ºåˆ¶ä½ å»æ€è€ƒåŠ¨æ€è¯­è¨€ç¨‹åºçš„ç±»å‹å¯èƒ½ä¼šå¸®åŠ©ä½ æ„å»ºæ›´æ¸…æ™°çš„ä»£ç æ¶æ„ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="autoformatter">Autoformatter&lt;/h2>
&lt;p>Autoformatter ï¼ˆè‡ªåŠ¨æ ¼å¼åŒ–å™¨ï¼‰é¡¾åæ€ä¹‰æ˜¯å¯ä»¥å°†ä»£ç æŒ‰ç‰¹å®šè§„åˆ™è‡ªåŠ¨æ ¼å¼åŒ–çš„ä¸€ç±»å·¥å…·ã€‚Linter å¯ä»¥å¸®åŠ©æˆ‘ä»¬å‘ç°ä»£ç ä¸­çš„æ ¼å¼é”™è¯¯å’Œé£æ ¼é—®é¢˜ï¼Œä½†å¹¶ä¸ä¼šè‡ªåŠ¨çº æ­£ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å€ŸåŠ©è‡ªåŠ¨æ ¼å¼åŒ–å™¨ï¼Œè¿›ä¸€æ­¥å°†æˆ‘ä»¬ä»é‡å¤çç¢çš„æ‰‹åŠ¨ä¿®æ”¹ä¸­è§£æ”¾å‡ºæ¥ã€‚&lt;/p>
&lt;p>Python ä¸­æœ‰ &lt;code>black&lt;/code> ã€ &lt;code>yapf&lt;/code>ã€ &lt;code>autopep8&lt;/code>ã€ &lt;code>isort&lt;/code> ç­‰ä¼—å¤šæ ¼å¼åŒ–å·¥å…·ï¼Œé™¤äº†æ•´ä½“ä¸Šéµå¾ª PEP8 ä»¥å¤–ï¼Œå„è‡ªéƒ½æœ‰ä¸åŒçš„é£æ ¼è§„èŒƒå’Œé€‚ç”¨èŒƒå›´ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½è¿›è¡Œé€‰æ‹©ã€‚&lt;/p>
&lt;p>ä»¥ &lt;code>black&lt;/code> å’Œä¸‹é¢è¿™æ®µä»£ç ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># test_black.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span> &lt;span class="p">(&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span> &lt;span class="nb">int&lt;/span> &lt;span class="p">])&lt;/span> &lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">37&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">u&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="o">**&lt;/span>&lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">very_important_function&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">template&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">variables&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PathLike&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">debug&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="nb">bool&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="kc">False&lt;/span>&lt;span class="p">,):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Applies `variables` to the `template` and writes to `file`.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>é¦–å…ˆé€šè¿‡ &lt;code>pip&lt;/code> å®‰è£… &lt;code>black&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pip install black
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åå¯¹éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶æˆ–æ•´ä¸ªç›®å½•çš„è·¯å¾„æ‰§è¡Œ &lt;code>black&lt;/code> å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ black test_black.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reformatted /Users/waynerv/Repos/github-markdown-toc/gfm_toc/__init__.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reformatted /Users/waynerv/Repos/github-markdown-toc/gfm_toc/md_toc.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">All &lt;span class="k">done&lt;/span>! âœ¨ ğŸ° âœ¨
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> files reformatted.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>black&lt;/code> ä¼šé¦–å…ˆæ£€æŸ¥å‡ºä¸ç¬¦åˆå…¶è§„èŒƒçš„æ–‡ä»¶ï¼Œç„¶åç¼–è¾‘æ–‡ä»¶å®Œæˆä¿®æ”¹ï¼Œå¹¶è¾“å‡ºä¿®æ”¹çš„æ–‡ä»¶è·¯å¾„åŠæ•°é‡ã€‚æ ¼å¼åŒ–åçš„æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># test_black.py&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">f&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">a&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">List&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="mi">37&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">42&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">u&lt;/span> &lt;span class="p">:&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="o">**&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">very_important_function&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">template&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">*&lt;/span>&lt;span class="n">variables&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">os&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">PathLike&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">debug&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nb">bool&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;Applies `variables` to the `template` and writes to `file`.&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;w&amp;#34;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">f&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>black&lt;/code> å·ç§°ã€Œä¸å¦¥åçš„ä»£ç æ ¼å¼åŒ–å™¨ã€ï¼Œå…¶ä¸å¦¥åä½“ç°åœ¨åŸºæœ¬æ²¡æœ‰å¯ä¾›è‡ªå®šä¹‰çš„é€‰é¡¹ï¼Œè¦ä¹ˆå…¨ç›˜æ¥å—å®ƒçš„ä»£ç é£æ ¼ï¼Œè¦ä¹ˆå°±ä¸ç”¨å®ƒã€‚å¦‚æœä½ æˆ–è€…ä½ çš„å›¢é˜Ÿèƒ½å¤Ÿæ¥å—å®ƒçš„é£æ ¼ï¼Œä½¿ç”¨ &lt;code>black&lt;/code> å¯ä»¥èŠ‚çœå¾ˆå¤šèŠ±åœ¨ä»£ç é£æ ¼ä¸Šçš„ç²¾åŠ›å’Œæ—¶é—´ï¼ˆå†ä¹Ÿä¸ç”¨äº‰è®ºæŸç§é£æ ¼å­°ä¼˜å­°åŠ£äº†ï¼‰ã€‚&lt;/p>
&lt;p>å®è·µä¸­æˆ‘ä»¬å¯ä»¥å¯¹æœ€å¤§è¡Œé•¿åº¦ä»¥åŠå¼•å·æ ¼å¼åŒ–é€‰é¡¹åšä¸€äº›è°ƒæ•´ï¼Œæ–¹æ³•æ˜¯åœ¨æ‰§è¡Œ &lt;code>black&lt;/code> çš„é¡¹ç›®æ ¹ç›®å½•æ·»åŠ  &lt;code>pyproject.tomal&lt;/code> æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹å†…å®¹:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-ini" data-lang="ini">&lt;span class="line">&lt;span class="cl">&lt;span class="k">[tool.black]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">line-length&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">120&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="na">skip-string-normalization&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="s">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ide-çš„è‡ªå¸¦å·¥å…·">IDE çš„è‡ªå¸¦å·¥å…·&lt;/h3>
&lt;p>ç°ä»£çš„ IDE å’Œç¼–è¾‘å™¨åŸºæœ¬éƒ½ä¼šè‡ªå¸¦ Linter å’Œæ ¼å¼åŒ–ç­‰åŠŸèƒ½ï¼Œæ¯”å¦‚ &lt;code>PyCharm&lt;/code> å°±å¯ä»¥é€šè¿‡ &lt;code>âŒ¥ âŒ˜ L&lt;/code> å¿«æ·é”®æ ¼å¼åŒ–å½“å‰æ–‡ä»¶çš„ä»£ç ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬è¿˜æœ‰å¿…è¦æ‰‹åŠ¨é›†æˆè¿™äº›ç¬¬ä¸‰æ–¹å·¥å…·å—ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯æœ‰å¿…è¦ï¼Œæˆ‘ä»¬ä»¥ç¬¬ä¸‰æ–¹å’Œ IDE è‡ªå¸¦çš„ä»£ç å·¥å…·ä½œå¯¹æ¯”ï¼š&lt;/p>
&lt;ul>
&lt;li>è‡ªå¸¦å·¥å…·å¯¹ç¯å¢ƒä¾èµ–ç¨‹åº¦å¾ˆé«˜ï¼Œå¿…é¡»è¦æœ‰ç‰¹å®šçš„äºŒè¿›åˆ¶åŒ…åŠé…ç½®æ–‡ä»¶æ‰èƒ½æ‰§è¡Œï¼›è€Œä½¿ç”¨ä¸é¡¹ç›®ç›¸åŒè¯­è¨€å®ç°çš„ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¯ä»¥ç›´æ¥ä½œä¸ºé¡¹ç›®çš„å¼€å‘ä¾èµ–ï¼Œé…ç½®ä¹Ÿèƒ½å¾ˆæ–¹ä¾¿åœ°æ•´åˆåˆ°é¡¹ç›®æœ¬èº«çš„é…ç½®æ–‡ä»¶ä¸­ï¼ˆå¦‚&lt;code>pyproject.toml&lt;/code>ã€&lt;code>tox.ini&lt;/code>ç­‰ï¼‰ï¼Œä¸”é€šå¸¸éƒ½å¯ä»¥å¾ˆå¿«åœ°é›†æˆåˆ°ä¸åŒ IDE ä¸­ã€‚&lt;/li>
&lt;li>è‡ªå¸¦å·¥å…·åªèƒ½åœ¨ IDE çš„å›¾å½¢ç•Œé¢ä¸­æ‰‹åŠ¨æ‰§è¡Œï¼›è€Œç¬¬ä¸‰æ–¹å·¥å…·åªè¦æœ‰åŸºç¡€çš„ä»£ç è¿è¡Œç¯å¢ƒå°±å¯ä»¥æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æŠŠå®ƒä»¬å¾ˆæ–¹ä¾¿çš„é›†æˆåˆ° Hooksã€CI ä¸­è‡ªåŠ¨åŒ–æ‰§è¡Œã€‚&lt;/li>
&lt;li>è‡ªå¸¦å·¥å…·å¹¶ä¸ä¸€å®šä¸¥æ ¼éµå¾ª PEP8 ç­‰é€šç”¨è§„èŒƒï¼Œè€Œä¸”ä¸æ–¹ä¾¿åœ¨åä½œæˆå‘˜ä¸­åˆ†äº«é…ç½®ï¼Œè¯è¯´å›æ¥ï¼Œå‡å¦‚ä½ ç”¨ &lt;code>PyCharm&lt;/code> ä½†ä½ çš„åŒäº‹ç”¨ &lt;code>VSCode&lt;/code> å‘¢ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;p>åœ¨æ¥ä¸‹æ¥çš„ Hooks å’Œ Pipeline ä¸¤èŠ‚å†…å®¹ä¸­ï¼Œä½ å°†è¿›ä¸€æ­¥è®¤è¯†åˆ°é›†æˆç¬¬ä¸‰æ–¹å·¥å…·å¸¦æ¥çš„ä¼˜åŠ¿ã€‚&lt;/p>
&lt;h2 id="hooks">Hooks&lt;/h2>
&lt;p>åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬ä»‹ç»äº†å¾ˆå¤šä¿éšœè´¨é‡çš„å·¥å…·ï¼Œä½†åœ¨æ—¥å¸¸ç¼–ç ä¸­ï¼Œæˆ‘ä»¬æ€»ä¸èƒ½æ¯ä¸€æ¬¡æäº¤ä»£ç å‰ï¼Œéƒ½æŠŠè¿™äº›å·¥å…·æ‰‹åŠ¨æ‰§è¡Œä¸€éå§ï¼Ÿè¿™çœ‹ä¸Šå»ä¸æ˜¯é«˜æ•ˆçš„åšæ³•ï¼Œåº†å¹¸åœ°æ˜¯æˆ‘ä»¬æœ‰ç°æˆé€”å¾„è§£å†³è¿™äº›é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="git-hooks">Git Hooks&lt;/h3>
&lt;p>Git å¯ä»¥åœ¨ä»“åº“ä¸­å‘ç”Ÿç‰¹å®šäº‹ä»¶æ—¶è‡ªåŠ¨è¿è¡Œè‡ªå®šä¹‰çš„è„šæœ¬ï¼Œè¿™äº›è‡ªå®šä¹‰è„šæœ¬å³ç§°ä¸º &lt;code>hooks&lt;/code>ã€‚ å®ƒä»¬è®©ä½ å¯ä»¥åœ¨å¼€å‘å‘¨æœŸçš„å…³é”®ç‚¹è§¦å‘å¯å®šåˆ¶çš„åŠ¨ä½œï¼Œæ¯”å¦‚æ¯æ¬¡æ‰§è¡Œæäº¤å‰éƒ½æ‰§è¡Œä¸€æ¬¡ &lt;code>flake8&lt;/code> å‘½ä»¤ã€‚å¤§éƒ¨åˆ†å…¶ä»–çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¹Ÿä¼šæä¾›ç±»ä¼¼çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>&lt;code>hooks&lt;/code> ä¿å­˜åœ¨ Git ä»“åº“çš„ &lt;code>.git/hooks&lt;/code> ç›®å½•ä¸­ï¼Œå®ƒå¯ä»¥æ˜¯æ™®é€šçš„ shell è„šæœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯ Pythonã€Ruby ç­‰è¯­è¨€çš„å¯æ‰§è¡Œè„šæœ¬ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†å¸¸ç”¨å·¥å…·é›†æˆåˆ° &lt;code>hooks&lt;/code> ä¸­ã€‚ &lt;code>hooks&lt;/code> é€šå¸¸æŒ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œå¸¸ç”¨çš„å®¢æˆ·ç«¯ç±»æœ‰ &lt;code>pre-commit&lt;/code> ã€ &lt;code>prepare-commit-msg&lt;/code>ã€ &lt;code>commit-msg&lt;/code>ã€ &lt;code>post-commit&lt;/code>ã€ &lt;code>pre-rebase&lt;/code> ç­‰ &lt;code>hooks&lt;/code>ï¼Œå®ƒä»¬åˆ†åˆ«åœ¨åç§°æ‰€ä»£è¡¨çš„äº‹ä»¶è§¦å‘æ—¶è¿è¡Œã€‚&lt;/p>
&lt;p>ä»¥ &lt;code>pre-commit&lt;/code> ä¸ºä¾‹ï¼Œè¯¥ &lt;code>hooks&lt;/code> åœ¨è¾“å…¥æäº¤ä¿¡æ¯å‰è¿è¡Œã€‚ å®ƒå¯ä»¥æ£€æŸ¥å³å°†æäº¤çš„å¿«ç…§ï¼Œå¦‚æœè¯¥ &lt;code>hooks&lt;/code> ä»¥éé›¶å€¼é€€å‡ºï¼ŒGit å°†æ”¾å¼ƒæ­¤æ¬¡æäº¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å®ƒæ¥æ£€æŸ¥æäº¤çš„ä»£ç é£æ ¼æ˜¯å¦æ­£ç¡®ï¼ˆè¿è¡Œä¾‹å¦‚ &lt;code>flake8&lt;/code>ã€ &lt;code>black&lt;/code> ç­‰ç¨‹åºï¼‰ã€æ˜¯å¦å¼•å…¥å®‰å…¨é£é™©ç­‰ç­‰ã€‚æ•´ä¸ªæµç¨‹ç¤ºæ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-pre-commit-workflow.png" alt="2020-01-04-pre-commit-workflow">&lt;/p>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†å±•ç¤ºï¼Œå¦‚ä½•å°†ä¸Šæ–‡ä»‹ç»çš„ä¼—å¤šå·¥å…·å¿«é€Ÿåœ°é›†æˆåˆ° &lt;code>pre-commit hooks&lt;/code> ä¸­ã€‚&lt;/p>
&lt;h3 id="pre-commit">pre-commit&lt;/h3>
&lt;p>&lt;code>pre-commit&lt;/code> æ˜¯ä¸€ä¸ªç”¨äºç®¡ç†å’Œç»´æŠ¤å¤šç§è¯­è¨€ &lt;code>pre-commit hooks&lt;/code> çš„æ¡†æ¶ï¼Œå°±åƒ Python çš„åŒ…ç®¡ç†å™¨ &lt;code>pip&lt;/code> ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>pre-commit&lt;/code> å°†ä»–äººåˆ›å»ºå¹¶åˆ†äº«çš„ &lt;code>pre-commit hooks&lt;/code> å®‰è£…åˆ°è‡ªå·±çš„é¡¹ç›®ä»“åº“ä¸­ã€‚ &lt;code>pre-commit&lt;/code> å¤§å¤§å‡å°‘äº†æˆ‘ä»¬ä½¿ç”¨ &lt;code>git hooks&lt;/code> çš„éš¾åº¦ï¼Œä½ åªéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæƒ³è¦çš„ &lt;code>hooks&lt;/code>ï¼Œå®ƒä¼šæ›¿ä½ å®‰è£…ä»»æ„è¯­è¨€ç¼–å†™çš„ &lt;code>hooks&lt;/code> å¹¶è§£å†³ç¯å¢ƒä¾èµ–é—®é¢˜ï¼Œç„¶ååœ¨æ¯æ¬¡æäº¤å‰æ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;code>pre-commit&lt;/code> çš„ç®€å•ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é€šè¿‡ &lt;code>pip&lt;/code> å®‰è£… &lt;code>pre-commit&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pip install pre-commit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>pre-commit&lt;/code> æ˜¯é¢å‘å¤šè¯­è¨€çš„ï¼Œå› æ­¤å®ƒè¿˜æ”¯æŒé€šè¿‡ &lt;code>homebrew&lt;/code> ç­‰æ–¹å¼å®‰è£…ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ·»åŠ é…ç½®æ–‡ä»¶ã€‚&lt;/p>
&lt;p>ä½ éœ€è¦åˆ›å»ºä¸€ä¸ªåä¸º &lt;code>.pre-commit-config.yml&lt;/code> çš„æ–‡ä»¶ï¼Œé€šå¸¸æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­æˆ‘ä»¬æŒ‰ç‰¹å®šæ ¼å¼æ·»åŠ éœ€è¦è¿è¡Œçš„ &lt;code>hooks&lt;/code> å¹¶æŒ‡å®šå‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">repos&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/psf/black&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">20.&lt;/span>&lt;span class="l">8b1&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">black&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">language_version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">python3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">^migrations/|^uploads/|^scripts/|^logs/|^docs/|^dist/|^build/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/pycqa/flake8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">3.8.4&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">flake8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">exclude&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">^migrations/|^uploads/|^scripts/|^logs/|^docs/|^dist/|^build/&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">repo&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">https://github.com/pre-commit/pre-commit-hooks&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">rev&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">v3.3.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hooks&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">id&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">check-added-large-files&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">args&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="w"> &lt;/span>--&lt;span class="l">maxkb=512 ]&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¯¥ç¤ºä¾‹æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº† &lt;code>black&lt;/code> ã€ &lt;code>flake8&lt;/code> ä»¥åŠä¸€ä¸ªæ£€æŸ¥æ˜¯å¦æ·»åŠ äº†å¤§ä½“ç§¯æ–‡ä»¶åˆ° Git çš„ &lt;code>hooks&lt;/code>ï¼Œè¿˜åˆ†åˆ«æŒ‡å®šäº†è¯­è¨€ç‰ˆæœ¬ã€è·³è¿‡æ£€æŸ¥è·¯å¾„ç­‰é€‰é¡¹ã€‚&lt;/p>
&lt;p>é…ç½®æ–‡ä»¶çš„é€‰é¡¹å«ä¹‰å‚è§ &lt;a href="https://pre-commit.com/#plugins">https://pre-commit.com/#plugins&lt;/a>ï¼Œæ‰€æœ‰æ”¯æŒå®‰è£…çš„ &lt;code>hooks&lt;/code> åˆ—è¡¨å‚è§&lt;a href="https://pre-commit.com/hooks.html">https://pre-commit.com/hooks.html&lt;/a>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®‰è£… &lt;code>git hook&lt;/code> è„šæœ¬ã€‚åœ¨é…ç½®æ–‡ä»¶æ‰€åœ¨çš„æ ¹ç›®å½•è¿è¡Œå‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pre-commit install
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pre-commit installed at .git/hooks/pre-commit
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¿™ä¼šåœ¨ &lt;code>.git/hooks&lt;/code> æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª &lt;code>pre-commit&lt;/code> è„šæœ¬æ–‡ä»¶ï¼Œå¹¶åœ¨æ¥ä¸‹æ¥ä½ æ¯ä¸€æ¬¡æäº¤ä¹‹å‰è¿è¡Œï¼ç°åœ¨æˆ‘ä»¬å¯ä»¥å°è¯•æäº¤ä¸€æ¬¡ä»£ç äº†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ï¼ˆå¯é€‰æ­¥éª¤ï¼‰å¯¹æ‰€æœ‰æ–‡ä»¶è¿è¡Œ &lt;code>hooks&lt;/code>ã€‚&lt;/p>
&lt;p>é€šå¸¸ &lt;code>pre-commit&lt;/code> åªä¼šåœ¨è§¦å‘ &lt;code>git hooks&lt;/code> æ—¶å¯¹å‘ç”Ÿæ›´æ”¹çš„æ–‡ä»¶è¿è¡Œï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨å¯¹å½“å‰ä»“åº“çš„æ‰€æœ‰æ–‡ä»¶è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ pre-commit run --all-files
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Initializing environment &lt;span class="k">for&lt;/span> https://github.com/psf/black.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Initializing environment &lt;span class="k">for&lt;/span> https://github.com/pycqa/flake8.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Initializing environment &lt;span class="k">for&lt;/span> https://github.com/pre-commit/pre-commit-hooks.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Installing environment &lt;span class="k">for&lt;/span> https://github.com/psf/black.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Once installed this environment will be reused.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> This may take a few minutes...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Installing environment &lt;span class="k">for&lt;/span> https://github.com/pycqa/flake8.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Once installed this environment will be reused.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> This may take a few minutes...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Installing environment &lt;span class="k">for&lt;/span> https://github.com/pre-commit/pre-commit-hooks.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> Once installed this environment will be reused.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>INFO&lt;span class="o">]&lt;/span> This may take a few minutes...
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">black....................................................................Failed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- hook id: black
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">- files were modified by this hook
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reformatted /.../setup.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">reformatted /.../test/generate_toc_test.py
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">All &lt;span class="k">done&lt;/span>! âœ¨ ğŸ° âœ¨
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">2&lt;/span> files reformatted, &lt;span class="m">2&lt;/span> files left unchanged.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">flake8...................................................................Passed
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Check &lt;span class="k">for&lt;/span> added large files..............................................Passed
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç»“æœæ˜¾ç¤ºæˆ‘ä»¬æœ‰æ–‡ä»¶æœªé€šè¿‡ &lt;code>black&lt;/code> æ£€æŸ¥ï¼Œä½† &lt;code>black&lt;/code> åŒæ—¶ä¹Ÿå¸®æˆ‘ä»¬è‡ªåŠ¨è¿›è¡Œäº†æ ¼å¼åŒ–ï¼Œå› æ­¤åªéœ€è¦æš‚å­˜å¹¶é‡æ–°æäº¤è¿™äº›æ–‡ä»¶å³å¯ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h3 id="pre-commit-hooks-çš„é™åˆ¶">&lt;code>pre-commit hooks&lt;/code> çš„é™åˆ¶&lt;/h3>
&lt;p>ä½¿ç”¨ &lt;code>pre-commit&lt;/code> ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†ä¸°å¯Œå¤šæ ·çš„ä»£ç å·¥å…·é›†æˆåˆ° Git çš„å·¥ä½œæµä¸­ï¼Œè¿™å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†æˆ‘ä»¬çš„æ•ˆç‡ï¼Œä½† &lt;code>pre-commit hooks&lt;/code> æœ¬èº«å­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>å®¢æˆ·ç«¯ &lt;code>hooks&lt;/code> å¹¶ä¸ä¼šéšä»£ç åº“ä¸€èµ·è¢«å¤åˆ¶ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æœ¬åœ°ä»“åº“é€šè¿‡ &lt;code>pre-commit install&lt;/code> æ‰§è¡Œå®‰è£…ä¹‹å &lt;code>hooks&lt;/code> æ‰ä¼šç”Ÿæ•ˆã€‚&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>git commit --no-verify&lt;/code> å³å¯ç»•è¿‡æ‰€æœ‰çš„ &lt;code>pre-commit hooks&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;code>pre-commit&lt;/code> è§£å†³äº†åœ¨æœ¬åœ°é›†æˆä»£ç å·¥å…·çš„é—®é¢˜ï¼Œä½†åœ¨å›¢é˜Ÿåˆä½œçš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸€ç§æœºåˆ¶å¯ä»¥åœ¨æœåŠ¡å™¨ç«¯å¯¹æ‰€æœ‰æˆå‘˜æ¨é€çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œæ–½åŠ ç‰¹å®šçš„çº¦æŸï¼Œè¿™æ—¶å€™å°±éœ€è¦ç”¨åˆ° Pipelines äº†ã€‚&lt;/p>
&lt;h2 id="pipelines">Pipelines&lt;/h2>
&lt;p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£ CI/CD è¿™ä¸€æ¦‚å¿µã€‚&lt;/p>
&lt;h3 id="cicd">CI/CD&lt;/h3>
&lt;p>CIï¼ˆContinuous Integrationï¼ŒæŒç»­é›†æˆï¼‰æ˜¯ä¸€ç§è½¯ä»¶å®è·µï¼Œå®ƒè¦æ±‚æˆ‘ä»¬é¢‘ç¹åœ°å‘å…±äº«ä»“åº“æäº¤ä»£ç ã€‚æ›´é¢‘ç¹åœ°æäº¤ä»£ç å¯ä»¥æ›´å¿«åœ°å‘ç°é”™è¯¯ï¼Œå‡å°‘æˆ‘ä»¬åœ¨å‘ç°é”™è¯¯æ—¶éœ€è¦è°ƒè¯•çš„ä»£ç é‡ï¼Œä¹Ÿä½¿å¾—å›¢é˜Ÿä¸åŒæˆå‘˜é—´çš„å˜æ›´æ›´å®¹æ˜“åˆå¹¶ã€‚CI å¯ä»¥èŠ‚çœæˆ‘ä»¬è°ƒè¯•é”™è¯¯æˆ–è§£å†³åˆå¹¶å†²çªçš„æ—¶é—´ï¼Œè®©æˆ‘ä»¬æœ‰æ›´å¤šçš„æ—¶é—´æ¥ç¼–å†™ä»£ç ã€‚&lt;/p>
&lt;p>å½“æäº¤ä»£ç åˆ°å…±äº«ä»“åº“æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯ä¸€æ¬¡æäº¤çš„ä»£ç è¿›è¡Œæ„å»ºå’Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿æäº¤ä¸ä¼šå¼•å…¥é”™è¯¯ã€‚è¿™äº›æµ‹è¯•æ—¢åŒ…æ‹¬ä¸Šæ–‡æåˆ°çš„ Linterï¼Œä¹ŸåŒ…æ‹¬å®‰å…¨æ€§æ£€æŸ¥ã€æµ‹è¯•è¦†ç›–ç‡ã€åŠŸèƒ½æµ‹è¯•å’Œå…¶ä»–è‡ªå®šä¹‰æ£€æŸ¥ã€‚æˆ‘ä»¬å°†éœ€è¦ä¸€ä¸ª CI æœåŠ¡å™¨ä½œä¸º Runner ä»¥è¿è¡Œå¯¹æäº¤ä»£ç çš„æ„å»ºå’Œæ£€æŸ¥ã€‚&lt;/p>
&lt;p>CDï¼ˆContinuous Deploymentï¼ŒæŒç»­éƒ¨ç½²ï¼‰æ˜¯ CI çš„ä¸‹ä¸€æ­¥ã€‚æˆ‘ä»¬ä¸ä»…åœ¨æ¯æ¬¡æ¨é€ä»£ç åˆ°å…±äº«ä»£ç åº“æ—¶è¿›è¡Œæ„å»ºå’Œæµ‹è¯•ï¼Œè¿˜ä¼šåœ¨ä¸éœ€è¦ä»»ä½•äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹ï¼Œè‡ªåŠ¨éƒ¨ç½²ä»£ç åˆ°ç”Ÿäº§ç¯å¢ƒã€‚æ­¤å¤–è¿˜æœ‰Continuous Delivery ï¼ˆæŒç»­äº¤ä»˜ï¼‰ï¼Œå®ƒå’ŒæŒç»­éƒ¨ç½²çš„åŒºåˆ«åœ¨äºéœ€è¦äººå·¥å¹²é¢„æ‰ä¼šæ‰§è¡Œéƒ¨ç½²ã€‚&lt;/p>
&lt;h3 id="pipeline">Pipeline&lt;/h3>
&lt;p>Pipeline æ˜¯æŒç»­é›†æˆã€äº¤ä»˜å’Œéƒ¨ç½²çš„é¡¶å±‚å…·è±¡åŒ–ç»„ä»¶ï¼Œå®ƒç”±é¡ºåºæ‰§è¡Œçš„é˜¶æ®µï¼ˆstageï¼‰ä»¥åŠæ¯ä¸ªé˜¶æ®µä¸­å¹¶è¡Œçš„ä»»åŠ¡ï¼ˆjobï¼‰ç»„æˆã€‚ä¸€ä¸ªç®€å•çš„ pipeline å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-pipelines.png" alt="2020-01-04-pipelines">&lt;/p>
&lt;p>é¦–å…ˆå¹¶è¡Œåœ°æ‰§è¡Œ &lt;code>build&lt;/code> é˜¶æ®µçš„æ‰€æœ‰ä»»åŠ¡ï¼ˆ&lt;code>build_a&lt;/code> å’Œ &lt;code>build_b&lt;/code>ï¼‰ï¼Œæ‰€æœ‰ä»»åŠ¡æˆåŠŸåç»§ç»­æ‰§è¡Œä¸‹ä¸€é˜¶æ®µçš„ä»»åŠ¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚pipeline è¿˜èƒ½å®šä¹‰æˆæŒ‰æ›´å¤æ‚çš„é€»è¾‘è§„åˆ™è¿è¡Œã€‚&lt;/p>
&lt;p>ä¸‹é¢æˆ‘ä»¬ä»¥ GitLab CI ä¸ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•é…ç½®ä¸€ä¸ª pipelineï¼Œå¹¶åœ¨æµ‹è¯•é˜¶æ®µæ‰§è¡Œä¸Šæ–‡ä»‹ç»çš„æ£€æŸ¥å·¥å…·ï¼Œè§£å†³ä¸èƒ½å¯¹å›¢é˜Ÿæˆå‘˜æäº¤ä»£ç è¿›è¡Œå¼ºåˆ¶çº¦æŸçš„é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="gitlab-ci-ç¤ºä¾‹">GitLab CI ç¤ºä¾‹&lt;/h3>
&lt;h4 id="é…ç½®-runner">é…ç½® Runner&lt;/h4>
&lt;p>é¦–å…ˆæˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸ªè¿è¡Œä»»åŠ¡çš„æœåŠ¡å™¨ä½œä¸º Runnerï¼Œè¿™éœ€è¦æˆ‘ä»¬æœ‰å¯ç”¨çš„æœåŠ¡å™¨ä¸»æœºï¼ˆä¹Ÿå¯ä»¥ä½¿ç”¨æœ¬åœ°çš„å¼€å‘æœºå™¨æˆ–è´­ä¹° GitLab æä¾›çš„ Runnerï¼‰ã€‚é…ç½® Runner æ•´ä½“åˆ†ä¸¤æ­¥ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ä¸»æœºä¸Š&lt;a href="https://docs.gitlab.com/runner/install/">å®‰è£… GitLab Runner&lt;/a>ï¼ŒGitLab Runner æ˜¯ä¸€ä¸ªç”¨äº GitLab CI/CD å¹¶åœ¨ä¸»æœºä¸Šç®¡ç†ã€æ‰§è¡Œ pipeline ä»»åŠ¡çš„åº”ç”¨ã€‚å¯¹äºä¸åŒçš„æ“ä½œç³»ç»Ÿä¸æ¶æ„ï¼Œå…·ä½“çš„å®‰è£…æ­¥éª¤ä¹Ÿæœ‰å¾ˆå¤§åŒºåˆ«ï¼Œè¯¦æƒ…å‚è§æ–‡æ¡£ã€‚&lt;/li>
&lt;li>ä¸ºé¡¹ç›®ï¼ˆæˆ–é¡¹ç›®ç»„ï¼‰&lt;a href="https://docs.gitlab.com/runner/register/">æ³¨å†Œ Runner&lt;/a>ã€‚è¿™ä¸€æ­¥é¦–å…ˆéœ€è¦ä» GitLab é¡¹ç›®ä¸»é¡µçš„ &lt;strong>Settings &amp;gt; CI/CD&lt;/strong> &lt;strong>&amp;gt; Runners settings&lt;/strong> è·å–é¡¹ç›®çš„ URL å’Œæ³¨å†Œä»¤ç‰Œï¼Œç„¶ååœ¨ Runner æ‰€åœ¨çš„æœºå™¨è¿è¡Œ &lt;code>register&lt;/code> å‘½ä»¤ä½¿ç”¨ URL å’Œä»¤ç‰Œå®Œæˆæ³¨å†Œï¼Œå¹¶é€‰æ‹©åˆé€‚çš„ Runner ç±»å‹ï¼Œè¯¦ç»†æ­¥éª¤å‚è§æ–‡æ¡£ã€‚&lt;/li>
&lt;/ul>
&lt;p>é…ç½®å®Œæˆåï¼Œæˆ‘ä»¬å°†å¯ä»¥åœ¨ &lt;strong>Runners settings&lt;/strong> é¡µé¢æŸ¥çœ‹å¯ç”¨çš„ Runner å’ŒçŠ¶æ€ï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-runner-status.png" alt="2020-01-04-runner-status">&lt;/p>
&lt;h4 id="åˆ›å»º-gitlabyml">åˆ›å»º &lt;code>.gitlab.yml&lt;/code>&lt;/h4>
&lt;p>æˆ‘ä»¬å°†åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªé…ç½® pipeline çš„ &lt;code>.gitlab.yml&lt;/code> æ–‡ä»¶ï¼ŒGitLab å°†åœ¨æ¯ä¸€æ¬¡æˆ‘ä»¬æ¨é€ä»£ç åˆ°å…±äº«ä»“åº“æ—¶ï¼Œè¯»å–è¯¥æ–‡ä»¶ä¸­çš„å®šä¹‰å’ŒæŒ‡ä»¤ï¼Œåˆ›å»ºä¸€æ¡ä¸åŒé˜¶æ®µåŠä»»åŠ¡ç»„æˆçš„ pipelineï¼Œå¹¶å°†é˜¶æ®µä¸­çš„ä»»åŠ¡æ´¾å‘ç»™å¯ç”¨çš„ Runner æ‰§è¡Œã€‚æˆ‘ä»¬ä»¥å¦‚ä¸‹ &lt;code>.gitlab.yml&lt;/code> æ–‡ä»¶ä¸ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">before_script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">python --version&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">pip install -r requirements-ci.txt&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">stages&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Pre-commit Hooks&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">Static Analysis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">pre-commit&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Pre-commit Hooks&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">variables&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">PRE_COMMIT_HOME&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${CI_PROJECT_DIR}/.cache/pre-commit&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">cache&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">20201116dash&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">paths&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">${PRE_COMMIT_HOME}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">pre-commit run --all-files&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">mypy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Static Analysis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">allow_failure&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">only&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">refs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">master&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">pwd&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">ls -l&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">python -m mypy app&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">flake8&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Static Analysis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">pwd&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">python -m flake8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">git-lint&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">stage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Static Analysis&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">git log -1 --pretty=%B | gitlint --contrib=CT1 --ignore=body-is-missing&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ï¼š&lt;/p>
&lt;ul>
&lt;li>Runner åº”è¯¥æ‰§è¡Œçš„ä»»åŠ¡çš„ç»“æ„å’Œé¡ºåºã€‚&lt;/li>
&lt;li>é‡åˆ°ç‰¹å®šæ¡ä»¶æ—¶ï¼ŒRunner åº”åšå‡ºçš„å†³å®šã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸Šé¢çš„ç¤ºä¾‹å®šä¹‰äº†å¦‚ä¸‹ pipelineï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-pipeline-graph.png" alt="2020-01-04-pipeline-graph">&lt;/p>
&lt;ul>
&lt;li>&lt;code>before_script&lt;/code>å…³é”®å­—å®šä¹‰äº†åœ¨æ¯ä¸ªä»»åŠ¡å‰æ‰§è¡Œçš„ä¸€ç»„å‘½ä»¤ï¼Œæˆ‘ä»¬é€šè¿‡è¿™é‡Œè®¾ç½®çš„å‘½ä»¤å®‰è£…è¿è¡Œ pipeline æ‰€éœ€çš„ä¾èµ–ã€‚&lt;/li>
&lt;li>&lt;code>stage&lt;/code> å…³é”®å­—å®šä¹‰äº† &lt;code>Pre-commit Hooks&lt;/code> å’Œ &lt;code>Static Analysis&lt;/code> ä¸¤ä¸ªé˜¶æ®µã€‚&lt;/li>
&lt;li>ä¹‹ååˆ™å®šä¹‰äº† &lt;code>pre-commit&lt;/code> ã€ &lt;code>git-lint&lt;/code>ã€ &lt;code>mypy&lt;/code> å’Œ &lt;code>flake8&lt;/code> ç­‰å¤šä¸ªä»»åŠ¡åŠæ‰€å±é˜¶æ®µã€‚&lt;/li>
&lt;li>æ¯ä¸ªä»»åŠ¡ä¸­é€šè¿‡ &lt;code>script&lt;/code> å…³é”®å­—å®šä¹‰è¯¥ä»»åŠ¡æ‰€è¿è¡Œçš„è„šæœ¬å‘½ä»¤ã€‚&lt;/li>
&lt;li>åœ¨ &lt;code>pre-commit&lt;/code> ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸåœ°å°†ä¸Šä¸€èŠ‚ä»‹ç»çš„ &lt;code>pre-commit&lt;/code> æ”¾åœ¨æœåŠ¡ç«¯è¿è¡Œï¼Œè¿™èƒ½ç¡®ä¿å¯¹ä»»ä½•äººæäº¤çš„ä»£ç éƒ½ä¼šè¿è¡ŒåŸå…ˆåªåœ¨æœ¬åœ°ç”Ÿæ•ˆçš„ &lt;code>pre-commit hooks&lt;/code>ã€‚æˆ‘ä»¬è¿˜é€šè¿‡&lt;a href="https://docs.gitlab.com/ee/ci/variables/predefined_variables.html">é¢„å®šä¹‰å˜é‡&lt;/a>å’Œ &lt;code>cache&lt;/code> å…³é”®å­—ç¼“å­˜è¿è¡Œä»»åŠ¡æ‰€éœ€çš„æ–‡ä»¶ä»¥åŠ å¿«æ‰§è¡Œé€Ÿåº¦ã€‚&lt;/li>
&lt;li>åœ¨ &lt;code>mypy&lt;/code> ä»»åŠ¡ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ &lt;code>allow_failure&lt;/code> å…³é”®å­—æ›´æ”¹äº†ä»»åŠ¡æˆåŠŸæ‰ä¼šè¿›å…¥ä¸‹ä¸€é˜¶æ®µè¿™ä¸€é»˜è®¤è¡Œä¸ºï¼Œå¹¶é€šè¿‡ &lt;code>only&lt;/code> å…³é”®å­—é™åˆ¶å…¶åªå¯¹ &lt;code>master&lt;/code> åˆ†æ”¯çš„æäº¤æ‰§è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;p>å…³äº &lt;code>.gitlab.yml&lt;/code> çš„æ›´å¤šè¯´æ˜è¯·å‚é˜… &lt;a href="https://docs.gitlab.com/ee/ci/yaml/README.html">GitLab CI/CD pipeline é…ç½®å‚è€ƒæ‰‹å†Œ&lt;/a> ä»¥åŠ &lt;a href="https://docs.gitlab.com/ee/ci/examples/README.html">GitLab CI/CD ç¤ºä¾‹&lt;/a>ã€‚&lt;/p>
&lt;h4 id="æŸ¥çœ‹-pipeline-çš„è¿è¡ŒçŠ¶æ€">æŸ¥çœ‹ pipeline çš„è¿è¡ŒçŠ¶æ€&lt;/h4>
&lt;p>ç°åœ¨å½“æˆ‘ä»¬æ¨é€æ–°çš„ä»£ç åˆ°å…±äº«ä»“åº“æ—¶ï¼Œä¸€ä¸ªæ–°çš„ pipeline ä¼šè¢«è§¦å‘è¿è¡Œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é€”å¾„åœ¨ GitLab ä»“åº“æŸ¥çœ‹ pipeline çš„è¿è¡ŒçŠ¶æ€ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¿›å…¥ &lt;strong>CI/CD &amp;gt; Pipelines&lt;/strong>ã€‚å°†å±•ç¤ºä¸€ä¸ªåŒ…å«ä¸¤ä¸ªé˜¶æ®µçš„ pipelineï¼ˆå½“å‰çŠ¶æ€ä¸ºå·²é€šè¿‡ï¼‰ã€‚&lt;/p>
&lt;p>&lt;img src="2020-01-04-pipeline-entry.png" alt="2020-01-04-pipeline-entry">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‚¹å‡» pipeline çš„ ID å³å¯æŸ¥çœ‹è¯¥ pipeline çš„è¿è¡Œç¤ºæ„å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-pipeline-graph.png" alt="2020-01-04-pipeline-graph">&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‚¹å‡»ä¸€ä¸ªä»»åŠ¡åç§°ï¼Œå¯æŸ¥çœ‹è¯¥ä»»åŠ¡çš„è¯¦ç»†è¿è¡Œä¿¡æ¯ï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-job-detail.png" alt="2020-01-04-job-detail">&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šå³ä¸ºä¸€ä¸ªå®Œæ•´çš„ GitLab CI pipeline ç¤ºä¾‹ã€‚åœ¨è¯¥ pipeline ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨æ¯ä¸€æ¬¡æäº¤ä»£ç åï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹æ‰€æœ‰æ–‡ä»¶è¿è¡Œé›†æˆäº†ä¼—å¤š &lt;code>hooks&lt;/code> çš„ &lt;code>pre-commit&lt;/code>ï¼Œç¡®ä¿ä»£ç å·²åœ¨æœ¬åœ°é€šè¿‡äº† &lt;code>pre-commit&lt;/code> æ£€æŸ¥ã€‚&lt;/li>
&lt;li>å•ç‹¬æ‰§è¡Œ &lt;code>mypy&lt;/code> ã€&lt;code>git-lint&lt;/code> ç­‰æ£€æŸ¥å·¥å…·ã€‚&lt;/li>
&lt;li>è¿˜èƒ½å¤Ÿæ‰§è¡Œæ‰“åŒ…ã€è¿è¡Œæµ‹è¯•ã€å®‰å…¨æ£€æŸ¥ç­‰æ›´å¤šæ›´å¤æ‚çš„ä»»åŠ¡ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ GitHub Actions ä¸ºä¾‹ï¼Œå±•ç¤ºå¦‚ä½•è¿è¡Œä¸€ä¸ªç®€å•çš„ CD pipelineã€‚&lt;/p>
&lt;h3 id="github-cd-ç¤ºä¾‹">GitHub CD ç¤ºä¾‹&lt;/h3>
&lt;h4 id="å’Œ-gitlab-cicd-çš„åŒºåˆ«">å’Œ GitLab CI/CD çš„åŒºåˆ«&lt;/h4>
&lt;p>GitHub Actions æ˜¯ GitHub åœ¨ 2018å¹´10æœˆæ¨å‡ºçš„æŒç»­é›†æˆæœåŠ¡ï¼Œå®ƒå’Œä¸Šæ–‡ä»‹ç»çš„ GitLab CI åŸç†å’Œä½¿ç”¨æ–¹æ³•åŸºæœ¬ç›¸åŒï¼Œä½†å­˜åœ¨ä»¥ä¸‹åŒºåˆ«ï¼š&lt;/p>
&lt;ul>
&lt;li>æœ¯è¯­å®šä¹‰æœ‰æ‰€ä¸åŒï¼ŒGitHub Actions æœ‰ä»¥ä¸‹ç»„æˆéƒ¨åˆ†ï¼š
&lt;ol>
&lt;li>&lt;strong>workflow&lt;/strong>Â ï¼ˆå·¥ä½œæµç¨‹ï¼‰ï¼šæŒç»­é›†æˆä¸€æ¬¡è¿è¡Œçš„è¿‡ç¨‹ï¼Œå³ GitLab ä¸­çš„ pipelineã€‚&lt;/li>
&lt;li>&lt;strong>job&lt;/strong>Â ï¼ˆä»»åŠ¡ï¼‰ï¼šä¸€ä¸ª workflow ç”±ä¸€ä¸ªæˆ–å¤šä¸ª jobs æ„æˆï¼Œç±»ä¼¼äº GitLab ä¸­çš„ stageï¼Œä½†é»˜è®¤åœ¨ä¸åŒçš„ Runner å¹¶è¡Œæ‰§è¡Œï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºé¡ºåºæ‰§è¡Œã€‚&lt;/li>
&lt;li>&lt;strong>step&lt;/strong>ï¼ˆæ­¥éª¤ï¼‰ï¼šæ¯ä¸ª job ç”±å¤šä¸ª step æ„æˆï¼Œç±»ä¼¼äº GitLab ä¸­çš„ jobï¼Œä½† step è¦ä¹ˆæ˜¯ä¸€è¡Œå‘½ä»¤ï¼Œè¦ä¹ˆå°±æ˜¯ä¸€ä¸ªactionï¼Œstep ä¹‹é—´æŒ‰é¡ºåºæ‰§è¡Œä¸”èƒ½å¤Ÿå…±äº«æ•°æ®ã€‚&lt;/li>
&lt;li>&lt;strong>action&lt;/strong>Â ï¼ˆåŠ¨ä½œï¼‰ï¼šä½ å¯ä»¥å°†å¤šä¸ªè„šæœ¬å‘½ä»¤å°è£…æˆä¸€ä¸ª actionï¼Œé€šè¿‡ GitHub å¸‚åœºåˆ†äº«ç»™å…¶ä»–äººï¼Œç„¶ååœ¨ step ä¸­ä½¿ç”¨è‡ªå»ºæˆ–æ¥è‡ªç¤¾åŒºçš„ actionã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>GitHub å…è´¹æä¾›å¸¸è§ç±»å‹çš„ Runnerï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸éœ€è¦å†è‡ªè¡Œé…ç½®æœåŠ¡å™¨åŠæ³¨å†Œã€‚&lt;/li>
&lt;li>workflow çš„é…ç½®æ–‡ä»¶ä¹Ÿæ˜¯ç±»ä¼¼äº &lt;code>.gitlab.yml&lt;/code> çš„ &lt;code>yaml&lt;/code> æ–‡ä»¶ï¼Œä½†éœ€è¦æ·»åŠ åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ &lt;code>.github/workflows&lt;/code> è·¯å¾„ä¸­ã€‚&lt;/li>
&lt;li>å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å…±äº«æˆ–ä½¿ç”¨ä»–äººåˆ›å»ºçš„è„šæœ¬å‘½ä»¤ï¼Œå³ actionã€‚&lt;/li>
&lt;/ul>
&lt;p>æ¥ä¸‹æ¥æˆ‘å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ GitHub Actions è‡ªåŠ¨å‘å¸ƒä¸€ä¸ª Hugo é™æ€ç«™ç‚¹åˆ° GitHub Pagesã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨-github-actions-è‡ªåŠ¨å‘å¸ƒé™æ€ç«™ç‚¹">ä½¿ç”¨ GitHub Actions è‡ªåŠ¨å‘å¸ƒé™æ€ç«™ç‚¹&lt;/h4>
&lt;p>å¤§è‡´çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>åœ¨æœ¬åœ°å†…å®¹ä»“åº“å¼€å‘ç«™ç‚¹å†…å®¹ï¼Œå®Œæˆåå°†å†…å®¹æ¨é€åˆ°å…±äº«ä»“åº“ã€‚è¯¥å…±äº«ä»“åº“å¯èƒ½æ˜¯ç§æœ‰çš„ã€‚&lt;/li>
&lt;li>å…±äº«ä»“åº“æ¥å—æ¨é€åè§¦å‘ workflowï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š
&lt;ol>
&lt;li>åœ¨ Runner ä¸­æ‹‰å–æäº¤çš„å†…å®¹ã€‚&lt;/li>
&lt;li>é…ç½®ç¯å¢ƒå¹¶å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ Hugoã€‚&lt;/li>
&lt;li>è¿è¡Œ Hugo æ ¹æ®æäº¤å†…å®¹ç”Ÿæˆé™æ€ç«™ç‚¹ã€‚&lt;/li>
&lt;li>å°†é™æ€æ–‡ä»¶æ¨é€åˆ°å‘å¸ƒä»“åº“ã€‚&lt;/li>
&lt;/ol>
&lt;/li>
&lt;li>å‘å¸ƒä»“åº“åœ¨æ¥æ”¶åˆ°æ¨é€å†…å®¹åä¼šè‡ªåŠ¨æ›´æ–° Pages é¡µé¢ã€‚&lt;/li>
&lt;/ol>
&lt;p>GitHub ä¸Šæœ‰è®¸å¤šè¿™ç±»è‡ªåŠ¨åŒ–éƒ¨ç½²ä»»åŠ¡çš„å¼€æº Actions é¡¹ç›®ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å…¶ä¸­ä¸€ä¸ªç®€å•æ˜“ç”¨çš„Â &lt;a href="https://github.com/peaceiris/actions-hugo#getting-started">GitHub Actions for Hugo&lt;/a>ã€‚å…·ä½“çš„æ“ä½œæ­¥éª¤æˆªå›¾å’Œè¯¦ç»†é…ç½®é¡¹å¯ä»¥æŸ¥çœ‹è¯¥é¡¹ç›®çš„Â &lt;a href="https://github.com/peaceiris/actions-hugo#github-actions-for-hugo">README&lt;/a>ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹é…ç½®è¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨æœ¬åœ°å†…å®¹ä»“åº“ä¸­æ·»åŠ ç›®å½•å’Œæ–‡ä»¶ï¼š&lt;code>.github/workflows/gh-pages.yml&lt;/code>ï¼Œ&lt;code>gh-pages.yml&lt;/code>Â æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">github pages&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">push&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="l">main &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯éƒ½ä¼šè§¦å‘éƒ¨ç½²ä»»åŠ¡&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-18.04&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">actions/checkout@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">submodules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch Hugo themes (true OR recursive)&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fetch-depth&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># Fetch all history for .GitInfo and .Lastmod&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Setup Hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-hugo@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">hugo-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0.79.1&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">extended&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Build&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo --minify&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-gh-pages@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">deploy_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.ACTIONS_DEPLOY_KEY }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">external_repository&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">&amp;lt;USERNAME&amp;gt;/&amp;lt;USERNAME&amp;gt;.github.io &lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="c"># å‘å¸ƒä»“åº“åç§°&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_branch&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">main&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">publish_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./public&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åœ¨è¯¥é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å¦‚ä¸‹çš„ workflowï¼š&lt;/p>
&lt;ol>
&lt;li>workflow åç§°ä¸º &lt;code>github pages&lt;/code>ã€‚&lt;/li>
&lt;li>ä»…åœ¨æ¨é€æäº¤åˆ° &lt;code>main&lt;/code> åˆ†æ”¯æ—¶æ‰§è¡Œã€‚&lt;/li>
&lt;li>å«æœ‰ä¸€ä¸ªåä¸º &lt;code>deploy&lt;/code> çš„ä»»åŠ¡ï¼Œå¹¶éœ€è¦åœ¨&lt;code>ubuntu-18.04&lt;/code>å¹³å°çš„ Runner æ‰§è¡Œã€‚&lt;/li>
&lt;li>ä»»åŠ¡ä¸­çš„ç¬¬ä¸€ä¸ªæ­¥éª¤ä½¿ç”¨äº†åä¸º &lt;code>actions/checkout@v2&lt;/code> çš„ &lt;code>action&lt;/code>ï¼Œä»¥æ‹‰å–æäº¤çš„å†…å®¹åˆ° Runnerã€‚&lt;/li>
&lt;li>ç¬¬äºŒä¸ªæ­¥éª¤ä½¿ç”¨ &lt;code>peaceiris/actions-hugo@v2&lt;/code> action é…ç½® Hugoï¼Œå¹¶æŒ‡å®šç‰ˆæœ¬ã€‚&lt;/li>
&lt;li>ç¬¬ä¸‰ä¸ªæ­¥éª¤ç›´æ¥æ‰§è¡Œ &lt;code>hugo --minify&lt;/code> å‘½ä»¤ï¼Œç”Ÿæˆé™æ€ç«™ç‚¹ï¼ˆé»˜è®¤è¾“å‡ºæ–‡ä»¶åˆ° &lt;code>public&lt;/code> ç›®å½•ï¼‰&lt;/li>
&lt;li>ç¬¬å››ä¸ªæ­¥éª¤ä½¿ç”¨ &lt;code>peaceiris/actions-gh-pages@v3&lt;/code> action å°†ç”Ÿæˆçš„é™æ€æ–‡ä»¶æ¨é€åˆ°æŒ‡å®šçš„å¤–éƒ¨ä»“åº“ã€‚&lt;/li>
&lt;/ol>
&lt;p>è¿™ä¸ªÂ &lt;code>workflow&lt;/code>Â åŸºäºå†…å®¹ä»“åº“è¿è¡Œï¼Œä½†æˆ‘ä»¬éœ€è¦å°†è¿è¡Œè¿‡ç¨‹ç”Ÿæˆçš„é™æ€æ–‡ä»¶æ¨é€åˆ°å‘å¸ƒä»“åº“è¿›è¡Œå‘å¸ƒï¼Œå› æ­¤è¿˜éœ€è¦åœ¨ä¸¤ä¸ªä»“åº“ä¸­åˆ†åˆ«è®¾ç½®å¯†é’¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æœ¬åœ°ç”Ÿæˆ SSH éƒ¨ç½²å¯†é’¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ssh-keygen -t rsa -b &lt;span class="m">4096&lt;/span> -C &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>git config user.email&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -f gh-pages -N &lt;span class="s2">&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å°†åœ¨å½“å‰ç›®å½•ç”Ÿæˆå¦‚ä¸‹å¯†é’¥æ–‡ä»¶:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># gh-pages.pub (å…¬é’¥)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># gh-pages (ç§é’¥)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨ GitHub åˆ†åˆ«è¿›å…¥å†…å®¹ä»“åº“å’Œå‘å¸ƒä»“åº“çš„Â &lt;code>Settings&lt;/code>Â é¡µé¢ï¼š&lt;/p>
&lt;ul>
&lt;li>å°†å…¬é’¥Â &lt;code>gh-pages.pub&lt;/code>Â ä½œä¸ºÂ &lt;code>Secret&lt;/code>Â æ·»åŠ åˆ°å†…å®¹ä»“åº“ï¼Œå¹¶è®¾ç½®Â &lt;code>Name&lt;/code>Â ä¸ºÂ &lt;code>ACTIONS_DEPLOY_KEY&lt;/code>ã€‚&lt;/li>
&lt;li>å°†ç§é’¥Â &lt;code>gh-pages&lt;/code>Â ä½œä¸ºÂ &lt;code>Deploy Key&lt;/code>Â æ·»åŠ åˆ°å‘å¸ƒä»“åº“ï¼Œå¹¶è®¾ç½®ä¸ºÂ &lt;code>Allow write access&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚&lt;/p>
&lt;p>åœ¨æœ¬åœ°å†…å®¹ä»“åº“åšä¸€äº›æ›´æ”¹ï¼Œé¢„è§ˆæ•ˆæœåæäº¤å¹¶æ¨é€ï¼Œç„¶ååœ¨å…±äº«ä»“åº“çš„ &lt;strong>GitHub Actions&lt;/strong> é¡µé¢æ£€æŸ¥ç›¸åº”Â &lt;code>workflow&lt;/code>Â çš„è¿è¡ŒçŠ¶æ€ä¸è¯¦ç»†ç»“æœï¼š&lt;/p>
&lt;p>&lt;img src="2020-01-04-actions-page.png" alt="2020-01-04-actions-page">&lt;/p>
&lt;p>è¿è¡ŒæˆåŠŸåï¼Œå¾ˆå¿«å‘å¸ƒä»“åº“å°†æ–°å¢ä¸€ä¸ªç”±è¯¥Â &lt;code>workflow&lt;/code>Â åˆ›å»ºçš„æäº¤ï¼Œç›¸åº”çš„ GitHub Pages ä¹Ÿä¼šæ›´æ–°ç›¸åº”çš„å†…å®¹ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å›´ç»•ä¿éšœä»£ç è´¨é‡è¿™ä¸€ç›®çš„ï¼š&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆä»‹ç»äº† Linterã€Static Type Checkerã€Autoformatter ä¸‰ç§å·¥å…·å¹¶å„å±•ç¤ºäº†ä¸€ä¸ªä»£è¡¨æ€§å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€‚&lt;/li>
&lt;li>å°†è¿™äº›å·¥å…·é€šè¿‡ &lt;code>pre-commit&lt;/code> é›†æˆåˆ° &lt;code>git hooks&lt;/code> ä¸­ï¼Œåœ¨ä»£ç å¼€å‘å·¥ä½œæµä¸­è‡ªåŠ¨æ‰§è¡Œã€‚&lt;/li>
&lt;li>ä»‹ç»äº†CI/CDï¼Œå¹¶ä»¥ GitLab CI pipeline ä¸ºä¾‹å°†ä»¥ä¸Šæ£€æŸ¥éƒ¨ç½²åˆ°å…±äº«ä»“åº“ï¼Œåœ¨æ¯æ¬¡ä»£ç æäº¤åè‡ªåŠ¨æ‰§è¡Œã€‚&lt;/li>
&lt;li>é¡ºä¾¿ä»‹ç»äº†ä¸€ä¸ªé€šè¿‡ GitHub Actions å®ç°æŒç»­éƒ¨ç½²çš„ç¤ºä¾‹ï¼Œæ¼”ç¤ºäº† GitHub æŒç»­é›†æˆæœåŠ¡çš„åŸºæœ¬ç”¨æ³•ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç»è¿‡ç®€å•å‡ æ­¥çš„ä¸€æ¬¡æ€§é…ç½®ï¼Œä½ å°±å¯ä»¥æ‹¥æœ‰ä¸€å¥—é«˜åº¦è‡ªåŠ¨åŒ–çš„ä»£ç è´¨é‡å·¥å…·å·¥ä½œæµç¨‹ã€‚ä½†å·¥å…·åªæ˜¯ä¿éšœä»£ç è´¨é‡ä¼—å¤šç¯èŠ‚ä¸­æœ€å®¹æ˜“å‘åŠ›ï¼Œè§æ•ˆå¿«ï¼Œä½†ä½œç”¨ä¹Ÿå¾ˆæœ‰é™çš„ä¸€ç¯ã€‚çœŸæ­£å®ç°ä¿è¯ä»£ç è´¨é‡è¿™ä¸€ç›®æ ‡ä»»é‡è€Œé“è¿œï¼Œè¿˜éœ€è¦æˆ‘ä»¬åœ¨ä¸ªäººå’Œå›¢é˜Ÿè¿™ä¸¤ä¸ªæ–¹é¢è®¤è¯†åˆ°ä»£ç è´¨é‡çš„é‡è¦æ€§ï¼Œå¹¶ä¸æ–­è·µè¡Œå„ç§ä»£ç è´¨é‡è®¾è®¡ä¸æ´»åŠ¨ã€‚&lt;/p>
&lt;p>&lt;em>&lt;strong>æ›´æ–°&lt;/strong>&lt;/em>ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœä½ è§‰å¾—æ‰‹åŠ¨é›†æˆä»¥ä¸Šå·¥å…·è¿‡äºç¹çï¼Œå¯ä»¥å°è¯•æˆ‘åˆ¶ä½œçš„ Python é¡¹ç›®æ¨¡æ¿ &lt;a href="https://github.com/waynerv/cookiecutter-pypackage">Cookiecutter PyPackage&lt;/a>ï¼Œä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œä½¿ç”¨äº† GitHub Actions è‡ªåŠ¨æ‰§è¡Œæµ‹è¯•ã€é¢„è§ˆå’Œå‘å¸ƒã€‚&lt;/li>
&lt;li>å¦‚æœä½ æƒ³å­¦ä¹ /æé«˜è‡ªå·±çš„ Python æŠ€èƒ½ï¼Œæˆ‘æ¨èä¸€ä¸ªå­¦ä¹ ç½‘ç«™ &lt;a href="https://jobtensor.com/Tutorial/Python/en/Introduction">https://jobtensor.com/Tutorial/Python/en/Introduction&lt;/a>ï¼Œå®ƒä»¬çš„å†…å®¹å¾ˆæ£’è€Œä¸”å®Œå…¨å…è´¹ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Lint_(software)">Linter-Wikipedia&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://flake8.pycqa.org/en/latest/">Flake8&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mypy.readthedocs.io/en/stable/">Mypy&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://realpython.com/python-type-checking">Python Type Checking (Guide)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://black.readthedocs.io/en/stable/">Black&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">Customizing Git - Git Hooks&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pre-commit.com/">pre-commit&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.github.com/en/free-pro-team@latest/actions/guides/about-continuous-integration">About continuous integration&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.gitlab.com/ee/ci/README.html">GitLab CI/CD&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.github.com/en/free-pro-team@latest/actions/quickstart">Quickstart for GitHub Actions&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/introduction-to-github-actions">Introduction to GitHub Actions&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.ruanyifeng.com/blog/2019/09/getting-started-with-github-actions.html">GitHub Actions å…¥é—¨æ•™ç¨‹&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/" term="ä»£ç è´¨é‡" label="ä»£ç è´¨é‡"/><category scheme="https://waynerv.com/tags/ci/" term="CI" label="CI"/></entry><entry><title type="text">ä½¿ç”¨ Hugo å’Œ GitHub Pages æ­å»ºé™æ€åšå®¢</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/setup-blog-with-hugo-and-github-pages/"/><id>https://waynerv.com/posts/setup-blog-with-hugo-and-github-pages/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2020-12-24T21:47:50+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Hugo å’Œ GitHub Pages å¿«é€Ÿæ­å»ºä¸ªäººä½¿ç”¨çš„é™æ€åšå®¢ï¼Œå¹¶é€šè¿‡ GitHub actions å®ç°è‡ªåŠ¨å‘å¸ƒã€‚</summary><content type="html">&lt;p>ä½œä¸ºä¸€ä¸ªå·²ç»å…¥è¡Œäº†ä¸€å¹´å¤šçš„ï¼ˆè€ï¼‰æŠ€æœ¯äººï¼Œç»´æŠ¤ä¸€ä¸ªçœ‹å¾—è¿‡å»çš„ä¸ªäººåšå®¢æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚&lt;/p>
&lt;p>åˆšå­¦ç¼–ç¨‹çš„æ—¶å€™ï¼Œè¿˜å¼€æºè¿‡ä¸€ä¸ªåŸºäº Flask å’Œ MongoDB çš„&lt;a href="https://github.com/waynerv/originblog">åšå®¢é¡¹ç›®&lt;/a>ï¼Œä½†åé¢å°±æ²¡æ€ä¹ˆä½¿ç”¨å’Œç»´æŠ¤äº†ï¼Œé™¤å¼€ä¸»è§‚ä¸Šçš„æ‡’ï¼Œè¿˜å› ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>è‡ªå»ºåšå®¢ç»•ä¸å¼€ä¸»æœºå’ŒåŸŸåï¼Œè¿™æ˜¯ä¸€ç¬”æŒç»­çš„ç»æµæˆæœ¬ã€‚å›½å†…çš„ä¸»æœºå¾€å¾€æ˜¯ç¬¬ä¸€å¹´å‰²è‚‰ç¬¬äºŒå¹´å®°çŒªï¼Œå›½å¤–çš„ä¸»æœºè®¿é—®å»¶è¿Ÿå¾ˆé«˜ã€‚&lt;/li>
&lt;li>å›½å†…ä¸»æœºæ›´éº»çƒ¦çš„æ˜¯è¿˜éœ€è¦å®šæœŸå¤‡æ¡ˆï¼Œç¬¬ä¸€ä¸ªåšå®¢å°±æ˜¯å› ä¸ºå¤‡æ¡ˆåˆ°æœŸä¸­æ–­äº†ã€‚&lt;/li>
&lt;li>åšå®¢åŠŸèƒ½çš„å®ç°æŠ€æœ¯éš¾åº¦ä¸å¤§ï¼Œå¼€å§‹è¿˜æœ‰ä¸€äº›æ–°é²œæ„Ÿï¼Œæœ‰äº†å·¥ä½œç»éªŒåå°±å¾ˆéš¾æœ‰å…´è¶£ç»§ç»­ç»´æŠ¤äº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>åˆšå¥½æœ€è¿‘æœ‰å†™ä¸€äº›æ–‡ç« çš„æ‰“ç®—ï¼Œå†³å®šæ‰¾ä¸ªç®€å•ã€çœäº‹ï¼ˆæœ€åå‘ç°å¹¶æ²¡æœ‰ï¼‰ä¸”ä¸èŠ±é’±çš„è·¯å­æŠŠåšå®¢å†æèµ·æ¥ï¼Œä¸€ç•ªç ”ç©¶åï¼Œé€‰æ‹©äº†ç”Ÿæˆé™æ€ç«™ç‚¹å‘å¸ƒåˆ° GitHub Pages çš„æ–¹æ¡ˆã€‚&lt;/p>
&lt;h2 id="å·¥ä½œæµ">å·¥ä½œæµ&lt;/h2>
&lt;p>æ•´ä¸ªæ–¹æ¡ˆçš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>ç”¨ Markdown æ ¼å¼å†™ä½œæ–‡ç« ã€‚&lt;/li>
&lt;li>ä½¿ç”¨ç”Ÿæˆå™¨å°† markdown æ–‡ä»¶è½¬æ¢æˆé™æ€ç«™ç‚¹ã€‚&lt;/li>
&lt;li>å°†ç”Ÿæˆçš„ç«™ç‚¹å†…å®¹æ¨é€åˆ° GitHub å¹¶å‘å¸ƒã€‚&lt;/li>
&lt;/ol>
&lt;p>å†™ markdown æ²¡å•¥å¥½è¯´çš„ï¼Œä»€ä¹ˆç¼–è¾‘å™¨éƒ½å¯ä»¥ï¼Œæˆ‘ä¸€ç›´ç”¨çš„æ˜¯ Typoraã€‚&lt;/p>
&lt;p>é™æ€ç«™ç‚¹ç”Ÿæˆå™¨æˆ‘é€‰æ‹©äº† Hugoï¼ŒåŸå› æ˜¯æœ€è¿‘åˆšå¥½åœ¨å­¦ Goï¼Œæ­¤å¤–è¿˜æœ‰ Gatsbyã€Jekyllã€Hexoç­‰å¾ˆå¤šé€‰é¡¹ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥è¦åšçš„å·¥ä½œæ˜¯ç”Ÿæˆé™æ€ç«™ç‚¹å¹¶é€šè¿‡ GitHub Pages å‘å¸ƒã€‚&lt;/p>
&lt;h2 id="ç”Ÿæˆé™æ€ç«™ç‚¹">ç”Ÿæˆé™æ€ç«™ç‚¹&lt;/h2>
&lt;p>ä½¿ç”¨ Hugo ç”Ÿæˆé™æ€åšå®¢ç«™ç‚¹éå¸¸ç®€å•ï¼Œå…·ä½“çš„æ­¥éª¤å’Œç”¨æ³•å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£çš„ &lt;a href="https://gohugo.io/getting-started/quick-start/">Quick Start&lt;/a>ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å®‰è£… Hugoã€‚&lt;code>macOS&lt;/code> ä¸‹å¯ä»¥ç›´æ¥ä½¿ç”¨ &lt;code>homebrew&lt;/code>å®‰è£…ï¼š&lt;code>brew install hugo&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ›å»ºä¸€ä¸ªæ–°çš„ç«™ç‚¹ã€‚è¿™ä¼šç”Ÿæˆä¸€ä¸ªç‰¹å®šç›®å½•ç»“æ„çš„é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œç”¨æ¥ç»´æŠ¤æ‰€æœ‰çš„ç«™ç‚¹å†…å®¹ã€‚å‡è®¾æˆ‘ä»¬æƒ³æŠŠå®ƒå‘½åä¸º &lt;code>hugo-blog&lt;/code>ï¼Œåˆ™ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå¹¶åˆ‡æ¢åˆ°è¯¥ç›®å½•ï¼Œåç»­çš„æ“ä½œå’Œå‘½ä»¤éƒ½ä¼šåœ¨è¿™ä¸ªæ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>hugo new site hugo-blog
cd hugo-blog
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>å®‰è£…ä¸€ä¸ªä¸»é¢˜ã€‚è¿™ä¸€æ­¥æ˜¯å¿…éœ€çš„ï¼Œå¦åˆ™ä¼šå› ä¸ºç¼ºå°‘åŸºç¡€æ¨¡æ¿æ— æ³•ç”Ÿæˆç«™ç‚¹ã€‚å®‰è£…ä¸»é¢˜æœ‰ 3 ç§æ–¹å¼ï¼Œä»¥ &lt;code>eureka&lt;/code> ä¸»é¢˜ä¸ºä¾‹ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç›´æ¥ä¸‹è½½ä¸»é¢˜çš„å‹ç¼©æ–‡ä»¶ï¼Œå°†è§£å‹å¾—åˆ°çš„æ–‡ä»¶å¤¹é‡å‘½åä¸ºä¸»é¢˜åç§° &lt;code>eureka&lt;/code> æ”¾åˆ° &lt;code>themes/&lt;/code>ç›®å½•ä¸‹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡ &lt;code>git submodule&lt;/code> å®‰è£…ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>git init
git submodule add https://github.com/wangchucheng/hugo-eureka.git themes/eureka
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>é€šè¿‡ &lt;code>Hugo Modules&lt;/code> å®‰è£…ï¼ˆè¿™ç§æ–¹å¼è¦æ±‚æœ¬æœºå®‰è£…æœ‰ &lt;a href="https://golang.org/dl/">Go 1.12&lt;/a> åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œä¸”åªæœ‰éƒ¨åˆ†ä¸»é¢˜æ”¯æŒï¼‰ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>hugo mod init &amp;lt;module_name&amp;gt;
&lt;/code>&lt;/pre>&lt;p>&lt;code>&amp;lt;module_name&amp;gt;&lt;/code> å¹¶ä¸é‡è¦ï¼Œéšä¾¿èµ·ä¸ªåå­—å°±è¡Œã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å®‰è£…åéœ€è¦å¯ç”¨ä¸»é¢˜ï¼Œæ–¹æ³•æ˜¯å°†ä¸»é¢˜åç§°å†™å…¥åˆ°æ ¹ç›®å½•ä¸‹çš„é»˜è®¤é…ç½®æ–‡ä»¶ &lt;code>config.yml&lt;/code> ä¸­ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>echo &amp;#39;theme = &amp;#34;eureka&amp;#34;&amp;#39; &amp;gt;&amp;gt; config.toml
&lt;/code>&lt;/pre>&lt;p>å¦‚æœæ˜¯é€šè¿‡ &lt;code>Hugo Modules&lt;/code> å®‰è£…ï¼Œéœ€è¦æŠŠä¸»é¢˜åç§°æ›¿æ¢æˆæ¨¡å—åç§°ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>echo &amp;#39;theme = &amp;#34;github.com/wangchucheng/hugo-eureka&amp;#34;&amp;#39; &amp;gt;&amp;gt; config.toml
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>æ·»åŠ ä¸€ç¯‡æ–‡ç« ã€‚å¯ä»¥ç›´æ¥åœ¨ &lt;code>content/posts&lt;/code> ç›®å½•ä¸‹åˆ›å»º markdown æ–‡ä»¶ï¼Œä½†éœ€è¦æ‰‹åŠ¨å†™å…¥ä¸€äº›å…ƒä¿¡æ¯ï¼Œå› æ­¤æ¨èä½¿ç”¨ Hugo è‡ªå¸¦çš„å‘½ä»¤ï¼š&lt;code>hugo new posts/my-first-post.md&lt;/code>ï¼Œæ·»åŠ çš„æ–‡ä»¶ä¼šä»¥å¦‚ä¸‹å…ƒä¿¡æ¯å¼€å¤´ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>---
title: &amp;#34;My First Post&amp;#34;
date: 2019-03-26T08:47:11+01:00
draft: true
---
&lt;/code>&lt;/pre>&lt;p>åœ¨ä¸‹æ–¹æ¥ç€å†™å…¥æ–‡ç« å†…å®¹å³å¯ã€‚æ³¨æ„æ­¤æ—¶è¯¥æ–‡ä»¶ä¸ºè‰ç¨¿çŠ¶æ€ï¼Œå†™ä½œå®Œæˆåéœ€è¦æ”¹æˆ &lt;code>draft: false&lt;/code> æ‰èƒ½éƒ¨ç½²ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯åŠ¨ Hugo é¢„è§ˆæœåŠ¡å™¨ã€‚Hugo å¯ä»¥å¯åŠ¨ä¸€ä¸ª Web æœåŠ¡å™¨ï¼ŒåŒæ—¶æ„å»ºç«™ç‚¹å†…å®¹åˆ°å†…å­˜ä¸­å¹¶åœ¨æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹åé‡æ–°æ¸²æŸ“ï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨å¼€å‘ç¯å¢ƒå®æ—¶é¢„è§ˆå¯¹ç«™ç‚¹æ‰€åšçš„æ›´æ”¹ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code>hugo server -D
&lt;/code>&lt;/pre>&lt;p>æ·»åŠ  &lt;code>-D&lt;/code> é€‰é¡¹ä»¥è¾“å‡ºè‰ç¨¿çŠ¶æ€çš„æ–‡ç« ï¼Œæ‰§è¡ŒæˆåŠŸåå¯ä»¥é€šè¿‡ &lt;code>http://localhost:1313/&lt;/code> è®¿é—®ç«™ç‚¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è‡ªå®šä¹‰ä¸»é¢˜é…ç½®ã€‚ç«™ç‚¹çš„é…ç½®é¡¹é»˜è®¤ä¿å­˜åœ¨æ ¹ç›®å½•çš„ &lt;code>config.toml&lt;/code> æ–‡ä»¶ä¸­ï¼Œé…ç½®é¡¹è¾ƒå¤šæ—¶é€šå¸¸ä¼šç”¨ä¸»é¢˜æä¾›çš„é¢„è®¾é…ç½®æ–‡ä»¶æ¥æ›¿æ¢è¯¥æ–‡ä»¶ï¼Œè¿˜å¯ä»¥é€šè¿‡&lt;code>config&lt;/code> ç›®å½•åŠ å¤šä¸ªæ–‡ä»¶çš„æ–¹å¼æ¥ç»„ç»‡é…ç½®ã€‚é»˜è®¤é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>baseURL = &amp;#34;http://example.org/&amp;#34; # å‘å¸ƒåœ°å€ï¼Œç”±ä¸»æœºåä»¥åŠè·¯å¾„ç»„æˆ
languageCode = &amp;#34;en-us&amp;#34; # è¯­è¨€ä»£ç ï¼Œä¸­æ–‡å¯ä»¥è®¾ç½®ä¸º&amp;#34;zh&amp;#34;
title = &amp;#34;My New Hugo Site&amp;#34; # ç«™ç‚¹æ ‡é¢˜
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸€æ­¥åº”è¯¥æ˜¯æ•´ä¸ªè¿‡ç¨‹ä¸­æœ€éº»çƒ¦ä¹Ÿæ˜¯æœ€å®¹æ˜“å‡ºé—®é¢˜çš„ä¸€æ­¥ï¼Œè§†ä¹ä½ é€‰æ‹©çš„ä¸»é¢˜ä¸æƒ³è¦çš„åŠŸèƒ½ä¸åŒï¼Œéœ€è¦è‡ªå®šä¹‰çš„é…ç½®é¡¹ä¹Ÿä¸åŒï¼Œæ•°é‡ä»å‡ ä¸ªåˆ°ä¸Šç™¾ä¸ªä¸ç­‰ã€‚æœ‰äº›ä¸»é¢˜ä¼šæœ‰è¯¦ç»†çš„æ–‡æ¡£è§£é‡Šé…ç½®è¿‡ç¨‹ï¼Œæœ‰äº›åˆ™ä¸€ç¬”å¸¦è¿‡åªèƒ½è‡ªå·±å»æ‘¸ç´¢ï¼Œé…ç½®è¾ƒå¤šæ—¶ç›¸äº’é—´å¯èƒ½è¿˜æœ‰ä¾èµ–å…³ç³»ï¼Œæœ€å¥½æ›´æ”¹ä¸€ä¸ªé…ç½®å°±åˆ·æ–°ä¸€æ¬¡é¡µé¢ç¡®è®¤ä¸‹ç»“æœã€‚&lt;/p>
&lt;p>å»ºè®®èµ·æ­¥æ—¶ä¸€åˆ‡ä»ç®€ï¼ŒèŠ±å¤§æŠŠæ—¶é—´æå„ç§èŠ±é‡Œèƒ¡å“¨çš„æ ·å¼å’ŒåŠŸèƒ½ï¼Œè¿˜ä¸å¦‚å¤šå†™å‡ ç¯‡æ–‡ç« ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ„å»ºé™æ€é¡µé¢ã€‚ç«™ç‚¹é…ç½®æˆæˆ‘ä»¬ç†æƒ³çš„æ•ˆæœä¹‹åå°±å¯ä»¥æ„å»ºé™æ€é¡µé¢äº†ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>hugo -D
&lt;/code>&lt;/pre>&lt;p>æ·»åŠ  &lt;code>-D&lt;/code> é€‰é¡¹å¯ä»¥åœ¨ç»“æœä¸­åŒ…æ‹¬è‰ç¨¿å†…å®¹ï¼Œé»˜è®¤æƒ…å†µä¸‹é™æ€é¡µé¢ä¼šè¾“å‡ºåˆ°æ ¹ç›®å½•ä¸‹çš„ &lt;code>public&lt;/code> æ–‡ä»¶å¤¹ä¸­ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="é€šè¿‡-github-pages-å‘å¸ƒ">é€šè¿‡ GitHub Pages å‘å¸ƒ&lt;/h2>
&lt;p>è¿™ä¸€æ­¥ Hugo çš„å®˜æ–¹æ–‡æ¡£åŒæ ·åœ¨ &lt;a href="https://gohugo.io/hosting-and-deployment/hosting-on-github/">Host on GitHub&lt;/a> ä¸­è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ï¼Œå¹¶ä¸”è¿˜å¾ˆè´´å¿ƒçš„æä¾›äº†è‡ªåŠ¨åŒ–æ“ä½œçš„ Shell è„šæœ¬ã€‚&lt;/p>
&lt;p>æœ‰ä¸¤ç§æ–¹å¼ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é€šè¿‡ä¸ªäººä¸»é¡µå‘å¸ƒï¼šå¿…é¡»åˆ›å»ºä¸€ä¸ª &lt;code>&amp;lt;USERNAME&amp;gt;.github.io&lt;/code> ä»“åº“æ¥æ‰˜ç®¡ç”Ÿæˆçš„é™æ€å†…å®¹ï¼Œå‘å¸ƒåçš„åŸŸåä¸º &lt;code>https://&amp;lt;USERNAME&amp;gt;.github.io&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡é¡¹ç›®ä¸»é¡µå‘å¸ƒï¼šå¯ä»¥éšæ„åˆ›å»º &lt;code>&amp;lt;PROJECT_NAME&amp;gt;&lt;/code> ä»“åº“ï¼Œå‘å¸ƒåçš„åŸŸåä¸º &lt;code>https://&amp;lt;USERNAME&amp;gt;.github.io/&amp;lt;PROJECT_NAME&amp;gt;&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>è§†é€‰æ‹©çš„å‘å¸ƒæ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬éœ€è¦å°† &lt;code>config.yml&lt;/code> ä¸­çš„ &lt;code>baseUrl&lt;/code> è®¾ç½®ä¸ºä¸åŒçš„å€¼ã€‚&lt;/p>
&lt;h3 id="é€šè¿‡ä¸ªäººä¸»é¡µå‘å¸ƒ">é€šè¿‡ä¸ªäººä¸»é¡µå‘å¸ƒ&lt;/h3>
&lt;p>å»ºè®®éç‰¹æ®Šæƒ…å†µä¸‹ä½¿ç”¨ç¬¬ 1 ç§æ–¹å¼ï¼ŒåŸå› æ˜¯è®¸å¤šä¸»é¢˜éƒ½ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒç¬¬ 2 ç§ï¼Œå…·ä½“æ¥è¯´æ˜¯å°† &lt;code>config.toml&lt;/code> çš„ &lt;code>baseURL&lt;/code> è®¾ç½®ä¸ºå«å­è·¯å¾„çš„åœ°å€æ—¶ï¼Œä¸èƒ½æ­£ç¡®çš„å¤„ç†æ‰€æœ‰èµ„æºçš„æ„å»ºä½ç½®ã€‚æˆ‘å°è¯•äº† 3 ä¸ªä¸»é¢˜ï¼Œå‡é­é‡äº†ä¸åŒçš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>eureka&lt;/code>: æ„å»ºå¤±è´¥ï¼Œæç¤º :&lt;/p>
&lt;pre tabindex="0">&lt;code>Error: Error building site: POSTCSS: failed to transform &amp;#34;css/eureka.css&amp;#34; (text/css): resource &amp;#34;css/waynerv.github.io/css/eureka.css_fc3f76d7bee2760c3a903059afc3d9b2&amp;#34; not found in file cache
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>&lt;code>LoveIt&lt;/code>: æ„å»ºæˆåŠŸï¼Œä½†é™¤ä¸»é¡µä»¥å¤–çš„æ–‡ç« ã€åˆ†ç±»å’Œæ ‡ç­¾çš„é¡µé¢å‡æç¤º 404ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>MemE&lt;/code>: æ„å»ºæˆåŠŸï¼Œä½†æ–‡ç« ä¸­æ’å…¥çš„å›¾ç‰‡åŠ è½½ 404ï¼ˆæ”¾åœ¨åŒä¸€æ–‡ä»¶å¤¹çš„&lt;code>favicon&lt;/code> å´èƒ½æ­£å¸¸å±•ç¤ºï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ªé—®é¢˜æˆ‘åœ¨ &lt;code>eureka&lt;/code> é¡¹ç›®æäº¤äº† issueï¼Œå¼€å‘è€…å›å¤å¯èƒ½æ˜¯ Hugo æœ¬èº«çš„æœºåˆ¶æ‰€å¯¼è‡´ï¼Œå¹¶å·²ç»åœ¨ Hugo è®ºå›ä¸­æå‡ºäº†æ­¤&lt;a href="https://discourse.gohugo.io/t/cached-resources-not-found-in-file-cache-when-baseurl-contains-subdirectory/30182/8">é—®é¢˜&lt;/a>ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å…³æ³¨åç»­è¿›å±•ã€‚&lt;/p>
&lt;h3 id="å‘å¸ƒæ­¥éª¤">å‘å¸ƒæ­¥éª¤&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>åœ¨ GitHub åˆ›å»ºä¸ªäººä¸»é¡µä»“åº“ï¼Œä»“åº“åç§°å¿…é¡»è®¾ç½®ä¸º &lt;code>&amp;lt;USERNAME&amp;gt;.github.io&lt;/code>ï¼Œè¿™ä¸ªä»“åº“ä»…å­˜æ”¾ç”Ÿæˆçš„é™æ€å†…å®¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨ GitHub åˆ›å»ºä¸€ä¸ªé¡¹ç›®ä»“åº“ &lt;code>hugo-blog&lt;/code> å¹¶æ·»åŠ ä¸ºæˆ‘ä»¬æœ¬åœ°é¡¹ç›®æ–‡ä»¶å¤¹çš„è¿œç¨‹ä»“åº“ã€‚è¿™ä¸ªä»“åº“ç”¨æ¥ç»´æŠ¤ç«™ç‚¹é…ç½®å’ŒåŸå§‹çš„æ–‡ç« å†…å®¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å‡è®¾æˆ‘ä»¬åœ¨å·²ç»é€šè¿‡ä¸Šæ–‡çš„æ­¥éª¤åœ¨ &lt;code>public&lt;/code> æ–‡ä»¶å¤¹ä¸­ç”Ÿæˆäº†æƒ³å‘å¸ƒçš„é™æ€å†…å®¹ï¼Œè¿è¡Œï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>git submodule add -b main https://github.com/&amp;lt;USERNAME&amp;gt;/&amp;lt;USERNAME&amp;gt;.github.io.git public
&lt;/code>&lt;/pre>&lt;p>åœ¨ &lt;code>public&lt;/code> ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª git å­æ¨¡å—ï¼Œä¹‹åè¿™ä¸ªç›®å½•å°†ä»¥ &lt;code>https://github.com/&amp;lt;USERNAME&amp;gt;/&amp;lt;USERNAME&amp;gt;.github.io&lt;/code> ä½œä¸ºè¿œç¨‹ä»“åº“ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­çš„ &lt;code>baseUrl&lt;/code> å·²ç»è®¾ç½®ä¸ºäº† &lt;code>&amp;lt;USERNAME&amp;gt;.github.io&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Hugo ä¸ºæˆ‘ä»¬æ¥ä¸‹æ¥çš„éƒ¨ç½²æ“ä½œæä¾›äº†ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„ Shell è„šæœ¬ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>#!/bin/sh
# ä»»ä¸€æ­¥éª¤æ‰§è¡Œå¤±è´¥éƒ½ä¼šç»ˆæ­¢æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹
set -e
printf &amp;#34;\033[0;32mDeploying updates to GitHub...\033[0m\n&amp;#34;
# æ„å»ºé™æ€å†…å®¹
hugo # if using a theme, replace with `hugo -t &amp;lt;YOURTHEME&amp;gt;`
# åˆ‡æ¢åˆ° Public æ–‡ä»¶å¤¹
cd public
# æ·»åŠ æ›´æ”¹åˆ° git
git add .
# æäº¤æ›´æ”¹
msg=&amp;#34;rebuilding site $(date)&amp;#34;
if [ -n &amp;#34;$*&amp;#34; ]; then
msg=&amp;#34;$*&amp;#34;
fi
git commit -m &amp;#34;$msg&amp;#34;
# æ¨é€åˆ°è¿œç¨‹ä»“åº“
git push origin main
&lt;/code>&lt;/pre>&lt;/li>
&lt;/ol>
&lt;p>å°†å¦‚ä¸Šå†…å®¹ä¿å­˜åˆ° &lt;code>deploy.sh&lt;/code> æ–‡ä»¶ä¸­ï¼Œå¹¶æ‰§è¡Œ &lt;code>chmod +x deploy.sh&lt;/code> ä¸ºå…¶æ·»åŠ å¯æ‰§è¡Œæƒé™ã€‚æ¥ç€æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>./deploy.sh
&lt;/code>&lt;/pre>&lt;p>å¤§åŠŸå‘Šæˆï¼ç¨ç­‰å‡ åˆ†é’Ÿå°±å¯ä»¥åœ¨ &lt;code>https://&amp;lt;USERNAME&amp;gt;.github.io&lt;/code> çœ‹åˆ°æˆ‘ä»¬çš„ä¸ªäººåšå®¢äº†ã€‚&lt;/p>
&lt;h2 id="é€šè¿‡-github-actions-è‡ªåŠ¨éƒ¨ç½²">é€šè¿‡ GitHub Actions è‡ªåŠ¨éƒ¨ç½²&lt;/h2>
&lt;p>ç›®å‰æˆ‘ä»¬çš„ã€Œåˆ›ä½œ-å‘å¸ƒã€æµç¨‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨é¡¹ç›®ä»“åº“ç¼–è¾‘åŸå§‹å†…å®¹å¹¶è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‰§è¡Œè‡ªåŠ¨è„šæœ¬ç”Ÿæˆé™æ€ç«™ç‚¹å¹¶æ¨é€åˆ°ä¸ªäººä¸»é¡µä»“åº“å®Œæˆå‘å¸ƒã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>è¿™å¥—æµç¨‹å·²ç»å¾ˆæµç•…ï¼Œä½†è¿˜æœ‰ä¸€äº›æ”¹è¿›ç©ºé—´ï¼šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;a href="https://github.com/features/actions">GitHub Actions&lt;/a>ï¼Œåœ¨æ¯æ¬¡å‘è¿œç¨‹çš„é¡¹ç›®ä»“åº“æ¨é€åŸå§‹å†…å®¹æ›´æ”¹æ—¶è‡ªåŠ¨æ‰§è¡Œç¬¬ 2 æ­¥è¿›è¡Œå‘å¸ƒã€‚&lt;/p>
&lt;p>GitHub ä¸Šæœ‰è®¸å¤šè¿™ç±»è‡ªåŠ¨åŒ–éƒ¨ç½²ä»»åŠ¡çš„å¼€æº Actions é¡¹ç›®ï¼Œæˆ‘ä»¬é€‰æ‹©äº†å…¶ä¸­ä¸€ä¸ªç®€å•æ˜“ç”¨çš„ &lt;a href="https://github.com/peaceiris/actions-hugo#getting-started">GitHub Actions for Hugo&lt;/a>ã€‚å…·ä½“çš„æ“ä½œæ­¥éª¤æˆªå›¾å’Œè¯¦ç»†é…ç½®é¡¹å¯ä»¥æŸ¥çœ‹è¯¥é¡¹ç›®çš„ &lt;a href="https://github.com/peaceiris/actions-hugo#github-actions-for-hugo">README&lt;/a>ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸‹é…ç½®è¿‡ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­æ·»åŠ ç›®å½•å’Œæ–‡ä»¶ï¼š&lt;code>.github/workflows/gh-pages.yml&lt;/code>ï¼Œ&lt;code>gh-pages.yml&lt;/code> æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>name: github pages
on:
push:
branches:
- main # æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯éƒ½ä¼šè§¦å‘éƒ¨ç½²ä»»åŠ¡
jobs:
deploy:
runs-on: ubuntu-18.04
steps:
- uses: actions/checkout@v2
with:
submodules: true # Fetch Hugo themes (true OR recursive)
fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod
- name: Setup Hugo
uses: peaceiris/actions-hugo@v2
with:
hugo-version: &amp;#39;0.79.1&amp;#39;
extended: true
- name: Build
run: hugo --minify
- name: Deploy
uses: peaceiris/actions-gh-pages@v3
with:
deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
external_repository: &amp;lt;USERNAME&amp;gt;/&amp;lt;USERNAME&amp;gt;.github.io # æ›¿æ¢æˆä¸Šæ–‡æ‰€åˆ›å»ºçš„ä¸ªäººä¸»é¡µä»“åº“
publish_branch: main
publish_dir: ./public
&lt;/code>&lt;/pre>&lt;p>è¿™ä¸ªæ–‡ä»¶æ‰€å®šä¹‰çš„ &lt;code>workflow&lt;/code> åŸºäºé¡¹ç›®ä»“åº“è¿è¡Œï¼Œä½†æˆ‘ä»¬éœ€è¦å°†è¿è¡Œè¿‡ç¨‹ç”Ÿæˆçš„é™æ€æ–‡ä»¶æ¨é€åˆ°ä¸ªäººä¸»é¡µä»“åº“ &lt;code>&amp;lt;USERNAME&amp;gt;.github.io&lt;/code> å®Œæˆå‘å¸ƒï¼Œå› æ­¤åœ¨ &lt;code>Deploy&lt;/code> ä»»åŠ¡ä¸­æŒ‰ç…§æ–‡æ¡£çš„ &lt;a href="https://github.com/peaceiris/actions-gh-pages#%EF%B8%8F-deploy-to-external-repository-external_repository">Deploy to external repository &lt;code>external_repository&lt;/code>&lt;/a> ä¸€èŠ‚åšäº†ä¸“é—¨çš„é…ç½®ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æœ¬åœ°ç”Ÿæˆ SSH éƒ¨ç½²å¯†é’¥ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>ssh-keygen -t rsa -b 4096 -C &amp;#34;$(git config user.email)&amp;#34; -f gh-pages -N &amp;#34;&amp;#34;
# å°†åœ¨å½“å‰ç›®å½•ç”Ÿæˆå¦‚ä¸‹å¯†é’¥æ–‡ä»¶:
# gh-pages.pub (å…¬é’¥)
# gh-pages (ç§é’¥)
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>åœ¨ GitHub åˆ†åˆ«è¿›å…¥é¡¹ç›®ä»“åº“å’Œä¸ªäººä¸»é¡µä»“åº“çš„ &lt;code>Settings&lt;/code> é¡µé¢ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å°†å…¬é’¥ &lt;code>gh-pages.pub&lt;/code> ä½œä¸º &lt;code>Secret&lt;/code> æ·»åŠ åˆ°é¡¹ç›®ä»“åº“ï¼Œå¹¶è®¾ç½® &lt;code>Name&lt;/code> ä¸º &lt;code>ACTIONS_DEPLOY_KEY&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å°†ç§é’¥ &lt;code>gh-pages&lt;/code> ä½œä¸º &lt;code>Deploy Key&lt;/code> æ·»åŠ åˆ°ä¸ªäººä¸»é¡µä»“åº“ï¼Œå¹¶è®¾ç½®ä¸º &lt;code>Allow write access&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹æ•ˆæœã€‚&lt;/p>
&lt;p>åœ¨æœ¬åœ°åšä¸€äº›æ›´æ”¹ï¼Œé¢„è§ˆæ•ˆæœåæäº¤å¹¶æ¨é€ï¼Œç„¶ååœ¨é¡¹ç›®ä»“åº“çš„ GitHub Actions é¡µé¢æ£€æŸ¥ç›¸åº”çš„ &lt;code>workflow&lt;/code> æ˜¯å¦è¿è¡ŒæˆåŠŸã€‚ä¸å‡ºæ„å¤–çš„è¯ï¼Œå¾ˆå¿«ä¸ªäººä¸»é¡µä»“åº“å°†æ–°å¢ä¸€ä¸ªç”±è¯¥ &lt;code>workflow&lt;/code> åˆ›å»ºçš„æäº¤ï¼Œè®¿é—®ä¸ªäººåšå®¢é¡µé¢ä¹Ÿä¼šå‘ç°é¡µé¢å·²ç»æ›´æ–°ã€‚&lt;/p>
&lt;h2 id="ä¸ªäººä½“éªŒ">ä¸ªäººä½“éªŒ&lt;/h2>
&lt;p>ç”±äºå…ˆåé€‰æ‹©çš„ 3 ä¸ªä¸»é¢˜å‡é­é‡äº†ä¸Šè¿°å‘å¸ƒåœ°å€ä¸èƒ½åŒ…å«å­è·¯å¾„çš„é—®é¢˜ï¼Œæˆ‘åœ¨åŸºæœ¬æŒ‰ç…§å®˜æ–¹æ–‡æ¡£æ“ä½œçš„å‰æä¸‹ï¼Œä¾ç„¶èŠ±äº†è¶…è¿‡ 10 ä¸ªå°æ—¶æ‰æŠŠ&lt;a href="https://waynerv.github.io/">åšå®¢&lt;/a>ä¸Šçº¿ï¼Œæµªè´¹äº†å¾ˆå¤šæ—¶é—´åœ¨é…ç½®ä¸»é¢˜ä»¥åŠå¯»æ‰¾é—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¸Šã€‚æœ¬ä»¥ä¸ºé€‰æ‹©äº†ä¸€ä¸ªç®€å•å¿«æ·çš„çœå¿ƒæ–¹æ¡ˆï¼Œç»“æœè¿˜æ˜¯å…ä¸äº†è¿‡ç¨‹çš„ä¸€é¡¿è¸©å‘å’ŒæŠ˜è…¾ã€‚&lt;/p>
&lt;p>è™½ç„¶æ­å»ºåšå®¢çš„æµç¨‹ä¸ç®—çœå¿ƒï¼Œä½†æˆ‘æ‰€é‡åˆ°çš„è¿™äº›é—®é¢˜ä¹Ÿç®—æ˜¯ä¸ªä¾‹ã€‚ä¸€åˆ‡å‡†å¤‡å°±ç»ªåï¼Œæˆ‘ä»¬å¯ä»¥åƒå†™ä»£ç ä¸€æ ·å†™åšå®¢ï¼Œå¯¹æ–‡ç« ä¿®æ”¹æäº¤å³è‡ªåŠ¨å‘å¸ƒï¼Œä¹Ÿä¸éœ€è¦è€ƒè™‘åšå®¢çš„æ ·å¼ã€åå°åŠŸèƒ½åŠä¸»æœºç»´æŠ¤ç­‰é—®é¢˜ï¼Œå¯¹æå‡å†™ä½œæ•ˆç‡ä¼šæœ‰æ‰€å¸®åŠ©ï¼Œå¯ä»¥çœä¸‹æ¥å¾ˆå¤šçš„æ—¶é—´å’Œç²¾åŠ›ï¼Œç»¼åˆæ¥çœ‹ä½“éªŒè¿˜æ˜¯ä¸é”™çš„ã€‚&lt;/p></content><category scheme="https://waynerv.com/categories/%E4%B8%AA%E4%BA%BA/" term="ä¸ªäºº" label="ä¸ªäºº"/><category scheme="https://waynerv.com/tags/%E5%8D%9A%E5%AE%A2/" term="åšå®¢" label="åšå®¢"/><category scheme="https://waynerv.com/tags/hugo/" term="Hugo" label="Hugo"/><category scheme="https://waynerv.com/tags/github/" term="GitHub" label="GitHub"/></entry><entry><title type="text">æ·±å…¥ç†è§£ git åˆå¹¶æ“ä½œ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/git-merge-intro/"/><id>https://waynerv.com/posts/git-merge-intro/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2020-11-29T07:17:23+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">åˆå¹¶åœ¨ Git ä¸­æ˜¯ä¸€ä¸ªååˆ†å¸¸è§çš„æ“ä½œï¼šæ•´åˆä¸åŒåˆ†æ”¯ä¹‹é—´çš„æ›´æ”¹ï¼Œæˆ–è€…å¯¹è¿œç¨‹åˆ†æ”¯æ‰§è¡Œ pull åŠ push æ“ä½œï¼Œéƒ½éœ€è¦è¿›è¡Œåˆå¹¶ã€‚ ä½†å¯¹æ–°æ‰‹æ¥è¯´ï¼Œ git merge è¿™ä¸€å‘½ä»¤â€¦â€¦</summary><content type="html">&lt;p>åˆå¹¶åœ¨ Git ä¸­æ˜¯ä¸€ä¸ªååˆ†å¸¸è§çš„æ“ä½œï¼šæ•´åˆä¸åŒåˆ†æ”¯ä¹‹é—´çš„æ›´æ”¹ï¼Œæˆ–è€…å¯¹è¿œç¨‹åˆ†æ”¯æ‰§è¡Œ &lt;code>pull&lt;/code> åŠ &lt;code>push&lt;/code> æ“ä½œï¼Œéƒ½éœ€è¦è¿›è¡Œåˆå¹¶ã€‚&lt;/p>
&lt;p>ä½†å¯¹æ–°æ‰‹æ¥è¯´ï¼Œ &lt;code>git merge&lt;/code> è¿™ä¸€å‘½ä»¤æœ‰äº›ä»¤äººç”Ÿç•ï¼Œå› ä¸ºåœ¨ä¸åŒæƒ…å†µä¸‹ï¼Œæ‰§è¡Œ &lt;code>merge&lt;/code> å¯èƒ½ä¼šå¾—åˆ°ä¸åŒçš„ç»“æœã€‚è¿™ç§å¯¹äºç»“æœçš„ä¸ç¡®å®šæ€§ï¼Œä½¿æˆ‘å¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸æ•¢ä¸»åŠ¨å»ä½¿ç”¨å®ƒï¼Œè€Œæ˜¯ä¾èµ– GitHub çš„ &lt;code>Pull Request&lt;/code> æˆ–è€… GitLab çš„ &lt;code>Merge Request&lt;/code> ç­‰å¯è§†åŒ–ç•Œé¢æ‰‹åŠ¨åˆå¹¶ã€‚&lt;/p>
&lt;p>ä¸ºäº†ä»Šåå¯ä»¥æ”¾å¿ƒå¤§èƒ†çš„ &lt;code>merge&lt;/code>ï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥å¯¹ &lt;code>merge&lt;/code> ä¸€æ¢ç©¶ç«Ÿã€‚&lt;/p>
&lt;h2 id="è®¤è¯†åˆå¹¶">è®¤è¯†åˆå¹¶&lt;/h2>
&lt;p>åœ¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿä¸­ï¼Œåˆå¹¶æ˜¯å°†ä¸€ç»„æ–‡ä»¶ä¸­æ‰€å‘ç”Ÿçš„ä¸åŒæ›´æ”¹è¿›è¡Œæ•´åˆçš„åŸºç¡€æ“ä½œã€‚é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Git æ—¶ä¼šå»ºç«‹ä¸åŒçš„åˆ†æ”¯ï¼Œç”±ä¸åŒçš„äººå¯¹åŒä¸€ç»„æ–‡ä»¶æ‰§è¡Œæ–°å¢ã€ç¼–è¾‘ç­‰æ“ä½œï¼Œæœ€ç»ˆæˆ‘ä»¬éœ€è¦åˆå¹¶è¿™äº›åä½œçš„åˆ†æ”¯ï¼Œæ•´åˆæ‰€æœ‰çš„æ›´æ”¹å½¢æˆä¸€ä»½æ–‡ä»¶ç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>åˆå¹¶ä¸€èˆ¬ç”± Git æ ¹æ®ç®—æ³•è‡ªåŠ¨æ‰§è¡Œï¼Œä½†å¦‚æœå‘ç”Ÿäº†å†²çªï¼Œæ¯”å¦‚å¯¹åŒä¸€æ–‡ä»¶çš„åŒä¸€å¤„å†…å®¹æ‰§è¡Œäº†ä¸åŒçš„æ›´æ”¹ï¼Œåˆ™éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆå¹¶ã€‚&lt;/p>
&lt;h3 id="é€’å½’ä¸‰è·¯åˆå¹¶ç®—æ³•">é€’å½’ä¸‰è·¯åˆå¹¶ç®—æ³•&lt;/h3>
&lt;p>Git åœ¨è‡ªåŠ¨åˆå¹¶æ—¶ä¼šä½¿ç”¨ã€Œ&lt;a href="https://en.wikipedia.org/wiki/Merge_(version_control)#Recursive_three-way_merge">é€’å½’ä¸‰è·¯åˆå¹¶&lt;/a>ã€ç®—æ³•å¯¹ä¸åŒæ–‡ä»¶è¿›è¡Œå·®å¼‚åˆ†æï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç®€å•äº†è§£ä¸€ä¸‹è¯¥ç®—æ³•ã€‚&lt;/p>
&lt;p>é¦–å…ˆä»ã€Œä¸‰è·¯åˆå¹¶ã€ç®—æ³•å¼€å§‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹æäº¤å†å²ï¼š&lt;/p>
&lt;p>&lt;img src="Dec-29-2020-merge.gif" alt="Dec-29-2020 22-40-46">&lt;/p>
&lt;p>ä¸Šå›¾ä¸­æˆ‘ä»¬åœ¨ &lt;code>master&lt;/code> åˆå¹¶äº† &lt;code>feature&lt;/code> åˆ†æ”¯ï¼Œç°åœ¨æˆ‘ä»¬å›æº¯ä¸€ä¸‹åˆå¹¶çš„è¿‡ç¨‹ï¼š&lt;/p>
&lt;p>æ­¤æ—¶ &lt;code>master&lt;/code> æ­£æŒ‡å‘æäº¤ Cï¼ŒGit é¦–å…ˆæ‰¾åˆ°ä¸¤ä¸ªåˆ†æ”¯æœ€è¿‘çš„å”¯ä¸€å…±åŒç¥–å…ˆæäº¤ Aï¼Œç„¶ååˆ†åˆ«å¯¹ Aã€Cã€F æäº¤çš„æ–‡ä»¶å¿«ç…§è¿›è¡Œå¯¹æ¯”ï¼Œæˆ‘ä»¬ä¸‹æ–‡ç§°å‘¼å®ƒä»¬ä¸º Aã€Cã€F æ–‡ä»¶ã€‚æ¥ä¸‹æ¥ Git å°†é€ã€Œè¡Œã€å¯¹ä¸‰ä¸ªæ–‡ä»¶çš„å†…å®¹è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸‰ä¸ªæ–‡ä»¶ä¸­æœ‰ä¸¤ä¸ªæ–‡ä»¶è¯¥è¡Œçš„å†…å®¹ä¸€è‡´ï¼Œåˆ™ä¸¢å¼ƒ A æ–‡ä»¶ä¸­è¯¥è¡Œçš„å†…å®¹ï¼Œä¿ç•™ä¸ A æ–‡ä»¶ä¸­ä¸åŒçš„å†…å®¹æ”¾åˆ°ç»“æœæ–‡ä»¶ä¸­ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼Œå‡å¦‚ Aã€C å†…å®¹ä¸€è‡´ï¼Œè¯´æ˜è¿™æ˜¯åœ¨ F ä¸­æ›´æ”¹çš„å†…å®¹ï¼Œéœ€è¦ä¿ç•™è¯¥æ›´æ”¹ï¼›Aã€F å†…å®¹ä¸€è‡´åŒç†ï¼›å‡å¦‚ Cã€F å†…å®¹ä¸€è‡´ï¼Œè¯´æ˜ C å’Œ F éƒ½ç›¸å¯¹äº A åšäº†åŒæ ·çš„æ›´æ”¹ï¼ŒåŒæ ·éœ€è¦ä¿ç•™ã€‚é™¤æ­¤ä¹‹å¤–çš„å†…å®¹å·®å¼‚ä»…å‰©ä¸¤ç§æƒ…å†µï¼šå¦‚æœ Aã€Cã€F çš„å†…å®¹éƒ½ä¸€è‡´ï¼Œè¯´æ˜ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿï¼›å¦‚æœè¯¥è¡Œåœ¨ Aã€Cã€F çš„å†…å®¹éƒ½ä¸ä¸€è‡´ï¼Œè¯´æ˜å‘ç”Ÿäº†å†²çªï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆå¹¶é€‰æ‹©éœ€è¦ä¿ç•™çš„å†…å®¹ã€‚&lt;/p>
&lt;p>ç»“æŸå¯¹æ¯”å Git ä¼šä»¥æœ€ç»ˆçš„ç»“æœæ–‡ä»¶å¿«ç…§åˆ›å»ºä¸€ä¸ªæ–°çš„ Merge æäº¤å¹¶æŒ‡å‘å®ƒã€‚&lt;/p>
&lt;p>ä¸‰è·¯åˆå¹¶ç®—æ³•çš„åŸºç¡€æ˜¯æ‰¾åˆ°è¢«åˆå¹¶æ–‡ä»¶çš„å…±åŒç¥–å…ˆï¼Œåœ¨ä¸€äº›ç®€å•çš„åœºæ™¯ä¸­è¿™è¿˜èƒ½è¡Œçš„é€šï¼Œä½†åœ¨é‡åˆ°&lt;a href="https://zh.wikipedia.org/wiki/%E5%90%88%E5%B9%B6_(%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6)#cite_note-2">åå­—äº¤å‰åˆå¹¶ï¼ˆcriss-cross mergeï¼‰&lt;/a>æ—¶ï¼Œä¸å­˜åœ¨å”¯ä¸€çš„æœ€è¿‘å…±åŒç¥–å…ˆï¼Œå¦‚ä¸‹å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="20201229152228-criss-cross-merge.png" alt="20201229152228-criss-cross-merge">&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬éœ€è¦ä» &lt;code>main&lt;/code> åˆ†æ”¯åˆå¹¶ &lt;code>feature&lt;/code> åˆ†æ”¯ï¼Œå³æŠŠ C7 åˆå¹¶åˆ° C8ï¼Œä¼šå‘ç° C8 å’Œ C7 æœ‰ä¸¤ä¸ªå…±åŒç¥–å…ˆï¼Œè¿™ä¸‹æ€ä¹ˆåŠå‘¢ï¼ŸGit é‡‡å–çš„æ˜¯é€’å½’ä¸‰è·¯åˆå¹¶ï¼ˆRecursive three-way mergeï¼‰ï¼Œä¼šå…ˆåˆå¹¶ C3 å’Œ C5 è¿™ä¸¤ä¸ªå…±åŒç¥–å…ˆåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçš„å”¯ä¸€æœ€è¿‘ç¥–å…ˆï¼ˆå‡è®¾ä¸º C9ï¼‰ï¼Œæ¥ç€åœ¨ C9ã€C7ã€C8 ä¹‹é—´æ‰§è¡Œä¸‰è·¯åˆå¹¶ï¼Œå¦‚æœåœ¨åˆå¹¶ C3 å’Œ C5 çš„è¿‡ç¨‹ä¸­åˆå‘ç”Ÿæ²¡æœ‰å”¯ä¸€å…±åŒç¥–å…ˆçš„æƒ…å†µï¼Œåˆ™é€’å½’æ‰§è¡Œä¸Šè¿°è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>å…³äºé€’å½’ä¸‰è·¯åˆå¹¶ç®—æ³•æˆ‘ä»¬å°±äº†è§£åˆ°è¿™é‡Œã€‚&lt;/p>
&lt;h3 id="åˆå¹¶å†²çª">åˆå¹¶å†²çª&lt;/h3>
&lt;p>å¦‚æœä½ åœ¨ä¸¤ä¸ªä¸åŒçš„åˆ†æ”¯ä¸­ï¼Œå¯¹åŒä¸€ä¸ªæ–‡ä»¶çš„åŒä¸€ä¸ªéƒ¨åˆ†è¿›è¡Œäº†ä¸åŒçš„ä¿®æ”¹ï¼ŒGit å°±æ— æ³•è‡ªåŠ¨åœ°åˆå¹¶å®ƒä»¬ï¼Œè€Œæ˜¯ä¼šæš‚åœåˆå¹¶è¿‡ç¨‹ï¼Œç­‰å¾…ä½ å»æ‰‹åŠ¨è§£å†³å†²çªã€‚&lt;/p>
&lt;p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ‰¾åˆ°è¿™äº›éœ€è¦è§£å†³å†²çªçš„æ–‡ä»¶ï¼Œä½¿ç”¨ &lt;code>git status&lt;/code> å¯ä»¥æŸ¥çœ‹è¿™äº›å› åŒ…å«åˆå¹¶å†²çªè€Œå¤„äºæœªåˆå¹¶çŠ¶æ€çš„æ–‡ä»¶ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ git status
On branch master
You have unmerged paths.
(fix conflicts and run &amp;#34;git commit&amp;#34;)
Unmerged paths:
(use &amp;#34;git add &amp;lt;file&amp;gt;...&amp;#34; to mark resolution)
both modified: main.py
no changes added to commit (use &amp;#34;git add&amp;#34; and/or &amp;#34;git commit -a&amp;#34;)
&lt;/code>&lt;/pre>&lt;p>æ‰‹åŠ¨è§£å†³å†²çªç±»ä¼¼äºäºŒé€‰ä¸€çš„è¿‡ç¨‹ï¼ŒGit ä¼šåœ¨æœ‰å†²çªçš„æ–‡ä»¶ä¸­åŠ å…¥ç‰¹æ®Šçš„æ ‡è®°ï¼Œçœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; HEAD:main.py
print(&amp;#34;Hello World&amp;#34;)
=======
print(&amp;#34;World Hello&amp;#34;)
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; feature:main.py
&lt;/code>&lt;/pre>&lt;p>é€šè¿‡ &lt;code>=======&lt;/code> è¿›è¡Œåˆ†å‰²ï¼Œä»¥ &lt;code>&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt;&amp;lt; HEAD:main.py&lt;/code> æ ‡è®°ä¸ºä¸Šç•Œçš„ä¸ŠåŠéƒ¨åˆ†æ˜¯å½“å‰åˆ†æ”¯ &lt;code>master&lt;/code> æ‰€åšçš„æ›´æ”¹ï¼Œä»¥ &lt;code>&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt; feature:main.py&lt;/code> æ ‡è®°ä¸ºä¸‹ç•Œçš„ä¸‹åŠéƒ¨åˆ†æ˜¯è¦åˆå¹¶çš„ &lt;code>feature&lt;/code> å¯¹åŒä¸€å†…å®¹æ‰€åšçš„ä¸åŒæ›´æ”¹ã€‚æˆ‘ä»¬éœ€è¦ç¼–è¾‘æ–‡ä»¶åˆ é™¤è¿™äº›æ ‡è®°ï¼Œä»…ä¿ç•™æˆ‘ä»¬éœ€è¦çš„å†…å®¹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>print(&amp;#34;Hello World&amp;#34;)
&lt;/code>&lt;/pre>&lt;p>å½“ç„¶ä¹Ÿå¯ä»¥ä¸ä»ä¸­é€‰æ‹©ï¼Œè€Œæ˜¯ç”¨ä¸€æ®µå…¨æ–°çš„å†…å®¹å»æ›¿æ¢å®ƒã€‚&lt;/p>
&lt;p>åœ¨è§£å†³äº†æ‰€æœ‰æ–‡ä»¶é‡Œçš„å†²çªä¹‹åï¼Œéœ€è¦ä½¿ç”¨ &lt;code>git add&lt;/code> æš‚å­˜è¿™äº›æ–‡ä»¶æ¥å°†å…¶æ ‡è®°ä¸ºå†²çªå·²è§£å†³ã€‚ç„¶åå†æ‰§è¡Œ &lt;code>git commit&lt;/code> æ¥å®Œæˆåˆå¹¶æäº¤ã€‚ Git ä¼šå°†è§£å†³çš„è¿™äº›å†²çªï¼ŒåŠ å…¥åˆ°ä¸Šæ–‡æåˆ°çš„æ–°å¢çš„ Merge æäº¤é‡Œã€‚&lt;/p>
&lt;h3 id="å¿«è¿›åˆå¹¶">å¿«è¿›åˆå¹¶&lt;/h3>
&lt;p>ä¹Ÿæœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œäº†åˆå¹¶æ“ä½œåï¼Œä¼šå‘ç°å¹¶æ²¡æœ‰å¢åŠ ä¸€ä¸ªæ–°çš„ Merge æäº¤ã€‚è¿™ç§æƒ…å†µæˆ‘ä»¬ç§°ä¹‹ä¸ºå¿«è¿›ï¼ˆfast-forwardï¼‰åˆå¹¶ã€‚&lt;/p>
&lt;p>å‡è®¾æˆ‘ä»¬åŸºäº &lt;code>master&lt;/code> åˆ›å»ºäº† &lt;code>feature&lt;/code> åˆ†æ”¯ï¼Œå¹¶æ–°å¢äº†ä¸€äº›æäº¤ã€‚ç°åœ¨æˆ‘ä»¬å°† &lt;code>feature&lt;/code> çš„æ›´æ”¹åˆå…¥ &lt;code>master&lt;/code> åˆ†æ”¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ git checkout master
$ git merge feature
Updating f42c576..3a0874c
Fast-forward
main.py | 2 ++
task.py | 3 ++
worker.py | 1 ++
3 file changed, 6 insertions(+)
&lt;/code>&lt;/pre>&lt;p>è¿‡ç¨‹ç¤ºæ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>&lt;img src="Dec-29-2020-fast-forward.gif" alt="Dec-29-2020 22-50-28">&lt;/p>
&lt;p>ç”±äºæˆ‘ä»¬æƒ³è¦åˆå¹¶çš„åˆ†æ”¯ &lt;code>feature&lt;/code> æ‰€æŒ‡å‘çš„æäº¤ D æ˜¯ &lt;code>master&lt;/code> çš„ç›´æ¥åç»§ï¼Œ å› æ­¤ Git ä¼šç›´æ¥å°† &lt;code>HEAD&lt;/code> æŒ‡é’ˆå‘å‰ç§»åŠ¨ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœé¡ºç€ä¸€ä¸ªåˆ†æ”¯èµ°ä¸‹å»ä¸€å®šèƒ½å¤Ÿåˆ°è¾¾å¦ä¸€ä¸ªåˆ†æ”¯ï¼Œé‚£ä¹ˆ Git åœ¨åˆå¹¶ä¸¤è€…æ—¶åªä¼šç®€å•çš„å°†æŒ‡é’ˆå‘å‰æ¨è¿›ï¼ˆå³ç§»ï¼‰ï¼Œå› ä¸ºè¿™ç§æƒ…å†µä¸‹çš„åˆå¹¶æ“ä½œæ²¡æœ‰éœ€è¦è§£å†³çš„åˆ†æ­§â€”â€”è¿™å°±å«åšå¿«è¿›ï¼ˆfast-forwardï¼‰ã€‚&lt;/p>
&lt;h2 id="git-çš„ä¸åŒåˆå¹¶ç­–ç•¥">Git çš„ä¸åŒåˆå¹¶ç­–ç•¥&lt;/h2>
&lt;p>æˆ‘ä»¬åœ¨ä½¿ç”¨ Git æ—¶ï¼Œé€šå¸¸ä¼šåŸºäºä¸»åˆ†æ”¯æ‹‰å‡ºè‹¥å¹²æ¡åŠŸèƒ½åˆ†æ”¯è¿›è¡Œå¼€å‘ï¼Œå¼€å‘å®Œæ¯•åå†å°†åŠŸèƒ½åˆ†æ”¯åˆå…¥ä¸»åˆ†æ”¯ã€‚æœ‰ä»¥ä¸‹ä¸åŒçš„åˆ†æ”¯åˆå¹¶ç­–ç•¥ï¼š&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡ &lt;code>merge&lt;/code> æ˜¾å¼åˆå¹¶&lt;/li>
&lt;li>é€šè¿‡ &lt;code>rebase&lt;/code> æˆ– &lt;code>fast-forward&lt;/code> éšå¼åˆå¹¶&lt;/li>
&lt;li>&lt;code>squash&lt;/code> åéšå¼åˆå¹¶&lt;/li>
&lt;/ul>
&lt;h3 id="é€šè¿‡-merge-æ˜¾å¼åˆå¹¶">é€šè¿‡ &lt;code>merge&lt;/code> æ˜¾å¼åˆå¹¶&lt;/h3>
&lt;p>è¿™æ˜¯æœ€å¸¸è§å’Œæœ€ç›´æ¥çš„åˆå¹¶æ–¹å¼ï¼Œä¹Ÿæ˜¯ GitHub å’Œ GitLab ç­‰ä»£ç æ‰˜ç®¡å¹³å°çš„é»˜è®¤å®ç°æ–¹å¼ã€‚&lt;/p>
&lt;p>&lt;img src="Dec-29-2020-merge.gif" alt="Dec-29-2020 22-40-46">&lt;/p>
&lt;p>å½“æˆ‘ä»¬å°†åŠŸèƒ½åˆ†æ”¯åˆå…¥ä¸»åˆ†æ”¯æ—¶ï¼ŒGit ä¼šå¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œé€’å½’ä¸‰è·¯åˆå¹¶ï¼Œå¹¶ä»¥åˆå¹¶ç»“æœåˆ›å»ºä¸€ä¸ªæ–°çš„ Merge æäº¤ã€‚è¿™ä¸ª Merge æäº¤å’Œæ™®é€šçš„æäº¤æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®ƒæœ‰ä¸¤ä¸ªçˆ¶æäº¤ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ git cat-file -p 44ba027
tree 5a1692ba62ef346b59e65e4aa441c731bebc51ff
parent 75bf5c59c2e7e493c98e026a415f16b8f0445e4a
parent bbbe6a4c02aa709299ac891779448daf8203df53
author xx &amp;lt;xx@xx.com&amp;gt; 1609141855 +0800
committer xx &amp;lt;xx@xx.com&amp;gt; 1609141855 +0800
Merge branch &amp;#39;feature&amp;#39; into &amp;#39;master&amp;#39;
&lt;/code>&lt;/pre>&lt;p>æˆ‘ä»¬èƒ½åœ¨æäº¤å†å²ä¸­ï¼Œå¾ˆæ˜äº†åœ°æ ¹æ® Merge æäº¤æŸ¥çœ‹å‘ç”Ÿçš„åˆå¹¶äº‹ä»¶ã€‚ä½†å¦ä¸€æ–¹é¢ï¼Œå¤§é‡çš„ Merge æäº¤ä¼šä½¿ä½ çš„æäº¤å†å²æœ‰å¾ˆå¤šåˆ†å‰ï¼Œç”šè‡³ååˆ†å‡Œä¹±ï¼Œæœ‰äº›å¼€å‘è€…æˆ–è€…å›¢é˜Ÿå¯èƒ½ä¼šæƒ³è¦ä¸€ä¸ªçœ‹ä¸Šå»æ›´åŠ æ•´æ´çš„çº¿æ€§æäº¤å†å²ã€‚&lt;/p>
&lt;p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ Git ä¸ä¼šåœ¨å¿«è¿›åˆå¹¶çš„æƒ…å†µä¸‹åˆ›å»ºå•ç‹¬çš„ Merge æäº¤ã€‚å‡å¦‚æˆ‘ä»¬æƒ³åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½åˆ›å»ºä¸€ä¸ª Merge æäº¤ï¼Œéœ€è¦åœ¨æ‰§è¡Œ &lt;code>git merge&lt;/code> å‘½ä»¤æ—¶æ·»åŠ  &lt;code>--no-ff&lt;/code> é€‰é¡¹ã€‚&lt;/p>
&lt;h3 id="é€šè¿‡-rebase-æˆ–-fast-forward-éšå¼åˆå¹¶">é€šè¿‡ &lt;code>rebase&lt;/code> æˆ– &lt;code>fast-forward&lt;/code> éšå¼åˆå¹¶&lt;/h3>
&lt;p>æˆ‘ä»¬å¯ä»¥ç”¨ &lt;code>rebase&lt;/code> æ›¿æ¢ &lt;code>merge&lt;/code> è¿›è¡Œåˆå¹¶ï¼Œæˆ‘åœ¨ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« &lt;a href="https://waynerv.github.io/posts/git-rebase-intro/">git-rebase æµ…æ&lt;/a>ä¸­è¯¦ç»†ä»‹ç»è¿‡ &lt;code>rebase&lt;/code> çš„åŸç†å’Œç”¨æ³•ï¼Œç®€å•æ¥è¯´ &lt;code>rebase&lt;/code> æ“ä½œä¼šæ‰¾åˆ°ä¸¤ä¸ªåˆ†æ”¯çš„æœ€è¿‘çš„ç¥–å…ˆæäº¤ï¼Œå¹¶åŸºäºç›®æ ‡åˆ†æ”¯æŒ‰é¡ºåºé‡æ–°åº”ç”¨å½“å‰åˆ†æ”¯åœ¨ç¥–å…ˆæäº¤ä¹‹åçš„æ›´æ”¹ã€‚å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹å›¾çš„ &lt;code>master&lt;/code> å’Œ &lt;code>feature&lt;/code> ä¸¤ä¸ªåˆ†æ”¯ï¼Œæ‰§è¡Œä¸‹åˆ—æ“ä½œï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>$ git checkout feature
$ git rebase master
$ git checkout master
$ git merge feature
&lt;/code>&lt;/pre>&lt;p>è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Dec-31-2020-rebase&amp;amp;fast-forfward.gif" alt="Dec-31-2020-rebase&amp;amp;fast-forfward">&lt;/p>
&lt;p>æˆ‘ä»¬é¦–å…ˆç”¨ &lt;code>rebase&lt;/code> å°† &lt;code>master&lt;/code> åˆå¹¶åˆ°äº† &lt;code>feature&lt;/code>ï¼Œå³ä½¿ä¸¤ä¸ªåˆ†æ”¯éƒ½æœ‰ä¸åŒçš„æäº¤ï¼Œä¹Ÿå¾—åˆ°äº†ä¸€æ¡å®Œå…¨çº¿æ€§çš„ &lt;code>feature&lt;/code> åˆ†æ”¯ï¼Œè€Œä¸”æ²¡æœ‰é¢å¤–çš„ Merge æäº¤ã€‚&lt;/p>
&lt;p>æ¥ç€åˆåˆ‡æ¢åˆ° &lt;code>master&lt;/code> åˆ†æ”¯åˆå¹¶äº† &lt;code>feature&lt;/code>ã€‚&lt;code>rebase&lt;/code> ä¹‹åçš„ &lt;code>feature&lt;/code> åˆ†æ”¯ä¸Šï¼Œæ‰€æœ‰æäº¤éƒ½æ˜¯ &lt;code>master&lt;/code> çš„åç»§æäº¤ï¼Œå› æ­¤æˆ‘ä»¬å°†ç›´æ¥æ‰§è¡Œå¿«è¿›åˆå¹¶ã€‚å¿«è¿›åˆå¹¶åªæœ‰åœ¨ &lt;code>master&lt;/code> åˆ†æ”¯ä¸­æ²¡æœ‰æ¯” &lt;code>feature&lt;/code> æ›´æ–°çš„æäº¤æ—¶æ‰ä¼šå‘ç”Ÿï¼ˆä½¿ç”¨ &lt;code>rebase&lt;/code> èƒ½å¤Ÿç¡®ä¿è¯¥ç»“æœï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ&lt;code>master&lt;/code> çš„ &lt;code>HEAD&lt;/code> å¯ä»¥ç›´æ¥å³ç§»åˆ° &lt;code>feature&lt;/code> åˆ†æ”¯çš„æœ€æ–°æäº¤ã€‚è¿™æ ·åˆå¹¶ä¹Ÿä¸ä¼šç”Ÿæˆå•ç‹¬çš„ Merge æäº¤ï¼Œå®ƒåªæ˜¯å°†åˆ†æ”¯æ ‡ç­¾å¿«é€ŸæŒ‡å‘äº†æ–°çš„æäº¤ã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>rebase&lt;/code> æˆ– &lt;code>fast-forward&lt;/code> éšå¼çš„åˆå¹¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾—åˆ°ä¸€æ¡æ•´æ´çº¿æ€§çš„æäº¤å†å²ï¼Œä½†åŒæ—¶ä¹Ÿä¼šä¸¢å¤±è¿™äº›æäº¤æ›¾ç»çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚&lt;/p>
&lt;h3 id="squash-åéšå¼åˆå¹¶">&lt;code>squash&lt;/code> åéšå¼åˆå¹¶&lt;/h3>
&lt;p>è¿˜æœ‰ä¸€ç§åˆå¹¶å˜æ›´çš„ç­–ç•¥æ˜¯ï¼Œåœ¨æ‰§è¡Œå¿«è¿›åˆå¹¶æˆ– &lt;code>rebase&lt;/code> ä¹‹å‰ï¼Œå°†æ‰€æœ‰åŠŸèƒ½åˆ†æ”¯çš„æäº¤é€šè¿‡ &lt;code>rebase&lt;/code> äº¤äº’æ¨¡å¼çš„ &lt;code>squash&lt;/code> å‘½ä»¤å‹ç¼©æˆä¸€ä¸ªæäº¤ã€‚è¿™æ ·å¯ä»¥è¿›ä¸€æ­¥ä¿æŒä¸»åˆ†æ”¯æäº¤å†å²çš„çº¿æ€§å’Œæ•´æ´ã€‚å®ƒå°†ä¸€ä¸ªå®Œæ•´çš„åŠŸèƒ½å•ç‹¬ä¿å­˜åœ¨ä¸€æ¬¡æäº¤ä¸­ï¼Œä½†ä¹Ÿå¤±å»äº†å¯¹æ•´ä¸ªåŠŸèƒ½åˆ†æ”¯å¼€å‘è¿‡ç¨‹çš„è®°å½•å’Œç»†èŠ‚ã€‚å…·ä½“çš„æ“ä½œæ–¹æ³•å¯å‚è€ƒ&lt;a href="https://waynerv.github.io/posts/git-rebase-intro/#%E9%87%8D%E5%86%99%E6%8F%90%E4%BA%A4%E5%8E%86%E5%8F%B2">é‡å†™æäº¤å†å²&lt;/a>ã€‚&lt;/p>
&lt;p>è¿™ä¸‰ç§ç­–ç•¥éƒ½æœ‰æ˜æ˜¾çš„ä¼˜ç¼ºç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å…·ä½“çš„åœºæ™¯ä»¥åŠè‡ªå·±çš„éœ€æ±‚è¿›è¡Œé€‰æ‹©ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://en.wikipedia.org/wiki/Merge_(version_control)">Merge (version control)&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://git-scm.com/docs/git-merge">git-merge - Join two or more development histories together&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://blog.developer.atlassian.com/pull-request-merge-strategies-the-great-debate/#:~:text=And%20the%20merge%20can%20complete,of%20an%20earlier%20feature%20branch">Pull Request Merge Strategies: The Great Debate&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%88%86%E6%94%AF%E7%9A%84%E6%96%B0%E5%BB%BA%E4%B8%8E%E5%90%88%E5%B9%B6">Git åˆ†æ”¯ - åˆ†æ”¯çš„æ–°å»ºä¸åˆå¹¶&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://segmentfault.com/a/1190000021712743">git mergeçš„åŸç†ï¼ˆé€’å½’ä¸‰è·¯åˆå¹¶ç®—æ³•ï¼‰&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/git/" term="Git" label="Git"/></entry><entry><title type="text">git rebase ç”¨æ³•è¯¦è§£ä¸å·¥ä½œåŸç†</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/git-rebase-intro/"/><id>https://waynerv.com/posts/git-rebase-intro/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2020-10-23T23:45:24+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">rebase å‘½ä»¤æ˜¯ git é«˜æ‰‹çš„ä¸€å¤§åˆ©å™¨ï¼Œä½¿ç”¨ rebase é‡å†™æäº¤å†å²åœ¨æ—¥å¸¸å¼€å‘ä¸­éå¸¸æœ‰ç”¨ï¼Œè¿™ç¯‡è¿‘å…­åƒå­—çš„é•¿æ–‡å°†å¸®åŠ©ä½ å½»åº•æŒæ¡ git rebase çš„ç”¨æ³•å’ŒåŸç†ã€‚</summary><content type="html">&lt;p>ä»¥å‰å¯¹ &lt;code>git rebase -i&lt;/code> çš„ç”¨æ³•ä¸€ç›´æ˜¯ä¸€çŸ¥åŠè§£ï¼Œä¸€æ¬¡åœ¨éœ€è¦åˆå¹¶å¤šä¸ªæäº¤æ—¶åˆšå¥½ç”¨åˆ°ï¼Œä¸€é¡¿æ“ä½œå·®ç‚¹æŠŠæäº¤éƒ½æä¸¢äº†ï¼Œå¹¸å¥½åé¢é¡ºåˆ©æ‰¾å›ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹å­¦ä¹  &lt;code>rebase&lt;/code> å‘½ä»¤çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;h2 id="ç†è§£-rebase-å‘½ä»¤">ç†è§£ Rebase å‘½ä»¤&lt;/h2>
&lt;p>&lt;code>git rebase&lt;/code> å‘½ä»¤çš„æ–‡æ¡£æè¿°æ˜¯ &lt;code>Reapply commits on top of another base tip&lt;/code>ï¼Œä»å­—é¢ä¸Šç†è§£æ˜¯ã€Œåœ¨å¦ä¸€ä¸ªåŸºç«¯ä¹‹ä¸Šé‡æ–°åº”ç”¨æäº¤ã€ï¼Œè¿™ä¸ªå®šä¹‰å¬èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œæ¢ä¸ªè§’åº¦å¯ä»¥ç†è§£ä¸ºã€Œå°†åˆ†æ”¯çš„åŸºç¡€ä»ä¸€ä¸ªæäº¤æ”¹æˆå¦ä¸€ä¸ªæäº¤ï¼Œä½¿å…¶çœ‹èµ·æ¥å°±åƒæ˜¯ä»å¦ä¸€ä¸ªæäº¤ä¸­åˆ›å»ºäº†åˆ†æ”¯ä¸€æ ·ã€ï¼Œå¦‚ä¸‹å›¾ï¼š&lt;/p>
&lt;p>&lt;img src="git-rebase-visual.png" alt="git-rebase.png">&lt;/p>
&lt;p>å‡è®¾æˆ‘ä»¬ä» &lt;code>Master&lt;/code> çš„æäº¤ A åˆ›å»ºäº† &lt;code>Feature&lt;/code> åˆ†æ”¯è¿›è¡Œæ–°çš„åŠŸèƒ½å¼€å‘ï¼Œè¿™æ—¶ A å°±æ˜¯ &lt;code>Feature&lt;/code> çš„åŸºç«¯ã€‚æ¥ç€ &lt;code>Matser&lt;/code> æ–°å¢äº†ä¸¤ä¸ªæäº¤ B å’Œ Cï¼Œ &lt;code>Feature&lt;/code> æ–°å¢äº†ä¸¤ä¸ªæäº¤ D å’Œ Eã€‚ç°åœ¨æˆ‘ä»¬å‡ºäºæŸç§åŸå› ï¼Œæ¯”å¦‚æ–°åŠŸèƒ½çš„å¼€å‘ä¾èµ– Bã€C æäº¤ï¼Œéœ€è¦å°† &lt;code>Master&lt;/code> çš„ä¸¤ä¸ªæ–°æäº¤æ•´åˆåˆ° &lt;code>Feature&lt;/code> åˆ†æ”¯ï¼Œä¸ºäº†ä¿æŒæäº¤å†å²çš„æ•´æ´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ‡æ¢åˆ° &lt;code>Feature&lt;/code> åˆ†æ”¯æ‰§è¡Œ &lt;code>rebase&lt;/code> æ“ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git rebase master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>rebase&lt;/code> çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯é¦–å…ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªåˆ†æ”¯ï¼ˆå³å½“å‰åˆ†æ”¯ &lt;code>Feature&lt;/code>ã€ &lt;code>rebase&lt;/code> æ“ä½œçš„ç›®æ ‡åŸºåº•åˆ†æ”¯ &lt;code>Master&lt;/code>ï¼‰ çš„æœ€è¿‘å…±åŒç¥–å…ˆæäº¤ Aï¼Œç„¶åå¯¹æ¯”å½“å‰åˆ†æ”¯ç›¸å¯¹äºè¯¥ç¥–å…ˆæäº¤çš„å†æ¬¡æäº¤ï¼ˆD å’Œ Eï¼‰ï¼Œæå–ç›¸åº”çš„ä¿®æ”¹å¹¶å­˜ä¸ºä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åå°†å½“å‰åˆ†æ”¯æŒ‡å‘ç›®æ ‡åŸºåº• &lt;code>Master&lt;/code> æ‰€æŒ‡å‘çš„æäº¤ C, æœ€åä»¥æ­¤ä½œä¸ºæ–°çš„åŸºç«¯å°†ä¹‹å‰å¦å­˜ä¸ºä¸´æ—¶æ–‡ä»¶çš„ä¿®æ”¹ä¾åºåº”ç”¨ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ä¸Šæ–‡ç†è§£æˆå°† &lt;code>Feature&lt;/code> åˆ†æ”¯çš„åŸºç¡€ä»æäº¤ A æ”¹æˆäº†æäº¤ Cï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯ä»æäº¤ C åˆ›å»ºäº†è¯¥åˆ†æ”¯ï¼Œå¹¶æäº¤äº† D å’Œ Eã€‚ä½†å®é™…ä¸Šè¿™åªæ˜¯ã€Œçœ‹èµ·æ¥ã€ï¼Œåœ¨å†…éƒ¨ Git å¤åˆ¶äº†æäº¤ D å’Œ E çš„å†…å®¹ï¼Œåˆ›å»ºæ–°çš„æäº¤ D' å’Œ E' å¹¶å°†å…¶åº”ç”¨åˆ°ç‰¹å®šåŸºç¡€ä¸Šï¼ˆAâ†’Bâ†’Cï¼‰ã€‚å°½ç®¡æ–°çš„ &lt;code>Feature&lt;/code> åˆ†æ”¯å’Œä¹‹å‰çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä½†å®ƒæ˜¯ç”±å…¨æ–°çš„æäº¤ç»„æˆçš„ã€‚&lt;/p>
&lt;p>&lt;code>rebase&lt;/code> æ“ä½œçš„å®è´¨æ˜¯ä¸¢å¼ƒä¸€äº›ç°æœ‰çš„æäº¤ï¼Œç„¶åç›¸åº”åœ°æ–°å»ºä¸€äº›å†…å®¹ä¸€æ ·ä½†å®é™…ä¸Šä¸åŒçš„æäº¤ã€‚&lt;/p>
&lt;h2 id="ä¸»è¦ç”¨é€”">ä¸»è¦ç”¨é€”&lt;/h2>
&lt;p>&lt;code>rebase&lt;/code> é€šå¸¸ç”¨äºé‡å†™æäº¤å†å²ã€‚ä¸‹é¢çš„ä½¿ç”¨åœºæ™¯åœ¨å¤§å¤šæ•° Git å·¥ä½œæµä¸­æ˜¯ååˆ†å¸¸è§çš„ï¼š&lt;/p>
&lt;ul>
&lt;li>æˆ‘ä»¬ä» &lt;code>master&lt;/code> åˆ†æ”¯æ‹‰å–äº†ä¸€æ¡ &lt;code>feature&lt;/code> åˆ†æ”¯åœ¨æœ¬åœ°è¿›è¡ŒåŠŸèƒ½å¼€å‘&lt;/li>
&lt;li>è¿œç¨‹çš„ &lt;code>master&lt;/code> åˆ†æ”¯åœ¨ä¹‹ååˆåˆå¹¶äº†ä¸€äº›æ–°çš„æäº¤&lt;/li>
&lt;li>æˆ‘ä»¬æƒ³åœ¨ &lt;code>feature&lt;/code> åˆ†æ”¯é›†æˆ &lt;code>master&lt;/code> çš„æœ€æ–°æ›´æ”¹&lt;/li>
&lt;/ul>
&lt;h3 id="rebase-å’Œ-merge-çš„åŒºåˆ«">rebase å’Œ merge çš„åŒºåˆ«&lt;/h3>
&lt;p>ä»¥ä¸Šåœºæ™¯åŒæ ·å¯ä»¥ä½¿ç”¨ &lt;code>merge&lt;/code> æ¥è¾¾æˆç›®çš„ï¼Œä½†ä½¿ç”¨ &lt;code>rebase&lt;/code> å¯ä»¥ä½¿æˆ‘ä»¬ä¿æŒä¸€ä¸ªçº¿æ€§ä¸”æ›´åŠ æ•´æ´çš„æäº¤å†å²ã€‚å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹åˆ†æ”¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> D---E feature
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A---B---C master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬å°†åˆ†åˆ«ä½¿ç”¨ &lt;code>merge&lt;/code> å’Œ &lt;code>rebase&lt;/code>ï¼ŒæŠŠ &lt;code>master&lt;/code> åˆ†æ”¯çš„ Bã€C æäº¤é›†æˆåˆ° &lt;code>feature&lt;/code> åˆ†æ”¯ï¼Œå¹¶åœ¨ &lt;code>feature&lt;/code> åˆ†æ”¯æ–°å¢ä¸€ä¸ªæäº¤ Fï¼Œç„¶åå†å°† &lt;code>feature&lt;/code> åˆ†æ”¯åˆå…¥ &lt;code>master&lt;/code> ï¼Œæœ€åå¯¹æ¯”ä¸¤ç§æ–¹æ³•æ‰€å½¢æˆçš„æäº¤å†å²çš„åŒºåˆ«ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ä½¿ç”¨ &lt;code>merge&lt;/code>&lt;/p>
&lt;ol>
&lt;li>åˆ‡æ¢åˆ° &lt;code>feature&lt;/code> åˆ†æ”¯ï¼š &lt;code>git checkout feature&lt;/code>ã€‚&lt;/li>
&lt;li>åˆå¹¶ &lt;code>master&lt;/code> åˆ†æ”¯çš„æ›´æ–°ï¼š &lt;code>git merge master&lt;/code>ã€‚&lt;/li>
&lt;li>æ–°å¢ä¸€ä¸ªæäº¤ Fï¼š &lt;code>git add . &amp;amp;&amp;amp; git commit -m &amp;quot;commit F&amp;quot;&lt;/code> ã€‚&lt;/li>
&lt;li>åˆ‡å› &lt;code>master&lt;/code> åˆ†æ”¯å¹¶æ‰§è¡Œå¿«è¿›åˆå¹¶ï¼š &lt;code>git chekcout master &amp;amp;&amp;amp; git merge feature&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Dec-30-2020-merge-example.gif" alt="Dec-30-2020-merge-example">&lt;/p>
&lt;p>æˆ‘ä»¬å°†å¾—åˆ°å¦‚ä¸‹æäº¤å†å²ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">* 6fa5484 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master, feature&lt;span class="o">)&lt;/span> commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* 875906b Merge branch &lt;span class="s1">&amp;#39;master&amp;#39;&lt;/span> into feature
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span>&lt;span class="se">\ &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> 5b05585 commit E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span> &lt;span class="p">|&lt;/span> f5b0fc0 commit D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* * d017dff commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* * 9df916f commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">|&lt;/span>/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* cb932a6 commit A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨ &lt;code>rebase&lt;/code>&lt;/p>
&lt;p>æ­¥éª¤ä¸ä½¿ç”¨ &lt;code>merge&lt;/code> åŸºæœ¬ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ç¬¬ 2 æ­¥çš„å‘½ä»¤æ›¿æ¢æˆï¼š &lt;code>git rebase master&lt;/code>ã€‚&lt;/p>
&lt;p>æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š&lt;/p>
&lt;p>&lt;img src="Dec-30-2020-rebase-example.gif" alt="Dec-30-2020-rebase-example">&lt;/p>
&lt;p>æˆ‘ä»¬å°†å¾—åˆ°å¦‚ä¸‹æäº¤å†å²ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">* 74199ce &lt;span class="o">(&lt;/span>HEAD -&amp;gt; master, feature&lt;span class="o">)&lt;/span> commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* e7c7111 commit E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* d9623b0 commit D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* 73deeed commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* c50221f commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">* ef13725 commit A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ &lt;code>rebase&lt;/code> æ–¹æ³•å½¢æˆçš„æäº¤å†å²æ˜¯å®Œå…¨çº¿æ€§çš„ï¼ŒåŒæ—¶ç›¸æ¯” &lt;code>merge&lt;/code> æ–¹æ³•å°‘äº†ä¸€æ¬¡ &lt;code>merge&lt;/code> æäº¤ï¼Œçœ‹ä¸Šå»æ›´åŠ æ•´æ´ã€‚&lt;/p>
&lt;h3 id="ä¸ºä»€ä¹ˆè¦ä¿æŒæäº¤å†å²çš„æ•´æ´">ä¸ºä»€ä¹ˆè¦ä¿æŒæäº¤å†å²çš„æ•´æ´&lt;/h3>
&lt;p>ä¸€ä¸ªçœ‹ä¸Šæ›´æ•´æ´çš„æäº¤å†å²æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ&lt;/p>
&lt;ol>
&lt;li>æ»¡è¶³æŸäº›å¼€å‘è€…çš„æ´ç™–ã€‚&lt;/li>
&lt;li>å½“ä½ å› ä¸ºæŸäº› bug éœ€è¦å›æº¯æäº¤å†å²æ—¶ï¼Œæ›´å®¹æ˜“å®šä½åˆ° bug æ˜¯ä»å“ªä¸€ä¸ªæäº¤å¼•å…¥ã€‚å°¤å…¶æ˜¯å½“ä½ éœ€è¦é€šè¿‡ &lt;code>git bisect&lt;/code> ä»å‡ åä¸Šç™¾ä¸ªæäº¤ä¸­æ’æŸ¥ bugï¼Œæˆ–è€…æœ‰ä¸€äº›ä½“é‡è¾ƒå¤§çš„åŠŸèƒ½åˆ†æ”¯éœ€è¦é¢‘ç¹çš„ä»è¿œç¨‹çš„ä¸»åˆ†æ”¯æ‹‰å–æ›´æ–°æ—¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä½¿ç”¨ &lt;code>rebase&lt;/code> æ¥å°†è¿œç¨‹çš„å˜æ›´æ•´åˆåˆ°æœ¬åœ°ä»“åº“æ˜¯ä¸€ç§æ›´å¥½çš„é€‰æ‹©ã€‚ç”¨ &lt;code>merge&lt;/code> æ‹‰å–è¿œç¨‹å˜æ›´çš„ç»“æœæ˜¯ï¼Œæ¯æ¬¡ä½ æƒ³è·å–é¡¹ç›®çš„æœ€æ–°è¿›å±•æ—¶ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªå¤šä½™çš„ &lt;code>merge&lt;/code> æäº¤ã€‚è€Œä½¿ç”¨ &lt;code>rebase&lt;/code> çš„ç»“æœæ›´ç¬¦åˆæˆ‘ä»¬çš„æœ¬æ„ï¼šæˆ‘æƒ³åœ¨å…¶ä»–äººçš„å·²å®Œæˆå·¥ä½œçš„åŸºç¡€ä¸Šè¿›è¡Œæˆ‘çš„æ›´æ”¹ã€‚&lt;/p>
&lt;h3 id="å…¶ä»–é‡å†™æäº¤å†å²çš„æ–¹æ³•">å…¶ä»–é‡å†™æäº¤å†å²çš„æ–¹æ³•&lt;/h3>
&lt;p>å½“æˆ‘ä»¬ä»…ä»…åªæƒ³ä¿®æ”¹æœ€è¿‘çš„ä¸€æ¬¡æäº¤æ—¶ï¼Œä½¿ç”¨ &lt;code>git commit --amend&lt;/code> ä¼šæ›´åŠ æ–¹ä¾¿ã€‚&lt;/p>
&lt;p>å®ƒé€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æˆ‘ä»¬åˆšåˆšå®Œæˆäº†ä¸€æ¬¡æäº¤ï¼Œä½†è¿˜æ²¡æœ‰æ¨é€åˆ°å…¬å…±çš„åˆ†æ”¯ã€‚&lt;/li>
&lt;li>çªç„¶å‘ç°ä¸Šä¸ªæäº¤è¿˜ç•™äº†äº›å°å°¾å·´æ²¡æœ‰å®Œæˆï¼Œæ¯”å¦‚ä¸€è¡Œå¿˜è®°åˆ é™¤çš„æ³¨é‡Šæˆ–è€…ä¸€ä¸ªå¾ˆå°çš„ç¬”è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¿«é€Ÿçš„å®Œæˆä¿®æ”¹ï¼Œä½†åˆä¸æƒ³å†æ–°å¢ä¸€ä¸ªå•ç‹¬çš„æäº¤ã€‚&lt;/li>
&lt;li>æˆ–è€…æˆ‘ä»¬åªæ˜¯è§‰å¾—ä¸Šä¸€æ¬¡æäº¤çš„æäº¤ä¿¡æ¯å†™çš„ä¸å¤Ÿå¥½ï¼Œæƒ³åšä¸€äº›ä¿®æ”¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥æ·»åŠ æ–°å¢çš„ä¿®æ”¹ï¼ˆæˆ–è·³è¿‡ï¼‰ï¼Œä½¿ç”¨ &lt;code>git commit --amend&lt;/code> å‘½ä»¤æ‰§è¡Œæäº¤ï¼Œæ‰§è¡Œåä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„ç¼–è¾‘å™¨çª—å£ï¼Œå¯ä»¥å¯¹ä¸Šä¸€æ¬¡æäº¤çš„æäº¤ä¿¡æ¯è¿›è¡Œä¿®æ”¹ï¼Œä¿å­˜åå°±ä¼šå°†æ‰€åšçš„è¿™äº›æ›´æ”¹åº”ç”¨åˆ°ä¸Šä¸€æ¬¡æäº¤ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å·²ç»å°†ä¸Šä¸€æ¬¡æäº¤æ¨é€åˆ°äº†è¿œç¨‹çš„åˆ†æ”¯ï¼Œç°åœ¨å†æ‰§è¡Œæ¨é€å°†ä¼šæç¤ºå‡ºé”™å¹¶è¢«æ‹’ç»ï¼Œåœ¨ç¡®ä¿è¯¥åˆ†æ”¯ä¸æ˜¯ä¸€ä¸ªå…¬å…±åˆ†æ”¯çš„å‰æä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code>git push --force&lt;/code> å¼ºåˆ¶æ¨é€ã€‚&lt;/p>
&lt;p>æ³¨æ„ä¸ &lt;code>rebase&lt;/code> ä¸€æ ·ï¼ŒGit åœ¨å†…éƒ¨å¹¶ä¸ä¼šçœŸæ­£åœ°ä¿®æ”¹å¹¶æ›¿æ¢ä¸Šä¸€ä¸ªæäº¤ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå…¨æ–°çš„æäº¤å¹¶é‡æ–°æŒ‡å‘è¿™ä¸ªæ–°çš„æäº¤ã€‚&lt;/p>
&lt;h2 id="ä½¿ç”¨-rebase-çš„äº¤äº’æ¨¡å¼é‡å†™æäº¤å†å²">ä½¿ç”¨ rebase çš„äº¤äº’æ¨¡å¼é‡å†™æäº¤å†å²&lt;/h2>
&lt;p>&lt;code>git rebase&lt;/code> å‘½ä»¤æœ‰æ ‡å‡†å’Œäº¤äº’ä¸¤ç§æ¨¡å¼ï¼Œä¹‹å‰çš„ç¤ºä¾‹æˆ‘ä»¬ç”¨çš„éƒ½æ˜¯é»˜è®¤çš„æ ‡å‡†æ¨¡å¼ï¼Œåœ¨å‘½ä»¤åæ·»åŠ  &lt;code>-i&lt;/code> æˆ– &lt;code>--interactive&lt;/code> é€‰é¡¹å³å¯ä½¿ç”¨äº¤äº’æ¨¡å¼ã€‚&lt;/p>
&lt;h3 id="ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«">ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«&lt;/h3>
&lt;p>æˆ‘ä»¬å‰é¢æåˆ°ï¼Œ &lt;code>rebase&lt;/code> æ˜¯ã€Œåœ¨å¦ä¸€ä¸ªåŸºç«¯ä¹‹ä¸Šé‡æ–°åº”ç”¨æäº¤ã€ï¼Œè€Œåœ¨é‡æ–°åº”ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œè¿™äº›æäº¤ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œè‡ªç„¶ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚åœ¨ &lt;code>rebase&lt;/code> çš„æ ‡å‡†æ¨¡å¼ä¸‹ï¼Œå½“å‰å·¥ä½œåˆ†æ”¯çš„æäº¤ä¼šè¢«ç›´æ¥åº”ç”¨åˆ°ä¼ å…¥åˆ†æ”¯çš„é¡¶ç«¯ï¼›è€Œåœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼Œåˆ™å…è®¸æˆ‘ä»¬åœ¨é‡æ–°åº”ç”¨ä¹‹å‰é€šè¿‡ç¼–è¾‘å™¨ä»¥åŠç‰¹å®šçš„å‘½ä»¤è§„åˆ™å¯¹è¿™äº›æäº¤è¿›è¡Œåˆå¹¶ã€é‡æ–°æ’åºåŠåˆ é™¤ç­‰é‡å†™æ“ä½œã€‚&lt;/p>
&lt;p>ä¸¤è€…æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ä¹Ÿå› æ­¤æœ‰æ‰€ä¸åŒï¼š&lt;/p>
&lt;ol>
&lt;li>æ ‡å‡†æ¨¡å¼å¸¸ç”¨äºåœ¨å½“å‰åˆ†æ”¯ä¸­é›†æˆæ¥è‡ªå…¶ä»–åˆ†æ”¯çš„æœ€æ–°ä¿®æ”¹ã€‚&lt;/li>
&lt;li>äº¤äº’æ¨¡å¼å¸¸ç”¨äºå¯¹å½“å‰åˆ†æ”¯çš„æäº¤å†å²è¿›è¡Œç¼–è¾‘ï¼Œå¦‚å°†å¤šä¸ªå°æäº¤åˆå¹¶æˆå¤§çš„æäº¤ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä¸ä»…ä»…æ˜¯åˆ†æ”¯">ä¸ä»…ä»…æ˜¯åˆ†æ”¯&lt;/h3>
&lt;p>è™½ç„¶æˆ‘ä»¬ä¹‹å‰çš„ç¤ºä¾‹éƒ½æ˜¯åœ¨ä¸åŒçš„ä¸¤ä¸ªåˆ†æ”¯ä¹‹é—´æ‰§è¡Œ rebase æ“ä½œï¼Œä½†äº‹å®ä¸Š rebase å‘½ä»¤ä¼ å…¥çš„å‚æ•°å¹¶ä¸ä»…é™äºåˆ†æ”¯ã€‚&lt;/p>
&lt;p>ä»»ä½•çš„æäº¤å¼•ç”¨ï¼Œéƒ½å¯ä»¥è¢«è§†ä½œæœ‰æ•ˆçš„ &lt;code>rebase&lt;/code> åŸºåº•å¯¹è±¡ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæäº¤ IDã€åˆ†æ”¯åç§°ã€æ ‡ç­¾åç§°æˆ– &lt;code>HEAD~1&lt;/code> è¿™æ ·çš„ç›¸å¯¹å¼•ç”¨ã€‚&lt;/p>
&lt;p>è‡ªç„¶åœ°ï¼Œå‡å¦‚æˆ‘ä»¬å¯¹å½“å‰åˆ†æ”¯çš„æŸæ¬¡å†å²æäº¤æ‰§è¡Œ &lt;code>rebase&lt;/code>ï¼Œå…¶ç»“æœå°±æ˜¯ä¼šå°†è¿™æ¬¡æäº¤ä¹‹åçš„æ‰€æœ‰æäº¤é‡æ–°åº”ç”¨åœ¨å½“å‰åˆ†æ”¯ï¼Œåœ¨äº¤äº’æ¨¡å¼ä¸‹ï¼Œå³å…è®¸æˆ‘ä»¬å¯¹è¿™äº›æäº¤è¿›è¡Œæ›´æ”¹ã€‚&lt;/p>
&lt;h3 id="é‡å†™æäº¤å†å²">é‡å†™æäº¤å†å²&lt;/h3>
&lt;p>ç»ˆäºè¿›å…¥åˆ°æœ¬æ–‡çš„ä¸»é¢˜ï¼Œå‰é¢æåˆ°ï¼Œå‡å¦‚æˆ‘ä»¬åœ¨äº¤äº’æ¨¡å¼å¯¹å½“å‰åˆ†æ”¯çš„æŸæ¬¡æäº¤æ‰§è¡Œ &lt;code>rebase&lt;/code>ï¼Œå³ï¼ˆé—´æ¥ï¼‰å®ç°äº†å¯¹è¿™æ¬¡æäº¤ä¹‹åçš„æ‰€æœ‰æäº¤è¿›è¡Œé‡å†™ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ä¸‹é¢çš„ç¤ºä¾‹è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚&lt;/p>
&lt;p>å‡è®¾æˆ‘ä»¬åœ¨ &lt;code>feature&lt;/code> åˆ†æ”¯æœ‰å¦‚ä¸‹æäº¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">74199cebdd34d107bb67b6da5533a2e405f4c330 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; feature&lt;span class="o">)&lt;/span> commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e7c7111d807c1d5209b97a9c75b09da5cd2810d4 commit E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">d9623b0ef9d722b4a83d58a334e1ce85545ea524 commit D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">73deeedaa944ef459b17d42601677c2fcc4c4703 commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c50221f93a39f3474ac59228d69732402556c93b commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ef1372522cdad136ce7e6dc3e02aab4d6ad73f79 commit A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¦æ‰§è¡Œçš„æ“ä½œæ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>å°† Bã€C åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„æäº¤ ï¼Œå¹¶ä»…ä¿ç•™åŸæäº¤ C çš„æäº¤ä¿¡æ¯&lt;/li>
&lt;li>åˆ é™¤æäº¤ D&lt;/li>
&lt;li>å°†æäº¤ E ç§»åŠ¨åˆ°æäº¤ F ä¹‹åå¹¶é‡æ–°å‘½åï¼ˆå³ä¿®æ”¹æäº¤ä¿¡æ¯ï¼‰ä¸ºæäº¤ H&lt;/li>
&lt;li>åœ¨æäº¤ F ä¸­åŠ å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶æ›´æ”¹ï¼Œå¹¶é‡æ–°å‘½åä¸ºæäº¤ G&lt;/li>
&lt;/ul>
&lt;p>ç”±äºæˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„æäº¤æ˜¯ Bâ†’Câ†’Dâ†’Eï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æäº¤ A ä½œä¸ºæ–°çš„ã€ŒåŸºç«¯ã€ï¼Œæäº¤ A ä¹‹åçš„æ‰€æœ‰æäº¤ä¼šè¢«é‡æ–°åº”ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git rebase -i ef1372522cdad136ce7e6dc3e02aab4d6ad73f79 &lt;span class="c1"># å‚æ•°æ˜¯æäº¤ A çš„ ID&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥ä¼šè¿›å…¥åˆ°å¦‚ä¸‹çš„ç¼–è¾‘å™¨ç•Œé¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pick c50221f commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pick 73deeed commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pick d9623b0 commit D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pick e7c7111 commit E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">pick 74199ce commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å˜åŸº ef13725..74199ce åˆ° ef13725ï¼ˆ5 ä¸ªæäº¤ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># å‘½ä»¤:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># p, pick &amp;lt;æäº¤&amp;gt; = ä½¿ç”¨æäº¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># r, reword &amp;lt;æäº¤&amp;gt; = ä½¿ç”¨æäº¤ï¼Œä½†ä¿®æ”¹æäº¤è¯´æ˜&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># e, edit &amp;lt;æäº¤&amp;gt; = ä½¿ç”¨æäº¤ï¼Œè¿›å…¥ shell ä»¥ä¾¿è¿›è¡Œæäº¤ä¿®è¡¥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># s, squash &amp;lt;æäº¤&amp;gt; = ä½¿ç”¨æäº¤ï¼Œä½†èåˆåˆ°å‰ä¸€ä¸ªæäº¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># f, fixup &amp;lt;æäº¤&amp;gt; = ç±»ä¼¼äº &amp;#34;squash&amp;#34;ï¼Œä½†ä¸¢å¼ƒæäº¤è¯´æ˜æ—¥å¿—&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># x, exec &amp;lt;å‘½ä»¤&amp;gt; = ä½¿ç”¨ shell è¿è¡Œå‘½ä»¤ï¼ˆæ­¤è¡Œå‰©ä½™éƒ¨åˆ†ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># b, break = åœ¨æ­¤å¤„åœæ­¢ï¼ˆä½¿ç”¨ &amp;#39;git rebase --continue&amp;#39; ç»§ç»­å˜åŸºï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># d, drop &amp;lt;æäº¤&amp;gt; = åˆ é™¤æäº¤&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ï¼ˆæ³¨æ„ä¸Šé¢æäº¤ ID ä¹‹åçš„æäº¤ä¿¡æ¯åªèµ·åˆ°æè¿°ä½œç”¨ï¼Œåœ¨è¿™é‡Œä¿®æ”¹å®ƒä»¬ä¸ä¼šæœ‰ä»»ä½•æ•ˆæœã€‚ï¼‰&lt;/p>
&lt;p>å…·ä½“çš„æ“ä½œå‘½ä»¤åœ¨ç¼–è¾‘å™¨çš„æ³¨é‡Šä¸­å·²è§£é‡Šçš„ç›¸å½“è¯¦ç»†ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å¯¹æäº¤ Bã€C ä½œå¦‚ä¸‹ä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pick c50221f commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">f 73deeed commit C
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç”±äºæäº¤ B æ˜¯è¿™äº›æäº¤ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•å¯¹å…¶æ‰§è¡Œ &lt;code>squash&lt;/code> æˆ–è€… &lt;code>fixup&lt;/code> å‘½ä»¤ï¼ˆæ²¡æœ‰å‰ä¸€ä¸ªæäº¤äº†ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å¯¹æäº¤ B æ‰§è¡Œ &lt;code>reword&lt;/code> å‘½ä»¤ä»¥ä¿®æ”¹å…¶æäº¤ä¿¡æ¯ï¼Œå› ä¸ºä¹‹ååœ¨å°†æäº¤ C èåˆåˆ°æäº¤ B ä¸­æ—¶ï¼Œä¼šå…è®¸æˆ‘ä»¬å¯¹èåˆä¹‹åçš„æäº¤ä¿¡æ¯è¿›è¡Œä¿®æ”¹ã€‚&lt;/p>
&lt;p>æ³¨æ„è¯¥ç•Œé¢æäº¤çš„å±•ç¤ºé¡ºåºæ˜¯ä»ä¸Šåˆ°ä¸‹ç”±æ—§åˆ°æ–°ï¼Œå› æ­¤æˆ‘ä»¬å°†æäº¤ C çš„å‘½ä»¤æ”¹ä¸º &lt;code>sï¼ˆæˆ– squashï¼‰&lt;/code> æˆ–è€… &lt;code>fï¼ˆæˆ– fixupï¼‰&lt;/code> ä¼šå°†å…¶èåˆåˆ°ï¼ˆä¸Šæ–¹çš„ï¼‰å‰ä¸€ä¸ªæäº¤ Bï¼Œä¸¤ä¸ªå‘½ä»¤çš„åŒºåˆ«ä¸ºæ˜¯å¦ä¿ç•™ C çš„æäº¤ä¿¡æ¯ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ é™¤æäº¤ Dï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">d d9623b0 commit D
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç§»åŠ¨æäº¤ E åˆ°æäº¤ F ä¹‹åå¹¶ä¿®æ”¹å…¶æäº¤ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pick 74199ce commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">r e7c7111 commit E
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨æäº¤ F ä¸­åŠ å…¥ä¸€ä¸ªæ–°çš„æ–‡ä»¶æ›´æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">e 74199ce commit F
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä¿å­˜é€€å‡ºã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>æ¥ä¸‹æ¥ä¼šæŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºä¾æ¬¡æ‰§è¡Œæˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªæäº¤æ‰€ä¿®æ”¹æˆ–ä¿ç•™çš„å‘½ä»¤ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å¯¹æäº¤ B çš„ &lt;code>pick&lt;/code> å‘½ä»¤ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦äº¤äº’ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¥ç€æ‰§è¡Œå¯¹æäº¤ C çš„ &lt;code>squash&lt;/code> å‘½ä»¤ï¼Œä¼šè¿›å…¥ä¸€ä¸ªæ–°çš„ç¼–è¾‘å™¨ç•Œé¢å…è®¸æˆ‘ä»¬ä¿®æ”¹åˆå¹¶äº†Bã€C ä¹‹åçš„æäº¤ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿™æ˜¯ä¸€ä¸ª 2 ä¸ªæäº¤çš„ç»„åˆã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿™æ˜¯ç¬¬ä¸€ä¸ªæäº¤è¯´æ˜ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># è¿™æ˜¯æäº¤è¯´æ˜ #2ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬å°† &lt;code>commit B&lt;/code> è¿™ä¸€è¡Œåˆ é™¤åä¿å­˜é€€å‡ºï¼Œèåˆä¹‹åçš„æäº¤å°†ä½¿ç”¨ &lt;code>commit C&lt;/code> ä½œä¸ºæäº¤ä¿¡æ¯ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯¹æäº¤ D çš„ &lt;code>drop&lt;/code> æ“ä½œä¹Ÿä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œæ²¡æœ‰äº¤äº’æ­¥éª¤ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ‰§è¡Œ &lt;code>rebase&lt;/code> çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‘ç”Ÿå†²çªï¼Œè¿™æ—¶å€™ &lt;code>rebase&lt;/code> ä¼šæš‚æ—¶ä¸­æ­¢ï¼Œéœ€è¦æˆ‘ä»¬ç¼–è¾‘å†²çªçš„æ–‡ä»¶å»æ‰‹åŠ¨åˆå¹¶å†²çªã€‚è§£å†³å†²çªåé€šè¿‡ &lt;code>git add/rm &amp;lt;conflicted_files&amp;gt;&lt;/code> å°†å…¶æ ‡è®°ä¸ºå·²è§£å†³ï¼Œç„¶åæ‰§è¡Œ &lt;code>git rebase --continue&lt;/code> å¯ä»¥ç»§ç»­ä¹‹åçš„ &lt;code>rebase&lt;/code> æ­¥éª¤ï¼›æˆ–è€…ä¹Ÿå¯ä»¥æ‰§è¡Œ &lt;code>git rebase --abort&lt;/code> æ”¾å¼ƒ &lt;code>rebase&lt;/code> æ“ä½œå¹¶æ¢å¤åˆ°æ“ä½œä¹‹å‰çš„çŠ¶æ€ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç”±äºæˆ‘ä»¬ä¸Šç§»äº†æäº¤ F çš„ä½ç½®ï¼Œå› æ­¤æ¥ä¸‹æ¥å°†æ‰§è¡Œå¯¹ F çš„ &lt;code>edit&lt;/code> æ“ä½œã€‚è¿™æ—¶å°†è¿›å…¥ä¸€ä¸ªæ–°çš„ Shell ä¼šè¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">åœæ­¢åœ¨ 74199ce... commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">æ‚¨ç°åœ¨å¯ä»¥ä¿®è¡¥è¿™ä¸ªæäº¤ï¼Œä½¿ç”¨
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git commit --amend
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">å½“æ‚¨å¯¹å˜æ›´æ„Ÿåˆ°æ»¡æ„ï¼Œæ‰§è¡Œ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git rebase --continue
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°çš„ä»£ç æ–‡ä»¶å¹¶æ‰§è¡Œ &lt;code>git commit --amend&lt;/code> å°†å…¶åˆå¹¶åˆ°å½“å‰çš„ä¸Šä¸€ä¸ªæäº¤ï¼ˆå³ Fï¼‰ï¼Œç„¶ååœ¨ç¼–è¾‘å™¨ç•Œé¢ä¸­å°†å…¶æäº¤ä¿¡æ¯ä¿®æ”¹ä¸º &lt;code>commit G&lt;/code>ï¼Œæœ€åæ‰§è¡Œ &lt;code>git rebase --continue&lt;/code> ç»§ç»­ &lt;code>rebase&lt;/code> æ“ä½œã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœ€åæ‰§è¡Œå¯¹æäº¤ E çš„ &lt;code>reword&lt;/code> æ“ä½œï¼Œåœ¨ç¼–è¾‘å™¨ç•Œé¢ä¸­å°†å…¶æäº¤ä¿¡æ¯ä¿®æ”¹ä¸º &lt;code>commit H&lt;/code> ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>å¤§åŠŸå‘Šæˆï¼æœ€åè®©æˆ‘ä»¬ç¡®è®¤ä¸€ä¸‹ &lt;code>rebase&lt;/code> ä¹‹åçš„æäº¤å†å²ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">64710dc88ef4fbe8fe7aac206ec2e3ef12e7bca9 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; feature&lt;span class="o">)&lt;/span> commit H
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8ab4506a672dac5c1a55db34779a185f045d7dd3 commit G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1e186f890710291aab5b508a4999134044f6f846 commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ef1372522cdad136ce7e6dc3e02aab4d6ad73f79 commit A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å®Œå…¨ç¬¦åˆé¢„æœŸï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°æäº¤ Aä¹‹åçš„æ‰€æœ‰æäº¤ ID éƒ½å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œè¿™ä¹Ÿå°è¯äº†æˆ‘ä»¬ä¹‹å‰æ‰€è¯´çš„ Git é‡æ–°åˆ›å»ºäº†è¿™äº›æäº¤ã€‚&lt;/p>
&lt;h2 id="rebase-çš„è¿›é˜¶ç”¨æ³•">Rebase çš„è¿›é˜¶ç”¨æ³•&lt;/h2>
&lt;h3 id="åˆå¹¶ä¹‹å‰æ‰§è¡Œ-rebase">åˆå¹¶ä¹‹å‰æ‰§è¡Œ rebase&lt;/h3>
&lt;p>å¦ä¸€ç§ä½¿ç”¨ &lt;code>rebase&lt;/code> çš„å¸¸è§åœºæ™¯æ˜¯åœ¨æ¨é€åˆ°è¿œç¨‹è¿›è¡Œåˆå¹¶ä¹‹å‰æ‰§è¡Œ &lt;code>rebase&lt;/code>ï¼Œä¸€èˆ¬è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿æäº¤å†å²çš„æ•´æ´ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬é¦–å…ˆåœ¨è‡ªå·±çš„åŠŸèƒ½åˆ†æ”¯é‡Œè¿›è¡Œå¼€å‘ï¼Œå½“å¼€å‘å®Œæˆæ—¶éœ€è¦å…ˆå°†å½“å‰åŠŸèƒ½åˆ†æ”¯ &lt;code>rebase&lt;/code> åˆ°æœ€æ–°çš„ä¸»åˆ†æ”¯ä¸Šï¼Œæå‰è§£å†³å¯èƒ½å‡ºç°çš„å†²çªï¼Œç„¶åå†å‘è¿œç¨‹æäº¤ä¿®æ”¹ã€‚ è¿™æ ·çš„è¯ï¼Œè¿œç¨‹ä»“åº“çš„ä¸»åˆ†æ”¯ç»´æŠ¤è€…å°±ä¸å†éœ€è¦è¿›è¡Œæ•´åˆä¸”åˆ›å»ºä¸€æ¡é¢å¤–çš„ &lt;code>merge&lt;/code> æäº¤ï¼Œåªéœ€è¦æ‰§è¡Œå¿«è¿›åˆå¹¶å³å¯ã€‚å³ä½¿æ˜¯åœ¨å¤šä¸ªåˆ†æ”¯å¹¶è¡Œå¼€å‘çš„æƒ…å†µï¼Œæœ€ç»ˆä¹Ÿèƒ½å¾—åˆ°ä¸€æ¡å®Œå…¨çº¿æ€§çš„æäº¤å†å²ã€‚&lt;/p>
&lt;h3 id="rebase-åˆ°å…¶ä»–åˆ†æ”¯">rebase åˆ°å…¶ä»–åˆ†æ”¯&lt;/h3>
&lt;p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;code>rebase&lt;/code> å¯¹ä¸¤ä¸ªåˆ†æ”¯è¿›è¡Œå¯¹æ¯”ï¼Œå–å‡ºç›¸åº”çš„ä¿®æ”¹ï¼Œç„¶ååº”ç”¨åˆ°å¦ä¸€ä¸ªåˆ†æ”¯ä¸Šã€‚ä¾‹å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl"> F---G patch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> D---E feature
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> /
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">A---B---C master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å‡è®¾æˆ‘ä»¬åŸºäº &lt;code>feature&lt;/code> åˆ†æ”¯çš„æäº¤ D åˆ›å»ºäº†åˆ†æ”¯ &lt;code>patch&lt;/code>ï¼Œå¹¶ä¸”æ–°å¢äº†æäº¤ Fã€Gï¼Œç°åœ¨æˆ‘ä»¬æƒ³å°† &lt;code>patch&lt;/code> æ‰€åšçš„æ›´æ”¹åˆå¹¶åˆ° &lt;code>master&lt;/code> å¹¶å‘å¸ƒï¼Œä½†æš‚æ—¶è¿˜ä¸æƒ³åˆå¹¶ &lt;code>feature&lt;/code> ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨ &lt;code>rebase&lt;/code> çš„ &lt;code>--onto &amp;lt;branch&amp;gt;&lt;/code> é€‰é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git rebase â€”onto master feature patch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä»¥ä¸Šæ“ä½œå°†å–å‡º &lt;code>patch&lt;/code> åˆ†æ”¯ï¼Œå¯¹æ¯”å®ƒåŸºäº &lt;code>feature&lt;/code> æ‰€åšçš„æ›´æ”¹ï¼Œ ç„¶åæŠŠè¿™äº›æ›´æ”¹åœ¨ &lt;code>master&lt;/code> åˆ†æ”¯ä¸Šé‡æ–°åº”ç”¨ï¼Œè®© &lt;code>patch&lt;/code> çœ‹èµ·æ¥å°±åƒç›´æ¥åŸºäº &lt;code>master&lt;/code> è¿›è¡Œæ›´æ”¹ä¸€æ ·ã€‚æ‰§è¡Œåçš„ &lt;code>patch&lt;/code> å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">A---B---C---F&lt;span class="s1">&amp;#39;---G&amp;#39;&lt;/span> patch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åæˆ‘ä»¬å¯ä»¥åˆ‡æ¢åˆ° &lt;code>master&lt;/code> åˆ†æ”¯ï¼Œå¹¶å¯¹ &lt;code>patch&lt;/code> æ‰§è¡Œå¿«è¿›åˆå¹¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git checkout master
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git merge patch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é€šè¿‡-rebase-ç­–ç•¥æ‰§è¡Œ-git-pull">é€šè¿‡ rebase ç­–ç•¥æ‰§è¡Œ &lt;code>git pull&lt;/code>&lt;/h3>
&lt;p>Git åœ¨æœ€è¿‘çš„æŸä¸ªç‰ˆæœ¬èµ·ï¼Œç›´æ¥è¿è¡Œ &lt;code>git pull&lt;/code> ä¼šæœ‰å¦‚ä¸‹æç¤ºæ¶ˆæ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">warning: ä¸å»ºè®®åœ¨æ²¡æœ‰ä¸ºåç¦»åˆ†æ”¯æŒ‡å®šåˆå¹¶ç­–ç•¥æ—¶æ‰§è¡Œ pull æ“ä½œã€‚ æ‚¨å¯ä»¥åœ¨æ‰§è¡Œä¸‹ä¸€æ¬¡ pull æ“ä½œä¹‹å‰æ‰§è¡Œä¸‹é¢ä¸€æ¡å‘½ä»¤æ¥æŠ‘åˆ¶æœ¬æ¶ˆæ¯ï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git config pull.rebase &lt;span class="nb">false&lt;/span> &lt;span class="c1"># åˆå¹¶ï¼ˆç¼ºçœç­–ç•¥ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git config pull.rebase &lt;span class="nb">true&lt;/span> &lt;span class="c1"># å˜åŸº&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> git config pull.ff only &lt;span class="c1"># ä»…å¿«è¿›&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>åŸæ¥ &lt;code>git pull&lt;/code> æ—¶ä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>rebase&lt;/code> æ¥è¿›è¡Œåˆå¹¶ï¼Œè¿™æ˜¯å› ä¸º &lt;code>git pull&lt;/code> å®é™…ä¸Šç­‰äº &lt;code>git fetch&lt;/code> + &lt;code>git merge&lt;/code> ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¬¬äºŒæ­¥ç›´æ¥ç”¨ &lt;code>git rebase&lt;/code> æ›¿æ¢ &lt;code>git merge&lt;/code>æ¥åˆå¹¶ &lt;code>fetch&lt;/code> å–å¾—çš„å˜æ›´ï¼Œä½œç”¨åŒæ ·æ˜¯é¿å…é¢å¤–çš„ &lt;code>merge&lt;/code> æäº¤ä»¥ä¿æŒçº¿æ€§çš„æäº¤å†å²ã€‚&lt;/p>
&lt;p>ä¸¤è€…çš„åŒºåˆ«åœ¨ä¸Šæ–‡ä¸­å·²è¿›è¡Œè¿‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¯¹æ¯”ç¤ºä¾‹ä¸­çš„ &lt;code>Matser&lt;/code> åˆ†æ”¯å½“æˆè¿œç¨‹åˆ†æ”¯ï¼ŒæŠŠ &lt;code>Feature&lt;/code> åˆ†æ”¯å½“æˆæœ¬åœ°åˆ†æ”¯ï¼Œå½“æˆ‘ä»¬åœ¨æœ¬åœ°æ‰§è¡Œ &lt;code>git pull&lt;/code> æ—¶ï¼Œå…¶å®å°±æ˜¯æ‹‰å– &lt;code>Master&lt;/code> çš„æ›´æ”¹ç„¶ååˆå¹¶åˆ° &lt;code>Feature&lt;/code> åˆ†æ”¯ã€‚å¦‚æœä¸¤ä¸ªåˆ†æ”¯éƒ½æœ‰ä¸åŒçš„æäº¤ï¼Œé»˜è®¤çš„ &lt;code>git merge&lt;/code> æ–¹å¼ä¼šç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ merge æäº¤ä»¥æ•´åˆè¿™äº›æäº¤ï¼›è€Œä½¿ç”¨ &lt;code>git rebase&lt;/code> åˆ™ç›¸å½“äºåŸºäºè¿œç¨‹åˆ†æ”¯çš„æœ€æ–°æäº¤é‡æ–°åˆ›å»ºæœ¬åœ°åˆ†æ”¯ï¼Œç„¶åå†é‡æ–°åº”ç”¨æœ¬åœ°æ‰€æ·»åŠ çš„æäº¤ã€‚&lt;/p>
&lt;p>å…·ä½“çš„ä½¿ç”¨æ–¹å¼æœ‰å¤šç§ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¯æ¬¡æ‰§è¡Œ pull å‘½ä»¤æ—¶æ·»åŠ ç‰¹å®šé€‰é¡¹ï¼š &lt;code>git pull --rebase&lt;/code> ã€‚&lt;/li>
&lt;li>ä¸ºå½“å‰ä»“åº“è®¾å®šé…ç½®é¡¹ï¼š &lt;code>git config pull.rebase true&lt;/code>ï¼Œåœ¨ &lt;code>git config&lt;/code> åæ·»åŠ  &lt;code>--global&lt;/code> é€‰é¡¹å¯ä»¥ä½¿è¯¥é…ç½®é¡¹å¯¹æ‰€æœ‰ä»“åº“ç”Ÿæ•ˆã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="æ½œåœ¨å¼Šç«¯å’Œåå¯¹æ„è§">æ½œåœ¨å¼Šç«¯å’Œåå¯¹æ„è§&lt;/h2>
&lt;p>ä»ä»¥ä¸Šåœºæ™¯æ¥çœ‹ &lt;code>rebase&lt;/code> åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œä½†æˆ‘ä»¬ä¹Ÿéœ€è¦æ„è¯†åˆ°å®ƒä¸æ˜¯ä¸‡èƒ½çš„ï¼Œç”šè‡³å¯¹æ–°æ‰‹æ¥è¯´æœ‰äº›å±é™©ï¼Œç¨æœ‰ä¸æ…å°±ä¼šå‘ç° &lt;code>git log&lt;/code> é‡Œçš„æäº¤ä¸è§äº†ï¼Œæˆ–è€…å¡åœ¨ &lt;code>rebase&lt;/code> çš„æŸä¸ªæ­¥éª¤ä¸çŸ¥é“å¦‚ä½•æ¢å¤ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¸Šé¢å·²ç»æåˆ°äº† &lt;code>rebase&lt;/code> æœ‰ä¿æŒæ•´æ´çš„çº¿æ€§æäº¤å†å²çš„ä¼˜ç‚¹ï¼Œä½†ä¹Ÿéœ€è¦æ„è¯†åˆ°å®ƒæœ‰ä»¥ä¸‹æ½œåœ¨çš„å¼Šç«¯ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœæ¶‰åŠåˆ°å·²ç»æ¨é€è¿‡çš„æäº¤ï¼Œéœ€è¦å¼ºåˆ¶æ¨é€æ‰èƒ½å°†æœ¬åœ° &lt;code>rebase&lt;/code> åçš„æäº¤æ¨é€åˆ°è¿œç¨‹ã€‚å› æ­¤ç»å¯¹ä¸è¦åœ¨ä¸€ä¸ªå…¬å…±åˆ†æ”¯ï¼ˆä¹Ÿå°±æ˜¯è¯´è¿˜æœ‰å…¶ä»–äººåŸºäºè¿™ä¸ªåˆ†æ”¯è¿›è¡Œå¼€å‘ï¼‰æ‰§è¡Œ &lt;code>rebase&lt;/code>ï¼Œå¦åˆ™å…¶ä»–äººä¹‹åæ‰§è¡Œ &lt;code>git pull&lt;/code> ä¼šåˆå¹¶å‡ºä¸€æ¡ä»¤äººå›°æƒ‘çš„æœ¬åœ°æäº¤å†å²ï¼Œè¿›ä¸€æ­¥æ¨é€å›è¿œç¨‹åˆ†æ”¯ååˆä¼šå°†è¿œç¨‹çš„æäº¤å†å²æ‰“ä¹±ï¼ˆè¯¦è§&lt;a href="https://www.daolf.com/posts/git-series-part-2/">Rebase and the golden rule explained&lt;/a>ï¼‰ï¼Œè¾ƒä¸¥é‡çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¹ä½ çš„äººèº«å®‰å…¨å¸¦æ¥é£é™©ã€‚&lt;/li>
&lt;li>å¯¹æ–°æ‰‹ä¸å‹å¥½ï¼Œæ–°æ‰‹å¾ˆæœ‰å¯èƒ½åœ¨äº¤äº’æ¨¡å¼ä¸­è¯¯æ“ä½œã€Œä¸¢å¤±ã€æŸäº›æäº¤ï¼ˆä½†å…¶å®æ˜¯èƒ½å¤Ÿæ‰¾å›çš„ï¼‰ã€‚&lt;/li>
&lt;li>å‡å¦‚ä½ é¢‘ç¹çš„ä½¿ç”¨ &lt;code>rebase&lt;/code> æ¥é›†æˆä¸»åˆ†æ”¯çš„æ›´æ–°ï¼Œä¸€ä¸ªæ½œåœ¨çš„åæœæ˜¯ä½ ä¼šé‡åˆ°è¶Šæ¥è¶Šå¤šéœ€è¦åˆå¹¶çš„å†²çªã€‚å°½ç®¡ä½ å¯ä»¥åœ¨ &lt;code>rebase&lt;/code> è¿‡ç¨‹ä¸­å¤„ç†è¿™äº›å†²çªï¼Œä½†è¿™å¹¶éé•¿ä¹…ä¹‹è®¡ï¼Œæ›´æ¨èçš„åšæ³•æ˜¯é¢‘ç¹çš„åˆå…¥ä¸»åˆ†æ”¯ç„¶ååˆ›å»ºæ–°çš„åŠŸèƒ½åˆ†æ”¯ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªé•¿æ—¶é—´å­˜åœ¨çš„åŠŸèƒ½åˆ†æ”¯ã€‚&lt;/li>
&lt;/ul>
&lt;p>å¦å¤–æœ‰ä¸€äº›è§‚ç‚¹æ˜¯æˆ‘ä»¬åº”è¯¥å°½é‡é¿å…é‡å†™æäº¤å†å²ï¼š&lt;/p>
&lt;blockquote>
&lt;p>æœ‰ä¸€ç§è§‚ç‚¹è®¤ä¸ºï¼Œä»“åº“çš„æäº¤å†å²å³æ˜¯ è®°å½•å®é™…å‘ç”Ÿè¿‡ä»€ä¹ˆã€‚ å®ƒæ˜¯é’ˆå¯¹å†å²çš„æ–‡æ¡£ï¼Œæœ¬èº«å°±æœ‰ä»·å€¼ï¼Œä¸èƒ½ä¹±æ”¹ã€‚ ä»è¿™ä¸ªè§’åº¦çœ‹æ¥ï¼Œæ”¹å˜æäº¤å†å²æ˜¯ä¸€ç§äºµæ¸ï¼Œä½ ä½¿ç”¨ è°è¨€ æ©ç›–äº†å®é™…å‘ç”Ÿè¿‡çš„äº‹æƒ…ã€‚ å¦‚æœç”±åˆå¹¶äº§ç”Ÿçš„æäº¤å†å²æ˜¯ä¸€å›¢ç³Ÿæ€ä¹ˆåŠï¼Ÿ æ—¢ç„¶äº‹å®å°±æ˜¯å¦‚æ­¤ï¼Œé‚£ä¹ˆè¿™äº›ç—•è¿¹å°±åº”è¯¥è¢«ä¿ç•™ä¸‹æ¥ï¼Œè®©åäººèƒ½å¤ŸæŸ¥é˜…ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä»¥åŠé¢‘ç¹çš„ä½¿ç”¨ &lt;code>rebase&lt;/code> å¯èƒ½ä¼šä½¿ä»å†å²æäº¤ä¸­å®šä½ bug å˜å¾—æ›´åŠ å›°éš¾ï¼Œè¯¦è§ &lt;a href="https://medium.com/@fredrikmorken/why-you-should-stop-using-git-rebase-5552bee4fed1">Why you should stop using Git rebase&lt;/a>ã€‚&lt;/p>
&lt;h2 id="æ‰¾å›ä¸¢å¤±çš„æäº¤">æ‰¾å›ä¸¢å¤±çš„æäº¤&lt;/h2>
&lt;p>åœ¨äº¤äº’å¼æ¨¡å¼ä¸‹è¿›è¡Œ &lt;code>rebase&lt;/code> å¹¶å¯¹æäº¤æ‰§è¡Œ &lt;code>squash&lt;/code> æˆ– &lt;code>drop&lt;/code> ç­‰å‘½ä»¤åï¼Œä¼šä»åˆ†æ”¯çš„ &lt;code>git log&lt;/code> ä¸­ç›´æ¥åˆ é™¤æäº¤ã€‚å¦‚æœä½ ä¸å°å¿ƒæ“ä½œå¤±è¯¯ï¼Œä¼šä»¥ä¸ºè¿™äº›æäº¤å·²ç»æ°¸ä¹…æ¶ˆå¤±äº†è€Œå“å‡ºä¸€èº«å†·æ±—ã€‚&lt;/p>
&lt;p>ä½†è¿™äº›æäº¤å¹¶æ²¡æœ‰çœŸæ­£åœ°è¢«åˆ é™¤ï¼Œå¦‚ä¸Šæ‰€è¯´ï¼ŒGit å¹¶ä¸ä¼šä¿®æ”¹ï¼ˆæˆ–åˆ é™¤ï¼‰åŸæ¥çš„æäº¤ï¼Œè€Œæ˜¯é‡æ–°åˆ›å»ºäº†ä¸€æ‰¹æ–°çš„æäº¤ï¼Œå¹¶å°†å½“å‰åˆ†æ”¯é¡¶ç«¯æŒ‡å‘äº†æ–°æäº¤ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ &lt;code>git reflog&lt;/code> æ‰¾åˆ°å¹¶ä¸”é‡æ–°æŒ‡å‘åŸæ¥çš„æäº¤æ¥æ¢å¤å®ƒä»¬ï¼Œè¿™ä¼šæ’¤é”€æ•´ä¸ª &lt;code>rebase&lt;/code>ã€‚æ„Ÿè°¢ Git ï¼Œå³ä½¿ä½ æ‰§è¡Œ &lt;code>rebase&lt;/code> æˆ–è€… &lt;code>commit --amend&lt;/code> ç­‰é‡å†™æäº¤å†å²çš„æ“ä½œï¼Œå®ƒä¹Ÿä¸ä¼šçœŸæ­£åœ°ä¸¢å¤±ä»»ä½•æäº¤ã€‚&lt;/p>
&lt;h3 id="git-reflog-å‘½ä»¤">&lt;code>git reflog&lt;/code> å‘½ä»¤&lt;/h3>
&lt;p>reflogs æ˜¯ Git ç”¨æ¥è®°å½•æœ¬åœ°ä»“åº“åˆ†æ”¯é¡¶ç«¯çš„æ›´æ–°çš„ä¸€ç§æœºåˆ¶ï¼Œå®ƒä¼šè®°å½•æ‰€æœ‰åˆ†æ”¯é¡¶ç«¯æ›¾ç»æŒ‡å‘è¿‡çš„æäº¤ï¼Œå› æ­¤ reflogs å…è®¸æˆ‘ä»¬æ‰¾åˆ°å¹¶åˆ‡æ¢åˆ°ä¸€ä¸ªå½“å‰æ²¡æœ‰è¢«ä»»ä½•åˆ†æ”¯æˆ–æ ‡ç­¾å¼•ç”¨çš„æäº¤ã€‚&lt;/p>
&lt;p>æ¯å½“åˆ†æ”¯é¡¶ç«¯ç”±äºä»»ä½•åŸå› è¢«æ›´æ–°ï¼ˆé€šè¿‡åˆ‡æ¢åˆ†æ”¯ã€æ‹‰å–æ–°çš„å˜æ›´ã€é‡å†™å†å²æˆ–è€…æ·»åŠ æ–°çš„æäº¤ï¼‰ï¼Œä¸€æ¡æ–°çš„è®°å½•å°†è¢«æ·»åŠ åˆ° reflogs ä¸­ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æ‰€åˆ›å»ºè¿‡çš„æ¯ä¸€æ¬¡æäº¤éƒ½ä¸€å®šä¼šè¢«è®°å½•åœ¨ reflogs ä¸­ã€‚å³ä½¿åœ¨é‡å†™äº†æäº¤å†å²ä¹‹åï¼Œ reflogs ä¹Ÿä¼šåŒ…å«å…³äºåˆ†æ”¯çš„æ—§çŠ¶æ€çš„ä¿¡æ¯ï¼Œå¹¶å…è®¸æˆ‘ä»¬åœ¨éœ€è¦æ—¶æ¢å¤åˆ°è¯¥çŠ¶æ€ã€‚&lt;/p>
&lt;p>æ³¨æ„ reflogs å¹¶ä¸ä¼šæ°¸ä¹…ä¿å­˜ï¼Œå®ƒæœ‰ 90 å¤©çš„è¿‡æœŸæ—¶é—´ã€‚&lt;/p>
&lt;h3 id="è¿˜åŸæäº¤å†å²">è¿˜åŸæäº¤å†å²&lt;/h3>
&lt;p>æˆ‘ä»¬ä»ä¸Šä¸€ä¸ªä¾‹å­ç»§ç»­ï¼Œå‡è®¾æˆ‘ä»¬æƒ³æ¢å¤ &lt;code>feature&lt;/code> åˆ†æ”¯åœ¨ &lt;code>rebase&lt;/code> ä¹‹å‰çš„ Aâ†’Bâ†’Câ†’Dâ†’Eâ†’F æäº¤å†å²ï¼Œä½†è¿™æ—¶å€™çš„ &lt;code>git log&lt;/code> ä¸­å·²ç»æ²¡æœ‰åé¢ 5 ä¸ªæäº¤ï¼Œæ‰€ä»¥éœ€è¦ä» reflogs ä¸­å¯»æ‰¾ï¼Œè¿è¡Œ &lt;code>git reflog&lt;/code> ç»“æœå¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">64710dc &lt;span class="o">(&lt;/span>HEAD -&amp;gt; feature&lt;span class="o">)&lt;/span> HEAD@&lt;span class="o">{&lt;/span>0&lt;span class="o">}&lt;/span>: rebase &lt;span class="o">(&lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="o">(&lt;/span>finish&lt;span class="o">)&lt;/span>: returning to refs/heads/feature
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">64710dc &lt;span class="o">(&lt;/span>HEAD -&amp;gt; feature&lt;span class="o">)&lt;/span> HEAD@&lt;span class="o">{&lt;/span>1&lt;span class="o">}&lt;/span>: rebase &lt;span class="o">(&lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="o">)&lt;/span>: commit H
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">8ab4506 HEAD@&lt;span class="o">{&lt;/span>2&lt;span class="o">}&lt;/span>: rebase &lt;span class="o">(&lt;/span>&lt;span class="k">continue&lt;/span>&lt;span class="o">)&lt;/span>: commit G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">1e186f8 HEAD@&lt;span class="o">{&lt;/span>3&lt;span class="o">}&lt;/span>: rebase &lt;span class="o">(&lt;/span>squash&lt;span class="o">)&lt;/span>: commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c50221f HEAD@&lt;span class="o">{&lt;/span>4&lt;span class="o">}&lt;/span>: rebase &lt;span class="o">(&lt;/span>start&lt;span class="o">)&lt;/span>: checkout ef1372522cdad136ce7e6dc3e02aab4d6ad73f79
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">74199ce HEAD@&lt;span class="o">{&lt;/span>5&lt;span class="o">}&lt;/span>: checkout: moving from master to feature
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">......
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>reflogs&lt;/code> å®Œæ•´çš„è®°å½•äº†æˆ‘ä»¬åˆ‡æ¢åˆ†æ”¯å¹¶è¿›è¡Œ &lt;code>rebase&lt;/code> çš„å…¨è¿‡ç¨‹ï¼Œç»§ç»­å‘ä¸‹æ£€ç´¢ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ä» &lt;code>git log&lt;/code> ä¸­æ¶ˆå¤±çš„æäº¤ F:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">74199ce HEAD@&lt;span class="o">{&lt;/span>15&lt;span class="o">}&lt;/span>: commit: commit F
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ &lt;code>git reset&lt;/code> å°† &lt;code>feature&lt;/code> åˆ†æ”¯çš„é¡¶ç«¯é‡æ–°æŒ‡å‘åŸæ¥çš„æäº¤ Fï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># æˆ‘ä»¬æƒ³å°†å·¥ä½œåŒºä¸­çš„æ–‡ä»¶ä¹Ÿä¸€å¹¶è¿˜åŸï¼Œå› æ­¤ä½¿ç”¨äº†--hardé€‰é¡¹ &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">$ git reset --hard 74199ce
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">HEAD ç°åœ¨ä½äº 74199ce commit F
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å†è¿è¡Œ &lt;code>git log&lt;/code> ä¼šå‘ç°ä¸€åˆ‡åˆå›åˆ°äº†ä»å‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">74199cebdd34d107bb67b6da5533a2e405f4c330 &lt;span class="o">(&lt;/span>HEAD -&amp;gt; feature&lt;span class="o">)&lt;/span> commit F
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">e7c7111d807c1d5209b97a9c75b09da5cd2810d4 commit E
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">d9623b0ef9d722b4a83d58a334e1ce85545ea524 commit D
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">73deeedaa944ef459b17d42601677c2fcc4c4703 commit C
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">c50221f93a39f3474ac59228d69732402556c93b commit B
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ef1372522cdad136ce7e6dc3e02aab4d6ad73f79 commit A
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>&lt;a href="https://www.atlassian.com/git/tutorials/rewriting-history/git-rebase">git rebase | Atlassian Git Tutorial&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.atlassian.com/git/tutorials/rewriting-history">git amend | Atlassian Git Tutorial&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://www.atlassian.com/git/tutorials/syncing/git-pull">Git Pull | Atlassian Git Tutorial&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://git-scm.com/book/zh/v2/Git-%E5%88%86%E6%94%AF-%E5%8F%98%E5%9F%BA">Git - å˜åŸº&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://git-scm.com/docs/git-rebase">Git - git-rebase Documentation&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://git-scm.com/docs/git-reflog">Git - git-reflog Documentation&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://medium.com/@fredrikmorken/why-you-should-stop-using-git-rebase-5552bee4fed1">Why you should stop using Git rebase&lt;/a>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;a href="https://medium.com/@fabisiakradoslaw/understand-how-does-git-rebase-work-and-compare-with-git-merge-and-git-interactive-rebase-cce2c9775e43">Understand how does git rebase work and compare with git merge and git interactive rebase&lt;/a>&lt;/p>
&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/%E5%B7%A5%E5%85%B7/" term="å·¥å…·" label="å·¥å…·"/><category scheme="https://waynerv.com/tags/git/" term="Git" label="Git"/></entry><entry><title type="text">å†™äº†ä¸€ä»½ Web API è®¾è®¡è§„èŒƒ</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/my-web-api-spcification/"/><id>https://waynerv.com/posts/my-web-api-spcification/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2020-10-17T11:40:09+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">åŸºäº GitHub REST API v3 å’Œ RFC7807ï¼Œå¹¶ç»“åˆè‡ªå·±åœ¨å·¥ä½œä¸­çš„ä¸€äº›å®è·µï¼Œç¼–å†™äº†è¿™ä»½ Web API è§„èŒƒã€‚</summary><content type="html">&lt;p>åŸºäº &lt;a href="https://developer.github.com/v3">GitHub REST API v3&lt;/a> å’Œ &lt;a href="https://tools.ietf.org/html/rfc7807">RFC7807&lt;/a> ï¼Œå¹¶ç»“åˆè‡ªå·±åœ¨å·¥ä½œä¸­çš„ä¸€äº›å®è·µï¼Œç¼–å†™äº†è¿™ä»½ Web API è§„èŒƒã€‚&lt;/p>
&lt;p>æœ¬è§„èŒƒè™½ç„¶æ•´ä½“ä¸Šéµå¾ª RESTful é£æ ¼ï¼Œä½†å¹¶æœªå¼ºåˆ¶è¦æ±‚ä½¿ç”¨è¶…åª’ä½“è¡¨ç¤ºï¼Œä¸¥æ ¼æ¥è¯´ä¸ç¬¦åˆ REST API çš„è¦æ±‚ï¼Œå› æ­¤åŸºäºæ­¤è§„èŒƒæ„å»ºçš„é¡¹ç›®åº”è¯¥å®šä¹‰ä¸º Web APIã€‚&lt;/p>
&lt;h2 id="æ¦‚è§ˆ">æ¦‚è§ˆ&lt;/h2>
&lt;p>æ‰€æœ‰ API åº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„æ ¹åŸŸåã€‚&lt;/p>
&lt;p>æ‰€æœ‰è®¿é—® API çš„è¯·æ±‚å‡åŸºäº HTTP åè®®ï¼Œå‡ºäºå®‰å…¨æ€§è€ƒè™‘å°½é‡ä½¿ç”¨ &lt;code>HTTPS&lt;/code> ã€‚&lt;/p>
&lt;p>é™¤æ–‡ä»¶ä¸Šä¼ ä¸‹è½½å¤–æ‰€æœ‰çš„æ•°æ®å‡é€šè¿‡ &lt;code>JSON&lt;/code> æ ¼å¼å‘é€å’Œæ¥æ”¶ï¼Œè¯·æ±‚å’Œå“åº”çš„ &lt;code>Content Type&lt;/code> é¦–éƒ¨å‡è®¾ç½®ä¸º &lt;code>application/json&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">curl&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">H&lt;/span> &lt;span class="s2">&amp;#34;Authorization: Bearer TOKEN&amp;#34;&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">qcs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">woqutech&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">employees&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">HTTP&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="n">OK&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Server&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">nginx&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mf">1.12.2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Date&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Thu&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">19&lt;/span> &lt;span class="n">Sep&lt;/span> &lt;span class="mi">2019&lt;/span> &lt;span class="mi">09&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">07&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">27&lt;/span> &lt;span class="n">GMT&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Content&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">application&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Content&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Length&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1115&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Connection&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">keep&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">alive&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Access&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Control&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Allow&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">Origin&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">*&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>&lt;span class="n">RESPONSE&lt;/span> &lt;span class="n">BODY&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç©ºç™½å­—æ®µå°†æä¾›ä¸º &lt;code>null&lt;/code> çš„å€¼ï¼Œè€Œä¸æ˜¯å¿½ç•¥è¯¥å­—æ®µæˆ–æä¾› &lt;code>&amp;quot;&amp;quot;&lt;/code> ç©ºå­—ç¬¦ä¸²å€¼ã€‚&lt;/p>
&lt;p>æ‰€æœ‰å“åº”ä¸­çš„æ—¶é—´æˆ³ä»¥ ISO 8601 æ ¼å¼è¡¨ç¤ºï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="mi">2019&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">09&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="n">T08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">42&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">47&lt;/span>&lt;span class="n">Z&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="uriå‘½å">URIå‘½å&lt;/h2>
&lt;h3 id="åŠ¨è¯-or-åè¯">åŠ¨è¯ or åè¯?&lt;/h3>
&lt;p>åŸºäº RESTful çš„åŸºæœ¬åŸåˆ™ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å°†æ‰€æœ‰çš„ API åˆ’åˆ†ä¸ºé€»è¾‘çš„èµ„æºï¼Œå¹¶é€šè¿‡ HTTP è¯·æ±‚æ–¹æ³•æ¥å¯¹èµ„æºè¿›è¡Œæ“ä½œ&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€æœ‰çš„èµ„æºéƒ½åº”è¯¥è¡¨è¿°ä¸ºåè¯è€Œä¸æ˜¯åŠ¨è¯ï¼Œä¸”è¯¥èµ„æºå¹¶ä¸éœ€è¦å’Œåº”ç”¨ç¨‹åºçš„æ•°æ®æ¨¡å‹å®Œå…¨å¯¹åº”ã€‚&lt;/p>
&lt;h3 id="å•æ•°-or-å¤æ•°">å•æ•° or å¤æ•°?&lt;/h3>
&lt;p>ä¸ºäº†ä¿æŒç®€å•å’Œä¸€è‡´ï¼Œä¸ç®¡æ˜¯èµ„æºçš„å•ä¸ªå®ä¾‹è¿˜æ˜¯é›†åˆï¼Œåœ¨ URI ä¸­éƒ½å°†ä½¿ç”¨å¤æ•°å½¢å¼æ¥è¡¨ç¤ºã€‚å¦‚ &lt;code>/tickets&lt;/code> å’Œ &lt;code>/tickets/12&lt;/code> ã€‚&lt;/p>
&lt;h3 id="å¦‚ä½•è¡¨ç¤ºé›†åˆå…³ç³»">å¦‚ä½•è¡¨ç¤ºé›†åˆå…³ç³»?&lt;/h3>
&lt;p>å½“èµ„æºä¹‹é—´å­˜åœ¨é›†åˆå…³ç³»æ—¶ï¼ˆå³æŸä¸€èµ„æºå­˜åœ¨äºå¦ä¸€èµ„æºçš„ä½œç”¨åŸŸä¸­ï¼‰ï¼Œæˆ‘ä»¬åº”å½“åœ¨è¯·æ±‚ URI ä¸­ä½“ç°é›†åˆå…³ç³»ï¼Œä»¥å·¥å•ä¸­çš„è¯„è®ºä¸ºä¾‹ï¼š&lt;/p>
&lt;ul>
&lt;li>GET /tickets/12/commentsÂ - è·å–ç¼–å·ä¸º12çš„å·¥å•çš„æ‰€æœ‰è¯„è®º&lt;/li>
&lt;li>GET /tickets/12/comments/5Â - è·å–ç¼–å·ä¸º12çš„å·¥å•ä¸­ç¼–å·ä¸º5çš„è¯„è®º&lt;/li>
&lt;/ul>
&lt;p>è‹¥æƒ³è·å–æŸä¸€é›†åˆä¸­çš„å­èµ„æºï¼Œå¿…é¡»é€šè¿‡å…¶çˆ¶èµ„æºç«¯ç‚¹è¿›è¡Œè®¿é—®ï¼Œåœ¨æ¥å£ä¸­ä¹Ÿå°†å¯¹å…¶ä¸Šä¸€çº§èµ„æºè¿›è¡Œæ ¡éªŒã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">GET&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">serviceRoot&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nb">id&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">subcollection&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nb">id&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½†å½“é›†åˆå±‚çº§è¿‡äºå¤æ‚æ—¶ï¼Œä¼šè€ƒè™‘åˆ†æ‹†é›†åˆå…³ç³»ä»¥æ„é€ ç®€å•æ˜“æ‡‚çš„ URIï¼Œå¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="o">/&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">tickets&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">12&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">comments&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">replies&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">likes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">---&amp;gt;&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">replies&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">20&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">likes&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="å¦‚ä½•è¡¨ç¤ºä¸é€‚ç”¨äº-crud-çš„è¡Œä¸º">å¦‚ä½•è¡¨ç¤ºä¸é€‚ç”¨äº CRUD çš„è¡Œä¸º?&lt;/h3>
&lt;ol>
&lt;li>å°†è¯¥è¡Œä¸ºé‡æ–°ç»„ç»‡ä¸ºèµ„æºä¸‹çš„æŸä¸€å­—æ®µï¼Œé€šè¿‡ PATCH æ–¹æ³•æ›´æ–°è¯¥å­—æ®µæ‰§è¡Œæ“ä½œã€‚&lt;/li>
&lt;li>å°†å…¶è§†ä¸ºä¸€ç§ RESTful åŸåˆ™ä¸‹çš„å­èµ„æºï¼Œå¦‚ GitHub's API é€šè¿‡ &lt;code>PUT /gists/:id/star&lt;/code> æ¥ star æŸä¸ªä»“åº“ï¼Œé€šè¿‡ &lt;code>DELETE /gists/:id/star&lt;/code> å–æ¶ˆ starã€‚&lt;/li>
&lt;li>æŸäº›åŠ¨ä½œå®åœ¨æ— æ³•æ˜ å°„åˆ°åˆç†çš„ RESTful ç»“æ„ï¼Œ ä¾‹å¦‚å¯¹å¤šç§èµ„æºåŒæ—¶è¿›è¡Œæœç´¢ï¼Œå¾ˆéš¾å¯¹åº”åˆ°ç‰¹å®šèµ„æºçš„ç«¯ç‚¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿å®ƒä¸æ˜¯èµ„æºä¹Ÿå¯ä»¥ä½¿ç”¨ &lt;code>/search&lt;/code> ä½œä¸ºç«¯ç‚¹ï¼Œåªéœ€è¦APIçš„ä½¿ç”¨è€…èƒ½å¤Ÿæ¸…æ™°åœ°ç†è§£å…¶æ„ä¹‰å³å¯ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="http-æ–¹æ³•">HTTP æ–¹æ³•&lt;/h2>
&lt;p>REST ä»¥èµ„æºä¸ºæ ¸å¿ƒï¼ŒHTTP æ–¹æ³•æ‰€æ“ä½œçš„å¯¹è±¡ä¹Ÿæ˜¯èµ„æºï¼Œå¯¹èµ„æºçš„æ“ä½œå³ä¸º&lt;strong>çŠ¶æ€è½¬ç§»ã€‚&lt;/strong>&lt;/p>
&lt;p>æ•°æ®çš„å¢åˆ æ”¹æŸ¥åˆ™æ˜¯æŒä¹…å±‚çš„å…·ä½“å®ç°ï¼Œä¸€æ¬¡çŠ¶æ€è½¬ç§»å¯èƒ½ä¼šå¯¹åº”å¤šä¸ªæ•°æ®åº“è¡¨çš„å¢åˆ æ”¹æ“ä½œï¼Œæ‰€ä»¥ HTTP æ–¹æ³•å’Œæ•°æ®åº“ CRUD ä¹‹é—´ä¹Ÿä¸æ˜¯ä¸¥æ ¼çš„ä¸€ä¸€å¯¹åº”å…³ç³»ã€‚&lt;/p>
&lt;p>å¯¹èµ„æºçš„æ“ä½œåœ¨ä»»ä½•æ—¶å€™éƒ½å¿…é¡»ä½¿ç”¨æ­£ç¡®çš„HTTPæ–¹æ³•ï¼Œå¹¶ä¸”å¿…é¡»éµå®ˆæ“ä½œå¹‚ç­‰æ€§ã€‚&lt;/p>
&lt;p>æ”¯æŒçš„HTTPæ–¹æ³•ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ–¹æ³•&lt;/th>
&lt;th>æè¿°&lt;/th>
&lt;th>æˆåŠŸçŠ¶æ€ç &lt;/th>
&lt;th>æ˜¯å¦å¹‚ç­‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>GET&lt;/td>
&lt;td>è·å–èµ„æº&lt;/td>
&lt;td>200 OK&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>POST&lt;/td>
&lt;td>åˆ›å»ºèµ„æº&lt;/td>
&lt;td>201 Created&lt;/td>
&lt;td>No&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PUT&lt;/td>
&lt;td>æ›¿æ¢èµ„æº&lt;/td>
&lt;td>200 OK&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>PATCH&lt;/td>
&lt;td>å¯¹èµ„æºè¿›è¡Œå±€éƒ¨æ›´æ–°&lt;/td>
&lt;td>200 OK&lt;/td>
&lt;td>No&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>DELETE&lt;/td>
&lt;td>åˆ é™¤èµ„æº&lt;/td>
&lt;td>204 No Content&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>OPTIONS&lt;/td>
&lt;td>è·å–æ¥å—çš„è¯·æ±‚æ–¹æ³•&lt;/td>
&lt;td>200 OK&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>HEAD&lt;/td>
&lt;td>è·å–HTTPé¦–éƒ¨ä¿¡æ¯&lt;/td>
&lt;td>200 OK&lt;/td>
&lt;td>Yes&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="post-æ–¹æ³•çš„å“åº”">POST æ–¹æ³•çš„å“åº”&lt;/h3>
&lt;p>POST è¯·æ±‚æˆåŠŸæ—¶å°†è¿”å› &lt;code>201 Created&lt;/code> çŠ¶æ€ç ï¼Œæ­¤å¤–å“åº”æ ¹æ®éœ€è¦æœ‰ä¸¤ç§å½¢å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>åœ¨å“åº”ä¸­æ·»åŠ  &lt;code>Location&lt;/code> é¦–éƒ¨å¹¶æŒ‡å®šè¢«åˆ›å»ºèµ„æºçš„ä½ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">Location&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">qcs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">woqutech&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">employees&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="mi">123&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åœ¨å“åº”ä¸­è¿”å›è¢«åˆ›å»ºèµ„æºçš„æ•°æ®è¡¨ç¤º&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="put-å’Œ-patchæ–¹æ³•">PUT å’Œ PATCHæ–¹æ³•&lt;/h3>
&lt;p>PUT å’Œ PATCH éƒ½è¡¨ç¤ºæ›´æ–°èµ„æºçš„æ“ä½œï¼Œä½†æ˜¯ PUT æ˜¯å…¨é‡æ›¿æ¢è€Œ PATCH æ˜¯éƒ¨åˆ†æ›´æ–°ã€‚ç†è®ºä¸Šæ¥è¯´å‰è€…åº”å½“å°†æœªä¼ å…¥çš„å­—æ®µè§†ä½œä¸º &lt;code>null&lt;/code> æˆ–é»˜è®¤å€¼å¹¶ä¸”æ›´æ–°åˆ°æ•°æ®åº“ä¸­ã€‚ç›®å‰æˆ‘ä»¬çš„å®ç°ä¸­åˆ†åˆ«ä½¿ç”¨äº† PUT å’Œ PATCHï¼Œä½†æ˜¯ PUT æ–¹æ³•ä¼šå¿½ç•¥æœªä¼ å­—æ®µï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§éƒ¨åˆ†æ›´æ–°ã€‚æœ‰ç½®ç©ºéœ€æ±‚çš„ä¸šåŠ¡éœ€è¦æ˜¾å¼åœ°ä¼ å…¥å­—æ®µå¹¶è®¾ä¸º &lt;code>null&lt;/code>ã€‚&lt;/p>
&lt;p>æ³¨æ„ç½®ç©ºæˆ–è¡¨ç¤º &lt;code>æ— &lt;/code> ç»Ÿä¸€ä½¿ç”¨ &lt;code>null&lt;/code> ï¼ˆåç«¯åŠæ•°æ®åº“å¯èƒ½è¡¨ç¤ºä¸º &lt;code>None&lt;/code> æˆ– &lt;code>NULL&lt;/code>ï¼‰ï¼Œä¸ä½¿ç”¨ç©ºå­—ç¬¦ä¸² &lt;code>&amp;quot;&amp;quot;&lt;/code>ã€‚&lt;/p>
&lt;h2 id="èº«ä»½è®¤è¯">èº«ä»½è®¤è¯&lt;/h2>
&lt;p>è®¿é—®éœ€è¦èº«ä»½è®¤è¯çš„ç«¯ç‚¹æ—¶ï¼Œè‹¥è¯·æ±‚æœªæºå¸¦å‡­æ®æˆ–å‡­æ®æ— æ•ˆï¼Œå°†è¿”å› &lt;code>401 Unauthorized&lt;/code> ã€‚&lt;/p>
&lt;p>è¿›è¡Œèº«ä»½è®¤è¯æ‰€éœ€çš„ OAuth2 ä»¤ç‰Œéœ€è¦æ”¾ç½®åœ¨è¯·æ±‚çš„ &lt;code>Authorization&lt;/code> é¦–éƒ¨ä¸­ï¼Œå¹¶ä½¿ç”¨ &lt;code>Bearer&lt;/code> è®¤è¯æ–¹å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="n">curl&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">H&lt;/span> &lt;span class="s2">&amp;#34;Authorization: Bearer TOKEN&amp;#34;&lt;/span> &lt;span class="n">http&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">qcs&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">woqutech&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">com&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">api&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">employees&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="è¯·æ±‚å‚æ•°">è¯·æ±‚å‚æ•°&lt;/h2>
&lt;p>å¯¹äº &lt;code>GET&lt;/code> è¯·æ±‚ï¼Œå°†å‚æ•°ä½œä¸º HTTP æŸ¥è¯¢å­—ç¬¦ä¸²æ·»åŠ åˆ° URL ä¸­å¯å¯¹è·å–çš„ç»“æœè¿›è¡ŒæŸ¥è¯¢å’Œè¿‡æ»¤ã€‚&lt;/p>
&lt;p>å¯¹äº &lt;code>POST&lt;/code>ï¼Œ &lt;code>PATCH&lt;/code>ï¼Œ &lt;code>PUT&lt;/code> å’Œ &lt;code>DELETE&lt;/code> è¯·æ±‚ï¼Œä»ç„¶å¯ä»¥åœ¨ URL ä¸­ä½¿ç”¨æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ŒURLä¸­æœªåŒ…å«çš„å‚æ•°åº”ç¼–ç ä¸º JSON ã€‚&lt;/p>
&lt;p>è¯·æ±‚ä½“å†…çš„å†…å®¹ä¸åº”è¯¥è¿›è¡ŒåŒ…è£…ï¼Œè‹¥å‘é€çš„å†…å®¹ä¸ºé›†åˆï¼Œåº”å½“ç›´æ¥å‘é€åŒ…å«å¯¹è±¡é›†åˆçš„æ•°ç»„ç±»å‹ã€‚&lt;/p>
&lt;h2 id="å“åº”æ ¼å¼">å“åº”æ ¼å¼&lt;/h2>
&lt;p>æ‰€æœ‰çš„å“åº”éƒ½ä½¿ç”¨ &lt;code>200 OK&lt;/code> çŠ¶æ€ç æ˜¯é”™è¯¯çš„ã€‚&lt;/p>
&lt;h3 id="åŒ…è£…ä¸å¯è§æ€§">åŒ…è£…ä¸å¯è§æ€§&lt;/h3>
&lt;p>åœ¨çº¦å®šå“åº”çš„æ ¼å¼æ—¶ï¼Œåº”å§‹ç»ˆè€ƒè™‘å¯è§æ€§ã€‚API å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®çº¦å®šç†è§£å’Œè§£æå“åº”ï¼Œä»æ¶ˆæ¯ä½“è·å–æ‰€éœ€è¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œä½†æœåŠ¡ç«¯å¹¶éç›´æ¥ä¸å®¢æˆ·ç«¯äº¤äº’ï¼Œè¿˜éœ€è€ƒè™‘åå‘ä»£ç†ã€ç½‘å…³ã€ç¼“å­˜ã€ç›‘æ§ä¸­é—´ä»¶ç­‰ HTTP ä¸­é—´å¤„ç†å±‚ã€‚HTTP æ¶ˆæ¯ä½“æ˜¯ç”¨æ¥è¡¨è¿°èµ„æºçš„ï¼ŒHTTP åˆ†å±‚ç³»ç»Ÿçš„ä¸­é—´å±‚ä¸ä¼šè§£ææ¶ˆæ¯ä½“ï¼Œè€Œæ˜¯æ ¹æ®å¤´éƒ¨ä¿¡æ¯è¿›è¡Œç›¸åº”å¤„ç†ï¼ˆå¦‚ç¼“å­˜å±‚æ ¹æ®çŠ¶æ€ç å†³å®šæ˜¯å¦ç¼“å­˜å“åº”å†…å®¹ï¼Œç›‘æ§å±‚æ ¹æ®çŠ¶æ€ç ç›‘æ§å¯ç”¨çŠ¶æ€ï¼‰ã€‚&lt;/p>
&lt;p>ä½¿ç”¨åŒ…è£…ç»“æ„çš„å“åº”å¹¶å¼ƒç”¨çŠ¶æ€ç æ—¶ï¼Œè¯·æ±‚æ˜¯å¦æˆåŠŸä»¥åŠå“åº”å†…å®¹ä»…åœ¨æ¶ˆæ¯ä½“ä¸­ä½“ç°ï¼Œå¯¹ä¸­é—´å±‚ç»„ä»¶ä¸å¯è§ï¼Œå¯èƒ½ä¼šå¯¼è‡´å…¶æ‰§è¡Œé”™è¯¯çš„é€»è¾‘æˆ–å¢åŠ ä¸å¿…è¦çš„è§£æé€»è¾‘ã€‚&lt;/p>
&lt;p>ä¸ºäº†ç¡®ä¿å¯è§æ€§ï¼Œåº”å§‹ç»ˆä¿è¯å“åº”å…·æœ‰ä¸°å¯Œå’Œå‡†ç¡®çš„å¤´éƒ¨ä¿¡æ¯ï¼Œæ¶ˆæ¯ä½“ä¸­ä¸åº”åŒ…å«é™¤èµ„æºè¡¨è¿°ä¹‹å¤–çš„å…¶ä»–ä¿¡æ¯ï¼Œé™¤éèµ„æºçš„è¡¨è¿°éœ€è¦ï¼ˆå¦‚é›†åˆèµ„æºçš„åˆ†é¡µï¼‰ä¸è¿›è¡Œå¤šä½™çš„åŒ…è£…ã€‚&lt;/p>
&lt;h3 id="é”™è¯¯">é”™è¯¯&lt;/h3>
&lt;p>å¯¹äºæœªæˆåŠŸçš„è¯·æ±‚ï¼ŒæœåŠ¡ç«¯åº”å½“å¯¹è¯·æ±‚è¿‡ç¨‹ä¸­çš„é”™è¯¯æˆ–å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œå¹¶è¿”å›ç»Ÿä¸€çš„å“åº”å¯¹è±¡ã€‚&lt;/p>
&lt;p>API å®¢æˆ·ç«¯éœ€è¦ï¼ˆé€šè¿‡çŠ¶æ€ç ï¼‰è¢«å‘ŠçŸ¥å“åº”çš„é«˜çº§é”™è¯¯ç±»ï¼Œæ¯”å¦‚å½“ç”¨æˆ·æ— æƒé™è®¿é—®ç«¯ç‚¹æ—¶ï¼Œè¿”å›çš„ &lt;code>403 Forbidden&lt;/code> çŠ¶æ€ç ä¼šå‘ŠçŸ¥ HTTP ä¸­é—´ç»„ä»¶ï¼ˆå¦‚å®¢æˆ·ç«¯åº“ã€ç¼“å­˜å’Œä»£ç†ï¼‰å“åº”çš„æ•´ä½“è¯­ä¹‰ã€‚&lt;/p>
&lt;p>åŒæ—¶ï¼ŒAPI å®¢æˆ·ç«¯è¿˜éœ€è¦è·å–å…³äºé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚å‘ç”Ÿé”™è¯¯çš„å…·ä½“åŸå› ä»¥åŠè§£å†³æ–¹æ¡ˆï¼Œå½“è¿™äº›ä¿¡æ¯ä»¥æœºå™¨å¯è¯»çš„æ–¹å¼åŒ…å«åœ¨å“åº”ä½“ä¸­æ—¶ï¼Œå®¢æˆ·ç«¯è¿˜èƒ½æ ¹æ®é”™è¯¯å“åº”è§¦å‘ç›¸åº”æ“ä½œã€‚&lt;/p>
&lt;p>&lt;strong>å¯¹è±¡ç¤ºä¾‹ï¼š&lt;/strong>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">HTTP/&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mi">422&lt;/span> &lt;span class="err">Unprocessable&lt;/span> &lt;span class="err">Entity&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">Content-Type:&lt;/span> &lt;span class="err">application/json&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;ValadationError&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;message&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;è¯·æ±‚æ•°æ®éªŒè¯å¤±è´¥&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;status&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">422&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;detail&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;loc&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;msg&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;field required&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;type&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;value_error.missing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>å¯¹è±¡æˆå‘˜ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;code>type&lt;/code> (string) &lt;em>required&lt;/em>&lt;/p>
&lt;p>ç”±æœåŠ¡ç«¯å®šä¹‰ï¼Œä¸€ä¸ªç®€çŸ­çš„ã€äººç±»å¯è¯»çš„ã€æŒ‡ç¤ºé—®é¢˜ç±»å‹çš„æ ‡è¯†ã€‚åœ¨ä¸åŒæœåŠ¡é—´å¯¹äºåŒç±»é—®é¢˜çš„ç±»å‹æ ‡è¯†å”¯ä¸€ï¼ŒAPI å®¢æˆ·ç«¯èƒ½å¤Ÿå¯¹æ‰€æœ‰çš„é—®é¢˜ç±»å‹è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>message&lt;/code> (string) &lt;em>required&lt;/em>&lt;/p>
&lt;p>ä¸€ä¸ªäººç±»å¯è¯»çš„å…³äºå‘ç”Ÿè¯¥é—®é¢˜çš„ç®€è¦è§£é‡Šã€‚è¯¥ä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯å¼€å‘è€…ä½¿ç”¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>status&lt;/code> (number) &lt;em>optional&lt;/em>&lt;/p>
&lt;p>ç”±æºå¤´æœåŠ¡å™¨ç”Ÿæˆçš„å…³äºå‘ç”Ÿè¯¥é—®é¢˜çš„ HTTP çŠ¶æ€ç &lt;/p>
&lt;p>API å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¯¥å­—æ®µæ¥ç¡®å®šå‘ç”Ÿè¯¥é—®é¢˜æ—¶ä½¿ç”¨çš„åŸå§‹çŠ¶æ€ä»£ç ï¼Œä»¥é˜²å®ƒåœ¨ä¼ é€’æ—¶è¢«æ”¹å˜ï¼ˆå¦‚ä¸­é—´è®¾å¤‡æˆ–ç¼“å­˜ï¼‰ï¼Œè€Œæ¶ˆæ¯ä½“åœ¨æ²¡æœ‰ HTTP ä¿¡æ¯çš„æƒ…å†µä¸‹èƒ½å¤Ÿç»´æŒä¸€è‡´ã€‚ HTTP ä¸­é—´ç»„ä»¶ä»å°†ä½¿ç”¨å“åº”çš„ HTTP çŠ¶æ€ç ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;code>detail&lt;/code> (object) &lt;em>optional&lt;/em>&lt;/p>
&lt;p>å…³äºå‘ç”Ÿè¯¥é—®é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ç”¨äºå¸®åŠ© API å®¢æˆ·ç«¯ä¿®æ­£é”™è¯¯ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>ï¼šåœ¨å¿…è¦æ—¶ï¼Œå¯å¯¹é”™è¯¯å“åº”å¯¹è±¡çš„æˆå‘˜è¿›è¡Œæ‰©å±•ã€‚&lt;/p>
&lt;p>ä¸è¦è½»æ˜“å»å®šä¹‰æ–°çš„é—®é¢˜ç±»å‹ï¼Œåªæœ‰å½“åŒºåˆ«å¯¹å¾…é—®é¢˜ç±»å‹å¯¹å®¢æˆ·ç«¯æœ‰æ„ä¹‰æ—¶ï¼Œæ‰è®¾è®¡å¯¹åº”çš„é—®é¢˜ç±»å‹ã€‚å°½é‡å°†é—®é¢˜å½’ç±»åˆ°å·²æœ‰çš„èƒ½å¤Ÿè‡ªè§£é‡Šçš„ HTTP é”™è¯¯çŠ¶æ€ç ä¸­ï¼Œä»…é€šè¿‡ &lt;code>message&lt;/code> å­—æ®µä¼ é€’å¿…è¦çš„æç¤ºä¿¡æ¯ï¼ŒåŒæ—¶æ³¨æ„ä¸åº”åœ¨é”™è¯¯å“åº”å¯¹è±¡æè¿°è¿‡å¤šå’Œè¿‡äºè¯¦ç»†çš„æœåŠ¡ç«¯é”™è¯¯ç»†èŠ‚ï¼Œé¿å…å¼•å…¥å®‰å…¨é£é™©ã€‚&lt;/p>
&lt;h3 id="è¯¦æƒ…è¡¨ç¤º">è¯¦æƒ…è¡¨ç¤º&lt;/h3>
&lt;p>è¯¦æƒ…è¡¨ç¤ºæ— éœ€è¿›è¡Œä»»ä½•å°è£…ã€‚&lt;/p>
&lt;p>è·å–å•ä¸ªç‹¬ç«‹çš„èµ„æºæ—¶ï¼Œå“åº”é€šå¸¸åŒ…æ‹¬è¯¥èµ„æºçš„æ‰€æœ‰å±æ€§ã€‚ è¿™ç§æƒ…å†µå®šä¹‰ä¸ºèµ„æºçš„è¯¦æƒ…è¡¨ç¤ºã€‚ï¼ˆAPI å®¢æˆ·ç«¯çš„èº«ä»½è®¤è¯æœ‰æ—¶ä¼šå½±å“è¯¦æƒ…è¡¨ç¤ºä¸­åŒ…å«çš„ä¿¡æ¯é‡ã€‚ï¼‰&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-python" data-lang="python">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;isbn&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;9780321125217&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Domain-Driven Design&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;authors&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;Matin Fowler&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;Levis Knuth&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="é›†åˆè¡¨ç¤º">é›†åˆè¡¨ç¤º&lt;/h3>
&lt;p>è·å–èµ„æºåˆ—è¡¨æ—¶ï¼Œå“åº”åŒ…æ‹¬è¯¥èµ„æºçš„å±æ€§å­é›†ï¼Œè¿™ç§æƒ…å†µå®šä¹‰ä¸ºèµ„æºçš„é›†åˆè¡¨ç¤ºã€‚ï¼ˆå‡ºäºè®¡ç®—å’ŒIOæ€§èƒ½åŸå› ï¼Œé›†åˆè¡¨ç¤ºä¼šæ’é™¤èµ„æºçš„éƒ¨åˆ†å±æ€§ï¼Œå¯é€šè¿‡è¯¦æƒ…è¡¨ç¤ºè·å–è¿™éƒ¨åˆ†å±æ€§ã€‚ï¼‰&lt;/p>
&lt;p>é›†åˆèµ„æºé€šè¿‡æ ‡å‡†çš„ JSON æ•°ç»„æ¥è¡¨ç¤ºï¼Œå¯¹äºé›†åˆèµ„æºï¼Œåˆ†é¡µæ˜¯ä¸€ç§å¸¸è§„éœ€æ±‚ï¼Œé›†åˆè¡¨ç¤ºå“åº”ä¸­å¯èƒ½ä¼šåŒ…æ‹¬èµ„æºé›†åˆè¡¨ç¤ºå’Œåˆ†é¡µä¿¡æ¯è¡¨ç¤ºä¸¤éƒ¨åˆ†ã€‚ä¸ºäº†ä¿æŒç®€å•å’Œä¸€è‡´ï¼Œæ‰€æœ‰çš„é›†åˆè¡¨ç¤ºå“åº”æ— è®ºæ˜¯å¦åŒ…å«åˆ†é¡µä¿¡æ¯éƒ½ä¼šå¯¹ç»“æ„è¿›è¡ŒåŒ…è£…ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š&lt;/p>
&lt;ul>
&lt;li>åŒ…å«åˆ†é¡µä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;data&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;isbn&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;9780321125217&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Domain-Driven Design&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;isbn&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;9780596805821&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;REST in Practice&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pagination&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;page&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;per_page&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">30&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pages&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;total&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">256&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>ä¸åŒ…å«åˆ†é¡µä¿¡æ¯&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;data&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;isbn&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;9780321125217&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;Domain-Driven Design&amp;#34;&lt;/span>&lt;span class="p">},&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="err">......&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">{&lt;/span>&lt;span class="nt">&amp;#34;isbn&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;9780596805821&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nt">&amp;#34;name&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;REST in Practice&amp;#34;&lt;/span>&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">],&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nt">&amp;#34;pagination&amp;#34;&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="kc">null&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="åˆ†é¡µ">åˆ†é¡µ&lt;/h3>
&lt;p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†åˆè¡¨ç¤ºçš„åˆ†é¡µè¡Œä¸ºç”± API å®¢æˆ·ç«¯é©±åŠ¨ï¼Œä½¿ç”¨ &lt;code>?page&lt;/code> å‚æ•°æŒ‡å®šè¦è¿”å›é¡µé¢ç¼–å·ï¼ˆæœåŠ¡ç«¯é»˜è®¤å€¼ä¸º 1ï¼‰ï¼Œ ä½¿ç”¨ &lt;code>?per_page&lt;/code> å‚æ•°æŒ‡å®šæ¯ä¸€é¡µåŒ…å«çš„èµ„æºæ•°é‡ï¼ˆæœåŠ¡ç«¯é»˜è®¤å€¼ä¸å¤§äº 30ï¼‰ã€‚&lt;/p>
&lt;p>æ³¨æ„é¡µç ç¼–å·ä» 1 å¼€å§‹ï¼Œçœç•¥ &lt;code>?page&lt;/code> å‚æ•°å°†ä½¿ç”¨æœåŠ¡ç«¯çš„é»˜è®¤å€¼è€Œä¸æ˜¯è¿”å›é›†åˆè¡¨ç¤ºçš„æ‰€æœ‰èµ„æºï¼Œä»¥å…è¿”å›çš„æ•°æ®é‡è¿‡å¤§é€ æˆæœåŠ¡ç«¯æ•°æ®åº“é˜»å¡ä»¥åŠç½‘ç»œé˜»å¡ã€‚API å®¢æˆ·ç«¯å¿…é¡»èƒ½å¤Ÿå¯¹æ¶ˆè´¹ä»»ä½•ç»™å®šè¯·æ±‚çš„åˆ†é¡µæˆ–éåˆ†é¡µé›†åˆè¡¨ç¤ºå…·æœ‰å¼¹æ€§ï¼Œå¹¶è¿›è¡Œç›¸åº”çº¦æŸï¼ˆå¦‚è®¾ç½®åˆ†é¡µå‚æ•°çš„é»˜è®¤å€¼å’Œæœ€å¤§å€¼ï¼‰ã€‚&lt;/p>
&lt;h3 id="è¿‡æ»¤ä¸æ’åº">è¿‡æ»¤ä¸æ’åº&lt;/h3>
&lt;p>åœ¨äº‹å…ˆçº¦å®šçš„æƒ…å†µä¸‹ï¼Œå¯æ ¹æ®éœ€è¦å¯¹æŒ‡å®šçš„èµ„æºå­—æ®µè¿›è¡Œè¿‡æ»¤æˆ–æ’åºã€‚&lt;/p>
&lt;h2 id="cors">CORS&lt;/h2>
&lt;p>API æ”¯æŒæŒ‡å®šæ¥æºçš„è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰è¯·æ±‚ã€‚ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">curl&lt;/span> &lt;span class="err">-i&lt;/span> &lt;span class="err">-H&lt;/span> &lt;span class="s2">&amp;#34;Authorization: Bearer TOKEN&amp;#34;&lt;/span> &lt;span class="err">http:&lt;/span>&lt;span class="c1">//qcs.woqutech.com -H &amp;#34;Origin: http://example.com&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">HTTP/&lt;/span>&lt;span class="mf">1.1&lt;/span> &lt;span class="mi">200&lt;/span> &lt;span class="err">OK&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">Access-Control-Allow-Origin:&lt;/span> &lt;span class="err">http:&lt;/span>&lt;span class="c1">//example.com
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="err">Vary:&lt;/span> &lt;span class="err">Origin&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">RESPONSE&lt;/span> &lt;span class="err">BODY&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ç‰ˆæœ¬åŒ–">ç‰ˆæœ¬åŒ–&lt;/h2>
&lt;p>æœ¬è§„èŒƒæš‚ä¸æ¶‰åŠã€‚&lt;/p>
&lt;h2 id="è¶…åª’ä½“">è¶…åª’ä½“&lt;/h2>
&lt;p>å¯¹èµ„æºè¿›è¡Œæ“ä½œçš„è¯·æ±‚åœ°å€ç”± API å®¢æˆ·ç«¯è‡ªè¡Œæ„é€ ï¼Œä¸ä½¿ç”¨è¶…åª’ä½“è¡¨ç¤ºã€‚&lt;/p>
&lt;h2 id="æ¥å£æ–‡æ¡£">æ¥å£æ–‡æ¡£&lt;/h2>
&lt;p>ä½¿ç”¨ &lt;a href="https://swagger.io/specification/">OpenAPI Specification (OAS) 3.0&lt;/a> ä½œä¸º API çš„äº¤äº’å¼æ–‡æ¡£æ ‡å‡†ã€‚&lt;/p>
&lt;p>API å®¢æˆ·ç«¯å¯è®¿é—®æŒ‡å®šåœ°å€è·å–æ‹¥æœ‰ UI ç•Œé¢çš„æ¥å£æ–‡æ¡£ï¼Œä»¥åŠ JSON æ ¼å¼çš„æ–‡æ¡£æ–‡æœ¬ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒ">å‚è€ƒ&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://developer.github.com/v3">GitHub REST API v3&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/microsoft/api-guidelines/blob/vNext/Guidelines.md">Microsoft api guidelines&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">Best Practices for Designing a Pragmatic RESTful API&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tools.ietf.org/html/rfc7807">RFC7807&lt;/a>&lt;/li>
&lt;/ul></content><category scheme="https://waynerv.com/categories/web/" term="Web" label="Web"/><category scheme="https://waynerv.com/tags/restful/" term="RESTful" label="RESTful"/></entry><entry><title type="text">è®°å½•ä¸€æ¬¡è¿ç§»MySQLæ•°æ®æ–‡ä»¶åˆ°æ–°ç¡¬ç›˜çš„è¿‡ç¨‹</title><link rel="alternate" type="text/html" href="https://waynerv.com/posts/migrate-mysql-to-a-new-disk/"/><id>https://waynerv.com/posts/migrate-mysql-to-a-new-disk/</id><updated>2022-07-28T05:24:43+00:00</updated><published>2020-09-08T12:14:24+08:00</published><author><name>Waynerv</name><uri>https://waynerv.com</uri><email>ampedee@gmail.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">è¿ç§»å‰çš„ç¯å¢ƒ MySQL Server ç¨‹åºç¼–è¯‘å®‰è£…äº qmysql ç”¨æˆ·çš„ /home/qmysql/qmysql/packages ç›®å½•ä¸‹ï¼Œæ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 .â€¦â€¦</summary><content type="html">&lt;h2 id="è¿ç§»å‰çš„ç¯å¢ƒ">è¿ç§»å‰çš„ç¯å¢ƒ&lt;/h2>
&lt;p>MySQL Server ç¨‹åºç¼–è¯‘å®‰è£…äº &lt;code>qmysql&lt;/code> ç”¨æˆ·çš„ &lt;code>/home/qmysql/qmysql/packages&lt;/code> ç›®å½•ä¸‹ï¼Œæ–‡ä»¶å¤¹ç»“æ„å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ data
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ auto.cnf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ binlog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ conf
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ ib_buffer_pool
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ ibdata1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ ib_logfile0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ ib_logfile1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ innodb_log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ innodb_ts
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ log
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ mydata
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ qcs-server.err
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ relaylog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ slowlog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ sock
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â”œâ”€â”€ tmpdir
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Â Â  â””â”€â”€ undo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ mysql -&amp;gt; /home/qmysql/qmysql/packages/mysql-5.7.21-linux-glibc2.12-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ mysql-5.7.21-linux-glibc2.12-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ bin
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ COPYING
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ data -&amp;gt; /home/qmysql/qmysql/packages/data &lt;span class="o">[&lt;/span>recursive, not followed&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ docs
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ include
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ lib
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ man
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ README
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â”œâ”€â”€ share
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€ support-files
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç°åœ¨åœ¨æœåŠ¡å™¨ä¸Šæ–°åŠ äº†ä¸€å—å›ºæ€ç¡¬ç›˜ï¼Œæƒ³å°†åŸæ¥å­˜æ”¾åœ¨æœºæ¢°ç¡¬ç›˜çš„æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®æ–‡ä»¶å³ &lt;code>data&lt;/code> æ–‡ä»¶å¤¹è¿ç§»åˆ°æ–°ç¡¬ç›˜ä¸­ï¼Œä»¥åŠ å¿«æ•°æ®åº“çš„è¯»å†™æ•ˆç‡ã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>fdisk -l&lt;/code> è·å–ç¡¬ç›˜ä¿¡æ¯å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">Disk /dev/sdb: 1197.8 GB, &lt;span class="m">1197759004672&lt;/span> bytes, &lt;span class="m">2339373056&lt;/span> sectors
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">Units&lt;/span> &lt;span class="o">=&lt;/span> sectors of &lt;span class="m">1&lt;/span> * &lt;span class="nv">512&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="m">512&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Sector size &lt;span class="o">(&lt;/span>logical/physical&lt;span class="o">)&lt;/span>: &lt;span class="m">512&lt;/span> bytes / &lt;span class="m">4096&lt;/span> bytes
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">I/O size &lt;span class="o">(&lt;/span>minimum/optimal&lt;span class="o">)&lt;/span>: &lt;span class="m">4096&lt;/span> bytes / &lt;span class="m">4096&lt;/span> bytes
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è€ƒè™‘åˆ°ç°åœ¨æŒ‚è½½çš„ç¡¬ç›˜å‡ä»¥ &lt;code>lvm&lt;/code> çš„æ–¹å¼è¿›è¡Œåˆ†å·ï¼Œè®¡åˆ’ä»å›ºæ€ç¡¬ç›˜ä¸­åˆ›å»º 300G çš„é€»è¾‘å·ï¼ŒæŒ‚è½½åˆ°ç³»ç»Ÿæ ¹ç›®å½•çš„ &lt;code>/data&lt;/code> ç›®å½•ï¼Œç„¶åå°† &lt;code>mysql&lt;/code> çš„æ•°æ®æ–‡ä»¶æ‹·è´è‡³è¯¥ä½ç½®ï¼Œå†&lt;strong>è½¯é“¾æ¥&lt;/strong>åˆ°åŸæ¥çš„ä½ç½®ï¼Œè¿™æ ·å¯ä»¥åœ¨ä¸æ›´æ”¹ä»»ä½•mysqlé…ç½®çš„æƒ…å†µä¸‹å®Œæˆè¿ç§»ã€‚&lt;/p>
&lt;h2 id="åˆ›å»ºæ•°æ®å·">åˆ›å»ºæ•°æ®å·&lt;/h2>
&lt;ol>
&lt;li>
&lt;p>åˆå§‹åŒ–ç‰©ç†å·&lt;/p>
&lt;p>å°†ç‰©ç†ç¡¬ç›˜åˆ†åŒºåˆå§‹åŒ–ä¸ºç‰©ç†å·ï¼Œä»¥ä¾¿LVMä½¿ç”¨ã€‚å‚æ•°ä¸ºè¦åˆ›å»ºçš„ç‰©ç†å·å¯¹åº”çš„è®¾å¤‡æ–‡ä»¶åã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">pvcreate /dev/sdb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åˆ›å»ºå·ç»„&lt;/p>
&lt;p>vgcreateå‘½ä»¤ç”¨äºåˆ›å»ºLVMå·ç»„ã€‚å·ç»„ï¼ˆVolume Groupï¼‰å°†å¤šä¸ªç‰©ç†å·ç»„ç»‡æˆä¸€ä¸ªæ•´ä½“ï¼Œå±è”½äº†åº•å±‚ç‰©ç†å·ç»†èŠ‚ã€‚åœ¨å·ç»„ä¸Šåˆ›å»ºé€»è¾‘å·æ—¶ä¸ç”¨è€ƒè™‘å…·ä½“çš„ç‰©ç†å·ä¿¡æ¯ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">vgcreate data_vg /dev/sdb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>åˆ›å»ºé€»è¾‘å·&lt;/p>
&lt;p>åˆ›å»ºå¤§å°300Gå¤§å°çš„é€»è¾‘å· ï¼Œ-L æŒ‡å®šå¤§å°ï¼Œ-næŒ‡å®šåç§°ï¼Œæœ€åæŒ‡å®šå·ç»„åç§°&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">lvcreate -L 300G -n mysqldata data_vg
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æ ¼å¼åŒ–é€»è¾‘å·&lt;/p>
&lt;p>å¯¹é€»è¾‘å·è¿›è¡Œxfsæ ¼å¼åŒ–&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mkfs.xfs /dev/data_vg/mysqldata
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>æŒ‚è½½æ–‡ä»¶ç›®å½•&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mount /dev/data_vg/mysqldata /data
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>è®¾ç½®å¼€æœºç£ç›˜è‡ªåŠ¨æŒ‚è½½&lt;/p>
&lt;p>è¦è®©ç³»ç»Ÿå¼€æœºè‡ªåŠ¨æŒ‚è½½ç£ç›˜ï¼Œéœ€è¦å°†æŒ‚è½½ä¿¡æ¯å†™å…¥åˆ°/etc/fstabæ–‡ä»¶ä¸­ï¼Œå¦åˆ™é‡å¯åéœ€è¦æ‰‹åŠ¨æŒ‚è½½ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">$ vim /etc/fstab
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/centos00-root / xfs defaults &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">UUID&lt;/span>&lt;span class="o">=&lt;/span>80f8fe62-70ab-4c9e-8d28-52c0d5e97979 /boot xfs defaults &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/centos00-home /home xfs defaults &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/centos00-swap swap swap defaults &lt;span class="m">0&lt;/span> &lt;span class="m">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/centos00/backup /backup xfs defaults &lt;span class="m">0&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/dev/mapper/data_vg-mysqldata /data xfs defaults &lt;span class="m">0&lt;/span> &lt;span class="m">2&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>æ·»åŠ æœ€ä¸‹é¢ä¸€è¡Œå‘½ä»¤åä¿å­˜é€€å‡ºã€‚å®Œæˆã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="è¿ç§»æ•°æ®æ–‡ä»¶">è¿ç§»æ•°æ®æ–‡ä»¶&lt;/h2>
&lt;p>å¼€å§‹è¿ç§»å‰éœ€è¦å…³é—­ &lt;code>mysql&lt;/code> æœåŠ¡ï¼Œç»ˆæ­¢è¿è¡Œæ•°æ®åº“ã€‚&lt;/p>
&lt;ol>
&lt;li>
&lt;p>åˆ‡æ¢ç”¨æˆ·&lt;/p>
&lt;p>ä¸ºä¿è¯æ–‡ä»¶å¤åˆ¶å‰åçš„æ‰€æœ‰è€…ä¸€è‡´ï¼Œé¿å…å‡ºç°æ–‡ä»¶æƒé™é—®é¢˜ï¼Œé¦–å…ˆåˆ‡æ¢åˆ°å½“å‰mysqlç¨‹åºä¸‹æ–‡ä»¶çš„æ‰€æœ‰è€…ç”¨æˆ· &lt;code>qmysql&lt;/code>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¤åˆ¶æ–‡ä»¶&lt;/p>
&lt;p>å¤åˆ¶æ‰€æœ‰ &lt;code>mysql&lt;/code> æ•°æ®æ–‡ä»¶åˆ°å›ºæ€ç¡¬ç›˜çš„æ–°ç›®å½•ï¼Œå¹¶ä¿ç•™æ‰€æœ‰æ–‡ä»¶ç›®å½•å±æ€§ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">cp -ar /home/qmysql/qmysql/packages/data /data/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¤‡ä»½åŸæ–‡ä»¶&lt;/p>
&lt;p>ä¿é™©èµ·è§ï¼Œå°†åŸæ¥çš„æ•°æ®æ–‡ä»¶è¿›è¡Œå¤‡ä»½ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">mv data data.bak
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>
&lt;p>é‡æ–°é“¾æ¥æ•°æ®æ–‡ä»¶&lt;/p>
&lt;p>å°†å›ºæ€ç¡¬ç›˜ä¸­çš„æ•°æ®æ–‡ä»¶ç›®å½•è½¯é“¾æ¥åˆ°åŸæ¥çš„æ•°æ®æ–‡ä»¶ä½ç½®&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">ln -s /data/data /home/qmysql/qmysql/packages/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>é‡å¯æ•°æ®åº“æœåŠ¡ï¼Œå¤§åŠŸå‘Šæˆï¼&lt;/p></content><category scheme="https://waynerv.com/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" term="æ•°æ®åº“" label="æ•°æ®åº“"/><category scheme="https://waynerv.com/tags/mysql/" term="MySQL" label="MySQL"/></entry></feed>